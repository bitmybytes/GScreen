cscope 15 $HOME/Documents/code/screen-4.0.3               0000778922
	@acls.c

24 
	~<sys/ty³s.h
>

26 
	~"cÚfig.h
"

31 #ifdeà
CHECKLOGIN


32 #ifdeà
_SEQUENT_


33 
	~<¡dio.h
>

35 
	~<pwd.h
>

36 #ifdeà
SHADOWPW


37 
	~<shadow.h
>

41 #iâdeà
NOSYSLOG


42 
	~<sy¦og.h
>

45 
	~"sü“n.h
"

46 
	~"ex‹º.h
"

53 
comm
 
comms
[];

54 
wš
 *
wšdows
, *
wb
[];

55 
NuÎSŒ
[];

56 
SockP©h
[];

57 
di¥Ïy
 *di¥Ïy, *
di¥Ïys
;

58 
aşu£r
 *
	gu£rs
;

60 #ifdeà
MULTIUSER


61 
	gmaxu£rcouÁ
 = 0;

64 
AşB™s
 
	gu£rb™s
;

70 
	gdeçuÉ_w_b™
[
ACL_BITS_PER_WIN
] =

77 
	gdeçuÉ_c_b™
[
ACL_BITS_PER_CMD
] =

89 
GrowB™f›ld
 
__P
((
AşB™s
 *, , , ));

90 
aşu£rgroup
 **
FšdGroupPŒ
 
__P
((aşu£rgrou°**, 
aşu£r
 *, ));

91 
AşS‘P”mCmd
 
__P
((
aşu£r
 *, *, 
comm
 *));

92 
AşS‘P”mWš
 
__P
((
aşu£r
 *, aşu£¸*, *, 
wš
 *));

93 
U£rAş
 
__P
((
aşu£r
 *, acluser **, , **));

94 
U£rAşCİy
 
__P
((
aşu£r
 **, acluser **));

98 
	$GrowB™f›ld
(
bå
, 
Ën
, 
d–
, 
deçuÉb™
)

99 
AşB™s
 *
bå
;

100 
Ën
, 
d–
, 
deçuÉb™
;

102 
AşB™s
 
n
, 
o
 = *
bå
;

103 
i
;

105 ià(!(
n
 = (
AşB™s
)
	`ÿÎoc
(1, ()(&
	`ACLBYTE
((*)0, 
Ën
 + 
d–
 + 1)))))

107 
i
 = 0; i < (
Ën
 + 
d–
); i++)

109 ià(((
i
 < 
Ën
è&& (
	`ACLBIT
(iè& 
	`ACLBYTE
(
o
, i))) ||

110 ((
i
 >ğ
Ën
è&& (
deçuÉb™
)))

111 
	`ACLBYTE
(
n
, 
i
è|ğ
	`ACLBIT
(i);

113 ià(
Ën
)

114 
	`ä“
((*)
o
);

115 *
bå
 = 
n
;

117 
	}
}

125 
aşu£r
 **

126 
	$FšdU£rPŒ
(
Çme
)

127 *
Çme
;

129 
aşu£r
 **
u
;

131 
u
 = &
u£rs
; *u; u = &(*u)->
u_Ãxt
)

132 ià(!
	`¡rcmp
((*
u
)->
u_Çme
, 
Çme
))

134 #ifdeà
MULTIUSER


135 
	`debug3
("FšdU£rPŒ % %sfound, id %d\n", 
Çme
, (*
u
)?"":"not ",

136 (*
u
)?(*u)->
u_id
:-1);

138 
	`debug2
("FšdU£rPŒ % %sfound\n", 
Çme
, (*
u
)?"":"not ");

140  
u
;

141 
	}
}

143 
	gDeçuÉEsc
 = -1;

144 
	gDeçuÉM‘aEsc
 = -1;

152 
	$U£rAdd
(
Çme
, 
·ss
, 
up
)

153 *
Çme
, *
·ss
;

154 
aşu£r
 **
up
;

156 #ifdeà
MULTIUSER


157 
j
;

160 ià(!
up
)

161 
up
 = 
	`FšdU£rPŒ
(
Çme
);

162 ià(*
up
)

164 ià(
·ss
)

165 (*
up
)->
u_·sswÜd
 = 
	`SaveSŒ
(
·ss
);

168 ià(
	`¡rcmp
("nÚe", 
Çme
))

169 *
up
 = (
aşu£r
 *)
	`ÿÎoc
(1, (acluser));

170 ià(!*
up
)

172 #ifdeà
COPY_PASTE


173 (*
up
)->
u_¶İ
.
buf
 = 
NULL
;

174 (*
up
)->
u_¶İ
.
Ën
 = 0;

175 #ifdeà
ENCODINGS


176 (*
up
)->
u_¶İ
.
’c
 = 0;

179 (*
up
)->
u_Esc
 = 
DeçuÉEsc
;

180 (*
up
)->
u_M‘aEsc
 = 
DeçuÉM‘aEsc
;

181 
	`¡ºıy
((*
up
)->
u_Çme
, 
Çme
, 20);

182 (*
up
)->
u_·sswÜd
 = 
NULL
;

183 ià(
·ss
)

184 (*
up
)->
u_·sswÜd
 = 
	`SaveSŒ
(
·ss
);

185 ià(!(*
up
)->
u_·sswÜd
)

186 (*
up
)->
u_·sswÜd
 = 
NuÎSŒ
;

187 (*
up
)->
u_d‘achwš
 = -1;

188 (*
up
)->
u_d‘achÙh”wš
 = -1;

190 #ifdeà
MULTIUSER


191 (*
up
)->
u_group
 = 
NULL
;

193 (*
up
)->
u_id
 = 0; (*up)->u_id < 
maxu£rcouÁ
; (*up)->u_id++)

194 ià(!(
	`ACLBIT
((*
up
)->
u_id
è& 
	`ACLBYTE
(
u£rb™s
, (*up)->u_id)))

196 
	`debug2
("U£rAdd % id %d\n", 
Çme
, (*
up
)->
u_id
);

197 ià((*
up
)->
u_id
 =ğ
maxu£rcouÁ
)

199 
j
;

200 
wš
 *
w
;

201 
aşu£r
 *
u
;

203 
	`debug2
("growšg‡Î b™f›ld %d +ğ%d\n", 
maxu£rcouÁ
, 
USER_CHUNK
);

206 ià(
	`GrowB™f›ld
(&
u£rb™s
, 
maxu£rcouÁ
, 
USER_CHUNK
, 0))

208 
	`ä“
((*)*
up
); *u°ğ
NULL
;  -1;

221 
j
 = 0; j <ğ
RC_LAST
; j++)

223 
i
;

225 
i
 = 0; i < 
ACL_BITS_PER_CMD
; i++)

226 ià(
	`GrowB™f›ld
(&
comms
[
j
].
u£rb™s
[
i
], 
maxu£rcouÁ
, 
USER_CHUNK
,

227 
deçuÉ_c_b™
[
i
]))

229 
	`ä“
((*)*
up
); *u°ğ
NULL
;  -1;

233 
u
 = 
u£rs
; u !ğ*
up
; u = u->
u_Ãxt
)

235 
j
 = 0; j < 
ACL_BITS_PER_WIN
; j++)

237 ià(
	`GrowB™f›ld
(&
u
->
u_umask_w_b™s
[
j
], 
maxu£rcouÁ
, 
USER_CHUNK
,

238 
deçuÉ_w_b™
[
j
]))

240 
	`ä“
((*)*
up
); *u°ğ
NULL
;  -1;

247 
w
 = 
wšdows
; w; w = w->
w_Ãxt
)

250 
j
 = 0; j < 
ACL_BITS_PER_WIN
; j++)

251 ià(
	`GrowB™f›ld
(&
w
->
w_u£rb™s
[
j
], 
maxu£rcouÁ
, 
USER_CHUNK
,

252 
deçuÉ_w_b™
[
j
]))

254 
	`ä“
((*)*
up
); *u°ğ
NULL
;  -1;

258 ià(
	`GrowB™f›ld
(&
w
->
w_mÚ_nÙify
, 
maxu£rcouÁ
, 
USER_CHUNK
, 0) ||

259 
	`GrowB™f›ld
(&
w
->
w_lio_nÙify
, 
maxu£rcouÁ
, 
USER_CHUNK
, 0))

261 
	`ä“
((*)*
up
); *u°ğ
NULL
;  -1;

264 
maxu£rcouÁ
 +ğ
USER_CHUNK
;

268 
	`ACLBYTE
(
u£rb™s
, (*
up
)->
u_id
è|ğ
	`ACLBIT
((*up)->u_id);

271 ià((*
up
)->
u_id
 == 0)

272 
	`AşS‘P”m
(
NULL
, *
up
, "+a", "#?");

275 ià(!
	`¡rcmp
((*
up
)->
u_Çme
, "nobody"))

277 
	`AşS‘P”m
(
NULL
, *
up
, "-rwx", "#?");

278 
	`AşS‘P”m
(
NULL
, *
up
, "+x", "su");

279 
	`AşS‘P”m
(
NULL
, *
up
, "+x", "detach");

280 
	`AşS‘P”m
(
NULL
, *
up
, "+x", "displays");

281 
	`AşS‘P”m
(
NULL
, *
up
, "+x", "version");

289 
j
 = 0; j < 
ACL_BITS_PER_WIN
; j++)

291 ià(
	`GrowB™f›ld
(&(*
up
)->
u_umask_w_b™s
[
j
], 0, 
maxu£rcouÁ
,

292 
deçuÉ_w_b™
[
j
]))

294 
	`ä“
((*)*
up
); *u°ğ
NULL
;  -1;

296 
	`ACLBYTE
((*
up
)->
u_umask_w_b™s
[
j
], (*up)->
u_id
è|ğ
	`ACLBIT
((*up)->u_id);

299 
	`debug1
("U£rAdd %s\n", 
Çme
);

302 
	}
}

307 
	$U£rS‘Pass
(
Çme
, 
·ss
, 
up
)

308 *
Çme
, *
·ss
;

309 
aşu£r
 **
up
;

311 ià(!
up
)

312 
up
 = 
	`FšdU£rPŒ
(
Çme
);

313 ià(!*
up
)

314  
	`U£rAdd
(
Çme
, 
·ss
, 
up
);

315 ià(!
	`¡rcmp
(
Çme
, "nobody"))

317 
	`¡ºıy
((*
up
)->
u_·sswÜd
, 
·ss
 ?…ass : "", 20);

318 (*
up
)->
u_·sswÜd
[20] = '\0';

320 
	}
}

328 
	$U£rD–
(
Çme
, 
up
)

329 *
Çme
;

330 
aşu£r
 **
up
;

332 
aşu£r
 *
u
;

333 #ifdeà
MULTIUSER


334 
i
;

336 
di¥Ïy
 *
Şd
, *
Ãxt
;

338 ià(!
up
)

339 
up
 = 
	`FšdU£rPŒ
(
Çme
);

340 ià(!(
u
 = *
up
))

342 
Şd
 = 
di¥Ïy
;

343 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = 
Ãxt
)

345 
Ãxt
 = 
di¥Ïy
->
d_Ãxt
;

346 ià(
D_u£r
 !ğ
u
)

348 ià(
di¥Ïy
 =ğ
Şd
)

349 
Şd
 = 
NULL
;

350 
	`D‘ach
(
D_REMOTE
);

352 
di¥Ïy
 = 
Şd
;

353 *
up
 = 
u
->
u_Ãxt
;

355 #ifdeà
MULTIUSER


356 
up
 = &
u£rs
; *up; u°ğ&(*up)->
u_Ãxt
)

359 
aşu£rgroup
 **
g
 = &(*
up
)->
u_group
;

361 *
g
)

363 ià((*
g
)->
u
 == u)

365 
aşu£rgroup
 *
Ãxt
 = (*
g
)->next;

367 
	`ä“
((*)(*
g
));

368 *
g
 = 
Ãxt
;

371 
g
 = &(*g)->
Ãxt
;

374 
	`ACLBYTE
(
u£rb™s
, 
u
->
u_id
è&ğ~
	`ACLBIT
(u->u_id);

376 
	`AşS‘P”m
(
NULL
, 
u
, 
deçuÉ_w_b™
[
ACL_READ
] ? "+r" : "-r", "#");

377 
	`AşS‘P”m
(
NULL
, 
u
, 
deçuÉ_w_b™
[
ACL_WRITE
]? "+w" : "-w", "#");

378 
	`AşS‘P”m
(
NULL
, 
u
, 
deçuÉ_w_b™
[
ACL_EXEC
] ? "+x" : "-x", "#");

379 
	`AşS‘P”m
(
NULL
, 
u
, 
deçuÉ_c_b™
[
ACL_EXEC
] ? "+x" : "-x", "?");

380 
i
 = 0; i < 
ACL_BITS_PER_WIN
; i++)

381 
	`ä“
((*)
u
->
u_umask_w_b™s
[
i
]);

383 
	`debug1
("FREEING u£¸¡ruùu» fÜ %s\n", 
u
->
u_Çme
);

384 #ifdeà
COPY_PASTE


385 
	`U£rF»eCİyBufãr
(
u
);

387 
	`ä“
((*)
u
);

388 ià(!
u£rs
)

390 
	`debug
("Last user deleted. Feierabend.\n");

391 
	`Fš™
(0);

394 
	}
}

397 #ifdeà
COPY_PASTE


404 
	$U£rF»eCİyBufãr
(
u
)

405 
aşu£r
 *
u
;

407 
wš
 *
w
;

408 
·¡”
 *
·
;

410 ià(!
u
->
u_¶İ
.
buf
)

412 
w
 = 
wšdows
; w; w = w->
w_Ãxt
)

414 
·
 = &
w
->
w_·¡”
;

415 ià(
·
->
·_·¡•Œ
 >ğ
u
->
u_¶İ
.
buf
 &&

416 
·
->
·_·¡•Œ
 - 
u
->
u_¶İ
.
buf
 < u->u_¶İ.
Ën
)

417 
	`F»ePa¡”
(
·
);

419 
	`ä“
((*)
u
->
u_¶İ
.
buf
);

420 
u
->
u_¶İ
.
Ën
 = 0;

421 
u
->
u_¶İ
.
buf
 = 0;

423 
	}
}

426 #ifdeà
MULTIUSER


433 
aşu£rgroup
 **

434 
	$FšdGroupPŒ
(
gp
, 
u
, 
»cursive
)

435 
aşu£rgroup
 **
gp
;

436 
aşu£r
 *
u
;

437 
»cursive
;

439 
aşu£rgroup
 **
g
;

441 
	`ASSERT
(
»cursive
 < 1000);

442 *
gp
)

444 ià((*
gp
)->
u
 == u)

445  
gp
;

446 ià(
»cursive
 &&

447 *(
g
 = 
	`FšdGroupPŒ
(&(*
gp
)->
u
->
u_group
, u, 
»cursive
 + 1)))

448  
g
;

449 
gp
 = &(*gp)->
Ãxt
;

451  
gp
;

452 
	}
}

460 
	$AşLškU£r
(
äom
, 
to
)

461 *
äom
, *
to
;

463 
aşu£r
 **
u1
, **
u2
;

464 
aşu£rgroup
 **
g
;

466 ià(!*(
u1
 = 
	`FšdU£rPŒ
(
äom
)è&& 
	`U£rAdd
(äom, 
NULL
, u1))

468 ià(!*(
u2
 = 
	`FšdU£rPŒ
(
to
)è&& 
	`U£rAdd
Ño, 
NULL
, u2))

471 ià(*
	`FšdGroupPŒ
(&(*
u2
)->
u_group
, *
u1
, 1))

473 ià(*(
g
 = 
	`FšdGroupPŒ
(&(*
u1
)->
u_group
, *
u2
, 0)))

476 ià(!(*
g
 = (
aşu£rgroup
 *)
	`m®loc
((aclusergroup))))

478 (*
g
)->
u
 = (*
u2
);

479 (*
g
)->
Ãxt
 = 
NULL
;

481 
	}
}

489 
	$DoSu
(
up
, 
Çme
, 
pw1
, 
pw2
)

490 
aşu£r
 **
up
;

491 *
Çme
, *
pw1
, *
pw2
;

493 
aşu£r
 *
u
;

494 
sÜry
 = 0;

496 ià(!(
u
 = *
	`FšdU£rPŒ
(
Çme
)))

497 
sÜry
++;

500 #ifdeà
CHECKLOGIN


501 
·sswd
 *
µ
;

502 #ifdeà
SHADOWPW


503 
¥wd
 *
ss
;

504 
t
, 
c
;

506 *
·ss
 = "";

508 ià(!(
µ
 = 
	`g‘pwÇm
(
Çme
)))

510 
	`debug1
("g‘pwÇm(\"%s\"èçed\n", 
Çme
);

511 ià(!(
pw1
 && *pw1 && *pw1 != '\377'))

513 
	`debug
("no unix‡ccount,‚o screen…asswd\n");

514 
sÜry
++;

518 
·ss
 = 
µ
->
pw_·sswd
;

519 #ifdeà
SHADOWPW


520 
t
 = 0; < 13;++)

522 
c
 = 
·ss
[
t
];

523 ià(!(
c
 == '.' || c == '/' ||

524 (
c
 >= '0' && c <= '9') ||

525 (
c
 >= 'a' && c <= 'z') ||

526 (
c
 >= 'A' && c <= 'Z')))

529 ià(
t
 < 13)

531 ià(!(
ss
 = 
	`g‘¥Çm
(
Çme
)))

533 
	`debug1
("g‘¥Çm(\"%s\"èçed\n", 
Çme
);

534 
sÜry
++;

537 
·ss
 = 
ss
->
¥_pwdp
;

541 ià(
pw2
 && *pw2 && *pw2 != '\377')

543 ià(!*
·ss
 ||

544 
	`¡rcmp
(
	`üy±
(
pw2
, 
·ss
),…ass))

546 
	`debug
("System…assword mismatch\n");

547 
sÜry
++;

551 ià(*
·ss
)

552 
sÜry
++;

554 ià(
pw1
 && *pw1 && *pw1 != '\377')

556 ià(!*
u
->
u_·sswÜd
 ||

557 
	`¡rcmp
(
	`üy±
(
pw1
, 
u
->
u_·sswÜd
), u->u_password))

559 
	`debug
("screen…assword mismatch\n");

560 
sÜry
++;

564 ià(*
u
->
u_·sswÜd
)

565 
sÜry
++;

568 
	`debug2
("sy¦og(LOG_NOTICE, \"sü“À%s: \"su %s\" ", 
SockP©h
, 
Çme
);

569 
	`debug2
("% fÜ \"%s\"\n", 
sÜry
 ? "çed" : "sucûded", (*
up
)->
u_Çme
);

570 #iâdeà
NOSYSLOG


571 #ifdeà
BSD_42


572 
	`İ’log
("sü“n", 
LOG_PID
);

574 
	`İ’log
("sü“n", 
LOG_PID
, 
LOG_AUTH
);

576 
	`sy¦og
(
LOG_NOTICE
, "%s: \"su %s\" % fÜ \"%s\"", 
SockP©h
, 
Çme
,

577 
sÜry
 ? "çed" : "sucûded", (*
up
)->
u_Çme
);

578 
	`şo£log
();

580 
	`debug
("NOT LOGGED.\n");

583 ià(
sÜry
)

586 *
up
 = 
u
;

587  
NULL
;

588 
	}
}

596 #ifdeà
MULTIUSER


600 
	$NewWšdowAş
(
w
, 
u
)

601 
wš
 *
w
;

602 
aşu£r
 *
u
;

604 
i
, 
j
;

606 
	`debug2
("NewWindowAcl %s's umask_w_bits for window %d\n",

607 
u
 ? u->
u_Çme
 : "ev”ybody", 
w
->
w_numb”
);

610 ià(
	`GrowB™f›ld
(&
w
->
w_mÚ_nÙify
, 0, 
maxu£rcouÁ
, 0) ||

611 
	`GrowB™f›ld
(&
w
->
w_lio_nÙify
, 0, 
maxu£rcouÁ
, 0))

613 
j
 = 0; j < 
ACL_BITS_PER_WIN
; j++)

616 ià(
	`GrowB™f›ld
(&
w
->
w_u£rb™s
[
j
], 0, 
maxu£rcouÁ
, 0))

618 --
j
 >= 0)

619 
	`ä“
((*)
w
->
w_u£rb™s
[
j
]);

620 
	`ä“
((*)
w
->
w_mÚ_nÙify
);

621 
	`ä“
((*)
w
->
w_lio_nÙify
);

624 
i
 = 0; i < 
maxu£rcouÁ
; i++)

625 ià(
u
 ? (
	`ACLBIT
(
i
è& 
	`ACLBYTE
(u->
u_umask_w_b™s
[
j
], i)) :

626 
deçuÉ_w_b™
[
j
])

627 
	`ACLBYTE
(
w
->
w_u£rb™s
[
j
], 
i
è|ğ
	`ACLBIT
(i);

630 
	}
}

633 
	$F»eWšdowAş
(
w
)

634 
wš
 *
w
;

636 
i
;

638 
i
 = 0; i < 
ACL_BITS_PER_WIN
; i++)

639 
	`ä“
((*)
w
->
w_u£rb™s
[
i
]);

640 
	`ä“
((*)
w
->
w_mÚ_nÙify
);

641 
	`ä“
((*)
w
->
w_lio_nÙify
);

642 
	}
}

651 
	$AşS‘P”mCmd
(
u
, 
mode
, 
cmd
)

652 
aşu£r
 *
u
;

653 *
mode
;

654 
comm
 *
cmd
;

656 
Ãg
 = 0;

657 *
m
 = 
mode
;

659 *
m
)

661 *
m
++)

664 
Ãg
 = 1;

667 
Ãg
 = 0;

673 ià(
Ãg
)

674 
	`ACLBYTE
(
cmd
->
u£rb™s
[
ACL_EXEC
], 
u
->
u_id
è&ğ~
	`ACLBIT
(u->u_id);

676 
	`ACLBYTE
(
cmd
->
u£rb™s
[
ACL_EXEC
], 
u
->
u_id
è|ğ
	`ACLBIT
(u->u_id);

686 
	}
}

696 
	$AşS‘P”mWš
(
uu
, 
u
, 
mode
, 
wš
)

697 
aşu£r
 *
u
, *
uu
;

698 *
mode
;

699 
wš
 *win;

701 
Ãg
 = 0;

702 
b™
, 
b™s
;

703 
AşB™s
 *
b™¬¿y
;

704 *
m
 = 
mode
;

706 ià(
uu
)

708 
	`debug3
("AşS‘P”mWš % UMASK % %s\n", 
uu
->
u_Çme
, 
u
->u_Çme, 
mode
);

709 
b™¬¿y
 = 
uu
->
u_umask_w_b™s
;

713 
	`ASSERT
(
wš
);

714 
b™¬¿y
 = 
wš
->
w_u£rb™s
;

715 
	`debug3
("AşS‘P”mWš % % %d\n", 
u
->
u_Çme
, 
mode
, 
wš
->
w_numb”
);

718 *
m
)

720 *
m
++)

723 
Ãg
 = 1;

726 
Ãg
 = 0;

729 
b™s
 = (1 << 
ACL_READ
);

732 
b™s
 = (1 << 
ACL_WRITE
);

735 
b™s
 = (1 << 
ACL_EXEC
);

738 
b™s
 = (1 << 
ACL_BITS_PER_WIN
) - 1;

743 
b™
 = 0; b™ < 
ACL_BITS_PER_WIN
; bit++)

745 ià(!(
b™s
 & (1 << 
b™
)))

747 ià(
Ãg
)

748 
	`ACLBYTE
(
b™¬¿y
[
b™
], 
u
->
u_id
è&ğ~
	`ACLBIT
(u->u_id);

750 
	`ACLBYTE
(
b™¬¿y
[
b™
], 
u
->
u_id
è|ğ
	`ACLBIT
(u->u_id);

751 ià(!
uu
 && (
wš
->
w_wlocku£r
 =ğ
u
è&& 
Ãg
 && (
b™
 =ğ
ACL_WRITE
))

753 
	`debug2
("% lo¡ wr™–ock oÀwš %d\n", 
u
->
u_Çme
, 
wš
->
w_numb”
);

754 
wš
->
w_wlocku£r
 = 
NULL
;

755 ià(
wš
->
w_wlock
 =ğ
WLOCK_ON
)

756 
wš
->
w_wlock
 = 
WLOCK_AUTO
;

760 ià(
uu
 && 
u
->
u_Çme
[0] == '?' && u->u_name[1] == '\0')

766 ià(
wš
)

768 
	`debug1
("AşS‘P”mWš: deçuÉ_w_b™ '%s'.\n", 
mode
);

769 
b™
 = 0; b™ < 
ACL_BITS_PER_WIN
; bit++)

770 
deçuÉ_w_b™
[
b™
] =

771 (
	`ACLBYTE
(
b™¬¿y
[
b™
], 
u
->
u_id
è& 
	`ACLBIT
(u->u_id)) ? 1 : 0;

780 
	`debug1
("AşS‘P”mWš: deçuÉ_c_b™ '%s'.\n", 
mode
);

781 
b™
 = 0; b™ < 
ACL_BITS_PER_CMD
; bit++)

782 
deçuÉ_c_b™
[
b™
] =

783 (
	`ACLBYTE
(
b™¬¿y
[
b™
], 
u
->
u_id
è& 
	`ACLBIT
(u->u_id)) ? 1 : 0;

785 
	`U£rD–
(
u
->
u_Çme
, 
NULL
);

788 
	}
}

796 
	$AşS‘P”m
(
uu
, 
u
, 
mode
, 
s
)

797 
aşu£r
 *
uu
, *
u
;

798 *
mode
, *
s
;

800 
wš
 *
w
;

801 
i
;

802 *
p
, 
ch
;

804 
	`debug3
("AclSetPerm(uu, user '%s', mode '%s', object '%s')\n",

805 
u
->
u_Çme
, 
mode
, 
s
);

806 *
s
)

808 *
s
)

811  
	`AşS‘P”m
(
uu
, 
u
, 
mode
, "#?");

813 ià(
uu
)

814 
	`AşS‘P”mWš
(
uu
, 
u
, 
mode
, (
wš
 *)1);

816 
w
 = 
wšdows
; w; w = w->
w_Ãxt
)

817 
	`AşS‘P”mWš
((
aşu£r
 *)0, 
u
, 
mode
, 
w
);

818 
s
++;

821 ià(
uu
)

822 
	`AşS‘P”mWš
(
uu
, 
u
, 
mode
, (
wš
 *)0);

824 
i
 = 0; i <ğ
RC_LAST
; i++)

825 
	`AşS‘P”mCmd
(
u
, 
mode
, &
comms
[
i
]);

826 
s
++;

829 
p
 = 
s
; *p && *p != ' ' && *p != '\t' && *p != ',';…++)

831 ià((
ch
 = *
p
))

832 *
p
++ = '\0';

833 ià((
i
 = 
	`FšdCommÄ
(
s
)è!ğ
RC_ILLEGAL
)

834 
	`AşS‘P”mCmd
(
u
, 
mode
, &
comms
[
i
]);

835 ià(((
i
 = 
	`WšdowByNoN
(
s
)è>ğ0è&& 
wb
[i])

836 
	`AşS‘P”mWš
((
aşu£r
 *)0, 
u
, 
mode
, 
wb
[
i
]);

840 ià(
ch
)

841 
p
[-1] = 
ch
;

842 
s
 = 
p
;

846 
	}
}

860 
	$U£rAş
(
uu
, 
u
, 
¬gc
, 
¬gv
)

861 
aşu£r
 *
uu
, **
u
;

862 
¬gc
;

863 **
¬gv
;

865 ià((*
u
 && !
	`¡rcmp
((*u)->
u_Çme
, "nobody")) ||

866 (
¬gc
 > 1 && !
	`¡rcmp
(
¬gv
[0], "nobody")))

869 
¬gc
)

872 
	`debug2
("U£rAş: u£¸'%s',…asswÜd '%s':", 
¬gv
[0],‡rgv[1]);

873  (
	`U£rAdd
(
¬gv
[0],‡rgv[1], 
u
) < 0) ||

874 
	`AşS‘P”m
(
uu
, *
u
, 
¬gv
[2],‡rgv[3]);

876 
	`debug1
("U£rAş: u£¸'%s',‚Ø·sswÜd:", 
¬gv
[0]);

877  (
	`U£rAdd
(
¬gv
[0], 
NULL
, 
u
) < 0) ||

878 
	`AşS‘P”m
(
uu
, *
u
, 
¬gv
[1],‡rgv[2]);

880 
	`debug2
("U£rAş: u£¸'%s',…asswÜd '%s'\n", 
¬gv
[0],‡rgv[1]);

881  
	`U£rAdd
(
¬gv
[0],‡rgv[1], 
u
) < 0;

883 
	`debug1
("U£rAş: u£¸'%s',‚Ø·sswÜd:", 
¬gv
[0]);

884  (
	`U£rAdd
(
¬gv
[0], 
NULL
, 
u
) < 0) ||

885 
	`AşS‘P”m
(
uu
, *
u
, "+a", "#?");

889 
	}
}

892 
	$U£rAşCİy
(
to_up
, 
äom_up
)

893 
aşu£r
 **
to_up
, **
äom_up
;

895 
wš
 *
w
;

896 
i
, 
j
, 
to_id
, 
äom_id
;

898 ià(!*
to_up
 || !*
äom_up
)

900 
	`debug2
("UserAclCopy: from user '%s'o user '%s'\n",

901 (*
äom_up
)->
u_Çme
, (*
to_up
)->u_name);

902 ià((
to_id
 = (*
to_up
)->
u_id
è=ğ(
äom_id
 = (*
äom_up
)->u_id))

904 
w
 = 
wšdows
; w; w = w->
w_Ãxt
)

906 
i
 = 0; i < 
ACL_BITS_PER_WIN
; i++)

908 ià(
	`ACLBYTE
(
w
->
w_u£rb™s
[
i
], 
äom_id
è& 
	`ACLBIT
(from_id))

909 
	`ACLBYTE
(
w
->
w_u£rb™s
[
i
], 
to_id
è|ğ
	`ACLBIT
(to_id);

912 
	`ACLBYTE
(
w
->
w_u£rb™s
[
i
], 
to_id
è&ğ~
	`ACLBIT
(to_id);

913 ià((
w
->
w_wlocku£r
 =ğ*
to_up
è&& (
i
 =ğ
ACL_WRITE
))

915 
	`debug2
("%s†ost wlock on win %d\n",

916 (*
to_up
)->
u_Çme
, 
w
->
w_numb”
);

917 
w
->
w_wlocku£r
 = 
NULL
;

918 ià(
w
->
w_wlock
 =ğ
WLOCK_ON
)

919 
w
->
w_wlock
 = 
WLOCK_AUTO
;

924 
j
 = 0; j <ğ
RC_LAST
; j++)

926 
i
 = 0; i < 
ACL_BITS_PER_CMD
; i++)

928 ià(
	`ACLBYTE
(
comms
[
j
].
u£rb™s
[
i
], 
äom_id
è& 
	`ACLBIT
(from_id))

929 
	`ACLBYTE
(
comms
[
j
].
u£rb™s
[
i
], 
to_id
è|ğ
	`ACLBIT
(to_id);

931 
	`ACLBYTE
(
comms
[
j
].
u£rb™s
[
i
], 
to_id
è&ğ~
	`ACLBIT
(to_id);

936 
	}
}

947 
	$U£rsAş
(
uu
, 
¬gc
, 
¬gv
)

948 
aşu£r
 *
uu
;

949 
¬gc
;

950 **
¬gv
;

952 *
s
;

953 
r
;

954 
aşu£r
 **
cf_u
 = 
NULL
;

956 ià(
¬gc
 == 1)

958 *
p
 = 
NULL
;

960 
s
 = 
¬gv
[0];

961 *
s
)

962 ià(*
s
++ =ğ'='è
p
 = s;

963 ià(
p
)

965 
p
[-1] = '\0';

966 
cf_u
 = 
	`FšdU£rPŒ
(
p
);

970 ià(
¬gv
[0][0] == '*' &&‡rgv[0][1] == '\0')

972 
aşu£r
 **
u
;

974 
	`debug
("all users‡cls.\n");

975 
u
 = &
u£rs
; *u; u = &(*u)->
u_Ãxt
)

976 ià(
	`¡rcmp
("nobody", (*
u
)->
u_Çme
) &&

977 ((
cf_u
) ?

978 ((
r
 = 
	`U£rAşCİy
(
u
, 
cf_u
)) < 0) :

979 ((
r
 = 
	`U£rAş
(
uu
, 
u
, 
¬gc
, 
¬gv
)) < 0)))

986 
s
 = 
¬gv
[0]; *s && *s!=' ' && *s!='\t' && *s!=',' && *s!='='; s++)

988 *
s
 ? (*s++ = '\0') : (*s = '\0');

989 
	`debug2
("U£rsAş(uu, \"%s\",‡rgc=%d)\n", 
¬gv
[0], 
¬gc
);

990 ià((
cf_u
) ?

991 ((
r
 = 
	`U£rAşCİy
(
	`FšdU£rPŒ
(
¬gv
[0]), 
cf_u
)) < 0) :

992 ((
r
 = 
	`U£rAş
(
uu
, 
	`FšdU£rPŒ
(
¬gv
[0]), 
¬gc
,‡rgv)) < 0))

994 } *(
¬gv
[0] = 
s
));

996 
	}
}

1008 
	$AşUmask
(
u
, 
¡r
, 
”½
)

1009 
aşu£r
 *
u
;

1010 *
¡r
;

1011 **
”½
;

1013 
mode
[16];

1014 *
av
[3];

1015 *
p
, 
c
 = '\0';

1018 
p
 = 
¡r
; *p;…++)

1019 ià((
c
 = *
p
) == '+' || c == '-')

1021 ià(!*
p
)

1023 *
”½
 = "Bad‡rgument. Should be ``[user[,user...]{+|-}rwxn''.";

1026 
	`¡ºıy
(
mode
, 
p
, 15);

1027 
mode
[15] = '\0';

1028 *
p
 = '\0';

1031 ià(!
	`¡rcmp
("??", 
¡r
))

1033 
¡r
++;

1034 
av
[2] = "?";

1037 
av
[2] = "#";

1038 
av
[1] = 
mode
;

1039 
av
[0] = *
¡r
 ? str : "*";

1041 ià(
	`U£rsAş
(
u
, 3, 
av
))

1043 *
”½
 = "UsersAcl failed. Hmmm.";

1044 *
p
 = 
c
;

1047 *
p
 = 
c
;

1049 
	}
}

1052 
	$AşWšSw­
(
a
, 
b
)

1053 
a
, 
b
;

1055 
	`debug2
("AşWšSw­(%d, %dèNOP.\n", 
a
, 
b
);

1056 
	}
}

1058 
aşu£r
 *
	gEfãùiveAşU£r
 = 
NULL
;

1061 
	$AşCheckP”mWš
(
u
, 
mode
, 
w
)

1062 
aşu£r
 *
u
;

1063 
mode
;

1064 
wš
 *
w
;

1066 
ok
;

1068 ià(
mode
 < 0 || mod>ğ
ACL_BITS_PER_WIN
)

1070 ià(
EfãùiveAşU£r
)

1072 
	`debug1
("AşCheckP”mWš: WARNING u£¸% ov”ridd’!\n", 
u
->
u_Çme
);

1073 
u
 = 
EfãùiveAşU£r
;

1075 
ok
 = 
	`ACLBYTE
(
w
->
w_u£rb™s
[
mode
], 
u
->
u_id
è& 
	`ACLBIT
(u->u_id);

1076 
	`debug3
("AşCheckP”mWš(%s, %d, %dèğ", 
u
->
u_Çme
, 
mode
, 
w
->
w_numb”
);

1078 ià(!
ok
)

1080 
aşu£rgroup
 **
g
 = &
u
->
u_group
;

1081 
aşu£r
 *
§ved_eff
 = 
EfãùiveAşU£r
;

1083 
EfãùiveAşU£r
 = 
NULL
;

1084 *
g
)

1086 ià(!
	`AşCheckP”mWš
((*
g
)->
u
, 
mode
, 
w
))

1088 
g
 = &(*g)->
Ãxt
;

1090 
EfãùiveAşU£r
 = 
§ved_eff
;

1091 ià(*
g
)

1092 
ok
 = 1;

1094 
	`debug1
("%d\n", !
ok
);

1095  !
ok
;

1096 
	}
}

1099 
	$AşCheckP”mCmd
(
u
, 
mode
, 
c
)

1100 
aşu£r
 *
u
;

1101 
mode
;

1102 
comm
 *
c
;

1104 
ok
;

1106 ià(
mode
 < 0 || mod>ğ
ACL_BITS_PER_CMD
)

1108 ià(
EfãùiveAşU£r
)

1110 
	`debug1
("AşCheckP”mCmd: WARNING u£¸% ov”ridd’!\n", 
u
->
u_Çme
);

1111 
u
 = 
EfãùiveAşU£r
;

1113 
ok
 = 
	`ACLBYTE
(
c
->
u£rb™s
[
mode
], 
u
->
u_id
è& 
	`ACLBIT
(u->u_id);

1114 
	`debug3
("AşCheckP”mCmd(% %d %sèğ", 
u
->
u_Çme
, 
mode
, 
c
->
Çme
);

1115 ià(!
ok
)

1117 
aşu£rgroup
 **
g
 = &
u
->
u_group
;

1118 
aşu£r
 *
§ved_eff
 = 
EfãùiveAşU£r
;

1120 
EfãùiveAşU£r
 = 
NULL
;

1121 *
g
)

1123 ià(!
	`AşCheckP”mCmd
((*
g
)->
u
, 
mode
, 
c
))

1125 
g
 = &(*g)->
Ãxt
;

1127 
EfãùiveAşU£r
 = 
§ved_eff
;

1128 ià(*
g
)

1129 
ok
 = 1;

1131 
	`debug1
("%d\n", !
ok
);

1132  !
ok
;

1133 
	}
}

	@acls.h

24 #ifdeà
MULTIUSER


27 
	#ACL_EXEC
 0

	)

28 
	#ACL_WRITE
 1

	)

29 
	#ACL_READ
 2

	)

31 
	#ACL_BITS_PER_CMD
 1

	)

32 
	#ACL_BITS_PER_WIN
 3

	)

34 
	#USER_CHUNK
 8

	)

36 
	#ACLBYTE
(
d©a
, 
w
è((d©a)[(wè>> 3])

	)

37 
	#ACLBIT
(
w
è(0x80 >> ((wè& 7))

	)

39 * 
	tAşB™s
;

45 
	saşu£rgroup


47 
aşu£r
 *
	mu
;

48 
aşu£rgroup
 *
	mÃxt
;

59 
	s¶İ


61 *
	mbuf
;

62 
	mËn
;

63 #ifdeà
ENCODINGS


64 
	m’c
;

73 
	saşu£r


75 
aşu£r
 *
	mu_Ãxt
;

76 
	mu_Çme
[20+1];

77 *
	mu_·sswÜd
;

78 
	mu_check·sswÜd
;

79 
	mu_d‘achwš
;

80 
	mu_d‘achÙh”wš
;

81 
	mu_Esc
, 
	mu_M‘aEsc
;

82 #ifdeà
COPY_PASTE


83 
¶İ
 
	mu_¶İ
;

85 #ifdeà
MULTIUSER


86 
	mu_id
;

87 
AşB™s
 
	mu_umask_w_b™s
[
ACL_BITS_PER_WIN
];

88 
aşu£rgroup
 *
	mu_group
;

90 } 
	tU£r
;

92 
DeçuÉEsc
, 
DeçuÉM‘aEsc
;

	@ansi.c

24 
	~<sys/ty³s.h
>

25 
	~<fú.h
>

26 #iâdeà
sun


27 
	~<sys/ioùl.h
>

30 
	~"cÚfig.h
"

31 
	~"sü“n.h
"

32 
	~"b¿Ë.h
"

33 
	~"ex‹º.h
"

34 
	~"logfe.h
"

36 
di¥Ïy
 *di¥Ïy, *
di¥Ïys
;

37 
wš
 *
fÜe
;

38 
Ïy”
 *
æay”
;

40 
NewWšdow
 
nwš_deçuÉ
;

41 
nv”siÚ
;

42 
log_æush
, 
logt¡amp_Ú
, 
logt¡amp_aá”
;

43 *
logt¡amp_¡ršg
;

44 *
ÿ±iÚ¡ršg
;

45 *
h¡©us¡ršg
;

46 *
wli¡¡r
;

47 #ifdeà
COPY_PASTE


48 
com·ùhi¡
;

50 #ifdeà
MULTIUSER


51 
aşu£r
 *
EfãùiveAşU£r
;

54 
	gZ0width
, 
	gZ1width
;

57 
wš
 *
	gcu¼
;

58 
	grows
, 
	gcŞs
;

60 
	gvisu®_b–l
 = 0;

61 
	gu£_h¬d¡©us
 = 1;

62 *
	g´štcmd
 = 0;

63 
	gu£_®tsü“n
 = 0;

65 *
	gbÏnk
;

66 *
	gnuÎ
;

68 
mlše
 
	gmlše_Şd
;

69 
mlše
 
	gmlše_bÏnk
;

70 
mlše
 
	gmlše_nuÎ
;

72 
mch¬
 
	gmch¬_nuÎ
;

73 
mch¬
 
	gmch¬_bÏnk
 = {' ' };

74 
mch¬
 
	gmch¬_so
 = {' ', 
A_SO
 };

77 *
	g¡ršg_t_¡ršg
[] =

91 *
	g¡©e_t_¡ršg
[] =

104 
S³cŸl
 
__P
(());

105 
DoESC
 
__P
((, ));

106 
DoCSI
 
__P
((, ));

107 
SŒšgS¹
 
__P
((
¡ršg_t
));

108 
SŒšgCh¬
 
__P
(());

109 
SŒšgEnd
 
__P
(());

110 
PrštS¹
 
__P
(());

111 
PrštCh¬
 
__P
(());

112 
PrštFlush
 
__P
(());

113 #ifdeà
FONT


114 
DesigÇ‹Ch¬£t
 
__P
((, ));

115 
M­Ch¬£t
 
__P
(());

116 
M­Ch¬£tR
 
__P
(());

118 
SaveCursÜ
 
__P
(());

119 
Re¡ÜeCursÜ
 
__P
(());

120 
BackS·û
 
__P
(());

121 
R‘uº
 
__P
(());

122 
LšeF“d
 
__P
(());

123 
Rev”£LšeF“d
 
__P
(());

124 
In£¹Ch¬
 
__P
(());

125 
D–‘eCh¬
 
__P
(());

126 
D–‘eLše
 
__P
(());

127 
In£¹Lše
 
__P
(());

128 
SüŞl
 
__P
((*, , , *));

129 
FÜw¬dTab
 
__P
(());

130 
Backw¬dTab
 
__P
(());

131 
CË¬Sü“n
 
__P
(());

132 
CË¬FromBOS
 
__P
(());

133 
CË¬ToEOS
 
__P
(());

134 
CË¬LšeRegiÚ
 
__P
((, ));

135 
CursÜRight
 
__P
(());

136 
CursÜUp
 
__P
(());

137 
CursÜDown
 
__P
(());

138 
CursÜLeá
 
__P
(());

139 
AS‘Mode
 
__P
(());

140 
S–eùR’d™iÚ
 
__P
(());

141 
Re¡ÜePosR’d™iÚ
 
__P
(());

142 
FlW™hEs
 
__P
(());

143 
FšdAKA
 
__P
(());

144 
R•Üt
 
__P
((*, , ));

145 
SüŞlRegiÚ
 
__P
(());

146 #ifdeà
COPY_PASTE


147 
WAddLšeToHi¡
 
__P
((
wš
 *, 
mlše
 *));

149 
WLogSŒšg
 
__P
((
wš
 *, *, ));

150 
WRev”£Video
 
__P
((
wš
 *, ));

151 
WšdowChªgedCheck
 
__P
((*, , *));

152 
MFixLše
 
__P
((
wš
 *, , 
mch¬
 *));

153 
MSüŞlH
 
__P
((
wš
 *, , , , , ));

154 
MSüŞlV
 
__P
((
wš
 *, , , , ));

155 
MCË¬A»a
 
__P
((
wš
 *, , , , , ));

156 
MInsCh¬
 
__P
((
wš
 *, 
mch¬
 *, , ));

157 
MPutCh¬
 
__P
((
wš
 *, 
mch¬
 *, , ));

158 
MPutSŒ
 
__P
((
wš
 *, *, , 
mch¬
 *, , ));

159 
MW¿pCh¬
 
__P
((
wš
 *, 
mch¬
 *, , , , ));

160 #ifdeà
COLOR


161 
MBûLše
 
__P
((
wš
 *, , , , ));

164 #ifdeà
COLOR


165 
	#CURR_BCE
 (
cu¼
->
w_bû
 ? 
	`»nd_g‘bg
(&cu¼->
w_»nd
è: 0)

	)

167 
	#CURR_BCE
 0

	)

171 
	$Re£tAnsiS‹
(
p
)

172 
wš
 *
p
;

174 
p
->
w_¡©e
 = 
LIT
;

175 
p
->
w_SŒšgTy³
 = 
NONE
;

176 
	}
}

179 
	$Re£tWšdow
(
p
)

180 
wš
 *
p
;

182 
i
;

184 
p
->
w_w¿p
 = 
nwš_deçuÉ
.
w¿p
;

185 
p
->
w_Üigš
 = 0;

186 
p
->
w_š£¹
 = 0;

187 
p
->
w_»vvid
 = 0;

188 
p
->
w_mou£
 = 0;

189 
p
->
w_curšv
 = 0;

190 
p
->
w_curvvis
 = 0;

191 
p
->
w_autŞf
 = 0;

192 
p
->
w_key·d
 = 0;

193 
p
->
w_cursÜkeys
 = 0;

194 
p
->
w_tİ
 = 0;

195 
p
->
w_bÙ
 =…->
w_height
 - 1;

196 
p
->
w_§ved
 = 0;

197 
p
->
w_x
 =…->
w_y
 = 0;

198 
p
->
w_¡©e
 = 
LIT
;

199 
p
->
w_SŒšgTy³
 = 
NONE
;

200 
	`bz”o
(
p
->
w_bs
,…->
w_width
);

201 
i
 = 8; i < 
p
->
w_width
; i += 8)

202 
p
->
w_bs
[
i
] = 1;

203 
p
->
w_»nd
 = 
mch¬_nuÎ
;

204 #ifdeà
FONT


205 
	`Re£tCh¬£ts
(
p
);

207 #ifdeà
COLOR


208 
p
->
w_bû
 = 
nwš_deçuÉ
.
bû
;

210 
	}
}

214 
	$G‘AnsiStus
(
w
, 
buf
)

215 
wš
 *
w
;

216 *
buf
;

218 *
p
 = 
buf
;

220 ià(
w
->
w_¡©e
 =ğ
LIT
)

223 
	`¡rıy
(
p
, 
¡©e_t_¡ršg
[
w
->
w_¡©e
]);

224 
p
 +ğ
	`¡¾’
(p);

225 ià(
w
->
w_š‹rmedŸ‹
)

227 *
p
++ = '-';

228 ià(
w
->
w_š‹rmedŸ‹
 > 0xff)

229 
p
 +ğ
	`AddXCh¬
Õ, 
w
->
w_š‹rmedŸ‹
 >> 8);

230 
p
 +ğ
	`AddXCh¬
Õ, 
w
->
w_š‹rmedŸ‹
 & 0xff);

231 *
p
 = 0;

233 ià(
w
->
w_¡©e
 =ğ
ASTR
 || w->w_¡©=ğ
STRESC
)

234 
	`¥rštf
(
p
, "-%s", 
¡ršg_t_¡ršg
[
w
->
w_SŒšgTy³
]);

235 
p
 +ğ
	`¡¾’
(p);

236  
p
 - 
buf
;

237 
	}
}

240 #ifdeà
FONT


243 
	$Re£tCh¬£ts
(
p
)

244 
wš
 *
p
;

246 
p
->
w_gr
 = 
nwš_deçuÉ
.
gr
;

247 
p
->
w_c1
 = 
nwš_deçuÉ
.
c1
;

248 
	`S‘Ch¬£ts
(
p
, "BBBB02");

249 ià(
nwš_deçuÉ
.
ch¬£t
)

250 
	`S‘Ch¬£ts
(
p
, 
nwš_deçuÉ
.
ch¬£t
);

251 #ifdeà
ENCODINGS


252 
	`Re£tEncodšg
(
p
);

254 
	}
}

257 
	$S‘Ch¬£ts
(
p
, 
s
)

258 
wš
 *
p
;

259 *
s
;

261 
i
;

263 
i
 = 0; i < 4 && *
s
; i++, s++)

264 ià(*
s
 != '.')

265 
p
->
w_ch¬£ts
[
i
] = ((*
s
 =ğ'B'è? 
ASCII
 : *s);

266 ià(*
s
 && *s++ != '.')

267 
p
->
w_Ch¬£t
 = 
s
[-1] - '0';

268 ià(*
s
 && *s != '.')

269 
p
->
w_Ch¬£tR
 = *
s
 - '0';

270 
p
->
w_ss
 = 0;

271 
p
->
w_FÚtL
 =…->
w_ch¬£ts
[p->
w_Ch¬£t
];

272 
p
->
w_FÚtR
 =…->
w_ch¬£ts
[p->
w_Ch¬£tR
];

273 
	}
}

288 
	$Wr™eSŒšg
(
wp
, 
buf
, 
Ën
)

289 
wš
 *
wp
;

290 *
buf
;

291 
Ën
;

293 
c
;

294 #ifdeà
FONT


295 
fÚt
;

297 
ÿnvas
 *
cv
;

299 ià(!
Ën
)

301 ià(
wp
->
w_log
)

302 
	`WLogSŒšg
(
wp
, 
buf
, 
Ën
);

305 
cu¼
 = 
wp
;

306 
cŞs
 = 
cu¼
->
w_width
;

307 
rows
 = 
cu¼
->
w_height
;

309 ià(
cu¼
->
w_s’û
)

310 
	`S‘Timeout
(&
cu¼
->
w_s’ûev
, cu¼->
w_s’ûwa™
 * 1000);

312 ià(
cu¼
->
w_mÚ™Ü
 =ğ
MON_ON
)

314 
	`debug2
("ACTIVITY %d %d\n", 
cu¼
->
w_mÚ™Ü
, cu¼->
w_b–l
);

315 
cu¼
->
w_mÚ™Ü
 = 
MON_FOUND
;

320 
c
 = ()*
buf
++;

321 #ifdeà
FONT


322 #ifdeà
DW_CHARS


323 ià(!
cu¼
->
w_mbcs
)

325 
cu¼
->
w_»nd
.
fÚt
 = cu¼->
w_FÚtL
;

329 ià(
cu¼
->
w_¡©e
 =ğ
LIT
 &&

330 #ifdeà
UTF8


331 
cu¼
->
w_’codšg
 !ğ
UTF8
 &&

333 #ifdeà
DW_CHARS


334 !
	`is_dw_fÚt
(
cu¼
->
w_»nd
.
fÚt
) &&

335 #ifdeà
ENCODINGS


336 
cu¼
->
w_»nd
.
fÚt
 !ğ
KANA
 && !cu¼->
w_mbcs
 &&

339 #ifdeà
FONT


340 
cu¼
->
w_»nd
.
fÚt
 != '<' &&

342 
c
 >= ' ' && c != 0x7f &&

343 ((
c
 & 0x80è=ğ0 || ((ø>ğ0xa0 || !
cu¼
->
w_c1
è&& !cu¼->
w_gr
)è&& !cu¼->
w_ss
 &&

344 !
cu¼
->
w_š£¹
 && cu¼->
w_x
 < 
cŞs
 - 1)

346 
cu¼x
 = 
cu¼
->
w_x
;

347 *
imp
 = 
buf
 - 1;

349 
cu¼x
 < 
cŞs
 - 1)

351 
cu¼x
++;

352 ià(--
Ën
 == 0)

354 
c
 = ()*
buf
++;

355 ià(
c
 < ' ' || c =ğ0x7à|| ((ø& 0x80è&& ((ø< 0xa0 && 
cu¼
->
w_c1
è|| cu¼->
w_gr
)))

358 
cu¼x
 -ğ
cu¼
->
w_x
;

359 ià(
cu¼x
 > 0)

361 
	`MPutSŒ
(
cu¼
, 
imp
, 
cu¼x
, &cu¼->
w_»nd
, cu¼->
w_x
, cu¼->
w_y
);

362 
	`LPutSŒ
(&
cu¼
->
w_Ïy”
, 
imp
, 
cu¼x
, &cu¼->
w_»nd
, cu¼->
w_x
, cu¼->
w_y
);

363 
cu¼
->
w_x
 +ğ
cu¼x
;

365 ià(
Ën
 == 0)

370 #ifdeà
UTF8


371 ià(
cu¼
->
w_’codšg
 =ğ
UTF8
)

373 
c
 = 
	`FromUtf8
(c, &
cu¼
->
w_decode¡©e
);

374 ià(
c
 == -1)

376 ià(
c
 == -2)

378 
c
 = 
UCS_REPL
;

380 
buf
--;

381 
Ën
++;

383 ià(
c
 > 0xff)

384 
	`debug1
("»ad UNICODE %04x\n", 
c
);

388 
Œyagaš
:

389 
cu¼
->
w_¡©e
)

391 
PRIN
:

392 
c
)

395 
cu¼
->
w_¡©e
 = 
PRINESC
;

398 
	`PrštCh¬
(
c
);

401 
PRINESC
:

402 
c
)

405 
cu¼
->
w_¡©e
 = 
PRINCSI
;

408 
	`PrštCh¬
('\033');

409 
	`PrštCh¬
(
c
);

410 
cu¼
->
w_¡©e
 = 
PRIN
;

413 
PRINCSI
:

414 
c
)

417 
cu¼
->
w_¡©e
 = 
PRIN4
;

420 
	`PrštCh¬
('\033');

421 
	`PrštCh¬
('[');

422 
	`PrštCh¬
(
c
);

423 
cu¼
->
w_¡©e
 = 
PRIN
;

426 
PRIN4
:

427 
c
)

430 
cu¼
->
w_¡©e
 = 
LIT
;

431 
	`PrštFlush
();

432 ià(
cu¼
->
w_pdi¥Ïy
 && cu¼->w_pdi¥Ïy->
d_´štfd
 >= 0)

434 
	`şo£
(
cu¼
->
w_pdi¥Ïy
->
d_´štfd
);

435 
cu¼
->
w_pdi¥Ïy
->
d_´štfd
 = -1;

437 
cu¼
->
w_pdi¥Ïy
 = 0;

440 
	`PrštCh¬
('\033');

441 
	`PrštCh¬
('[');

442 
	`PrštCh¬
('4');

443 
	`PrštCh¬
(
c
);

444 
cu¼
->
w_¡©e
 = 
PRIN
;

447 
ASTR
:

448 ià(
c
 == 0)

450 ià(
c
 == '\033')

452 
cu¼
->
w_¡©e
 = 
STRESC
;

457 ià(!(
cu¼
->
w_SŒšgTy³
 =ğ
OSC
 && 
c
 < ' ' && c != '\005'))

458 ià(!
cu¼
->
w_c1
 || 
c
 != ('\\' ^ 0xc0))

460 
	`SŒšgCh¬
(
c
);

463 
c
 = '\\';

465 
STRESC
:

466 
c
)

469 ià(
	`SŒšgEnd
(è=ğ0 || 
Ën
 <= 1)

472 
cv
 = 
cu¼
->
w_Ïy”
.
l_cvli¡
; cv; cv = cv->
c_Êext
)

474 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

475 ià(
D_¡©us
 =ğ
STATUS_ON_WIN
)

478 ià(
cv
)

480 ià(
Ën
 > 
IOSIZE
 + 1)

481 
Ën
 = 
IOSIZE
 + 1;

482 
cu¼
->
w_ou’
 = 
Ën
 - 1;

483 
	`bcİy
(
buf
, 
cu¼
->
w_outbuf
, 
Ën
 - 1);

488 
	`SŒšgCh¬
('\033');

491 
cu¼
->
w_¡©e
 = 
ASTR
;

492 
	`SŒšgCh¬
('\033');

493 
	`SŒšgCh¬
(
c
);

497 
ESC
:

498 
c
)

501 
cu¼
->
w_NumArgs
 = 0;

502 
cu¼
->
w_š‹rmedŸ‹
 = 0;

503 
	`bz”o
((*è
cu¼
->
w_¬gs
, 
MAXARGS
 * ());

504 
cu¼
->
w_¡©e
 = 
CSI
;

507 
	`SŒšgS¹
(
OSC
);

510 
	`SŒšgS¹
(
APC
);

513 
	`SŒšgS¹
(
DCS
);

516 
	`SŒšgS¹
(
PM
);

519 
	`SŒšgS¹
(
GM
);

523 
	`SŒšgS¹
(
AKA
);

526 ià(
	`S³cŸl
(
c
))

528 
cu¼
->
w_¡©e
 = 
LIT
;

531 
	`debug1
("nÙ s³cŸl. c = %x\n", 
c
);

532 ià(
c
 >= ' ' && c <= '/')

534 ià(
cu¼
->
w_š‹rmedŸ‹
)

536 #ifdeà
DW_CHARS


537 ià(
cu¼
->
w_š‹rmedŸ‹
 == '$')

538 
c
 |= '$' << 8;

541 
c
 = -1;

543 
cu¼
->
w_š‹rmedŸ‹
 = 
c
;

545 ià(
c
 >= '0' && c <= '~')

547 
	`DoESC
(
c
, 
cu¼
->
w_š‹rmedŸ‹
);

548 
cu¼
->
w_¡©e
 = 
LIT
;

552 
cu¼
->
w_¡©e
 = 
LIT
;

553 
Œyagaš
;

557 
CSI
:

558 
c
)

562 ià(
cu¼
->
w_NumArgs
 < 
MAXARGS
)

564 ià(
cu¼
->
w_¬gs
[cu¼->
w_NumArgs
] < 100000000)

565 
cu¼
->
w_¬gs
[cu¼->
w_NumArgs
] =

566 10 * 
cu¼
->
w_¬gs
[cu¼->
w_NumArgs
] + (
c
 - '0');

571 ià(
cu¼
->
w_NumArgs
 < 
MAXARGS
)

572 
cu¼
->
w_NumArgs
++;

575 ià(
	`S³cŸl
(
c
))

577 ià(
c
 >= '@' && c <= '~')

579 ià(
cu¼
->
w_NumArgs
 < 
MAXARGS
)

580 
cu¼
->
w_NumArgs
++;

581 
	`DoCSI
(
c
, 
cu¼
->
w_š‹rmedŸ‹
);

582 ià(
cu¼
->
w_¡©e
 !ğ
PRIN
)

583 
cu¼
->
w_¡©e
 = 
LIT
;

585 ià((
c
 >= ' ' && c <= '/') || (c >= '<' && c <= '?'))

586 
cu¼
->
w_š‹rmedŸ‹
 = cu¼->w_š‹rmedŸ‹ ? -1 : 
c
;

589 
cu¼
->
w_¡©e
 = 
LIT
;

590 
Œyagaš
;

594 
LIT
:

596 #ifdeà
DW_CHARS


597 ià(
cu¼
->
w_mbcs
)

598 ià(
c
 <ğ' ' || c =ğ0x7à|| (ø>ğ0x80 && c < 0xa0 && 
cu¼
->
w_c1
))

599 
cu¼
->
w_mbcs
 = 0;

601 ià(
c
 < ' ')

603 ià(
c
 == '\033')

605 
cu¼
->
w_š‹rmedŸ‹
 = 0;

606 
cu¼
->
w_¡©e
 = 
ESC
;

607 ià(
cu¼
->
w_autßka
 < 0)

608 
cu¼
->
w_autßka
 = 0;

611 
	`S³cŸl
(
c
);

614 ià(
c
 >ğ0x80 && c < 0xa0 && 
cu¼
->
w_c1
)

615 #ifdeà
FONT


616 ià((
cu¼
->
w_FÚtR
 & 0xf0) != 0x20

617 #ifdeà
UTF8


618 || 
cu¼
->
w_’codšg
 =ğ
UTF8


623 
c
)

631 
	`DoESC
(
c
 ^ 0xc0, 0);

634 ià(
cu¼
->
w_autßka
 < 0)

635 
cu¼
->
w_autßka
 = 0;

636 
cu¼
->
w_NumArgs
 = 0;

637 
cu¼
->
w_š‹rmedŸ‹
 = 0;

638 
	`bz”o
((*è
cu¼
->
w_¬gs
, 
MAXARGS
 * ());

639 
cu¼
->
w_¡©e
 = 
CSI
;

642 
	`SŒšgS¹
(
DCS
);

650 #ifdeà
FONT


651 #ifdeà
DW_CHARS


652 ià(!
cu¼
->
w_mbcs
)

655 ià(
c
 < 0x80 || 
cu¼
->
w_gr
 == 0)

656 
cu¼
->
w_»nd
.
fÚt
 = cu¼->
w_FÚtL
;

657 #ifdeà
ENCODINGS


658 ià(
cu¼
->
w_gr
 =ğ2 && !cu¼->
w_ss
)

659 
cu¼
->
w_»nd
.
fÚt
 = cu¼->
w_FÚtE
;

662 
cu¼
->
w_»nd
.
fÚt
 = cu¼->
w_FÚtR
;

663 #ifdeà
DW_CHARS


666 #ifdeà
UTF8


667 ià(
cu¼
->
w_’codšg
 =ğ
UTF8
)

669 ià(
cu¼
->
w_»nd
.
fÚt
 == '0')

671 
mch¬
 
mc
, *
mı
;

673 
	`debug1
("SPECIAL %x\n", 
c
);

674 
mc
.
image
 = 
c
;

675 
mc
.
mbcs
 = 0;

676 
mc
.
fÚt
 = '0';

677 
mı
 = 
	`»code_mch¬
(&
mc
, 0, 
UTF8
);

678 
	`debug2
("%02x %02x\n", 
mı
->
image
, mı->
fÚt
);

679 
c
 = 
mı
->
image
 | mı->
fÚt
 << 8;

681 
cu¼
->
w_»nd
.
fÚt
 = 0;

683 #ifdeà
DW_CHARS


684 ià(
cu¼
->
w_’codšg
 =ğ
UTF8
 && 
c
 >ğ0x1100 && 
	`utf8_isdoubË
(c))

685 
cu¼
->
w_mbcs
 = 0xff;

687 ià(
cu¼
->
w_’codšg
 =ğ
UTF8
 && 
c
 >ğ0x0300 && 
	`utf8_iscomb
(c))

689 
ox
, 
oy
;

690 
mch¬
 
omc
;

692 
ox
 = 
cu¼
->
w_x
 - 1;

693 
oy
 = 
cu¼
->
w_y
;

694 ià(
ox
 < 0)

696 
ox
 = 
cu¼
->
w_width
 - 1;

697 
oy
--;

699 ià(
oy
 < 0)

700 
oy
 = 0;

701 
	`cİy_mlše2mch¬
(&
omc
, &
cu¼
->
w_mlšes
[
oy
], 
ox
);

702 ià(
omc
.
image
 =ğ0xfà&& omc.
fÚt
 == 0xff)

704 
ox
--;

705 ià(
ox
 >= 0)

707 
	`cİy_mlše2mch¬
(&
omc
, &
cu¼
->
w_mlšes
[
oy
], 
ox
);

708 
omc
.
mbcs
 = 0xff;

711 ià(
ox
 >= 0)

713 
	`utf8_hªdË_comb
(
c
, &
omc
);

714 
	`MFixLše
(
cu¼
, 
oy
, &
omc
);

715 
	`cİy_mch¬2mlše
(&
omc
, &
cu¼
->
w_mlšes
[
oy
], 
ox
);

716 
	`LPutCh¬
(&
cu¼
->
w_Ïy”
, &
omc
, 
ox
, 
oy
);

717 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, cu¼->
w_x
, cu¼->
w_y
);

721 
fÚt
 = 
cu¼
->
w_»nd
.font;

723 #ifdeà
DW_CHARS


724 #ifdeà
ENCODINGS


725 ià(
fÚt
 =ğ
KANA
 && 
cu¼
->
w_’codšg
 =ğ
SJIS
 && cu¼->
w_mbcs
 == 0)

728 
	`debug1
("%x may bfœ¡ oàSJIS\n", 
c
);

729 ià((0x81 <ğ
c
 && c <= 0x9f) || (0xe0 <= c && c <= 0xef))

731 
	`debug
("YES!\n");

732 
cu¼
->
w_mbcs
 = 
c
;

737 ià(
fÚt
 =ğ031 && 
c
 =ğ0x80 && !
cu¼
->
w_mbcs
)

738 
fÚt
 = 
cu¼
->
w_»nd
.font = 0;

739 ià(
	`is_dw_fÚt
(
fÚt
è&& 
c
 == ' ')

740 
fÚt
 = 
cu¼
->
w_»nd
.font = 0;

741 ià(
	`is_dw_fÚt
(
fÚt
è|| 
cu¼
->
w_mbcs
)

743 
t
 = 
c
;

744 ià(
cu¼
->
w_mbcs
 == 0)

746 
cu¼
->
w_mbcs
 = 
c
;

749 ià(
cu¼
->
w_x
 =ğ
cŞs
 - 1)

751 
cu¼
->
w_x
 +ğcu¼->
w_w¿p
 ? 1 : -1;

752 
	`debug1
("P©ched w_xØ%d\n", 
cu¼
->
w_x
);

754 #ifdeà
UTF8


755 ià(
cu¼
->
w_’codšg
 !ğ
UTF8
)

758 
c
 = 
cu¼
->
w_mbcs
;

759 #ifdeà
ENCODINGS


760 ià(
fÚt
 =ğ
KANA
 && 
cu¼
->
w_’codšg
 =ğ
SJIS
)

762 
	`debug2
("SJIS !! %x %x\n", 
c
, 
t
);

773 ià(0x40 <ğ
t
 && <= 0xfc && != 0x7f)

775 ià(
c
 <= 0x9f) c = (c - 0x81) * 2 + 0x21;

776 
c
 = (c - 0xc1) * 2 + 0x21;

777 ià(
t
 <= 0x7e) -= 0x1f;

778 ià(
t
 <= 0x9e) -= 0x20;

779 
t
 -ğ0x7e, 
c
++;

780 
cu¼
->
w_»nd
.
fÚt
 = 
KANJI
;

785 
c
 = 
t
;

786 
t
 = 0;

788 
	`debug2
("SJIS‡á” %x %x\n", 
c
, 
t
);

791 ià(
t
 && 
cu¼
->
w_gr
 && 
fÚt
 != 030 && font != 031)

793 
t
 &= 0x7f;

794 ià(
t
 < ' ')

795 
Œyagaš
;

797 ià(
t
 == '\177')

799 
cu¼
->
w_mbcs
 = 
t
;

803 ià(
fÚt
 =ğ'<' && 
c
 >= ' ')

805 
fÚt
 = 
cu¼
->
w_»nd
.font = 0;

806 
c
 |= 0x80;

808 #ifdeà
UTF8


809 ià(
cu¼
->
w_gr
 && cu¼->
w_’codšg
 !ğ
UTF8
)

811 ià(
cu¼
->
w_gr
)

814 #ifdeà
ENCODINGS


815 ià(
c
 =ğ0x80 && 
fÚt
 =ğ0 && 
cu¼
->
w_’codšg
 =ğ
GBK
)

816 
c
 = 0xa4;

818 
c
 &= 0x7f;

819 ià(
c
 < ' ' && 
fÚt
 != 031)

820 
Œyagaš
;

822 
c
 &= 0x7f;

823 ià(
c
 < ' ')

824 
Œyagaš
;

828 ià(
c
 == '\177')

830 
cu¼
->
w_»nd
.
image
 = 
c
;

831 #ifdeà
UTF8


832 ià(
cu¼
->
w_’codšg
 =ğ
UTF8
)

833 
cu¼
->
w_»nd
.
fÚt
 = 
c
 >> 8;

835 #ifdeà
DW_CHARS


836 
cu¼
->
w_»nd
.
mbcs
 = cu¼->
w_mbcs
;

838 ià(
cu¼
->
w_x
 < 
cŞs
 - 1)

840 ià(
cu¼
->
w_š£¹
)

842 
	`§ve_mlše
(&
cu¼
->
w_mlšes
[cu¼->
w_y
], 
cŞs
);

843 
	`MInsCh¬
(
cu¼
, &cu¼->
w_»nd
, cu¼->
w_x
, cu¼->
w_y
);

844 
	`LInsCh¬
(&
cu¼
->
w_Ïy”
, &cu¼->
w_»nd
, cu¼->
w_x
, cu¼->
w_y
, &
mlše_Şd
);

845 
cu¼
->
w_x
++;

849 
	`MPutCh¬
(
cu¼
, &cu¼->
w_»nd
, cu¼->
w_x
, cu¼->
w_y
);

850 
	`LPutCh¬
(&
cu¼
->
w_Ïy”
, &cu¼->
w_»nd
, cu¼->
w_x
, cu¼->
w_y
);

851 
cu¼
->
w_x
++;

854 ià(
cu¼
->
w_x
 =ğ
cŞs
 - 1)

856 
	`MPutCh¬
(
cu¼
, &cu¼->
w_»nd
, cu¼->
w_x
, cu¼->
w_y
);

857 
	`LPutCh¬
(&
cu¼
->
w_Ïy”
, &cu¼->
w_»nd
, cu¼->
w_x
, cu¼->
w_y
);

858 ià(
cu¼
->
w_w¿p
)

859 
cu¼
->
w_x
++;

863 
	`MW¿pCh¬
(
cu¼
, &cu¼->
w_»nd
, cu¼->
w_y
, cu¼->
w_tİ
, cu¼->
w_bÙ
, cu¼->
w_š£¹
);

864 
	`LW¿pCh¬
(&
cu¼
->
w_Ïy”
, &cu¼->
w_»nd
, cu¼->
w_y
, cu¼->
w_tİ
, cu¼->
w_bÙ
, cu¼->
w_š£¹
);

865 ià(
cu¼
->
w_y
 !ğcu¼->
w_bÙ
 && cu¼->w_y !ğcu¼->
w_height
 - 1)

866 
cu¼
->
w_y
++;

867 
cu¼
->
w_x
 = 1;

869 #ifdeà
FONT


870 #ifdeà
DW_CHARS


871 ià(
cu¼
->
w_mbcs
)

873 
cu¼
->
w_»nd
.
mbcs
 = cu¼->
w_mbcs
 = 0;

874 
cu¼
->
w_x
++;

877 ià(
cu¼
->
w_ss
)

879 
cu¼
->
w_FÚtL
 = cu¼->
w_ch¬£ts
[cu¼->
w_Ch¬£t
];

880 
cu¼
->
w_FÚtR
 = cu¼->
w_ch¬£ts
[cu¼->
w_Ch¬£tR
];

881 
cu¼
->
w_»nd
.
fÚt
 = cu¼->
w_FÚtL
;

882 
	`LS‘R’d™iÚ
(&
cu¼
->
w_Ïy”
, &cu¼->
w_»nd
);

883 
cu¼
->
w_ss
 = 0;

889 --
Ën
);

890 ià(!
´štcmd
 && 
cu¼
->
w_¡©e
 =ğ
PRIN
)

891 
	`PrštFlush
();

895 
	`WLogSŒšg
(
p
, 
buf
, 
Ën
)

896 
wš
 *
p
;

897 *
buf
;

898 
Ën
;

900 ià(!
p
->
w_log
)

902 ià(
logt¡amp_Ú
 && 
p
->
w_logs’û
 >ğ
logt¡amp_aá”
 * 2)

904 *
t
 = 
	`MakeWšMsg
(
logt¡amp_¡ršg
, 
p
, '%');

905 
	`logfwr™e
(
p
->
w_log
, 
t
, 
	`¡¾’
(t));

907 
p
->
w_logs’û
 = 0;

908 ià(
	`logfwr™e
(
p
->
w_log
, 
buf
, 
Ën
) < 1)

910 
	`WMsg
(
p
, 
”ºo
, "Error writing†ogfile");

911 
	`logfşo£
(
p
->
w_log
);

912 
p
->
w_log
 = 0;

914 ià(!
log_æush
)

915 
	`logfæush
(
p
->
w_log
);

919 
	`S³cŸl
(
c
)

920 
c
;

922 
c
)

925 
	`BackS·û
();

928 
	`R‘uº
();

931 ià(
cu¼
->
w_autßka
)

932 
	`FšdAKA
();

933 
	`LšeF“d
(0);

936 
	`WB–l
(
cu¼
, 
visu®_b–l
);

939 
	`FÜw¬dTab
();

941 #ifdeà
FONT


943 
	`M­Ch¬£t
(
G0
);

946 
	`M­Ch¬£t
(
G1
);

954 
	`DoESC
(
c
, 
š‹rmedŸ‹
)

955 
c
, 
š‹rmedŸ‹
;

957 
	`debug2
("DoESC: %x - iÁ” = %x\n", 
c
, 
š‹rmedŸ‹
);

958 
š‹rmedŸ‹
)

961 
c
)

964 
	`LšeF“d
(1);

967 
	`LšeF“d
(0);

970 
	`Rev”£LšeF“d
();

973 
cu¼
->
w_bs
[cu¼->
w_x
] = 1;

976 
	`R•Üt
("\033[?%d;%dc", 1, 2);

979 
	`SaveCursÜ
();

982 
	`Re¡ÜeCursÜ
();

985 
	`CË¬Sü“n
();

986 
	`Re£tWšdow
(
cu¼
);

987 
	`LKey·dMode
(&
cu¼
->
w_Ïy”
, 0);

988 
	`LCursÜkeysMode
(&
cu¼
->
w_Ïy”
, 0);

989 #iâdeà
TIOCPKT


990 
	`WNewAutoFlow
(
cu¼
, 1);

997 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, cu¼->
w_x
, cu¼->
w_y
);

1000 
	`LKey·dMode
(&
cu¼
->
w_Ïy”
, cu¼->
w_key·d
 = 1);

1001 #iâdeà
TIOCPKT


1002 
	`WNewAutoFlow
(
cu¼
, 0);

1006 
	`LKey·dMode
(&
cu¼
->
w_Ïy”
, cu¼->
w_key·d
 = 0);

1007 #iâdeà
TIOCPKT


1008 
	`WNewAutoFlow
(
cu¼
, 1);

1011 #ifdeà
FONT


1013 
	`M­Ch¬£t
(
G2
);

1016 
	`M­Ch¬£t
(
G3
);

1019 
	`M­Ch¬£tR
(
G1
);

1023 
	`M­Ch¬£tR
(
G2
);

1026 
	`M­Ch¬£tR
(
G3
);

1029 ià(
cu¼
->
w_ch¬£ts
[cu¼->
w_Ch¬£t
] !ğcu¼->w_ch¬£ts[
G2
]

1030 || 
cu¼
->
w_ch¬£ts
[cu¼->
w_Ch¬£tR
] !ğcu¼->w_ch¬£ts[
G2
])

1031 
cu¼
->
w_FÚtR
 = cu¼->
w_FÚtL
 = cu¼->
w_ch¬£ts
[cu¼->
w_ss
 = 
G2
];

1033 
cu¼
->
w_ss
 = 0;

1036 ià(
cu¼
->
w_ch¬£ts
[cu¼->
w_Ch¬£t
] !ğcu¼->w_ch¬£ts[
G3
]

1037 || 
cu¼
->
w_ch¬£ts
[cu¼->
w_Ch¬£tR
] !ğcu¼->w_ch¬£ts[
G3
])

1038 
cu¼
->
w_FÚtR
 = cu¼->
w_FÚtL
 = cu¼->
w_ch¬£ts
[cu¼->
w_ss
 = 
G3
];

1040 
cu¼
->
w_ss
 = 0;

1044 
	`WB–l
(
cu¼
, 1);

1049 
c
)

1052 
	`FlW™hEs
();

1056 #ifdeà
FONT


1058 
	`DesigÇ‹Ch¬£t
(
c
, 
G0
);

1061 
	`DesigÇ‹Ch¬£t
(
c
, 
G1
);

1064 
	`DesigÇ‹Ch¬£t
(
c
, 
G2
);

1067 
	`DesigÇ‹Ch¬£t
(
c
, 
G3
);

1069 #ifdeà
DW_CHARS


1079 
	`DesigÇ‹Ch¬£t
(
c
 & 037, 
G0
);

1082 
	`DesigÇ‹Ch¬£t
(
c
 & 037, 
G1
);

1085 
	`DesigÇ‹Ch¬£t
(
c
 & 037, 
G2
);

1088 
	`DesigÇ‹Ch¬£t
(
c
 & 037, 
G3
);

1096 
	`DoCSI
(
c
, 
š‹rmedŸ‹
)

1097 
c
, 
š‹rmedŸ‹
;

1099 
i
, 
a1
 = 
cu¼
->
w_¬gs
[0], 
a2
 = curr->w_args[1];

1101 ià(
cu¼
->
w_NumArgs
 > 
MAXARGS
)

1102 
cu¼
->
w_NumArgs
 = 
MAXARGS
;

1103 
š‹rmedŸ‹
)

1106 
c
)

1110 ià(
a1
 < 1)

1111 
a1
 = 1;

1112 ià(
cu¼
->
w_Üigš
)

1113 
a1
 +ğ
cu¼
->
w_tİ
;

1114 ià(
a1
 > 
rows
)

1115 
a1
 = 
rows
;

1116 ià(
a2
 < 1)

1117 
a2
 = 1;

1118 ià(
a2
 > 
cŞs
)

1119 
a2
 = 
cŞs
;

1120 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, --
a2
, --
a1
);

1121 
cu¼
->
w_x
 = 
a2
;

1122 
cu¼
->
w_y
 = 
a1
;

1123 ià(
cu¼
->
w_autßka
)

1124 
cu¼
->
w_autßka
 = 
a1
 + 1;

1127 ià(
a1
 < 0 ||‡1 > 2)

1128 
a1
 = 0;

1129 
a1
)

1132 
	`CË¬ToEOS
();

1135 
	`CË¬FromBOS
();

1138 
	`CË¬Sü“n
();

1139 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, cu¼->
w_x
, cu¼->
w_y
);

1144 ià(
a1
 < 0 ||‡1 > 2)

1145 
a1
 %= 3;

1146 
a1
)

1149 
	`CË¬LšeRegiÚ
(
cu¼
->
w_x
, 
cŞs
 - 1);

1152 
	`CË¬LšeRegiÚ
(0, 
cu¼
->
w_x
);

1155 
	`CË¬LšeRegiÚ
(0, 
cŞs
 - 1);

1160 
a1
 = 
cu¼
->
w_x
 + (a1 ?‡1 - 1 : 0);

1161 
	`CË¬LšeRegiÚ
(
cu¼
->
w_x
, 
a1
 < 
cŞs
 ?‡1 : cols - 1);

1164 
	`CursÜUp
(
a1
 ?‡1 : 1);

1167 
	`CursÜDown
(
a1
 ?‡1 : 1);

1170 
	`CursÜRight
(
a1
 ?‡1 : 1);

1173 
	`CursÜLeá
(
a1
 ?‡1 : 1);

1176 
cu¼
->
w_x
 = 0;

1177 
	`CursÜDown
(
a1
 ?‡1 : 1);

1180 
cu¼
->
w_x
 = 0;

1181 
	`CursÜUp
(
a1
 ?‡1 : 1);

1185 
cu¼
->
w_x
 = 
a1
 ?‡1 - 1 : 0;

1186 ià(
cu¼
->
w_x
 >ğ
cŞs
)

1187 
cu¼
->
w_x
 = 
cŞs
 - 1;

1188 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, cu¼->
w_x
, cu¼->
w_y
);

1191 
cu¼
->
w_y
 = 
a1
 ?‡1 - 1 : 0;

1192 ià(
cu¼
->
w_y
 >ğ
rows
)

1193 
cu¼
->
w_y
 = 
rows
 - 1;

1194 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, cu¼->
w_x
, cu¼->
w_y
);

1197 
	`S–eùR’d™iÚ
();

1200 ià(
a1
 == 0)

1201 
cu¼
->
w_bs
[cu¼->
w_x
] = 0;

1202 ià(
a1
 == 3)

1203 
	`bz”o
(
cu¼
->
w_bs
, 
cŞs
);

1206 ià(!
a1
)

1207 
a1
 = 1;

1208 ià(!
a2
)

1209 
a2
 = 
rows
;

1210 ià(
a1
 < 1 || 
a2
 > 
rows
 ||‡1 >=‡2)

1212 
cu¼
->
w_tİ
 = 
a1
 - 1;

1213 
cu¼
->
w_bÙ
 = 
a2
 - 1;

1215 ià(
cu¼
->
w_Üigš
)

1217 
cu¼
->
w_y
 = cu¼->
w_tİ
;

1218 
cu¼
->
w_x
 = 0;

1221 
cu¼
->
w_y
 = cu¼->
w_x
 = 0;

1222 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, cu¼->
w_x
, cu¼->
w_y
);

1225 
	`SaveCursÜ
();

1228 ià(
a1
 != 8)

1230 
a1
 = 
cu¼
->
w_¬gs
[2];

1231 ià(
a1
 < 1)

1232 
a1
 = 
cu¼
->
w_width
;

1233 ià(
a2
 < 1)

1234 
a2
 = 
cu¼
->
w_height
;

1235 ià(
a1
 > 10000 || 
a2
 > 10000)

1237 
	`WChªgeSize
(
cu¼
, 
a1
, 
a2
);

1238 
cŞs
 = 
cu¼
->
w_width
;

1239 
rows
 = 
cu¼
->
w_height
;

1242 
	`Re¡ÜeCursÜ
();

1245 ià(!
a1
)

1246 
a1
 = 1;

1247 
a1
--)

1248 
	`FÜw¬dTab
();

1251 ià(!
a1
)

1252 
a1
 = 1;

1253 
a1
--)

1254 
	`Backw¬dTab
();

1257 
	`In£¹Lše
(
a1
 ?‡1 : 1);

1260 
	`D–‘eLše
(
a1
 ?‡1 : 1);

1263 
	`D–‘eCh¬
(
a1
 ?‡1 : 1);

1266 
	`In£¹Ch¬
(
a1
 ?‡1 : 1);

1269 
	`AS‘Mode
(1);

1272 
	`AS‘Mode
(0);

1275 ià(
a1
 == 5)

1276 
	`PrštS¹
();

1279 ià(
a1
 == 5)

1280 
	`R•Üt
("\033[0n", 0, 0);

1281 ià(
a1
 == 6)

1282 
	`R•Üt
("\033[%d;%dR", 
cu¼
->
w_y
 + 1, cu¼->
w_x
 + 1);

1285 ià(
a1
 == 0)

1286 
	`R•Üt
("\033[?%d;%dc", 1, 2);

1289 ià(
a1
 == 0 ||‡1 == 1)

1290 
	`R•Üt
("\033[%d;1;1;112;112;1;0x", 
a1
 + 2, 0);

1293 ià(
a1
 == 6 ||‡1 == 7)

1295 
cu¼
->
w_curšv
 = 7 - 
a1
;

1296 
	`LCursÜVisib™y
(&
cu¼
->
w_Ïy”
, cu¼->
w_curšv
 ? -1 : cu¼->
w_curvvis
);

1300 
	`SüŞlRegiÚ
(
a1
 ?‡1 : 1);

1304 
	`SüŞlRegiÚ
(
a1
 ? -a1 : -1);

1309 
a2
 = 0;‡2 < 
cu¼
->
w_NumArgs
;‡2++)

1311 
a1
 = 
cu¼
->
w_¬gs
[
a2
];

1312 
	`debug2
("\\E[?%d%c\n",
a1
,
c
);

1313 ià(
c
 != 'h' && c != 'l')

1315 
i
 = (
c
 == 'h');

1316 
a1
)

1319 
	`LCursÜkeysMode
(&
cu¼
->
w_Ïy”
, cu¼->
w_cursÜkeys
 = 
i
);

1320 #iâdeà
TIOCPKT


1321 
	`WNewAutoFlow
(
cu¼
, !
i
);

1325 ià(
i
)

1327 #ifdeà
FONT


1328 #ifdeà
ENCODINGS


1329 ià(
cu¼
->
w_’codšg
)

1332 
cu¼
->
w_ch¬£ts
[0] = curr->w_charsets[1] =

1333 
cu¼
->
w_ch¬£ts
[2] = curr->w_charsets[2] =

1334 
cu¼
->
w_FÚtL
 = cu¼->
w_FÚtR
 = 
ASCII
;

1335 
cu¼
->
w_Ch¬£t
 = 0;

1336 
cu¼
->
w_Ch¬£tR
 = 2;

1337 
cu¼
->
w_ss
 = 0;

1342 
i
 = (˜? 
Z0width
 : 
Z1width
);

1343 
	`WChªgeSize
(
cu¼
, 
i
, cu¼->
w_height
);

1344 
cŞs
 = 
cu¼
->
w_width
;

1345 
rows
 = 
cu¼
->
w_height
;

1349 ià(
i
 !ğ
cu¼
->
w_»vvid
)

1350 
	`WRev”£Video
(
cu¼
, 
i
);

1351 
cu¼
->
w_»vvid
 = 
i
;

1354 ià((
cu¼
->
w_Üigš
 = 
i
) != 0)

1356 
cu¼
->
w_y
 = cu¼->
w_tİ
;

1357 
cu¼
->
w_x
 = 0;

1360 
cu¼
->
w_y
 = cu¼->
w_x
 = 0;

1361 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, cu¼->
w_x
, cu¼->
w_y
);

1364 
cu¼
->
w_w¿p
 = 
i
;

1369 
cu¼
->
w_mou£
 = 
i
 ? 9 : 0;

1370 
	`LMou£Mode
(&
cu¼
->
w_Ïy”
, cu¼->
w_mou£
);

1380 
cu¼
->
w_curšv
 = !
i
;

1381 
	`LCursÜVisib™y
(&
cu¼
->
w_Ïy”
, cu¼->
w_curšv
 ? -1 : cu¼->
w_curvvis
);

1393 ià(
u£_®tsü“n
)

1395 ià(
i
)

1396 
	`EÁ”AÉSü“n
(
cu¼
);

1398 
	`L—veAÉSü“n
(
cu¼
);

1399 ià(
a1
 =ğ47 && !
i
)

1400 
cu¼
->
w_§ved
 = 0;

1401 
	`LReäeshAÎ
(&
cu¼
->
w_Ïy”
, 0);

1402 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, cu¼->
w_x
, cu¼->
w_y
);

1411 
cu¼
->
w_mou£
 = 
i
 ? 
a1
 : 0;

1412 
	`LMou£Mode
(&
cu¼
->
w_Ïy”
, cu¼->
w_mou£
);

1418 
c
)

1421 ià(
a1
 == 0)

1422 
	`R•Üt
("\033[>%d;%d;0c", 83, 
nv”siÚ
);

1431 
	`SŒšgS¹
(
ty³
)

1432 
¡ršg_t
 
ty³
;

1434 
cu¼
->
w_SŒšgTy³
 = 
ty³
;

1435 
cu¼
->
w_¡ršgp
 = cu¼->
w_¡ršg
;

1436 
cu¼
->
w_¡©e
 = 
ASTR
;

1440 
	`SŒšgCh¬
(
c
)

1441 
c
;

1443 ià(
cu¼
->
w_¡ršgp
 >ğcu¼->
w_¡ršg
 + 
MAXSTR
 - 1)

1444 
cu¼
->
w_¡©e
 = 
LIT
;

1446 *(
cu¼
->
w_¡ršgp
)++ = 
c
;

1454 
	`SŒšgEnd
()

1456 
ÿnvas
 *
cv
;

1457 *
p
;

1458 
typ
;

1460 
cu¼
->
w_¡©e
 = 
LIT
;

1461 *
cu¼
->
w_¡ršgp
 = '\0';

1462 
cu¼
->
w_SŒšgTy³
)

1464 
OSC
:

1465 ià(
cu¼
->
w_¡ršg
[0] =ğ';' || (
p
 = 
	`šdex
(curr->w_string, ';')) == 0)

1467 
typ
 = 
	`©oi
(
cu¼
->
w_¡ršg
);

1468 
p
++;

1469 #ifdeà
MULTIUSER


1470 ià(
typ
 == 83)

1473 *
¬gs
[
MAXARGS
];

1474 
¬gl
[
MAXARGS
];

1475 
aşu£r
 *
wšdowu£r
;

1477 
wšdowu£r
 = *
	`FšdU£rPŒ
(":window:");

1478 ià(
wšdowu£r
 && 
	`P¬£
(
p
, (
cu¼
->
w_¡ršg
è- (°- cu¼->w_¡ršg), 
¬gs
, 
¬gl
))

1480 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

1481 ià(
D_fÜecv
->
c_Ïy”
->
l_bÙtom
 =ğ&
cu¼
->
w_Ïy”
)

1483 ià(
di¥Ïy
 =ğ0 && 
cu¼
->
w_Ïy”
.
l_cvli¡
)

1484 
di¥Ïy
 = 
cu¼
->
w_Ïy”
.
l_cvli¡
->
c_di¥Ïy
;

1485 ià(
di¥Ïy
 == 0)

1486 
di¥Ïy
 = 
di¥Ïys
;

1487 
EfãùiveAşU£r
 = 
wšdowu£r
;

1488 
fÜe
 = 
cu¼
;

1489 
æay”
 = 
fÜe
->
w_§v–ay”
 ? fÜe->w_§v–ay” : &fÜe->
w_Ïy”
;

1490 
	`DoCommªd
(
¬gs
, 
¬gl
);

1491 
EfãùiveAşU£r
 = 0;

1492 
fÜe
 = 0;

1493 
æay”
 = 0;

1498 #ifdeà
RXVT_OSC


1499 ià(
typ
 == 0 ||yp == 1 ||yp == 20 ||yp == 39 ||yp == 49)

1501 
typ2
;

1502 
typ2
 = 
typ
 / 10;

1503 ià(--
typ2
 < 0)

1504 
typ2
 = 0;

1505 ià(
	`¡rcmp
(
cu¼
->
w_x‹rmosc
[
typ2
], 
p
))

1507 
	`¡ºıy
(
cu¼
->
w_x‹rmosc
[
typ2
], 
p
, (curr->w_xtermosc[typ2]) - 1);

1508 
cu¼
->
w_x‹rmosc
[
typ2
][(curr->w_xtermosc[typ2]) - 1] = 0;

1510 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

1512 ià(!
D_CXT
)

1514 ià(
D_fÜecv
->
c_Ïy”
->
l_bÙtom
 =ğ&
cu¼
->
w_Ïy”
)

1515 
	`S‘X‹rmOSC
(
typ2
, 
cu¼
->
w_x‹rmosc
[typ2]);

1516 ià((
typ2
 =ğ2 ||yp2 =ğ3è&& 
D_x‹rmosc
[typ2])

1517 
	`Redi¥Ïy
(0);

1521 ià(
typ
 != 0 &&yp != 2)

1524 ià(
typ
 < 0 ||yp > 2)

1528 
cu¼
->
w_¡ršgp
 -ğ
p
 - cu¼->
w_¡ršg
;

1529 ià(
cu¼
->
w_¡ršgp
 > cu¼->
w_¡ršg
)

1530 
	`bcİy
(
p
, 
cu¼
->
w_¡ršg
, cu¼->
w_¡ršgp
 - curr->w_string);

1531 *
cu¼
->
w_¡ršgp
 = '\0';

1533 
APC
:

1534 ià(
cu¼
->
w_h¡©us
)

1536 ià(
	`¡rcmp
(
cu¼
->
w_h¡©us
, cu¼->
w_¡ršg
) == 0)

1538 
	`ä“
(
cu¼
->
w_h¡©us
);

1539 
cu¼
->
w_h¡©us
 = 0;

1541 ià(
cu¼
->
w_¡ršg
 !ğcu¼->
w_¡ršgp
)

1542 
cu¼
->
w_h¡©us
 = 
	`SaveSŒ
(cu¼->
w_¡ršg
);

1543 
	`WšdowChªged
(
cu¼
, 'h');

1545 
PM
:

1546 
GM
:

1547 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

1549 
cv
 = 
D_cvli¡
; cv; cv = cv->
c_Ãxt
)

1550 ià(
cv
->
c_Ïy”
->
l_bÙtom
 =ğ&
cu¼
->
w_Ïy”
)

1552 ià(
cv
 || 
cu¼
->
w_SŒšgTy³
 =ğ
GM
)

1553 
	`MakeStus
(
cu¼
->
w_¡ršg
);

1556 
DCS
:

1557 
	`LAY_DISPLAYS
(&
cu¼
->
w_Ïy”
, 
	`AddSŒ
(cu¼->
w_¡ršg
));

1559 
AKA
:

1560 ià(
cu¼
->
w_t™Ë
 =ğcu¼->
w_akabuf
 && !*cu¼->
w_¡ršg
)

1562 
	`ChªgeAKA
(
cu¼
, cu¼->
w_¡ršg
, 
	`¡¾’
(curr->w_string));

1563 ià(!*
cu¼
->
w_¡ršg
)

1564 
cu¼
->
w_autßka
 = cu¼->
w_y
 + 1;

1573 
	`PrštS¹
()

1575 
cu¼
->
w_pdi¥Ïy
 = 0;

1578 
di¥Ïy
 = 
cu¼
->
w_Ï¡di¥
;

1579 ià(!(
di¥Ïy
 && 
cu¼
 =ğ
D_fÜe
 && (
´štcmd
 || 
D_PO
)))

1580 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

1581 ià(
cu¼
 =ğ
D_fÜe
 && (
´štcmd
 || 
D_PO
))

1583 ià(!
di¥Ïy
)

1585 
ÿnvas
 *
cv
;

1586 
cv
 = 
cu¼
->
w_Ïy”
.
l_cvli¡
; cv; cv = cv->
c_Êext
)

1588 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

1589 ià(
´štcmd
 || 
D_PO
)

1592 ià(!
cv
)

1594 
di¥Ïy
 = 
di¥Ïys
;

1595 ià(!
di¥Ïy
 || di¥Ïy->
d_Ãxt
 || !(
´štcmd
 || 
D_PO
))

1599 
cu¼
->
w_pdi¥Ïy
 = 
di¥Ïy
;

1600 
cu¼
->
w_¡ršgp
 = cu¼->
w_¡ršg
;

1601 
cu¼
->
w_¡©e
 = 
PRIN
;

1602 ià(
´štcmd
 && 
cu¼
->
w_pdi¥Ïy
->
d_´štfd
 < 0)

1603 
cu¼
->
w_pdi¥Ïy
->
d_´štfd
 = 
	`´še
(cu¼, 
´štcmd
);

1607 
	`PrštCh¬
(
c
)

1608 
c
;

1610 ià(
cu¼
->
w_¡ršgp
 >ğcu¼->
w_¡ršg
 + 
MAXSTR
 - 1)

1611 
	`PrštFlush
();

1612 *(
cu¼
->
w_¡ršgp
)++ = 
c
;

1616 
	`PrštFlush
()

1618 
di¥Ïy
 = 
cu¼
->
w_pdi¥Ïy
;

1619 ià(
di¥Ïy
 && 
´štcmd
)

1621 *
bp
 = 
cu¼
->
w_¡ršg
;

1622 
Ën
 = 
cu¼
->
w_¡ršgp
 - cu¼->
w_¡ršg
;

1623 
r
;

1624 
Ën
 && 
di¥Ïy
->
d_´štfd
 >= 0)

1626 
r
 = 
	`wr™e
(
di¥Ïy
->
d_´štfd
, 
bp
, 
Ën
);

1627 ià(
r
 <= 0)

1629 
	`WMsg
(
cu¼
, 
”ºo
, "printing‡borted");

1630 
	`şo£
(
di¥Ïy
->
d_´štfd
);

1631 
di¥Ïy
->
d_´štfd
 = -1;

1634 
bp
 +ğ
r
;

1635 
Ën
 -ğ
r
;

1638 ià(
di¥Ïy
 && 
cu¼
->
w_¡ršgp
 > cu¼->
w_¡ršg
)

1640 
	`AddCSŒ
(
D_PO
);

1641 
	`AddSŒn
(
cu¼
->
w_¡ršg
, cu¼->
w_¡ršgp
 - curr->w_string);

1642 
	`AddCSŒ
(
D_PF
);

1643 
	`Flush
();

1645 
cu¼
->
w_¡ršgp
 = cu¼->
w_¡ršg
;

1650 
	`WNewAutoFlow
(
wš
, 
Ú
)

1651 
wš
 *win;

1652 
Ú
;

1654 
	`debug1
("WNewAutoFlow: %d\n", 
Ú
);

1655 ià(
wš
->
w_æow
 & 
FLOW_AUTOFLAG
)

1656 
wš
->
w_æow
 = 
FLOW_AUTOFLAG
 | (
FLOW_AUTO
|
FLOW_NOW
è* 
Ú
;

1658 
wš
->
w_æow
 = (wš->w_æow & ~
FLOW_AUTO
è| FLOW_AUTO * 
Ú
;

1659 
	`LS‘Flow
(&
wš
->
w_Ïy”
, wš->
w_æow
 & 
FLOW_NOW
);

1663 #ifdeà
FONT


1666 
	`DesigÇ‹Ch¬£t
(
c
, 
n
)

1667 
c
, 
n
;

1669 
cu¼
->
w_ss
 = 0;

1670 #ifdeà
ENCODINGS


1671 ià(
c
 == ('@' & 037))

1672 
c
 = 
KANJI
;

1674 ià(
c
 == 'B')

1675 
c
 = 
ASCII
;

1676 ià(
cu¼
->
w_ch¬£ts
[
n
] !ğ
c
)

1678 
cu¼
->
w_ch¬£ts
[
n
] = 
c
;

1679 ià(
cu¼
->
w_Ch¬£t
 =ğ
n
)

1681 
cu¼
->
w_FÚtL
 = 
c
;

1682 
cu¼
->
w_»nd
.
fÚt
 = cu¼->
w_FÚtL
;

1683 
	`LS‘R’d™iÚ
(&
cu¼
->
w_Ïy”
, &cu¼->
w_»nd
);

1685 ià(
cu¼
->
w_Ch¬£tR
 =ğ
n
)

1686 
cu¼
->
w_FÚtR
 = 
c
;

1691 
	`M­Ch¬£t
(
n
)

1692 
n
;

1694 
cu¼
->
w_ss
 = 0;

1695 ià(
cu¼
->
w_Ch¬£t
 !ğ
n
)

1697 
cu¼
->
w_Ch¬£t
 = 
n
;

1698 
cu¼
->
w_FÚtL
 = cu¼->
w_ch¬£ts
[
n
];

1699 
cu¼
->
w_»nd
.
fÚt
 = cu¼->
w_FÚtL
;

1700 
	`LS‘R’d™iÚ
(&
cu¼
->
w_Ïy”
, &cu¼->
w_»nd
);

1705 
	`M­Ch¬£tR
(
n
)

1706 
n
;

1708 
cu¼
->
w_ss
 = 0;

1709 ià(
cu¼
->
w_Ch¬£tR
 !ğ
n
)

1711 
cu¼
->
w_Ch¬£tR
 = 
n
;

1712 
cu¼
->
w_FÚtR
 = cu¼->
w_ch¬£ts
[
n
];

1714 
cu¼
->
w_gr
 = 1;

1720 
	`SaveCursÜ
()

1722 
cu¼
->
w_§ved
 = 1;

1723 
cu¼
->
w_Saved_x
 = cu¼->
w_x
;

1724 
cu¼
->
w_Saved_y
 = cu¼->
w_y
;

1725 
cu¼
->
w_SavedR’d
 = cu¼->
w_»nd
;

1726 #ifdeà
FONT


1727 
cu¼
->
w_SavedCh¬£t
 = cu¼->
w_Ch¬£t
;

1728 
cu¼
->
w_SavedCh¬£tR
 = cu¼->
w_Ch¬£tR
;

1729 
	`bcİy
((*è
cu¼
->
w_ch¬£ts
, (*ècu¼->
w_SavedCh¬£ts
,

1735 
	`Re¡ÜeCursÜ
()

1737 ià(!
cu¼
->
w_§ved
)

1739 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, cu¼->
w_Saved_x
, cu¼->
w_Saved_y
);

1740 
cu¼
->
w_x
 = cu¼->
w_Saved_x
;

1741 
cu¼
->
w_y
 = cu¼->
w_Saved_y
;

1742 
cu¼
->
w_»nd
 = cu¼->
w_SavedR’d
;

1743 #ifdeà
FONT


1744 
	`bcİy
((*è
cu¼
->
w_SavedCh¬£ts
, (*ècu¼->
w_ch¬£ts
,

1746 
cu¼
->
w_Ch¬£t
 = cu¼->
w_SavedCh¬£t
;

1747 
cu¼
->
w_Ch¬£tR
 = cu¼->
w_SavedCh¬£tR
;

1748 
cu¼
->
w_ss
 = 0;

1749 
cu¼
->
w_FÚtL
 = cu¼->
w_ch¬£ts
[cu¼->
w_Ch¬£t
];

1750 
cu¼
->
w_FÚtR
 = cu¼->
w_ch¬£ts
[cu¼->
w_Ch¬£tR
];

1752 
	`LS‘R’d™iÚ
(&
cu¼
->
w_Ïy”
, &cu¼->
w_»nd
);

1756 
	`BackS·û
()

1758 ià(
cu¼
->
w_x
 > 0)

1760 
cu¼
->
w_x
--;

1762 ià(
cu¼
->
w_w¿p
 && cu¼->
w_y
 > 0)

1764 
cu¼
->
w_x
 = 
cŞs
 - 1;

1765 
cu¼
->
w_y
--;

1767 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, cu¼->
w_x
, cu¼->
w_y
);

1771 
	`R‘uº
()

1773 ià(
cu¼
->
w_x
 == 0)

1775 
cu¼
->
w_x
 = 0;

1776 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, cu¼->
w_x
, cu¼->
w_y
);

1780 
	`LšeF“d
(
out_mode
)

1781 
out_mode
;

1784 ià(
out_mode
)

1785 
cu¼
->
w_x
 = 0;

1786 ià(
cu¼
->
w_y
 !ğcu¼->
w_bÙ
)

1788 ià(
cu¼
->
w_y
 < 
rows
-1)

1789 
cu¼
->
w_y
++;

1790 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, cu¼->
w_x
, cu¼->
w_y
);

1793 ià(
cu¼
->
w_autßka
 > 1)

1794 
cu¼
->
w_autßka
--;

1795 
	`MSüŞlV
(
cu¼
, 1, cu¼->
w_tİ
, cu¼->
w_bÙ
, 
CURR_BCE
);

1796 
	`LSüŞlV
(&
cu¼
->
w_Ïy”
, 1, cu¼->
w_tİ
, cu¼->
w_bÙ
, 
CURR_BCE
);

1797 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, cu¼->
w_x
, cu¼->
w_y
);

1801 
	`Rev”£LšeF“d
()

1803 ià(
cu¼
->
w_y
 =ğcu¼->
w_tİ
)

1805 
	`MSüŞlV
(
cu¼
, -1, cu¼->
w_tİ
, cu¼->
w_bÙ
, 
CURR_BCE
);

1806 
	`LSüŞlV
(&
cu¼
->
w_Ïy”
, -1, cu¼->
w_tİ
, cu¼->
w_bÙ
, 
CURR_BCE
);

1807 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, cu¼->
w_x
, cu¼->
w_y
);

1809 ià(
cu¼
->
w_y
 > 0)

1810 
	`CursÜUp
(1);

1814 
	`In£¹Ch¬
(
n
)

1815 
n
;

1817 
y
 = 
cu¼
->
w_y
, 
x
 = cu¼->
w_x
;

1819 ià(
n
 <= 0)

1821 ià(
x
 =ğ
cŞs
)

1822 
x
--;

1823 
	`§ve_mlše
(&
cu¼
->
w_mlšes
[
y
], 
cŞs
);

1824 
	`MSüŞlH
(
cu¼
, -
n
, 
y
, 
x
, cu¼->
w_width
 - 1, 
CURR_BCE
);

1825 
	`LSüŞlH
(&
cu¼
->
w_Ïy”
, -
n
, 
y
, 
x
, cu¼->
w_width
 - 1, 
CURR_BCE
, &
mlše_Şd
);

1826 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, 
x
, 
y
);

1830 
	`D–‘eCh¬
(
n
)

1831 
n
;

1833 
y
 = 
cu¼
->
w_y
, 
x
 = cu¼->
w_x
;

1835 ià(
x
 =ğ
cŞs
)

1836 
x
--;

1837 
	`§ve_mlše
(&
cu¼
->
w_mlšes
[
y
], 
cŞs
);

1838 
	`MSüŞlH
(
cu¼
, 
n
, 
y
, 
x
, cu¼->
w_width
 - 1, 
CURR_BCE
);

1839 
	`LSüŞlH
(&
cu¼
->
w_Ïy”
, 
n
, 
y
, 
x
, cu¼->
w_width
 - 1, 
CURR_BCE
, &
mlše_Şd
);

1840 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, 
x
, 
y
);

1844 
	`D–‘eLše
(
n
)

1845 
n
;

1847 ià(
cu¼
->
w_y
 < cu¼->
w_tİ
 || cu¼->w_y > cu¼->
w_bÙ
)

1849 ià(
n
 > 
cu¼
->
w_bÙ
 - cu¼->
w_y
 + 1)

1850 
n
 = 
cu¼
->
w_bÙ
 - cu¼->
w_y
 + 1;

1851 
	`MSüŞlV
(
cu¼
, 
n
, cu¼->
w_y
, cu¼->
w_bÙ
, 
CURR_BCE
);

1852 
	`LSüŞlV
(&
cu¼
->
w_Ïy”
, 
n
, cu¼->
w_y
, cu¼->
w_bÙ
, 
CURR_BCE
);

1853 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, cu¼->
w_x
, cu¼->
w_y
);

1857 
	`In£¹Lše
(
n
)

1858 
n
;

1860 ià(
cu¼
->
w_y
 < cu¼->
w_tİ
 || cu¼->w_y > cu¼->
w_bÙ
)

1862 ià(
n
 > 
cu¼
->
w_bÙ
 - cu¼->
w_y
 + 1)

1863 
n
 = 
cu¼
->
w_bÙ
 - cu¼->
w_y
 + 1;

1864 
	`MSüŞlV
(
cu¼
, -
n
, cu¼->
w_y
, cu¼->
w_bÙ
, 
CURR_BCE
);

1865 
	`LSüŞlV
(&
cu¼
->
w_Ïy”
, -
n
, cu¼->
w_y
, cu¼->
w_bÙ
, 
CURR_BCE
);

1866 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, cu¼->
w_x
, cu¼->
w_y
);

1870 
	`SüŞlRegiÚ
(
n
)

1871 
n
;

1873 
	`MSüŞlV
(
cu¼
, 
n
, cu¼->
w_tİ
, cu¼->
w_bÙ
, 
CURR_BCE
);

1874 
	`LSüŞlV
(&
cu¼
->
w_Ïy”
, 
n
, cu¼->
w_tİ
, cu¼->
w_bÙ
, 
CURR_BCE
);

1875 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, cu¼->
w_x
, cu¼->
w_y
);

1880 
	`FÜw¬dTab
()

1882 
x
 = 
cu¼
->
w_x
;

1884 ià(
x
 =ğ
cŞs
)

1886 
	`LšeF“d
(1);

1887 
x
 = 0;

1889 ià(
cu¼
->
w_bs
[
x
] && x < 
cŞs
 - 1)

1890 
x
++;

1891 
x
 < 
cŞs
 - 1 && !
cu¼
->
w_bs
[x])

1892 
x
++;

1893 
cu¼
->
w_x
 = 
x
;

1894 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, cu¼->
w_x
, cu¼->
w_y
);

1898 
	`Backw¬dTab
()

1900 
x
 = 
cu¼
->
w_x
;

1902 ià(
cu¼
->
w_bs
[
x
] && x > 0)

1903 
x
--;

1904 
x
 > 0 && !
cu¼
->
w_bs
[x])

1905 
x
--;

1906 
cu¼
->
w_x
 = 
x
;

1907 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, cu¼->
w_x
, cu¼->
w_y
);

1911 
	`CË¬Sü“n
()

1913 
	`LCË¬A»a
(&
cu¼
->
w_Ïy”
, 0, 0, cu¼->
w_width
 - 1, cu¼->
w_height
 - 1, 
CURR_BCE
, 1);

1914 #ifdeà
COPY_PASTE


1915 
	`MSüŞlV
(
cu¼
, cu¼->
w_height
, 0, cu¼->w_heighˆ- 1, 
CURR_BCE
);

1917 
	`MCË¬A»a
(
cu¼
, 0, 0, cu¼->
w_width
 - 1, cu¼->
w_height
 - 1, 
CURR_BCE
);

1922 
	`CË¬FromBOS
()

1924 
y
 = 
cu¼
->
w_y
, 
x
 = cu¼->
w_x
;

1926 
	`LCË¬A»a
(&
cu¼
->
w_Ïy”
, 0, 0, 
x
, 
y
, 
CURR_BCE
, 1);

1927 
	`MCË¬A»a
(
cu¼
, 0, 0, 
x
, 
y
, 
CURR_BCE
);

1928 
	`Re¡ÜePosR’d™iÚ
();

1932 
	`CË¬ToEOS
()

1934 
y
 = 
cu¼
->
w_y
, 
x
 = cu¼->
w_x
;

1936 ià(
x
 =ğ0 && 
y
 == 0)

1938 
	`CË¬Sü“n
();

1939 
	`Re¡ÜePosR’d™iÚ
();

1942 
	`LCË¬A»a
(&
cu¼
->
w_Ïy”
, 
x
, 
y
, 
cŞs
 - 1, 
rows
 - 1, 
CURR_BCE
, 1);

1943 
	`MCË¬A»a
(
cu¼
, 
x
, 
y
, 
cŞs
 - 1, 
rows
 - 1, 
CURR_BCE
);

1944 
	`Re¡ÜePosR’d™iÚ
();

1948 
	`CË¬LšeRegiÚ
(
äom
, 
to
)

1949 
äom
, 
to
;

1951 
y
 = 
cu¼
->
w_y
;

1952 
	`LCË¬A»a
(&
cu¼
->
w_Ïy”
, 
äom
, 
y
, 
to
, y, 
CURR_BCE
, 1);

1953 
	`MCË¬A»a
(
cu¼
, 
äom
, 
y
, 
to
, y, 
CURR_BCE
);

1954 
	`Re¡ÜePosR’d™iÚ
();

1958 
	`CursÜRight
(
n
)

1959 
n
;

1961 
x
 = 
cu¼
->
w_x
;

1963 ià(
x
 =ğ
cŞs
)

1965 
	`LšeF“d
(1);

1966 
x
 = 0;

1968 ià((
cu¼
->
w_x
 +ğ
n
è>ğ
cŞs
)

1969 
cu¼
->
w_x
 = 
cŞs
 - 1;

1970 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, cu¼->
w_x
, cu¼->
w_y
);

1974 
	`CursÜUp
(
n
)

1975 
n
;

1977 ià(
cu¼
->
w_y
 < cu¼->
w_tİ
)

1979 ià((
cu¼
->
w_y
 -ğ
n
) < 0)

1980 
cu¼
->
w_y
 = 0;

1983 ià((
cu¼
->
w_y
 -ğ
n
è< cu¼->
w_tİ
)

1984 
cu¼
->
w_y
 = cu¼->
w_tİ
;

1985 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, cu¼->
w_x
, cu¼->
w_y
);

1989 
	`CursÜDown
(
n
)

1990 
n
;

1992 ià(
cu¼
->
w_y
 > cu¼->
w_bÙ
)

1994 ià((
cu¼
->
w_y
 +ğ
n
è> 
rows
 - 1)

1995 
cu¼
->
w_y
 = 
rows
 - 1;

1998 ià((
cu¼
->
w_y
 +ğ
n
è> cu¼->
w_bÙ
)

1999 
cu¼
->
w_y
 = cu¼->
w_bÙ
;

2000 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, cu¼->
w_x
, cu¼->
w_y
);

2004 
	`CursÜLeá
(
n
)

2005 
n
;

2007 ià((
cu¼
->
w_x
 -ğ
n
) < 0)

2008 
cu¼
->
w_x
 = 0;

2009 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, cu¼->
w_x
, cu¼->
w_y
);

2013 
	`AS‘Mode
(
Ú
)

2014 
Ú
;

2016 
i
;

2018 
i
 = 0; i < 
cu¼
->
w_NumArgs
; ++i)

2020 
cu¼
->
w_¬gs
[
i
])

2024 
cu¼
->
w_š£¹
 = 
Ú
;

2025 
	`LAY_DISPLAYS
(&
cu¼
->
w_Ïy”
, 
	`In£¹Mode
(
Ú
));

2029 
cu¼
->
w_autŞf
 = 
Ú
;

2032 
cu¼
->
w_curvvis
 = !
Ú
;

2033 
	`LCursÜVisib™y
(&
cu¼
->
w_Ïy”
, cu¼->
w_curšv
 ? -1 : cu¼->
w_curvvis
);

2041 
»ndli¡
[] =

2043 ~((1 << 
NATTR
è- 1), 
A_BD
, 
A_DI
, 
A_SO
, 
A_US
, 
A_BL
, 0, 
A_RV
, 0, 0,

2045 0, 0, ~(
A_BD
|
A_SO
|
A_DI
), ~A_SO, ~
A_US
, ~
A_BL
, 0, ~
A_RV


2049 
	`S–eùR’d™iÚ
()

2051 #ifdeà
COLOR


2052 
j
, 
i
 = 0, 
a
 = 
cu¼
->
w_»nd
.
©Œ
, 
c
 = cu¼->w_»nd.
cŞÜ
;

2053 #ifdeà
COLORS256


2054 
cx
 = 
cu¼
->
w_»nd
.
cŞÜx
;

2057 
j
, 
i
 = 0, 
a
 = 
cu¼
->
w_»nd
.
©Œ
;

2062 
j
 = 
cu¼
->
w_¬gs
[
i
];

2063 #ifdeà
COLOR


2064 ià((
j
 =ğ38 || j =ğ48è&& 
i
 + 2 < 
cu¼
->
w_NumArgs
 && cu¼->
w_¬gs
[i + 1] == 5)

2066 
jj
;

2068 
i
 += 2;

2069 
jj
 = 
cu¼
->
w_¬gs
[
i
];

2070 ià(
jj
 < 0 || jj > 255)

2072 #ifdeà
COLORS256


2073 ià(
j
 == 38)

2075 
c
 = (ø& 0xf0è| ((
jj
 & 0x0f) ^ 9);

2076 
a
 |ğ
A_BFG
;

2077 ià(
jj
 >= 8 && jj < 16)

2078 
c
 |= 0x08;

2080 
a
 ^ğ
A_BFG
;

2081 
a
 = (¨& 0xbfè| (
jj
 & 8 ? 0x40 : 0);

2082 
cx
 = (cx & 0xf0è| (
jj
 >> 4 & 0x0f);

2086 
c
 = (ø& 0x0fè| ((
jj
 & 0x0f) ^ 9) << 4;

2087 
a
 |ğ
A_BBG
;

2088 ià(
jj
 >= 8 && jj < 16)

2089 
c
 |= 0x80;

2091 
a
 ^ğ
A_BBG
;

2092 
cx
 = (cx & 0x0fè| (
jj
 & 0xf0);

2096 
jj
 = 
	`cŞÜ256to16
(jj) + 30;

2097 ià(
jj
 >= 38)

2098 
jj
 += 60 - 8;

2099 
j
 = j =ğ38 ? 
jj
 : jj + 10;

2102 #ifdeà
COLORS16


2103 ià(
j
 == 0 || (j >= 30 && j <= 39 && j != 38))

2104 
a
 &= 0xbf;

2105 ià(
j
 == 0 || (j >= 40 && j <= 49 && j != 48))

2106 
a
 &= 0x7f;

2107 ià(
j
 >= 90 && j <= 97)

2108 
a
 |= 0x40;

2109 ià(
j
 >= 100 && j <= 107)

2110 
a
 |= 0x80;

2112 ià(
j
 >= 90 && j <= 97)

2113 
j
 -= 60;

2114 ià(
j
 >= 100 && j <= 107)

2115 
j
 -= 60;

2116 ià(
j
 >= 30 && j <= 39 && j != 38)

2117 
c
 = (ø& 0xf0è| ((
j
 - 30) ^ 9);

2118 ià(
j
 >= 40 && j <= 49 && j != 48)

2119 
c
 = (ø& 0x0fè| (((
j
 - 40) ^ 9) << 4);

2120 ià(
j
 == 0)

2121 
c
 = 0;

2122 #ifdeà
COLORS256


2123 ià(
j
 == 0 || (j >= 30 && j <= 39 && j != 38))

2124 
cx
 &= 0xf0;

2125 ià(
j
 == 0 || (j >= 40 && j <= 49 && j != 48))

2126 
cx
 &= 0x0f;

2129 ià(
j
 < 0 || j >ğ()((
»ndli¡
)/(*rendlist)))

2131 
j
 = 
»ndli¡
[j];

2132 ià(
j
 & (1 << 
NATTR
))

2133 
a
 &ğ
j
;

2135 
a
 |ğ
j
;

2137 ++
i
 < 
cu¼
->
w_NumArgs
);

2138 
cu¼
->
w_»nd
.
©Œ
 = 
a
;

2139 #ifdeà
COLOR


2140 
cu¼
->
w_»nd
.
cŞÜ
 = 
c
;

2141 #ifdeà
COLORS256


2142 
cu¼
->
w_»nd
.
cŞÜx
 = 
cx
;

2145 
	`LS‘R’d™iÚ
(&
cu¼
->
w_Ïy”
, &cu¼->
w_»nd
);

2149 
	`FlW™hEs
()

2151 
i
;

2152 *
p
, *
•
;

2154 
	`LCË¬AÎ
(&
cu¼
->
w_Ïy”
, 1);

2155 
cu¼
->
w_y
 = cu¼->
w_x
 = 0;

2156 
i
 = 0; i < 
rows
; ++i)

2158 
	`ş—r_mlše
(&
cu¼
->
w_mlšes
[
i
], 0, 
cŞs
 + 1);

2159 
p
 = 
cu¼
->
w_mlšes
[
i
].
image
;

2160 
•
 = 
p
 + 
cŞs
;

2161 
p
 < 
•
)

2162 *
p
++ = 'E';

2164 
	`LReäeshAÎ
(&
cu¼
->
w_Ïy”
, 1);

2175 
	`ChªgeAKA
(
p
, 
s
, 
l
)

2176 
wš
 *
p
;

2177 *
s
;

2178 
l
;

2180 
i
, 
c
;

2182 
i
 = 0; 
l
 > 0;†--)

2184 ià(
p
->
w_akachªge
 + 
i
 =ğp->
w_akabuf
 + (p->w_akabuf) - 1)

2186 
c
 = ()*
s
++;

2187 ià(
c
 == 0)

2189 ià(
c
 < 32 || c =ğ127 || (ø>ğ128 && c < 160 && 
p
->
w_c1
))

2191 
p
->
w_akachªge
[
i
++] = 
c
;

2193 
p
->
w_akachªge
[
i
] = 0;

2194 
p
->
w_t™Ë
 =…->
w_akachªge
;

2195 ià(
p
->
w_akachªge
 !ğp->
w_akabuf
)

2196 ià(
p
->
w_akachªge
[0] == 0 ||…->w_akachange[-1] == ':')

2197 
p
->
w_t™Ë
 =…->
w_akabuf
 + 
	`¡¾’
(p->w_akabuf) + 1;

2198 
	`WšdowChªged
(
p
, 't');

2199 
	`WšdowChªged
((
wš
 *)0, 'w');

2200 
	`WšdowChªged
((
wš
 *)0, 'W');

2204 
	`FšdAKA
()

2206 *
ı
, *
lše
;

2207 
wš
 *
wp
 = 
cu¼
;

2208 
Ën
 = 
	`¡¾’
(
wp
->
w_akabuf
);

2209 
y
;

2211 
y
 = (
wp
->
w_autßka
 > 0 && wp->w_autßk¨<ğwp->
w_height
è? wp->w_autßk¨- 1 : wp->
w_y
;

2212 
cŞs
 = 
wp
->
w_width
;

2213 
Œy_lše
:

2214 
ı
 = 
lše
 = 
wp
->
w_mlšes
[
y
].
image
;

2215 ià(
wp
->
w_autßka
 > 0 && *wp->
w_akabuf
 != '\0')

2219 ià(
ı
 - 
lše
 >ğ
cŞs
 - 
Ën
)

2221 ià(++
y
 =ğ
wp
->
w_autßka
 && y < 
rows
)

2222 
Œy_lše
;

2225 ià(
	`¡ºcmp
((*)
ı
, 
wp
->
w_akabuf
, 
Ën
) == 0)

2227 
ı
++;

2229 
ı
 +ğ
Ën
;

2231 
Ën
 = 
cŞs
 - (
ı
 - 
lše
);†en && *cp == ' ';†en--, cp++)

2233 ià(
Ën
)

2235 ià(
wp
->
w_autßka
 > 0 && (*
ı
 == '!' || *cp == '%' || *cp == '^'))

2236 
wp
->
w_autßka
 = -1;

2238 
wp
->
w_autßka
 = 0;

2239 
lše
 = 
ı
;

2240 
Ën
 && *
ı
 != ' ')

2242 ià(*
ı
++ == '/')

2243 
lše
 = 
ı
;

2244 
Ën
--;

2246 
	`ChªgeAKA
(
wp
, (*)
lše
, 
ı
 -†ine);

2249 
wp
->
w_autßka
 = 0;

2253 
	`Re¡ÜePosR’d™iÚ
()

2255 
	`LGÙoPos
(&
cu¼
->
w_Ïy”
, cu¼->
w_x
, cu¼->
w_y
);

2256 
	`LS‘R’d™iÚ
(&
cu¼
->
w_Ïy”
, &cu¼->
w_»nd
);

2261 
	`R•Üt
(
fmt
, 
n1
, 
n2
)

2262 *
fmt
;

2263 
n1
, 
n2
;

2265 
Ën
;

2266 
rbuf
[40];

2268 
	`¥rštf
(
rbuf
, 
fmt
, 
n1
, 
n2
);

2269 
Ën
 = 
	`¡¾’
(
rbuf
);

2271 ià(()(
cu¼
->
w_šËn
 + 
Ën
è<ğ(cu¼->
w_šbuf
))

2273 
	`bcİy
(
rbuf
, 
cu¼
->
w_šbuf
 + cu¼->
w_šËn
, 
Ën
);

2274 
cu¼
->
w_šËn
 +ğ
Ën
;

2292 
	`MFixLše
(
p
, 
y
, 
mc
)

2293 
wš
 *
p
;

2294 
y
;

2295 
mch¬
 *
mc
;

2297 
mlše
 *
ml
 = &
p
->
w_mlšes
[
y
];

2298 ià(
mc
->
©Œ
 && 
ml
->©Œ =ğ
nuÎ
)

2300 ià((
ml
->
©Œ
 = (*)
	`m®loc
(
p
->
w_width
 + 1)) == 0)

2302 
ml
->
©Œ
 = 
nuÎ
;

2303 
mc
->
©Œ
 = 
p
->
w_»nd
.attr = 0;

2304 
	`WMsg
(
p
, 0, "Warning:‚o space for‡ttr -urned off");

2306 
	`bz”o
((*)
ml
->
©Œ
, 
p
->
w_width
 + 1);

2308 #ifdeà
FONT


2309 ià(
mc
->
fÚt
 && 
ml
->fÚˆ=ğ
nuÎ
)

2311 ià((
ml
->
fÚt
 = (*)
	`m®loc
(
p
->
w_width
 + 1)) == 0)

2313 
ml
->
fÚt
 = 
nuÎ
;

2314 
p
->
w_FÚtL
 =…->
w_ch¬£ts
[p->
w_ss
 ?…->w_s :…->
w_Ch¬£t
] = 0;

2315 
p
->
w_FÚtR
 =…->
w_ch¬£ts
[p->
w_ss
 ?…->w_s :…->
w_Ch¬£tR
] = 0;

2316 
mc
->
fÚt
 = 
p
->
w_»nd
.font = 0;

2317 
	`WMsg
(
p
, 0, "Warning:‚o space for font -urned off");

2319 
	`bz”o
((*)
ml
->
fÚt
, 
p
->
w_width
 + 1);

2322 #ifdeà
COLOR


2323 ià(
mc
->
cŞÜ
 && 
ml
->cŞÜ =ğ
nuÎ
)

2325 ià((
ml
->
cŞÜ
 = (*)
	`m®loc
(
p
->
w_width
 + 1)) == 0)

2327 
ml
->
cŞÜ
 = 
nuÎ
;

2328 
mc
->
cŞÜ
 = 
p
->
w_»nd
.color = 0;

2329 
	`WMsg
(
p
, 0, "Warning:‚o space for color -urned off");

2331 
	`bz”o
((*)
ml
->
cŞÜ
, 
p
->
w_width
 + 1);

2333 #ifdeà
COLORS256


2334 ià(
mc
->
cŞÜx
 && 
ml
->cŞÜx =ğ
nuÎ
)

2336 ià((
ml
->
cŞÜx
 = (*)
	`m®loc
(
p
->
w_width
 + 1)) == 0)

2338 
ml
->
cŞÜx
 = 
nuÎ
;

2339 
mc
->
cŞÜx
 = 
p
->
w_»nd
.colorx = 0;

2340 
	`WMsg
(
p
, 0, "Warning:‚o space forƒxtended colors -urned off");

2342 
	`bz”o
((*)
ml
->
cŞÜx
, 
p
->
w_width
 + 1);

2350 #ifdeà
DW_CHARS


2351 
	#MKlDwRight
(
p
, 
ml
, 
x
) \

2352 ià(
	`dw_right
(
ml
, 
x
, 
p
->
w_’codšg
)) \

2354 ià(
x
 > 0) \

2355 
	`cİy_mch¬2mlše
(&
mch¬_bÏnk
, 
ml
, 
x
 - 1); \

2356 
	`cİy_mch¬2mlše
(&
mch¬_bÏnk
, 
ml
, 
x
); \

2357 }

	)

2359 
	#MKlDwLeá
(
p
, 
ml
, 
x
) \

2360 ià(
	`dw_Ëá
(
ml
, 
x
, 
p
->
w_’codšg
)) \

2362 
	`cİy_mch¬2mlše
(&
mch¬_bÏnk
, 
ml
, 
x
); \

2363 
	`cİy_mch¬2mlše
(&
mch¬_bÏnk
, 
ml
, 
x
 + 1); \

2364 }

	)

2366 
	#MKlDwRight
(
p
, 
ml
, 
x
è;

	)

2367 
	#MKlDwLeá
(
p
, 
ml
, 
x
è;

	)

2371 
	`MSüŞlH
(
p
, 
n
, 
y
, 
xs
, 
xe
, 
bû
)

2372 
wš
 *
p
;

2373 
n
, 
y
, 
xs
, 
xe
, 
bû
;

2375 
mlše
 *
ml
;

2377 ià(
n
 == 0)

2379 
ml
 = &
p
->
w_mlšes
[
y
];

2380 
	`MKlDwRight
(
p
, 
ml
, 
xs
);

2381 
	`MKlDwLeá
(
p
, 
ml
, 
xe
);

2382 ià(
n
 > 0)

2384 ià(
xe
 - 
xs
 + 1 > 
n
)

2386 
	`MKlDwRight
(
p
, 
ml
, 
xs
 + 
n
);

2387 
	`bcİy_mlše
(
ml
, 
xs
 + 
n
, xs, 
xe
 + 1 - xs -‚);

2390 
n
 = 
xe
 - 
xs
 + 1;

2391 
	`ş—r_mlše
(
ml
, 
xe
 + 1 - 
n
,‚);

2392 #ifdeà
COLOR


2393 ià(
bû
)

2394 
	`MBûLše
(
p
, 
y
, 
xe
 + 1 - 
n
,‚, 
bû
);

2399 
n
 = -n;

2400 ià(
xe
 - 
xs
 + 1 > 
n
)

2402 
	`MKlDwLeá
(
p
, 
ml
, 
xe
 - 
n
);

2403 
	`bcİy_mlše
(
ml
, 
xs
, x + 
n
, 
xe
 + 1 - xs -‚);

2406 
n
 = 
xe
 - 
xs
 + 1;

2407 
	`ş—r_mlše
(
ml
, 
xs
, 
n
);

2408 #ifdeà
COLOR


2409 ià(
bû
)

2410 
	`MBûLše
(
p
, 
y
, 
xs
, 
n
, 
bû
);

2416 
	`MSüŞlV
(
p
, 
n
, 
ys
, 
ye
, 
bû
)

2417 
wš
 *
p
;

2418 
n
, 
ys
, 
ye
, 
bû
;

2420 
i
, 
út1
, 
út2
;

2421 
mlše
 
tmp
[256];

2422 
mlše
 *
ml
;

2424 ià(
n
 == 0)

2426 ià(
n
 > 0)

2428 ià(
n
 > 256)

2430 
	`MSüŞlV
(
p
, 
n
 - 256, 
ys
, 
ye
, 
bû
);

2431 
n
 = 256;

2433 ià(
ye
 - 
ys
 + 1 < 
n
)

2434 
n
 = 
ye
 - 
ys
 + 1;

2435 #ifdeà
COPY_PASTE


2436 ià(
com·ùhi¡
)

2438 
ye
 = 
	`MFšdU£dLše
(
p
, ye, 
ys
);

2439 ià(
ye
 - 
ys
 + 1 < 
n
)

2440 
n
 = 
ye
 - 
ys
 + 1;

2441 ià(
n
 <= 0)

2446 
ml
 = 
p
->
w_mlšes
 + 
ys
;

2447 
i
 = 
ys
; i < y + 
n
; i++, 
ml
++)

2449 #ifdeà
COPY_PASTE


2450 ià(
ys
 =ğ
p
->
w_tİ
)

2451 
	`WAddLšeToHi¡
(
p
, 
ml
);

2453 ià(
ml
->
©Œ
 !ğ
nuÎ
)

2454 
	`ä“
(
ml
->
©Œ
);

2455 
ml
->
©Œ
 = 
nuÎ
;

2456 #ifdeà
FONT


2457 ià(
ml
->
fÚt
 !ğ
nuÎ
)

2458 
	`ä“
(
ml
->
fÚt
);

2459 
ml
->
fÚt
 = 
nuÎ
;

2461 #ifdeà
COLOR


2462 ià(
ml
->
cŞÜ
 !ğ
nuÎ
)

2463 
	`ä“
(
ml
->
cŞÜ
);

2464 
ml
->
cŞÜ
 = 
nuÎ
;

2465 #ifdeà
COLORS256


2466 ià(
ml
->
cŞÜx
 !ğ
nuÎ
)

2467 
	`ä“
(
ml
->
cŞÜx
);

2468 
ml
->
cŞÜx
 = 
nuÎ
;

2471 
	`bş—r
((*)
ml
->
image
, 
p
->
w_width
 + 1);

2472 #ifdeà
COLOR


2473 ià(
bû
)

2474 
	`MBûLše
(
p
, 
i
, 0,…->
w_width
, 
bû
);

2478 
út1
 = 
n
 * (
mlše
);

2479 
út2
 = (
ye
 - 
ys
 + 1 - 
n
è* (
mlše
);

2480 ià(
út1
 && 
út2
)

2481 
	`SüŞl
((*)(
p
->
w_mlšes
 + 
ys
), 
út1
, 
út2
, (*)
tmp
);

2485 ià(
n
 < -256)

2487 
	`MSüŞlV
(
p
, 
n
 + 256, 
ys
, 
ye
, 
bû
);

2488 
n
 = -256;

2490 
n
 = -n;

2491 ià(
ye
 - 
ys
 + 1 < 
n
)

2492 
n
 = 
ye
 - 
ys
 + 1;

2494 
ml
 = 
p
->
w_mlšes
 + 
ye
;

2496 
i
 = 
ye
; i > y- 
n
; i--, 
ml
--)

2498 ià(
ml
->
©Œ
 !ğ
nuÎ
)

2499 
	`ä“
(
ml
->
©Œ
);

2500 
ml
->
©Œ
 = 
nuÎ
;

2501 #ifdeà
FONT


2502 ià(
ml
->
fÚt
 !ğ
nuÎ
)

2503 
	`ä“
(
ml
->
fÚt
);

2504 
ml
->
fÚt
 = 
nuÎ
;

2506 #ifdeà
COLOR


2507 ià(
ml
->
cŞÜ
 !ğ
nuÎ
)

2508 
	`ä“
(
ml
->
cŞÜ
);

2509 
ml
->
cŞÜ
 = 
nuÎ
;

2510 #ifdeà
COLORS256


2511 ià(
ml
->
cŞÜx
 !ğ
nuÎ
)

2512 
	`ä“
(
ml
->
cŞÜx
);

2513 
ml
->
cŞÜx
 = 
nuÎ
;

2516 
	`bş—r
((*)
ml
->
image
, 
p
->
w_width
 + 1);

2517 #ifdeà
COLOR


2518 ià(
bû
)

2519 
	`MBûLše
(
p
, 
i
, 0,…->
w_width
, 
bû
);

2522 
út1
 = 
n
 * (
mlše
);

2523 
út2
 = (
ye
 - 
ys
 + 1 - 
n
è* (
mlše
);

2524 ià(
út1
 && 
út2
)

2525 
	`SüŞl
((*)(
p
->
w_mlšes
 + 
ys
), 
út2
, 
út1
, (*)
tmp
);

2530 
	`SüŞl
(
ı
, 
út1
, 
út2
, 
tmp
)

2531 *
ı
, *
tmp
;

2532 
út1
, 
út2
;

2534 ià(!
út1
 || !
út2
)

2536 ià(
út1
 <ğ
út2
)

2538 
	`bcİy
(
ı
, 
tmp
, 
út1
);

2539 
	`bcİy
(
ı
 + 
út1
, cp, 
út2
);

2540 
	`bcİy
(
tmp
, 
ı
 + 
út2
, 
út1
);

2544 
	`bcİy
(
ı
 + 
út1
, 
tmp
, 
út2
);

2545 
	`bcİy
(
ı
, c°+ 
út2
, 
út1
);

2546 
	`bcİy
(
tmp
, 
ı
, 
út2
);

2551 
	`MCË¬A»a
(
p
, 
xs
, 
ys
, 
xe
, 
ye
, 
bû
)

2552 
wš
 *
p
;

2553 
xs
, 
ys
, 
xe
, 
ye
, 
bû
;

2555 
n
, 
y
;

2556 
xxe
;

2557 
mlše
 *
ml
;

2560 ià(
xs
 >ğ
p
->
w_width
)

2561 
xs
 = 
p
->
w_width
 - 1;

2562 ià(
xe
 >ğ
p
->
w_width
)

2563 
xe
 = 
p
->
w_width
 - 1;

2565 
	`MKlDwRight
(
p
,…->
w_mlšes
 + 
ys
, 
xs
);

2566 
	`MKlDwLeá
(
p
,…->
w_mlšes
 + 
ye
, 
xe
);

2568 
ml
 = 
p
->
w_mlšes
 + 
ys
;

2569 
y
 = 
ys
; y <ğ
ye
; y++, 
ml
++)

2571 
xxe
 = (
y
 =ğ
ye
è? 
xe
 : 
p
->
w_width
 - 1;

2572 
n
 = 
xxe
 - 
xs
 + 1;

2573 ià(
n
 > 0)

2574 
	`ş—r_mlše
(
ml
, 
xs
, 
n
);

2575 #ifdeà
COLOR


2576 ià(
n
 > 0 && 
bû
)

2577 
	`MBûLše
(
p
, 
y
, 
xs
, x + 
n
 - 1, 
bû
);

2579 
xs
 = 0;

2584 
	`MInsCh¬
(
p
, 
c
, 
x
, 
y
)

2585 
wš
 *
p
;

2586 
mch¬
 *
c
;

2587 
x
, 
y
;

2589 
n
;

2590 
mlše
 *
ml
;

2592 
	`ASSERT
(
x
 >ğ0 && x < 
p
->
w_width
);

2593 
	`MFixLše
(
p
, 
y
, 
c
);

2594 
ml
 = 
p
->
w_mlšes
 + 
y
;

2595 
n
 = 
p
->
w_width
 - 
x
 - 1;

2596 
	`MKlDwRight
(
p
, 
ml
, 
x
);

2597 ià(
n
 > 0)

2599 
	`MKlDwRight
(
p
, 
ml
,…->
w_width
 - 1);

2600 
	`bcİy_mlše
(
ml
, 
x
, x + 1, 
n
);

2602 
	`cİy_mch¬2mlše
(
c
, 
ml
, 
x
);

2603 #ifdeà
DW_CHARS


2604 ià(
c
->
mbcs
)

2606 ià(--
n
 > 0)

2608 
	`MKlDwRight
(
p
, 
ml
,…->
w_width
 - 1);

2609 
	`bcİy_mlše
(
ml
, 
x
 + 1, x + 2, 
n
);

2611 
	`cİy_mch¬2mlše
(
c
, 
ml
, 
x
 + 1);

2612 
ml
->
image
[
x
 + 1] = 
c
->
mbcs
;

2613 #ifdeà
UTF8


2614 ià(
p
->
w_’codšg
 !ğ
UTF8
)

2615 
ml
->
fÚt
[
x
 + 1] |= 0x80;

2616 ià(
p
->
w_’codšg
 =ğ
UTF8
 && 
c
->
mbcs
)

2617 
ml
->
fÚt
[
x
 + 1] = 
c
->
mbcs
;

2619 
ml
->
fÚt
[
x
 + 1] |= 0x80;

2626 
	`MPutCh¬
(
p
, 
c
, 
x
, 
y
)

2627 
wš
 *
p
;

2628 
mch¬
 *
c
;

2629 
x
, 
y
;

2631 
mlše
 *
ml
;

2633 
	`MFixLše
(
p
, 
y
, 
c
);

2634 
ml
 = &
p
->
w_mlšes
[
y
];

2635 
	`MKlDwRight
(
p
, 
ml
, 
x
);

2636 
	`MKlDwLeá
(
p
, 
ml
, 
x
);

2637 
	`cİy_mch¬2mlše
(
c
, 
ml
, 
x
);

2638 #ifdeà
DW_CHARS


2639 ià(
c
->
mbcs
)

2641 
	`MKlDwLeá
(
p
, 
ml
, 
x
 + 1);

2642 
	`cİy_mch¬2mlše
(
c
, 
ml
, 
x
 + 1);

2643 
ml
->
image
[
x
 + 1] = 
c
->
mbcs
;

2644 #ifdeà
UTF8


2645 ià(
p
->
w_’codšg
 !ğ
UTF8
)

2646 
ml
->
fÚt
[
x
 + 1] |= 0x80;

2647 ià(
p
->
w_’codšg
 =ğ
UTF8
 && 
c
->
mbcs
)

2648 
ml
->
fÚt
[
x
 + 1] = 
c
->
mbcs
;

2650 
ml
->
fÚt
[
x
 + 1] |= 0x80;

2658 
	`MW¿pCh¬
(
p
, 
c
, 
y
, 
tİ
, 
bÙ
, 
šs
)

2659 
wš
 *
p
;

2660 
mch¬
 *
c
;

2661 
y
, 
tİ
, 
bÙ
;

2662 
šs
;

2664 
mlše
 *
ml
;

2665 
bû
;

2667 #ifdeà
COLOR


2668 
bû
 = 
	`»nd_g‘bg
(
c
);

2670 
bû
 = 0;

2672 
	`MFixLše
(
p
, 
y
, 
c
);

2673 
ml
 = &
p
->
w_mlšes
[
y
];

2674 
	`cİy_mch¬2mlše
(&
mch¬_nuÎ
, 
ml
, 
p
->
w_width
);

2675 ià(
y
 =ğ
bÙ
)

2676 
	`MSüŞlV
(
p
, 1, 
tİ
, 
bÙ
, 
bû
);

2677 ià(
y
 < 
p
->
w_height
 - 1)

2678 
y
++;

2679 ià(
šs
)

2680 
	`MInsCh¬
(
p
, 
c
, 0, 
y
);

2682 
	`MPutCh¬
(
p
, 
c
, 0, 
y
);

2686 
	`MPutSŒ
(
p
, 
s
, 
n
, 
r
, 
x
, 
y
)

2687 
wš
 *
p
;

2688 *
s
;

2689 
n
;

2690 
mch¬
 *
r
;

2691 
x
, 
y
;

2693 
mlše
 *
ml
;

2694 
i
;

2695 *
b
;

2697 ià(
n
 <= 0)

2699 
	`MFixLše
(
p
, 
y
, 
r
);

2700 
ml
 = &
p
->
w_mlšes
[
y
];

2701 
	`MKlDwRight
(
p
, 
ml
, 
x
);

2702 
	`MKlDwLeá
(
p
, 
ml
, 
x
 + 
n
 - 1);

2703 
	`bcİy
(
s
, (*)
ml
->
image
 + 
x
, 
n
);

2704 
b
 = 
ml
->
©Œ
 + 
x
;

2705 
i
 = 
n
; i-- > 0;)

2706 *
b
++ = 
r
->
©Œ
;

2707 #ifdeà
FONT


2708 
b
 = 
ml
->
fÚt
 + 
x
;

2709 
i
 = 
n
; i-- > 0;)

2710 *
b
++ = 
r
->
fÚt
;

2712 #ifdeà
COLOR


2713 
b
 = 
ml
->
cŞÜ
 + 
x
;

2714 
i
 = 
n
; i-- > 0;)

2715 *
b
++ = 
r
->
cŞÜ
;

2716 #ifdeà
COLORS256


2717 
b
 = 
ml
->
cŞÜx
 + 
x
;

2718 
i
 = 
n
; i-- > 0;)

2719 *
b
++ = 
r
->
cŞÜx
;

2724 #ifdeà
COLOR


2726 
	`MBûLše
(
p
, 
y
, 
xs
, 
xe
, 
bû
)

2727 
wš
 *
p
;

2728 
y
, 
xs
, 
xe
, 
bû
;

2730 
mch¬
 
mc
;

2731 
mlše
 *
ml
;

2732 
x
;

2734 
mc
 = 
mch¬_nuÎ
;

2735 
	`»nd_£tbg
(&
mc
, 
bû
);

2736 
	`MFixLše
(
p
, 
y
, &
mc
);

2737 
ml
 = 
p
->
w_mlšes
 + 
y
;

2738 #ifdeà
COLORS16


2739 ià(
mc
.
©Œ
)

2740 
x
 = 
xs
; x <ğ
xe
; x++)

2741 
ml
->
©Œ
[
x
] = 
mc
.attr;

2743 ià(
mc
.
cŞÜ
)

2744 
x
 = 
xs
; x <ğ
xe
; x++)

2745 
ml
->
cŞÜ
[
x
] = 
mc
.color;

2746 #ifdeà
COLORS256


2747 ià(
mc
.
cŞÜx
)

2748 
x
 = 
xs
; x <ğ
xe
; x++)

2749 
ml
->
cŞÜx
[
x
] = 
mc
.colorx;

2755 #ifdeà
COPY_PASTE


2757 
	`WAddLšeToHi¡
(
wp
, 
ml
)

2758 
wš
 *
wp
;

2759 
mlše
 *
ml
;

2761 *
q
, *
o
;

2762 
mlše
 *
hml
;

2764 ià(
wp
->
w_hi¡height
 == 0)

2766 
hml
 = &
wp
->
w_hlšes
[wp->
w_hi¡idx
];

2767 
q
 = 
ml
->
image
; ml->imagğ
hml
->image; hml->image = q;

2769 
q
 = 
ml
->
©Œ
; 
o
 = 
hml
->©Œ; hml->©Œ = q; ml->©Œ = 
nuÎ
;

2770 ià(
o
 !ğ
nuÎ
)

2771 
	`ä“
(
o
);

2773 #ifdeà
FONT


2774 
q
 = 
ml
->
fÚt
; 
o
 = 
hml
->fÚt; hml->fÚˆğq; ml->fÚˆğ
nuÎ
;

2775 ià(
o
 !ğ
nuÎ
)

2776 
	`ä“
(
o
);

2779 #ifdeà
COLOR


2780 
q
 = 
ml
->
cŞÜ
; 
o
 = 
hml
->cŞÜ; hml->cŞÜ = q; ml->cŞÜ = 
nuÎ
;

2781 ià(
o
 !ğ
nuÎ
)

2782 
	`ä“
(
o
);

2783 #ifdeà
COLORS256


2784 
q
 = 
ml
->
cŞÜx
; 
o
 = 
hml
->cŞÜx; hml->cŞÜx = q; ml->cŞÜx = 
nuÎ
;

2785 ià(
o
 !ğ
nuÎ
)

2786 
	`ä“
(
o
);

2790 ià(++
wp
->
w_hi¡idx
 >ğwp->
w_hi¡height
)

2791 
wp
->
w_hi¡idx
 = 0;

2796 
	`MFšdU£dLše
(
p
, 
ye
, 
ys
)

2797 
wš
 *
p
;

2798 
ys
, 
ye
;

2800 
y
;

2801 
mlše
 *
ml
 = 
p
->
w_mlšes
 + 
ye
;

2803 
	`debug2
("MFšdU£dLše: %d %d\n", 
ye
, 
ys
);

2804 
y
 = 
ye
; y >ğ
ys
; y--, 
ml
--)

2806 ià(
	`bcmp
((*)
ml
->
image
, 
bÏnk
, 
p
->
w_width
))

2808 ià(
ml
->
©Œ
 !ğ
nuÎ
 && 
	`bcmp
((*)ml->©Œ,‚uÎ, 
p
->
w_width
))

2810 #ifdeà
COLOR


2811 ià(
ml
->
cŞÜ
 !ğ
nuÎ
 && 
	`bcmp
((*)ml->cŞÜ,‚uÎ, 
p
->
w_width
))

2813 #ifdeà
COLORS256


2814 ià(
ml
->
cŞÜx
 !ğ
nuÎ
 && 
	`bcmp
((*)ml->cŞÜx,‚uÎ, 
p
->
w_width
))

2819 
	`debug1
("MFšdU£dLš»tuºšg %d\n", 
y
);

2820  
y
;

2834 
	`WB–l
(
p
, 
visu®
)

2835 
wš
 *
p
;

2836 
visu®
;

2838 
ÿnvas
 *
cv
;

2839 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

2841 
cv
 = 
D_cvli¡
; cv; cv = cv->
c_Ãxt
)

2842 ià(
cv
->
c_Ïy”
->
l_bÙtom
 =ğ&
p
->
w_Ïy”
)

2844 ià(
cv
 && !
visu®
)

2845 
	`AddCSŒ
(
D_BL
);

2846 ià(
cv
 && 
D_VB
)

2847 
	`AddCSŒ
(
D_VB
);

2849 
p
->
w_b–l
 = 
visu®
 ? 
BELL_VISUAL
 : 
BELL_FOUND
;

2861 
	`WRev”£Video
(
p
, 
Ú
)

2862 
wš
 *
p
;

2863 
Ú
;

2865 
ÿnvas
 *
cv
;

2866 
cv
 = 
p
->
w_Ïy”
.
l_cvli¡
; cv; cv = cv->
c_Êext
)

2868 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

2869 ià(
cv
 !ğ
D_fÜecv
)

2871 
	`Rev”£Video
(
Ú
);

2872 ià(!
Ú
 && 
p
->
w_»vvid
 && !
D_CVR
)

2874 ià(
D_VB
)

2875 
	`AddCSŒ
(
D_VB
);

2877 
p
->
w_b–l
 = 
BELL_VISUAL
;

2883 
	`WMsg
(
p
, 
”r
, 
¡r
)

2884 
wš
 *
p
;

2885 
”r
;

2886 *
¡r
;

2888 
Ïy”
 *
æay”
;

2889 
Ïy”
 *
Şdæay”
 = 
æay”
;

2890 
æay”
 = &
p
->
w_Ïy”
;

2891 
	`LMsg
(
”r
, 
¡r
);

2892 
æay”
 = 
Şdæay”
;

2896 
	`WChªgeSize
(
p
, 
w
, 
h
)

2897 
wš
 *
p
;

2898 
w
, 
h
;

2900 
wok
 = 0;

2901 
ÿnvas
 *
cv
;

2903 ià(
p
->
w_Ïy”
.
l_cvli¡
 == 0)

2906 
	`ChªgeWšdowSize
(
p
, 
w
, 
h
,…->
w_hi¡height
);

2909 
cv
 = 
p
->
w_Ïy”
.
l_cvli¡
; cv; cv = cv->
c_Êext
)

2911 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

2912 ià(
p
 !ğ
D_fÜe
)

2914 ià(
D_CWS
)

2916 ià(
D_CZ0
 && (
w
 =ğ
Z0width
 || w =ğ
Z1width
))

2917 
wok
 = 1;

2919 ià(
cv
 =ğ0 && 
wok
 == 0)

2921 ià(!
D_CWS
)

2922 
h
 = 
p
->
w_height
;

2923 
	`ChªgeWšdowSize
(
p
, 
w
, 
h
,…->
w_hi¡height
);

2924 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

2926 ià(
p
 =ğ
D_fÜe
)

2928 ià(
D_cvli¡
 && D_cvli¡->
c_Ãxt
 == 0)

2929 
	`ResizeDi¥Ïy
(
w
, 
h
);

2931 
	`ResizeDi¥Ïy
(
w
, 
D_height
);

2932 
	`ResizeLay”sToCªva£s
();

2935 
cv
 = 
D_cvli¡
; cv; cv = cv->
c_Ãxt
)

2936 ià(
cv
->
c_Ïy”
->
l_bÙtom
 =ğ&
p
->
w_Ïy”
)

2938 ià(
cv
)

2939 
	`Redi¥Ïy
(0);

2944 
	`WšdowChªgedCheck
(
s
, 
wh©
, 
hp
)

2945 *
s
;

2946 
wh©
;

2947 *
hp
;

2949 
h
 = 0;

2950 
l
;

2951 *
s
)

2953 ià(*
s
++ !ğ(
hp
 ? '%' : '\005'))

2955 
l
 = 0;

2956 *
s
 >= '0' && *s <= '9')

2957 
s
++;

2958 ià(*
s
 == 'L')

2960 
s
++;

2961 
l
 = 0x100;

2963 ià(*
s
 == 'h')

2964 
h
 = 1;

2965 ià(*
s
 =ğ
wh©
 || ((* | 
l
) == what) || what == 'd')

2967 ià(*
s
)

2968 
s
++;

2970 ià(
hp
)

2971 *
hp
 = 
h
;

2972  *
s
 ? 1 : 0;

2976 
	`WšdowChªged
(
p
, 
wh©
)

2977 
wš
 *
p
;

2978 
wh©
;

2980 
šw¡r
, 
šh¡r
, 
šl¡r
;

2981 
šw¡rh
 = 0, 
šh¡rh
 = 0, 
šl¡rh
 = 0;

2982 
gÙ
, 
ox
, 
oy
;

2983 
di¥Ïy
 *
Şddi¥Ïy
 = display;

2984 
ÿnvas
 *
cv
;

2986 
šw¡r
 = 
šh¡r
 = 0;

2988 ià(
wh©
 == 'f')

2990 
	`WšdowChªged
((
wš
 *)0, 'w'|0x100);

2991 
	`WšdowChªged
((
wš
 *)0, 'W'|0x100);

2994 ià(
wh©
)

2996 
šw¡r
 = 
	`WšdowChªgedCheck
(
ÿ±iÚ¡ršg
, 
wh©
, &
šw¡rh
);

2997 
šh¡r
 = 
	`WšdowChªgedCheck
(
h¡©us¡ršg
, 
wh©
, &
šh¡rh
);

2998 
šl¡r
 = 
	`WšdowChªgedCheck
(
wli¡¡r
, 
wh©
, &
šl¡rh
);

3002 
šw¡r
 = 
šh¡r
 = 0;

3003 
šl¡r
 = 1;

3006 ià(
p
 == 0)

3008 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

3010 
ox
 = 
D_x
;

3011 
oy
 = 
D_y
;

3012 
cv
 = 
D_cvli¡
; cv; cv = cv->
c_Ãxt
)

3014 ià(
šl¡r
 || (
šl¡rh
 && 
p
 &&…->
w_h¡©us
 && *p->w_h¡©u && 
	`WšdowChªgedCheck
Õ->w_h¡©us, 
wh©
, (*)0)))

3015 
	`WLi¡Upd©ecv
(
cv
, (
wš
 *)0);

3016 
p
 = 
	`Lay”2Wšdow
(
cv
->
c_Ïy”
);

3017 ià(
šw¡r
 || (
šw¡rh
 && 
p
 &&…->
w_h¡©us
 && *p->w_h¡©u && 
	`WšdowChªgedCheck
Õ->w_h¡©us, 
wh©
, (*)0)))

3018 ià(
cv
->
c_ye
 + 1 < 
D_height
)

3019 
	`ReäeshLše
(
cv
->
c_ye
 + 1, 0, 
D_width
 - 1, 0);

3021 
p
 = 
D_fÜe
;

3022 ià(
šh¡r
 || (
šh¡rh
 && 
p
 &&…->
w_h¡©us
 && *p->w_h¡©u && 
	`WšdowChªgedCheck
Õ->w_h¡©us, 
wh©
, (*)0)))

3023 
	`ReäeshHStus
();

3024 ià(
ox
 != -1 && ox != -1)

3025 
	`GÙoPos
(
ox
, 
oy
);

3027 
di¥Ïy
 = 
Şddi¥Ïy
;

3031 ià(
p
->
w_h¡©us
 && *p->w_h¡©u && (
šw¡rh
 || 
šh¡rh
 || 
šl¡rh
è&& 
	`WšdowChªgedCheck
Õ->w_h¡©us, 
wh©
, (*)0))

3033 
šw¡r
 |ğ
šw¡rh
;

3034 
šh¡r
 |ğ
šh¡rh
;

3035 
šl¡r
 |ğ
šl¡rh
;

3037 ià(!
šw¡r
 && !
šh¡r
 && !
šl¡r
)

3039 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

3041 
gÙ
 = 0;

3042 
ox
 = 
D_x
;

3043 
oy
 = 
D_y
;

3044 
cv
 = 
D_cvli¡
; cv; cv = cv->
c_Ãxt
)

3046 ià(
šl¡r
)

3047 
	`WLi¡Upd©ecv
(
cv
, 
p
);

3048 ià(
	`Lay”2Wšdow
(
cv
->
c_Ïy”
è!ğ
p
)

3050 
gÙ
 = 1;

3051 ià(
šw¡r
 && 
cv
->
c_ye
 + 1 < 
D_height
)

3052 
	`ReäeshLše
(
cv
->
c_ye
 + 1, 0, 
D_width
 - 1, 0);

3054 ià(
gÙ
 && 
šh¡r
 && 
p
 =ğ
D_fÜe
)

3055 
	`ReäeshHStus
();

3056 ià(
ox
 != -1 && ox != -1)

3057 
	`GÙoPos
(
ox
, 
oy
);

3059 
di¥Ïy
 = 
Şddi¥Ïy
;

	@ansi.h

25 
	#NATTR
 6

	)

27 
	#ATTR_DI
 0

	)

28 
	#ATTR_US
 1

	)

29 
	#ATTR_BD
 2

	)

30 
	#ATTR_RV
 3

	)

31 
	#ATTR_SO
 4

	)

32 
	#ATTR_BL
 5

	)

34 
	#A_DI
 (1<<
ATTR_DI
)

	)

35 
	#A_US
 (1<<
ATTR_US
)

	)

36 
	#A_BD
 (1<<
ATTR_BD
)

	)

37 
	#A_RV
 (1<<
ATTR_RV
)

	)

38 
	#A_SO
 (1<<
ATTR_SO
)

	)

39 
	#A_BL
 (1<<
ATTR_BL
)

	)

40 
	#A_MAX
 (1<<(
NATTR
-1))

	)

42 
	#ATYP_M
 (1<<0)

	)

43 
	#ATYP_S
 (1<<1)

	)

44 
	#ATYP_U
 (1<<2)

	)

46 #ifdeà
COLORS16


48 
	#ATTR_BFG
 6

	)

49 
	#ATTR_BBG
 7

	)

50 
	#A_BFG
 (1<<
ATTR_BFG
)

	)

51 
	#A_BBG
 (1<<
ATTR_BBG
)

	)

58 
	e¡©e_t


60 
	mLIT
,

61 
	mESC
,

62 
	mASTR
,

63 
	mSTRESC
,

64 
	mCSI
,

65 
	mPRIN
,

66 
	mPRINESC
,

67 
	mPRINCSI
,

68 
	mPRIN4


72 
	e¡ršg_t


74 
	mNONE
,

75 
	mDCS
,

76 
	mOSC
,

77 
	mAPC
,

79 
	mPM
,

80 
	mAKA
,

81 
	mGM
,

82 
	mSTATUS


88 
	emove_t
 {

89 
	mM_NONE
,

90 
	mM_UP
,

91 
	mM_CUP
,

92 
	mM_DO
,

93 
	mM_CDO
,

94 
	mM_LE
,

95 
	mM_CLE
,

96 
	mM_RI
,

97 
	mM_CRI
,

98 
	mM_RW
,

99 
	mM_CR


102 
	#EXPENSIVE
 1000

	)

104 
	#G0
 0

	)

105 
	#G1
 1

	)

106 
	#G2
 2

	)

107 
	#G3
 3

	)

109 
	#ASCII
 0

	)

111 #ifdeà
TOPSTAT


112 
	#STATLINE
 (0)

	)

114 
	#STATLINE
 (
D_height
-1)

	)

117 #ifdeà
ENCODINGS


119 
	#KANJI
 ('B' & 037)

	)

120 
	#KANJI0212
 ('D' & 037)

	)

121 
	#KANA
 'I'

	)

123 
	#EUC_JP
 1

	)

124 
	#SJIS
 2

	)

125 
	#EUC_KR
 3

	)

126 
	#EUC_CN
 4

	)

127 
	#BIG5
 5

	)

128 
	#KOI8R
 6

	)

129 
	#CP1251
 7

	)

130 
	#GBK
 20

	)

132 
	#EUC
 
EUC_JP


	)

136 #ifdeà
UTF8


137 #undeà
UTF8


138 
	#UTF8
 8

	)

141 #ifdeà
UTF8


142 
	#UCS_REPL
 0xfffd

	)

143 
	#UCS_REPL_DW
 0xff1à

	)

144 
	#UCS_HIDDEN
 0xffff

	)

147 #ifdeà
DW_CHARS


148 
	#is_dw_fÚt
(
f
è((fè&& ((fè& 0x60è=ğ0)

	)

150 #ifdeà
UTF8


151 
	#dw_Ëá
(
ml
, 
x
, 
’c
è(Ónø=ğ
UTF8
) ? \

152 ()(
ml
)->
fÚt
[(
x
è+ 1] =ğ0xfà&& ()(ml)->
image
[(x) + 1] == 0xff : \

153 (()(
ml
)->
fÚt
[
x
] & 0x1f) != 0 && (()(ml)->font[x] & 0xe0) == 0 \

154 )

	)

155 
	#dw_right
(
ml
, 
x
, 
’c
è(Ónø=ğ
UTF8
) ? \

156 ()(
ml
)->
fÚt
[
x
] =ğ0xfà&& ()(ml)->
image
[x] == 0xff : \

157 (()(
ml
)->
fÚt
[
x
] & 0xe0) == 0x80 \

158 )

	)

160 
	#dw_Ëá
(
ml
, 
x
, 
’c
) ( \

161 (()(
ml
)->
fÚt
[
x
] & 0x1f) != 0 && (()(ml)->font[x] & 0xe0) == 0 \

162 )

	)

163 
	#dw_right
(
ml
, 
x
, 
’c
) ( \

164 (()(
ml
)->
fÚt
[
x
] & 0xe0) == 0x80 \

165 )

	)

168 
	#dw_Ëá
(
ml
, 
x
, 
’c
è0

	)

169 
	#dw_right
(
ml
, 
x
, 
’c
è0

	)

	@attacher.c

24 
	~<sys/ty³s.h
>

25 
	~<sys/¡©.h
>

26 
	~<sys/ioùl.h
>

27 
	~<fú.h
>

28 
	~<sigÇl.h
>

29 
	~"cÚfig.h
"

30 
	~"sü“n.h
"

31 
	~"ex‹º.h
"

33 
	~<pwd.h
>

35 
Wr™eMes§ge
 
__P
((, 
msg
 *));

36 
sig»t_t
 
A‰ach”SigIÁ
 
__P
(
SIGPROTOARG
);

37 #ià
defšed
(
SIGWINCH
è&& defšed(
TIOCGWINSZ
)

38 
sig»t_t
 
A‰ach”Wšch
 
__P
(
SIGPROTOARG
);

40 #ifdeà
LOCK


41 
sig»t_t
 
DoLock
 
__P
(
SIGPROTOARG
);

42 
LockT”mš®
 
__P
(());

43 
sig»t_t
 
LockHup
 
__P
(
SIGPROTOARG
);

44 
sü“n_butš_lck
 
__P
(());

46 #ifdeà
DEBUG


47 
sig»t_t
 
A‰ach”Chld
 
__P
(
SIGPROTOARG
);

49 #ifdeà
MULTIUSER


50 
sig»t_t
 
A‰achSigCÚt
 
__P
(
SIGPROTOARG
);

53 
»®_uid
, 
»®_gid
, 
eff_uid
, 
eff_gid
;

54 *
SockName
, *
SockM©ch
, 
SockP©h
[];

55 
·sswd
 *
µp
;

56 *
©ch_‰y
, *
©ch_‹rm
, *
LogšName
, *
´e£Ëù
;

57 
xæag
, 
dæag
, 
ræag
, 
qu›tæag
, 
ad­tæag
;

58 
mode
 
©ch_Mode
;

59 
NewWšdow
 
nwš_İtiÚs
;

60 
Ma¡”Pid
;

62 #ifdeà
MULTIUSER


63 *
muÉi
;

64 
muÉŸ‰ach
, 
muÉi_uid
, 
own_uid
;

65 
‰y_mode
, 
‰y_Şdmode
;

66 #iâdeà
USE_SETEUID


67 
	gmuÉe
[2];

72 #ifdeà
MULTIUSER


73 
	gCÚtšuePËa£
;

75 
sig»t_t


76 
A‰achSigCÚt
 
	gSIGDEFARG


78 
debug
("SigCont()\n");

79 
	gCÚtšuePËa£
 = 1;

80 
	gSIGRETURN
;

93 
	$Wr™eMes§ge
(
s
, 
m
)

94 
s
;

95 
msg
 *
m
;

97 
r
, 
l
 = (*
m
);

99 
l
 > 0)

101 
r
 = 
	`wr™e
(
s
, (*)
m
 + ((*mè- 
l
),†);

102 ià(
r
 =ğ-1 && 
”ºo
 =ğ
EINTR
)

104 ià(
r
 == -1 ||„ == 0)

106 
l
 -ğ
r
;

109 
	}
}

113 
	$A‰ach
(
how
)

114 
how
;

116 
n
, 
Ï¡s
;

117 
msg
 
m
;

118 
¡©
 
¡
;

119 *
s
;

121 
	`debug2
("A‰ach: how=%d,ty=%s\n", 
how
, 
©ch_‰y
);

122 #ifdeà
MULTIUSER


123 #iâdeà
USE_SETEUID


124 (
how
 =ğ
MSG_ATTACH
 || how =ğ
MSG_CONT
è&& 
muÉŸ‰ach
)

126 
»t
;

128 ià(
	`pe
(
muÉe
))

129 
	`Pªic
(
”ºo
, "pipe");

130 ià(
	`chmod
(
©ch_‰y
, 0666))

131 
	`Pªic
(
”ºo
, "chmod %s", 
©ch_‰y
);

132 
‰y_Şdmode
 = 
‰y_mode
;

133 
eff_uid
 = -1;

134 
»®_uid
 = 
muÉi_uid
;

135 ià((
»t
 = 
	`U£rCÚ‹xt
()) <= 0)

137 
dummy
;

138 
eff_uid
 = 0;

139 
»®_uid
 = 
own_uid
;

140 ià(
»t
 < 0)

141 
	`Pªic
(
”ºo
, "UserContext");

142 
	`şo£
(
muÉe
[1]);

143 
	`»ad
(
muÉe
[0], &
dummy
, 1);

144 ià(
‰y_Şdmode
 >= 0)

146 
	`chmod
(
©ch_‰y
, 
‰y_Şdmode
);

147 
‰y_Şdmode
 = -1;

149 
»t
 = 
	`U£rStus
();

150 #ifdeà
LOCK


151 ià(
»t
 =ğ
SIG_LOCK
)

152 
	`LockT”mš®
();

155 #ifdeà
SIGTSTP


156 ià(
»t
 =ğ
SIG_STOP
)

157 
	`kl
(
	`g‘pid
(), 
SIGTSTP
);

160 ià(
»t
 =ğ
SIG_POWER_BYE
)

162 
µid
;

163 
	`£tgid
(
»®_gid
);

164 
	`£tuid
(
»®_uid
);

165 ià((
µid
 = 
	`g‘µid
()) > 1)

166 
	`Kl
(
µid
, 
SIGHUP
);

167 
	`ex™
(0);

170 
	`ex™
(
»t
);

171 
dæag
 = 0;

172 #ifdeà
MULTI


173 
xæag
 = 1;

175 
how
 = 
MSG_ATTACH
;

178 
	`şo£
(
muÉe
[0]);

179 
eff_uid
 = 
»®_uid
;

183 ià((
how
 =ğ
MSG_ATTACH
 || how =ğ
MSG_CONT
è&& 
muÉŸ‰ach
)

185 
»®_uid
 = 
muÉi_uid
;

186 
eff_uid
 = 
own_uid
;

187 
	`x£‹uid
(
muÉi_uid
);

188 
	`x£‹uid
(
own_uid
);

189 ià(
	`chmod
(
©ch_‰y
, 0666))

190 
	`Pªic
(
”ºo
, "chmod %s", 
©ch_‰y
);

191 
‰y_Şdmode
 = 
‰y_mode
;

196 
	`bz”o
((*è&
m
, (m));

197 
m
.
ty³
 = 
how
;

198 
m
.
´ÙocŞ_»visiÚ
 = 
MSG_REVISION
;

199 
	`¡ºıy
(
m
.
m_‰y
, 
©ch_‰y
, (m.m_tty) - 1);

200 
m
.
m_‰y
[(m.m_tty) - 1] = 0;

202 ià(
how
 =ğ
MSG_WINCH
)

204 ià((
Ï¡s
 = 
	`MakeCl›ÁSock‘
(0)) >= 0)

206 
	`Wr™eMes§ge
(
Ï¡s
, &
m
);

207 
	`şo£
(
Ï¡s
);

212 ià(
how
 =ğ
MSG_CONT
)

214 ià((
Ï¡s
 = 
	`MakeCl›ÁSock‘
(0)) < 0)

216 
	`Pªic
(0, "Sorry, cannot contact session \"%s\"‡gain.\r\n",

217 
SockName
);

222 
n
 = 
	`FšdSock‘
(&
Ï¡s
, (*)0, (*)0, 
SockM©ch
);

223 
n
)

226 ià(
ræag
 && (rflag & 1) == 0)

228 ià(
qu›tæag
)

229 
	`“x™
(10);

230 
	`Pªic
(0, 
SockM©ch
 && *SockMatch ? "There is‚o screeno be %sed matching %s." : "There is‚o screeno be %sed.",

231 
xæag
 ? "attach" :

232 
dæag
 ? "detach" :

233 "»sum", 
SockM©ch
);

238 ià(
ræag
 < 3)

240 ià(
qu›tæag
)

241 
	`“x™
(10 + 
n
);

242 
	`Pªic
(0, "Type \"screen [-d] -r [pid.]tty.host\"o„esume one ofhem.");

252 #ifdeà
MULTIUSER


253 ià(!
muÉŸ‰ach
)

255 
	`£tuid
(
»®_uid
);

256 #ià
	`defšed
(
MULTIUSER
è&& defšed(
USE_SETEUID
)

260 
	`x£‹uid
(
»®_uid
);

263 
	`£tgid
(
»®_gid
);

264 
eff_uid
 = 
»®_uid
;

265 
eff_gid
 = 
»®_gid
;

267 
	`debug2
("A‰ach: uid %dƒuid %d\n", ()
	`g‘uid
(), ()
	`g‘euid
());

268 
Ma¡”Pid
 = 0;

269 
s
 = 
SockName
; *s; s++)

271 ià(*
s
 > '9' || *s < '0')

273 
Ma¡”Pid
 = 10 * Ma¡”Pid + (*
s
 - '0');

275 
	`debug1
("A‰ach decided, iˆi '%s'\n", 
SockP©h
);

276 
	`debug1
("A‰ach found Ma¡”Pid =ğ%d\n", 
Ma¡”Pid
);

277 ià(
	`¡©
(
SockP©h
, &
¡
) == -1)

278 
	`Pªic
(
”ºo
, "¡© %s", 
SockP©h
);

279 ià((
¡
.
¡_mode
 & 0600) != 0600)

280 
	`Pªic
(0, "Sock‘ i š wrÚg mod(%03o)", ()
¡
.
¡_mode
);

285 ià((
xæag
 || 
ræag
è&& 
dæag
 && (
¡
.
¡_mode
 & 0700) == 0600)

286 
dæag
 = 0;

292 ià((
dæag
 || !
xæag
è&& (
¡
.
¡_mode
 & 0700) != (dflag ? 0700 : 0600))

293 
	`Pªic
(0, "Th© sü“Ài %sd‘ached.", 
dæag
 ? "already " : "not ");

294 #ifdeà
REMOTE_DETACH


295 ià(
dæag
 &&

296 (
how
 =ğ
MSG_ATTACH
 || how =ğ
MSG_DETACH
 || how =ğ
MSG_POW_DETACH
))

298 
m
.m.
d‘ach
.
dpid
 = 
	`g‘pid
();

299 
	`¡ºıy
(
m
.m.
d‘ach
.
du£r
, 
LogšName
, (m.m.detach.duser) - 1);

300 
m
.m.
d‘ach
.
du£r
[(m.m.detach.duser) - 1] = 0;

301 #ifdeà
POW_DETACH


302 ià(
dæag
 == 2)

303 
m
.
ty³
 = 
MSG_POW_DETACH
;

306 
m
.
ty³
 = 
MSG_DETACH
;

307 ià(
	`Wr™eMes§ge
(
Ï¡s
, &
m
))

308 
	`Pªic
(
”ºo
, "WriteMessage");

309 
	`şo£
(
Ï¡s
);

310 ià(
how
 !ğ
MSG_ATTACH
)

312 
	`¦“p
(1);

313 ià((
Ï¡s
 = 
	`MakeCl›ÁSock‘
(0)) == -1)

314 
	`Pªic
(0, "Cannot contact screen‡gain. Sigh.");

315 
m
.
ty³
 = 
how
;

318 
	`ASSERT
(
how
 =ğ
MSG_ATTACH
 || how =ğ
MSG_CONT
);

319 
	`¡ºıy
(
m
.m.
©ch
.
’v‹rm
, 
©ch_‹rm
, (m.m.attach.envterm) - 1);

320 
m
.m.
©ch
.
’v‹rm
[(m.m.attach.envterm) - 1] = 0;

321 
	`debug1
("©ch: s’dšg %d by‹s... ", ()(
m
));

323 
	`¡ºıy
(
m
.m.
©ch
.
au£r
, 
LogšName
, (m.m.attach.auser) - 1);

324 
m
.m.
©ch
.
au£r
[(m.m.attach.auser) - 1] = 0;

325 
m
.m.
©ch
.
esc
 = 
DeçuÉEsc
;

326 
m
.m.
©ch
.
m‘a_esc
 = 
DeçuÉM‘aEsc
;

327 
	`¡ºıy
(
m
.m.
©ch
.
´e£Ëù
,…reselect ?…reselect : "", (m.m.attach.preselect) - 1);

328 
m
.m.
©ch
.
´e£Ëù
[(m.m.attach.preselect) - 1] = 0;

329 
m
.m.
©ch
.
­id
 = 
	`g‘pid
();

330 
m
.m.
©ch
.
ad­tæag
 =‡daptflag;

331 
m
.m.
©ch
.
lšes
 = m.m.©ch.
cŞumns
 = 0;

332 ià((
s
 = 
	`g‘’v
("LINES")))

333 
m
.m.
©ch
.
lšes
 = 
	`©oi
(
s
);

334 ià((
s
 = 
	`g‘’v
("COLUMNS")))

335 
m
.m.
©ch
.
cŞumns
 = 
	`©oi
(
s
);

336 
m
.m.
©ch
.
’codšg
 = 
nwš_İtiÚs
.encoding > 0 ?‚win_options.encoding + 1 : 0;

338 #ifdeà
MULTIUSER


340 ià(
muÉi
 && (
how
 =ğ
MSG_ATTACH
 || how =ğ
MSG_CONT
))

341 
	`sigÇl
(
SIGCONT
, 
A‰achSigCÚt
);

344 ià(
	`Wr™eMes§ge
(
Ï¡s
, &
m
))

345 
	`Pªic
(
”ºo
, "WriteMessage");

346 
	`şo£
(
Ï¡s
);

347 
	`debug1
("A‰ach(%d): s’t\n", 
m
.
ty³
);

348 #ifdeà
MULTIUSER


349 ià(
muÉi
 && (
how
 =ğ
MSG_ATTACH
 || how =ğ
MSG_CONT
))

351 !
CÚtšuePËa£
)

352 
	`·u£
();

353 
	`sigÇl
(
SIGCONT
, 
SIG_DFL
);

354 
CÚtšuePËa£
 = 0;

355 #iâdeà
USE_SETEUID


356 
	`şo£
(
muÉe
[1]);

358 
	`x£‹uid
(
own_uid
);

359 ià(
‰y_Şdmode
 >= 0)

360 ià(
	`chmod
(
©ch_‰y
, 
‰y_Şdmode
))

361 
	`Pªic
(
”ºo
, "chmod %s", 
©ch_‰y
);

362 
‰y_Şdmode
 = -1;

363 
	`x£‹uid
(
»®_uid
);

367 
ræag
 = 0;

369 
	}
}

372 #ià
defšed
(
DEBUG
è|| !defšed(
DO_NOT_POLL_MASTER
)

373 
	gA‰ach”Pªic
 = 0;

376 #ifdeà
DEBUG


377 
sig»t_t


378 
A‰ach”Chld
 
	gSIGDEFARG


380 
	gA‰ach”Pªic
 = 1;

381 
	gSIGRETURN
;

385 
sig»t_t


386 
A‰ach”SigAÏrm
 
	gSIGDEFARG


388 #ifdeà
DEBUG


389 
	gtick_út
 = 0;

390 ià((
	gtick_út
 = (
tick_út
 + 1) % 4) == 0)

391 
debug
("tick\n");

393 
	gSIGRETURN
;

400 
sig»t_t


401 
A‰ach”SigIÁ
 
	gSIGDEFARG


403 
sigÇl
(
SIGINT
, 
A‰ach”SigIÁ
);

404 
Kl
(
Ma¡”Pid
, 
SIGINT
);

405 
	gSIGRETURN
;

413 
sig»t_t


414 
A‰ach”Fš™
 
	gSIGDEFARG


416 
¡©
 
	g¡©b
;

417 
msg
 
	gm
;

418 
	gs
;

420 
debug
("AttacherFinit();\n");

421 
sigÇl
(
SIGHUP
, 
SIG_IGN
);

423 ià(
¡©
(
SockP©h
, &
¡©b
è=ğ0 && (¡©b.
¡_mode
 & 0777) != 0600)

425 
debug
("Detaching backend!\n");

426 
bz”o
((*è&
m
, (m));

427 
¡ºıy
(
m
.
m_‰y
, 
©ch_‰y
, (m.m_tty) - 1);

428 
	gm
.
	gm_‰y
[(
m
.
m_‰y
) - 1] = 0;

429 
debug1
("©ch_‰y i %s\n", 
©ch_‰y
);

430 
	gm
.m.
	gd‘ach
.
	gdpid
 = 
g‘pid
();

431 
	gm
.
	gty³
 = 
MSG_HANGUP
;

432 
	gm
.
	g´ÙocŞ_»visiÚ
 = 
MSG_REVISION
;

433 ià((
	gs
 = 
MakeCl›ÁSock‘
(0)) >= 0)

435 
Wr™eMes§ge
(
s
, &
m
);

436 
şo£
(
s
);

439 #ifdeà
MULTIUSER


440 ià(
	g‰y_Şdmode
 >= 0)

442 
£tuid
(
own_uid
);

443 
chmod
(
©ch_‰y
, 
‰y_Şdmode
);

446 
ex™
(0);

447 
	gSIGRETURN
;

450 #ifdeà
POW_DETACH


451 
sig»t_t


452 
A‰ach”Fš™Bye
 
	gSIGDEFARG


454 
	gµid
;

455 
debug
("AttacherFintBye()\n");

456 #ià
defšed
(
MULTIUSER
è&& !defšed(
USE_SETEUID
)

457 ià(
	gmuÉŸ‰ach
)

458 
ex™
(
SIG_POWER_BYE
);

460 
£tgid
(
»®_gid
);

461 #ifdeà
MULTIUSER


462 
£tuid
(
own_uid
);

464 
£tuid
(
»®_uid
);

467 ià((
	gµid
 = 
g‘µid
()) > 1)

468 
Kl
(
µid
, 
SIGHUP
);

469 
ex™
(0);

470 
	gSIGRETURN
;

474 #ià
defšed
(
DEBUG
è&& defšed(
SIG_NODEBUG
)

475 
sig»t_t


476 
A‰ach”NoDebug
 
	gSIGDEFARG


478 
debug
("AttacherNoDebug()\n");

479 
sigÇl
(
SIG_NODEBUG
, 
A‰ach”NoDebug
);

480 ià(
	gdå
)

482 
debug
("debug: closing debug file.\n");

483 
fæush
(
då
);

484 
fşo£
(
då
);

485 
	gdå
 = 
NULL
;

487 
	gSIGRETURN
;

491 
	gSu¥’dPËa£
;

493 
sig»t_t


494 
SigStİ
 
	gSIGDEFARG


496 
debug
("SigStop()\n");

497 
	gSu¥’dPËa£
 = 1;

498 
	gSIGRETURN
;

501 #ifdeà
LOCK


502 
	gLockPËa£
;

504 
sig»t_t


505 
DoLock
 
	gSIGDEFARG


507 #ifdeà
SYSVSIGS


508 
sigÇl
(
SIG_LOCK
, 
DoLock
);

510 
debug
("DoLock()\n");

511 
	gLockPËa£
 = 1;

512 
	gSIGRETURN
;

516 #ià
defšed
(
SIGWINCH
è&& defšed(
TIOCGWINSZ
)

517 
	gSigWšchPËa£
;

519 
sig»t_t


520 
A‰ach”Wšch
 
	gSIGDEFARG


522 
debug
("AttacherWinch()\n");

523 
	gSigWšchPËa£
 = 1;

524 
	gSIGRETURN
;

534 
	$A‰ach”
()

536 
	`sigÇl
(
SIGHUP
, 
A‰ach”Fš™
);

537 
	`sigÇl
(
SIG_BYE
, 
A‰ach”Fš™
);

538 #ifdeà
POW_DETACH


539 
	`sigÇl
(
SIG_POWER_BYE
, 
A‰ach”Fš™Bye
);

541 #ià
	`defšed
(
DEBUG
è&& defšed(
SIG_NODEBUG
)

542 
	`sigÇl
(
SIG_NODEBUG
, 
A‰ach”NoDebug
);

544 #ifdeà
LOCK


545 
	`sigÇl
(
SIG_LOCK
, 
DoLock
);

547 
	`sigÇl
(
SIGINT
, 
A‰ach”SigIÁ
);

548 #ifdeà
BSDJOBS


549 
	`sigÇl
(
SIG_STOP
, 
SigStİ
);

551 #ià
	`defšed
(
SIGWINCH
è&& defšed(
TIOCGWINSZ
)

552 
	`sigÇl
(
SIGWINCH
, 
A‰ach”Wšch
);

554 #ifdeà
DEBUG


555 
	`sigÇl
(
SIGCHLD
, 
A‰ach”Chld
);

557 
	`debug
("attacher: going for‡‚ap.\n");

558 
dæag
 = 0;

559 #ifdeà
MULTI


560 
xæag
 = 1;

564 #iâdeà
DO_NOT_POLL_MASTER


565 
	`sigÇl
(
SIGALRM
, 
A‰ach”SigAÏrm
);

566 
	`®¬m
(15);

567 
	`·u£
();

568 
	`®¬m
(0);

569 ià(
	`kl
(
Ma¡”Pid
, 0è< 0 && 
”ºo
 !ğ
EPERM
)

571 
	`debug1
("©ch”: Pªic! Ma¡”Pid %d dÛ nÙƒxi¡.\n", 
Ma¡”Pid
);

572 
A‰ach”Pªic
++;

575 
	`·u£
();

577 #ià
	`defšed
(
DEBUG
è|| !defšed(
DO_NOT_POLL_MASTER
)

578 ià(
A‰ach”Pªic
)

580 
	`fú
(0, 
F_SETFL
, 0);

581 
	`S‘TTY
(0, &
©ch_Mode
);

582 
	`´štf
("\nSuddenlyhe Dungeon collapses!! - You die...\n");

583 
	`“x™
(1);

586 #ifdeà
BSDJOBS


587 ià(
Su¥’dPËa£
)

589 
Su¥’dPËa£
 = 0;

590 #ià
	`defšed
(
MULTIUSER
è&& !defšed(
USE_SETEUID
)

591 ià(
muÉŸ‰ach
)

592 
	`ex™
(
SIG_STOP
);

594 
	`sigÇl
(
SIGTSTP
, 
SIG_DFL
);

595 
	`debug
("attacher: killing myself SIGTSTP\n");

596 
	`kl
(
	`g‘pid
(), 
SIGTSTP
);

597 
	`debug
("attacher: continuing from stop\n");

598 
	`sigÇl
(
SIG_STOP
, 
SigStİ
);

599 (è
	`A‰ach
(
MSG_CONT
);

602 #ifdeà
LOCK


603 ià(
LockPËa£
)

605 
LockPËa£
 = 0;

606 #ià
	`defšed
(
MULTIUSER
è&& !defšed(
USE_SETEUID
)

607 ià(
muÉŸ‰ach
)

608 
	`ex™
(
SIG_LOCK
);

610 
	`LockT”mš®
();

611 #ifdeà
SYSVSIGS


612 
	`sigÇl
(
SIG_LOCK
, 
DoLock
);

614 (è
	`A‰ach
(
MSG_CONT
);

617 #ià
	`defšed
(
SIGWINCH
è&& defšed(
TIOCGWINSZ
)

618 ià(
SigWšchPËa£
)

620 
SigWšchPËa£
 = 0;

621 #ifdeà
SYSVSIGS


622 
	`sigÇl
(
SIGWINCH
, 
A‰ach”Wšch
);

624 (è
	`A‰ach
(
MSG_WINCH
);

628 
	}
}

630 #ifdeà
LOCK


635 
	gLockEnd
[] = "Welcome backo screen !!\n";

637 
sig»t_t


638 
LockHup
 
	gSIGDEFARG


640 
	gµid
 = 
g‘µid
();

641 
£tgid
(
»®_gid
);

642 #ifdeà
MULTIUSER


643 
£tuid
(
own_uid
);

645 
£tuid
(
»®_uid
);

647 ià(
	gµid
 > 1)

648 
Kl
(
µid
, 
SIGHUP
);

649 
ex™
(0);

653 
	$LockT”mš®
()

655 *
´g
;

656 
sig
, 
pid
;

657 
	`sig»t_t
 (*
sigs
[
NSIG
])
	`__P
(
SIGPROTOARG
);

659 
sig
 = 1; sig < 
NSIG
; sig++)

660 
sigs
[
sig
] = 
	`sigÇl
(sig, sig =ğ
SIGCHLD
 ? 
SIG_DFL
 : 
SIG_IGN
);

661 
	`sigÇl
(
SIGHUP
, 
LockHup
);

662 
	`´štf
("\n");

664 
´g
 = 
	`g‘’v
("LOCKPRG");

665 ià(
´g
 && 
	`¡rcmp
Õrg, "butš"è&& !
	`acûss
Õrg, 
X_OK
))

667 
	`sigÇl
(
SIGCHLD
, 
SIG_DFL
);

668 
	`debug1
("lock‹rmš®: '%s' s“m execubË,ƒxeş it!\n", 
´g
);

669 ià((
pid
 = 
	`fÜk
()) == 0)

672 
	`£tgid
(
»®_gid
);

673 #ifdeà
MULTIUSER


674 
	`£tuid
(
own_uid
);

676 
	`£tuid
(
»®_uid
);

678 
	`şo£®lfes
(0);

679 
	`exeş
(
´g
, "SCREEN-LOCK", 
NULL
);

680 
	`ex™
(
”ºo
);

682 ià(
pid
 == -1)

683 
	`Msg
(
”ºo
, "Cannot†ockerminal - fork failed");

686 #ifdeà
BSDWAIT


687 
wa™
 
w¡©
;

689 
w¡©
;

691 
w»t
;

693 #ifdeà
hpux


694 
	`sigÇl
(
SIGCHLD
, 
SIG_DFL
);

696 
”ºo
 = 0;

697 ((
w»t
 = 
	`wa™
(&
w¡©
)è!ğ
pid
) ||

698 ((
w»t
 =ğ-1è&& (
”ºo
 =ğ
EINTR
))

700 
”ºo
 = 0;

702 ià(
”ºo
)

704 
	`Msg
(
”ºo
, "Lock");

705 
	`¦“p
(2);

707 ià(
	`WTERMSIG
(
w¡©
) != 0)

709 
	`årštf
(
¡d”r
, "Lock: %s: KËd by sigÇl: %d%s\n", 
´g
,

710 
	`WTERMSIG
(
w¡©
), 
	`WIFCORESIG
(wstat) ? " (Core dumped)" : "");

711 
	`¦“p
(2);

713 ià(
	`WEXITSTATUS
(
w¡©
))

715 
	`debug2
("Lock: %s:„‘uº cod%d\n", 
´g
, 
	`WEXITSTATUS
(
w¡©
));

718 
	`´štf
(
LockEnd
);

723 ià(
´g
)

725 
	`debug1
("lock‹rmš®: '%s' s“m NOTƒxecubË, wu£ ou¸butš\n", 
´g
);

729 
	`debug
("lockterminal: using buitin.\n");

731 
	`sü“n_butš_lck
();

734 
sig
 = 1; sig < 
NSIG
; sig++)

736 ià(
sigs
[
sig
] !ğ(
	`sig»t_t
(*)
	`__P
(
SIGPROTOARG
)) -1)

737 
	`sigÇl
(
sig
, 
sigs
[sig]);

739 
	}
}

741 #ifdeà
USE_PAM


747 
	~<£cur™y/·m_­¶.h
>

749 
PAM_cÚv
 
__P
((, cÚ¡ 
·m_mes§ge
 **, 
·m_»¥Ú£
 **, *));

752 
	$PAM_cÚv
(
num_msg
, 
msg
, 
»¥
, 
­pd©a_±r
)

753 
num_msg
;

754 cÚ¡ 
·m_mes§ge
 **
msg
;

755 
·m_»¥Ú£
 **
»¥
;

756 *
­pd©a_±r
;

758 
»¶›s
 = 0;

759 
·m_»¥Ú£
 *
»¶y
 = 
NULL
;

761 
»¶y
 = 
	`m®loc
((
·m_»¥Ú£
)*
num_msg
);

762 ià(!
»¶y
)

763  
PAM_CONV_ERR
;

764 
	#COPY_STRING
(
s
è(sè? 
	`¡rdup
(sè: 
NULL


	)

766 
»¶›s
 = 0;„•l› < 
num_msg
;„eplies++)

768 
msg
[
»¶›s
]->
msg_¡yË
)

770 
PAM_PROMPT_ECHO_OFF
:

772 
»¶y
[
»¶›s
].
»¥_»tcode
 = 
PAM_SUCCESS
;

773 
»¶y
[
»¶›s
].
»¥
 = 
­pd©a_±r
 ? 
	`¡rdup
((*)appdata_ptr) : 0;

775 
PAM_TEXT_INFO
:

778 
»¶y
[
»¶›s
].
»¥
 = 
NULL
;

780 
PAM_PROMPT_ECHO_ON
:

785 
	`ä“
(
»¶y
);

786  
PAM_CONV_ERR
;

789 *
»¥
 = 
»¶y
;

790  
PAM_SUCCESS
;

791 
	}
}

793 
·m_cÚv
 
	gPAM_cÚv”§tiÚ
 = {

794 &
PAM_cÚv
,

795 
NULL


803 
	$sü“n_butš_lck
()

805 
fuÎÇme
[100], *
ı1
, 
mes§ge
[100 + 100];

806 #ifdeà
USE_PAM


807 
·m_hªdË_t
 *
·mh
 = 0;

808 
·m_”rÜ
;

810 *
·ss
, 
my·ss
[16 + 1], 
§É
[3];

813 #iâdeà
USE_PAM


814 
·ss
 = 
µp
->
pw_·sswd
;

815 ià(
·ss
 == 0 || *pass == 0)

817 ià((
·ss
 = 
	`g‘·ss
("Key: ")))

819 
	`¡ºıy
(
my·ss
, 
·ss
, (mypass) - 1);

820 
my·ss
[(mypass) - 1] = 0;

821 ià(*
my·ss
 == 0)

823 ià((
·ss
 = 
	`g‘·ss
("Again: ")))

825 ià(
	`¡rcmp
(
my·ss
, 
·ss
))

827 
	`årštf
(
¡d”r
, "Passwords don't match.\007\n");

828 
	`¦“p
(2);

833 ià(
·ss
 == 0)

835 
	`årštf
(
¡d”r
, "Getpassƒrror.\007\n");

836 
	`¦“p
(2);

840 
§É
[0] = 'A' + ()(
	`time
(0) % 26);

841 
§É
[1] = 'A' + ()((
	`time
(0) >> 6) % 26);

842 
§É
[2] = 0;

843 
·ss
 = 
	`üy±
(
my·ss
, 
§É
);

844 
·ss
 = 
µp
->
pw_·sswd
 = 
	`SaveSŒ
(pass);

848 
	`debug
("screen_builtin_lck†ooking in gcos field\n");

849 
	`¡ºıy
(
fuÎÇme
, 
µp
->
pw_gecos
, (fullname) - 9);

850 
fuÎÇme
[(fullname) - 9] = 0;

852 ià((
ı1
 = 
	`šdex
(
fuÎÇme
, ',')è!ğ
NULL
)

853 *
ı1
 = '\0';

854 ià((
ı1
 = 
	`šdex
(
fuÎÇme
, '&')è!ğ
NULL
)

856 
	`¡ºıy
(
ı1
, 
µp
->
pw_Çme
, 8);

857 
ı1
[8] = 0;

858 ià(*
ı1
 >= 'a' && *cp1 <= 'z')

859 *
ı1
 -= 'a' - 'A';

862 
	`¥rštf
(
mes§ge
, "Screen used by %s <%s>.\nPassword:\007",

863 
fuÎÇme
, 
µp
->
pw_Çme
);

868 
	`debug
("screen_builtin_lck‡waiting…assword\n");

869 
”ºo
 = 0;

870 ià((
ı1
 = 
	`g‘·ss
(
mes§ge
)è=ğ
NULL
)

872 
	`A‰ach”Fš™
(
SIGARG
);

875 #ifdeà
USE_PAM


876 
PAM_cÚv”§tiÚ
.
­pd©a_±r
 = 
ı1
;

877 
·m_”rÜ
 = 
	`·m_¡¬t
("sü“n", 
µp
->
pw_Çme
, &
PAM_cÚv”§tiÚ
, &
·mh
);

878 ià(
·m_”rÜ
 !ğ
PAM_SUCCESS
)

879 
	`A‰ach”Fš™
(
SIGARG
);

880 
·m_”rÜ
 = 
	`·m_auth’tiÿ‹
(
·mh
, 0);

881 
	`·m_’d
(
·mh
, 
·m_”rÜ
);

882 
PAM_cÚv”§tiÚ
.
­pd©a_±r
 = 0;

883 ià(
·m_”rÜ
 =ğ
PAM_SUCCESS
)

886 ià(!
	`¡ºcmp
(
	`üy±
(
ı1
, 
·ss
),…ass, 
	`¡¾’
(pass)))

889 
	`debug
("screen_builtin_lck: NO!!!!!\n");

890 
	`bz”o
(
ı1
, 
	`¡¾’
(cp1));

892 
	`bz”o
(
ı1
, 
	`¡¾’
(cp1));

893 
	`debug
("password ok.\n");

894 
	}
}

900 
	$S’dCmdMes§ge
(
¡y
, 
m©ch
, 
av
)

901 *
¡y
;

902 *
m©ch
;

903 **
av
;

905 
i
, 
s
;

906 
msg
 
m
;

907 *
p
;

908 
Ën
, 
n
;

910 ià(
¡y
 == 0)

912 
i
 = 
	`FšdSock‘
(&
s
, (*)0, (*)0, 
m©ch
);

913 ià(
i
 == 0)

914 
	`Pªic
(0, "No screen session found.");

915 ià(
i
 != 1)

916 
	`Pªic
(0, "Use -So specify‡ session.");

920 #ifdeà
NAME_MAX


921 ià(
	`¡¾’
(
¡y
è> 
NAME_MAX
)

922 
¡y
[
NAME_MAX
] = 0;

924 ià(
	`¡¾’
(
¡y
è> 2 * 
MAXSTR
 - 1)

925 
¡y
[2 * 
MAXSTR
 - 1] = 0;

926 
	`¥rštf
(
SockP©h
 + 
	`¡¾’
(SockP©h), "/%s", 
¡y
);

927 ià((
s
 = 
	`MakeCl›ÁSock‘
(1)) == -1)

928 
	`ex™
(1);

930 
	`bz”o
((*)&
m
, (m));

931 
m
.
ty³
 = 
MSG_COMMAND
;

932 ià(
©ch_‰y
)

934 
	`¡ºıy
(
m
.
m_‰y
, 
©ch_‰y
, (m.m_tty) - 1);

935 
m
.
m_‰y
[(m.m_tty) - 1] = 0;

937 
p
 = 
m
.m.
commªd
.
cmd
;

938 
n
 = 0;

939 ; *
av
 && 
n
 < 
MAXARGS
 - 1; ++av, ++n)

941 
Ën
 = 
	`¡¾’
(*
av
) + 1;

942 ià(
p
 + 
Ën
 >ğ
m
.m.
commªd
.
cmd
 + (m.m.command.cmd) - 1)

944 
	`¡rıy
(
p
, *
av
);

945 
p
 +ğ
Ën
;

947 *
p
 = 0;

948 
m
.m.
commªd
.
Çrgs
 = 
n
;

949 
	`¡ºıy
(
m
.m.
©ch
.
au£r
, 
LogšName
, (m.m.attach.auser) - 1);

950 
m
.m.
commªd
.
au£r
[(m.m.command.auser) - 1] = 0;

951 
m
.
´ÙocŞ_»visiÚ
 = 
MSG_REVISION
;

952 
	`¡ºıy
(
m
.m.
commªd
.
´e£Ëù
,…reselect ?…reselect : "", (m.m.command.preselect) - 1);

953 
m
.m.
commªd
.
´e£Ëù
[(m.m.command.preselect) - 1] = 0;

954 
m
.m.
commªd
.
­id
 = 
	`g‘pid
();

955 
	`debug1
("S’dCommªdMsg wr™šg '%s'\n", 
m
.m.
commªd
.
cmd
);

956 ià(
	`Wr™eMes§ge
(
s
, &
m
))

957 
	`Msg
(
”ºo
, "write");

958 
	`şo£
(
s
);

959 
	}
}

	@braille.c

28 
	~<¡dio.h
>

29 
	~<fú.h
>

30 
	~<sys/¡©.h
>

32 
	~"cÚfig.h
"

33 
	~"sü“n.h
"

34 
	~"ex‹º.h
"

35 
	~"b¿Ë.h
"

37 #ifdeà
HAVE_BRAILLE


40 
bd_š™_pow”b¿Ë_40
 
__P
(());

41 
bd_š™_pow”b¿Ë_80
 
__P
(());

42 
bd_š™_Çvig©Ü_40
 
__P
(());

44 
Ïy”
 *
æay”
;

45 
di¥Ïy
 *
di¥Ïys
, *display;

46 *
rc_Çme
;

53 
b¿Ë_di¥Ïy
 
	gbd
;

55 
	sbd_ty³
 {

56 *
	mÇme
;

57 (*
	mš™
è
__P
(());

60 
bd_ty³
 
	gbd_ty³li¡
[] =

62 {"pow”b¿Ë_40", 
bd_š™_pow”b¿Ë_40
},

63 {"pow”b¿Ë_80", 
bd_š™_pow”b¿Ë_80
},

64 {"Çvig©Ü_40" , 
bd_š™_Çvig©Ü_40
}

67 
pos™iÚ_b¿Ë_cursÜ
 
__P
(());

68 
š™Ÿlize_b¿Ë_di¥Ïy_ty³
 
__P
((*));

69 
İ’_b¿Ë_deviû
 
__P
(());

70 
lßd_b¿Ë_bË
 
__P
((*));

71 
bd_sigÇl
 
__P
(());

72 
bd_bc_Ëá
 
__P
(());

73 
bd_bc_right
 
__P
(());

74 
bd_bc_up
 
__P
(());

75 
bd_bc_down
 
__P
(());

76 
bd_uµ”_Ëá
 
__P
(());

77 
bd_uµ”_right
 
__P
(());

78 
bd_low”_Ëá
 
__P
(());

79 
bd_low”_right
 
__P
(());

80 
bd_do_£¬ch
 
__P
((, , ));

81 
bd_nÜm®ize
 
__P
((, ));

82 
bd_»adev_â
 
__P
((
ev’t
 *, *));

83 
bd_wr™“v_â
 
__P
((
ev’t
 *, *));

84 
bd_£Ëùev_â
 
__P
((
ev’t
 *, *));

86 
	gbbË_loÿl
 [] =

123 
	$In™B¿Ë
()

125 
bd
.
bd_¡¬t_b¿Ë
=0;

126 
bd
.
bd_pÜt
 = 0;

127 
bd
.
bd_b¿Ë_bË
 = 
	`SaveSŒ
("internal us-braille.tbl");

128 
bd
.
bd_ty³
 = 0;

129 
bd
.
bd_baud
 = 9600;

130 
bd
.
bd_b–l
 = 1;

131 
bd
.
bd_eightdÙ
 = 1;

132 
bd
.
bd_šfo
 = 0;

133 
bd
.
bd_lšk
 = 1;

134 
bd
.
bd_nûÎs
 = 0;

135 
bd
.
bd_width
 = 0;

136 
bd
.
bd_nüc
 = 1;

137 
bd
.
bd_süŞl
 = 1;

138 
bd
.
bd_sk
 = 0;

139 
bd
.
bd_usšg_b¿Ë
 = 0;

140 
bd
.
bd_obuæ’
 = 0;

141 
bd
.
bd_fd
 = -1;

142 
	`bcİy
((*)
bbË_loÿl
, 
bd
.
bd_bbË
, 256);

143 
	}
}

146 
	$š™Ÿlize_b¿Ë_di¥Ïy_ty³
(
s
)

147 *
s
;

149 
i
;

151 
i
 = 0; i < (
bd_ty³li¡
)/(*bd_typelist); i++)

152 ià(!
	`¡rcmp
(
s
, 
bd_ty³li¡
[
i
].
Çme
))

154 ià(
i
 =ğ(
bd_ty³li¡
)/(*bd_typelist))

156 
	`Msg
(0, "NØ’Œy fÜ bd_ty³: % ", 
s
);

159 
bd
.
bd_ty³
 = 
bd_ty³li¡
[
i
].
Çme
;

160 ià((*
bd_ty³li¡
[
i
].
š™
)())

163 ià(!
bd
.
bd_width
)

164 
bd
.
bd_width
 = bd.
bd_nûÎs
;

167 
	}
}

170 
	$S¹B¿Ë
()

172 
bd
.
bd_dpy
 = 
di¥Ïys
;

174 
	`debug
("StartBraille called\n");

175 
	`evdeq
(&
bd
.
bd_»adev
);

176 
	`evdeq
(&
bd
.
bd_wr™“v
);

177 
	`evdeq
(&
bd
.
bd_£Ëùev
);

178 
bd
.
bd_usšg_b¿Ë
 = 0;

180 ià(!
bd
.
bd_¡¬t_b¿Ë
)

183 ià(
bd
.
bd_ty³
 =ğ0 || bd.
bd_pÜt
 == 0)

186 ià(
bd
.
bd_fd
 < 0 && 
	`İ’_b¿Ë_deviû
())

188 
	`Msg
(0, "bd_porturned off");

189 
	`ä“
(
bd
.
bd_pÜt
);

190 
bd
.
bd_pÜt
 = 0;

195 ià(
bd
.
	`bd_»¥Ú£_‹¡
())

197 
	`Msg
(0, "Make surehat braille display is connected‡ndurned on. ");

198 
	`Msg
(0, "start_brailleurned off");

199 
bd
.
bd_¡¬t_b¿Ë
 = 0;

203 
bd
.
bd_usšg_b¿Ë
 = 1;

204 
bd
.
bd_»adev
.
fd
 = bd.
bd_wr™“v
.fd = bd.
bd_fd
;

205 
bd
.
bd_»adev
.
ty³
 = 
EV_READ
;

206 
bd
.
bd_wr™“v
.
ty³
 = 
EV_WRITE
;

207 
bd
.
bd_£Ëùev
.
ty³
 = 
EV_ALWAYS
;

208 
bd
.
bd_»adev
.
d©a
 = bd.
bd_wr™“v
.d©¨ğbd.
bd_£Ëùev
.data = (*)&bd;

209 
bd
.
bd_»adev
.
hªdËr
 = 
bd_»adev_â
;

210 
bd
.
bd_wr™“v
.
hªdËr
 = 
bd_wr™“v_â
;

211 
bd
.
bd_£Ëùev
.
hªdËr
 = 
bd_£Ëùev_â
;

212 
	`ev’q
(&
bd
.
bd_»adev
);

213 
bd
.
bd_wr™“v
.
cÚdpos
 = &bd.
bd_obuæ’
;

214 
bd
.
bd_wr™“v
.
cÚdÃg
 = 0;

215 
	`ev’q
(&
bd
.
bd_wr™“v
);

216 
bd
.
bd_£Ëùev
.
´i
 = -20;

217 
	`ev’q
(&
bd
.
bd_£Ëùev
);

219 
	}
}

223 
	$lßd_b¿Ë_bË
(
bËÇme
)

224 *
bËÇme
;

226 
i
, 
j
, 
c
, 
p
;

227 
FILE
 *
å
;

228 
bufãr
[80], 
a
[10];

230 ià((
å
 = 
	`£cfİ’
(
bËÇme
, "r")) == 0)

232 
	`Msg
(
”ºo
, "B¿ËabË‚Ù found: % ", 
bËÇme
);

235 
	`bz”o
(
bd
.
bd_bbË
, 256);

240 
	`fg‘s
(
bufãr
, (bufãr), 
å
))

242 ià(
bufãr
[0] == '#')

244 
	`ssÿnf
(
bufãr
,"%d %x %8s", &
i
, &
j
, 
a
);

245 ià(
i
 < 0 || i > 255)

247 
j
=1, 
p
=1, 
c
=0; j<9; j++,…*=2)

248 ià(
a
[
j
] == '0' + j)

249 
c
 +ğ
p
;

250 
bd
.
bd_bbË
[
i
] = 
c
;

252 
	`fşo£
(
å
);

254 
	}
}

258 
	$İ’_b¿Ë_deviû
(
s
)

259 *
s
;

261 
¡r
[256];

263 
	`¥rštf
(
¡r
, "%d cs8 -i¡r ixÚ ixoff", 
bd
.
bd_baud
);

264 
bd
.
bd_fd
 = 
	`O³nTTY
(bd.
bd_pÜt
, 
¡r
);

265 ià(
bd
.
bd_fd
 == -1)

267 
	`Msg
(
”ºo
, "İ’ comm…Üˆçed: % ", 
bd
.
bd_pÜt
);

270 
	`fú
(
bd
.
bd_fd
, 
F_SETFL
, 
FNBLOCK
);

272 
	}
}

276 
	$pos™iÚ_b¿Ë_cursÜ
()

278 
sx
 = 
bd
.
bd_sx
;

279 
bx
 = 
BD_FORE
->
w_bd_x
;

280 
eŞ
 = 
BD_FORE
->
w_width
;

281 
w
 = 
bd
.
bd_width
;

283 ià(
bd
.
bd_süŞl
)

284 
bx
 = 
sx
 - 
w
 + 
bd
.
bd_nüc
;

286 
bx
 = 
w
 * ()(
sx
 / w);

288 ià(
bx
 > 
eŞ
 - 
w
)

289 
bx
 = 
eŞ
 - 
w
;

290 ià(
bx
 < 0)

291 
bx
 = 0;

292 
BD_FORE
->
w_bd_x
 = 
bx
;

293 
BD_FORE
->
w_bd_y
 = 
bd
.
bd_sy
;

294 
	}
}

298 
	$ReäeshB¿Ë
()

300 
i
, 
y
, 
xs
, 
xe
;

301 
cursÜ_pos
;

303 ià(!
bd
.
bd_usšg_b¿Ë
)

305 ià(!
BD_FORE
)

307 
	`bcİy
(
bd
.
bd_lše
, bd.
bd_Şše
, bd.
bd_nûÎs
);

308 
bd
.
bd_»äeshšg
 = 1;

309 
æay”
 = 
bd
.
bd_dpy
->
d_fÜecv
->
c_Ïy”
;

310 
bd
.
bd_sx
 = 
æay”
->
l_x
;

311 
bd
.
bd_sy
 = 
æay”
->
l_y
;

312 
di¥Ïy
 = 
bd
.
bd_dpy
;

313 ià((
D_obuå
 !ğ
D_obuf
è&& 
bd
.
bd_lšk
)

316 
	`debug
("calling…osition_braille_cursor\n");

317 
	`pos™iÚ_b¿Ë_cursÜ
();

319 
	`bş—r
(
bd
.
bd_lše
, bd.
bd_nûÎs
);

321 
y
 = 
BD_FORE
->
w_bd_y
;

322 
xs
 = 
BD_FORE
->
w_bd_x
;

324 ià(
bd
.
bd_šfo
 & 1)

326 
	`¥rštf
(
bd
.
bd_lše
, "%02d%02d", (
BD_FORE
->
w_bd_x
 + 1è% 100, (BD_FORE->
w_bd_y
 + 1) % 100);

327 
bd
.
bd_lše
[4] = ' ';

329 ià(
bd
.
bd_šfo
 & 2)

331 
	`¥rštf
(
bd
.
bd_lše
 + bd.
bd_nûÎs
 - 4, "%02d%02d",(bd.
bd_sx
 +1è% 100, (bd.
bd_sy
 +1) % 100);

334 
xe
 = 
xs
 + 
bd
.
bd_width
 - 1;

336 ià(
xs
 > 
æay”
->
l_width
 - 1)

337 
xs
 = 
æay”
->
l_width
 - 1;

338 ià(
xe
 > 
æay”
->
l_width
 - 1)

339 
xe
 = 
æay”
->
l_width
 - 1;

341 ià(
D_¡©us
)

343 
	`¥rštf
(
bd
.
bd_lše
, "**%-*.*s", bd.
bd_nûÎs
 - 2, bd.bd_nûÎ - 2, 
D_¡©us_Ï¡msg
 ? D_status_lastmsg : "unknown msg");

344 
xs
 = 
xe
 = -1;

346 ià(
xs
 <ğ
xe
)

348 
	`LayRedi¥ÏyLše
(-1, 
xs
, 
xe
, 1);

349 
	`LayRedi¥ÏyLše
(
y
, 
xs
, 
xe
, 1);

352 
	`debug1
("B¿Ë: gÙ >%s<\n", 
bd
.
bd_lše
);

354 
bd
.
bd_»äeshšg
 = 0;

356 ià(
y
 =ğ
bd
.
bd_sy
 && 
xs
 <ğbd.
bd_sx
 && bd.bd_sx <ğ
xe
)

357 
cursÜ_pos
 = 
bd
.
bd_sx
 - 
xs
 + (bd.
bd_šfo
 & 1 ? 4 : 0);

359 
cursÜ_pos
 = 
bd
.
bd_nûÎs
;

360 
i
 = 0; i < 
bd
.
bd_nûÎs
; i++)

361 ià(
bd
.
bd_lše
[
i
] !ğbd.
bd_Şše
[i])

363 ià(
bd
.
bd_cursÜpos
 !ğ
cursÜ_pos
 || 
i
 < bd.
bd_nûÎs
)

364 
bd
.
	`wr™e_lše_b¿Ë
(bd.
bd_lše
, bd.
bd_nûÎs
, 
cursÜ_pos
);

365 
bd
.
bd_cursÜpos
 = 
cursÜ_pos
;

366 
	}
}

381 
	$bd_sigÇl
()

383 ià(!
bd
.
bd_b–l
)

385 
di¥Ïy
 = 
bd
.
bd_dpy
;

386 ià(
D_obuå
 !ğ
D_obuf
)

387 
	`AddCSŒ
(
D_BL
);

390 
	`AddCSŒ
(
D_BL
);

391 
	`Flush
();

393 
	}
}

396 
	$bd_do_£¬ch
(
y
, 
xs
, 
xe
)

397 
y
, 
xs
, 
xe
;

399 
oy
 = 
BD_FORE
->
w_bd_y
;

401 ià(!
bd
.
bd_sk
)

403 ià(
xs
 > 
xe
)

405 
bd
.
bd_£¬chmš
 = 
xs
;

406 
bd
.
bd_£¬chmax
 = 
xe
;

409 
æay”
 = 
bd
.
bd_dpy
->
d_fÜecv
->
c_Ïy”
;

410 
bd
.
bd_£¬chmax
 = -1;

411 
bd
.
bd_£¬chmš
 = 
æay”
->
l_width
;

412 ià(
xs
 <ğ
xe
)

414 
BD_FORE
->
w_bd_y
 = 
y
;

415 
bd
.
bd_»äeshšg
 = bd.
bd_£¬chšg
 = 1;

416 
bd
.
bd_£¬ch¡¬t
 = 
xs
;

417 
bd
.
bd_£¬ch’d
 = 
xe
;

418 
	`LayRedi¥ÏyLše
(-1, 
xs
, 
xe
, 1);

419 
	`LayRedi¥ÏyLše
(
y
, 
xs
, 
xe
, 1);

420 
bd
.
bd_»äeshšg
 = bd.
bd_£¬chšg
 = 0;

421 
BD_FORE
->
w_bd_y
 = 
oy
;

423  
bd
.
bd_£¬chmax
 >= 0;

424 
	}
}

427 
	$bd_nÜm®ize
(
x
, 
y
)

428 
x
, 
y
;

430 ià(
x
 > 
BD_FORE
->
w_width
 - 
bd
.
bd_width
)

431 
x
 = 
BD_FORE
->
w_width
 - 
bd
.
bd_width
;

432 ià(
x
 < 0)

433 
x
 = 0;

434 ià(
y
 < 0)

436 
	`bd_sigÇl
();

437 
y
 = 0;

439 ià(
y
 >ğ
BD_FORE
->
w_height
)

441 
	`bd_sigÇl
();

442 
y
 = 
BD_FORE
->
w_height
 - 1;

444 ià(
x
 !ğ
BD_FORE
->
w_bd_x
 || 
y
 !ğBD_FORE->
w_bd_y
)

445 
bd
.
bd_moved
 = 1;

446 
BD_FORE
->
w_bd_x
 = 
x
;

447 
BD_FORE
->
w_bd_y
 = 
y
;

448 
	}
}

451 
	$bd_bc_Ëá
()

453 
bx
 = 
BD_FORE
->
w_bd_x
, 
by
 = BD_FORE->
w_bd_y
;

454 
ex
;

456 
ex
 = 
bx
 - 1;

457 
bx
 = 0;

458 ; 
by
 >= 0; by--)

460 ià(
	`bd_do_£¬ch
(
by
, 0, 
ex
))

462 ià(!
bd
.
bd_sk
 && 
by
 !ğ
BD_FORE
->
w_bd_y
)

463 
	`bd_sigÇl
();

464 
bx
 = 
bd
.
bd_£¬chmax
 + 1 - bd.
bd_width
;

467 
ex
 = 
BD_FORE
->
w_width
 - 1;

469 
	`bd_nÜm®ize
(
bx
, 
by
);

470 
	}
}

473 
	$bd_bc_right
()

475 
bx
 = 
BD_FORE
->
w_bd_x
, 
by
 = BD_FORE->
w_bd_y
;

476 
sx
;

478 
sx
 = 
bx
 + 
bd
.
bd_width
;

479 
bx
 = 
BD_FORE
->
w_width
 - 
bd
.
bd_width
;

480 ; 
by
 < 
BD_FORE
->
w_height
; by++)

482 ià(
	`bd_do_£¬ch
(
by
, 
sx
, 
BD_FORE
->
w_width
 - 1))

484 ià(!
bd
.
bd_sk
 && 
by
 !ğ
BD_FORE
->
w_bd_y
)

485 
	`bd_sigÇl
();

486 
bx
 = 
bd
.
bd_£¬chmš
;

489 
sx
 = 0;

491 
	`bd_nÜm®ize
(
bx
, 
by
);

492 
	}
}

495 
	$bd_bc_up
()

497 
bx
 = 
BD_FORE
->
w_bd_x
, 
by
 = BD_FORE->
w_bd_y
;

499 
by
--; by >= 0; by--)

500 ià(
	`bd_do_£¬ch
(
by
, 
bx
, bx + 
bd
.
bd_width
 - 1))

502 
	`bd_nÜm®ize
(
bx
, 
by
);

503 
	}
}

506 
	$bd_bc_down
()

508 
bx
 = 
BD_FORE
->
w_bd_x
, 
by
 = BD_FORE->
w_bd_y
;

510 
by
++; by < 
BD_FORE
->
w_height
; by++)

511 ià(
	`bd_do_£¬ch
(
by
, 
bx
, bx + 
bd
.
bd_width
 - 1))

513 
	`bd_nÜm®ize
(
bx
, 
by
);

514 
	}
}

518 
	$bd_uµ”_Ëá
()

520 
	`bd_nÜm®ize
(0, 0);

521 
	}
}

525 
	$bd_uµ”_right
()

527 
	`bd_nÜm®ize
(
BD_FORE
->
w_width
 - 
bd
.
bd_width
, 0);

528 
	}
}

532 
	$bd_low”_Ëá
()

534 
	`bd_nÜm®ize
(0, 
BD_FORE
->
w_height
 - 1);

535 
	}
}

539 
	$bd_low”_right
()

541 
	`bd_nÜm®ize
(
BD_FORE
->
w_width
 - 
bd
.
bd_width
, BD_FORE->
w_height
 -1);

542 
	}
}

550 
	$bd_check
(
x
, 
c
)

551 
x
, 
c
;

553 ià(
c
 == ' ')

555 ià(
x
 < 
bd
.
bd_£¬ch¡¬t
 || x > bd.
bd_£¬ch’d
)

557 ià(
x
 > 
bd
.
bd_£¬chmax
)

558 
bd
.
bd_£¬chmax
 = 
x
;

559 ià(
x
 < 
bd
.
bd_£¬chmš
)

560 
bd
.
bd_£¬chmš
 = 
x
;

561 
	}
}

567 
	$BGÙoPos
(
Ï
, 
x
, 
y
)

568 
Ïy”
 *
Ï
;

569 
x
, 
y
;

571 
	}
}

575 
	$BCDi¥ÏyLše
(
Ï
, 
ml
, 
y
, 
xs
, 
xe
, 
isbÏnk
)

576 
Ïy”
 *
Ï
;

577 
mlše
 *
ml
;

578 
y
, 
xs
, 
xe
;

579 
isbÏnk
;

581 
x
;

582 
sx
, 
ex
;

583 *
l
;

585 ià(
y
 !ğ
BD_FORE
->
w_bd_y
)

587 ià(
bd
.
bd_£¬chšg
)

589 
x
 = 
xs
; x <ğ
xe
; x++)

590 
	`bd_check
(
x
, 
ml
->
image
[x]);

593 
l
 = 
bd
.
bd_lše
;

594 
sx
 = 
BD_FORE
->
w_bd_x
;

595 
ex
 = 
sx
 + 
bd
.
bd_width
 - 1;

596 ià(
bd
.
bd_šfo
 & 1)

597 
l
 += 4;

598 
x
 = 
xs
; x <ğ
xe
; x++)

599 ià(
x
 >ğ
sx
 && x <ğ
ex
)

600 
l
[
x
 - 
sx
] = 
ml
->
image
[x];

601 
	}
}

605 
	$BPutCh¬
(
Ï
, 
c
, 
x
, 
y
)

606 
Ïy”
 *
Ï
;

607 
mch¬
 *
c
;

608 
x
, 
y
;

610 
sx
, 
ex
;

611 *
l
;

613 ià(
y
 !ğ
BD_FORE
->
w_bd_y
)

615 ià(
bd
.
bd_£¬chšg
)

617 
	`bd_check
(
x
, 
c
->
image
);

620 
l
 = 
bd
.
bd_lše
;

621 
sx
 = 
BD_FORE
->
w_bd_x
;

622 
ex
 = 
sx
 + 
bd
.
bd_width
 - 1;

623 ià(
bd
.
bd_šfo
 & 1)

624 
l
 += 4;

625 ià(
x
 >ğ
sx
 && x <ğ
ex
)

626 
l
[
x
 - 
sx
] = 
c
->
image
;

627 
	}
}

631 
	$BPutSŒ
(
Ï
, 
s
, 
n
, 
r
, 
x
, 
y
)

632 
Ïy”
 *
Ï
;

633 *
s
;

634 
n
;

635 
mch¬
 *
r
;

636 
x
, 
y
;

638 
sx
, 
ex
;

639 *
l
;

641 ià(
y
 !ğ
BD_FORE
->
w_bd_y
)

643 ià(
bd
.
bd_£¬chšg
)

645 ; 
n
 > 0;‚--, 
s
++, 
x
++)

646 
	`bd_check
(
x
, *
s
);

649 
l
 = 
bd
.
bd_lše
;

650 
sx
 = 
BD_FORE
->
w_bd_x
;

651 
ex
 = 
sx
 + 
bd
.
bd_width
 - 1;

652 ià(
bd
.
bd_šfo
 & 1)

653 
l
 += 4;

654 ; 
n
 > 0;‚--, 
s
++, 
x
++)

655 ià(
x
 >ğ
sx
 && x <ğ
ex
)

656 
l
[
x
 - 
sx
] = *
s
;

657 
	}
}

665 *
	gšfÚames
[] = {"none", "bc", "sc", "bc+sc"};

668 
	$DoB¿ËAùiÚ
(
aù
, 
msgok
)

669 
aùiÚ
 *
aù
;

670 
msgok
;

672 
Ä
, 
dosig
;

673 
n
, 
l
, 
o
;

674 *
s
, **
¬gs
;

675 
¡©
 
¡
;

677 
Ä
 = 
aù
->nr;

678 
¬gs
 = 
aù
->args;

679 
dosig
 = 
di¥Ïy
 && !*
rc_Çme
;

681 
Ä
)

683 
RC_BD_BELL
:

684 ià(
	`P¬£Sw™ch
(
aù
, &
bd
.
bd_b–l
è|| !
msgok
)

686 
	`bd_sigÇl
();

689 
	`Msg
(0, 
bd
.
bd_b–l
 ? "bd_bell is on." : "bd_bell is off.");

692 
RC_BD_EIGHTDOT
:

693 ià(
	`P¬£Sw™ch
(
aù
, &
bd
.
bd_eightdÙ
è|| !
msgok
)

695 
	`Msg
(0, "sw™chedØ%d-dÙ sy¡em.", 
bd
.
bd_eightdÙ
 ? 8 : 6);

698 
RC_BD_INFO
:

699 
n
 = 
bd
.
bd_šfo
;

700 ià(*
¬gs
)

702 ià(
	`¡¾’
(*
¬gs
) == 4)

703 
n
 = 
¬gs
[0][n] - '0';

704 ià(
	`P¬£Num
(
aù
, &
n
))

707 ià(
n
 < 0 &&‚ > 3)

709 
	`Msg
(0, "Out of„ange; 0 <= bd_info >= 3 ");

713 ià(
bd
.
bd_width
 == 0)

716 
o
 = (
bd
.
bd_šfo
 * 2 + 2) & 12;

717 
l
 = (
n
 * 2 + 2) & 12;

718 ià(
l
 >ğ
bd
.
bd_nûÎs
)

720 
	`Msg
(0, "bd_info isoo†arge for braille display.");

723 ià(
l
 >ğ
bd
.
bd_width
 + 
o
)

725 
	`Msg
(0, "bd_info isoo†arge for bd_width.");

728 
bd
.
bd_width
 +ğ
o
 - 
l
;

729 
bd
.
bd_šfo
 = 
n
;

731 ià(
msgok
)

732 
	`Msg
(0, "bd_šfØi %s.", 
šfÚames
[
n
]);

733 
	`pos™iÚ_b¿Ë_cursÜ
();

736 
RC_BD_LINK
:

737 ià(*
¬gs
 =ğ0 && 
bd
.
bd_moved
)

738 
bd
.
bd_lšk
 = 0;

739 ià(
	`P¬£Sw™ch
(
aù
, &
bd
.
bd_lšk
))

741 ià(
bd
.
bd_lšk
)

743 
bd
.
bd_moved
 = 0;

744 ià(
dosig
)

745 
	`bd_sigÇl
();

746 
	`pos™iÚ_b¿Ë_cursÜ
();

748 ià(
msgok
)

749 
	`Msg
(0, 
bd
.
bd_lšk
 ? "bd_link is on." : "bd_link is off.");

752 
RC_BD_SKIP
:

753 ià(
	`P¬£Sw™ch
(
aù
, &
bd
.
bd_sk
))

755 ià(
bd
.
bd_sk
 && 
dosig
)

756 
	`bd_sigÇl
();

757 ià(
msgok
)

758 
	`Msg
(0, 
bd
.
bd_sk
 ? "bd_skip is on." : "bd_skip is off.");

761 
RC_BD_SCROLL
:

762 ià(
	`P¬£Sw™ch
(
aù
, &
bd
.
bd_süŞl
è|| !
msgok
)

764 
	`pos™iÚ_b¿Ë_cursÜ
();

767 
	`Msg
(0, 
bd
.
bd_süŞl
 ? "bd_scroll is on." : "bd_scroll is off.");

770 
RC_BD_NCRC
:

771 
n
 = 
bd
.
bd_nüc
;

772 ià(*
¬gs
)

774 ià(
¬gs
[0][0] == '+')

775 
n
 = (À+ 
	`©oi
(*
¬gs
 + 1)è% 
bd
.
bd_width
 + 1;

776 ià(
¬gs
[0][0] == '-')

777 
n
 = (À- 
	`©oi
(*
¬gs
 + 1)è% 
bd
.
bd_width
 + 1;

778 ià(
	`P¬£Num
(
aù
, &
n
))

781 ià(
n
 < 1 ||‚ > 
bd
.
bd_width
)

783 
	`Msg
(0, "Ouˆoà¿nge; 1 <ğbd_nüø>ğ%d", 
bd
.
bd_width
);

786 
bd
.
bd_nüc
 = 
n
;

787 ià(
msgok
)

788 
	`Msg
(0, "bd_nüø¡©u is: %d ", 
bd
.
bd_nüc
);

789 
	`pos™iÚ_b¿Ë_cursÜ
();

792 
RC_BD_BRAILLE_TABLE
:

793 
s
 = 0;

794 ià(*
¬gs
)

796 ià(
	`P¬£SaveSŒ
(
aù
, &
s
))

798 ià(
	`lßd_b¿Ë_bË
(
s
))

800 
	`ä“
(
s
);

803 ià(
bd
.
bd_b¿Ë_bË
)

804 
	`ä“
(
bd
.
bd_b¿Ë_bË
);

805 
bd
.
bd_b¿Ë_bË
 = 
s
;

807 ià(
msgok
)

808 
	`Msg
(0, "bd_b¿Ë_bË is: % ", 
bd
.
bd_b¿Ë_bË
);

811 
RC_BD_PORT
:

812 
s
 = 0;

813 ià(*
¬gs
)

815 ià(
	`P¬£SaveSŒ
(
aù
, &
s
))

818 ià(
	`¡©
(
s
, &
¡
è|| !
	`S_ISCHR
(¡.
¡_mode
è|| 
	`acûss
(s, 
R_OK
|
W_OK
))

820 
	`Msg
(0, "CªnÙ‡cûs b¿Ë deviû…Üˆ%s", 
s
);

821 
	`ä“
(
s
);

824 ià(
bd
.
bd_fd
 >= 0)

825 
	`şo£
(
bd
.
bd_fd
);

826 
bd
.
bd_fd
 = -1;

827 ià(
bd
.
bd_pÜt
)

828 
	`ä“
(
bd
.
bd_pÜt
);

829 
bd
.
bd_pÜt
 = 
s
;

831 ià(
msgok
)

832 
	`Msg
(0, "bd_pÜˆis: % ", 
bd
.
bd_pÜt
 ? bd.bd_port : "not set");

833 
	`S¹B¿Ë
();

836 
RC_BD_TYPE
:

837 
s
 = 0;

838 ià(*
¬gs
)

839 ià(
	`P¬£SaveSŒ
(
aù
, &
s
è|| 
	`š™Ÿlize_b¿Ë_di¥Ïy_ty³
(s))

841 ià(
msgok
)

842 
	`Msg
(0, "bd_ty³ is: % ", 
bd
.
bd_ty³
 ? bd.bd_type : "not set");

843 
	`S¹B¿Ë
();

846 
RC_BD_START_BRAILLE
:

847 ià(
	`P¬£Sw™ch
(
aù
, &
bd
.
bd_¡¬t_b¿Ë
))

849 ià(
msgok
)

850 
	`Msg
(0, 
bd
.
bd_¡¬t_b¿Ë
 ? "bd_start_braille is on." : "bd_start_braille is off.");

851 
	`S¹B¿Ë
();

854 
RC_BD_WIDTH
:

855 
n
 = 
bd
.
bd_width
;

856 ià(*
¬gs
)

858 ià(
	`P¬£Num
(
aù
, &
n
))

861 ià(
n
 <= 0)

863 
	`Msg
(0, "Inv®id v®ufÜ bd_width: %d ", 
n
);

866 
l
 = (
bd
.
bd_šfo
 * 2 + 2) & 12;

867 ià(
n
 > 
bd
.
bd_nûÎs
 - 
l
 ||‚ <†)

869 
	`Msg
(0, "bd_info isoo†arge for bd_width.");

872 
bd
.
bd_width
 = 
n
;

873 ià(
msgok
)

874 
	`Msg
(0, "bd_width is: %d ", 
bd
.
bd_width
);

877 
RC_BD_BC_LEFT
:

878 
	`bd_bc_Ëá
();

881 
RC_BD_BC_RIGHT
:

882 
	`bd_bc_right
();

885 
RC_BD_BC_UP
:

886 
	`bd_bc_up
();

889 
RC_BD_BC_DOWN
:

890 
	`bd_bc_down
();

893 
RC_BD_UPPER_LEFT
:

894 
	`bd_uµ”_Ëá
();

897 
RC_BD_UPPER_RIGHT
:

898 
	`bd_uµ”_right
();

901 
RC_BD_LOWER_LEFT
:

902 
	`bd_low”_Ëá
();

905 
RC_BD_LOWER_RIGHT
:

906 
	`bd_low”_right
();

912 
	}
}

915 
	$bd_»adev_â
(
ev
, 
d©a
)

916 
ev’t
 *
ev
;

917 *
d©a
;

919 
bd
.
	`bu‰Ú´ess
();

920 
	}
}

923 
	$bd_wr™“v_â
(
ev
, 
d©a
)

924 
ev’t
 *
ev
;

925 *
d©a
;

927 
Ën
;

929 ià(
bd
.
bd_obuæ’
 == 0)

931 ià((
Ën
 = 
	`wr™e
(
bd
.
bd_fd
, bd.
bd_obuf
, bd.
bd_obuæ’
)) < 0)

932 
Ën
 = 
bd
.
bd_obuæ’
;

933 ià((
bd
.
bd_obuæ’
 -ğ
Ën
))

934 
	`bcİy
(
bd
.
bd_obuf
 + 
Ën
, bd.bd_obuf, bd.
bd_obuæ’
);

935 
	}
}

938 
	$bd_£Ëùev_â
(
ev
, 
d©a
)

939 
ev’t
 *
ev
;

940 *
d©a
;

942 
	`ReäeshB¿Ë
();

943 
	}
}

	@braille.h

28 #ifdeà
HAVE_BRAILLE


30 
S¹B¿Ë
 
__P
(());

32 
	sb¿Ë_di¥Ïy


34 
di¥Ïy
 *
	mbd_dpy
;

35 
	mbd_¡¬t_b¿Ë
;

36 
	mbd_usšg_b¿Ë
;

37 
ev’t
 
	mbd_»adev
;

38 
ev’t
 
	mbd_wr™“v
;

39 
ev’t
 
	mbd_£Ëùev
;

40 
	mbd_fd
;

41 
	mbd_obuæ’
;

42 
	mbd_obuf
[
IOSIZE
];

43 
	mbd_šfo
;

44 
	mbd_nüc
;

45 
	mbd_sk
;

46 
	mbd_lšk
;

47 
	mbd_width
;

48 
	mbd_süŞl
;

49 *
	mbd_b¿Ë_bË
;

51 
	mbd_b–l
;

52 
	mbd_nûÎs
;

53 
	mbd_eightdÙ
;

54 
	mbd_baud
;

55 *
	mbd_pÜt
;

56 *
	mbd_ty³
;

57 
	mbd_v”siÚ
;

58 
	mbd_bbË
[256];

61 (*
	mwr™e_lše_b¿Ë
è
__P
(([],, ));

62 (*
	mbu‰Ú´ess
è
__P
(());

63 (*
	mbd_»¥Ú£_‹¡
è
__P
(());

65 
	mbd_»äeshšg
;

66 
	mbd_lše
[40+1];

67 
	mbd_cursÜpos
;

68 
	mbd_Şše
[40+1];

69 
	mbd_sx
, 
	mbd_sy
;

70 
	mbd_moved
;

72 
	mbd_£¬chšg
;

73 
	mbd_£¬chmax
;

74 
	mbd_£¬chmš
;

75 
	mbd_£¬ch¡¬t
;

76 
	mbd_£¬ch’d
;

79 
b¿Ë_di¥Ïy
 
bd
;

81 
	#BD_FORE
 
bd
.
bd_dpy
->
d_fÜe


	)

	@braille_tsi.c

29 
	~"cÚfig.h
"

30 
	~"sü“n.h
"

31 
	~"ex‹º.h
"

32 
	~"b¿Ë.h
"

34 #ifdeà
HAVE_BRAILLE


36 
di¥Ïy
 *display;

38 
	skey2rc
 {

39 
	mkey
;

40 
	mÄ
;

41 *
	m¬g1
;

42 *
	m¬g2
;

46 
	gtsi_ùy³
 = 1;

48 
	gtsi_lše_ty³
;

51 
di¥Ïy_¡©us_tsi
 
__P
(());

52 
wr™e_lše_tsi
 
__P
((*, , ));

53 
bu‰Ú´ess_tsi
 
__P
((
key2rc
 *));

54 
bu‰Ú´ess_Çvig©Ü_40
 
__P
(());

55 
bu‰Ú´ess_pow”b¿Ë_40
 
__P
(());

56 
bu‰Ú´ess_pow”b¿Ë_80
 
__P
(());

59 
	$bd_š™_pow”b¿Ë_40
()

61 
bd
.
wr™e_lše_b¿Ë
 = 
wr™e_lše_tsi
;

62 
bd
.
bu‰Ú´ess
 = 
bu‰Ú´ess_pow”b¿Ë_40
;

63 
bd
.
bd_»¥Ú£_‹¡
 = 
di¥Ïy_¡©us_tsi
;

64 
bd
.
bd_nûÎs
 = 40;

65 
tsi_lše_ty³
 = 2;

67 
	}
}

70 
	$bd_š™_pow”b¿Ë_80
()

72 
bd
.
wr™e_lše_b¿Ë
 = 
wr™e_lše_tsi
;

73 
bd
.
bu‰Ú´ess
 = 
bu‰Ú´ess_pow”b¿Ë_80
;

74 
bd
.
bd_»¥Ú£_‹¡
 = 
di¥Ïy_¡©us_tsi
;

75 
bd
.
bd_nûÎs
 = 80;

76 
tsi_lše_ty³
 = 3;

78 
	}
}

81 
	$bd_š™_Çvig©Ü_40
()

83 
bd
.
wr™e_lše_b¿Ë
 = 
wr™e_lše_tsi
;

84 
bd
.
bu‰Ú´ess
 = 
bu‰Ú´ess_Çvig©Ü_40
;

85 
bd
.
bd_»¥Ú£_‹¡
 = 
di¥Ïy_¡©us_tsi
;

86 
bd
.
bd_nûÎs
 = 40;

87 
tsi_lše_ty³
 = 2;

89 
	}
}

92 
	$di¥Ïy_¡©us_tsi
()

94 
obuf
[3],
ibuf
[20];

95 
r
;

97 
obuf
[0] = 0xff;

98 
obuf
[1] = 0xff;

99 
obuf
[2] = 0x0a;

100 
r
 = 
	`»ad
(
bd
.
bd_fd
, 
ibuf
, 20);

101 
r
 = 
	`wr™e
(
bd
.
bd_fd
, 
obuf
, 3);

102 ià(
r
 != 3)

109 
	`¦“p
(1);

110 
r
 = 
	`»ad
(
bd
.
bd_fd
, 
ibuf
, 2);

111 ià(
r
 == -1)

113 
	`¦“p
(2);

114 
r
 = 
	`»ad
(
bd
.
bd_fd
, 
ibuf
, 2);

116 
	`debug2
("fœ¡ ch¬ äom b¿Ë di¥Ïy %d %d\n",
ibuf
[0],ibuf[1]);

117 ià(
r
 !ğ2 || 
ibuf
[0] != 0 || ibuf[1] != 5)

120 
r
ğ
	`»ad
(
bd
.
bd_fd
,
ibuf
,2);

121 ià(
r
 != 2)

123 
	`debug2
("b¿Ë di¥Ïy size:%d dÙs:%d\n", 
ibuf
[0], ibuf[1]);

124 
bd
.
bd_nûÎs
 = ()
ibuf
[0];

125 ià(
bd
.
bd_nûÎs
 <= 1)

127 
r
 = 
	`»ad
(
bd
.
bd_fd
,
ibuf
,1);

128 ià(
r
 != 1)

130 ià(
r
 != -1)

131 ià(
ibuf
[0] == 'V')

132 
r
 = 
	`»ad
(
bd
.
bd_fd
, 
ibuf
, 3);

134 
r
 = 
	`»ad
(
bd
.
bd_fd
, 
ibuf
 + 1, 2) + 1;

135 ià(
r
 != 3)

137 
ibuf
[3] = 0;

138 
	`debug1
("b¿Ë di¥Ïy v”siÚ %s\n", 
ibuf
);

139 
bd
.
bd_v”siÚ
 = 
	`©of
(
ibuf
);

141 
	}
}

145 
	$wr™e_lše_tsi
 (
b¡r
,
lše_Ëngth
, 
cursÜ_pos
)

146 *
b¡r
;

147 
lše_Ëngth
, 
cursÜ_pos
;

149 
obp
, 
i
;

150 
bd
.
bd_obuf
[0] = 0xff;

151 
bd
.
bd_obuf
[1] = 0xff;

152 
bd
.
bd_obuf
[2] = 
tsi_lše_ty³
;

153 
bd
.
bd_obuf
[3] = 0x07;

154 
bd
.
bd_obuf
[4] = 
cursÜ_pos
;

155 
bd
.
bd_obuf
[5] = 
tsi_ùy³
;

156 
obp
=6;

158 
i
=0; i < 
lše_Ëngth
; i++)

160 
bd
.
bd_obuf
[2*
i
+
obp
] = 0;

161 
bd
.
bd_obuf
[2*
i
+1+
obp
] = bd.
bd_bbË
[()()
b¡r
[i]];

163 
i
=
lše_Ëngth
; i < 
bd
.
bd_nûÎs
; i++)

165 
bd
.
bd_obuf
[2*
i
+
obp
] = 0;

166 
bd
.
bd_obuf
[2*
i
+1+
obp
] = bd.
bd_bbË
[()' '];

169 
bd
.
bd_obuæ’
 = 2*bd.
bd_nûÎs
 + 
obp
 ;

171 
	}
}

173 
key2rc
 
	gkeys_Çvig©Ü_40
[] = {

174 {0x4000000, 
RC_STUFF
, "-k", "kl"},

175 {0x10000000, 
RC_STUFF
, "-k", "kr"},

176 {0x8000000, 
RC_STUFF
, "-k", "ku"},

177 {0x20000000, 
RC_STUFF
, "-k", "kd"},

178 {0x2000, 
RC_BD_BC_LEFT
, 0, 0},

179 {0x8000, 
RC_BD_BC_RIGHT
, 0, 0},

180 {0x4000, 
RC_BD_BC_UP
, 0, 0},

181 {0x10000, 
RC_BD_BC_DOWN
, 0, 0},

182 {0x6000, 
RC_BD_UPPER_LEFT
, 0, 0},

183 {0xc000, 
RC_BD_UPPER_RIGHT
, 0, 0},

184 {0x12000, 
RC_BD_LOWER_LEFT
, 0, 0},

185 {0x18000, 
RC_BD_LOWER_RIGHT
, 0, 0},

186 {0xa000, 
RC_BD_INFO
, "1032", 0},

187 {0x14000000, 
RC_BD_INFO
, "2301", 0},

188 {0x4008000, 
RC_BD_INFO
, "3330", 0},

189 {0x8010000, 
RC_BD_BELL
, 0, 0},

190 {0x8004000, 
RC_BD_EIGHTDOT
, 0, 0},

191 {0x40000000, 
RC_STUFF
, "\015", 0},

192 {0x20000, 
RC_BD_LINK
, 0, 0},

193 {0x10002000, 
RC_BD_SCROLL
, 0, 0},

194 {0x20010000, 
RC_BD_NCRC
, "+", 0},

195 {0x14000, 
RC_BD_SKIP
, 0, 0},

196 {-1, 
RC_ILLEGAL
, 0, 0}

199 
key2rc
 
	gkeys_pow”b¿Ë_40
[] = {

200 {0x4000000, 
RC_STUFF
, "-k", "kl"},

201 {0x10000000, 
RC_STUFF
, "-k", "kr"},

202 {0x8000000, 
RC_STUFF
, "-k", "ku"},

203 {0x20000000, 
RC_STUFF
, "-k", "kd"},

204 {0x2000, 
RC_BD_BC_LEFT
, 0, 0},

205 {0x8000, 
RC_BD_BC_RIGHT
, 0, 0},

206 {0x4000, 
RC_BD_BC_UP
, 0, 0},

207 {0x10000, 
RC_BD_BC_DOWN
, 0, 0},

208 {0x8002000, 
RC_BD_UPPER_LEFT
, 0, 0},

209 {0xc000, 
RC_BD_UPPER_RIGHT
, 0, 0},

210 {0x20002000, 
RC_BD_LOWER_LEFT
, 0, 0},

211 {0x18000, 
RC_BD_LOWER_RIGHT
, 0, 0},

212 {0x8008000, 
RC_BD_INFO
, "1032", 0},

213 {0x6000, 
RC_BD_INFO
, "2301", 0},

214 {0x8004000, 
RC_BD_INFO
, "3330", 0},

215 {0x8010000, 
RC_BD_BELL
, 0, 0},

216 {0x20008000, 
RC_BD_EIGHTDOT
, 0, 0},

217 {0x40000000, 
RC_STUFF
, "\015", 0},

218 {0x20000, 
RC_BD_LINK
, 0, 0},

219 {0xa000, 
RC_BD_SCROLL
, 0, 0},

220 {0x20010000, 
RC_BD_NCRC
, "+", 0},

221 {0x20004000, 
RC_BD_SKIP
, 0, 0},

222 {-1, 
RC_ILLEGAL
, 0, 0}

226 
key2rc
 
	gkeys_pow”b¿Ë_80
[] = {

227 {0x4000000, 
RC_STUFF
, "-k", "kl"},

228 {0x10000000, 
RC_STUFF
, "-k", "kr"},

229 {0x8000000, 
RC_STUFF
, "-k", "ku"},

230 {0x20000000, 
RC_STUFF
, "-k", "kd"},

231 {0x40000, 
RC_BD_BC_LEFT
, 0, 0},

232 {0x100000, 
RC_BD_BC_RIGHT
, 0, 0},

233 {0x4000, 
RC_BD_BC_UP
, 0, 0},

234 {0x10000, 
RC_BD_BC_DOWN
, 0, 0},

235 {0x44000, 
RC_BD_UPPER_LEFT
, 0, 0},

236 {0x104000, 
RC_BD_UPPER_RIGHT
, 0, 0},

237 {0x50000, 
RC_BD_LOWER_LEFT
, 0, 0},

238 {0x110000, 
RC_BD_LOWER_RIGHT
, 0, 0},

239 {0x8100000, 
RC_BD_INFO
, "1032", 0},

240 {0x8040000, 
RC_BD_INFO
, "2301", 0},

241 {0x140000, 
RC_BD_INFO
, "3330", 0},

242 {0x8010000, 
RC_BD_BELL
, 0, 0},

243 {0x8004000, 
RC_BD_EIGHTDOT
, 0, 0},

244 {0x40000000, 
RC_STUFF
, "\015", 0},

245 {0x20000, 
RC_BD_LINK
, 0, 0},

246 {0x20004000, 
RC_BD_SCROLL
, 0, 0},

247 {0x20010000, 
RC_BD_NCRC
, "+", 0},

248 {0x40010000, 
RC_BD_SKIP
, 0, 0},

249 {-1, 
RC_ILLEGAL
, 0, 0}

253 
	$bu‰Ú´ess_tsi
(
b
)

254 
key2rc
 *
b
;

256 
i
, 
nb
;

257 
bkeys
;

258 
buf
[10];

259 
nb
 = 
	`»ad
(
bd
.
bd_fd
, 
buf
, 10);

260 
	`debug1
("bu‰Ú´ess_tsi:„—d %d by‹s\n", 
nb
);

261 
i
=0, 
bkeys
=0; i < 
nb
; i++)

263 
buf
[
i
] & 0xE0)

265 0x00: 
bkeys
 +ğ(()(
buf
[
i
] & 0x1f) ); ;

266 0x20: 
bkeys
 +ğ(()(
buf
[
i
] & 0x1f) << 5 ); ;

267 0x40: 
bkeys
 +ğ(()(
buf
[
i
] & 0x1f) << 9 ); ;

268 0x60: 
bkeys
 +ğ(()(
buf
[
i
] & 0x1f) << 13 ); ;

269 0xA0: 
bkeys
 +ğ(()(
buf
[
i
] & 0x1f) << 18 ); ;

270 0xC0: 
bkeys
 +ğ(()(
buf
[
i
] & 0x1f) << 22 ); ;

271 0xE0: 
bkeys
 +ğ(()(
buf
[
i
] & 0x1f) << 26 ); ;

275 
	`debug1
("bkey %x\n", 
bkeys
);

276 
i
 = 0; 
b
[i].
key
 != -1; i++)

277 ià(
bkeys
 =ğ
b
[
i
].
key
)

279 
	`debug1
("bkey index %d\n", 
i
);

280 ià(
b
[
i
].
key
 !ğ-1 &&ab[i].
Ä
 !ğ
RC_ILLEGAL
)

282 *
¬gs
[3];

283 
¬gl
[2];

285 
aùiÚ
 
aù
;

286 
¬gs
[0] = 
b
[
i
].
¬g1
;

287 
¬gs
[1] = 
b
[
i
].
¬g2
;

288 
¬gs
[2] = 0;

289 
¬gl
[0] = 
¬gs
[0] ? 
	`¡¾’
(args[0]) : 0;

290 
¬gl
[1] = 
¬gs
[1] ? 
	`¡¾’
(args[1]) : 0;

291 
aù
.
Ä
 = 
b
[
i
].nr;

292 
aù
.
¬gs
 =‡rgs;

293 
aù
.
¬gl
 =‡rgl;

294 
di¥Ïy
 = 
bd
.
bd_dpy
;

295 
	`DoAùiÚ
(&
aù
, -2);

297 
	}
}

301 
	$bu‰Ú´ess_Çvig©Ü_40
()

303 
	`bu‰Ú´ess_tsi
(
keys_Çvig©Ü_40
);

304 
	}
}

307 
	$bu‰Ú´ess_pow”b¿Ë_40
()

309 
	`bu‰Ú´ess_tsi
(
keys_pow”b¿Ë_40
);

310 
	}
}

313 
	$bu‰Ú´ess_pow”b¿Ë_80
()

315 
	`bu‰Ú´ess_tsi
(
keys_pow”b¿Ë_80
);

316 
	}
}

	@comm.c

33 
	~"cÚfig.h
"

34 
	~"aşs.h
"

35 
	~"comm.h
"

37 
	#bcİy
 :-Ğ

	)

41 
comm
 
	gcomms
[
RC_LAST
 + 1] =

43 #ifdeà
MULTIUSER


44 { "aşadd", 
ARGS_1234
 },

45 { "aşchg", 
ARGS_23
 },

46 { "aşd–", 
ARGS_1
 },

47 { "aşg½", 
ARGS_12
 },

48 { "aşumask", 
ARGS_1
|
ARGS_ORMORE
 },

50 { "aùiv™y", 
ARGS_1
 },

51 #ifdeà
MULTIUSER


52 { "addaş", 
ARGS_1234
 },

54 { "®Í¬tŸl", 
NEED_DISPLAY
|
ARGS_1
 },

55 { "®tsü“n", 
ARGS_01
 },

56 { "©", 
NEED_DISPLAY
|
ARGS_2
|
ARGS_ORMORE
 },

57 #ifdeà
COLOR


58 { "©ŒcŞÜ", 
ARGS_12
 },

60 { "autod‘ach", 
ARGS_1
 },

61 #ifdeà
AUTO_NUKE


62 { "autÚuke", 
NEED_DISPLAY
|
ARGS_1
 },

64 { "backtick", 
ARGS_1
|
ARGS_ORMORE
 },

65 #ifdeà
COLOR


66 { "bû", 
NEED_FORE
|
ARGS_01
 },

69 #ifdeà
HAVE_BRAILLE


71 { "bd_bc_down", 
ARGS_0
 },

72 { "bd_bc_Ëá", 
ARGS_0
 },

73 { "bd_bc_right", 
ARGS_0
 },

74 { "bd_bc_up", 
ARGS_0
 },

75 { "bd_b–l", 
ARGS_01
 },

76 { "bd_b¿Ë_bË", 
ARGS_01
 },

77 { "bd_eightdÙ", 
ARGS_01
 },

78 { "bd_šfo", 
ARGS_01
 },

79 { "bd_lšk", 
ARGS_01
 },

80 { "bd_low”_Ëá", 
ARGS_0
 },

81 { "bd_low”_right", 
ARGS_0
 },

82 { "bd_nüc", 
ARGS_01
 },

83 { "bd_pÜt", 
ARGS_01
 },

84 { "bd_süŞl", 
ARGS_01
 },

85 { "bd_sk", 
ARGS_01
 },

86 { "bd_¡¬t_b¿Ë", 
ARGS_01
 },

87 { "bd_ty³", 
ARGS_01
 },

88 { "bd_uµ”_Ëá", 
ARGS_0
 },

89 { "bd_uµ”_right", 
ARGS_0
 },

90 { "bd_width", 
ARGS_01
 },

93 { "b–l", 
ARGS_01
 },

94 { "b–l_msg", 
ARGS_01
 },

95 { "bšd", 
ARGS_1
|
ARGS_ORMORE
 },

96 #ifdeà
MAPKEYS


97 { "bšdkey", 
ARGS_0
|
ARGS_ORMORE
 },

99 { "bÏnk”", 
NEED_DISPLAY
|
ARGS_0
},

100 #ifdeà
BLANKER_PRG


101 { "bÏnk”´g", 
ARGS_1
|
ARGS_ORMORE
 },

103 { "b»ak", 
NEED_FORE
|
ARGS_01
 },

104 { "b»akty³", 
NEED_FORE
|
ARGS_01
 },

105 #ifdeà
COPY_PASTE


106 { "bufãrfe", 
ARGS_01
 },

108 { "c1", 
NEED_FORE
|
ARGS_01
 },

109 { "ÿ±iÚ", 
ARGS_12
 },

110 #ifdeà
MULTIUSER


111 { "chaş", 
ARGS_23
 },

113 { "ch¬£t", 
NEED_FORE
|
ARGS_1
 },

114 { "chdœ", 
ARGS_01
 },

115 { "ş—r", 
NEED_FORE
|
ARGS_0
 },

116 { "cŞÚ", 
NEED_LAYER
|
ARGS_01
 },

117 { "commªd", 
NEED_DISPLAY
|
ARGS_02
 },

118 #ifdeà
COPY_PASTE


119 { "com·ùhi¡", 
ARGS_01
 },

121 { "cÚsŞe", 
NEED_FORE
|
ARGS_01
 },

122 #ifdeà
COPY_PASTE


123 { "cİy", 
NEED_FORE
|
ARGS_0
 },

124 { "ülf", 
ARGS_01
 },

126 { "debug", 
ARGS_01
 },

127 #ifdeà
AUTO_NUKE


128 { "deçutÚuke", 
ARGS_1
 },

130 #ifdeà
COLOR


131 { "defbû", 
ARGS_1
 },

133 { "defb»akty³", 
ARGS_01
 },

134 { "defc1", 
ARGS_1
 },

135 { "defch¬£t", 
ARGS_01
 },

136 #ifdeà
ENCODINGS


137 { "deãncodšg", 
ARGS_1
 },

139 { "deãsÿ³", 
ARGS_1
 },

140 { "defæow", 
ARGS_12
 },

141 { "defgr", 
ARGS_1
 },

142 { "defh¡©us", 
ARGS_01
 },

143 #ifdeà
ENCODINGS


144 { "defkªji", 
ARGS_1
 },

146 { "deæog", 
ARGS_1
 },

147 #ià
defšed
(
UTMPOK
è&& defšed(
LOGOUTOK
)

148 { "deæogš", 
ARGS_1
 },

150 { "defmode", 
ARGS_1
 },

151 { "defmÚ™Ü", 
ARGS_1
 },

152 #ifdeà
MULTI


153 { "deâÚblock", 
ARGS_1
 },

155 { "defobuæim™", 
ARGS_1
 },

156 #ifdeà
COPY_PASTE


157 { "defsüŞlback", 
ARGS_1
 },

159 { "defsh–l", 
ARGS_1
 },

160 { "defs’û", 
ARGS_1
 },

161 { "def¦ow·¡e", 
ARGS_1
 },

162 #ifdeà
UTF8


163 { "defutf8", 
ARGS_1
 },

165 { "defw¿p", 
ARGS_1
 },

166 { "defwr™–ock", 
ARGS_1
 },

167 #ifdeà
DETACH


168 { "d‘ach", 
NEED_DISPLAY
|
ARGS_01
 },

170 { "dig¿ph", 
NEED_LAYER
|
ARGS_01
 },

171 { "dšfo", 
NEED_DISPLAY
|
ARGS_0
 },

172 { "di¥Ïys", 
NEED_LAYER
|
ARGS_0
 },

173 { "dum±”mÿp", 
NEED_FORE
|
ARGS_0
 },

174 { "echo", 
ARGS_12
 },

175 #ifdeà
ENCODINGS


176 { "’codšg", 
ARGS_12
 },

178 { "esÿ³", 
ARGS_1
 },

179 { "ev®", 
ARGS_1
|
ARGS_ORMORE
 },

180 #ifdeà
PSEUDOS


181 { "exec", 
NEED_FORE
|
ARGS_0
|
ARGS_ORMORE
 },

183 { "f™", 
NEED_DISPLAY
|
ARGS_0
 },

184 { "æow", 
NEED_FORE
|
ARGS_01
 },

185 { "focus", 
NEED_DISPLAY
|
ARGS_01
 },

186 { "gr", 
NEED_FORE
|
ARGS_01
 },

187 { "h¬dcİy", 
ARGS_012
 },

188 { "h¬dcİy_­³nd", 
ARGS_1
 },

189 { "h¬dcİydœ", 
ARGS_01
 },

190 { "h¬d¡©us", 
ARGS_012
 },

191 { "height", 
ARGS_0123
 },

192 { "h–p", 
NEED_LAYER
|
ARGS_02
 },

193 #ifdeà
COPY_PASTE


194 { "hi¡Üy", 
NEED_DISPLAY
|
NEED_FORE
|
ARGS_0
 },

196 { "h¡©us", 
NEED_FORE
|
ARGS_1
 },

197 { "idË", 
ARGS_0
|
ARGS_ORMORE
 },

198 { "ignÜeÿ£", 
ARGS_01
 },

199 { "šfo", 
NEED_LAYER
|
ARGS_0
 },

200 #ifdeà
ENCODINGS


201 { "kªji", 
NEED_FORE
|
ARGS_12
 },

203 { "kl", 
NEED_FORE
|
ARGS_0
 },

204 { "Ï¡msg", 
NEED_DISPLAY
|
ARGS_0
 },

205 { "liûn£", 
NEED_LAYER
|
ARGS_0
 },

206 #ifdeà
LOCK


207 { "locksü“n", 
NEED_DISPLAY
|
ARGS_0
 },

209 { "log", 
NEED_FORE
|
ARGS_01
 },

210 { "logfe", 
ARGS_012
 },

211 #ià
defšed
(
UTMPOK
è&& defšed(
LOGOUTOK
)

212 { "logš", 
NEED_FORE
|
ARGS_01
 },

214 { "logt¡amp", 
ARGS_012
 },

215 #ifdeà
MAPKEYS


216 { "m­deçuÉ", 
NEED_DISPLAY
|
ARGS_0
 },

217 { "m­nÙÃxt", 
NEED_DISPLAY
|
ARGS_0
 },

218 { "m­timeout", 
ARGS_01
 },

220 #ifdeà
COPY_PASTE


221 { "m¬kkeys", 
ARGS_1
 },

223 { "maxwš", 
ARGS_1
 },

224 { "m‘a", 
NEED_LAYER
|
ARGS_0
 },

225 { "mÚ™Ü", 
NEED_FORE
|
ARGS_01
 },

226 { "msgmšwa™", 
ARGS_1
 },

227 { "msgwa™", 
ARGS_1
 },

228 #ifdeà
MULTIUSER


229 { "muÉiu£r", 
ARGS_1
 },

231 #ifdeà
NETHACK


232 { "Ãthack", 
ARGS_1
 },

234 { "Ãxt", 
ARGS_0
 },

235 #ifdeà
MULTI


236 { "nÚblock", 
NEED_DISPLAY
|
ARGS_01
 },

238 { "numb”", 
NEED_FORE
|
ARGS_01
 },

239 { "obuæim™", 
NEED_DISPLAY
|
ARGS_01
 },

240 { "Úly", 
NEED_DISPLAY
|
ARGS_0
 },

241 { "Ùh”", 
ARGS_0
 },

242 { "·¹Ÿl", 
NEED_FORE
|
ARGS_01
 },

243 #ifdeà
PASSWORD


244 { "·sswÜd", 
ARGS_01
 },

246 #ifdeà
COPY_PASTE


247 { "·¡e", 
NEED_LAYER
|
ARGS_012
 },

248 { "·¡efÚt", 
ARGS_01
 },

250 { "pow_b»ak", 
NEED_FORE
|
ARGS_01
 },

251 #ià
defšed
(
DETACH
è&& defšed(
POW_DETACH
)

252 { "pow_d‘ach", 
NEED_DISPLAY
|
ARGS_0
 },

253 { "pow_d‘ach_msg", 
ARGS_01
 },

255 { "´ev", 
ARGS_0
 },

256 { "´štcmd", 
ARGS_01
 },

257 { "´oûss", 
NEED_DISPLAY
|
ARGS_01
 },

258 { "qu™", 
ARGS_0
 },

259 #ifdeà
COPY_PASTE


260 { "»adbuf", 
ARGS_0123
 },

262 { "»ad»g", 
ARGS_0
|
ARGS_ORMORE
 },

263 { "»di¥Ïy", 
NEED_DISPLAY
|
ARGS_0
 },

264 { "»gi¡”", 
ARGS_24
 },

265 { "»move", 
NEED_DISPLAY
|
ARGS_0
 },

266 #ifdeà
COPY_PASTE


267 { "»movebuf", 
ARGS_0
 },

269 { "»£t", 
NEED_FORE
|
ARGS_0
 },

270 { "»size", 
NEED_DISPLAY
|
ARGS_01
 },

271 { "sü“n", 
ARGS_0
|
ARGS_ORMORE
 },

272 #ifdeà
COPY_PASTE


273 { "süŞlback", 
NEED_FORE
|
ARGS_1
 },

275 { "£Ëù", 
ARGS_01
 },

276 { "£ssiÚÇme", 
ARGS_01
 },

277 { "£‹nv", 
ARGS_012
 },

278 { "£tsid", 
ARGS_1
 },

279 { "sh–l", 
ARGS_1
 },

280 { "sh–É™Ë", 
ARGS_1
 },

281 { "s’û", 
NEED_FORE
|
ARGS_01
 },

282 { "s’ûwa™", 
ARGS_1
 },

283 { "¦“p", 
ARGS_1
 },

284 { "¦ow·¡e", 
NEED_FORE
|
ARGS_01
 },

285 { "sÜ’d™iÚ", 
ARGS_012
 },

286 { "sourû", 
ARGS_1
 },

287 { "¥l™", 
NEED_DISPLAY
|
ARGS_0
 },

288 { "¡¬tup_mes§ge", 
ARGS_1
 },

289 { "¡uff", 
NEED_LAYER
|
ARGS_12
 },

290 #ifdeà
MULTIUSER


291 { "su", 
NEED_DISPLAY
|
ARGS_012
 },

293 #ifdeà
BSDJOBS


294 { "su¥’d", 
NEED_DISPLAY
|
ARGS_0
 },

296 { "‹rm", 
ARGS_1
 },

297 { "‹rmÿp", 
ARGS_23
 },

298 { "‹rmÿpšfo", 
ARGS_23
 },

299 { "‹rmšfo", 
ARGS_23
 },

300 { "time", 
ARGS_01
 },

301 { "t™Ë", 
NEED_FORE
|
ARGS_01
 },

302 { "umask", 
ARGS_1
|
ARGS_ORMORE
 },

303 { "un£‹nv", 
ARGS_1
 },

304 #ifdeà
UTF8


305 { "utf8", 
NEED_FORE
|
ARGS_012
 },

307 { "vb–l", 
ARGS_01
 },

308 { "vb–l_msg", 
ARGS_01
 },

309 { "vb–lwa™", 
ARGS_1
 },

310 { "v”bo£", 
ARGS_01
 },

311 { "v”siÚ", 
ARGS_0
 },

312 { "w®l", 
NEED_DISPLAY
|
ARGS_1
},

313 { "width", 
ARGS_0123
 },

314 { "wšdowli¡", 
NEED_DISPLAY
|
ARGS_012
 },

315 { "wšdows", 
NEED_DISPLAY
|
ARGS_0
 },

316 { "w¿p", 
NEED_FORE
|
ARGS_01
 },

317 #ifdeà
COPY_PASTE


318 { "wr™ebuf", 
ARGS_0123
 },

320 { "wr™–ock", 
NEED_FORE
|
ARGS_01
 },

321 { "xoff", 
NEED_LAYER
|
ARGS_0
 },

322 { "xÚ", 
NEED_LAYER
|
ARGS_0
 },

323 #ifdeà
ZMODEM


324 { "zmodem", 
ARGS_012
 },

326 { "zomb›", 
ARGS_01
 }

	@display.c

24 
	~<sys/ty³s.h
>

25 
	~<sigÇl.h
>

26 
	~<fú.h
>

27 #iâdeà
sun


28 
	~<sys/ioùl.h
>

31 
	~"cÚfig.h
"

32 
	~"sü“n.h
"

33 
	~"ex‹º.h
"

34 
	~"b¿Ë.h
"

36 
CouÁCh¬s
 
__P
(());

37 
DoAddCh¬
 
__P
(());

38 
BÏnkResize
 
__P
((, ));

39 
C®lRewr™e
 
__P
((, , , ));

40 
F»eCªvas
 
__P
((
ÿnvas
 *));

41 
di¥_»adev_â
 
__P
((
ev’t
 *, *));

42 
di¥_wr™“v_â
 
__P
((
ev’t
 *, *));

43 #ifdeà
lšux


44 
di¥_wr™“v_—gaš
 
__P
((
ev’t
 *, *));

46 
di¥_¡©us_â
 
__P
((
ev’t
 *, *));

47 
di¥_h¡©us_â
 
__P
((
ev’t
 *, *));

48 
di¥_blocked_â
 
__P
((
ev’t
 *, *));

49 
cv_wšid_â
 
__P
((
ev’t
 *, *));

50 #ifdeà
MAPKEYS


51 
di¥_m­_â
 
__P
((
ev’t
 *, *));

53 
di¥_idË_â
 
__P
((
ev’t
 *, *));

54 #ifdeà
BLANKER_PRG


55 
di¥_bÏnk”_â
 
__P
((
ev’t
 *, *));

57 
Wr™eLP
 
__P
((, ));

58 
INSERTCHAR
 
__P
(());

59 
RAW_PUTCHAR
 
__P
(());

60 #ifdeà
COLOR


61 
S‘BackCŞÜ
 
__P
(());

65 
Ïy”
 *
æay”
;

66 
wš
 *
wšdows
, *
fÜe
;

67 
LayFuncs
 
WšLf
;

69 
u£_h¬d¡©us
;

70 
MsgWa™
, 
MsgMšWa™
;

71 
Z0width
, 
Z1width
;

72 *
bÏnk
, *
nuÎ
;

73 
mlše
 
mlše_bÏnk
, 
mlše_nuÎ
, 
mlše_Şd
;

74 
mch¬
 
mch¬_nuÎ
, 
mch¬_bÏnk
, 
mch¬_so
;

75 
NewWšdow
 
nwš_deçuÉ
;

76 
aùiÚ
 
idËaùiÚ
;

79 *
h¡©us¡ršg
;

80 *
ÿ±iÚ¡ršg
;

82 
·¡efÚt
;

83 
idËtimo
;

85 #ifdeà
BLANKER_PRG


86 
±y_´eİ’
;

87 #ià
defšed
(
TIOCSWINSZ
è|| defšed(
TIOCGWINSZ
)

88 
wšsize
 
glwz
;

90 **
NewEnv
;

91 
»®_uid
, 
»®_gid
;

97 #iâdeà
NEED_OSPEED


100 
o¥“d
;

103 
di¥Ïy
 *
	gdi¥Ïy
, *
	gdi¥Ïys
;

104 #ifdeà
COLOR


105 
	g©Œ2cŞÜ
[8][4];

106 
	gÇ‰r2cŞÜ
;

109 #iâdeà
MULTI


110 
di¥Ïy
 
	gTheDi¥Ïy
;

116 
	gdefobuæim™
 = 
OBUF_MAX
;

117 
	gdeâÚblock
 = -1;

118 #ifdeà
AUTO_NUKE


119 
	gdeçutÚuke
 = 0;

121 
	gÿ±iÚ®ways
;

122 
	gh¬d¡©u£mu
 = 
HSTATUS_IGNORE
;

129 
	$DefProûss
(
buå
, 
ËÅ
)

130 **
buå
;

131 *
ËÅ
;

133 *
buå
 +ğ*
ËÅ
;

134 *
ËÅ
 = 0;

135 
	}
}

138 
	$DefRedi¥ÏyLše
(
y
, 
xs
, 
xe
, 
isbÏnk
)

139 
y
, 
xs
, 
xe
, 
isbÏnk
;

141 ià(
isbÏnk
 =ğ0 && 
y
 >= 0)

142 
	`DefCË¬Lše
(
y
, 
xs
, 
xe
, 0);

143 
	}
}

146 
	$DefCË¬Lše
(
y
, 
xs
, 
xe
, 
bû
)

147 
y
, 
xs
, 
xe
, 
bû
;

149 
	`LCË¬Lše
(
æay”
, 
y
, 
xs
, 
xe
, 
bû
, (
mlše
 *)0);

150 
	}
}

154 
	$DefRewr™e
(
y
, 
xs
, 
xe
, 
»nd
, 
do™
)

155 
y
, 
xs
, 
xe
, 
do™
;

156 
mch¬
 *
»nd
;

158  
EXPENSIVE
;

159 
	}
}

163 
	$DefResize
(
wi
, 
he
)

164 
wi
, 
he
;

167 
	}
}

170 
	$DefRe¡Üe
()

172 
	`LAY_DISPLAYS
(
æay”
, 
	`In£¹Mode
(0));

174 
	`LKey·dMode
(
æay”
, 0);

175 
	`LCursÜkeysMode
(
æay”
, 0);

176 
	`LCursÜVisib™y
(
æay”
, 0);

177 
	`LMou£Mode
(
æay”
, 0);

178 
	`LS‘R’d™iÚ
(
æay”
, &
mch¬_nuÎ
);

179 
	`LS‘Flow
(
æay”
, 
nwš_deçuÉ
.
æowæag
 & 
FLOW_NOW
);

180 
	}
}

186 
LayFuncs
 
	gBÏnkLf
 =

188 
DefProûss
,

190 
DefRedi¥ÏyLše
,

191 
DefCË¬Lše
,

192 
DefRewr™e
,

193 
BÏnkResize
,

194 
DefRe¡Üe


199 
	$BÏnkResize
(
wi
, 
he
)

200 
wi
, 
he
;

202 
æay”
->
l_width
 = 
wi
;

203 
æay”
->
l_height
 = 
he
;

205 
	}
}

214 
di¥Ïy
 *

215 
	$MakeDi¥Ïy
(
uÇme
, 
u‰y
, 
‹rm
, 
fd
, 
pid
, 
Mode
)

216 *
uÇme
, *
u‰y
, *
‹rm
;

217 
fd
, 
pid
;

218 
mode
 *
Mode
;

220 
aşu£r
 **
u
;

221 
baud_v®ues
 *
b
;

223 ià(!*(
u
 = 
	`FšdU£rPŒ
(
uÇme
)è&& 
	`U£rAdd
(uname, (*)0, u))

226 #ifdeà
MULTI


227 ià((
di¥Ïy
 = (di¥Ïy *)
	`ÿÎoc
(1, (*display))) == 0)

230 ià(
di¥Ïys
)

232 
	`bz”o
((*)&
TheDi¥Ïy
, (TheDisplay));

233 
di¥Ïy
 = &
TheDi¥Ïy
;

235 
di¥Ïy
->
d_Ãxt
 = 
di¥Ïys
;

236 
di¥Ïys
 = 
di¥Ïy
;

237 
D_æow
 = 1;

238 
D_nÚblock
 = 
deâÚblock
;

239 
D_u£rfd
 = 
fd
;

240 
D_»adev
.
fd
 = 
D_wr™“v
.fd = fd;

241 
D_»adev
.
ty³
 = 
EV_READ
;

242 
D_wr™“v
.
ty³
 = 
EV_WRITE
;

243 
D_»adev
.
d©a
 = 
D_wr™“v
.d©¨ğ(*)
di¥Ïy
;

244 
D_»adev
.
hªdËr
 = 
di¥_»adev_â
;

245 
D_wr™“v
.
hªdËr
 = 
di¥_wr™“v_â
;

246 
	`ev’q
(&
D_»adev
);

247 
D_wr™“v
.
cÚdpos
 = &
D_obuæ’
;

248 
D_wr™“v
.
cÚdÃg
 = &
D_obufä“
;

249 
	`ev’q
(&
D_wr™“v
);

250 
D_¡©u£v
.
ty³
 = 
EV_TIMEOUT
;

251 
D_¡©u£v
.
d©a
 = (*)
di¥Ïy
;

252 
D_¡©u£v
.
hªdËr
 = 
di¥_¡©us_â
;

253 
D_h¡©u£v
.
ty³
 = 
EV_TIMEOUT
;

254 
D_h¡©u£v
.
d©a
 = (*)
di¥Ïy
;

255 
D_h¡©u£v
.
hªdËr
 = 
di¥_h¡©us_â
;

256 
D_blockedev
.
ty³
 = 
EV_TIMEOUT
;

257 
D_blockedev
.
d©a
 = (*)
di¥Ïy
;

258 
D_blockedev
.
hªdËr
 = 
di¥_blocked_â
;

259 
D_blockedev
.
cÚdpos
 = &
D_obufä“
;

260 
D_blockedev
.
cÚdÃg
 = &
D_obuæ’max
;

261 
D_h¡©u£v
.
hªdËr
 = 
di¥_h¡©us_â
;

262 #ifdeà
MAPKEYS


263 
D_m­ev
.
ty³
 = 
EV_TIMEOUT
;

264 
D_m­ev
.
d©a
 = (*)
di¥Ïy
;

265 
D_m­ev
.
hªdËr
 = 
di¥_m­_â
;

267 
D_idËev
.
ty³
 = 
EV_TIMEOUT
;

268 
D_idËev
.
d©a
 = (*)
di¥Ïy
;

269 
D_idËev
.
hªdËr
 = 
di¥_idË_â
;

270 #ifdeà
BLANKER_PRG


271 
D_bÏnk”ev
.
ty³
 = 
EV_READ
;

272 
D_bÏnk”ev
.
d©a
 = (*)
di¥Ïy
;

273 
D_bÏnk”ev
.
hªdËr
 = 
di¥_bÏnk”_â
;

274 
D_bÏnk”ev
.
fd
 = -1;

276 
D_OldMode
 = *
Mode
;

277 
D_¡©us_obufä“
 = -1;

278 
	`Resize_obuf
();

279 
D_obufmax
 = 
defobuæim™
;

280 
D_obuæ’max
 = 
D_obuæ’
 - 
D_obufmax
;

281 #ifdeà
AUTO_NUKE


282 
D_auto_nuke
 = 
deçutÚuke
;

284 
D_obuå
 = 
D_obuf
;

285 
D_´štfd
 = -1;

286 
D_u£½id
 = 
pid
;

288 #ifdeà
POSIX


289 ià((
b
 = 
	`lookup_baud
(()
	`cfg‘o¥“d
(&
D_OldMode
.
tio
))))

290 
D_do¥“d
 = 
b
->
idx
;

292 #ifdeà
TERMIO


293 ià((
b
 = 
	`lookup_baud
(
D_OldMode
.
tio
.
c_cæag
 & 
CBAUD
)))

294 
D_do¥“d
 = 
b
->
idx
;

296 
D_do¥“d
 = ()
D_OldMode
.
m_‰yb
.
sg_o¥“d
;

299 
	`debug1
("New di¥Ïy o¥“d = %d\n", 
D_do¥“d
);

301 
	`¡ºıy
(
D_u£¹ty
, 
u‰y
, (D_usertty) - 1);

302 
D_u£¹ty
[(D_usertty) - 1] = 0;

303 
	`¡ºıy
(
D_‹rmÇme
, 
‹rm
, (D_termname) - 1);

304 
D_‹rmÇme
[(D_termname) - 1] = 0;

305 
D_u£r
 = *
u
;

306 
D_´oûssšput
 = 
ProûssIÅut
;

307  
di¥Ïy
;

308 
	}
}

312 
	$F»eDi¥Ïy
()

314 
wš
 *
p
;

315 
ÿnvas
 *
cv
, *
cvp
;

316 #ifdeà
MULTI


317 
di¥Ïy
 *
d
, **
dp
;

320 #ifdeà
FONT


321 
	`F»eT¿nsTabË
();

323 #ifdeà
BLANKER_PRG


324 
	`KlBÏnk”
();

326 ià(
D_u£rfd
 >= 0)

328 
	`Flush
();

329 ià(!
di¥Ïy
)

331 
	`S‘TTY
(
D_u£rfd
, &
D_OldMode
);

332 
	`fú
(
D_u£rfd
, 
F_SETFL
, 0);

334 
	`ä“‰y
();

335 ià(
D_‹Áry
)

336 
	`ä“
(
D_‹Áry
);

337 
D_‹Áry
 = 0;

338 ià(
D_´oûssšputd©a
)

339 
	`ä“
(
D_´oûssšputd©a
);

340 
D_´oûssšputd©a
 = 0;

341 
D_tcš™ed
 = 0;

342 
	`evdeq
(&
D_h¡©u£v
);

343 
	`evdeq
(&
D_¡©u£v
);

344 
	`evdeq
(&
D_»adev
);

345 
	`evdeq
(&
D_wr™“v
);

346 
	`evdeq
(&
D_blockedev
);

347 #ifdeà
MAPKEYS


348 
	`evdeq
(&
D_m­ev
);

349 ià(
D_km­s
)

351 
	`ä“
(
D_km­s
);

352 
D_km­s
 = 0;

353 
D_a£qs
 = 0;

354 
D_n£qs
 = 0;

355 
D_£qp
 = 0;

356 
D_£ql
 = 0;

357 
D_£qh
 = 0;

360 
	`evdeq
(&
D_idËev
);

361 #ifdeà
BLANKER_PRG


362 
	`evdeq
(&
D_bÏnk”ev
);

364 #ifdeà
HAVE_BRAILLE


365 ià(
bd
.
bd_dpy
 =ğ
di¥Ïy
)

367 
bd
.
bd_¡¬t_b¿Ë
 = 0;

368 
	`S¹B¿Ë
();

372 #ifdeà
MULTI


373 
dp
 = &
di¥Ïys
; (
d
 = *dpè; d°ğ&d->
d_Ãxt
)

374 ià(
d
 =ğ
di¥Ïy
)

376 
	`ASSERT
(
d
);

377 ià(
D_¡©us_Ï¡msg
)

378 
	`ä“
(
D_¡©us_Ï¡msg
);

379 ià(
D_obuf
)

380 
	`ä“
(
D_obuf
);

381 *
dp
 = 
di¥Ïy
->
d_Ãxt
;

382 
cv
 = 
di¥Ïy
->
d_cvli¡
;

384 
	`ASSERT
(
di¥Ïy
 =ğ
di¥Ïys
);

385 
	`ASSERT
(
di¥Ïy
 =ğ&
TheDi¥Ïy
);

386 
cv
 = 
di¥Ïy
->
d_cvli¡
;

387 
di¥Ïy
->
d_cvli¡
 = 0;

388 
di¥Ïys
 = 0;

391 
p
 = 
wšdows
;…;… =…->
w_Ãxt
)

393 ià(
p
->
w_pdi¥Ïy
 =ğ
di¥Ïy
)

394 
p
->
w_pdi¥Ïy
 = 0;

395 ià(
p
->
w_Ï¡di¥
 =ğ
di¥Ïy
)

396 
p
->
w_Ï¡di¥
 = 0;

397 ià(
p
->
w_»adev
.
cÚdÃg
 =ğ&
D_¡©us
 ||…->w_»adev.cÚdÃg =ğ&
D_obuæ’max
)

398 
p
->
w_»adev
.
cÚdpos
 =…->w_»adev.
cÚdÃg
 = 0;

400 ; 
cv
; cv = 
cvp
)

402 
cvp
 = 
cv
->
c_Ãxt
;

403 
	`F»eCªvas
(
cv
);

405 #ifdeà
ZMODEM


406 
p
 = 
wšdows
;…;… =…->
w_Ãxt
)

407 ià(
p
->
w_zdi¥Ïy
 =ğ
di¥Ïy
)

408 
	`zmodem_abÜt
(
p
, 0);

410 #ifdeà
MULTI


411 
	`ä“
((*)
di¥Ïy
);

413 
di¥Ïy
 = 0;

414 
	}
}

417 
	$MakeDeçuÉCªvas
()

419 
ÿnvas
 *
cv
;

421 
	`ASSERT
(
di¥Ïy
);

422 ià((
cv
 = (
ÿnvas
 *)
	`ÿÎoc
(1,  *cv)) == 0)

424 
cv
->
c_xs
 = 0;

425 
cv
->
c_xe
 = 
D_width
 - 1;

426 
cv
->
c_ys
 = 0;

427 
cv
->
c_ye
 = 
D_height
 - 1 - (
D_has_h¡©us
 =ğ
HSTATUS_LASTLINE
è- 
ÿ±iÚ®ways
;

428 
cv
->
c_xoff
 = 0;

429 
cv
->
c_yoff
 = 0;

430 
cv
->
c_Ãxt
 = 0;

431 
cv
->
c_di¥Ïy
 = 
di¥Ïy
;

432 
cv
->
c_v¶i¡
 = 0;

433 
cv
->
c_ÿ±ev
.
ty³
 = 
EV_TIMEOUT
;

434 
cv
->
c_ÿ±ev
.
d©a
 = (*)cv;

435 
cv
->
c_ÿ±ev
.
hªdËr
 = 
cv_wšid_â
;

437 
cv
->
c_bÏnk
.
l_cvli¡
 = cv;

438 
cv
->
c_bÏnk
.
l_width
 = cv->
c_xe
 - cv->
c_xs
 + 1;

439 
cv
->
c_bÏnk
.
l_height
 = cv->
c_ye
 - cv->
c_ys
 + 1;

440 
cv
->
c_bÏnk
.
l_x
 = cv->c_bÏnk.
l_y
 = 0;

441 
cv
->
c_bÏnk
.
l_Ïyâ
 = &
BÏnkLf
;

442 
cv
->
c_bÏnk
.
l_d©a
 = 0;

443 
cv
->
c_bÏnk
.
l_Ãxt
 = 0;

444 
cv
->
c_bÏnk
.
l_bÙtom
 = &cv->c_blank;

445 
cv
->
c_bÏnk
.
l_blockšg
 = 0;

446 
cv
->
c_Ïy”
 = &cv->
c_bÏnk
;

447 
cv
->
c_Êext
 = 0;

449 
D_cvli¡
 = 
cv
;

450 
	`R‘hškDi¥ÏyV›wpÜts
();

451 
D_fÜecv
 = 
cv
;

453 
	}
}

456 
	$F»eCªvas
(
cv
)

457 
ÿnvas
 *
cv
;

459 
v›wpÜt
 *
vp
, *
nvp
;

460 
wš
 *
p
;

462 
p
 = 
	`Lay”2Wšdow
(
cv
->
c_Ïy”
);

463 
	`S‘CªvasWšdow
(
cv
, 0);

464 ià(
p
)

465 
	`WšdowChªged
(
p
, 'u');

466 ià(
æay”
 =ğ
cv
->
c_Ïy”
)

467 
æay”
 = 0;

468 
vp
 = 
cv
->
c_v¶i¡
; vp; v°ğ
nvp
)

470 
vp
->
v_ÿnvas
 = 0;

471 
nvp
 = 
vp
->
v_Ãxt
;

472 
vp
->
v_Ãxt
 = 0;

473 
	`ä“
(
vp
);

475 
	`evdeq
(&
cv
->
c_ÿ±ev
);

476 
	`ä“
(
cv
);

477 
	}
}

480 
	$AddCªvas
()

482 
hh
, 
h
, 
i
, 
j
;

483 
ÿnvas
 *
cv
, **
cvµ
;

485 
cv
 = 
D_cvli¡
, 
j
 = 0; cv; cv = cv->
c_Ãxt
)

486 
j
++;

487 
j
++;

488 
h
 = 
D_height
 - (
D_has_h¡©us
 =ğ
HSTATUS_LASTLINE
);

489 ià(
h
 / 
j
 <= 1)

492 
cv
 = 
D_cvli¡
; cv; cv = cv->
c_Ãxt
)

493 ià(
cv
 =ğ
D_fÜecv
)

495 
	`ASSERT
(
cv
);

496 
cvµ
 = &
cv
->
c_Ãxt
;

498 ià((
cv
 = (
ÿnvas
 *)
	`ÿÎoc
(1,  *cv)) == 0)

501 
cv
->
c_xs
 = 0;

502 
cv
->
c_xe
 = 
D_width
 - 1;

503 
cv
->
c_ys
 = 0;

504 
cv
->
c_ye
 = 
D_height
 - 1;

505 
cv
->
c_xoff
 = 0;

506 
cv
->
c_yoff
 = 0;

507 
cv
->
c_di¥Ïy
 = 
di¥Ïy
;

508 
cv
->
c_v¶i¡
 = 0;

509 
cv
->
c_ÿ±ev
.
ty³
 = 
EV_TIMEOUT
;

510 
cv
->
c_ÿ±ev
.
d©a
 = (*)cv;

511 
cv
->
c_ÿ±ev
.
hªdËr
 = 
cv_wšid_â
;

513 
cv
->
c_bÏnk
.
l_cvli¡
 = cv;

514 
cv
->
c_bÏnk
.
l_width
 = cv->
c_xe
 - cv->
c_xs
 + 1;

515 
cv
->
c_bÏnk
.
l_height
 = cv->
c_ye
 - cv->
c_ys
 + 1;

516 
cv
->
c_bÏnk
.
l_x
 = cv->c_bÏnk.
l_y
 = 0;

517 
cv
->
c_bÏnk
.
l_Ïyâ
 = &
BÏnkLf
;

518 
cv
->
c_bÏnk
.
l_d©a
 = 0;

519 
cv
->
c_bÏnk
.
l_Ãxt
 = 0;

520 
cv
->
c_bÏnk
.
l_bÙtom
 = &cv->c_blank;

521 
cv
->
c_bÏnk
.
l_blockšg
 = 0;

522 
cv
->
c_Ïy”
 = &cv->
c_bÏnk
;

523 
cv
->
c_Êext
 = 0;

525 
cv
->
c_Ãxt
 = *
cvµ
;

526 *
cvµ
 = 
cv
;

528 
i
 = 0;

529 
cv
 = 
D_cvli¡
; cv; cv = cv->
c_Ãxt
)

531 
hh
 = 
h
 / 
j
-- - 1;

532 
cv
->
c_ys
 = 
i
;

533 
cv
->
c_ye
 = 
i
 + 
hh
 - 1;

534 
cv
->
c_yoff
 = 
i
;

535 
i
 +ğ
hh
 + 1;

536 
h
 -ğ
hh
 + 1;

539 
	`R‘hškDi¥ÏyV›wpÜts
();

540 
	`ResizeLay”sToCªva£s
();

542 
	}
}

545 
	$RemCªvas
()

547 
hh
, 
h
, 
i
, 
j
;

548 
ÿnvas
 *
cv
, **
cvµ
;

549 
did
 = 0;

551 
h
 = 
D_height
 - (
D_has_h¡©us
 =ğ
HSTATUS_LASTLINE
);

552 
cv
 = 
D_cvli¡
, 
j
 = 0; cv; cv = cv->
c_Ãxt
)

553 
j
++;

554 ià(
j
 == 1)

556 
i
 = 0;

557 
j
--;

558 
cvµ
 = &
D_cvli¡
; (
cv
 = *cvµ); cvµ = &cv->
c_Ãxt
)

560 ià(
cv
 =ğ
D_fÜecv
 && !
did
)

562 *
cvµ
 = 
cv
->
c_Ãxt
;

563 
	`F»eCªvas
(
cv
);

564 
cv
 = *
cvµ
;

565 
D_fÜecv
 = 
cv
 ? cv : 
D_cvli¡
;

566 
D_fÜe
 = 
	`Lay”2Wšdow
(
D_fÜecv
->
c_Ïy”
);

567 
æay”
 = 
D_fÜecv
->
c_Ïy”
;

568 ià(
cv
 == 0)

570 
did
 = 1;

572 
hh
 = 
h
 / 
j
-- - 1;

573 ià(!
ÿ±iÚ®ways
 && 
i
 =ğ0 && 
j
 == 0)

574 
hh
++;

575 
cv
->
c_ys
 = 
i
;

576 
cv
->
c_ye
 = 
i
 + 
hh
 - 1;

577 
cv
->
c_yoff
 = 
i
;

578 
i
 +ğ
hh
 + 1;

579 
h
 -ğ
hh
 + 1;

581 
	`R‘hškDi¥ÏyV›wpÜts
();

582 
	`ResizeLay”sToCªva£s
();

583 
	}
}

586 
	$OÃCªvas
()

588 
ÿnvas
 *
mycv
 = 
D_fÜecv
;

589 
ÿnvas
 *
cv
, **
cvµ
;

591 
cvµ
 = &
D_cvli¡
; (
cv
 = *cvpp);)

593 ià(
cv
 =ğ
mycv
)

595 
cv
->
c_ys
 = 0;

596 
cv
->
c_ye
 = 
D_height
 - 1 - (
D_has_h¡©us
 =ğ
HSTATUS_LASTLINE
è- 
ÿ±iÚ®ways
;

597 
cv
->
c_yoff
 = 0;

598 
cvµ
 = &
cv
->
c_Ãxt
;

602 *
cvµ
 = 
cv
->
c_Ãxt
;

603 
	`F»eCªvas
(
cv
);

606 
	`R‘hškDi¥ÏyV›wpÜts
();

607 
	`ResizeLay”sToCªva£s
();

608 
	}
}

611 
	$R‘hškDi¥ÏyV›wpÜts
()

613 
ÿnvas
 *
cv
;

614 
v›wpÜt
 *
vp
, *
v²
;

617 
cv
 = 
di¥Ïy
->
d_cvli¡
; cv; cv = cv->
c_Ãxt
)

619 
vp
 = 
cv
->
c_v¶i¡
; vp; v°ğ
v²
)

621 
vp
->
v_ÿnvas
 = 0;

622 
v²
 = 
vp
->
v_Ãxt
;

623 
	`bz”o
((*)
vp
, (*vp));

624 
	`ä“
(
vp
);

626 
cv
->
c_v¶i¡
 = 0;

628 
di¥Ïy
->
d_vpxmš
 = -1;

629 
di¥Ïy
->
d_vpxmax
 = -1;

631 
cv
 = 
di¥Ïy
->
d_cvli¡
; cv; cv = cv->
c_Ãxt
)

633 ià((
vp
 = (
v›wpÜt
 *)
	`m®loc
( *vp)) == 0)

635 #ifdeà
HOLE


636 
vp
->
v_ÿnvas
 = 
cv
;

637 
vp
->
v_xs
 = 
cv
->
c_xs
;

638 
vp
->
v_ys
 = (
cv
->
c_ys
 + cv->
c_ye
) / 2;

639 
vp
->
v_xe
 = 
cv
->
c_xe
;

640 
vp
->
v_ye
 = 
cv
->
c_ye
;

641 
vp
->
v_xoff
 = 
cv
->
c_xoff
;

642 
vp
->
v_yoff
 = 
cv
->
c_yoff
;

643 
vp
->
v_Ãxt
 = 
cv
->
c_v¶i¡
;

644 
cv
->
c_v¶i¡
 = 
vp
;

646 ià((
vp
 = (
v›wpÜt
 *)
	`m®loc
( *vp)) == 0)

648 
vp
->
v_ÿnvas
 = 
cv
;

649 
vp
->
v_xs
 = (
cv
->
c_xs
 + cv->
c_xe
) / 2;

650 
vp
->
v_ys
 = (3 * 
cv
->
c_ys
 + cv->
c_ye
) / 4;

651 
vp
->
v_xe
 = 
cv
->
c_xe
;

652 
vp
->
v_ye
 = (
cv
->
c_ys
 + cv->
c_ye
) / 2 - 1;

653 
vp
->
v_xoff
 = 
cv
->
c_xoff
;

654 
vp
->
v_yoff
 = 
cv
->
c_yoff
;

655 
vp
->
v_Ãxt
 = 
cv
->
c_v¶i¡
;

656 
cv
->
c_v¶i¡
 = 
vp
;

658 ià((
vp
 = (
v›wpÜt
 *)
	`m®loc
( *vp)) == 0)

660 
vp
->
v_ÿnvas
 = 
cv
;

661 
vp
->
v_xs
 = 
cv
->
c_xs
;

662 
vp
->
v_ys
 = (3 * 
cv
->
c_ys
 + cv->
c_ye
) / 4;

663 
vp
->
v_xe
 = (3 * 
cv
->
c_xs
 + cv->
c_xe
) / 4 - 1;

664 
vp
->
v_ye
 = (
cv
->
c_ys
 + cv->
c_ye
) / 2 - 1;

665 
vp
->
v_xoff
 = 
cv
->
c_xoff
;

666 
vp
->
v_yoff
 = 
cv
->
c_yoff
;

667 
vp
->
v_Ãxt
 = 
cv
->
c_v¶i¡
;

668 
cv
->
c_v¶i¡
 = 
vp
;

670 ià((
vp
 = (
v›wpÜt
 *)
	`m®loc
( *vp)) == 0)

672 
vp
->
v_ÿnvas
 = 
cv
;

673 
vp
->
v_xs
 = 
cv
->
c_xs
;

674 
vp
->
v_ys
 = 
cv
->
c_ys
;

675 
vp
->
v_xe
 = 
cv
->
c_xe
;

676 
vp
->
v_ye
 = (3 * 
cv
->
c_ys
 + cv->
c_ye
) / 4 - 1;

677 
vp
->
v_xoff
 = 
cv
->
c_xoff
;

678 
vp
->
v_yoff
 = 
cv
->
c_yoff
;

679 
vp
->
v_Ãxt
 = 
cv
->
c_v¶i¡
;

680 
cv
->
c_v¶i¡
 = 
vp
;

682 
vp
->
v_ÿnvas
 = 
cv
;

683 
vp
->
v_xs
 = 
cv
->
c_xs
;

684 
vp
->
v_ys
 = 
cv
->
c_ys
;

685 
vp
->
v_xe
 = 
cv
->
c_xe
;

686 
vp
->
v_ye
 = 
cv
->
c_ye
;

687 
vp
->
v_xoff
 = 
cv
->
c_xoff
;

688 
vp
->
v_yoff
 = 
cv
->
c_yoff
;

689 
vp
->
v_Ãxt
 = 
cv
->
c_v¶i¡
;

690 
cv
->
c_v¶i¡
 = 
vp
;

693 ià(
cv
->
c_xs
 < 
di¥Ïy
->
d_vpxmš
 || display->d_vpxmin == -1)

694 
di¥Ïy
->
d_vpxmš
 = 
cv
->
c_xs
;

695 ià(
cv
->
c_xe
 > 
di¥Ïy
->
d_vpxmax
 || display->d_vpxmax == -1)

696 
di¥Ïy
->
d_vpxmax
 = 
cv
->
c_xe
;

699 
	}
}

702 
	$R‘hškV›wpÜtOff£ts
(
cv
)

703 
ÿnvas
 *
cv
;

705 
v›wpÜt
 *
vp
;

707 
vp
 = 
cv
->
c_v¶i¡
; vp; v°ğvp->
v_Ãxt
)

709 
vp
->
v_xoff
 = 
cv
->
c_xoff
;

710 
vp
->
v_yoff
 = 
cv
->
c_yoff
;

712 
	}
}

719 
	$In™T”m
(
ad­t
)

720 
ad­t
;

722 
	`ASSERT
(
di¥Ïy
);

723 
	`ASSERT
(
D_tcš™ed
);

724 
D_tİ
 = 
D_bÙ
 = -1;

725 
	`AddCSŒ
(
D_TI
);

726 
	`AddCSŒ
(
D_IS
);

728 ià(
D_IM
 && 
	`¡rcmp
(D_IM, 
D_EI
))

729 
	`AddCSŒ
(
D_EI
);

730 
D_š£¹
 = 0;

731 #ifdeà
MAPKEYS


732 
	`AddCSŒ
(
D_KS
);

733 
	`AddCSŒ
(
D_CCS
);

736 ià(
D_KS
 && 
	`¡rcmp
(D_KS, 
D_KE
))

737 
	`AddCSŒ
(
D_KE
);

738 ià(
D_CCS
 && 
	`¡rcmp
(D_CCS, 
D_CCE
))

739 
	`AddCSŒ
(
D_CCE
);

741 
D_key·d
 = 0;

742 
D_cursÜkeys
 = 0;

743 
	`AddCSŒ
(
D_ME
);

744 
	`AddCSŒ
(
D_EA
);

745 
	`AddCSŒ
(
D_CE0
);

746 
D_»nd
 = 
mch¬_nuÎ
;

747 
D_©yp
 = 0;

748 ià(
ad­t
 == 0)

749 
	`ResizeDi¥Ïy
(
D_defwidth
, 
D_defheight
);

750 
	`ChªgeSüŞlRegiÚ
(0, 
D_height
 - 1);

751 
D_x
 = 
D_y
 = 0;

752 
	`Flush
();

753 
	`CË¬AÎ
();

754 
	`debug1
("we %swanto‡dapt‡ll our windowsohe display\n",

755 (
ad­t
) ? "" : "don't ");

757 
	`CheckSü“nSize
((
ad­t
) ? 2 : 0);

758 
	}
}

761 
	$Fš™T”m
()

763 
	`ASSERT
(
di¥Ïy
);

764 #ifdeà
BLANKER_PRG


765 
	`KlBÏnk”
();

767 ià(
D_tcš™ed
)

769 
	`ResizeDi¥Ïy
(
D_defwidth
, 
D_defheight
);

770 
	`In£¹Mode
(0);

771 
	`ChªgeSüŞlRegiÚ
(0, 
D_height
 - 1);

772 
	`Key·dMode
(0);

773 
	`CursÜkeysMode
(0);

774 
	`CursÜVisib™y
(0);

775 
	`Mou£Mode
(0);

776 
	`S‘R’d™iÚ
(&
mch¬_nuÎ
);

777 
	`S‘Flow
(
FLOW_NOW
);

778 #ifdeà
MAPKEYS


779 
	`AddCSŒ
(
D_KE
);

780 
	`AddCSŒ
(
D_CCE
);

782 ià(
D_h¡©us
)

783 
	`ShowHStus
((*)0);

784 #ifdeà
RXVT_OSC


785 
	`CË¬AÎX‹rmOSC
();

787 
D_x
 = 
D_y
 = -1;

788 
	`GÙoPos
(0, 
D_height
 - 1);

789 
	`AddCh¬
('\r');

790 
	`AddCh¬
('\n');

791 
	`AddCSŒ
(
D_TE
);

793 
	`Flush
();

794 
	}
}

798 
	$INSERTCHAR
(
c
)

799 
c
;

801 
	`ASSERT
(
di¥Ïy
);

802 ià(!
D_š£¹
 && 
D_x
 < 
D_width
 - 1)

804 ià(
D_IC
 || 
D_CIC
)

806 ià(
D_IC
)

807 
	`AddCSŒ
(
D_IC
);

809 
	`AddCSŒ2
(
D_CIC
, 1);

810 
	`RAW_PUTCHAR
(
c
);

813 
	`In£¹Mode
(1);

814 ià(!
D_š£¹
)

816 
	`ReäeshLše
(
D_y
, 
D_x
, 
D_width
-1, 0);

820 
	`RAW_PUTCHAR
(
c
);

821 
	}
}

824 
	$PUTCHAR
(
c
)

825 
c
;

827 
	`ASSERT
(
di¥Ïy
);

828 ià(
D_š£¹
 && 
D_x
 < 
D_width
 - 1)

829 
	`In£¹Mode
(0);

830 
	`RAW_PUTCHAR
(
c
);

831 
	}
}

834 
	$PUTCHARLP
(
c
)

835 
c
;

837 ià(
D_x
 < 
D_width
 - 1)

839 ià(
D_š£¹
)

840 
	`In£¹Mode
(0);

841 
	`RAW_PUTCHAR
(
c
);

844 ià(
D_CLP
 || 
D_y
 !ğ
D_bÙ
)

846 
y
 = 
D_y
;

847 
	`RAW_PUTCHAR
(
c
);

848 ià(
D_AM
 && !
D_CLP
)

849 
	`GÙoPos
(
D_width
 - 1, 
y
);

852 
	`debug
("PUTCHARLP:†p_missing!\n");

853 
D_Í_missšg
 = 1;

854 
D_»nd
.
image
 = 
c
;

855 
D_Ích¬
 = 
D_»nd
;

856 #ifdeà
DW_CHARS


858 ià(
D_mbcs
)

860 
D_Ích¬
.
mbcs
 = 
c
;

861 
D_Ích¬
.
image
 = 
D_mbcs
;

862 
D_mbcs
 = 0;

863 
D_x
--;

866 
	}
}

873 
STATIC
 

874 
	$RAW_PUTCHAR
(
c
)

875 
c
;

877 
	`ASSERT
(
di¥Ïy
);

879 #ifdeà
FONT


880 #ifdeà
UTF8


881 ià(
D_’codšg
 =ğ
UTF8
)

883 
c
 = (ø& 255è| ()
D_»nd
.
fÚt
 << 8;

884 #ifdeà
DW_CHARS


885 ià(
D_mbcs
)

887 
c
 = 
D_mbcs
;

888 ià(
D_x
 =ğ
D_width
)

889 
D_x
 +ğ
D_AM
 ? 1 : -1;

890 
D_mbcs
 = 0;

892 ià(
	`utf8_isdoubË
(
c
))

894 
D_mbcs
 = 
c
;

895 
D_x
++;

899 ià(
c
 < 32)

901 
	`AddCSŒ2
(
D_CS0
, '0');

902 
	`AddCh¬
(
c
 + 0x5f);

903 
	`AddCSŒ
(
D_CE0
);

904 
addedutf8
;

906 
	`AddUtf8
(
c
);

907 
addedutf8
;

910 #ifdeà
DW_CHARS


911 ià(
	`is_dw_fÚt
(
D_»nd
.
fÚt
))

913 
t
 = 
c
;

914 ià(
D_mbcs
 == 0)

916 
D_mbcs
 = 
c
;

917 
D_x
++;

920 
D_x
--;

921 ià(
D_x
 =ğ
D_width
 - 1)

922 
D_x
 +ğ
D_AM
 ? 1 : -1;

923 
c
 = 
D_mbcs
;

924 
D_mbcs
 = 
t
;

927 #ià
	`defšed
(
ENCODINGS
è&& defšed(
DW_CHARS
)

928 ià(
D_’codšg
)

929 
c
 = 
	`P»·»EncodedCh¬
(c);

931 #ifdeà
DW_CHARS


932 
kªjoİ
:

934 ià(
D_xbË
 && D_xbË[()()
D_»nd
.
fÚt
] && D_xbË[()()D_»nd.fÚt][()()
c
])

935 
	`AddSŒ
(
D_xbË
[()()
D_»nd
.
fÚt
][()()
c
]);

937 
	`AddCh¬
(
D_»nd
.
fÚt
 !ğ'0' ? 
c
 : 
D_c0_b
[()()c]);

939 
	`AddCh¬
(
c
);

942 #ifdeà
UTF8


943 
addedutf8
:

945 ià(++
D_x
 >ğ
D_width
)

947 ià(
D_AM
 == 0)

948 
D_x
 = 
D_width
 - 1;

949 ià(!
D_CLP
 || 
D_x
 > 
D_width
)

951 
D_x
 -ğ
D_width
;

952 ià(
D_y
 < 
D_height
-1 && D_y !ğ
D_bÙ
)

953 
D_y
++;

956 #ifdeà
DW_CHARS


957 ià(
D_mbcs
)

959 
c
 = 
D_mbcs
;

960 
D_mbcs
 = 0;

961 
kªjoİ
;

964 
	}
}

967 
	$DoAddCh¬
(
c
)

968 
c
;

971 
	`AddCh¬
(
c
);

972  
c
;

973 
	}
}

976 
	$AddCSŒ
(
s
)

977 *
s
;

979 ià(
di¥Ïy
 && 
s
 && *s)

981 
o¥“d
 = 
D_do¥“d
;

982 
	`uts
(
s
, 1, 
DoAddCh¬
);

984 
	}
}

987 
	$AddCSŒ2
(
s
, 
c
)

988 *
s
;

989 
c
;

991 ià(
di¥Ïy
 && 
s
 && *s)

993 
o¥“d
 = 
D_do¥“d
;

994 
	`uts
(
	`tgÙo
(
s
, 0, 
c
), 1, 
DoAddCh¬
);

996 
	}
}

1002 
	$In£¹Mode
(
Ú
)

1003 
Ú
;

1005 ià(
di¥Ïy
 && 
Ú
 !ğ
D_š£¹
 && 
D_IM
)

1007 
D_š£¹
 = 
Ú
;

1008 ià(
Ú
)

1009 
	`AddCSŒ
(
D_IM
);

1011 
	`AddCSŒ
(
D_EI
);

1013 
	}
}

1018 
	$Key·dMode
(
Ú
)

1019 
Ú
;

1021 #ifdeà
MAPKEYS


1022 ià(
di¥Ïy
)

1023 
D_key·d
 = 
Ú
;

1025 ià(
di¥Ïy
 && 
D_key·d
 !ğ
Ú
 && 
D_KS
)

1027 
D_key·d
 = 
Ú
;

1028 ià(
Ú
)

1029 
	`AddCSŒ
(
D_KS
);

1031 
	`AddCSŒ
(
D_KE
);

1034 
	}
}

1037 
	$CursÜkeysMode
(
Ú
)

1038 
Ú
;

1040 #ifdeà
MAPKEYS


1041 ià(
di¥Ïy
)

1042 
D_cursÜkeys
 = 
Ú
;

1044 ià(
di¥Ïy
 && 
D_cursÜkeys
 !ğ
Ú
 && 
D_CCS
)

1046 
D_cursÜkeys
 = 
Ú
;

1047 ià(
Ú
)

1048 
	`AddCSŒ
(
D_CCS
);

1050 
	`AddCSŒ
(
D_CCE
);

1053 
	}
}

1056 
	$Rev”£Video
(
Ú
)

1057 
Ú
;

1059 ià(
di¥Ïy
 && 
D_»vvid
 !ğ
Ú
 && 
D_CVR
)

1061 
D_»vvid
 = 
Ú
;

1062 ià(
D_»vvid
)

1063 
	`AddCSŒ
(
D_CVR
);

1065 
	`AddCSŒ
(
D_CVN
);

1067 
	}
}

1070 
	$CursÜVisib™y
(
v
)

1071 
v
;

1073 ià(
di¥Ïy
 && 
D_curvis
 !ğ
v
)

1075 ià(
D_curvis
)

1076 
	`AddCSŒ
(
D_VE
);

1077 
D_curvis
 = 0;

1078 ià(
v
 =ğ-1 && 
D_VI
)

1079 
	`AddCSŒ
(
D_VI
);

1080 ià(
v
 =ğ1 && 
D_VS
)

1081 
	`AddCSŒ
(
D_VS
);

1084 
D_curvis
 = 
v
;

1086 
	}
}

1089 
	$Mou£Mode
(
mode
)

1090 
mode
;

1092 ià(
di¥Ïy
 && 
D_mou£
 !ğ
mode
)

1094 
mou£buf
[20];

1095 ià(!
D_CXT
)

1097 ià(
D_mou£
)

1099 
	`¥rštf
(
mou£buf
, "\033[?%dl", 
D_mou£
);

1100 
	`AddSŒ
(
mou£buf
);

1102 ià(
mode
)

1104 
	`¥rštf
(
mou£buf
, "\033[?%dh", 
mode
);

1105 
	`AddSŒ
(
mou£buf
);

1107 
D_mou£
 = 
mode
;

1109 
	}
}

1111 
	gSŒCo¡
;

1115 
	$CouÁCh¬s
(
c
)

1116 
c
;

1118 
SŒCo¡
++;

1119  
c
;

1120 
	}
}

1123 
	$C®cCo¡
(
s
)

1124 *
s
;

1126 
	`ASSERT
(
di¥Ïy
);

1127 ià(
s
)

1129 
SŒCo¡
 = 0;

1130 
o¥“d
 = 
D_do¥“d
;

1131 
	`uts
(
s
, 1, 
CouÁCh¬s
);

1132  
SŒCo¡
;

1135  
EXPENSIVE
;

1136 
	}
}

1139 
	$C®lRewr™e
(
y
, 
xs
, 
xe
, 
do™
)

1140 
y
, 
xs
, 
xe
, 
do™
;

1142 
ÿnvas
 *
cv
, *
cvli¡
, *
cvÊext
;

1143 
v›wpÜt
 *
vp
;

1144 
Ïy”
 *
Şdæay”
;

1145 
co¡
;

1147 
	`debug3
("C®lRewr™%d %d %d\n", 
y
, 
xs
, 
xe
);

1148 
	`ASSERT
(
di¥Ïy
);

1149 
	`ASSERT
(
xe
 >ğ
xs
);

1151 
vp
 = 0;

1152 
cv
 = 
D_cvli¡
; cv; cv = cv->
c_Ãxt
)

1154 ià(
y
 < 
cv
->
c_ys
 || y > cv->
c_ye
 || 
xe
 < cv->
c_xs
 || 
xs
 > cv->
c_xe
)

1156 
vp
 = 
cv
->
c_v¶i¡
; vp; v°ğvp->
v_Ãxt
)

1157 ià(
y
 >ğ
vp
->
v_ys
 && y <ğvp->
v_ye
 && 
xe
 >ğvp->
v_xs
 && 
xs
 <ğvp->
v_xe
)

1159 ià(
vp
)

1162 ià(
do™
)

1164 
Şdæay”
 = 
æay”
;

1165 
æay”
 = 
cv
->
c_Ïy”
;

1166 
cvli¡
 = 
æay”
->
l_cvli¡
;

1167 
cvÊext
 = 
cv
->
c_Êext
;

1168 
æay”
->
l_cvli¡
 = 
cv
;

1169 
cv
->
c_Êext
 = 0;

1170 
	`LayRewr™e
(
y
 - 
vp
->
v_yoff
, 
xs
 - vp->
v_xoff
, 
xe
 - vp->v_xoff, &
D_»nd
, 1);

1171 
æay”
->
l_cvli¡
 = 
cvli¡
;

1172 
cv
->
c_Êext
 = 
cvÊext
;

1173 
æay”
 = 
Şdæay”
;

1176 ià(
cv
 =ğ0 || cv->
c_Ïy”
 == 0)

1177  
EXPENSIVE
;

1178 ià(
xs
 < 
vp
->
v_xs
 || 
xe
 > vp->
v_xe
)

1179  
EXPENSIVE
;

1180 ià(
y
 - 
vp
->
v_yoff
 < 0 || y - vp->v_yofà>ğ
cv
->
c_Ïy”
->
l_height
)

1181  
EXPENSIVE
;

1182 ià(
xs
 - 
vp
->
v_xoff
 < 0 || 
xe
 - vp->v_xofà>ğ
cv
->
c_Ïy”
->
l_width
)

1183  
EXPENSIVE
;

1184 #ifdeà
UTF8


1185 ià(
D_’codšg
 =ğ
UTF8
)

1186 
D_»nd
.
fÚt
 = 0;

1188 
Şdæay”
 = 
æay”
;

1189 
æay”
 = 
cv
->
c_Ïy”
;

1190 
	`debug3
("C®lšg Rewr™%d %d %d\n", 
y
 - 
vp
->
v_yoff
, 
xs
 - vp->
v_xoff
, 
xe
 - vp->v_xoff);

1191 
co¡
 = 
	`LayRewr™e
(
y
 - 
vp
->
v_yoff
, 
xs
 - vp->
v_xoff
, 
xe
 - vp->v_xoff, &
D_»nd
, 0);

1192 
æay”
 = 
Şdæay”
;

1193 ià(
D_š£¹
)

1194 
co¡
 +ğ
D_EIco¡
 + 
D_IMco¡
;

1195  
co¡
;

1196 
	}
}

1200 
	$GÙoPos
(
x2
, 
y2
)

1201 
x2
, 
y2
;

1203 
dy
, 
dx
, 
x1
, 
y1
;

1204 
co¡x
, 
co¡y
;

1205 
m
;

1206 *
s
;

1207 
CMco¡
;

1208 
move_t
 
xm
 = 
M_NONE
, 
ym
 = M_NONE;

1210 ià(!
di¥Ïy
)

1213 
x1
 = 
D_x
;

1214 
y1
 = 
D_y
;

1216 ià(
x1
 =ğ
D_width
)

1218 ià(
D_CLP
 && 
D_AM
)

1219 
x1
 = -1;

1221 
x1
--;

1223 ià(
x2
 =ğ
D_width
)

1224 
x2
--;

1225 
dx
 = 
x2
 - 
x1
;

1226 
dy
 = 
y2
 - 
y1
;

1227 ià(
dy
 =ğ0 && 
dx
 == 0)

1229 
	`debug2
("GÙoPo (%d,%d)", 
x1
, 
y1
);

1230 
	`debug2
(" -> (%d,%d)\n", 
x2
, 
y2
);

1231 ià(!
D_MS
)

1232 
	`S‘R’d™iÚ
(&
mch¬_nuÎ
);

1233 ià(
y1
 < 0

1234 || (
y2
 > 
D_bÙ
 && 
y1
 <= D_bot)

1235 || (
y2
 < 
D_tİ
 && 
y1
 >= D_top))

1237 
DoCM
:

1238 ià(
D_HO
 && !
x2
 && !
y2
)

1239 
	`AddCSŒ
(
D_HO
);

1241 
	`AddCSŒ
(
	`tgÙo
(
D_CM
, 
x2
, 
y2
));

1242 
D_x
 = 
x2
;

1243 
D_y
 = 
y2
;

1250 ià((
y1
 > 
D_bÙ
 && 
y2
 > y1è|| (y1 < 
D_tİ
 && y2 < y1))

1251 
DoCM
;

1254 ià(
D_HO
 && !
x2
 && !
y2
)

1255 
s
 = 
D_HO
;

1257 
s
 = 
	`tgÙo
(
D_CM
, 
x2
, 
y2
);

1258 
CMco¡
 = 
	`C®cCo¡
(
s
);

1261 
co¡x
 = 
EXPENSIVE
;

1262 ià(
x1
 >= 0)

1264 ià(
dx
 > 0)

1266 ià(
D_CRI
 && (
dx
 > 1 || !
D_ND
))

1268 
co¡x
 = 
	`C®cCo¡
(
	`tgÙo
(
D_CRI
, 0, 
dx
));

1269 
xm
 = 
M_CRI
;

1271 ià((
m
 = 
D_NDco¡
 * 
dx
è< 
co¡x
)

1273 
co¡x
 = 
m
;

1274 
xm
 = 
M_RI
;

1277 ià(
dx
 < 
co¡x
 && (
m
 = 
	`C®lRewr™e
(
y1
, 
x1
, 
x2
 - 1, 0)) < costx)

1279 
co¡x
 = 
m
;

1280 
xm
 = 
M_RW
;

1283 ià(
dx
 < 0)

1285 ià(
D_CLE
 && (
dx
 < -1 || !
D_BC
))

1287 
co¡x
 = 
	`C®cCo¡
(
	`tgÙo
(
D_CLE
, 0, -
dx
));

1288 
xm
 = 
M_CLE
;

1290 ià((
m
 = -
dx
 * 
D_LEco¡
è< 
co¡x
)

1292 
co¡x
 = 
m
;

1293 
xm
 = 
M_LE
;

1297 
co¡x
 = 0;

1300 ià(
x2
 + 
D_CRco¡
 < 
co¡x
 && (
m
 = (x2 ? 
	`C®lRewr™e
(
y1
, 0, x2 - 1, 0) : 0) + D_CRcost) < costx)

1302 
co¡x
 = 
m
;

1303 
xm
 = 
M_CR
;

1307 ià(
co¡x
 >ğ
CMco¡
)

1308 
DoCM
;

1311 
co¡y
 = 
EXPENSIVE
;

1312 ià(
dy
 > 0)

1314 ià(
D_CDO
 && 
dy
 > 1)

1316 
co¡y
 = 
	`C®cCo¡
(
	`tgÙo
(
D_CDO
, 0, 
dy
));

1317 
ym
 = 
M_CDO
;

1319 ià((
m
 = 
dy
 * ((
x2
 =ğ0è? 
D_NLco¡
 : 
D_DOco¡
)è< 
co¡y
)

1321 
co¡y
 = 
m
;

1322 
ym
 = 
M_DO
;

1325 ià(
dy
 < 0)

1327 ià(
D_CUP
 && (
dy
 < -1 || !
D_UP
))

1329 
co¡y
 = 
	`C®cCo¡
(
	`tgÙo
(
D_CUP
, 0, -
dy
));

1330 
ym
 = 
M_CUP
;

1332 ià((
m
 = -
dy
 * 
D_UPco¡
è< 
co¡y
)

1334 
co¡y
 = 
m
;

1335 
ym
 = 
M_UP
;

1339 
co¡y
 = 0;

1342 ià(
co¡x
 + 
co¡y
 >ğ
CMco¡
)

1343 
DoCM
;

1345 
xm
)

1347 
M_LE
:

1348 
dx
++ < 0)

1349 
	`AddCSŒ
(
D_BC
);

1351 
M_CLE
:

1352 
	`AddCSŒ2
(
D_CLE
, -
dx
);

1354 
M_RI
:

1355 
dx
-- > 0)

1356 
	`AddCSŒ
(
D_ND
);

1358 
M_CRI
:

1359 
	`AddCSŒ2
(
D_CRI
, 
dx
);

1361 
M_CR
:

1362 
	`AddCSŒ
(
D_CR
);

1363 
D_x
 = 0;

1364 
x1
 = 0;

1366 
M_RW
:

1367 ià(
x1
 < 
x2
)

1368 (è
	`C®lRewr™e
(
y1
, 
x1
, 
x2
 - 1, 1);

1374 
ym
)

1376 
M_UP
:

1377 
dy
++ < 0)

1378 
	`AddCSŒ
(
D_UP
);

1380 
M_CUP
:

1381 
	`AddCSŒ2
(
D_CUP
, -
dy
);

1383 
M_DO
:

1384 
s
 = (
x2
 =ğ0è? 
D_NL
 : 
D_DO
;

1385 
dy
-- > 0)

1386 
	`AddCSŒ
(
s
);

1388 
M_CDO
:

1389 
	`AddCSŒ2
(
D_CDO
, 
dy
);

1394 
D_x
 = 
x2
;

1395 
D_y
 = 
y2
;

1396 
	}
}

1399 
	$CË¬AÎ
()

1401 
	`ASSERT
(
di¥Ïy
);

1402 
	`CË¬A»a
(0, 0, 0, 
D_width
 - 1, D_width - 1, 
D_height
 - 1, 0, 0);

1403 
	}
}

1406 
	$CË¬A»a
(
x1
, 
y1
, 
xs
, 
xe
, 
x2
, 
y2
, 
bû
, 
u£Ïyâ
)

1407 
x1
, 
y1
, 
xs
, 
xe
, 
x2
, 
y2
, 
bû
, 
u£Ïyâ
;

1409 
y
, 
xxe
;

1410 
ÿnvas
 *
cv
;

1411 
v›wpÜt
 *
vp
;

1413 
	`debug2
("CË¬ %d,%d", 
x1
, 
y1
);

1414 
	`debug2
(" %d-%d", 
xs
, 
xe
);

1415 
	`debug2
(" %d,%d", 
x2
, 
y2
);

1416 
	`debug2
(" u£Ïyâ=%d bû=%d\n", 
u£Ïyâ
, 
bû
);

1417 
	`ASSERT
(
di¥Ïy
);

1418 ià(
x1
 =ğ
D_width
)

1419 
x1
--;

1420 ià(
x2
 =ğ
D_width
)

1421 
x2
--;

1422 ià(
xs
 == -1)

1423 
xs
 = 
x1
;

1424 ià(
xe
 == -1)

1425 
xe
 = 
x2
;

1426 ià(
D_UT
)

1427 
	`S‘R’d™iÚ
(&
mch¬_nuÎ
);

1428 #ifdeà
COLOR


1429 ià(
D_BE
)

1430 
	`S‘BackCŞÜ
(
bû
);

1432 ià(
D_Í_missšg
 && 
y1
 <ğ
D_bÙ
 && 
xe
 >ğ
D_width
 - 1)

1434 ià(
y2
 > 
D_bÙ
 || (y2 =ğD_bÙ && 
x2
 >ğ
D_width
 - 1))

1435 
D_Í_missšg
 = 0;

1437 ià(
x2
 =ğ
D_width
 - 1 && (
xs
 =ğ0 || 
y1
 =ğ
y2
è&& 
xe
 =ğD_width - 1 && y2 =ğ
D_height
 - 1 && (!
bû
 || 
D_BE
))

1439 #ifdeà
AUTO_NUKE


1440 ià(
x1
 =ğ0 && 
y1
 =ğ0 && 
D_auto_nuke
)

1441 
	`NukeP’dšg
();

1443 ià(
x1
 =ğ0 && 
y1
 =ğ0 && 
D_CL
)

1445 
	`AddCSŒ
(
D_CL
);

1446 
D_y
 = 
D_x
 = 0;

1453 ià(
D_CD
 && (
y1
 < 
y2
 || !
D_CE
))

1455 
	`GÙoPos
(
x1
, 
y1
);

1456 
	`AddCSŒ
(
D_CD
);

1460 ià(
x1
 =ğ0 && 
xs
 =ğ0 && (
xe
 =ğ
D_width
 - 1 || 
y1
 =ğ
y2
è&& y1 =ğ0 && 
D_CCD
 && (!
bû
 || 
D_BE
))

1462 
	`GÙoPos
(
x1
, 
y1
);

1463 
	`AddCSŒ
(
D_CCD
);

1466 
xxe
 = 
xe
;

1467 
y
 = 
y1
; y <ğ
y2
; y++, 
x1
 = 
xs
)

1469 ià(
y
 =ğ
y2
)

1470 
xxe
 = 
x2
;

1471 ià(
x1
 =ğ0 && 
D_CB
 && (
xxe
 !ğ
D_width
 - 1 || (
D_x
 =ğxx&& 
D_y
 =ğ
y
)è&& (!
bû
 || 
D_BE
))

1473 
	`GÙoPos
(
xxe
, 
y
);

1474 
	`AddCSŒ
(
D_CB
);

1477 ià(
xxe
 =ğ
D_width
 - 1 && 
D_CE
 && (!
bû
 || 
D_BE
))

1479 
	`GÙoPos
(
x1
, 
y
);

1480 
	`AddCSŒ
(
D_CE
);

1483 ià(
u£Ïyâ
)

1485 
vp
 = 0;

1486 
cv
 = 
D_cvli¡
; cv; cv = cv->
c_Ãxt
)

1488 ià(
y
 < 
cv
->
c_ys
 || y > cv->
c_ye
 || 
xxe
 < cv->
c_xs
 || 
x1
 > cv->
c_xe
)

1490 
vp
 = 
cv
->
c_v¶i¡
; vp; v°ğvp->
v_Ãxt
)

1491 ià(
y
 >ğ
vp
->
v_ys
 && y <ğvp->
v_ye
 && 
xxe
 >ğvp->
v_xs
 && 
x1
 <ğvp->
v_xe
)

1493 ià(
vp
)

1496 ià(
cv
 && cv->
c_Ïy”
 && 
x1
 >ğ
vp
->
v_xs
 && 
xxe
 <ğvp->
v_xe
 &&

1497 
y
 - 
vp
->
v_yoff
 >ğ0 && y - vp->v_yofà< 
cv
->
c_Ïy”
->
l_height
 &&

1498 
xxe
 - 
vp
->
v_xoff
 >ğ0 && 
x1
 - vp->v_xofà< 
cv
->
c_Ïy”
->
l_width
)

1500 
Ïy”
 *
Şdæay”
 = 
æay”
;

1501 
ÿnvas
 *
cvli¡
, *
cvÊext
;

1502 
æay”
 = 
cv
->
c_Ïy”
;

1503 
cvli¡
 = 
æay”
->
l_cvli¡
;

1504 
cvÊext
 = 
cv
->
c_Êext
;

1505 
æay”
->
l_cvli¡
 = 
cv
;

1506 
cv
->
c_Êext
 = 0;

1507 
	`LayCË¬Lše
(
y
 - 
vp
->
v_yoff
, 
x1
 - vp->
v_xoff
, 
xxe
 - vp->v_xoff, 
bû
);

1508 
æay”
->
l_cvli¡
 = 
cvli¡
;

1509 
cv
->
c_Êext
 = 
cvÊext
;

1510 
æay”
 = 
Şdæay”
;

1514 
	`CË¬Lše
((
mlše
 *)0, 
y
, 
x1
, 
xxe
, 
bû
);

1516 
	}
}

1524 
	$Redi¥Ïy
(
cur_Úly
)

1525 
cur_Úly
;

1527 
	`ASSERT
(
di¥Ïy
);

1530 
	`In£¹Mode
(0);

1531 
	`ChªgeSüŞlRegiÚ
(0, 
D_height
 - 1);

1532 
	`Key·dMode
(0);

1533 
	`CursÜkeysMode
(0);

1534 
	`CursÜVisib™y
(0);

1535 
	`Mou£Mode
(0);

1536 
	`S‘R’d™iÚ
(&
mch¬_nuÎ
);

1537 
	`S‘Flow
(
FLOW_NOW
);

1539 
	`CË¬AÎ
();

1540 #ifdeà
RXVT_OSC


1541 
	`ReäeshX‹rmOSC
();

1543 ià(
cur_Úly
 > 0 && 
D_fÜe
)

1544 
	`ReäeshA»a
(0, 
D_fÜe
->
w_y
, 
D_width
 - 1, D_fore->w_y, 1);

1546 
	`ReäeshAÎ
(1);

1547 
	`ReäeshHStus
();

1548 
	`CV_CALL
(
D_fÜecv
, 
	`LayRe¡Üe
();
	`LayS‘CursÜ
());

1549 
	}
}

1552 
	$Redi¥ÏyDi¥Ïys
(
cur_Úly
)

1553 
cur_Úly
;

1555 
di¥Ïy
 *
Şddi¥Ïy
 = display;

1556 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

1557 
	`Redi¥Ïy
(
cur_Úly
);

1558 
di¥Ïy
 = 
Şddi¥Ïy
;

1559 
	}
}

1564 
	$SüŞlH
(
y
, 
xs
, 
xe
, 
n
, 
bû
, 
oml
)

1565 
y
, 
xs
, 
xe
, 
n
, 
bû
;

1566 
mlše
 *
oml
;

1568 
i
;

1570 ià(
n
 == 0)

1572 ià(
xe
 !ğ
D_width
 - 1)

1574 
	`ReäeshLše
(
y
, 
xs
, 
xe
, 0);

1578 
	`GÙoPos
(
xs
, 
y
);

1579 ià(
D_UT
)

1580 
	`S‘R’d™iÚ
(&
mch¬_nuÎ
);

1581 #ifdeà
COLOR


1582 ià(
D_BE
)

1583 
	`S‘BackCŞÜ
(
bû
);

1585 ià(
n
 > 0)

1587 ià(
n
 >ğ
xe
 - 
xs
 + 1)

1588 
n
 = 
xe
 - 
xs
 + 1;

1589 ià(
D_CDC
 && !(
n
 =ğ1 && 
D_DC
))

1590 
	`AddCSŒ2
(
D_CDC
, 
n
);

1591 ià(
D_DC
)

1593 
i
 = 
n
; i--; )

1594 
	`AddCSŒ
(
D_DC
);

1598 
	`ReäeshLše
(
y
, 
xs
, 
xe
, 0);

1605 ià(-
n
 >ğ
xe
 - 
xs
 + 1)

1606 
n
 = -(
xe
 - 
xs
 + 1);

1607 ià(!
D_š£¹
)

1609 ià(
D_CIC
 && !(
n
 =ğ-1 && 
D_IC
))

1610 
	`AddCSŒ2
(
D_CIC
, -
n
);

1611 ià(
D_IC
)

1613 
i
 = -
n
; i--; )

1614 
	`AddCSŒ
(
D_IC
);

1616 ià(
D_IM
)

1618 
	`In£¹Mode
(1);

1619 
	`S‘R’d™iÚ
(&
mch¬_nuÎ
);

1620 #ifdeà
COLOR


1621 
	`S‘BackCŞÜ
(
bû
);

1623 
i
 = -
n
; i--; )

1624 
	`INSERTCHAR
(' ');

1625 
bû
 = 0;

1630 
	`ReäeshLše
(
y
, 
xs
, 
xe
, 0);

1636 
	`S‘R’d™iÚ
(&
mch¬_nuÎ
);

1637 #ifdeà
COLOR


1638 
	`S‘BackCŞÜ
(
bû
);

1640 
i
 = -
n
; i--; )

1641 
	`INSERTCHAR
(' ');

1642 
bû
 = 0;

1645 ià(
bû
 && !
D_BE
)

1647 ià(
n
 > 0)

1648 
	`CË¬Lše
((
mlše
 *)0, 
y
, 
xe
 - 
n
 + 1, xe, 
bû
);

1650 
	`CË¬Lše
((
mlše
 *)0, 
y
, 
xs
, x - 
n
 - 1, 
bû
);

1652 ià(
D_Í_missšg
 && 
y
 =ğ
D_bÙ
)

1654 ià(
n
 > 0)

1655 
	`Wr™eLP
(
D_width
 - 1 - 
n
, 
y
);

1656 
D_Í_missšg
 = 0;

1658 
	}
}

1661 
	$SüŞlV
(
xs
, 
ys
, 
xe
, 
ye
, 
n
, 
bû
)

1662 
xs
, 
ys
, 
xe
, 
ye
, 
n
, 
bû
;

1664 
i
;

1665 
up
;

1666 
Şdtİ
, 
ŞdbÙ
;

1667 
®ok
, 
dlok
, 
®dlç¡”
;

1668 
missy
 = 0;

1670 
	`ASSERT
(
di¥Ïy
);

1671 ià(
n
 == 0)

1673 ià(
n
 >ğ
ye
 - 
ys
 + 1 || -n >= ye - ys + 1)

1675 
	`CË¬A»a
(
xs
, 
ys
, xs, 
xe
, xe, 
ye
, 
bû
, 0);

1678 ià(
xs
 > 
D_vpxmš
 || 
xe
 < 
D_vpxmax
)

1680 
	`ReäeshA»a
(
xs
, 
ys
, 
xe
, 
ye
, 0);

1684 ià(
D_Í_missšg
)

1686 ià(
D_bÙ
 > 
ye
 || D_bÙ < 
ys
)

1687 
missy
 = 
D_bÙ
;

1690 
missy
 = 
D_bÙ
 - 
n
;

1691 ià(
missy
 > 
ye
 || missy < 
ys
)

1692 
D_Í_missšg
 = 0;

1696 
up
 = 1;

1697 ià(
n
 < 0)

1699 
up
 = 0;

1700 
n
 = -n;

1702 ià(
n
 >ğ
ye
 - 
ys
 + 1)

1703 
n
 = 
ye
 - 
ys
 + 1;

1705 
Şdtİ
 = 
D_tİ
;

1706 
ŞdbÙ
 = 
D_bÙ
;

1707 ià(
ys
 < 
D_tİ
 || 
D_bÙ
 !ğ
ye
)

1708 
	`ChªgeSüŞlRegiÚ
(
ys
, 
ye
);

1709 
®ok
 = (
D_AL
 || 
D_CAL
 || (
ys
 >ğ
D_tİ
 && 
ye
 =ğ
D_bÙ
 && 
up
));

1710 
dlok
 = (
D_DL
 || 
D_CDL
 || (
ys
 >ğ
D_tİ
 && 
ye
 =ğ
D_bÙ
 && !
up
));

1711 ià(
D_tİ
 !ğ
ys
 && !(
®ok
 && 
dlok
))

1712 
	`ChªgeSüŞlRegiÚ
(
ys
, 
ye
);

1714 ià(
D_Í_missšg
 &&

1715 (
ŞdbÙ
 !ğ
D_bÙ
 ||

1716 (
ŞdbÙ
 =ğ
D_bÙ
 && 
up
 && 
D_tİ
 =ğ
ys
 && D_bÙ =ğ
ye
)))

1718 
	`Wr™eLP
(
D_width
 - 1, 
ŞdbÙ
);

1719 ià(
ŞdbÙ
 =ğ
D_bÙ
)

1721 ià(--
n
 == 0)

1726 ià(
bû
 && !
D_BE
)

1727 
	`CË¬Lše
((
mlše
 *)0, 
ye
, 
xs
, 
xe
, 
bû
);

1733 ià(
D_UT
)

1734 
	`S‘R’d™iÚ
(&
mch¬_nuÎ
);

1735 #ifdeà
COLOR


1736 ià(
D_BE
)

1737 
	`S‘BackCŞÜ
(
bû
);

1740 
®dlç¡”
 = (
n
 > 1 && 
ys
 >ğ
D_tİ
 && 
ye
 =ğ
D_bÙ
 && ((
up
 && 
D_CDL
è|| (!u°&& 
D_CAL
)));

1742 ià((
up
 || 
D_SR
è&& 
D_tİ
 =ğ
ys
 && 
D_bÙ
 =ğ
ye
 && !
®dlç¡”
)

1744 ià(
up
)

1746 
	`GÙoPos
(0, 
ye
);

1747 
i
 = 
n
; i-- > 0; )

1748 
	`AddCSŒ
(
D_NL
);

1752 
	`GÙoPos
(0, 
ys
);

1753 
i
 = 
n
; i-- > 0; )

1754 
	`AddCSŒ
(
D_SR
);

1757 ià(
®ok
 && 
dlok
)

1759 ià(
up
 || 
ye
 !ğ
D_bÙ
)

1761 
	`GÙoPos
(0, 
up
 ? 
ys
 : 
ye
+1-
n
);

1762 ià(
D_CDL
 && !(
n
 =ğ1 && 
D_DL
))

1763 
	`AddCSŒ2
(
D_CDL
, 
n
);

1765 
i
 = 
n
; i--; )

1766 
	`AddCSŒ
(
D_DL
);

1768 ià(!
up
 || 
ye
 !ğ
D_bÙ
)

1770 
	`GÙoPos
(0, 
up
 ? 
ye
+1-
n
 : 
ys
);

1771 ià(
D_CAL
 && !(
n
 =ğ1 && 
D_AL
))

1772 
	`AddCSŒ2
(
D_CAL
, 
n
);

1774 
i
 = 
n
; i--; )

1775 
	`AddCSŒ
(
D_AL
);

1780 
	`ReäeshA»a
(
xs
, 
ys
, 
xe
, 
ye
, 0);

1783 ià(
bû
 && !
D_BE
)

1785 ià(
up
)

1786 
	`CË¬A»a
(
xs
, 
ye
 - 
n
 + 1, xs, 
xe
, xe, ye, 
bû
, 0);

1788 
	`CË¬A»a
(
xs
, 
ys
, xs, 
xe
, xe, y + 
n
 - 1, 
bû
, 0);

1790 ià(
D_Í_missšg
 && 
missy
 !ğ
D_bÙ
)

1791 
	`Wr™eLP
(
D_width
 - 1, 
missy
);

1797 
	}
}

1800 
	$S‘A‰r
(
Ãw
)

1801 
Ãw
;

1803 
i
, 
j
, 
Şd
, 
typ
;

1805 ià(!
di¥Ïy
 || (
Şd
 = 
D_»nd
.
©Œ
è=ğ
Ãw
)

1807 #ifdeà
COLORS16


1808 
D_cŞ16chªge
 = (
Şd
 ^ 
Ãw
è& (
A_BFG
 | 
A_BBG
);

1809 
Ãw
 ^ğ
D_cŞ16chªge
;

1810 ià(
Şd
 =ğ
Ãw
)

1813 #ià
	`defšed
(
TERMINFO
è&& defšed(
USE_SGR
)

1814 ià(
D_SA
)

1816 *
	`¬m
();

1817 
	`S‘FÚt
(
ASCII
);

1818 
o¥“d
 = 
D_do¥“d
;

1819 
	`uts
(
	`¬m
(
D_SA
, 
Ãw
 & 
A_SO
,‚ew & 
A_US
,‚ew & 
A_RV
,‚ew & 
A_BL
,

1820 
Ãw
 & 
A_DI
,‚ew & 
A_BD
, 0 , 0 ,

1821 0), 1, 
DoAddCh¬
);

1822 
D_»nd
.
©Œ
 = 
Ãw
;

1823 
D_©yp
 = 0;

1824 #ifdeà
COLOR


1825 ià(
D_hascŞÜ
)

1826 
	`»nd_£tdeçuÉ
(&
D_»nd
);

1831 
D_»nd
.
©Œ
 = 
Ãw
;

1832 
typ
 = 
D_©yp
;

1833 ià((
Ãw
 & 
Şd
) != old)

1835 ià((
typ
 & 
ATYP_U
))

1836 
	`AddCSŒ
(
D_UE
);

1837 ià((
typ
 & 
ATYP_S
))

1838 
	`AddCSŒ
(
D_SE
);

1839 ià((
typ
 & 
ATYP_M
))

1841 
	`AddCSŒ
(
D_ME
);

1842 #ifdeà
COLOR


1844 ià(
D_hascŞÜ
)

1845 
	`»nd_£tdeçuÉ
(&
D_»nd
);

1847 #ifdeà
FONT


1848 ià(!
D_CG0
)

1851 
D_»nd
.
fÚt
 = 0;

1852 #ifdeà
ENCODINGS


1853 
D_»®fÚt
 = 0;

1858 
Şd
 = 0;

1859 
typ
 = 0;

1861 
Şd
 ^ğ
Ãw
;

1862 
i
 = 0, 
j
 = 1; 
Şd
 && i < 
NATTR
; i++, j <<= 1)

1864 ià((
Şd
 & 
j
) == 0)

1866 
Şd
 ^ğ
j
;

1867 ià(
D_©Œb
[
i
])

1869 
	`AddCSŒ
(
D_©Œb
[
i
]);

1870 
typ
 |ğ
D_©Œtyp
[
i
];

1873 
D_©yp
 = 
typ
;

1874 
	}
}

1876 #ifdeà
FONT


1878 
	$S‘FÚt
(
Ãw
)

1879 
Ãw
;

1881 
Şd
 = 
D_»nd
.
fÚt
;

1882 ià(!
di¥Ïy
 || 
Şd
 =ğ
Ãw
)

1884 
D_»nd
.
fÚt
 = 
Ãw
;

1885 #ifdeà
ENCODINGS


1886 ià(
D_’codšg
 && 
	`CªEncodeFÚt
(D_’codšg, 
Ãw
))

1888 ià(
Ãw
 =ğ
D_»®fÚt
)

1890 
D_»®fÚt
 = 
Ãw
;

1892 ià(
D_xbË
 && D_xbË[()()
Ãw
] &&

1893 
D_xbË
[()()
Ãw
][256])

1895 
	`AddCSŒ
(
D_xbË
[()()
Ãw
][256]);

1899 ià(!
D_CG0
 && 
Ãw
 != '0')

1901 
Ãw
 = 
ASCII
;

1902 ià(
Şd
 =ğ
Ãw
)

1906 ià(
Ãw
 =ğ
ASCII
)

1907 
	`AddCSŒ
(
D_CE0
);

1908 #ifdeà
DW_CHARS


1909 ià(
Ãw
 < ' ')

1911 
	`AddSŒ
("\033$");

1912 ià(
Ãw
 > 2)

1913 
	`AddCh¬
('(');

1914 
	`AddCh¬
(
Ãw
 + '@');

1918 
	`AddCSŒ2
(
D_CS0
, 
Ãw
);

1919 
	}
}

1922 #ifdeà
COLOR


1925 
	$cŞÜ256to16
(
jj
)

1926 
jj
;

1928 
mš
, 
max
;

1929 
r
, 
g
, 
b
;

1931 ià(
jj
 >= 232)

1933 
jj
 = (jj - 232) / 6;

1934 
jj
 = (jj & 1) << 3 | (jj & 2 ? 7 : 0);

1936 ià(
jj
 >= 16)

1938 
jj
 -= 16;

1939 
r
 = 
jj
 / 36;

1940 
g
 = (
jj
 / 6) % 6;

1941 
b
 = 
jj
 % 6;

1942 
mš
 = 
r
 < 
g
 ? (¸< 
b
 ?„ : b) : (g < b ? g : b);

1943 
max
 = 
r
 > 
g
 ? (¸> 
b
 ?„ : b) : (g > b ? g : b);

1944 ià(
mš
 =ğ
max
)

1945 
jj
 = ((
max
 + 1) & 2) << 2 | ((max + 1) & 4 ? 7 : 0);

1947 
jj
 = (
b
 - 
mš
è/ (
max
 - mšè<< 2 | (
g
 - mšè/ (max - mšè<< 1 | (
r
 -

1948 
mš
è/ (
max
 - min) | (max > 3 ? 8 : 0);

1950  
jj
;

1951 
	}
}

1953 #ifdeà
COLORS256


1955 
	$cŞÜ256to88
(
jj
)

1956 
jj
;

1958 
r
, 
g
, 
b
;

1960 ià(
jj
 >= 232)

1961  (
jj
 - 232) / 3 + 80;

1962 ià(
jj
 >= 16)

1964 
jj
 -= 16;

1965 
r
 = 
jj
 / 36;

1966 
g
 = (
jj
 / 6) % 6;

1967 
b
 = 
jj
 % 6;

1968  ((
r
 + 1è/ 2è* 16 + ((
g
 + 1è/ 2è* 4 + ((
b
 + 1) / 2) + 16;

1970  
jj
;

1971 
	}
}

1975 
	$S‘CŞÜ
(
f
, 
b
)

1976 
f
, 
b
;

1978 
of
, 
ob
;

1979 
sá¿ns
[8] = {0,4,2,6,1,5,3,7};

1981 ià(!
di¥Ïy
)

1984 
of
 = 
	`»nd_g‘fg
(&
D_»nd
);

1985 
ob
 = 
	`»nd_g‘bg
(&
D_»nd
);

1987 #ifdeà
COLORS16


1989 ià(
f
 == 0x100)

1990 
f
 = 0;

1991 ià(
b
 == 0x100)

1992 
b
 = 0;

1994 
	`debug2
("S‘CŞÜ %d %d", 
	`cŞi2e
(
of
), cŞi2e(
ob
));

1995 
	`debug2
(" -> %d %d\n", 
	`cŞi2e
(
f
), cŞi2e(
b
));

1996 
	`debug2
("(%d %d", 
of
, 
ob
);

1997 
	`debug2
(" -> %d %d)\n", 
f
, 
b
);

1999 ià(!
D_CAX
 && 
D_hascŞÜ
 && ((
f
 =ğ0 && f !ğ
of
è|| (
b
 =ğ0 && b !ğ
ob
)))

2001 ià(
D_OP
)

2002 
	`AddCSŒ
(
D_OP
);

2005 
ß‰r
;

2006 
ß‰r
 = 
D_»nd
.
©Œ
;

2007 
	`AddCSŒ
(
D_ME
 ? D_ME : "\033[m");

2008 #ifdeà
FONT


2009 ià(
D_ME
 && !
D_CG0
)

2012 
D_»nd
.
fÚt
 = 0;

2013 #ifdeà
ENCODINGS


2014 
D_»®fÚt
 = 0;

2018 
D_©yp
 = 0;

2019 
D_»nd
.
©Œ
 = 0;

2020 
	`S‘A‰r
(
ß‰r
);

2022 
of
 = 
ob
 = 0;

2024 
	`»nd_£tfg
(&
D_»nd
, 
f
);

2025 
	`»nd_£tbg
(&
D_»nd
, 
b
);

2026 #ifdeà
COLORS16


2027 
D_cŞ16chªge
 = 0;

2029 ià(!
D_hascŞÜ
)

2031 
f
 = f ? 
	`cŞi2e
(f) : -1;

2032 
b
 = b ? 
	`cŞi2e
(b) : -1;

2033 
of
 = oà? 
	`cŞi2e
(of) : -1;

2034 
ob
 = ob ? 
	`cŞi2e
(ob) : -1;

2035 #ifdeà
COLORS256


2036 ià(
f
 !ğ
of
 && f > 15 && 
D_CCO
 != 256)

2037 
f
 = 
D_CCO
 =ğ88 && 
D_CAF
 ? 
	`cŞÜ256to88
(fè: 
	`cŞÜ256to16
(f);

2038 ià(
f
 !ğ
of
 && f > 15 && 
D_CAF
)

2040 
	`AddCSŒ2
(
D_CAF
, 
f
);

2041 
of
 = 
f
;

2043 ià(
b
 !ğ
ob
 && b > 15 && 
D_CCO
 != 256)

2044 
b
 = 
D_CCO
 =ğ88 && 
D_CAB
 ? 
	`cŞÜ256to88
(bè: 
	`cŞÜ256to16
(b);

2045 ià(
b
 !ğ
ob
 && b > 15 && 
D_CAB
)

2047 
	`AddCSŒ2
(
D_CAB
, 
b
);

2048 
ob
 = 
b
;

2051 ià(
f
 !ğ
of
 && f != (of | 8))

2053 ià(
f
 == -1)

2054 
	`AddCSŒ
("\033[39m");

2055 ià(
D_CAF
)

2056 
	`AddCSŒ2
(
D_CAF
, 
f
 & 7);

2057 ià(
D_CSF
)

2058 
	`AddCSŒ2
(
D_CSF
, 
sá¿ns
[
f
 & 7]);

2060 ià(
b
 !ğ
ob
 && b != (ob | 8))

2062 ià(
b
 == -1)

2063 
	`AddCSŒ
("\033[49m");

2064 ià(
D_CAB
)

2065 
	`AddCSŒ2
(
D_CAB
, 
b
 & 7);

2066 ià(
D_CSB
)

2067 
	`AddCSŒ2
(
D_CSB
, 
sá¿ns
[
b
 & 7]);

2069 #ifdeà
COLORS16


2070 ià(
f
 !ğ
of
 && 
D_CXT
 && (f & 8) != 0 && f != -1)

2072 #ifdeà
TERMINFO


2073 
	`AddCSŒ2
("\033[9%p1%dm", 
f
 & 7);

2075 
	`AddCSŒ2
("\033[9%dm", 
f
 & 7);

2078 ià(
b
 !ğ
ob
 && 
D_CXT
 && (b & 8) != 0 && b != -1)

2080 #ifdeà
TERMINFO


2081 
	`AddCSŒ2
("\033[10%p1%dm", 
b
 & 7);

2083 
	`AddCSŒ2
("\033[10%dm", 
b
 & 7);

2087 
	}
}

2090 
	$S‘BackCŞÜ
(
Ãw
)

2091 
Ãw
;

2093 ià(!
di¥Ïy
)

2095 
	`S‘CŞÜ
(
	`»nd_g‘fg
(&
D_»nd
), 
Ãw
);

2096 
	}
}

2100 
	$S‘R’d™iÚ
(
mc
)

2101 
mch¬
 *
mc
;

2103 ià(!
di¥Ïy
)

2105 ià(
Ç‰r2cŞÜ
 && 
D_hascŞÜ
 && (
mc
->
©Œ
 &‚attr2color) != 0)

2107 
mch¬
 
mmc
;

2108 
i
;

2109 
mmc
 = *
mc
;

2110 
i
 = 0; i < 8; i++)

2111 ià(
©Œ2cŞÜ
[
i
] && (
mc
->
©Œ
 & (1 << i)) != 0)

2113 ià(
mc
->
cŞÜ
 =ğ0 && 
©Œ2cŞÜ
[
i
][3])

2114 
	`AµlyA‰rCŞÜ
(
©Œ2cŞÜ
[
i
][3], &
mmc
);

2115 ià((
mc
->
cŞÜ
 & 0x0fè=ğ0 && 
©Œ2cŞÜ
[
i
][2])

2116 
	`AµlyA‰rCŞÜ
(
©Œ2cŞÜ
[
i
][2], &
mmc
);

2117 ià((
mc
->
cŞÜ
 & 0xf0è=ğ0 && 
©Œ2cŞÜ
[
i
][1])

2118 
	`AµlyA‰rCŞÜ
(
©Œ2cŞÜ
[
i
][1], &
mmc
);

2120 
	`AµlyA‰rCŞÜ
(
©Œ2cŞÜ
[
i
][0], &
mmc
);

2122 
mc
 = &
mmc
;

2123 
	`debug2
("S‘R’d™iÚ: m­³dØ%02x %02x\n", ()
mc
->
©Œ
, 0x99 - ()mc->
cŞÜ
);

2125 ià(
D_hascŞÜ
 && 
D_CC8
 && (
mc
->
©Œ
 & (
A_BFG
|
A_BBG
)))

2127 
a
 = 
mc
->
©Œ
;

2128 ià((
mc
->
©Œ
 & 
A_BFG
è&& 
D_MD
)

2129 
a
 |ğ
A_BD
;

2130 ià((
mc
->
©Œ
 & 
A_BBG
è&& 
D_MB
)

2131 
a
 |ğ
A_BL
;

2132 ià(
D_»nd
.
©Œ
 !ğ
a
)

2133 
	`S‘A‰r
(
a
);

2135 ià(
D_»nd
.
©Œ
 !ğ
mc
->attr)

2136 
	`S‘A‰r
(
mc
->
©Œ
);

2137 #ifdeà
COLOR


2138 ià(
D_»nd
.
cŞÜ
 !ğ
mc
->color

2139 #ifdeà
COLORS256


2140 || 
D_»nd
.
cŞÜx
 !ğ
mc
->colorx

2142 #ifdeà
COLORS16


2143 || 
D_cŞ16chªge


2146 
	`S‘CŞÜ
(
	`»nd_g‘fg
(
mc
), 
	`»nd_g‘bg
(mc));

2148 #ifdeà
FONT


2149 ià(
D_»nd
.
fÚt
 !ğ
mc
->font)

2150 
	`S‘FÚt
(
mc
->
fÚt
);

2152 
	}
}

2155 
	$S‘R’d™iÚMlše
(
ml
, 
x
)

2156 
mlše
 *
ml
;

2157 
x
;

2159 ià(!
di¥Ïy
)

2161 ià(
Ç‰r2cŞÜ
 && 
D_hascŞÜ
 && (
ml
->
©Œ
[
x
] &‚attr2color) != 0)

2163 
mch¬
 
mc
;

2164 
	`cİy_mlše2mch¬
(&
mc
, 
ml
, 
x
);

2165 
	`S‘R’d™iÚ
(&
mc
);

2168 ià(
D_hascŞÜ
 && 
D_CC8
 && (
ml
->
©Œ
[
x
] & (
A_BFG
|
A_BBG
)))

2170 
a
 = 
ml
->
©Œ
[
x
];

2171 ià((
ml
->
©Œ
[
x
] & 
A_BFG
è&& 
D_MD
)

2172 
a
 |ğ
A_BD
;

2173 ià((
ml
->
©Œ
[
x
] & 
A_BBG
è&& 
D_MB
)

2174 
a
 |ğ
A_BL
;

2175 ià(
D_»nd
.
©Œ
 !ğ
a
)

2176 
	`S‘A‰r
(
a
);

2178 ià(
D_»nd
.
©Œ
 !ğ
ml
->©Œ[
x
])

2179 
	`S‘A‰r
(
ml
->
©Œ
[
x
]);

2180 #ifdeà
COLOR


2181 ià(
D_»nd
.
cŞÜ
 !ğ
ml
->cŞÜ[
x
]

2182 #ifdeà
COLORS256


2183 || 
D_»nd
.
cŞÜx
 !ğ
ml
->cŞÜx[
x
]

2185 #ifdeà
COLORS16


2186 || 
D_cŞ16chªge


2190 
mch¬
 
mc
;

2191 
	`cİy_mlše2mch¬
(&
mc
, 
ml
, 
x
);

2192 
	`S‘CŞÜ
(
	`»nd_g‘fg
(&
mc
), 
	`»nd_g‘bg
(&mc));

2195 #ifdeà
FONT


2196 ià(
D_»nd
.
fÚt
 !ğ
ml
->fÚt[
x
])

2197 
	`S‘FÚt
(
ml
->
fÚt
[
x
]);

2199 
	}
}

2202 
	$MakeStus
(
msg
)

2203 *
msg
;

2205 *
s
, *
t
;

2206 
max
;

2208 ià(!
di¥Ïy
)

2211 ià(
D_blocked
)

2213 ià(!
D_tcš™ed
)

2215 
	`debug
("tc‚ot inited, just writing msg\n");

2216 ià(
D_´oûssšputd©a
)

2218 
	`AddSŒ
(
msg
);

2219 
	`AddSŒ
("\r\n");

2220 
	`Flush
();

2223 ià(!
u£_h¬d¡©us
 || !
D_HS
)

2225 
max
 = 
D_width
;

2226 ià(
D_CLP
 == 0)

2227 
max
--;

2230 
max
 = 
D_WS
 > 0 ? D_WS : (
D_width
 - !
D_CLP
);

2231 ià(
D_¡©us
)

2234 ià(
	`¡rcmp
(
msg
, 
D_¡©us_Ï¡msg
) == 0)

2236 
	`debug
("same message - increaseimeout");

2237 
	`S‘Timeout
(&
D_¡©u£v
, 
MsgWa™
);

2240 ià(!
D_¡©us_b–l
)

2242 
timev®
 
now
;

2243 
ti
;

2244 
	`g‘timeofday
(&
now
, 
NULL
);

2245 
ti
 = (
now
.
tv_£c
 - 
D_¡©us_time
.tv_£cè* 1000 + (now.
tv_u£c
 - D_status_time.tv_usec) / 1000;

2246 ià(
ti
 < 
MsgMšWa™
)

2247 
	`Di¥ÏySË•1000
(
MsgMšWa™
 - 
ti
, 0);

2249 
	`RemoveStus
();

2251 
s
 = 
t
 = 
msg
; * && - msg < 
max
; ++s)

2252 ià(*
s
 =ğ
BELL
)

2253 
	`AddCSŒ
(
D_BL
);

2254 ià(()*
s
 >= ' ' && *s != 0177)

2255 *
t
++ = *
s
;

2256 *
t
 = '\0';

2257 ià(
t
 =ğ
msg
)

2259 ià(
t
 - 
msg
 >ğ
D_¡©us_buæ’
)

2261 *
buf
;

2262 ià(
D_¡©us_Ï¡msg
)

2263 
buf
 = 
	`»®loc
(
D_¡©us_Ï¡msg
, 
t
 - 
msg
 + 1);

2265 
buf
 = 
	`m®loc
(
t
 - 
msg
 + 1);

2266 ià(
buf
)

2268 
D_¡©us_Ï¡msg
 = 
buf
;

2269 
D_¡©us_buæ’
 = 
t
 - 
msg
 + 1;

2272 ià(
t
 - 
msg
 < 
D_¡©us_buæ’
)

2273 
	`¡rıy
(
D_¡©us_Ï¡msg
, 
msg
);

2274 
D_¡©us_Ën
 = 
t
 - 
msg
;

2275 
D_¡©us_Ï¡x
 = 
D_x
;

2276 
D_¡©us_Ï¡y
 = 
D_y
;

2277 ià(!
u£_h¬d¡©us
 || 
D_has_h¡©us
 =ğ
HSTATUS_IGNORE
 || D_has_h¡©u =ğ
HSTATUS_MESSAGE
)

2279 
D_¡©us
 = 
STATUS_ON_WIN
;

2280 
	`debug1
("usšg STATLINE %d\n", 
STATLINE
);

2281 
	`GÙoPos
(0, 
STATLINE
);

2282 
	`S‘R’d™iÚ
(&
mch¬_so
);

2283 
	`In£¹Mode
(0);

2284 
	`AddSŒ
(
msg
);

2285 ià(
D_¡©us_Ën
 < 
max
)

2288 
D_¡©us_Ën
++;

2289 
	`S‘R’d™iÚ
(&
mch¬_nuÎ
);

2290 
	`AddCh¬
(' ');

2291 ià(
D_¡©us_Ën
 < 
max
)

2293 
D_¡©us_Ën
++;

2294 
	`AddCh¬
(' ');

2295 
	`AddCh¬
('\b');

2297 
	`AddCh¬
('\b');

2299 
D_x
 = -1;

2303 
D_¡©us
 = 
STATUS_ON_HS
;

2304 
	`ShowHStus
(
msg
);

2306 
	`Flush
();

2307 ià(!
di¥Ïy
)

2309 ià(
D_¡©us
 =ğ
STATUS_ON_WIN
)

2311 
di¥Ïy
 *
Şddi¥Ïy
 = display;

2312 
Ïy”
 *
Şdæay”
 = 
æay”
;

2314 
	`ASSERT
(
D_obufä“
 =ğ
D_obuæ’
);

2316 
D_¡©us
 = 0;

2317 
	`GÙoPos
(0, 
STATLINE
);

2318 
	`ReäeshLše
(
STATLINE
, 0, 
D_¡©us_Ën
 - 1, 0);

2319 
	`GÙoPos
(
D_¡©us_Ï¡x
, 
D_¡©us_Ï¡y
);

2320 
æay”
 = 
D_fÜecv
 ? D_fÜecv->
c_Ïy”
 : 0;

2321 ià(
æay”
)

2322 
	`LayS‘CursÜ
();

2323 
di¥Ïy
 = 
Şddi¥Ïy
;

2324 
æay”
 = 
Şdæay”
;

2325 
D_¡©us_obuæ’
 = 
D_obuæ’
;

2326 
D_¡©us_obufä“
 = 
D_obufä“
;

2327 
D_obufä“
 = 
D_obuæ’
 = 0;

2328 
D_¡©us
 = 
STATUS_ON_WIN
;

2330 
	`g‘timeofday
(&
D_¡©us_time
, 
NULL
);

2331 
	`S‘Timeout
(&
D_¡©u£v
, 
MsgWa™
);

2332 
	`ev’q
(&
D_¡©u£v
);

2333 #ifdeà
HAVE_BRAILLE


2334 
	`ReäeshB¿Ë
();

2336 
	}
}

2339 
	$RemoveStus
()

2341 
di¥Ïy
 *
Şddi¥Ïy
;

2342 
Ïy”
 *
Şdæay”
;

2343 
wh”e
;

2345 ià(!
di¥Ïy
)

2347 ià(!(
wh”e
 = 
D_¡©us
))

2350 
	`debug
("RemoveStatus\n");

2351 ià(
D_¡©us_obufä“
 >= 0)

2353 
D_obuæ’
 = 
D_¡©us_obuæ’
;

2354 
D_obufä“
 = 
D_¡©us_obufä“
;

2355 
D_¡©us_obufä“
 = -1;

2356 
D_¡©us
 = 0;

2357 
D_¡©us_b–l
 = 0;

2358 
	`evdeq
(&
D_¡©u£v
);

2361 
D_¡©us
 = 0;

2362 
D_¡©us_b–l
 = 0;

2363 
	`evdeq
(&
D_¡©u£v
);

2364 
Şddi¥Ïy
 = 
di¥Ïy
;

2365 
Şdæay”
 = 
æay”
;

2366 ià(
wh”e
 =ğ
STATUS_ON_WIN
)

2368 
	`GÙoPos
(0, 
STATLINE
);

2369 
	`ReäeshLše
(
STATLINE
, 0, 
D_¡©us_Ën
 - 1, 0);

2370 
	`GÙoPos
(
D_¡©us_Ï¡x
, 
D_¡©us_Ï¡y
);

2373 
	`ReäeshHStus
();

2374 
æay”
 = 
D_fÜecv
 ? D_fÜecv->
c_Ïy”
 : 0;

2375 ià(
æay”
)

2376 
	`LayS‘CursÜ
();

2377 
di¥Ïy
 = 
Şddi¥Ïy
;

2378 
æay”
 = 
Şdæay”
;

2379 
	}
}

2383 
	$ShowHStus
(
¡r
)

2384 *
¡r
;

2386 
l
, 
i
, 
ox
, 
oy
, 
max
;

2388 ià(
D_¡©us
 =ğ
STATUS_ON_WIN
 && 
D_has_h¡©us
 =ğ
HSTATUS_LASTLINE
 && 
STATLINE
 =ğ
D_height
-1)

2390 ià(
D_blocked
)

2393 ià(
D_HS
 && 
D_has_h¡©us
 =ğ
HSTATUS_HS
)

2395 ià(!
D_h¡©us
 && (
¡r
 == 0 || *str == 0))

2397 
	`debug
("ShowHStatus: using HS\n");

2398 
	`S‘R’d™iÚ
(&
mch¬_nuÎ
);

2399 
	`In£¹Mode
(0);

2400 ià(
D_h¡©us
)

2401 
	`AddCSŒ
(
D_DS
);

2402 
D_h¡©us
 = 0;

2403 ià(
¡r
 == 0 || *str == 0)

2405 
	`AddCSŒ2
(
D_TS
, 0);

2406 
max
 = 
D_WS
 > 0 ? D_WS : (
D_width
 - !
D_CLP
);

2407 ià(()
	`¡¾’
(
¡r
è> 
max
)

2408 
	`AddSŒn
(
¡r
, 
max
);

2410 
	`AddSŒ
(
¡r
);

2411 
	`AddCSŒ
(
D_FS
);

2412 
D_h¡©us
 = 1;

2414 ià(
D_has_h¡©us
 =ğ
HSTATUS_LASTLINE
)

2416 
	`debug
("ShowHStatus: using†ast†ine\n");

2417 
ox
 = 
D_x
;

2418 
oy
 = 
D_y
;

2419 
¡r
 = str ? str : "";

2420 
l
 = 
	`¡¾’
(
¡r
);

2421 ià(
l
 > 
D_width
)

2422 
l
 = 
D_width
;

2423 
	`GÙoPos
(0, 
D_height
 - 1);

2424 
	`S‘R’d™iÚ
(
ÿ±iÚ®ways
 || 
D_cvli¡
 =ğ0 || D_cvli¡->
c_Ãxt
 ? &
mch¬_nuÎ
: &
mch¬_so
);

2425 ià(!
	`PutWšMsg
(
¡r
, 0, 
l
))

2426 
i
 = 0; i < 
l
; i++)

2427 
	`PUTCHARLP
(
¡r
[
i
]);

2428 ià(!
ÿ±iÚ®ways
 && 
D_cvli¡
 && !D_cvli¡->
c_Ãxt
)

2429 
l
++ < 
D_width
)

2430 
	`PUTCHARLP
(' ');

2431 ià(
l
 < 
D_width
)

2432 
	`CË¬A»a
(
l
, 
D_height
 - 1,†, 
D_width
 - 1, D_width - 1, D_height - 1, 0, 0);

2433 ià(
ox
 !ğ-1 && 
oy
 != -1)

2434 
	`GÙoPos
(
ox
, 
oy
);

2435 
D_h¡©us
 = *
¡r
 ? 1 : 0;

2436 
	`S‘R’d™iÚ
(&
mch¬_nuÎ
);

2438 ià(
¡r
 && *¡¸&& 
D_has_h¡©us
 =ğ
HSTATUS_MESSAGE
)

2440 
	`debug
("ShowHStatus: using message\n");

2441 
	`Msg
(0, "%s", 
¡r
);

2443 
	}
}

2450 
	$ReäeshHStus
()

2452 *
buf
;

2454 
	`evdeq
(&
D_h¡©u£v
);

2455 ià(
D_¡©us
 =ğ
STATUS_ON_HS
)

2457 
buf
 = 
	`MakeWšMsgEv
(
h¡©us¡ršg
, 
D_fÜe
, '%', (
D_HS
 && 
D_has_h¡©us
 =ğ
HSTATUS_HS
 && 
D_WS
 > 0è? D_WS : 
D_width
 - !
D_CLP
, &
D_h¡©u£v
, 0);

2458 ià(
buf
 && *buf)

2460 
	`ShowHStus
(
buf
);

2461 ià(
D_has_h¡©us
 !ğ
HSTATUS_IGNORE
 && 
D_h¡©u£v
.
timeout
.
tv_£c
)

2462 
	`ev’q
(&
D_h¡©u£v
);

2465 
	`ShowHStus
((*)0);

2466 
	}
}

2474 
	$ReäeshAÎ
(
isbÏnk
)

2475 
isbÏnk
;

2477 
ÿnvas
 *
cv
;

2479 
	`ASSERT
(
di¥Ïy
);

2480 
	`debug
("Signalling full„efresh!\n");

2481 
cv
 = 
D_cvli¡
; cv; cv = cv->
c_Ãxt
)

2483 
	`CV_CALL
(
cv
, 
	`LayRedi¥ÏyLše
(-1, -1, -1, 
isbÏnk
));

2484 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

2486 
	`ReäeshA»a
(0, 0, 
D_width
 - 1, 
D_height
 - 1, 
isbÏnk
);

2487 
	}
}

2490 
	$ReäeshA»a
(
xs
, 
ys
, 
xe
, 
ye
, 
isbÏnk
)

2491 
xs
, 
ys
, 
xe
, 
ye
, 
isbÏnk
;

2493 
y
;

2494 
	`ASSERT
(
di¥Ïy
);

2495 
	`debug2
("Reäesh A»a: %d,%d", 
xs
, 
ys
);

2496 
	`debug3
(" - %d,%d (isbÏnk=%d)\n", 
xe
, 
ye
, 
isbÏnk
);

2497 ià(!
isbÏnk
 && 
xs
 =ğ0 && 
xe
 =ğ
D_width
 - 1 && 
ye
 =ğ
D_height
 - 1 && (
ys
 =ğ0 || 
D_CD
))

2499 
	`CË¬A»a
(
xs
, 
ys
, xs, 
xe
, xe, 
ye
, 0, 0);

2500 
isbÏnk
 = 1;

2502 
y
 = 
ys
; y <ğ
ye
; y++)

2503 
	`ReäeshLše
(
y
, 
xs
, 
xe
, 
isbÏnk
);

2504 
	}
}

2507 
	$ReäeshLše
(
y
, 
äom
, 
to
, 
isbÏnk
)

2508 
y
, 
äom
, 
to
, 
isbÏnk
;

2510 
v›wpÜt
 *
vp
, *
lvp
;

2511 
ÿnvas
 *
cv
, *
lcv
, *
cvli¡
, *
cvÊext
;

2512 
Ïy”
 *
Şdæay”
;

2513 
xx
, 
yy
;

2514 *
buf
;

2515 
wš
 *
p
;

2517 
	`ASSERT
(
di¥Ïy
);

2519 
	`debug2
("ReäeshLš%d %d", 
y
, 
äom
);

2520 
	`debug2
(" %d %d\n", 
to
, 
isbÏnk
);

2522 ià(
D_¡©us
 =ğ
STATUS_ON_WIN
 && 
y
 =ğ
STATLINE
)

2525 ià(
isbÏnk
 =ğ0 && 
D_CE
 && 
to
 =ğ
D_width
 - 1 && 
äom
 <o)

2527 
	`GÙoPos
(
äom
, 
y
);

2528 ià(
D_UT
 || 
D_BE
)

2529 
	`S‘R’d™iÚ
(&
mch¬_nuÎ
);

2530 
	`AddCSŒ
(
D_CE
);

2531 
isbÏnk
 = 1;

2533 
äom
 <ğ
to
)

2535 
lcv
 = 0;

2536 
lvp
 = 0;

2537 
cv
 = 
di¥Ïy
->
d_cvli¡
; cv; cv = cv->
c_Ãxt
)

2539 ià(
y
 < 
cv
->
c_ys
 || y > cv->
c_ye
 || 
to
 < cv->
c_xs
 || 
äom
 > cv->
c_xe
)

2541 
	`debug2
("- cªva h™: %d %d", 
cv
->
c_xs
, cv->
c_ys
);

2542 
	`debug2
(" %d %d\n", 
cv
->
c_xe
, cv->
c_ye
);

2543 
vp
 = 
cv
->
c_v¶i¡
; vp; v°ğvp->
v_Ãxt
)

2545 
	`debug2
(" - vp: %d %d", 
vp
->
v_xs
, vp->
v_ys
);

2546 
	`debug2
(" %d %d\n", 
vp
->
v_xe
, vp->
v_ye
);

2548 ià(
y
 >ğ
vp
->
v_ys
 && y <ğvp->
v_ye
 && 
äom
 <ğvp->
v_xe
 && 
to
 >ğvp->
v_xs
 && (
lvp
 == 0 ||†vp->v_xs > vp->v_xs))

2550 
lcv
 = 
cv
;

2551 
lvp
 = 
vp
;

2555 ià(
lvp
 == 0)

2557 ià(
äom
 < 
lvp
->
v_xs
)

2559 ià(!
isbÏnk
)

2560 
	`Di¥ÏyLše
(&
mlše_nuÎ
, &
mlše_bÏnk
, 
y
, 
äom
, 
lvp
->
v_xs
 - 1);

2561 
äom
 = 
lvp
->
v_xs
;

2565 
yy
 = 
y
 - 
lvp
->
v_yoff
;

2566 
xx
 = 
to
 < 
lvp
->
v_xe
 ?o :†vp->v_xe;

2568 ià(
lcv
->
c_Ïy”
 && 
yy
 =ğlcv->c_Ïy”->
l_height
)

2570 
	`GÙoPos
(
äom
, 
y
);

2571 
	`S‘R’d™iÚ
(&
mch¬_bÏnk
);

2572 
äom
 <ğ
lvp
->
v_xe
 && from -†vp->
v_xoff
 < 
lcv
->
c_Ïy”
->
l_width
)

2574 
	`PUTCHARLP
('-');

2575 
äom
++;

2577 ià(
äom
 >ğ
lvp
->
v_xe
 + 1)

2580 ià(
lcv
->
c_Ïy”
 =ğ0 || 
yy
 >ğlcv->c_Ïy”->
l_height
 || 
äom
 - 
lvp
->
v_xoff
 >ğlcv->c_Ïy”->
l_width
)

2582 ià(!
isbÏnk
)

2583 
	`Di¥ÏyLše
(&
mlše_nuÎ
, &
mlše_bÏnk
, 
y
, 
äom
, 
lvp
->
v_xe
);

2584 
äom
 = 
lvp
->
v_xe
 + 1;

2588 ià(
xx
 - 
lvp
->
v_xoff
 >ğ
lcv
->
c_Ïy”
->
l_width
)

2589 
xx
 = 
lcv
->
c_Ïy”
->
l_width
 + 
lvp
->
v_xoff
 - 1;

2590 
Şdæay”
 = 
æay”
;

2591 
æay”
 = 
lcv
->
c_Ïy”
;

2592 
cvli¡
 = 
æay”
->
l_cvli¡
;

2593 
cvÊext
 = 
lcv
->
c_Êext
;

2594 
æay”
->
l_cvli¡
 = 
lcv
;

2595 
lcv
->
c_Êext
 = 0;

2596 
	`LayRedi¥ÏyLše
(
yy
, 
äom
 - 
lvp
->
v_xoff
, 
xx
 -†vp->v_xoff, 
isbÏnk
);

2597 
æay”
->
l_cvli¡
 = 
cvli¡
;

2598 
lcv
->
c_Êext
 = 
cvÊext
;

2599 
æay”
 = 
Şdæay”
;

2601 
äom
 = 
xx
 + 1;

2603 ià(
äom
 > 
to
)

2606 ià(
y
 =ğ
D_height
 - 1 && 
D_has_h¡©us
 =ğ
HSTATUS_LASTLINE
)

2608 
	`ReäeshHStus
();

2612 
cv
 = 
di¥Ïy
->
d_cvli¡
; cv; cv = cv->
c_Ãxt
)

2613 ià(
y
 =ğ
cv
->
c_ye
 + 1)

2615 ià(
cv
 == 0)

2617 ià(!
isbÏnk
)

2618 
	`Di¥ÏyLše
(&
mlše_nuÎ
, &
mlše_bÏnk
, 
y
, 
äom
, 
to
);

2622 
p
 = 
	`Lay”2Wšdow
(
cv
->
c_Ïy”
);

2623 
buf
 = 
	`MakeWšMsgEv
(
ÿ±iÚ¡ršg
, 
p
, '%', 
D_width
 - !
D_CLP
, &
cv
->
c_ÿ±ev
, 0);

2624 ià(
cv
->
c_ÿ±ev
.
timeout
.
tv_£c
)

2625 
	`ev’q
(&
cv
->
c_ÿ±ev
);

2626 
xx
 = 
	`¡¾’
(
buf
);

2627 
	`GÙoPos
(
äom
, 
y
);

2628 
	`S‘R’d™iÚ
(&
mch¬_so
);

2629 ià(
	`PutWšMsg
(
buf
, 
äom
, 
to
 + 1))

2630 
äom
 = 
xx
 > 
to
 + 1 ?o + 1 : xx;

2633 
äom
 <ğ
to
 && from < 
xx
)

2635 
	`PUTCHARLP
(
buf
[
äom
]);

2636 
äom
++;

2639 
äom
++ <ğ
to
)

2640 
	`PUTCHARLP
(' ');

2641 
	}
}

2649 
	$Wr™eLP
(
x2
, 
y2
)

2650 
x2
, 
y2
;

2652 
mch¬
 
Şd»nd
;

2654 
	`ASSERT
(
di¥Ïy
);

2655 
	`ASSERT
(
D_Í_missšg
);

2656 
Şd»nd
 = 
D_»nd
;

2657 
	`debug2
("Wr™eLP(%d,%d)\n", 
x2
, 
y2
);

2658 #ifdeà
DW_CHARS


2659 ià(
D_Ích¬
.
mbcs
)

2661 ià(
x2
 > 0)

2662 
x2
--;

2664 
D_Ích¬
 = 
mch¬_bÏnk
;

2668 
	`GÙoPos
(
x2
, 
y2
);

2669 
	`S‘R’d™iÚ
(&
D_Ích¬
);

2670 
	`PUTCHAR
(
D_Ích¬
.
image
);

2671 #ifdeà
DW_CHARS


2672 ià(
D_Ích¬
.
mbcs
)

2673 
	`PUTCHAR
(
D_Ích¬
.
mbcs
);

2675 
D_Í_missšg
 = 0;

2676 
	`S‘R’d™iÚ
(&
Şd»nd
);

2677 
	}
}

2680 
	$CË¬Lše
(
oml
, 
y
, 
äom
, 
to
, 
bû
)

2681 
mlše
 *
oml
;

2682 
äom
, 
to
, 
y
, 
bû
;

2684 
x
;

2685 #ifdeà
COLOR


2686 
mch¬
 
bûch¬
;

2689 
	`debug3
("CË¬Lš%d,%d-%d\n", 
y
, 
äom
, 
to
);

2690 ià(
D_UT
)

2691 
	`S‘R’d™iÚ
(&
mch¬_nuÎ
);

2692 #ifdeà
COLOR


2693 ià(
D_BE
)

2694 
	`S‘BackCŞÜ
(
bû
);

2696 ià(
äom
 =ğ0 && 
D_CB
 && (
to
 !ğ
D_width
 - 1 || (
D_x
 =ğtØ&& 
D_y
 =ğ
y
)è&& (!
bû
 || 
D_BE
))

2698 
	`GÙoPos
(
to
, 
y
);

2699 
	`AddCSŒ
(
D_CB
);

2702 ià(
to
 =ğ
D_width
 - 1 && 
D_CE
 && (!
bû
 || 
D_BE
))

2704 
	`GÙoPos
(
äom
, 
y
);

2705 
	`AddCSŒ
(
D_CE
);

2708 ià(
oml
 == 0)

2709 
oml
 = &
mlše_nuÎ
;

2710 #ifdeà
COLOR


2711 ià(!
bû
)

2713 
	`Di¥ÏyLše
(
oml
, &
mlše_bÏnk
, 
y
, 
äom
, 
to
);

2716 
bûch¬
 = 
mch¬_bÏnk
;

2717 
	`»nd_£tbg
(&
bûch¬
, 
bû
);

2718 
x
 = 
äom
; x <ğ
to
; x++)

2719 
	`cİy_mch¬2mlše
(&
bûch¬
, &
mlše_Şd
, 
x
);

2720 
	`Di¥ÏyLše
(
oml
, &
mlše_Şd
, 
y
, 
äom
, 
to
);

2722 
	`Di¥ÏyLše
(
oml
, &
mlše_bÏnk
, 
y
, 
äom
, 
to
);

2724 
	}
}

2727 
	$Di¥ÏyLše
(
oml
, 
ml
, 
y
, 
äom
, 
to
)

2728 
mlše
 *
oml
, *
ml
;

2729 
äom
, 
to
, 
y
;

2731 
x
;

2732 
Ï¡2æag
 = 0, 
d–‘e_Í
 = 0;

2734 
	`ASSERT
(
di¥Ïy
);

2735 
	`ASSERT
(
y
 >ğ0 && y < 
D_height
);

2736 
	`ASSERT
(
äom
 >ğ0 && from < 
D_width
);

2737 
	`ASSERT
(
to
 >ğ0 &&Ø< 
D_width
);

2738 ià(!
D_CLP
 && 
y
 =ğ
D_bÙ
 && 
to
 =ğ
D_width
 - 1)

2740 ià(
D_Í_missšg
 || !
	`cmp_mlše
(
oml
, 
ml
, 
to
))

2742 #ifdeà
DW_CHARS


2743 ià((
D_IC
 || 
D_IM
è&& 
äom
 < 
to
 && !
	`dw_Ëá
(
ml
,o, 
D_’codšg
))

2745 ià((
D_IC
 || 
D_IM
è&& 
äom
 < 
to
)

2748 
Ï¡2æag
 = 1;

2749 
D_Í_missšg
 = 0;

2750 
to
--;

2754 
d–‘e_Í
 = !
	`cmp_mch¬_mlše
(&
mch¬_bÏnk
, 
oml
, 
to
è&& (
D_CE
 || 
D_DC
 || 
D_CDC
);

2755 
D_Í_missšg
 = !
	`cmp_mch¬_mlše
(&
mch¬_bÏnk
, 
ml
, 
to
);

2756 
	`cİy_mlše2mch¬
(&
D_Ích¬
, 
ml
, 
to
);

2759 
to
--;

2761 #ifdeà
DW_CHARS


2762 ià(
D_mbcs
)

2765 
	`debug
("DisplayLine finishing kanji\n");

2766 
	`S‘R’d™iÚMlše
(
ml
, 
äom
);

2767 
	`PUTCHAR
(
ml
->
image
[
äom
]);

2768 
äom
++;

2771 
x
 = 
äom
; x <ğ
to
; x++)

2774 ià(
x
 || 
D_x
 !ğ
D_width
 || 
D_y
 !ğ
y
 - 1)

2777 ià(
x
 < 
to
 || x !ğ
D_width
 - 1 || 
ml
->
image
[x + 1])

2778 ià(
	`cmp_mlše
(
oml
, 
ml
, 
x
))

2780 
	`GÙoPos
(
x
, 
y
);

2782 #ifdeà
DW_CHARS


2783 ià(
	`dw_right
(
ml
, 
x
, 
D_’codšg
))

2785 
x
--;

2786 
	`debug1
("Di¥ÏyLšÚ„ighˆsidoàdw ch¬- x‚ow %d\n", 
x
);

2787 
	`GÙoPos
(
x
, 
y
);

2789 ià(
x
 =ğ
to
 && 
	`dw_Ëá
(
ml
, x, 
D_’codšg
))

2792 
	`S‘R’d™iÚMlše
(
ml
, 
x
);

2793 
	`PUTCHAR
(
ml
->
image
[
x
]);

2794 #ifdeà
DW_CHARS


2795 ià(
	`dw_Ëá
(
ml
, 
x
, 
D_’codšg
))

2796 
	`PUTCHAR
(
ml
->
image
[++
x
]);

2801 ià(
to
 =ğ
D_width
 - 1 && 
y
 < 
D_height
 - 1 && 
D_x
 =ğD_width && 
ml
->
image
[to + 1])

2802 
	`GÙoPos
(0, 
y
 + 1);

2804 ià(
Ï¡2æag
)

2806 
	`GÙoPos
(
x
, 
y
);

2807 
	`S‘R’d™iÚMlše
(
ml
, 
x
 + 1);

2808 
	`PUTCHAR
(
ml
->
image
[
x
 + 1]);

2809 
	`GÙoPos
(
x
, 
y
);

2810 
	`S‘R’d™iÚMlše
(
ml
, 
x
);

2811 
	`INSERTCHAR
(
ml
->
image
[
x
]);

2813 ià(
d–‘e_Í
)

2815 ià(
D_UT
)

2816 
	`S‘R’d™iÚ
(&
mch¬_nuÎ
);

2817 ià(
D_DC
)

2818 
	`AddCSŒ
(
D_DC
);

2819 ià(
D_CDC
)

2820 
	`AddCSŒ2
(
D_CDC
, 1);

2821 ià(
D_CE
)

2822 
	`AddCSŒ
(
D_CE
);

2824 
	}
}

2827 
	$PutCh¬
(
c
, 
x
, 
y
)

2828 
mch¬
 *
c
;

2829 
x
, 
y
;

2831 
	`GÙoPos
(
x
, 
y
);

2832 
	`S‘R’d™iÚ
(
c
);

2833 
	`PUTCHARLP
(
c
->
image
);

2834 #ifdeà
DW_CHARS


2835 ià(
c
->
mbcs
)

2837 #ifdeà
UTF8


2838 ià(
D_’codšg
 =ğ
UTF8
)

2839 
D_»nd
.
fÚt
 = 0;

2841 
	`PUTCHARLP
(
c
->
mbcs
);

2844 
	}
}

2847 
	$InsCh¬
(
c
, 
x
, 
xe
, 
y
, 
oml
)

2848 
mch¬
 *
c
;

2849 
x
, 
xe
, 
y
;

2850 
mlše
 *
oml
;

2852 
	`GÙoPos
(
x
, 
y
);

2853 ià(
y
 =ğ
D_bÙ
 && !
D_CLP
)

2855 ià(
x
 =ğ
D_width
 - 1)

2857 
D_Í_missšg
 = 1;

2858 
D_Ích¬
 = *
c
;

2861 ià(
xe
 =ğ
D_width
 - 1)

2862 
D_Í_missšg
 = 0;

2864 ià(
x
 =ğ
xe
)

2866 
	`S‘R’d™iÚ
(
c
);

2867 
	`PUTCHARLP
(
c
->
image
);

2870 ià(!(
D_IC
 || 
D_CIC
 || 
D_IM
è|| 
xe
 !ğ
D_width
 - 1)

2872 
	`ReäeshLše
(
y
, 
x
, 
xe
, 0);

2873 
	`GÙoPos
(
x
 + 1, 
y
);

2877 
	`In£¹Mode
(1);

2878 ià(!
D_š£¹
)

2880 #ifdeà
DW_CHARS


2881 ià(
c
->
mbcs
 && 
D_IC
)

2882 
	`AddCSŒ
(
D_IC
);

2883 ià(
D_IC
)

2884 
	`AddCSŒ
(
D_IC
);

2886 
	`AddCSŒ2
(
D_CIC
, 
c
->
mbcs
 ? 2 : 1);

2888 ià(
D_IC
)

2889 
	`AddCSŒ
(
D_IC
);

2891 
	`AddCSŒ2
(
D_CIC
, 1);

2894 
	`S‘R’d™iÚ
(
c
);

2895 
	`RAW_PUTCHAR
(
c
->
image
);

2896 #ifdeà
DW_CHARS


2897 ià(
c
->
mbcs
)

2899 #ifdeà
UTF8


2900 ià(
D_’codšg
 =ğ
UTF8
)

2901 
D_»nd
.
fÚt
 = 0;

2903 ià(
D_x
 =ğ
D_width
 - 1)

2904 
	`PUTCHARLP
(
c
->
mbcs
);

2906 
	`RAW_PUTCHAR
(
c
->
mbcs
);

2909 
	}
}

2912 
	$W¿pCh¬
(
c
, 
x
, 
y
, 
xs
, 
ys
, 
xe
, 
ye
, 
šs
)

2913 
mch¬
 *
c
;

2914 
x
, 
y
;

2915 
xs
, 
ys
, 
xe
, 
ye
;

2916 
šs
;

2918 
bû
;

2920 #ifdeà
COLOR


2921 
bû
 = 
	`»nd_g‘bg
(
c
);

2923 
bû
 = 0;

2925 
	`debug
("WrapChar:");

2926 
	`debug2
(" x %d y %d", 
x
, 
y
);

2927 
	`debug2
(" Dx %d Dy %d", 
D_x
, 
D_y
);

2928 
	`debug2
(" x %d y %d", 
xs
, 
ys
);

2929 
	`debug3
(" x%d y%d in %d\n", 
xe
, 
ye
, 
šs
);

2930 ià(
xs
 !ğ0 || 
x
 !ğ
D_width
 || !
D_AM
)

2932 ià(
y
 =ğ
ye
)

2933 
	`SüŞlV
(
xs
, 
ys
, 
xe
, 
ye
, 1, 
bû
);

2934 ià(
y
 < 
D_height
 - 1)

2935 
y
++;

2936 ià(
šs
)

2937 
	`InsCh¬
(
c
, 
xs
, 
xe
, 
y
, 0);

2939 
	`PutCh¬
(
c
, 
xs
, 
y
);

2942 ià(
y
 =ğ
ye
)

2944 
	`debug
("- scrolling\n");

2945 
	`ChªgeSüŞlRegiÚ
(
ys
, 
ye
);

2946 ià(
D_bÙ
 !ğ
y
 || 
D_x
 !ğ
D_width
 || (!
bû
 && !
D_BE
))

2948 
	`debug
("- haveo call ScrollV\n");

2949 
	`SüŞlV
(
xs
, 
ys
, 
xe
, 
ye
, 1, 
bû
);

2950 
y
--;

2953 ià(
y
 =ğ
D_bÙ
)

2954 
	`ChªgeSüŞlRegiÚ
(0, 
D_height
 - 1);

2955 ià(
D_x
 !ğ
D_width
 || 
D_y
 !ğ
y
)

2957 ià(
D_CLP
 && 
y
 >= 0)

2958 
	`ReäeshLše
(
y
, 
D_width
 - 1, D_width - 1, 0);

2959 
	`debug2
("-„eäesh†a¡ ch¬ -> x,y‚ow %d,%d\n", 
D_x
, 
D_y
);

2960 ià(
D_x
 !ğ
D_width
 || 
D_y
 !ğ
y
)

2962 ià(
y
 =ğ
ye
)

2963 
	`SüŞlV
(
xs
, 
ys
, 
xe
, 
ye
, 1, 
bû
);

2964 
	`GÙoPos
(
xs
, 
y
 =ğ
ye
 || y =ğ
D_height
 - 1 ? y : y + 1);

2967 
	`debug
("- writeing‚ew char");

2968 ià(
y
 !ğ
ye
 && y < 
D_height
 - 1)

2969 
y
++;

2970 ià(
šs
 !ğ
D_š£¹
)

2971 
	`In£¹Mode
(
šs
);

2972 ià(
šs
 && !
D_š£¹
)

2974 
	`InsCh¬
(
c
, 0, 
xe
, 
y
, 0);

2975 
	`debug2
(" -> dÚw™h in£¹ (%d,%d)\n", 
D_x
, 
D_y
);

2978 
D_y
 = 
y
;

2979 
D_x
 = 0;

2980 
	`S‘R’d™iÚ
(
c
);

2981 
	`RAW_PUTCHAR
(
c
->
image
);

2982 #ifdeà
DW_CHARS


2983 ià(
c
->
mbcs
)

2985 #ifdeà
UTF8


2986 ià(
D_’codšg
 =ğ
UTF8
)

2987 
D_»nd
.
fÚt
 = 0;

2989 
	`RAW_PUTCHAR
(
c
->
mbcs
);

2992 
	`debug2
(" -> dÚ(%d,%d)\n", 
D_x
, 
D_y
);

2993 
	}
}

2996 
	$ResizeDi¥Ïy
(
wi
, 
he
)

2997 
wi
, 
he
;

2999 
	`ASSERT
(
di¥Ïy
);

3000 
	`debug2
("ResizeDi¥Ïy:Ø(%d,%d).\n", 
wi
, 
he
);

3001 ià(
D_width
 =ğ
wi
 && 
D_height
 =ğ
he
)

3003 
	`debug
("ResizeDisplay: No change\n");

3006 ià(
D_width
 !ğ
wi
 && (
D_height
 =ğ
he
 || !
D_CWS
è&& 
D_CZ0
 && (w˜=ğ
Z0width
 || w˜=ğ
Z1width
))

3008 
	`debug
("ResizeDisplay: using Z0/Z1\n");

3009 
	`AddCSŒ
(
wi
 =ğ
Z0width
 ? 
D_CZ0
 : 
D_CZ1
);

3010 
	`ChªgeSü“nSize
(
wi
, 
D_height
, 0);

3011  (
he
 =ğ
D_height
) ? 0 : -1;

3013 ià(
D_CWS
)

3015 
	`debug
("ResizeDisplay: using WS\n");

3016 
	`AddCSŒ
(
	`tgÙo
(
D_CWS
, 
wi
, 
he
));

3017 
	`ChªgeSü“nSize
(
wi
, 
he
, 0);

3021 
	}
}

3024 
	$ChªgeSüŞlRegiÚ
(
Ãwtİ
, 
ÃwbÙ
)

3025 
Ãwtİ
, 
ÃwbÙ
;

3027 ià(
di¥Ïy
 == 0)

3029 ià(
Ãwtİ
 =ğ
ÃwbÙ
)

3031 ià(
Ãwtİ
 == -1)

3032 
Ãwtİ
 = 0;

3033 ià(
ÃwbÙ
 == -1)

3034 
ÃwbÙ
 = 
D_height
 - 1;

3035 ià(
D_CS
 == 0)

3037 
D_tİ
 = 0;

3038 
D_bÙ
 = 
D_height
 - 1;

3041 ià(
D_tİ
 =ğ
Ãwtİ
 && 
D_bÙ
 =ğ
ÃwbÙ
)

3043 
	`debug2
("ChªgeSüŞlRegiÚ: (%d - %d)\n", 
Ãwtİ
, 
ÃwbÙ
);

3044 
	`AddCSŒ
(
	`tgÙo
(
D_CS
, 
ÃwbÙ
, 
Ãwtİ
));

3045 
D_tİ
 = 
Ãwtİ
;

3046 
D_bÙ
 = 
ÃwbÙ
;

3047 
D_y
 = 
D_x
 = -1;

3048 
	}
}

3050 #ifdeà
RXVT_OSC


3052 
	$S‘X‹rmOSC
(
i
, 
s
)

3053 
i
;

3054 *
s
;

3056 
oscs
[] = "1;\000\00020;\00039;\00049;\000";

3058 
	`ASSERT
(
di¥Ïy
);

3059 ià(!
D_CXT
)

3061 ià(!
s
)

3062 
s
 = "";

3063 ià(!
D_x‹rmosc
[
i
] && !*
s
)

3065 ià(
i
 =ğ0 && !*
s
)

3066 
s
 = "screen";

3067 ià(
i
 =ğ1 && !*
s
)

3068 
s
 = "";

3069 ià(
i
 =ğ2 && !*
s
)

3070 
s
 = "black";

3071 ià(
i
 =ğ3 && !*
s
)

3072 
s
 = "white";

3073 
D_x‹rmosc
[
i
] = 1;

3074 
	`AddSŒ
("\033]");

3075 
	`AddSŒ
(
oscs
 + 
i
 * 4);

3076 
	`AddSŒ
(
s
);

3077 
	`AddCh¬
(7);

3078 
	}
}

3081 
	$CË¬AÎX‹rmOSC
()

3083 
i
;

3084 
i
 = 3; i >= 0; i--)

3085 
	`S‘X‹rmOSC
(
i
, 0);

3086 
	}
}

3094 
	$AddSŒ
(
¡r
)

3095 *
¡r
;

3097 
c
;

3099 
	`ASSERT
(
di¥Ïy
);

3101 #ifdeà
UTF8


3102 ià(
D_’codšg
 =ğ
UTF8
)

3104 (
c
 = *
¡r
++))

3105 
	`AddUtf8
(()
c
);

3109 (
c
 = *
¡r
++))

3110 
	`AddCh¬
(
c
);

3111 
	}
}

3114 
	$AddSŒn
(
¡r
, 
n
)

3115 *
¡r
;

3116 
n
;

3118 
c
;

3120 
	`ASSERT
(
di¥Ïy
);

3121 #ifdeà
UTF8


3122 ià(
D_’codšg
 =ğ
UTF8
)

3124 (
c
 = *
¡r
++è&& 
n
-- > 0)

3125 
	`AddUtf8
(()
c
);

3129 (
c
 = *
¡r
++è&& 
n
-- > 0)

3130 
	`AddCh¬
(
c
);

3131 
n
-- > 0)

3132 
	`AddCh¬
(' ');

3133 
	}
}

3136 
	$Flush
()

3138 
l
;

3139 *
p
;

3141 
	`ASSERT
(
di¥Ïy
);

3142 
l
 = 
D_obuå
 - 
D_obuf
;

3143 
	`debug1
("Flush(): %d\n", 
l
);

3144 ià(
l
 == 0)

3146 
	`ASSERT
(
l
 + 
D_obufä“
 =ğ
D_obuæ’
);

3147 ià(
D_u£rfd
 < 0)

3149 
D_obufä“
 +ğ
l
;

3150 
D_obuå
 = 
D_obuf
;

3153 
p
 = 
D_obuf
;

3154 ià(
	`fú
(
D_u£rfd
, 
F_SETFL
, 0))

3155 
	`debug1
("W¬nšg: BLOCK fú faed: %d\n", 
”ºo
);

3156 
l
)

3158 
wr
;

3159 
wr
 = 
	`wr™e
(
D_u£rfd
, 
p
, 
l
);

3160 ià(
wr
 <= 0)

3162 ià(
”ºo
 =ğ
EINTR
)

3164 
	`debug1
("Wr™šgØdi¥Ïy: %d\n", 
”ºo
);

3165 
wr
 = 
l
;

3167 ià(!
di¥Ïy
)

3169 
D_obufä“
 +ğ
wr
;

3170 
p
 +ğ
wr
;

3171 
l
 -ğ
wr
;

3173 
D_obufä“
 +ğ
l
;

3174 
D_obuå
 = 
D_obuf
;

3175 ià(
	`fú
(
D_u£rfd
, 
F_SETFL
, 
FNBLOCK
))

3176 
	`debug1
("W¬nšg: NBLOCK fú faed: %d\n", 
”ºo
);

3177 ià(
D_blocked
 == 1)

3178 
D_blocked
 = 0;

3179 
D_blocked_fuzz
 = 0;

3180 
	}
}

3183 
	$ä“‰y
()

3185 ià(
D_u£rfd
 >= 0)

3186 
	`şo£
(
D_u£rfd
);

3187 
	`debug1
("did f»‘ty %d\n", 
D_u£rfd
);

3188 
D_u£rfd
 = -1;

3189 
D_obuå
 = 0;

3190 
D_obufä“
 = 0;

3191 ià(
D_obuf
)

3192 
	`ä“
(
D_obuf
);

3193 
D_obuf
 = 0;

3194 
D_obuæ’
 = 0;

3195 
D_obuæ’max
 = -
D_obufmax
;

3196 
D_blocked
 = 0;

3197 
D_blocked_fuzz
 = 0;

3198 
	}
}

3206 
	$Resize_obuf
()

3208 
šd
;

3210 
	`ASSERT
(
di¥Ïy
);

3211 ià(
D_¡©us_obufä“
 >= 0)

3213 
	`ASSERT
(
D_obufä“
 == -1);

3214 ià(!
D_¡©us_b–l
)

3216 
timev®
 
now
;

3217 
ti
;

3218 
	`g‘timeofday
(&
now
, 
NULL
);

3219 
ti
 = (
now
.
tv_£c
 - 
D_¡©us_time
.tv_£cè* 1000 + (now.
tv_u£c
 - D_status_time.tv_usec) / 1000;

3220 ià(
ti
 < 
MsgMšWa™
)

3221 
	`Di¥ÏySË•1000
(
MsgMšWa™
 - 
ti
, 0);

3223 
	`RemoveStus
();

3224 ià(--
D_obufä“
 > 0)

3227 ià(
D_obuæ’
 && 
D_obuf
)

3229 
šd
 = 
D_obuå
 - 
D_obuf
;

3230 
D_obuæ’
 +ğ
GRAIN
;

3231 
D_obufä“
 +ğ
GRAIN
;

3232 
D_obuf
 = 
	`»®loc
(D_obuf, 
D_obuæ’
);

3236 
šd
 = 0;

3237 
D_obuæ’
 = 
GRAIN
;

3238 
D_obufä“
 = 
GRAIN
;

3239 
D_obuf
 = 
	`m®loc
(
D_obuæ’
);

3241 ià(!
D_obuf
)

3242 
	`Pªic
(0, "Out of memory");

3243 
D_obuå
 = 
D_obuf
 + 
šd
;

3244 
D_obuæ’max
 = 
D_obuæ’
 - 
D_obufmax
;

3245 
	`debug1
("ResizeObuf:„esizedØ%d\n", 
D_obuæ’
);

3246 
	}
}

3249 
	$Di¥ÏySË•1000
(
n
, 
—t
)

3250 
n
;

3251 
—t
;

3253 
buf
;

3254 
fd_£t
 
r
;

3255 
timev®
 
t
;

3257 ià(
n
 <= 0)

3259 ià(!
di¥Ïy
)

3261 
	`debug
("DisplaySleep has‚o display sigh\n");

3262 
	`¦“p1000
(
n
);

3265 
t
.
tv_u£c
 = (
n
 % 1000) * 1000;

3266 
t
.
tv_£c
 = 
n
 / 1000;

3267 
	`FD_ZERO
(&
r
);

3268 
	`FD_SET
(
D_u£rfd
, &
r
);

3269 ià(
	`£Ëù
(
FD_SETSIZE
, &
r
, (
fd_£t
 *)0, (fd_£ˆ*)0, &
t
) > 0)

3271 
	`debug
("display‡ctivity stopped sleep\n");

3272 ià(
—t
)

3273 
	`»ad
(
D_u£rfd
, &
buf
, 1);

3275 
	`debug2
("Di¥ÏySË•(%dè’dšg,ƒ© wa %d\n", 
n
, 
—t
);

3276 
	}
}

3278 #ifdeà
AUTO_NUKE


3280 
	$NukeP’dšg
()

3282 
Ën
;

3283 
Şdtİ
 = 
D_tİ
, 
ŞdbÙ
 = 
D_bÙ
;

3284 
mch¬
 
Şd»nd
;

3285 
Şdkey·d
 = 
D_key·d
, 
ŞdcursÜkeys
 = 
D_cursÜkeys
;

3286 
Şdcurvis
 = 
D_curvis
;

3287 
Şdmou£
 = 
D_mou£
;

3289 
Şd»nd
 = 
D_»nd
;

3290 
Ën
 = 
D_obuå
 - 
D_obuf
;

3291 
	`debug1
("NukeP’dšg:‚ukšg %d ch¬s\n", 
Ën
);

3294 #ifdeà
POSIX


3295 
	`tcæush
(
D_u£rfd
, 
TCOFLUSH
);

3297 #ifdeà
TCFLSH


3298 (è
	`ioùl
(
D_u£rfd
, 
TCFLSH
, (*) 1);

3302 
D_obuå
 = 
D_obuf
;

3303 
D_obufä“
 +ğ
Ën
;

3304 
D_tİ
 = 
D_bÙ
 = -1;

3305 
	`AddCSŒ
(
D_TI
);

3306 
	`AddCSŒ
(
D_IS
);

3308 ià(
D_ME
)

3309 
	`AddCSŒ
(
D_ME
);

3312 #ifdeà
COLOR


3313 ià(
D_hascŞÜ
)

3314 
	`AddSŒ
("\033[m");

3316 
	`AddCSŒ
(
D_SE
);

3317 
	`AddCSŒ
(
D_UE
);

3320 ià(
D_IM
 && 
	`¡rcmp
(D_IM, 
D_EI
))

3321 
	`AddCSŒ
(
D_EI
);

3322 
D_š£¹
 = 0;

3324 #ifdeà
MAPKEYS


3325 ià(
D_KS
 && 
	`¡rcmp
(D_KS, 
D_KE
))

3326 
	`AddCSŒ
(
D_KS
);

3327 ià(
D_CCS
 && 
	`¡rcmp
(D_CCS, 
D_CCE
))

3328 
	`AddCSŒ
(
D_CCS
);

3330 ià(
D_KS
 && 
	`¡rcmp
(D_KS, 
D_KE
))

3331 
	`AddCSŒ
(
D_KE
);

3332 
D_key·d
 = 0;

3333 ià(
D_CCS
 && 
	`¡rcmp
(D_CCS, 
D_CCE
))

3334 
	`AddCSŒ
(
D_CCE
);

3335 
D_cursÜkeys
 = 0;

3337 
	`AddCSŒ
(
D_CE0
);

3338 
D_»nd
 = 
mch¬_nuÎ
;

3339 
D_©yp
 = 0;

3340 
	`AddCSŒ
(
D_DS
);

3341 
D_h¡©us
 = 0;

3342 
	`AddCSŒ
(
D_VE
);

3343 
D_curvis
 = 0;

3344 
	`ChªgeSüŞlRegiÚ
(
Şdtİ
, 
ŞdbÙ
);

3345 
	`S‘R’d™iÚ
(&
Şd»nd
);

3346 
	`Key·dMode
(
Şdkey·d
);

3347 
	`CursÜkeysMode
(
ŞdcursÜkeys
);

3348 
	`CursÜVisib™y
(
Şdcurvis
);

3349 
	`Mou£Mode
(
Şdmou£
);

3350 ià(
D_CWS
)

3352 
	`debug
("ResizeDisplay: using WS\n");

3353 
	`AddCSŒ
(
	`tgÙo
(
D_CWS
, 
D_width
, 
D_height
));

3355 ià(
D_CZ0
 && (
D_width
 =ğ
Z0width
 || D_width =ğ
Z1width
))

3357 
	`debug
("ResizeDisplay: using Z0/Z1\n");

3358 
	`AddCSŒ
(
D_width
 =ğ
Z0width
 ? 
D_CZ0
 : 
D_CZ1
);

3360 
	}
}

3363 #ifdeà
lšux


3368 
	$di¥_wr™“v_—gaš
(
ev
, 
d©a
)

3369 
ev’t
 *
ev
;

3370 *
d©a
;

3372 
di¥Ïy
 = (di¥Ïy *)
d©a
;

3373 
	`evdeq
(&
D_wr™“v
);

3374 
D_wr™“v
.
ty³
 = 
EV_WRITE
;

3375 
D_wr™“v
.
hªdËr
 = 
di¥_wr™“v_â
;

3376 
	`ev’q
(&
D_wr™“v
);

3377 
	}
}

3381 
	$di¥_wr™“v_â
(
ev
, 
d©a
)

3382 
ev’t
 *
ev
;

3383 *
d©a
;

3385 
Ën
, 
size
 = 
OUTPUT_BLOCK_SIZE
;

3387 
di¥Ïy
 = (di¥Ïy *)
d©a
;

3388 
Ën
 = 
D_obuå
 - 
D_obuf
;

3389 ià(
Ën
 < 
size
)

3390 
size
 = 
Ën
;

3391 
	`ASSERT
(
Ën
 >= 0);

3392 
size
 = 
	`wr™e
(
D_u£rfd
, 
D_obuf
, size);

3393 ià(
size
 >= 0)

3395 
Ën
 -ğ
size
;

3396 ià(
Ën
)

3398 
	`bcİy
(
D_obuf
 + 
size
, D_obuf, 
Ën
);

3399 
	`debug2
("ASYNC: wrÙ%d -„emaššg %d\n", 
size
, 
Ën
);

3401 
D_obuå
 -ğ
size
;

3402 
D_obufä“
 +ğ
size
;

3403 ià(
D_blocked_fuzz
)

3405 
D_blocked_fuzz
 -ğ
size
;

3406 ià(
D_blocked_fuzz
 < 0)

3407 
D_blocked_fuzz
 = 0;

3409 ià(
D_blockedev
.
queued
)

3411 ià(
D_obuå
 - 
D_obuf
 > 
D_obufmax
 / 2)

3413 
	`debug2
("%s:„e£‰šgimeouˆtØ%g secs\n", 
D_u£¹ty
, 
D_nÚblock
/1000.);

3414 
	`S‘Timeout
(&
D_blockedev
, 
D_nÚblock
);

3418 
	`debug1
("%s: d–‘šg blockedimeout\n", 
D_u£¹ty
);

3419 
	`evdeq
(&
D_blockedev
);

3422 ià(
D_blocked
 =ğ1 && 
D_obuf
 =ğ
D_obuå
)

3425 
	`debug1
("%s: bufã¸em±y, unblockšg\n", 
D_u£¹ty
);

3426 
D_blocked
 = 0;

3427 
	`Aùiv©e
(
D_fÜe
 ? D_fÜe->
w_nÜeäesh
 : 0);

3428 
D_blocked_fuzz
 = 
D_obuå
 - 
D_obuf
;

3433 #ifdeà
lšux


3435 ià(
”ºo
 =ğ
EAGAIN
)

3437 
	`evdeq
(&
D_wr™“v
);

3438 
D_wr™“v
.
ty³
 = 
EV_TIMEOUT
;

3439 
D_wr™“v
.
hªdËr
 = 
di¥_wr™“v_—gaš
;

3440 
	`S‘Timeout
(&
D_wr™“v
, 100);

3441 
	`ev’q
(&
D_wr™“v
);

3444 ià(
”ºo
 !ğ
EINTR
 &&ƒ¼nØ!ğ
EAGAIN
)

3445 #ià
	`defšed
(
EWOULDBLOCK
è&& (EWOULDBLOCK !ğ
EAGAIN
)

3446 ià(
”ºo
 !ğ
EWOULDBLOCK
)

3448 
	`Msg
(
”ºo
, "Error writing outputo display");

3450 
	}
}

3453 
	$di¥_»adev_â
(
ev
, 
d©a
)

3454 
ev’t
 *
ev
;

3455 *
d©a
;

3457 
size
;

3458 
buf
[
IOSIZE
];

3459 
ÿnvas
 *
cv
;

3461 
di¥Ïy
 = (di¥Ïy *)
d©a
;

3464 ià(
D_fÜecv
)

3465 
cv
 = 
D_fÜecv
->
c_Ïy”
->
l_cvli¡
; cv; cv = cv->
c_Êext
)

3467 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

3468 ià(
D_¡©us
 =ğ
STATUS_ON_WIN
)

3469 
	`RemoveStus
();

3472 
di¥Ïy
 = (di¥Ïy *)
d©a
;

3473 ià(
D_fÜe
 == 0)

3474 
size
 = 
IOSIZE
;

3477 #ifdeà
PSEUDOS


3478 ià(
	`W_UWP
(
D_fÜe
))

3479 
size
 = (
D_fÜe
->
w_pwš
->
p_šbuf
è- D_fÜe->w_pwš->
p_šËn
;

3482 
size
 = (
D_fÜe
->
w_šbuf
è- D_fÜe->
w_šËn
;

3485 ià(
size
 > 
IOSIZE
)

3486 
size
 = 
IOSIZE
;

3487 ià(
size
 <= 0)

3488 
size
 = 1;

3490 
size
 = 
	`»ad
(
D_u£rfd
, 
buf
, size);

3491 ià(
size
 < 0)

3493 ià(
”ºo
 =ğ
EINTR
 ||ƒ¼nØ=ğ
EAGAIN
)

3495 #ià
	`defšed
(
EWOULDBLOCK
è&& (EWOULDBLOCK !ğ
EAGAIN
)

3496 ià(
”ºo
 =ğ
EWOULDBLOCK
)

3499 
	`debug1
("R—dƒ¼Ü: %d - hªgup!\n", 
”ºo
);

3500 
	`Hªgup
();

3501 
	`¦“p
(1);

3504 ià(
size
 == 0)

3506 
	`debug
("Found EOF - hangup!\n");

3507 
	`Hªgup
();

3508 
	`¦“p
(1);

3511 ià(
D_blocked
 == 4)

3513 
D_blocked
 = 0;

3514 #ifdeà
BLANKER_PRG


3515 
	`KlBÏnk”
();

3517 
	`Aùiv©e
(
D_fÜe
 ? D_fÜe->
w_nÜeäesh
 : 0);

3518 
	`Re£tIdË
();

3521 #ifdeà
ZMODEM


3522 ià(
D_blocked
 > 1)

3524 *
buå
;

3525 
wš
 *
p
;

3527 
æay”
 = 0;

3528 
p
 = 
wšdows
;… ;… =…->
w_Ãxt
)

3529 ià(
p
->
w_zdi¥Ïy
 =ğ
di¥Ïy
)

3531 
æay”
 = &
p
->
w_Ïy”
;

3532 
buå
 = 
buf
;

3533 
size
 > 0)

3534 
	`LayProûss
(&
buå
, &
size
);

3537 
	`debug
("zmodem window gone, deblocking display");

3538 
	`zmodem_abÜt
(0, 
di¥Ïy
);

3541 ià(
idËtimo
 > 0)

3542 
	`Re£tIdË
();

3543 ià(
D_fÜe
)

3544 
D_fÜe
->
w_Ï¡di¥
 = 
di¥Ïy
;

3545 ià(
D_mou£
 && 
D_fÜecv
)

3547 *
bp
 = (*)
buf
;

3548 
x
, 
y
, 
i
 = 
size
;

3551 
i
 = 
size
; i > 0; i--, 
bp
++)

3553 ià(
i
 > 5 && 
bp
[0] == 033 && bp[1] == '[' && bp[2] == 'M')

3555 
bp
++;

3556 
i
--;

3558 ià(
i
 < 5 || 
bp
[0] != 0233 || bp[1] != 'M')

3560 
x
 = 
bp
[3] - 33;

3561 
y
 = 
bp
[4] - 33;

3562 ià(
x
 >ğ
D_fÜecv
->
c_xs
 && x <ğD_fÜecv->
c_xe
 && 
y
 >ğD_fÜecv->
c_ys
 && y <ğD_fÜecv->
c_ye
)

3564 
x
 -ğ
D_fÜecv
->
c_xoff
;

3565 
y
 -ğ
D_fÜecv
->
c_yoff
;

3566 ià(
x
 >ğ0 && x < 
D_fÜecv
->
c_Ïy”
->
l_width
 && 
y
 >ğ0 && y < D_fÜecv->c_Ïy”->
l_height
)

3568 
bp
[3] = 
x
 + 33;

3569 
bp
[4] = 
y
 + 33;

3570 
i
 -= 4;

3571 
bp
 += 4;

3575 ià(
bp
[0] == '[')

3577 
	`bcİy
((*)
bp
 + 1, (*)bp, 
i
);

3578 
bp
--;

3579 
size
--;

3581 ià(
i
 > 5)

3582 
	`bcİy
((*)
bp
 + 5, (*)bp, 
i
 - 5);

3583 
bp
--;

3584 
i
 -= 4;

3585 
size
 -= 5;

3588 #ifdeà
ENCODINGS


3589 ià(
D_’codšg
 !ğ(
D_fÜecv
 ? D_fÜecv->
c_Ïy”
->
l_’codšg
 : 0))

3591 
i
, 
j
, 
c
, 
’c
;

3592 
buf2
[
IOSIZE
 * 2 + 10];

3593 
’c
 = 
D_fÜecv
 ? D_fÜecv->
c_Ïy”
->
l_’codšg
 : 0;

3594 
i
 = 
j
 = 0; i < 
size
; i++)

3596 
c
 = ((*)
buf
)[
i
];

3597 
c
 = 
	`DecodeCh¬
(c, 
D_’codšg
, &
D_decode¡©e
);

3598 ià(
c
 == -2)

3599 
i
--;

3600 ià(
c
 < 0)

3602 ià(
·¡efÚt
)

3604 
fÚt
 = 0;

3605 
j
 +ğ
	`EncodeCh¬
(
buf2
 + j, 
c
, 
’c
, &
fÚt
);

3606 
j
 +ğ
	`EncodeCh¬
(
buf2
 + j, -1, 
’c
, &
fÚt
);

3609 
j
 +ğ
	`EncodeCh¬
(
buf2
 + j, 
c
, 
’c
, 0);

3610 ià(
j
 > ()(
buf2
) - 10)

3613 (*
D_´oûssšput
)(
buf2
, 
j
);

3617 (*
D_´oûssšput
)(
buf
, 
size
);

3618 
	}
}

3621 
	$di¥_¡©us_â
(
ev
, 
d©a
)

3622 
ev’t
 *
ev
;

3623 *
d©a
;

3625 
di¥Ïy
 = (di¥Ïy *)
d©a
;

3626 
	`debug1
("di¥_¡©us_â fÜ di¥Ïy %x\n", ()
di¥Ïy
);

3627 ià(
D_¡©us
)

3628 
	`RemoveStus
();

3629 
	}
}

3632 
	$di¥_h¡©us_â
(
ev
, 
d©a
)

3633 
ev’t
 *
ev
;

3634 *
d©a
;

3636 
di¥Ïy
 = (di¥Ïy *)
d©a
;

3637 ià(
D_¡©us
 =ğ
STATUS_ON_HS
)

3639 
	`S‘Timeout
(
ev
, 1);

3640 
	`ev’q
(
ev
);

3643 
	`ReäeshHStus
();

3644 
	}
}

3647 
	$di¥_blocked_â
(
ev
, 
d©a
)

3648 
ev’t
 *
ev
;

3649 *
d©a
;

3651 
wš
 *
p
;

3653 
di¥Ïy
 = (di¥Ïy *)
d©a
;

3654 
	`debug1
("blockedimeouˆ%s\n", 
D_u£¹ty
);

3655 ià(
D_obuå
 - 
D_obuf
 > 
D_obufmax
 + 
D_blocked_fuzz
)

3657 
	`debug
("stopping outputo display\n");

3658 
D_blocked
 = 1;

3660 
p
 = 
wšdows
;…;… =…->
w_Ãxt
)

3661 ià(
p
->
w_»adev
.
cÚdÃg
 =ğ&
D_obuæ’max
)

3663 
	`debug1
("ä“šg wšdow #%d\n", 
p
->
w_numb”
);

3664 
p
->
w_»adev
.
cÚdpos
 =…->w_»adev.
cÚdÃg
 = 0;

3667 
	}
}

3670 
	$cv_wšid_â
(
ev
, 
d©a
)

3671 
ev’t
 *
ev
;

3672 *
d©a
;

3674 
ox
, 
oy
;

3675 
ÿnvas
 *
cv
 = (ÿnva *)
d©a
;

3677 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

3678 ià(
D_¡©us
 =ğ
STATUS_ON_WIN
)

3680 
	`S‘Timeout
(
ev
, 1);

3681 
	`ev’q
(
ev
);

3684 
ox
 = 
D_x
;

3685 
oy
 = 
D_y
;

3686 ià(
cv
->
c_ye
 + 1 < 
D_height
)

3687 
	`ReäeshLše
(
cv
->
c_ye
 + 1, 0, 
D_width
 - 1, 0);

3688 ià(
ox
 !ğ-1 && 
oy
 != -1)

3689 
	`GÙoPos
(
ox
, 
oy
);

3690 
	}
}

3692 #ifdeà
MAPKEYS


3694 
	$di¥_m­_â
(
ev
, 
d©a
)

3695 
ev’t
 *
ev
;

3696 *
d©a
;

3698 *
p
;

3699 
l
, 
i
;

3700 *
q
;

3701 
di¥Ïy
 = (di¥Ïy *)
d©a
;

3702 
	`debug
("Flushing map sequence\n");

3703 ià(!(
l
 = 
D_£ql
))

3705 
p
 = (*)
D_£qp
 - 
l
;

3706 
D_£qp
 = 
D_km­s
 + 3;

3707 
D_£ql
 = 0;

3708 ià((
q
 = 
D_£qh
) != 0)

3710 
D_£qh
 = 0;

3711 
i
 = 
q
[0] << 8 | q[1];

3712 
i
 &ğ~
KMAP_NOTIMEOUT
;

3713 
	`debug1
("M­pšg fÜm” h™ #%d - ", 
i
);

3714 
	`debug2
("%d(%sè- ", 
q
[2], q + 3);

3715 ià(
	`StuffKey
(
i
))

3716 
	`ProûssIÅut2
((*)
q
 + 3, q[2]);

3717 ià(
di¥Ïy
 == 0)

3719 
l
 -ğ
q
[2];

3720 
p
 +ğ
q
[2];

3723 
D_dÚtm­
 = 1;

3724 
	`ProûssIÅut
(
p
, 
l
);

3725 
	}
}

3729 
	$di¥_idË_â
(
ev
, 
d©a
)

3730 
ev’t
 *
ev
;

3731 *
d©a
;

3733 
di¥Ïy
 *
Şddi¥Ïy
;

3734 
di¥Ïy
 = (di¥Ïy *)
d©a
;

3735 
	`debug
("idleimeout\n");

3736 ià(
idËtimo
 <ğ0 || 
idËaùiÚ
.
Ä
 =ğ
RC_ILLEGAL
)

3738 
Şddi¥Ïy
 = 
di¥Ïy
;

3739 
æay”
 = 
D_fÜecv
->
c_Ïy”
;

3740 
fÜe
 = 
D_fÜe
;

3741 
	`DoAùiÚ
(&
idËaùiÚ
, -1);

3742 ià(
idËaùiÚ
.
Ä
 =ğ
RC_BLANKER
)

3744 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

3745 ià(
Şddi¥Ïy
 =ğ
di¥Ïy
)

3747 ià(
di¥Ïy
)

3748 
	`Re£tIdË
();

3749 
	}
}

3752 
	$Re£tIdË
()

3754 ià(
idËtimo
 > 0)

3756 
	`S‘Timeout
(&
D_idËev
, 
idËtimo
);

3757 ià(!
D_idËev
.
queued
)

3758 
	`ev’q
(&
D_idËev
);

3761 
	`evdeq
(&
D_idËev
);

3762 
	}
}

3765 #ifdeà
BLANKER_PRG


3768 
	$di¥_bÏnk”_â
(
ev
, 
d©a
)

3769 
ev’t
 *
ev
;

3770 *
d©a
;

3772 
buf
[
IOSIZE
], *
b
;

3773 
size
;

3775 
di¥Ïy
 = (di¥Ïy *)
d©a
;

3776 
size
 = 
	`»ad
(
D_bÏnk”ev
.
fd
, 
buf
, 
IOSIZE
);

3777 ià(
size
 <= 0)

3779 
	`evdeq
(&
D_bÏnk”ev
);

3780 
	`şo£
(
D_bÏnk”ev
.
fd
);

3781 
D_bÏnk”ev
.
fd
 = -1;

3784 
b
 = 
buf
; 
size
; size--)

3785 
	`AddCh¬
(*
b
++);

3786 
	}
}

3789 
	$KlBÏnk”
()

3791 
Şdtİ
 = 
D_tİ
, 
ŞdbÙ
 = 
D_bÙ
;

3792 
mch¬
 
Şd»nd
;

3794 ià(
D_bÏnk”ev
.
fd
 == -1)

3796 ià(
D_blocked
 == 4)

3797 
D_blocked
 = 0;

3798 
	`evdeq
(&
D_bÏnk”ev
);

3799 
	`şo£
(
D_bÏnk”ev
.
fd
);

3800 
D_bÏnk”ev
.
fd
 = -1;

3801 
	`Kl
(
D_bÏnk”pid
, 
SIGHUP
);

3802 
D_tİ
 = 
D_bÙ
 = -1;

3803 
Şd»nd
 = 
D_»nd
;

3804 ià(
D_ME
)

3806 
	`AddCSŒ
(
D_ME
);

3807 
	`AddCSŒ
(
D_ME
);

3811 #ifdeà
COLOR


3812 ià(
D_hascŞÜ
)

3813 
	`AddSŒ
("\033[m\033[m");

3815 
	`AddCSŒ
(
D_SE
);

3816 
	`AddCSŒ
(
D_UE
);

3818 
	`AddCSŒ
(
D_VE
);

3819 
	`AddCSŒ
(
D_CE0
);

3820 
D_»nd
 = 
mch¬_nuÎ
;

3821 
D_©yp
 = 0;

3822 
D_curvis
 = 0;

3823 
D_x
 = 
D_y
 = -1;

3824 
	`ChªgeSüŞlRegiÚ
(
Şdtİ
, 
ŞdbÙ
);

3825 
	`S‘R’d™iÚ
(&
Şd»nd
);

3826 
	`CË¬AÎ
();

3827 
	}
}

3830 
	$RunBÏnk”
(
cmdv
)

3831 **
cmdv
;

3833 *
m
;

3834 
pid
;

3835 
¦ave
 = -1;

3836 
‹rmÇme
[30];

3837 #iâdeà
TIOCSWINSZ


3838 
libuf
[20], 
cobuf
[20];

3840 **
Å
;

3842 
	`¡rıy
(
‹rmÇme
, "TERM=");

3843 
	`¡ºıy
(
‹rmÇme
 + 5, 
D_‹rmÇme
, (termname) - 6);

3844 
‹rmÇme
[(termname) - 1] = 0;

3845 
	`KlBÏnk”
();

3846 
D_bÏnk”pid
 = -1;

3847 ià((
D_bÏnk”ev
.
fd
 = 
	`O³nPTY
(&
m
)) == -1)

3849 
	`Msg
(0, "OpenPty failed");

3852 #ifdeà
O_NOCTTY


3853 ià(
±y_´eİ’
)

3855 ià((
¦ave
 = 
	`İ’
(
m
, 
O_RDWR
|
O_NOCTTY
)) == -1)

3857 
	`Msg
(
”ºo
, "%s", 
m
);

3858 
	`şo£
(
D_bÏnk”ev
.
fd
);

3859 
D_bÏnk”ev
.
fd
 = -1;

3864 
pid
 = ()
	`fÜk
())

3867 
	`Msg
(
”ºo
, "fork");

3868 
	`şo£
(
D_bÏnk”ev
.
fd
);

3869 
D_bÏnk”ev
.
fd
 = -1;

3872 
di¥Ïys
 = 0;

3873 #ifdeà
DEBUG


3874 ià(
då
 && då !ğ
¡d”r
)

3875 
	`fşo£
(
då
);

3877 ià(
	`£tgid
(
»®_gid
è|| 
	`£tuid
(
»®_uid
))

3878 
	`Pªic
(
”ºo
, "setuid/setgid");

3879 
	`brk‰y
(
D_u£rfd
);

3880 
	`ä“‰y
();

3881 
	`şo£
(0);

3882 
	`şo£
(1);

3883 
	`şo£
(2);

3884 
	`şo£®lfes
(
¦ave
);

3885 ià(
	`İ’
(
m
, 
O_RDWR
))

3886 
	`Pªic
(
”ºo
, "CªnÙ o³À%s", 
m
);

3887 
	`dup
(0);

3888 
	`dup
(0);

3889 ià(
¦ave
 != -1)

3890 
	`şo£
(
¦ave
);

3891 
	`In™PTY
(0);

3892 
	`fg‰y
(0);

3893 
	`S‘TTY
(0, &
D_OldMode
);

3894 
Å
 = 
NewEnv
 + 3;

3895 *
Å
++ = 
NewEnv
[0];

3896 *
Å
++ = 
‹rmÇme
;

3897 #ifdeà
TIOCSWINSZ


3898 
glwz
.
ws_cŞ
 = 
D_width
;

3899 
glwz
.
ws_row
 = 
D_height
;

3900 ()
	`ioùl
(0, 
TIOCSWINSZ
, (*)&
glwz
);

3902 
	`¥rštf
(
libuf
, "LINES=%d", 
D_height
);

3903 
	`¥rštf
(
libuf
, "COLUMNS=%d", 
D_width
);

3904 *
Å
++ = 
libuf
;

3905 *
Å
++ = 
cobuf
;

3907 #ifdeà
SIGPIPE


3908 
	`sigÇl
(
SIGPIPE
, 
SIG_DFL
);

3910 
di¥Ïy
 = 0;

3911 
	`execv³
(*
cmdv
, cmdv, 
NewEnv
 + 3);

3912 
	`Pªic
(
”ºo
, *
cmdv
);

3916 
D_bÏnk”pid
 = 
pid
;

3917 
	`ev’q
(&
D_bÏnk”ev
);

3918 
D_blocked
 = 4;

3919 
	`CË¬AÎ
();

3920 
	}
}

	@display.h

25 #ifdeà
MAPKEYS


27 
	#KMAP_KEYS
 (
T_OCAPS
-
T_CAPS
)

	)

28 
	#KMAP_AKEYS
 (
T_OCAPS
-
T_CURSOR
)

	)

29 
	#KMAP_EXT
 50

	)

31 
	#KMAP_NOTIMEOUT
 0x4000

	)

33 
	skm­_ext


35 *
	m¡r
;

36 
	mæ
;

37 
aùiÚ
 
	mum
;

38 
aùiÚ
 
	mdm
;

39 
aùiÚ
 
	mmm
;

44 
	gwš
;

46 
	sÿnvas


48 
ÿnvas
 *
	mc_Ãxt
;

49 
di¥Ïy
 *
	mc_di¥Ïy
;

50 
v›wpÜt
 *
	mc_v¶i¡
;

51 
Ïy”
 *
	mc_Ïy”
;

52 
ÿnvas
 *
	mc_Êext
;

53 
Ïy”
 
	mc_bÏnk
;

54 
	mc_xoff
;

55 
	mc_yoff
;

56 
	mc_xs
;

57 
	mc_xe
;

58 
	mc_ys
;

59 
	mc_ye
;

60 
ev’t
 
	mc_ÿ±ev
;

63 
	sv›wpÜt


65 
v›wpÜt
 *
	mv_Ãxt
;

66 
ÿnvas
 *
	mv_ÿnvas
;

67 
	mv_xoff
;

68 
	mv_yoff
;

69 
	mv_xs
;

70 
	mv_xe
;

71 
	mv_ys
;

72 
	mv_ye
;

75 
	sdi¥Ïy


77 
di¥Ïy
 *
	md_Ãxt
;

78 
aşu£r
 *
	md_u£r
;

79 
ÿnvas
 *
	md_cvli¡
;

80 
ÿnvas
 *
	md_fÜecv
;

81 (*
	md_´oûssšput
è
__P
((*, ));

82 *
	md_´oûssšputd©a
;

83 
	md_vpxmš
, 
	md_vpxmax
;

84 
wš
 *
	md_fÜe
;

85 
wš
 *
	md_Ùh”
;

86 
	md_nÚblock
;

88 
	md_‹rmÇme
[20 + 1];

89 *
	md_‹Áry
;

90 
	md_tcš™ed
;

91 
	md_width
, 
	md_height
;

92 
	md_defwidth
, 
	md_defheight
;

93 
	md_tİ
, 
	md_bÙ
;

94 
	md_x
, 
	md_y
;

95 
mch¬
 
	md_»nd
;

96 
	md_cŞ16chªge
;

97 
	md_©yp
;

98 #ifdeà
DW_CHARS


99 
	md_mbcs
;

101 #ifdeà
ENCODINGS


102 
	md_’codšg
;

103 
	md_decode¡©e
;

104 
	md_»®fÚt
;

106 
	md_š£¹
;

107 
	md_key·d
;

108 
	md_cursÜkeys
;

109 
	md_»vvid
;

110 
	md_curvis
;

111 
	md_has_h¡©us
;

112 
	md_h¡©us
;

113 
	md_Í_missšg
;

114 
	md_mou£
;

115 #ifdeà
RXVT_OSC


116 
	md_x‹rmosc
[4];

118 
mch¬
 
	md_Ích¬
;

119 
timev®
 
	md_¡©us_time
;

120 
	md_¡©us
;

121 
	md_¡©us_b–l
;

122 
	md_¡©us_Ën
;

123 *
	md_¡©us_Ï¡msg
;

124 
	md_¡©us_buæ’
;

125 
	md_¡©us_Ï¡x
;

126 
	md_¡©us_Ï¡y
;

127 
	md_¡©us_obuæ’
;

128 
	md_¡©us_obufä“
;

129 
ev’t
 
	md_¡©u£v
;

130 
ev’t
 
	md_h¡©u£v
;

131 
	md_k¯bÏmm
;

132 
aùiÚ
 *
	md_ESC£’
;

133 
	md_u£½id
;

134 
	md_u£¹ty
[
MAXPATHLEN
];

135 
	md_u£rfd
;

136 
ev’t
 
	md_»adev
;

137 
ev’t
 
	md_wr™“v
;

138 
ev’t
 
	md_blockedev
;

139 
mode
 
	md_OldMode
;

140 
mode
 
	md_NewMode
;

141 
	md_æow
;

142 
	md_šŒc
;

143 *
	md_obuf
;

144 
	md_obuæ’
;

145 
	md_obufmax
;

146 
	md_obuæ’max
;

147 *
	md_obuå
;

148 
	md_obufä“
;

149 #ifdeà
AUTO_NUKE


150 
	md_auto_nuke
;

152 #ifdeà
MAPKEYS


153 
	md_n£qs
;

154 
	md_a£qs
;

155 *
	md_km­s
;

156 *
	md_£qp
;

157 
	md_£ql
;

158 *
	md_£qh
;

159 
ev’t
 
	md_m­ev
;

160 
	md_dÚtm­
;

161 
	md_m­deçuÉ
;

163 
tcu
 
	md_tcs
[
T_N
];

164 *
	md_©Œb
[
NATTR
];

165 
	md_©Œtyp
[
NATTR
];

166 
	md_hascŞÜ
;

167 
	md_do¥“d
;

168 #ifdeà
FONT


169 
	md_c0_b
[256];

170 ***
	md_xbË
;

172 
	md_UPco¡
, 
	md_DOco¡
, 
	md_LEco¡
, 
	md_NDco¡
;

173 
	md_CRco¡
, 
	md_IMco¡
, 
	md_EIco¡
, 
	md_NLco¡
;

174 
	md_´štfd
;

175 #ifdeà
UTMPOK


176 
¦Ù_t
 
	md_logš¦Ù
;

177 
utmp
 
	md_utmp_logš‰y
;

178 
	md_logš‰ymode
;

179 #ifdeà
_SEQUENT_


180 
	md_logšho¡
[100+1];

183 
	md_blocked
;

184 
	md_blocked_fuzz
;

185 
ev’t
 
	md_idËev
;

186 #ifdeà
BLANKER_PRG


187 
	md_bÏnk”pid
;

188 
ev’t
 
	md_bÏnk”ev
;

192 #ifdeà
MULTI


193 
	#DISPLAY
(
x
è
di¥Ïy
->
	)
x

195 
di¥Ïy
 
TheDi¥Ïy
;

196 
	#DISPLAY
(
x
è
TheDi¥Ïy
.
	)
x

199 
	#D_u£r
 
	`DISPLAY
(
d_u£r
)

	)

200 
	#D_u£ºame
 (
	`DISPLAY
(
d_u£r
è? DISPLAY(d_u£r)->
u_Çme
 : 0)

	)

201 
	#D_cvli¡
 
	`DISPLAY
(
d_cvli¡
)

	)

202 
	#D_fÜecv
 
	`DISPLAY
(
d_fÜecv
)

	)

203 
	#D_´oûssšput
 
	`DISPLAY
(
d_´oûssšput
)

	)

204 
	#D_´oûssšputd©a
 
	`DISPLAY
(
d_´oûssšputd©a
)

	)

205 
	#D_vpxmš
 
	`DISPLAY
(
d_vpxmš
)

	)

206 
	#D_vpxmax
 
	`DISPLAY
(
d_vpxmax
)

	)

207 
	#D_fÜe
 
	`DISPLAY
(
d_fÜe
)

	)

208 
	#D_Ùh”
 
	`DISPLAY
(
d_Ùh”
)

	)

209 
	#D_nÚblock
 
	`DISPLAY
(
d_nÚblock
)

	)

210 
	#D_‹rmÇme
 
	`DISPLAY
(
d_‹rmÇme
)

	)

211 
	#D_‹Áry
 
	`DISPLAY
(
d_‹Áry
)

	)

212 
	#D_tcš™ed
 
	`DISPLAY
(
d_tcš™ed
)

	)

213 
	#D_width
 
	`DISPLAY
(
d_width
)

	)

214 
	#D_height
 
	`DISPLAY
(
d_height
)

	)

215 
	#D_defwidth
 
	`DISPLAY
(
d_defwidth
)

	)

216 
	#D_defheight
 
	`DISPLAY
(
d_defheight
)

	)

217 
	#D_tİ
 
	`DISPLAY
(
d_tİ
)

	)

218 
	#D_bÙ
 
	`DISPLAY
(
d_bÙ
)

	)

219 
	#D_x
 
	`DISPLAY
(
d_x
)

	)

220 
	#D_y
 
	`DISPLAY
(
d_y
)

	)

221 
	#D_»nd
 
	`DISPLAY
(
d_»nd
)

	)

222 
	#D_cŞ16chªge
 
	`DISPLAY
(
d_cŞ16chªge
)

	)

223 
	#D_©yp
 
	`DISPLAY
(
d_©yp
)

	)

224 
	#D_mbcs
 
	`DISPLAY
(
d_mbcs
)

	)

225 
	#D_’codšg
 
	`DISPLAY
(
d_’codšg
)

	)

226 
	#D_decode¡©e
 
	`DISPLAY
(
d_decode¡©e
)

	)

227 
	#D_»®fÚt
 
	`DISPLAY
(
d_»®fÚt
)

	)

228 
	#D_š£¹
 
	`DISPLAY
(
d_š£¹
)

	)

229 
	#D_key·d
 
	`DISPLAY
(
d_key·d
)

	)

230 
	#D_cursÜkeys
 
	`DISPLAY
(
d_cursÜkeys
)

	)

231 
	#D_»vvid
 
	`DISPLAY
(
d_»vvid
)

	)

232 
	#D_curvis
 
	`DISPLAY
(
d_curvis
)

	)

233 
	#D_has_h¡©us
 
	`DISPLAY
(
d_has_h¡©us
)

	)

234 
	#D_h¡©us
 
	`DISPLAY
(
d_h¡©us
)

	)

235 
	#D_Í_missšg
 
	`DISPLAY
(
d_Í_missšg
)

	)

236 
	#D_mou£
 
	`DISPLAY
(
d_mou£
)

	)

237 
	#D_x‹rmosc
 
	`DISPLAY
(
d_x‹rmosc
)

	)

238 
	#D_Ích¬
 
	`DISPLAY
(
d_Ích¬
)

	)

239 
	#D_¡©us
 
	`DISPLAY
(
d_¡©us
)

	)

240 
	#D_¡©us_time
 
	`DISPLAY
(
d_¡©us_time
)

	)

241 
	#D_¡©us_b–l
 
	`DISPLAY
(
d_¡©us_b–l
)

	)

242 
	#D_¡©us_Ën
 
	`DISPLAY
(
d_¡©us_Ën
)

	)

243 
	#D_¡©us_Ï¡msg
 
	`DISPLAY
(
d_¡©us_Ï¡msg
)

	)

244 
	#D_¡©us_buæ’
 
	`DISPLAY
(
d_¡©us_buæ’
)

	)

245 
	#D_¡©us_Ï¡x
 
	`DISPLAY
(
d_¡©us_Ï¡x
)

	)

246 
	#D_¡©us_Ï¡y
 
	`DISPLAY
(
d_¡©us_Ï¡y
)

	)

247 
	#D_¡©us_obuæ’
 
	`DISPLAY
(
d_¡©us_obuæ’
)

	)

248 
	#D_¡©us_obufä“
 
	`DISPLAY
(
d_¡©us_obufä“
)

	)

249 
	#D_¡©u£v
 
	`DISPLAY
(
d_¡©u£v
)

	)

250 
	#D_h¡©u£v
 
	`DISPLAY
(
d_h¡©u£v
)

	)

251 
	#D_k¯bÏmm
 
	`DISPLAY
(
d_k¯bÏmm
)

	)

252 
	#D_ESC£’
 
	`DISPLAY
(
d_ESC£’
)

	)

253 
	#D_u£½id
 
	`DISPLAY
(
d_u£½id
)

	)

254 
	#D_u£¹ty
 
	`DISPLAY
(
d_u£¹ty
)

	)

255 
	#D_u£rfd
 
	`DISPLAY
(
d_u£rfd
)

	)

256 
	#D_OldMode
 
	`DISPLAY
(
d_OldMode
)

	)

257 
	#D_NewMode
 
	`DISPLAY
(
d_NewMode
)

	)

258 
	#D_æow
 
	`DISPLAY
(
d_æow
)

	)

259 
	#D_šŒ
 
	`DISPLAY
(
d_šŒ
)

	)

260 
	#D_obuf
 
	`DISPLAY
(
d_obuf
)

	)

261 
	#D_obuæ’
 
	`DISPLAY
(
d_obuæ’
)

	)

262 
	#D_obufmax
 
	`DISPLAY
(
d_obufmax
)

	)

263 
	#D_obuæ’max
 
	`DISPLAY
(
d_obuæ’max
)

	)

264 
	#D_obuå
 
	`DISPLAY
(
d_obuå
)

	)

265 
	#D_obufä“
 
	`DISPLAY
(
d_obufä“
)

	)

266 
	#D_auto_nuke
 
	`DISPLAY
(
d_auto_nuke
)

	)

267 
	#D_n£qs
 
	`DISPLAY
(
d_n£qs
)

	)

268 
	#D_a£qs
 
	`DISPLAY
(
d_a£qs
)

	)

269 
	#D_£qp
 
	`DISPLAY
(
d_£qp
)

	)

270 
	#D_£ql
 
	`DISPLAY
(
d_£ql
)

	)

271 
	#D_£qh
 
	`DISPLAY
(
d_£qh
)

	)

272 
	#D_dÚtm­
 
	`DISPLAY
(
d_dÚtm­
)

	)

273 
	#D_m­deçuÉ
 
	`DISPLAY
(
d_m­deçuÉ
)

	)

274 
	#D_km­s
 
	`DISPLAY
(
d_km­s
)

	)

275 
	#D_tcs
 
	`DISPLAY
(
d_tcs
)

	)

276 
	#D_©Œb
 
	`DISPLAY
(
d_©Œb
)

	)

277 
	#D_©Œtyp
 
	`DISPLAY
(
d_©Œtyp
)

	)

278 
	#D_hascŞÜ
 
	`DISPLAY
(
d_hascŞÜ
)

	)

279 
	#D_do¥“d
 
	`DISPLAY
(
d_do¥“d
)

	)

280 
	#D_c0_b
 
	`DISPLAY
(
d_c0_b
)

	)

281 
	#D_xbË
 
	`DISPLAY
(
d_xbË
)

	)

282 
	#D_UPco¡
 
	`DISPLAY
(
d_UPco¡
)

	)

283 
	#D_DOco¡
 
	`DISPLAY
(
d_DOco¡
)

	)

284 
	#D_LEco¡
 
	`DISPLAY
(
d_LEco¡
)

	)

285 
	#D_NDco¡
 
	`DISPLAY
(
d_NDco¡
)

	)

286 
	#D_CRco¡
 
	`DISPLAY
(
d_CRco¡
)

	)

287 
	#D_IMco¡
 
	`DISPLAY
(
d_IMco¡
)

	)

288 
	#D_EIco¡
 
	`DISPLAY
(
d_EIco¡
)

	)

289 
	#D_NLco¡
 
	`DISPLAY
(
d_NLco¡
)

	)

290 
	#D_´štfd
 
	`DISPLAY
(
d_´štfd
)

	)

291 
	#D_logš¦Ù
 
	`DISPLAY
(
d_logš¦Ù
)

	)

292 
	#D_utmp_logš‰y
 
	`DISPLAY
(
d_utmp_logš‰y
)

	)

293 
	#D_logš‰ymode
 
	`DISPLAY
(
d_logš‰ymode
)

	)

294 
	#D_logšho¡
 
	`DISPLAY
(
d_logšho¡
)

	)

295 
	#D_»adev
 
	`DISPLAY
(
d_»adev
)

	)

296 
	#D_wr™“v
 
	`DISPLAY
(
d_wr™“v
)

	)

297 
	#D_blockedev
 
	`DISPLAY
(
d_blockedev
)

	)

298 
	#D_m­ev
 
	`DISPLAY
(
d_m­ev
)

	)

299 
	#D_blocked
 
	`DISPLAY
(
d_blocked
)

	)

300 
	#D_blocked_fuzz
 
	`DISPLAY
(
d_blocked_fuzz
)

	)

301 
	#D_idËev
 
	`DISPLAY
(
d_idËev
)

	)

302 
	#D_bÏnk”ev
 
	`DISPLAY
(
d_bÏnk”ev
)

	)

303 
	#D_bÏnk”pid
 
	`DISPLAY
(
d_bÏnk”pid
)

	)

306 
	#GRAIN
 4096

	)

307 
	#OBUF_MAX
 256

	)

309 
	#OUTPUT_BLOCK_SIZE
 256

	)

311 
	#AddCh¬
(
c
) \

314 ià(--
D_obufä“
 <= 0) \

315 
	`Resize_obuf
(); \

316 *
D_obuå
++ = (
c
); \

318 0)

	)

320 
	#CV_CALL
(
cv
, 
cmd
) \

322 
di¥Ïy
 *
Şddi¥Ïy
 = display; \

323 
Ïy”
 *
Şdæay”
 = 
æay”
; \

324 
Ïy”
 *
l
 = 
cv
->
c_Ïy”
; \

325 
ÿnvas
 *
cvli¡
 = 
l
->
l_cvli¡
; \

326 
ÿnvas
 *
cvÊext
 = 
cv
->
c_Êext
; \

327 
æay”
 = 
l
; \

328 
l
->
l_cvli¡
 = 
cv
; \

329 
cv
->
c_Êext
 = 0; \

330 
cmd
; \

331 
æay”
 = 
Şdæay”
; \

332 
l
->
l_cvli¡
 = 
cvli¡
; \

333 
cv
->
c_Êext
 = 
cvÊext
; \

334 
di¥Ïy
 = 
Şddi¥Ïy
; \

335 }

	)

337 
	#STATUS_OFF
 0

	)

338 
	#STATUS_ON_WIN
 1

	)

339 
	#STATUS_ON_HS
 2

	)

341 
	#HSTATUS_IGNORE
 0

	)

342 
	#HSTATUS_LASTLINE
 1

	)

343 
	#HSTATUS_MESSAGE
 2

	)

344 
	#HSTATUS_HS
 3

	)

345 
	#HSTATUS_ALWAYS
 (1<<2)

	)

	@encoding.c

24 
	~<sys/ty³s.h
>

26 
	~"cÚfig.h
"

27 
	~"sü“n.h
"

28 
	~"ex‹º.h
"

30 #ifdeà
ENCODINGS


32 *
nuÎ
;

33 
di¥Ïy
 *di¥Ïy, *
di¥Ïys
;

34 
Ïy”
 *
æay”
;

36 *
sü“Ãncodšgs
;

38 
’cm©ch
 
__P
((*, *));

39 #ifdeà
UTF8


40 
»code_ch¬
 
__P
((, , ));

41 
»code_ch¬_to_’codšg
 
__P
((, ));

42 
comb_toäÚt
 
__P
((, ));

43 #ifdeà
DW_CHARS


44 
»code_ch¬_dw
 
__P
((, *, , ));

45 
»code_ch¬_dw_to_’codšg
 
__P
((, *, ));

49 
	s’codšg
 {

50 *
	mÇme
;

51 *
	mch¬£ts
;

52 
	mdeffÚt
;

53 
	mu£gr
;

54 
	mnoc1
;

55 *
	mfÚi¡
;

62 
’codšg
 
	g’codšgs
[] = {

86 #ifdeà
UTF8


88 
	gbutš_bs
[][2] = {

277 
	s»cod‘ab


279 (*
	mb
)[2];

280 
	mæags
;

283 
	#RECODETAB_ALLOCED
 1

	)

284 
	#RECODETAB_BUILTIN
 2

	)

285 
	#RECODETAB_TRIED
 4

	)

287 
»cod‘ab
 
	g»cod‘abs
[256];

290 
	$In™ButšTabs
()

292 (*
p
)[2];

293 
p
 = 
butš_bs
; (*p)[0];…++)

295 
»cod‘abs
[(*
p
)[0]].
æags
 = 
RECODETAB_BUILTIN
;

296 
»cod‘abs
[(*
p
)[0]].
b
 =… + 1;

297 
p
++;

298 (*
p
)[0])

299 
p
++;

301 
	}
}

304 
	$»code_ch¬
(
c
, 
to_utf
, 
fÚt
)

305 
c
, 
to_utf
, 
fÚt
;

307 
f
;

308 (*
p
)[2];

310 ià(
to_utf
)

312 ià(
c
 < 256)

313  
c
;

314 
f
 = (
c
 >> 8) & 0xff;

315 
c
 &= 0xff;

317 
f
)

320 
f
 ^= ('C' ^ '5');

323 
f
 ^= ('E' ^ '6');

326 
f
 ^= ('H' ^ '7');

331 
p
 = 
»cod‘abs
[
f
].
b
;

332 ià(
p
 =ğ0 && 
»cod‘abs
[
f
].
æags
 == 0)

334 
	`LßdFÚtT¿n¦©iÚ
(
f
, 0);

335 
p
 = 
»cod‘abs
[
f
].
b
;

337 ià(
p
)

338 ; (*
p
)[0];…++)

340 ià((
p
[0][0] & 0x8000è&& (
c
 <= (p[0][0] & 0x7fff)) && c >=…[-1][0])

341  
c
 - 
p
[-1][0] +…[-1][1];

342 ià((*
p
)[0] =ğ
c
)

343  (*
p
)[1];

345  
c
 & 0xff;

347 ià(
fÚt
 == -1)

349 ià(
c
 < 256)

350  
c
;

351 
fÚt
 = 32; font < 128; font++)

353 
p
 = 
»cod‘abs
[
fÚt
].
b
;

354 ià(
p
)

355 ; (*
p
)[1];…++)

357 ià((
p
[0][0] & 0x8000è&& 
c
 <=…[0][1] && c >=…[-1][1])

358  (
c
 - 
p
[-1][1] +…[-1][0]è| (
fÚt
 << 8);

359 ià((*
p
)[1] =ğ
c
)

360  (*
p
)[0] | (
fÚt
 << 8);

365 ià(
c
 < 128 && (
fÚt
 & 128) != 0)

366  
c
;

367 ià(
fÚt
 >= 32)

369 
p
 = 
»cod‘abs
[
fÚt
].
b
;

370 ià(
p
 =ğ0 && 
»cod‘abs
[
fÚt
].
æags
 == 0)

372 
	`LßdFÚtT¿n¦©iÚ
(
fÚt
, 0);

373 
p
 = 
»cod‘abs
[
fÚt
].
b
;

375 ià(
p
)

376 ; (*
p
)[1];…++)

378 ià((
p
[0][0] & 0x8000è&& 
c
 <=…[0][1] && c >=…[-1][1])

379  (
c
 - 
p
[-1][1] +…[-1][0]è| (
fÚt
 & 128 ? 0 : font << 8);

380 ià((*
p
)[1] =ğ
c
)

381  (*
p
)[0] | (
fÚt
 & 128 ? 0 : font << 8);

385 
	}
}

388 #ifdeà
DW_CHARS


390 
	$»code_ch¬_dw
(
c
, 
c2p
, 
to_utf
, 
fÚt
)

391 
c
, *
c2p
, 
to_utf
, 
fÚt
;

393 
f
;

394 (*
p
)[2];

396 ià(
to_utf
)

398 
f
 = (
c
 >> 8) & 0xff;

399 
c
 = (ø& 255è<< 8 | (*
c2p
 & 255);

400 *
c2p
 = 0xffff;

401 
p
 = 
»cod‘abs
[
f
].
b
;

402 ià(
p
 =ğ0 && 
»cod‘abs
[
f
].
æags
 == 0)

404 
	`LßdFÚtT¿n¦©iÚ
(
f
, 0);

405 
p
 = 
»cod‘abs
[
f
].
b
;

407 ià(
p
)

408 ; (*
p
)[0];…++)

409 ià((*
p
)[0] =ğ
c
)

411 #ifdeà
DW_CHARS


412 ià(!
	`utf8_isdoubË
((*
p
)[1]))

413 *
c2p
 = ' ';

415  (*
p
)[1];

417  
UCS_REPL_DW
;

419 ià(
fÚt
 == -1)

421 
fÚt
 = 0; font < 030; font++)

423 
p
 = 
»cod‘abs
[
fÚt
].
b
;

424 ià(
p
)

425 ; (*
p
)[1];…++)

426 ià((*
p
)[1] =ğ
c
)

428 *
c2p
 = ((*
p
)[0] & 255è| 
fÚt
 << 8 | 0x8000;

429  ((*
p
)[0] >> 8è| 
fÚt
 << 8;

432 *
c2p
 = '?';

435 ià(
fÚt
 < 32)

437 
p
 = 
»cod‘abs
[
fÚt
].
b
;

438 ià(
p
 =ğ0 && 
»cod‘abs
[
fÚt
].
æags
 == 0)

440 
	`LßdFÚtT¿n¦©iÚ
(
fÚt
, 0);

441 
p
 = 
»cod‘abs
[
fÚt
].
b
;

443 ià(
p
)

444 ; (*
p
)[1];…++)

445 ià((*
p
)[1] =ğ
c
)

447 *
c2p
 = ((*
p
)[0] & 255è| 
fÚt
 << 8 | 0x8000;

448  ((*
p
)[0] >> 8è| 
fÚt
 << 8;

452 
	}
}

456 
	$»code_ch¬_to_’codšg
(
c
, 
’codšg
)

457 
c
, 
’codšg
;

459 *
å
;

460 
x
;

462 ià(
’codšg
 =ğ
UTF8
)

463  
	`»code_ch¬
(
c
, 1, -1);

464 ià((
å
 = 
’codšgs
[
’codšg
].
fÚi¡
) != 0)

465 *
å
)

466 ià((
x
 = 
	`»code_ch¬
(
c
, 0, ()*
å
++)) != -1)

467  
x
;

468 ià(
’codšgs
[
’codšg
].
deffÚt
)

469 ià((
x
 = 
	`»code_ch¬
(
c
, 0, 
’codšgs
[
’codšg
].
deffÚt
)) != -1)

470  
x
;

471  
	`»code_ch¬
(
c
, 0, -1);

472 
	}
}

474 #ifdeà
DW_CHARS


476 
	$»code_ch¬_dw_to_’codšg
(
c
, 
c2p
, 
’codšg
)

477 
c
, *
c2p
, 
’codšg
;

479 *
å
;

480 
x
;

482 ià(
’codšg
 =ğ
UTF8
)

483  
	`»code_ch¬_dw
(
c
, 
c2p
, 1, -1);

484 ià((
å
 = 
’codšgs
[
’codšg
].
fÚi¡
) != 0)

485 *
å
)

486 ià((
x
 = 
	`»code_ch¬_dw
(
c
, 
c2p
, 0, ()*
å
++)) != -1)

487  
x
;

488 ià(
’codšgs
[
’codšg
].
deffÚt
)

489 ià((
x
 = 
	`»code_ch¬_dw
(
c
, 
c2p
, 0, 
’codšgs
[
’codšg
].
deffÚt
)) != -1)

490  
x
;

491  
	`»code_ch¬_dw
(
c
, 
c2p
, 0, -1);

492 
	}
}

496 
mch¬
 *

497 
	$»code_mch¬
(
mc
, 
äom
, 
to
)

498 
mch¬
 *
mc
;

499 
äom
, 
to
;

501 
mch¬
 
rmc
;

502 
c
;

504 
	`debug3
("»code_mch¬ %02x from %dØ%d\n", 
mc
->
image
, 
äom
, 
to
);

505 ià(
äom
 =ğ
to
 || (äom !ğ
UTF8
 &&o != UTF8))

506  
mc
;

507 
rmc
 = *
mc
;

508 ià(
rmc
.
fÚt
 =ğ0 && 
äom
 !ğ
UTF8
)

509 
rmc
.
fÚt
 = 
’codšgs
[
äom
].
deffÚt
;

510 ià(
rmc
.
fÚt
 == 0)

511  
mc
;

512 
c
 = 
rmc
.
image
 | (rmc.
fÚt
 << 8);

513 #ifdeà
DW_CHARS


514 ià(
rmc
.
mbcs
)

516 
c2
 = 
rmc
.
mbcs
;

517 
c
 = 
	`»code_ch¬_dw_to_’codšg
(c, &
c2
, 
to
);

518 
rmc
.
mbcs
 = 
c2
;

522 
c
 = 
	`»code_ch¬_to_’codšg
(c, 
to
);

523 
rmc
.
image
 = 
c
 & 255;

524 
rmc
.
fÚt
 = 
c
 >> 8 & 255;

525  &
rmc
;

526 
	}
}

528 
mlše
 *

529 
	$»code_mlše
(
ml
, 
w
, 
äom
, 
to
)

530 
mlše
 *
ml
;

531 
w
;

532 
äom
, 
to
;

534 
maxËn
;

535 
Ï¡
;

536 
mlše
 
rml
[2], *
¾
;

537 
i
, 
c
;

539 ià(
äom
 =ğ
to
 || (äom !ğ
UTF8
 &&Ø!ğUTF8è|| 
w
 == 0)

540  
ml
;

541 ià(
ml
->
fÚt
 =ğ
nuÎ
 && 
’codšgs
[
äom
].
deffÚt
 == 0)

542  
ml
;

543 ià(
w
 > 
maxËn
)

545 
i
 = 0; i < 2; i++)

547 ià(
rml
[
i
].
image
 == 0)

548 
rml
[
i
].
image
 = 
	`m®loc
(
w
);

550 
rml
[
i
].
image
 = 
	`»®loc
Ôml[i].image, 
w
);

551 ià(
rml
[
i
].
fÚt
 == 0)

552 
rml
[
i
].
fÚt
 = 
	`m®loc
(
w
);

554 
rml
[
i
].
fÚt
 = 
	`»®loc
Ôml[i].fÚt, 
w
);

555 ià(
rml
[
i
].
image
 =ğ0 ||„ml[i].
fÚt
 == 0)

557 
maxËn
 = 0;

558  
ml
;

561 
maxËn
 = 
w
;

564 
	`debug
("recode_mline: from\n");

565 
i
 = 0; i < 
w
; i++)

566 
	`debug1
("%c", "0123456789abcdef"[(
ml
->
image
[
i
] >> 4) & 15]);

567 
	`debug
("\n");

568 
i
 = 0; i < 
w
; i++)

569 
	`debug1
("%c", "0123456789abcdef"[(
ml
->
image
[
i
] ) & 15]);

570 
	`debug
("\n");

571 
i
 = 0; i < 
w
; i++)

572 
	`debug1
("%c", "0123456789abcdef"[(
ml
->
fÚt
[
i
] >> 4) & 15]);

573 
	`debug
("\n");

574 
i
 = 0; i < 
w
; i++)

575 
	`debug1
("%c", "0123456789abcdef"[(
ml
->
fÚt
[
i
] ) & 15]);

576 
	`debug
("\n");

578 
¾
 = 
rml
 + 
Ï¡
;

579 
¾
->
©Œ
 = 
ml
->attr;

580 #ifdeà
COLOR


581 
¾
->
cŞÜ
 = 
ml
->color;

582 #ifdeà
COLORS256


583 
¾
->
cŞÜx
 = 
ml
->colorx;

586 
i
 = 0; i < 
w
; i++)

588 
c
 = 
ml
->
image
[
i
] | (ml->
fÚt
[i] << 8);

589 ià(
äom
 !ğ
UTF8
 && 
c
 < 256)

590 
c
 |ğ
’codšgs
[
äom
].
deffÚt
 << 8;

591 #ifdeà
DW_CHARS


592 ià((
äom
 !ğ
UTF8
 && (
c
 & 0x1f00è!ğ0 && (ø& 0xe000è=ğ0è|| (äom =ğUTF8 && 
	`utf8_isdoubË
(c)))

594 ià(
i
 + 1 =ğ
w
)

595 
c
 = '?';

598 
c2
;

599 
i
++;

600 
c2
 = 
ml
->
image
[
i
] | (ml->
fÚt
[i] << 8);

601 
c
 = 
	`»code_ch¬_dw_to_’codšg
(c, &
c2
, 
to
);

602 
¾
->
fÚt
[
i
 - 1] = 
c
 >> 8 & 255;

603 
¾
->
image
[
i
 - 1] = 
c
 & 255;

604 
c
 = 
c2
;

609 
c
 = 
	`»code_ch¬_to_’codšg
(c, 
to
);

610 
¾
->
image
[
i
] = 
c
 & 255;

611 
¾
->
fÚt
[
i
] = 
c
 >> 8 & 255;

613 
Ï¡
 ^= 1;

614 
	`debug
("recode_mline:o\n");

615 
i
 = 0; i < 
w
; i++)

616 
	`debug1
("%c", "0123456789abcdef"[(
¾
->
image
[
i
] >> 4) & 15]);

617 
	`debug
("\n");

618 
i
 = 0; i < 
w
; i++)

619 
	`debug1
("%c", "0123456789abcdef"[(
¾
->
image
[
i
] ) & 15]);

620 
	`debug
("\n");

621 
i
 = 0; i < 
w
; i++)

622 
	`debug1
("%c", "0123456789abcdef"[(
¾
->
fÚt
[
i
] >> 4) & 15]);

623 
	`debug
("\n");

624 
i
 = 0; i < 
w
; i++)

625 
	`debug1
("%c", "0123456789abcdef"[(
¾
->
fÚt
[
i
] ) & 15]);

626 
	`debug
("\n");

627  
¾
;

628 
	}
}

630 
	scombch¬
 {

631 
	mc1
;

632 
	mc2
;

633 
	mÃxt
;

634 
	m´ev
;

636 
combch¬
 **
	gcombch¬s
;

639 
	$AddUtf8
(
c
)

640 
c
;

642 
	`ASSERT
(
D_’codšg
 =ğ
UTF8
);

643 ià(
c
 >ğ0xd800 && c < 0xe000 && 
combch¬s
 && combchars[c - 0xd800])

645 
	`AddUtf8
(
combch¬s
[
c
 - 0xd800]->
c1
);

646 
c
 = 
combch¬s
[ø- 0xd800]->
c2
;

648 ià(
c
 >= 0x800)

650 
	`AddCh¬
((
c
 & 0xf000) >> 12 | 0xe0);

651 
c
 = (c & 0x0fff) | 0x1000;

653 ià(
c
 >= 0x80)

655 
	`AddCh¬
((
c
 & 0x1fc0) >> 6 ^ 0xc0);

656 
c
 = (c & 0x3f) | 0x80;

658 
	`AddCh¬
(
c
);

659 
	}
}

662 
	$ToUtf8_comb
(
p
, 
c
)

663 *
p
;

664 
c
;

666 
l
;

668 ià(
c
 >ğ0xd800 && c < 0xe000 && 
combch¬s
 && combchars[c - 0xd800])

670 
l
 = 
	`ToUtf8_comb
(
p
, 
combch¬s
[
c
 - 0xd800]->
c1
);

671  
l
 + 
	`ToUtf8
(
p
 ?… +† : 0, 
combch¬s
[
c
 - 0xd800]->
c2
);

673  
	`ToUtf8
(
p
, 
c
);

674 
	}
}

677 
	$ToUtf8
(
p
, 
c
)

678 *
p
;

679 
c
;

681 
l
 = 1;

682 ià(
c
 >= 0x800)

684 ià(
p
)

685 *
p
++ = (
c
 & 0xf000) >> 12 | 0xe0;

686 
l
++;

687 
c
 = (c & 0x0fff) | 0x1000;

689 ià(
c
 >= 0x80)

691 ià(
p
)

692 *
p
++ = (
c
 & 0x1fc0) >> 6 ^ 0xc0;

693 
l
++;

694 
c
 = (c & 0x3f) | 0x80;

696 ià(
p
)

697 *
p
++ = 
c
;

698  
l
;

699 
	}
}

708 
	$FromUtf8
(
c
, 
utf8ch¬p
)

709 
c
, *
utf8ch¬p
;

711 
utf8ch¬
 = *
utf8ch¬p
;

712 ià(
utf8ch¬
)

714 ià((
c
 & 0xc0) != 0x80)

716 *
utf8ch¬p
 = 0;

720 
c
 = (ø& 0x3fè| (
utf8ch¬
 << 6);

721 ià(!(
utf8ch¬
 & 0x40000000))

724 ià((
c
 & 0x820823e0) == 0x80000000)

725 
c
 = 0xfdffffff;

726 ià((
c
 & 0x020821f0) == 0x02000000)

727 
c
 = 0xfff7ffff;

728 ià((
c
 & 0x000820f8) == 0x00080000)

729 
c
 = 0xffffd000;

730 ià((
c
 & 0x0000207c) == 0x00002000)

731 
c
 = 0xffffff70;

737 ià(
c
 >= 0xfe)

738 
c
 = 
UCS_REPL
;

739 ià(
c
 >= 0xfc)

740 
c
 = (c & 0x01) | 0xbffffffc;

741 ià(
c
 >= 0xf8)

742 
c
 = (c & 0x03) | 0xbfffff00;

743 ià(
c
 >= 0xf0)

744 
c
 = (c & 0x07) | 0xbfffc000;

745 ià(
c
 >= 0xe0)

746 
c
 = (c & 0x0f) | 0xbff00000;

747 ià(
c
 >= 0xc2)

748 
c
 = (c & 0x1f) | 0xfc000000;

749 ià(
c
 >= 0xc0)

750 
c
 = 0xfdffffff;

751 ià(
c
 >= 0x80)

752 
c
 = 
UCS_REPL
;

754 *
utf8ch¬p
 = 
utf8ch¬
 = (
c
 & 0x80000000) ? c : 0;

755 ià(
utf8ch¬
)

757 ià(
c
 & 0xffff0000)

758 
c
 = 
UCS_REPL
;

759 ià(
c
 >= 0xd800 && (c <= 0xdfff || c == 0xfffe || c == 0xffff))

760 
c
 = 
UCS_REPL
;

761  
c
;

762 
	}
}

766 
	$WšSw™chEncodšg
(
p
, 
’codšg
)

767 
wš
 *
p
;

768 
’codšg
;

770 
i
, 
j
, 
c
;

771 
mlše
 *
ml
;

772 
di¥Ïy
 *
d
;

773 
ÿnvas
 *
cv
;

774 
Ïy”
 *
Şdæay”
;

776 ià((
p
->
w_’codšg
 =ğ
UTF8
è=ğ(
’codšg
 == UTF8))

778 
p
->
w_’codšg
 = 
’codšg
;

781 
Şdæay”
 = 
æay”
;

782 
d
 = 
di¥Ïys
; d; d = d->
d_Ãxt
)

783 
cv
 = 
d
->
d_cvli¡
; cv; cv = cv->
c_Ãxt
)

784 ià(
p
 =ğ
	`Lay”2Wšdow
(
cv
->
c_Ïy”
))

786 
æay”
 = 
cv
->
c_Ïy”
;

787 
æay”
->
l_Ãxt
)

789 ià(
Şdæay”
 =ğ
æay”
)

790 
Şdæay”
 = 
æay”
->
l_Ãxt
;

791 
	`Ex™Ov”ÏyPage
();

794 
æay”
 = 
Şdæay”
;

795 
j
 = 0; j < 
p
->
w_height
 +…->
w_hi¡height
; j++)

797 #ifdeà
COPY_PASTE


798 
ml
 = 
j
 < 
p
->
w_height
 ? &p->
w_mlšes
[j] : &p->
w_hlšes
[j -…->w_height];

800 
ml
 = &
p
->
w_mlšes
[
j
];

802 ià(
ml
->
fÚt
 =ğ
nuÎ
 && 
’codšgs
[
p
->
w_’codšg
].
deffÚt
 == 0)

804 
i
 = 0; i < 
p
->
w_width
; i++)

806 
c
 = 
ml
->
image
[
i
] | (ml->
fÚt
[i] << 8);

807 ià(
p
->
w_’codšg
 !ğ
UTF8
 && 
c
 < 256)

808 
c
 |ğ
’codšgs
[
p
->
w_’codšg
].
deffÚt
 << 8;

809 ià(
c
 < 256)

811 ià(
ml
->
fÚt
 =ğ
nuÎ
)

813 ià((
ml
->
fÚt
 = (*)
	`m®loc
(
p
->
w_width
 + 1)) == 0)

815 
ml
->
fÚt
 = 
nuÎ
;

818 
	`bz”o
(
ml
->
fÚt
, 
p
->
w_width
 + 1);

820 #ifdeà
DW_CHARS


821 ià((
p
->
w_’codšg
 !ğ
UTF8
 && (
c
 & 0x1f00è!ğ0 && (ø& 0xe000è=ğ0è|| (p->w_’codšg =ğUTF8 && 
	`utf8_isdoubË
(c)))

823 ià(
i
 + 1 =ğ
p
->
w_width
)

824 
c
 = '?';

827 
c2
;

828 
i
++;

829 
c2
 = 
ml
->
image
[
i
] | (ml->
fÚt
[i] << 8);

830 
c
 = 
	`»code_ch¬_dw_to_’codšg
(c, &
c2
, 
’codšg
);

831 
ml
->
fÚt
[
i
 - 1] = 
c
 >> 8 & 255;

832 
ml
->
image
[
i
 - 1] = 
c
 & 255;

833 
c
 = 
c2
;

838 
c
 = 
	`»code_ch¬_to_’codšg
(c, 
’codšg
);

839 
ml
->
image
[
i
] = 
c
 & 255;

840 
ml
->
fÚt
[
i
] = 
c
 >> 8 & 255;

843 
p
->
w_’codšg
 = 
’codšg
;

845 
	}
}

847 #ifdeà
DW_CHARS


849 
	$utf8_isdoubË
(
c
)

850 
c
;

853 (
c
 >= 0x1100 &&

854 (
c
 <= 0x115f ||

855 (
c
 >= 0x2e80 && c <= 0xa4cf && (c & ~0x0011) != 0x300a &&

856 
c
 != 0x303f) ||

857 (
c
 >= 0xac00 && c <= 0xd7a3) ||

858 (
c
 >= 0xdf00 && c <= 0xdfff) ||

859 (
c
 >= 0xf900 && c <= 0xfaff) ||

860 (
c
 >= 0xfe30 && c <= 0xfe6f) ||

861 (
c
 >= 0xff00 && c <= 0xff5f) ||

862 (
c
 >= 0xffe0 && c <= 0xffe6) ||

863 (
c
 >= 0x20000 && c <= 0x2ffff)));

864 
	}
}

868 
	$utf8_iscomb
(
c
)

869 
c
;

873 
fœ¡
;

874 
Ï¡
;

875 } 
combššg
[] = {

913 
mid
, 
mš
 = 0, 
max
 = (
combššg
)/(*combining) - 1;

915 ià(
c
 < 0x0300 || c > 0xfffb)

917 
max
 >ğ
mš
)

919 
mid
 = (
mš
 + 
max
) / 2;

920 ià(
c
 > 
combššg
[
mid
].
Ï¡
)

921 
mš
 = 
mid
 + 1;

922 ià(
c
 < 
combššg
[
mid
].
fœ¡
)

923 
max
 = 
mid
 - 1;

928 
	}
}

931 
	$comb_toäÚt
(
roÙ
, 
i
)

932 
roÙ
, 
i
;

936 
	`debug1
("bršgØäÚt: %x\n", 
i
);

937 
combch¬s
[combch¬s[
i
]->
´ev
]->
Ãxt
 = combchars[i]->next;

938 
combch¬s
[combch¬s[
i
]->
Ãxt
]->
´ev
 = combchars[i]->prev;

939 
combch¬s
[
i
]->
Ãxt
 = combch¬s[
roÙ
]->next;

940 
combch¬s
[
i
]->
´ev
 = 
roÙ
;

941 
combch¬s
[combch¬s[
roÙ
]->
Ãxt
]->
´ev
 = 
i
;

942 
combch¬s
[
roÙ
]->
Ãxt
 = 
i
;

943 
i
 = 
combch¬s
[i]->
c1
;

944 ià(
i
 < 0xd800 || i >= 0xe000)

946 
i
 -= 0xd800;

948 
	}
}

951 
	$utf8_hªdË_comb
(
c
, 
mc
)

952 
c
;

953 
mch¬
 *
mc
;

955 
roÙ
, 
i
, 
c1
;

956 
isdoubË
;

958 
c1
 = 
mc
->
image
 | (mc->
fÚt
 << 8);

959 
isdoubË
 = 
c1
 >ğ0x1100 && 
	`utf8_isdoubË
(c1);

960 ià(!
combch¬s
)

962 
combch¬s
 = (
combch¬
 **)
	`m®loc
((combchar *) * 0x802);

963 ià(!
combch¬s
)

965 
	`bz”o
((*)
combch¬s
, (
combch¬
 *) * 0x802);

966 
combch¬s
[0x800] = (
combch¬
 *)
	`m®loc
((combchar));

967 
combch¬s
[0x801] = (
combch¬
 *)
	`m®loc
((combchar));

968 ià(!
combch¬s
[0x800] || !combchars[0x801])

970 ià(
combch¬s
[0x800])

971 
	`ä“
(
combch¬s
[0x800]);

972 ià(
combch¬s
[0x801])

973 
	`ä“
(
combch¬s
[0x801]);

974 
	`ä“
(
combch¬s
);

977 
combch¬s
[0x800]->
c1
 = 0x000;

978 
combch¬s
[0x800]->
c2
 = 0x700;

979 
combch¬s
[0x800]->
Ãxt
 = 0x800;

980 
combch¬s
[0x800]->
´ev
 = 0x800;

981 
combch¬s
[0x801]->
c1
 = 0x700;

982 
combch¬s
[0x801]->
c2
 = 0x800;

983 
combch¬s
[0x801]->
Ãxt
 = 0x801;

984 
combch¬s
[0x801]->
´ev
 = 0x801;

986 
roÙ
 = 
isdoubË
 ? 0x801 : 0x800;

987 
i
 = 
combch¬s
[
roÙ
]->
c1
; i < combch¬s[roÙ]->
c2
; i++)

989 ià(!
combch¬s
[
i
])

991 ià(
combch¬s
[
i
]->
c1
 =ğc1 && combch¬s[i]->
c2
 =ğ
c
)

994 ià(
i
 =ğ
combch¬s
[
roÙ
]->
c2
)

997 ià(
c1
 >= 0xd800 && c1 < 0xe000)

998 
	`comb_toäÚt
(
roÙ
, 
c1
 - 0xd800);

999 
i
 = 
combch¬s
[
roÙ
]->
´ev
;

1000 ià(
c1
 =ğ
i
 + 0xd800)

1003 
	`debug
("utf8_handle_comp: completely full!\n");

1004 
mc
->
image
 = '?';

1005 
mc
->
fÚt
 = 0;

1010 ià(!
combch¬s
[
i
])

1012 
combch¬s
[
i
] = (
combch¬
 *)
	`m®loc
((combchar));

1013 ià(!
combch¬s
[
i
])

1015 
combch¬s
[
i
]->
´ev
 = i;

1016 
combch¬s
[
i
]->
Ãxt
 = i;

1018 
combch¬s
[
i
]->
c1
 = c1;

1019 
combch¬s
[
i
]->
c2
 = 
c
;

1020 
mc
->
image
 = 
i
 & 0xff;

1021 
mc
->
fÚt
 = (
i
 >> 8) + 0xd8;

1022 
	`debug3
("combšig ch¬ %x %x -> %x\n", 
c1
, 
c
, 
i
 + 0xd800);

1023 
	`comb_toäÚt
(
roÙ
, 
i
);

1024 
	}
}

1029 
	$WšSw™chEncodšg
(
p
, 
’codšg
)

1030 
wš
 *
p
;

1031 
’codšg
;

1033 
p
->
w_’codšg
 = 
’codšg
;

1035 
	}
}

1040 
	$’cm©ch
(
s1
, 
s2
)

1041 *
s1
;

1042 *
s2
;

1044 
c1
, 
c2
;

1047 
c1
 = ()*
s1
;

1048 ià(
c1
 >= 'A' && c1 <= 'Z')

1049 
c1
 += 'a' - 'A';

1050 ià(!(
c1
 >= 'a' && c1 <= 'z') && !(c1 >= '0' && c1 <= '9'))

1052 
s1
++;

1055 
c2
 = ()*
s2
;

1056 ià(
c2
 >= 'A' && c2 <= 'Z')

1057 
c2
 += 'a' - 'A';

1058 ià(!(
c2
 >= 'a' && c2 <= 'z') && !(c2 >= '0' && c2 <= '9'))

1060 
s2
++;

1063 ià(
c1
 !ğ
c2
)

1065 
s1
++;

1066 
s2
++;

1068 
c1
);

1070 
	}
}

1073 
	$FšdEncodšg
(
Çme
)

1074 *
Çme
;

1076 
’codšg
;

1078 
	`debug1
("FšdEncodšg %s\n", 
Çme
);

1079 ià(
Çme
 == 0 || *name == 0)

1081 ià(
	`’cm©ch
(
Çme
, "euc"))

1082 
Çme
 = "eucJP";

1083 ià(
	`’cm©ch
(
Çme
, "off") ||ƒncmatch(name, "iso8859-1"))

1085 #iâdeà
UTF8


1086 ià(
	`’cm©ch
(
Çme
, "UTF-8"))

1089 
’codšg
 = 0;ƒncodšg < ()((
’codšgs
)/(*encodings));ƒncoding++)

1090 ià(
	`’cm©ch
(
Çme
, 
’codšgs
[
’codšg
].name))

1092 #ifdeà
UTF8


1093 
	`LßdFÚtT¿n¦©iÚsFÜEncodšg
(
’codšg
);

1095  
’codšg
;

1098 
	}
}

1101 
	$EncodšgName
(
’codšg
)

1102 
’codšg
;

1104 ià(
’codšg
 >ğ()((
’codšgs
)/(*encodings)))

1106  
’codšgs
[
’codšg
].
Çme
;

1107 
	}
}

1110 
	$EncodšgDefFÚt
(
’codšg
)

1111 
’codšg
;

1113  
’codšgs
[
’codšg
].
deffÚt
;

1114 
	}
}

1117 
	$Re£tEncodšg
(
p
)

1118 
wš
 *
p
;

1120 *
c
;

1121 
’codšg
 = 
p
->
w_’codšg
;

1123 
c
 = 
’codšgs
[
’codšg
].
ch¬£ts
;

1124 ià(
c
)

1125 
	`S‘Ch¬£ts
(
p
, 
c
);

1126 #ifdeà
UTF8


1127 
	`LßdFÚtT¿n¦©iÚsFÜEncodšg
(
’codšg
);

1129 ià(
’codšgs
[
’codšg
].
u£gr
)

1131 
p
->
w_gr
 = 2;

1132 
p
->
w_FÚtE
 = 
’codšgs
[
’codšg
].
ch¬£ts
[1];

1135 
p
->
w_FÚtE
 = 0;

1136 ià(
’codšgs
[
’codšg
].
noc1
)

1137 
p
->
w_c1
 = 0;

1138 
	}
}

1141 
	$DecodeCh¬
(
c
, 
’codšg
, 
¡©•
)

1142 
c
;

1143 
’codšg
;

1144 *
¡©•
;

1146 
t
;

1148 
	`debug2
("Decodšg ch¬ %02x fÜƒncodšg %d\n", 
c
, 
’codšg
);

1149 #ifdeà
UTF8


1150 ià(
’codšg
 =ğ
UTF8
)

1151  
	`FromUtf8
(
c
, 
¡©•
);

1153 ià(
’codšg
 =ğ
SJIS
)

1155 ià(!*
¡©•
)

1157 ià((0x81 <ğ
c
 && c <= 0x9f) || (0xe0 <= c && c <= 0xef))

1159 *
¡©•
 = 
c
;

1162  
c
 | (
KANA
 << 16);

1164 
t
 = 
c
;

1165 
c
 = *
¡©•
;

1166 *
¡©•
 = 0;

1167 ià(0x40 <ğ
t
 && <= 0xfc && != 0x7f)

1169 ià(
c
 <= 0x9f) c = (c - 0x81) * 2 + 0x21;

1170 
c
 = (c - 0xc1) * 2 + 0x21;

1171 ià(
t
 <= 0x7e) -= 0x1f;

1172 ià(
t
 <= 0x9e) -= 0x20;

1173 
t
 -ğ0x7e, 
c
++;

1174  (
c
 << 8è| 
t
 | (
KANJI
 << 16);

1176  
t
;

1178 ià(
’codšg
 =ğ
EUC_JP
 ||ƒncodšg =ğ
EUC_KR
 ||ƒncodšg =ğ
EUC_CN
)

1180 ià(!*
¡©•
)

1182 ià(
c
 & 0x80)

1184 *
¡©•
 = 
c
;

1187  
c
;

1189 
t
 = 
c
;

1190 
c
 = *
¡©•
;

1191 *
¡©•
 = 0;

1192 ià(
’codšg
 =ğ
EUC_JP
)

1194 ià(
c
 == 0x8e)

1195  
t
 | (
KANA
 << 16);

1196 ià(
c
 == 0x8f)

1198 *
¡©•
 = 
t
 | (
KANJI0212
 << 8);

1202 
c
 &= 0xff7f;

1203 
t
 &= 0x7f;

1204 
c
 = c << 8 | 
t
;

1205 ià(
’codšg
 =ğ
EUC_KR
)

1206  
c
 | (3 << 16);

1207 ià(
’codšg
 =ğ
EUC_CN
)

1208  
c
 | (1 << 16);

1209 ià(
c
 & (
KANJI0212
 << 16))

1210  
c
;

1212  
c
 | (
KANJI
 << 16);

1214 ià(
’codšg
 =ğ
BIG5
 ||ƒncodšg =ğ
GBK
)

1216 ià(!*
¡©•
)

1218 ià(
c
 & 0x80)

1220 ià(
’codšg
 =ğ
GBK
 && 
c
 == 0x80)

1222 *
¡©•
 = 
c
;

1225  
c
;

1227 
t
 = 
c
;

1228 
c
 = *
¡©•
;

1229 *
¡©•
 = 0;

1230 
c
 &= 0x7f;

1231  
c
 << 8 | 
t
 | (
’codšg
 =ğ
BIG5
 ? 030 << 16 : 031 << 16);

1233  
c
 | (
’codšgs
[
’codšg
].
deffÚt
 << 16);

1234 
	}
}

1237 
	$EncodeCh¬
(
bp
, 
c
, 
’codšg
, 
fÚ
)

1238 *
bp
;

1239 
c
;

1240 
’codšg
;

1241 *
fÚ
;

1243 
t
, 
f
, 
l
;

1245 
	`debug2
("Encodšg ch¬ %02x fÜƒncodšg %d\n", 
c
, 
’codšg
);

1246 ià(
c
 =ğ-1 && 
fÚ
)

1248 ià(*
fÚ
 == 0)

1250 ià(
bp
)

1252 *
bp
++ = 033;

1253 *
bp
++ = '(';

1254 *
bp
++ = 'B';

1258 
f
 = 
c
 >> 16;

1260 #ifdeà
UTF8


1261 ià(
’codšg
 =ğ
UTF8
)

1263 ià(
f
)

1265 #ifdeà
DW_CHARS


1266 ià(
	`is_dw_fÚt
(
f
))

1268 
c2
 = 
c
 & 0xff;

1269 
c
 = (ø>> 8 & 0xffè| (
f
 << 8);

1270 
c
 = 
	`»code_ch¬_dw_to_’codšg
(c, &
c2
, 
’codšg
);

1275 
c
 = (ø& 0xffè| (
f
 << 8);

1276 
c
 = 
	`»code_ch¬_to_’codšg
(c, 
’codšg
);

1279  
	`ToUtf8
(
bp
, 
c
);

1281 ià((
c
 & 0xff00è&& 
f
 == 0)

1283 #ifdeà
DW_CHARS


1284 ià(
	`utf8_isdoubË
(
c
))

1286 
c2
 = 0xffff;

1287 
c
 = 
	`»code_ch¬_dw_to_’codšg
(c, &
c2
, 
’codšg
);

1288 
c
 = (ø<< 8è| (
c2
 & 0xff);

1293 
c
 = 
	`»code_ch¬_to_’codšg
(c, 
’codšg
);

1294 
c
 = ((c & 0xff00) << 8) | (c & 0xff);

1296 
	`debug1
("Encode: ch¬ m­³d from utf8Ø%x\n", 
c
);

1297 
f
 = 
c
 >> 16;

1300 ià(
f
 & 0x80)

1301 
f
 = 0;

1303 ià(
’codšg
 =ğ
SJIS
)

1305 ià(
f
 =ğ
KANA
)

1306 
c
 = (c & 0xff) | 0x80;

1307 ià(
f
 =ğ
KANJI
)

1309 ià(!
bp
)

1311 
t
 = 
c
 & 0xff;

1312 
c
 = (c >> 8) & 0xff;

1313 
t
 +ğ(
c
 & 1) ? ((t <= 0x5f) ? 0x1f : 0x20) : 0x7e;

1314 
c
 = (c - 0x21) / 2 + ((c < 0x5f) ? 0x81 : 0xc1);

1315 *
bp
++ = 
c
;

1316 *
bp
++ = 
t
;

1320 ià(
’codšg
 =ğ
EUC
)

1322 ià(
f
 =ğ
KANA
)

1324 ià(
bp
)

1326 *
bp
++ = 0x8e;

1327 *
bp
++ = 
c
;

1331 ià(
f
 =ğ
KANJI
)

1333 ià(
bp
)

1335 *
bp
++ = (
c
 >> 8) | 0x80;

1336 *
bp
++ = 
c
 | 0x80;

1340 ià(
f
 =ğ
KANJI0212
)

1342 ià(
bp
)

1344 *
bp
++ = 0x8f;

1345 *
bp
++ = 
c
 >> 8;

1346 *
bp
++ = 
c
;

1351 ià((
’codšg
 =ğ
EUC_KR
 && 
f
 =ğ3è|| (’codšg =ğ
EUC_CN
 && f == 1))

1353 ià(
bp
)

1355 *
bp
++ = (
c
 >> 8) | 0x80;

1356 *
bp
++ = 
c
 | 0x80;

1360 ià((
’codšg
 =ğ
BIG5
 && 
f
 =ğ030è|| (’codšg =ğ
GBK
 && f == 031))

1362 ià(
bp
)

1364 *
bp
++ = (
c
 >> 8) | 0x80;

1365 *
bp
++ = 
c
;

1369 ià(
’codšg
 =ğ
GBK
 && 
f
 =ğ0 && 
c
 == 0xa4)

1370 
c
 = 0x80;

1372 
l
 = 0;

1373 ià(
fÚ
 && 
f
 != *fontp)

1375 *
fÚ
 = 
f
;

1376 ià(
f
 && f < ' ')

1378 ià(
bp
)

1380 *
bp
++ = 033;

1381 *
bp
++ = '$';

1382 ià(
f
 > 2)

1383 *
bp
++ = '(';

1384 *
bp
++ = '@' + 
f
;

1386 
l
 +ğ
f
 > 2 ? 4 : 3;

1388 ià(
f
 < 128)

1390 ià(
f
 == 0)

1391 
f
 = 'B';

1392 ià(
bp
)

1394 *
bp
++ = 033;

1395 *
bp
++ = '(';

1396 *
bp
++ = 
f
;

1398 
l
 += 3;

1401 ià(
c
 & 0xff00)

1403 ià(
bp
)

1404 *
bp
++ = 
c
 >> 8;

1405 
l
++;

1407 ià(
bp
)

1408 *
bp
++ = 
c
;

1409  
l
 + 1;

1410 
	}
}

1413 
	$CªEncodeFÚt
(
’codšg
, 
f
)

1414 
’codšg
, 
f
;

1416 
’codšg
)

1418 #ifdeà
UTF8


1419 
UTF8
:

1422 
SJIS
:

1423  
f
 =ğ
KANJI
 || f =ğ
KANA
;

1424 
EUC
:

1425  
f
 =ğ
KANJI
 || f =ğ
KANA
 || f =ğ
KANJI0212
;

1426 
EUC_KR
:

1427  
f
 == 3;

1428 
EUC_CN
:

1429  
f
 == 1;

1430 
BIG5
:

1431  
f
 == 030;

1432 
GBK
:

1433  
f
 == 031;

1438 
	}
}

1440 #ifdeà
DW_CHARS


1442 
	$P»·»EncodedCh¬
(
c
)

1443 
c
;

1445 
’codšg
;

1446 
t
 = 0;

1447 
f
;

1449 
’codšg
 = 
D_’codšg
;

1450 
f
 = 
D_»nd
.
fÚt
;

1451 
t
 = 
D_mbcs
;

1452 ià(
’codšg
 =ğ
SJIS
)

1454 ià(
f
 =ğ
KANA
)

1455  
c
 | 0x80;

1456 ià(
f
 =ğ
KANJI
)

1458 
t
 +ğ(
c
 & 1) ? ((t <= 0x5f) ? 0x1f : 0x20) : 0x7e;

1459 
c
 = (c - 0x21) / 2 + ((c < 0x5f) ? 0x81 : 0xc1);

1460 
D_mbcs
 = 
t
;

1462  
c
;

1464 ià(
’codšg
 =ğ
EUC
)

1466 ià(
f
 =ğ
KANA
)

1468 
	`AddCh¬
(0x8e);

1469  
c
 | 0x80;

1471 ià(
f
 =ğ
KANJI
)

1473 
D_mbcs
 = 
t
 | 0x80;

1474  
c
 | 0x80;

1476 ià(
f
 =ğ
KANJI0212
)

1478 
	`AddCh¬
(0x8f);

1479 
D_mbcs
 = 
t
 | 0x80;

1480  
c
 | 0x80;

1483 ià((
’codšg
 =ğ
EUC_KR
 && 
f
 =ğ3è|| (’codšg =ğ
EUC_CN
 && f == 1))

1485 
D_mbcs
 = 
t
 | 0x80;

1486  
c
 | 0x80;

1488 ià((
’codšg
 =ğ
BIG5
 && 
f
 =ğ030è|| (’codšg =ğ
GBK
 && f == 031))

1489  
c
 | 0x80;

1490  
c
;

1491 
	}
}

1495 
	$RecodeBuf
(
fbuf
, 
æ’
, 
ãnc
, 
‹nc
, 
tbuf
)

1496 *
fbuf
;

1497 
æ’
;

1498 
ãnc
, 
‹nc
;

1499 *
tbuf
;

1501 
c
, 
i
, 
j
;

1502 
dec¡©e
 = 0, 
fÚt
 = 0;

1504 
i
 = 
j
 = 0; i < 
æ’
; i++)

1506 
c
 = 
fbuf
[
i
];

1507 
c
 = 
	`DecodeCh¬
(c, 
ãnc
, &
dec¡©e
);

1508 ià(
c
 == -2)

1509 
i
--;

1510 ià(
c
 < 0)

1512 
j
 +ğ
	`EncodeCh¬
(
tbuf
 ? (*ébuà+ j : 0, 
c
, 
‹nc
, &
fÚt
);

1514 
j
 +ğ
	`EncodeCh¬
(
tbuf
 ? (*ébuà+ j : 0, -1, 
‹nc
, &
fÚt
);

1515  
j
;

1516 
	}
}

1518 #ifdeà
UTF8


1520 
	$CÚšsS³cŸlDeffÚt
(
ml
, 
xs
, 
xe
, 
’codšg
)

1521 
mlše
 *
ml
;

1522 
xs
, 
xe
;

1523 
’codšg
;

1525 *
f
, *
i
;

1526 
c
, 
x
, 
dx
;

1528 ià(
’codšg
 =ğ
UTF8
 || 
’codšgs
[’codšg].
deffÚt
 == 0)

1530 
i
 = 
ml
->
image
 + 
xs
;

1531 
f
 = 
ml
->
fÚt
 + 
xs
;

1532 
dx
 = 
xe
 - 
xs
 + 1;

1533 
dx
-- > 0)

1535 ià(*
f
++)

1537 
c
 = *
i
++;

1538 
x
 = 
	`»code_ch¬_to_’codšg
(
c
 | (
’codšgs
[
’codšg
].
deffÚt
 << 8), 
UTF8
);

1539 ià(
c
 !ğ
x
)

1541 
	`debug2
("CÚšsS³cŸlDeffÚt: ye %02x !ğ%02x\n", 
c
, 
x
);

1545 
	`debug
("ContainsSpecialDeffont:‚o\n");

1547 
	}
}

1551 
	$LßdFÚtT¿n¦©iÚ
(
fÚt
, 
fe
)

1552 
fÚt
;

1553 *
fe
;

1555 
buf
[1024], *
myfe
;

1556 
FILE
 *
f
;

1557 
i
;

1558 
fo
;

1559 
x
, 
u
, 
c
, 
ok
;

1560 (*
p
)[2], (*
b
)[2];

1562 
myfe
 = 
fe
;

1563 ià(
myfe
 == 0)

1565 ià(
fÚt
 =ğ0 || 
sü“Ãncodšgs
 == 0)

1567 ià(
	`¡¾’
(
sü“Ãncodšgs
è> (
buf
) - 10)

1569 
	`¥rštf
(
buf
, "%s/%02x", 
sü“Ãncodšgs
, 
fÚt
 & 0xff);

1570 
myfe
 = 
buf
;

1572 
	`debug1
("LßdFÚtT¿n¦©iÚ:ryšg %s\n", 
myfe
);

1573 ià((
f
 = 
	`£cfİ’
(
myfe
, "r")) == 0)

1575 
i
 = 
ok
 = 0;

1578 ; 
i
 < 12; i++)

1579 ià(
	`g‘c
(
f
è!ğ"Sü“nI2UTF8"[
i
])

1581 ià(
	`g‘c
(
f
) != 0)

1583 
fo
 = 
	`g‘c
(
f
);

1584 ià(
fo
 =ğ
EOF
)

1586 ià(
fÚt
 !ğ-1 && fÚˆ!ğ
fo
)

1588 
i
 = 
	`g‘c
(
f
);

1589 
x
 = 
	`g‘c
(
f
);

1590 ià(
x
 =ğ
EOF
)

1592 
i
 = i << 8 | 
x
;

1593 
	`g‘c
(
f
);

1594 (
x
 = 
	`g‘c
(
f
)è&& x !ğ
EOF
)

1595 
	`g‘c
(
f
);

1596 ià((
p
 = 
	`m®loc
((*pè* (
i
 + 1))) == 0)

1598 
b
 = 
p
;

1599 
i
 > 0)

1601 
x
 = 
	`g‘c
(
f
);

1602 
x
 = x << 8 | 
	`g‘c
(
f
);

1603 
u
 = 
	`g‘c
(
f
);

1604 
c
 = 
	`g‘c
(
f
);

1605 
u
 = u << 8 | 
c
;

1606 ià(
c
 =ğ
EOF
)

1608 (*
p
)[0] = 
x
;

1609 (*
p
)[1] = 
u
;

1610 
p
++;

1611 
i
--;

1613 (*
p
)[0] = 0;

1614 (*
p
)[1] = 0;

1615 ià(
i
 || (
b
[0][0] & 0x8000))

1617 
	`ä“
(
b
);

1620 ià(
»cod‘abs
[
fo
].
b
 && (»cod‘abs[fo].
æags
 & 
RECODETAB_ALLOCED
) != 0)

1621 
	`ä“
(
»cod‘abs
[
fo
].
b
);

1622 
»cod‘abs
[
fo
].
b
 =ab;

1623 
»cod‘abs
[
fo
].
æags
 = 
RECODETAB_ALLOCED
;

1624 
	`debug1
("SucûssfuÈlßd oà»cod‘ab %02x\n", 
fo
);

1625 
c
 = 
	`g‘c
(
f
);

1626 ià(
c
 =ğ
EOF
)

1628 
ok
 = 1;

1631 ià(
c
 != 'S')

1633 
i
 = 1;

1635 
	`fşo£
(
f
);

1636 ià(
fÚt
 !ğ-1 && 
fe
 =ğ0 && 
»cod‘abs
[fÚt].
æags
 == 0)

1637 
»cod‘abs
[
fÚt
].
æags
 = 
RECODETAB_TRIED
;

1638  
ok
 ? 0 : -1;

1639 
	}
}

1642 
	$LßdFÚtT¿n¦©iÚsFÜEncodšg
(
’codšg
)

1643 
’codšg
;

1645 *
c
;

1646 
f
;

1648 
	`debug1
("LßdFÚtT¿n¦©iÚsFÜEncodšg:ƒncodšg %d\n", 
’codšg
);

1649 ià((
c
 = 
’codšgs
[
’codšg
].
fÚi¡
) != 0)

1650 (
f
 = ()*
c
++) != 0)

1651 ià(
»cod‘abs
[
f
].
æags
 == 0)

1652 
	`LßdFÚtT¿n¦©iÚ
(
f
, 0);

1653 
f
 = 
’codšgs
[
’codšg
].
deffÚt
;

1654 ià(
f
 > 0 && 
»cod‘abs
[f].
æags
 == 0)

1655 
	`LßdFÚtT¿n¦©iÚ
(
f
, 0);

1656 
	}
}

1666 
	$EncodeCh¬
(
bp
, 
c
, 
’codšg
, 
fÚ
)

1667 *
bp
;

1668 
c
;

1669 
’codšg
;

1670 *
fÚ
;

1672 
f
, 
l
;

1673 
f
 = (
c
 == -1) ? 0 : c >> 16;

1674 
l
 = 0;

1675 ià(
fÚ
 && 
f
 != *fontp)

1677 *
fÚ
 = 
f
;

1678 ià(
f
 && f < ' ')

1680 ià(
bp
)

1682 *
bp
++ = 033;

1683 *
bp
++ = '$';

1684 ià(
f
 > 2)

1685 *
bp
++ = '(';

1686 *
bp
++ = '@' + 
f
;

1688 
l
 +ğ
f
 > 2 ? 4 : 3;

1690 ià(
f
 < 128)

1692 ià(
f
 == 0)

1693 
f
 = 'B';

1694 ià(
bp
)

1696 *
bp
++ = 033;

1697 *
bp
++ = '(';

1698 *
bp
++ = 
f
;

1700 
l
 += 3;

1703 ià(
c
 == -1)

1704  
l
;

1705 ià(
c
 & 0xff00)

1707 ià(
bp
)

1708 *
bp
++ = 
c
 >> 8;

1709 
l
++;

1711 ià(
bp
)

1712 *
bp
++ = 
c
;

1713  
l
 + 1;

1714 
	}
}

	@extern.h

25 #ià!
defšed
(
__GNUC__
) || __GNUC__ < 2

26 #undeà
__©Œibu‹__


27 
	#__©Œibu‹__
(
x
)

	)

31 
maš
 
__P
((, **));

32 
sig»t_t
 
SigHup
 
__P
(
SIGPROTOARG
);

33 
“x™
 
__P
(());

34 
D‘ach
 
__P
(());

35 
Hªgup
 
__P
(());

36 
Kl
 
__P
((, ));

37 #ifdeà
USEVARARGS


38 
Msg
 
__P
((, *, ...)è
__©Œibu‹__
((
fÜm©
(
´štf
, 2, 3)));

39 
Pªic
 
__P
((, *, ...)è
__©Œibu‹__
((
fÜm©
(
´štf
, 2, 3)));

41 
Msg
 
__P
(());

42 
Pªic
 
__P
(());

44 
Fš™
 
__P
(());

45 
MakeNewEnv
 
__P
(());

46 *
MakeWšMsg
 
__P
((*, 
wš
 *, ));

47 *
MakeWšMsgEv
 
__P
((*, 
wš
 *, , , 
ev’t
 *, ));

48 
PutWšMsg
 
__P
((*, , ));

49 
WšdowD›d
 
__P
((
wš
 *));

50 
£tbacktick
 
__P
((, , , **));

53 
Re£tAnsiS‹
 
__P
((
wš
 *));

54 
Re£tWšdow
 
__P
((
wš
 *));

55 
Re£tCh¬£ts
 
__P
((
wš
 *));

56 
Wr™eSŒšg
 
__P
((
wš
 *, *, ));

57 
ChªgeAKA
 
__P
((
wš
 *, *, ));

58 
S‘Ch¬£ts
 
__P
((
wš
 *, *));

59 
G‘AnsiStus
 
__P
((
wš
 *, *));

60 
WNewAutoFlow
 
__P
((
wš
 *, ));

61 
WB–l
 
__P
((
wš
 *, ));

62 
WMsg
 
__P
((
wš
 *, , *));

63 
WChªgeSize
 
__P
((
wš
 *, , ));

64 
WšdowChªged
 
__P
((
wš
 *, ));

65 
MFšdU£dLše
 
__P
((
wš
 *, , ));

68 
S¹Rc
 
__P
((*));

69 
FšishRc
 
__P
((*));

70 
RcLše
 
__P
((*, ));

71 
FILE
 *
£cfİ’
 
__P
((*, *));

72 
£cİ’
 
__P
((*, , ));

73 
Wr™eFe
 
__P
((
aşu£r
 *, *, ));

74 *
R—dFe
 
__P
((*, *));

75 
KlBufãrs
 
__P
(());

76 
´še
 
__P
((
wš
 *, *));

77 
»adpe
 
__P
((**));

78 
RunBÏnk”
 
__P
((**));

79 
do_sourû
 
__P
((*));

82 
O³nTTY
 
__P
((*, *));

83 
In™TTY
 
__P
((
mode
 *, ));

84 
G‘TTY
 
__P
((, 
mode
 *));

85 
S‘TTY
 
__P
((, 
mode
 *));

86 
S‘Mode
 
__P
((
mode
 *, mode *, , ));

87 
S‘Flow
 
__P
(());

88 
S’dB»ak
 
__P
((
wš
 *, , ));

89 
TtyG¿bCÚsŞe
 
__P
((, , *));

90 *
TtyG‘ModemStus
 
__P
((, *));

91 #ifdeà
DEBUG


92 
DebugTTY
 
__P
((
mode
 *));

94 
fg‰y
 
__P
(());

95 
brk‰y
 
__P
(());

96 
baud_v®ues
 *
lookup_baud
 
__P
((
bps
));

97 
S‘Baud
 
__P
((
mode
 *, , ));

98 
S‰yMode
 
__P
((
mode
 *, *));

102 
G‘Hi¡Üy
 
__P
(());

103 
M¬kRoutše
 
__P
(());

104 
»vto_lše
 
__P
((, , ));

105 
»vto
 
__P
((, ));

106 
InM¬k
 
__P
(());

107 
MakePa¡”
 
__P
((
·¡”
 *, *, , ));

108 
F»ePa¡”
 
__P
((
·¡”
 *));

111 
S—rch
 
__P
(());

112 
IS—rch
 
__P
(());

115 
šp_£rom±
 
__P
((*, *));

116 
IÅut
 
__P
((*, , , (*)(*, , *), *));

117 
InIÅut
 
	`__P
(());

120 
ex™_w™h_u§ge
 
	`__P
((*, *, *));

121 
di¥Ïy_h–p
 
	`__P
((*, 
aùiÚ
 *));

122 
di¥Ïy_cİyright
 
	`__P
(());

123 
di¥Ïy_di¥Ïys
 
	`__P
(());

124 
di¥Ïy_bšdkey
 
	`__P
((*, 
aùiÚ
 *));

125 
di¥Ïy_wli¡
 
	`__P
((, ));

126 
InWLi¡
 
	`__P
(());

127 
WLi¡Upd©ecv
 
	`__P
((
ÿnvas
 *, 
wš
 *));

128 
WLi¡LškChªged
 
	`__P
(());

129 #ifdeà
ZMODEM


130 
ZmodemPage
 
	`__P
(());

134 
MakeWšdow
 
	`__P
((
NewWšdow
 *));

135 
RemakeWšdow
 
	`__P
((
wš
 *));

136 
F»eWšdow
 
	`__P
((
wš
 *));

137 #ifdeà
PSEUDOS


138 
wšexec
 
	`__P
((**));

139 
F»eP£udowš
 
	`__P
((
wš
 *));

141 
nwš_compo£
 
	`__P
((
NewWšdow
 *, NewWindow *, NewWindow *));

142 
DoS¹Log
 
	`__P
((
wš
 *, *, ));

143 
R–—£AutoWr™–ock
 
	`__P
((
di¥Ïy
 *, 
wš
 *));

144 
ObšAutoWr™–ock
 
	`__P
((
di¥Ïy
 *, 
wš
 *));

145 
Clo£Deviû
 
	`__P
((
wš
 *));

146 #ifdeà
ZMODEM


147 
zmodem_abÜt
 
	`__P
((
wš
 *, 
di¥Ïy
 *));

149 
execv³
 
	`__P
((*, **, **));

152 #ifdeà
UTMPOK


153 
In™Utmp
 
	`__P
(());

154 
RemoveLogšSlÙ
 
	`__P
(());

155 
Re¡ÜeLogšSlÙ
 
	`__P
(());

156 
S‘Utmp
 
	`__P
((
wš
 *));

157 
RemoveUtmp
 
	`__P
((
wš
 *));

159 
SlÙToggË
 
	`__P
(());

160 #ifdeà
USRLIMIT


161 
CouÁU£rs
 
	`__P
(());

163 #ifdeà
CAREFULUTMP


164 
C¬efulUtmp
 
	`__P
(());

166 
	#C¬efulUtmp
(è

	)

171 #ifdeà
LOADAV


172 
In™Lßdav
 
	`__P
(());

173 
AddLßdav
 
	`__P
((*));

177 
O³nPTY
 
	`__P
((**));

178 
In™PTY
 
	`__P
(());

181 
In™Keyb
 
	`__P
(());

182 
ProûssIÅut
 
	`__P
((*, ));

183 #ifdeà
MAPKEYS


184 
ProûssIÅut2
 
	`__P
((*, ));

186 
DoProûss
 
	`__P
((
wš
 *, **, *, 
·¡”
 *));

187 
DoAùiÚ
 
	`__P
((
aùiÚ
 *, ));

188 
FšdCommÄ
 
	`__P
((*));

189 
DoCommªd
 
	`__P
((**, *));

190 
Aùiv©e
 
	`__P
(());

191 
KlWšdow
 
	`__P
((
wš
 *));

192 
S‘FÜeWšdow
 
	`__P
((
wš
 *));

193 
P¬£
 
	`__P
((*, , **, *));

194 
S‘Esÿ³
 
	`__P
((
aşu£r
 *, , ));

195 
DoSü“n
 
	`__P
((*, **));

196 
IsNumCŞÚ
 
	`__P
((*, , *, ));

197 
ShowWšdows
 
	`__P
(());

198 *
AddWšdows
 
	`__P
((*, , , ));

199 *
AddWšdowFÏgs
 
	`__P
((*, , 
wš
 *));

200 *
AddOth”U£rs
 
	`__P
((*, , 
wš
 *));

201 
WšdowByNoN
 
	`__P
((*));

202 
wš
 *
FšdNiûWšdow
 
	`__P
((win *, *));

203 #ifdeà
COPY_PASTE


204 
CompeKeys
 
	`__P
((*, , *));

206 #ifdeà
RXVT_OSC


207 
ReäeshX‹rmOSC
 
	`__P
(());

209 
P¬£SaveSŒ
 
	`__P
((
aùiÚ
 *
aù
, **));

210 
P¬£Num
 
	`__P
((
aùiÚ
 *
aù
, *));

211 
P¬£Sw™ch
 
	`__P
((
aùiÚ
 *, *));

212 
P¬£A‰rCŞÜ
 
	`__P
((*, *, ));

213 
AµlyA‰rCŞÜ
 
	`__P
((, 
mch¬
 *));

214 
Sw™chWšdow
 
	`__P
(());

215 
StuffKey
 
	`__P
(());

218 
In™T”mÿp
 
	`__P
((, ));

219 *
MakeT”mÿp
 
	`__P
(());

220 *
g‘‹rmÿp¡ršg
 
	`__P
((*));

221 #ifdeà
MAPKEYS


222 
»m­
 
	`__P
((, ));

223 
CheckEsÿ³
 
	`__P
(());

225 
C»©eT¿nsTabË
 
	`__P
((*));

226 
F»eT¿nsTabË
 
	`__P
(());

229 
A‰ach
 
	`__P
(());

230 
A‰ach”
 
	`__P
(());

231 
sig»t_t
 
A‰ach”Fš™
 
	`__P
(
SIGPROTOARG
);

232 
S’dCmdMes§ge
 
	`__P
((*, *, **));

235 
di¥Ïy
 *
MakeDi¥Ïy
 
	`__P
((*, *, *, , , 
mode
 *));

236 
F»eDi¥Ïy
 
	`__P
(());

237 
DefProûss
 
	`__P
((**, *));

238 
DefRedi¥ÏyLše
 
	`__P
((, , , ));

239 
DefCË¬Lše
 
	`__P
((, , , ));

240 
DefRewr™e
 
	`__P
((, , , 
mch¬
 *, ));

241 
DefResize
 
	`__P
((, ));

242 
DefRe¡Üe
 
	`__P
(());

243 
AddCSŒ
 
	`__P
((*));

244 
AddCSŒ2
 
	`__P
((*, ));

245 
In™T”m
 
	`__P
(());

246 
Fš™T”m
 
	`__P
(());

247 
PUTCHAR
 
	`__P
(());

248 
PUTCHARLP
 
	`__P
(());

249 
CË¬AÎ
 
	`__P
(());

250 
CË¬A»a
 
	`__P
((, , , , , , , ));

251 
CË¬Lše
 
	`__P
((
mlše
 *, , , , ));

252 
ReäeshAÎ
 
	`__P
(());

253 
ReäeshA»a
 
	`__P
((, , , , ));

254 
ReäeshLše
 
	`__P
((, , , ));

255 
Redi¥Ïy
 
	`__P
(());

256 
Redi¥ÏyDi¥Ïys
 
	`__P
(());

257 
ShowHStus
 
	`__P
((*));

258 
ReäeshHStus
 
	`__P
(());

259 
Di¥ÏyLše
 
	`__P
((
mlše
 *, mline *, , , ));

260 
GÙoPos
 
	`__P
((, ));

261 
C®cCo¡
 
	`__P
((*));

262 
SüŞlH
 
	`__P
((, , , , , 
mlše
 *));

263 
SüŞlV
 
	`__P
((, , , , , ));

264 
PutCh¬
 
	`__P
((
mch¬
 *, , ));

265 
InsCh¬
 
	`__P
((
mch¬
 *, , , , 
mlše
 *));

266 
W¿pCh¬
 
	`__P
((
mch¬
 *, , , , , , , ));

267 
ChªgeSüŞlRegiÚ
 
	`__P
((, ));

268 
In£¹Mode
 
	`__P
(());

269 
Key·dMode
 
	`__P
(());

270 
CursÜkeysMode
 
	`__P
(());

271 
Rev”£Video
 
	`__P
(());

272 
CursÜVisib™y
 
	`__P
(());

273 
Mou£Mode
 
	`__P
(());

274 
S‘FÚt
 
	`__P
(());

275 
S‘A‰r
 
	`__P
(());

276 
S‘CŞÜ
 
	`__P
((, ));

277 
S‘R’d™iÚ
 
	`__P
((
mch¬
 *));

278 
S‘R’d™iÚMlše
 
	`__P
((
mlše
 *, ));

279 
MakeStus
 
	`__P
((*));

280 
RemoveStus
 
	`__P
(());

281 
ResizeDi¥Ïy
 
	`__P
((, ));

282 
AddSŒ
 
	`__P
((*));

283 
AddSŒn
 
	`__P
((*, ));

284 
Flush
 
	`__P
(());

285 
ä“‰y
 
	`__P
(());

286 
Resize_obuf
 
	`__P
(());

287 #ifdeà
AUTO_NUKE


288 
NukeP’dšg
 
	`__P
(());

290 
S‘CªvasWšdow
 
	`__P
((
ÿnvas
 *, 
wš
 *));

291 
MakeDeçuÉCªvas
 
	`__P
(());

292 
AddCªvas
 
	`__P
(());

293 
RemCªvas
 
	`__P
(());

294 
OÃCªvas
 
	`__P
(());

295 
R‘hškDi¥ÏyV›wpÜts
 
	`__P
(());

296 
R‘hškV›wpÜtOff£ts
 
	`__P
((
ÿnvas
 *));

297 #ifdeà
RXVT_OSC


298 
CË¬AÎX‹rmOSC
 
	`__P
(());

299 
S‘X‹rmOSC
 
	`__P
((, *));

301 #ifdeà
COLOR


302 
cŞÜ256to16
 
	`__P
(());

303 #ifdeà
COLORS256


304 
cŞÜ256to88
 
	`__P
(());

307 
Re£tIdË
 
	`__P
(());

308 
KlBÏnk”
 
	`__P
(());

309 
Di¥ÏySË•1000
 
	`__P
((, ));

312 
ChªgeWšdowSize
 
	`__P
((
wš
 *, , , ));

313 
ChªgeSü“nSize
 
	`__P
((, , ));

314 
CheckSü“nSize
 
	`__P
(());

315 *
x»®loc
 
	`__P
((*, ));

316 
ResizeLay”sToCªva£s
 
	`__P
(());

317 
ResizeLay”
 
	`__P
((
Ïy”
 *, , , 
di¥Ïy
 *));

318 
MayResizeLay”
 
	`__P
((
Ïy”
 *));

319 
F»eAÉSü“n
 
	`__P
((
wš
 *));

320 
EÁ”AÉSü“n
 
	`__P
((
wš
 *));

321 
L—veAÉSü“n
 
	`__P
((
wš
 *));

324 
ev’q
 
	`__P
((
ev’t
 *));

325 
evdeq
 
	`__P
((
ev’t
 *));

326 
S‘Timeout
 
	`__P
((
ev’t
 *, ));

327 
sched
 
	`__P
(());

330 
FšdSock‘
 
	`__P
((*, *, *, *));

331 
MakeCl›ÁSock‘
 
	`__P
(());

332 
MakeS”v”Sock‘
 
	`__P
(());

333 
Recov”Sock‘
 
	`__P
(());

334 
chsock
 
	`__P
(());

335 
ReûiveMsg
 
	`__P
(());

336 
S’dC»©eMsg
 
	`__P
((*, 
NewWšdow
 *));

337 
S’dE¼ÜMsg
 
	`__P
((*, *));

340 *
SaveSŒ
 
	`__P
((const *));

341 *
SaveSŒn
 
	`__P
((const *, ));

342 *
InSŒ
 
	`__P
((*, const *));

343 #iâdeà
HAVE_STRERROR


344 *
¡»¼Ü
 
	`__P
(());

346 
ûÁ”lše
 
	`__P
((*, ));

347 
Ëálše
 
	`__P
((*, ));

348 *
F’ame
 
	`__P
((*));

349 *
¡rdev
 
	`__P
((*));

350 #ifdeà
NEED_OWN_BCOPY


351 
xbcİy
 
	`__P
((*, *, ));

353 
bş—r
 
	`__P
((*, ));

354 
şo£®lfes
 
	`__P
(());

355 
U£rCÚ‹xt
 
	`__P
(());

356 
U£rR‘uº
 
	`__P
(());

357 
U£rStus
 
	`__P
(());

358 #ià
	`defšed
(
POSIX
è|| defšed(
hpux
)

359 (*
xsigÇl
 
	`__P
((, (*)
SIGPROTOARG
))) __P(SIGPROTOARG);

361 #iâdeà
HAVE_RENAME


362 
»Çme
 
	`__P
((*, *));

364 #ià
	`defšed
(
HAVE_SETEUID
è|| defšed(
HAVE_SETREUID
)

365 
x£‹uid
 
	`__P
(());

366 
x£‹gid
 
	`__P
(());

368 
AddXCh¬
 
	`__P
((*, ));

369 
AddXCh¬s
 
	`__P
((*, , *));

370 
x£‹nv
 
	`__P
((*, *));

371 
¦“p1000
 
	`__P
(());

372 #ifdeà
DEBUG


373 
İ’debug
 
	`__P
((, ));

375 #ifdeà
USEVARARGS


376 #iâdeà
HAVE_VSNPRINTF


377 
xv¢´štf
 
	`__P
((*, , *, 
va_li¡
));

380 
x¢´štf
 
	`__P
(());

385 #ifdeà
MULTIUSER


386 
AşCheckP”mWš
 
	`__P
((
aşu£r
 *, , 
wš
 *));

387 
AşCheckP”mCmd
 
	`__P
((
aşu£r
 *, , 
comm
 *));

388 
AşS‘P”m
 
	`__P
((
aşu£r
 *, acluser *, *, *));

389 
AşUmask
 
	`__P
((
aşu£r
 *, *, **));

390 
U£rsAş
 
	`__P
((
aşu£r
 *, , **));

391 
AşWšSw­
 
	`__P
((, ));

392 
NewWšdowAş
 
	`__P
((
wš
 *, 
aşu£r
 *));

393 
F»eWšdowAş
 
	`__P
((
wš
 *));

394 *
DoSu
 
	`__P
((
aşu£r
 **, *, *, *));

395 
AşLškU£r
 
	`__P
((*, *));

397 
U£rF»eCİyBufãr
 
	`__P
((
aşu£r
 *));

398 
aşu£r
 **
FšdU£rPŒ
 
	`__P
((*));

399 
U£rAdd
 
	`__P
((*, *, 
aşu£r
 **));

400 
U£rD–
 
	`__P
((*, 
aşu£r
 **));

404 #ifdeà
HAVE_BRAILLE


405 
In™B¿Ë
 
	`__P
(());

406 
ReäeshB¿Ë
 
	`__P
(());

407 
DoB¿ËAùiÚ
 
	`__P
((
aùiÚ
 *, ));

408 
BGÙoPos
 
	`__P
((
Ïy”
 *, , ));

409 
BPutCh¬
 
	`__P
((
Ïy”
 *, 
mch¬
 *, , ));

410 
BPutSŒ
 
	`__P
((
Ïy”
 *, *, , 
mch¬
 *, , ));

411 
BCDi¥ÏyLše
 
	`__P
((
Ïy”
 *, 
mlše
 *, , , , ));

418 
LGÙoPos
 
	`__P
((
Ïy”
 *, , ));

419 
LPutCh¬
 
	`__P
((
Ïy”
 *, 
mch¬
 *, , ));

420 
LInsCh¬
 
	`__P
((
Ïy”
 *, 
mch¬
 *, , , 
mlše
 *));

421 
LPutSŒ
 
	`__P
((
Ïy”
 *, *, , 
mch¬
 *, , ));

422 
LPutWšMsg
 
	`__P
((
Ïy”
 *, *, , 
mch¬
 *, , ));

423 
LSüŞlH
 
	`__P
((
Ïy”
 *, , , , , , 
mlše
 *));

424 
LSüŞlV
 
	`__P
((
Ïy”
 *, , , , ));

425 
LCË¬AÎ
 
	`__P
((
Ïy”
 *, ));

426 
LCË¬A»a
 
	`__P
((
Ïy”
 *, , , , , , ));

427 
LCË¬Lše
 
	`__P
((
Ïy”
 *, , , , , 
mlše
 *));

428 
LReäeshAÎ
 
	`__P
((
Ïy”
 *, ));

429 
LCDi¥ÏyLše
 
	`__P
((
Ïy”
 *, 
mlše
 *, , , , ));

430 
LCDi¥ÏyLšeW¿p
 
	`__P
((
Ïy”
 *, 
mlše
 *, , , , ));

431 
LS‘R’d™iÚ
 
	`__P
((
Ïy”
 *, 
mch¬
 *));

432 
LW¿pCh¬
 
	`__P
((
Ïy”
 *, 
mch¬
 *, , , , ));

433 
LCursÜVisib™y
 
	`__P
((
Ïy”
 *, ));

434 
LS‘Flow
 
	`__P
((
Ïy”
 *, ));

435 
LKey·dMode
 
	`__P
((
Ïy”
 *, ));

436 
LCursÜkeysMode
 
	`__P
((
Ïy”
 *, ));

437 
LMou£Mode
 
	`__P
((
Ïy”
 *, ));

438 #ifdeà
USEVARARGS


439 
LMsg
 
	`__P
((, *, ...)è
	`__©Œibu‹__
((
	`fÜm©
(
´štf
, 2, 3)));

441 
LMsg
 
	`__P
(());

443 
KlLay”Chaš
 
	`__P
((
Ïy”
 *));

444 
In™Ov”ÏyPage
 
	`__P
((, 
LayFuncs
 *, ));

445 
Ex™Ov”ÏyPage
 
	`__P
(());

448 #ifdeà
BUILTIN_TELNET


449 
T–O³n
 
	`__P
((**));

450 
T–CÚÃù
 
	`__P
((
wš
 *));

451 
T–I¦še
 
	`__P
((
wš
 *
p
));

452 
T–ProûssLše
 
	`__P
((**, *));

453 
DoT–Ãt
 
	`__P
((*, *, ));

454 
T–In
 
	`__P
((
wš
 *, *, , ));

455 
T–B»ak
 
	`__P
((
wš
 *));

456 
T–WšdowSize
 
	`__P
((
wš
 *));

457 
T–Stus
 
	`__P
((
wš
 *, *, ));

461 *
DoNLS
 
	`__P
((*));

464 #ifdeà
ENCODINGS


465 #ifdeà
UTF8


466 
In™ButšTabs
 
	`__P
(());

467 
mch¬
 *
»code_mch¬
 
	`__P
((mchar *, , ));

468 
mlše
 *
»code_mlše
 
	`__P
((mline *, , , ));

469 
FromUtf8
 
	`__P
((, *));

470 
AddUtf8
 
	`__P
(());

471 
ToUtf8
 
	`__P
((*, ));

472 
ToUtf8_comb
 
	`__P
((*, ));

473 
utf8_isdoubË
 
	`__P
(());

474 
utf8_iscomb
 
	`__P
(());

475 
utf8_hªdË_comb
 
	`__P
((, 
mch¬
 *));

476 
CÚšsS³cŸlDeffÚt
 
	`__P
((
mlše
 *, , , ));

477 
LßdFÚtT¿n¦©iÚ
 
	`__P
((, *));

478 
LßdFÚtT¿n¦©iÚsFÜEncodšg
 
	`__P
(());

480 
WšSw™chEncodšg
 
	`__P
((
wš
 *, ));

481 
FšdEncodšg
 
	`__P
((*));

482 *
EncodšgName
 
	`__P
(());

483 
EncodšgDefFÚt
 
	`__P
(());

484 
Re£tEncodšg
 
	`__P
((
wš
 *));

485 
CªEncodeFÚt
 
	`__P
((, ));

486 
DecodeCh¬
 
	`__P
((, , *));

487 
RecodeBuf
 
	`__P
((*, , , , *));

488 #ifdeà
DW_CHARS


489 
P»·»EncodedCh¬
 
	`__P
(());

492 
EncodeCh¬
 
	`__P
((*, , , *));

	@fileio.c

24 
	~<sys/ty³s.h
>

25 
	~<fú.h
>

26 
	~<sys/¡©.h
>

28 #iâdeà
SIGINT


29 
	~<sigÇl.h
>

32 
	~"cÚfig.h
"

33 
	~"sü“n.h
"

34 
	~"ex‹º.h
"

36 
di¥Ïy
 *di¥Ïy, *
di¥Ïys
;

37 
wš
 *
fÜe
;

38 
Ïy”
 *
æay”
;

39 
»®_uid
, 
eff_uid
;

40 
»®_gid
, 
eff_gid
;

41 *
exŒa_šÿp
, *
exŒa_outÿp
;

42 *
home
, *
RcFeName
;

43 
SockP©h
[], *
SockName
;

44 #ifdeà
COPY_PASTE


45 *
BufãrFe
;

47 
h¬dcİy_­³nd
;

48 *
h¬dcİydœ
;

50 *
C©ExŒa
 
__P
((*, *));

51 *
fšdrcfe
 
__P
((*));

54 *
	grc_Çme
 = "";

55 
	grc_»cursiÚ
 = 0;

58 
	$C©ExŒa
(
¡r1
, 
¡r2
)

59 *
¡r1
, *
¡r2
;

61 *
ı
;

62 
Ën1
, 
Ën2
, 
add_cŞÚ
;

64 
Ën1
 = 
	`¡¾’
(
¡r1
);

65 ià(
Ën1
 == 0)

66  
¡r2
;

67 
add_cŞÚ
 = (
¡r1
[
Ën1
 - 1] != ':');

68 ià(
¡r2
)

70 
Ën2
 = 
	`¡¾’
(
¡r2
);

71 ià((
ı
 = 
	`»®loc
(
¡r2
, (è
Ën1
 + 
Ën2
 + 
add_cŞÚ
 + 1)è=ğ
NULL
)

72 
	`Pªic
(0, 
¡ºomem
);

73 
	`bcİy
(
ı
, c°+ 
Ën1
 + 
add_cŞÚ
, 
Ën2
 + 1);

77 ià(
Ën1
 == 0)

79 ià((
ı
 = 
	`m®loc
((è
Ën1
 + 
add_cŞÚ
 + 1)è=ğ
NULL
)

80 
	`Pªic
(0, 
¡ºomem
);

81 
ı
[
Ën1
 + 
add_cŞÚ
] = '\0';

83 
	`bcİy
(
¡r1
, 
ı
, 
Ën1
);

84 ià(
add_cŞÚ
)

85 
ı
[
Ën1
] = ':';

87  
ı
;

88 
	}
}

91 
	$fšdrcfe
(
rcfe
)

92 *
rcfe
;

94 
buf
[256];

95 *
p
;

97 ià(
rcfe
)

99 *
rûnd
 = 
	`ršdex
(
rc_Çme
, '/');

100 ià(*
rcfe
 !ğ'/' && 
rûnd
 && (rûnd - 
rc_Çme
è+ 
	`¡¾’
Ôcfeè+ 2 < (
buf
))

102 
	`¡ºıy
(
buf
, 
rc_Çme
, 
rûnd
 -„c_name + 1);

103 
	`¡rıy
(
buf
 + (
rûnd
 - 
rc_Çme
è+ 1, 
rcfe
);

104 ià(
	`acûss
(
buf
, 
R_OK
) == 0)

105  
	`SaveSŒ
(
buf
);

107 
	`debug1
("fšdrcfe: you s³cif›d '%s'\n", 
rcfe
);

108  
	`SaveSŒ
(
rcfe
);

110 
	`debug
("findrcfile: you specified‚othing...\n");

111 ià((
p
 = 
	`g‘’v
("SCREENRC")è!ğ
NULL
 && *p != '\0')

113 
	`debug1
(" $SCREENRC has: '%s'\n", 
p
);

114  
	`SaveSŒ
(
p
);

118 
	`debug
(" ...nothing in $SCREENRC, defaulting $HOME/.screenrc\n");

119 ià(
	`¡¾’
(
home
è> (
buf
) - 12)

120 
	`Pªic
(0, "Rc: homeoo†arge");

121 
	`¥rštf
(
buf
, "%s/.sü“Äc", 
home
);

122  
	`SaveSŒ
(
buf
);

124 
	}
}

132 
	$S¹Rc
(
rcf’ame
)

133 *
rcf’ame
;

135 
¬gc
, 
Ën
;

136 *
p
, *
ı
;

137 
buf
[2048];

138 *
¬gs
[
MAXARGS
];

139 
¬gl
[
MAXARGS
];

140 
FILE
 *
å
;

141 *
Şdrc_Çme
 = 
rc_Çme
;

144 
exŒa_šÿp
 = 
	`C©ExŒa
("TF",ƒxtra_incap);

147 ià(
di¥Ïy
 && (!
	`¡ºcmp
(
D_‹rmÇme
, "vt", 2) || !strncmp(D_termname, "xterm", 5)))

148 
exŒa_šÿp
 = 
	`C©ExŒa
("xn:f0=\033Op:f1=\033Oq:f2=\033Or:f3=\033Os:f4=\033Ot:f5=\033Ou:f6=\033Ov:f7=\033Ow:f8=\033Ox:f9=\033Oy:f.=\033On:f,=\033Ol:fe=\033OM:f+=\033Ok:f-=\033Om:f*=\033Oj:f/=\033Oo:fq=\033OX",ƒxtra_incap);

150 
rc_Çme
 = 
	`fšdrcfe
(
rcf’ame
);

152 ià((
å
 = 
	`£cfİ’
(
rc_Çme
, "r")è=ğ
NULL
)

154 ià(!
rc_»cursiÚ
 && 
RcFeName
 && !
	`¡rcmp
(RcFeName, 
rc_Çme
))

161 
	`debug3
("S¹Rc: '%s','%s', '%s'\n", 
RcFeName
, 
rc_Çme
, 
rcf’ame
);

162 
	`Pªic
(0, "UÇbËØİ’ \"%s\".", 
rc_Çme
);

165 
	`debug1
("S¹Rc: '%s'‚Øgood. ignÜed\n", 
rc_Çme
);

166 
	`F»e
(
rc_Çme
);

167 
rc_Çme
 = 
Şdrc_Çme
;

170 
	`fg‘s
(
buf
,  buf, 
å
è!ğ
NULL
)

172 ià((
p
 = 
	`ršdex
(
buf
, '\n')è!ğ
NULL
)

173 *
p
 = '\0';

174 ià((
¬gc
 = 
	`P¬£
(
buf
,  buf, 
¬gs
, 
¬gl
)) == 0)

176 ià(
	`¡rcmp
(
¬gs
[0], "echo") == 0)

178 ià(!
di¥Ïy
)

180 ià(
¬gc
 < 2 || (¬gø=ğ3 && 
	`¡rcmp
(
¬gs
[1], "-n")) ||‡rgc > 3)

182 
	`Msg
(0, "%s: 'echØ[-n] \"¡ršg\"'ƒx³ùed.", 
rc_Çme
);

185 
	`AddSŒ
(
¬gs
[
¬gc
 - 1]);

186 ià(
¬gc
 != 3)

188 
	`AddSŒ
("\r\n");

189 
	`Flush
();

192 ià(
	`¡rcmp
(
¬gs
[0], "sleep") == 0)

194 ià(!
di¥Ïy
)

196 
	`debug
("sleeeeeeep\n");

197 ià(
¬gc
 != 2)

199 
	`Msg
(0, "%s: sË•: oÃ‚um”iø¬gum’ˆex³ùed.", 
rc_Çme
);

202 
	`Di¥ÏySË•1000
(1000 * 
	`©oi
(
¬gs
[1]), 1);

204 #ifdeà
TERMINFO


205 ià(!
	`¡rcmp
(
¬gs
[0], "termcapinfo") || !strcmp(args[0], "terminfo"))

207 ià(!
	`¡rcmp
(
¬gs
[0], "termcapinfo") || !strcmp(args[0], "termcap"))

210 ià(!
di¥Ïy
)

212 ià(
¬gc
 < 3 ||‡rgc > 4)

214 
	`Msg
(0, "%s: %s: incÜ»ù‚umb” oà¬gum’ts.", 
rc_Çme
, 
¬gs
[0]);

217 
p
 = 
¬gs
[1];… && *p;… = 
ı
)

219 ià((
ı
 = 
	`šdex
(
p
, '|')) != 0)

220 *
ı
++ = '\0';

221 
Ën
 = 
	`¡¾’
(
p
);

222 ià(
p
[
Ën
 - 1] == '*')

224 ià(!(
Ën
 - 1è|| !
	`¡ºcmp
(
p
, 
D_‹rmÇme
,†en - 1))

227 ià(!
	`¡rcmp
(
p
, 
D_‹rmÇme
))

230 ià(!(
p
 && *p))

232 
exŒa_šÿp
 = 
	`C©ExŒa
(
¬gs
[2],ƒxtra_incap);

233 ià(
¬gc
 == 4)

234 
exŒa_outÿp
 = 
	`C©ExŒa
(
¬gs
[3],ƒxtra_outcap);

236 ià(!
	`¡rcmp
(
¬gs
[0], "source"))

238 ià(
rc_»cursiÚ
 <= 10)

240 
rc_»cursiÚ
++;

241 
	`S¹Rc
(
¬gs
[1]);

242 
rc_»cursiÚ
--;

246 
	`fşo£
(
å
);

247 
	`F»e
(
rc_Çme
);

248 
rc_Çme
 = 
Şdrc_Çme
;

249 
	}
}

252 
	$FšishRc
(
rcf’ame
)

253 *
rcf’ame
;

255 
buf
[2048];

256 
FILE
 *
å
;

257 *
Şdrc_Çme
 = 
rc_Çme
;

259 
rc_Çme
 = 
	`fšdrcfe
(
rcf’ame
);

261 ià((
å
 = 
	`£cfİ’
(
rc_Çme
, "r")è=ğ
NULL
)

263 ià(
rc_»cursiÚ
)

264 
	`Msg
(
”ºo
, "%s: sourû %s", 
Şdrc_Çme
, 
rc_Çme
);

265 ià(
RcFeName
 && !
	`¡rcmp
(RcFeName, 
rc_Çme
))

272 
	`debug3
("FšishRc:'%s','%s','%s'\n", 
RcFeName
, 
rc_Çme
, 
rcf’ame
);

273 
	`Pªic
(0, "UÇbËØİ’ \"%s\".", 
rc_Çme
);

276 
	`debug1
("FšishRc: '%s'‚Øgood. ignÜed\n", 
rc_Çme
);

277 
	`F»e
(
rc_Çme
);

278 
rc_Çme
 = 
Şdrc_Çme
;

282 
	`debug
("finishrc is going...\n");

283 
	`fg‘s
(
buf
,  buf, 
å
è!ğ
NULL
)

284 
	`RcLše
(
buf
,  buf);

285 (è
	`fşo£
(
å
);

286 
	`F»e
(
rc_Çme
);

287 
rc_Çme
 = 
Şdrc_Çme
;

288 
	}
}

291 
	$do_sourû
(
rcf’ame
)

292 *
rcf’ame
;

294 ià(
rc_»cursiÚ
 > 10)

296 
	`Msg
(0, "%s: sourû:„ecursiÚ†im™„—ched", 
rc_Çme
);

299 
rc_»cursiÚ
++;

300 
	`FšishRc
(
rcf’ame
);

301 
rc_»cursiÚ
--;

302 
	}
}

311 
	$RcLše
(
ubuf
, 
ubuæ
)

312 *
ubuf
;

313 
ubuæ
;

315 *
¬gs
[
MAXARGS
];

316 
¬gl
[
MAXARGS
];

317 #ifdeà
MULTIUSER


318 
aşu£r
 *
EfãùiveAşU£r
;

319 
aşu£r
 *
u£rs
;

322 ià(
di¥Ïy
)

324 
fÜe
 = 
D_fÜe
;

325 
æay”
 = 
D_fÜecv
->
c_Ïy”
;

328 
æay”
 = 
fÜe
 ? fÜe->
w_§v–ay”
 : 0;

329 ià(
	`P¬£
(
ubuf
, 
ubuæ
, 
¬gs
, 
¬gl
) <= 0)

331 #ifdeà
MULTIUSER


332 ià(!
di¥Ïy
)

335 
EfãùiveAşU£r
 = 
u£rs
;

336 
	`debug
("RcLine: WARNING,‚o display‚o user! Session ownerƒxecutes command\n");

339 
	`DoCommªd
(
¬gs
, 
¬gl
);

340 #ifdeà
MULTIUSER


341 
EfãùiveAşU£r
 = 0;

343 
	}
}

349 
	$Wr™eFe
(
u£r
, 
â
, 
dump
)

350 
aşu£r
 *
u£r
;

351 *
â
;

352 
dump
;

361 
i
, 
j
, 
k
;

362 *
p
;

363 
FILE
 *
f
;

364 
âbuf
[1024];

365 *
mode
 = "w";

366 #ifdeà
COPY_PASTE


367 
public
 = 0;

368 #ifdeà
_MODE_T


369 
mode_t
 
Şd_umask
;

371 
Şd_umask
;

373 #ifdeà
HAVE_LSTAT


374 
¡©
 
¡b
, 
¡b2
;

375 
fd
, 
exi¡s
 = 0;

379 
dump
)

381 
DUMP_TERMCAP
:

382 ià(
â
 == 0)

384 
i
 = 
SockName
 - 
SockP©h
;

385 ià(
i
 > ()(
âbuf
) - 9)

386 
i
 = 0;

387 
	`¡ºıy
(
âbuf
, 
SockP©h
, 
i
);

388 
	`¡rıy
(
âbuf
 + 
i
, ".termcap");

389 
â
 = 
âbuf
;

392 
DUMP_HARDCOPY
:

393 
DUMP_SCROLLBACK
:

394 ià(
â
 == 0)

396 ià(
fÜe
 == 0)

398 ià(
h¬dcİydœ
 && *h¬dcİydœ && 
	`¡¾’
(h¬dcİydœè< (
âbuf
) - 21)

399 
	`¥rštf
(
âbuf
, "%s/h¬dcİy.%d", 
h¬dcİydœ
, 
fÜe
->
w_numb”
);

401 
	`¥rštf
(
âbuf
, "h¬dcİy.%d", 
fÜe
->
w_numb”
);

402 
â
 = 
âbuf
;

404 ià(
h¬dcİy_­³nd
 && !
	`acûss
(
â
, 
W_OK
))

405 
mode
 = "a";

407 #ifdeà
COPY_PASTE


408 
DUMP_EXCHANGE
:

409 ià(
â
 == 0)

411 
	`¡ºıy
(
âbuf
, 
BufãrFe
, (fnbuf) - 1);

412 
âbuf
[(fnbuf) - 1] = 0;

413 
â
 = 
âbuf
;

415 
public
 = !
	`¡rcmp
(
â
, 
DEFAULT_BUFFERFILE
);

416 #ifdeà
HAVE_LSTAT


417 
exi¡s
 = !
	`l¡©
(
â
, &
¡b
);

418 ià(
public
 && 
exi¡s
 && (
	`S_ISLNK
(
¡b
.
¡_mode
è|| stb.
¡_Æšk
 > 1))

420 
	`Msg
(0, "No writeo†inks,…lease.");

428 
	`debug2
("Wr™eFe(%dè%s\n", 
dump
, 
â
);

429 ià(
	`U£rCÚ‹xt
() > 0)

431 
	`debug
("Writefile: usercontext\n");

432 #ifdeà
COPY_PASTE


433 ià(
dump
 =ğ
DUMP_EXCHANGE
 && 
public
)

435 
Şd_umask
 = 
	`umask
(0);

436 #ifdeà
HAVE_LSTAT


437 ià(
exi¡s
)

439 ià((
fd
 = 
	`İ’
(
â
, 
O_WRONLY
, 0666)) >= 0)

441 ià(
	`f¡©
(
fd
, &
¡b2
è=ğ0 && 
¡b
.
¡_dev
 =ğ¡b2.¡_dev && stb.
¡_šo
 == stb2.st_ino)

442 
	`árunÿ‹
(
fd
, 0);

445 
	`şo£
(
fd
);

446 
fd
 = -1;

451 
fd
 = 
	`İ’
(
â
, 
O_WRONLY
|
O_CREAT
|
O_EXCL
, 0666);

452 
f
 = 
fd
 >ğ0 ? 
	`fdİ’
(fd, 
mode
) : 0;

454 
f
 = 
	`fİ’
(
â
, 
mode
);

456 
	`umask
(
Şd_umask
);

460 
f
 = 
	`fİ’
(
â
, 
mode
);

461 ià(
f
 =ğ
NULL
)

463 
	`debug2
("Wr™eFe: fİ’(%s,\"%s\"èçed\n", 
â
, 
mode
);

464 
	`U£rR‘uº
(0);

468 
dump
)

470 
DUMP_HARDCOPY
:

471 
DUMP_SCROLLBACK
:

472 ià(!
fÜe
)

474 ià(*
mode
 == 'a')

476 
	`putc
('>', 
f
);

477 
j
 = 
fÜe
->
w_width
 - 2; j > 0; j--)

478 
	`putc
('=', 
f
);

479 
	`åuts
("<\n", 
f
);

481 ià(
dump
 =ğ
DUMP_SCROLLBACK
)

483 
i
 = 0; i < 
fÜe
->
w_hi¡height
; i++)

485 
p
 = (*)(
	`WIN
(
i
)->
image
);

486 
k
 = 
fÜe
->
w_width
 - 1; k >ğ0 && 
p
[k] == ' '; k--)

488 
j
 = 0; j <ğ
k
; j++)

489 
	`putc
(
p
[
j
], 
f
);

490 
	`putc
('\n', 
f
);

493 
i
 = 0; i < 
fÜe
->
w_height
; i++)

495 
p
 = (*)
fÜe
->
w_mlšes
[
i
].
image
;

496 
k
 = 
fÜe
->
w_width
 - 1; k >ğ0 && 
p
[k] == ' '; k--)

498 
j
 = 0; j <ğ
k
; j++)

499 
	`putc
(
p
[
j
], 
f
);

500 
	`putc
('\n', 
f
);

503 
DUMP_TERMCAP
:

504 ià((
p
 = 
	`šdex
(
	`MakeT”mÿp
(
fÜe
->
w_aæag
), '=')è!ğ
NULL
)

506 
	`åuts
(++
p
, 
f
);

507 
	`putc
('\n', 
f
);

510 #ifdeà
COPY_PASTE


511 
DUMP_EXCHANGE
:

512 
p
 = 
u£r
->
u_¶İ
.
buf
;

513 
i
 = 
u£r
->
u_¶İ
.
Ën
; i-- > 0; 
p
++)

514 ià(*
p
 =ğ'\r' && (
i
 == 0 ||…[1] != '\n'))

515 
	`putc
('\n', 
f
);

517 
	`putc
(*
p
, 
f
);

521 (è
	`fşo£
(
f
);

522 
	`U£rR‘uº
(1);

525 ià(
	`U£rStus
() <= 0)

526 
	`Msg
(0, "CªnÙ o³À\"%s\"", 
â
);

527 ià(
di¥Ïy
 && !*
rc_Çme
)

529 
dump
)

531 
DUMP_TERMCAP
:

532 
	`Msg
(0, "T”mÿ°’Œy wr™‹ÀtØ\"%s\".", 
â
);

534 
DUMP_HARDCOPY
:

535 
DUMP_SCROLLBACK
:

536 
	`Msg
(0, "Screen image %so \"%s\".",

537 (*
mode
 =ğ'a'è? "­³nded" : "wr™‹n", 
â
);

539 #ifdeà
COPY_PASTE


540 
DUMP_EXCHANGE
:

541 
	`Msg
(0, "Cİybufã¸wr™‹ÀtØ\"%s\".", 
â
);

545 
	}
}

547 #ifdeà
COPY_PASTE


555 
	$R—dFe
(
â
, 
ËÅ
)

556 *
â
;

557 *
ËÅ
;

559 
i
, 
l
, 
size
;

560 
c
, *
bp
, *
buf
;

561 
¡©
 
¡b
;

563 
	`ASSERT
(
ËÅ
);

564 
	`debug1
("R—dFe(%s)\n", 
â
);

565 ià((
i
 = 
	`£cİ’
(
â
, 
O_RDONLY
, 0)) < 0)

567 
	`Msg
(
”ºo
, "nØ% --‚Ø¦u½", 
â
);

568  
NULL
;

570 ià(
	`f¡©
(
i
, &
¡b
))

572 
	`Msg
(
”ºo
, "nØgood % --‚Ø¦u½", 
â
);

573 
	`şo£
(
i
);

574  
NULL
;

576 
size
 = 
¡b
.
¡_size
;

577 ià((
buf
 = 
	`m®loc
(
size
)è=ğ
NULL
)

579 
	`şo£
(
i
);

580 
	`Msg
(0, 
¡ºomem
);

581  
NULL
;

583 
”ºo
 = 0;

584 ià((
l
 = 
	`»ad
(
i
, 
buf
, 
size
)) != size)

586 ià(
l
 < 0)

587 
l
 = 0;

588 
	`Msg
(
”ºo
, "GÙ oÆy %d by‹ äom %s", 
l
, 
â
);

589 
	`şo£
(
i
);

593 ià(
	`»ad
(
i
, &
c
, 1) > 0)

594 
	`Msg
(0, "Slurped only %d characters (of %d) into buffer -ry‡gain",

595 
l
, 
size
);

597 
	`Msg
(0, "Slu½ed %d ch¬aù” štØbufãr", 
l
);

599 
	`şo£
(
i
);

600 *
ËÅ
 = 
l
;

601 
bp
 = 
buf
; 
l
-- > 0; bp++)

602 ià(*
bp
 =ğ'\n' && (b°=ğ
buf
 || bp[-1] != '\r'))

603 *
bp
 = '\r';

604  
buf
;

605 
	}
}

608 
	$KlBufãrs
()

610 ià(
	`U£rCÚ‹xt
() > 0)

611 
	`U£rR‘uº
(
	`uÆšk
(
BufãrFe
è? 
”ºo
 : 0);

612 
”ºo
 = 
	`U£rStus
();

613 
	`Msg
(
”ºo
, "% %¤emoved", 
BufãrFe
,ƒrrno ? "not " : "");

614 
	}
}

622 
FILE
 *

623 
	$£cfİ’
(
Çme
, 
mode
)

624 *
Çme
;

625 *
mode
;

627 
FILE
 *
fi
;

628 #iâdeà
USE_SETEUID


629 
æags
, 
fd
;

632 
	`debug2
("£cfİ’(%s, %s)\n", 
Çme
, 
mode
);

633 #ifdeà
USE_SETEUID


634 
	`x£‹uid
(
»®_uid
);

635 
	`x£‹gid
(
»®_gid
);

636 
fi
 = 
	`fİ’
(
Çme
, 
mode
);

637 
	`x£‹uid
(
eff_uid
);

638 
	`x£‹gid
(
eff_gid
);

639  
fi
;

641 ià(
eff_uid
 =ğ
»®_uid
)

642  
	`fİ’
(
Çme
, 
mode
);

643 ià(
mode
[0] && mode[1] == '+')

644 
æags
 = 
O_RDWR
;

646 
æags
 = (
mode
[0] =ğ'r'è? 
O_RDONLY
 : 
O_WRONLY
;

647 ià(
mode
[0] == 'w')

648 
æags
 |ğ
O_CREAT
 | 
O_TRUNC
;

649 ià(
mode
[0] == 'a')

650 
æags
 |ğ
O_CREAT
 | 
O_APPEND
;

651 ià(
mode
[0] != 'r')

653 
”ºo
 = 
EINVAL
;

656 ià((
fd
 = 
	`£cİ’
(
Çme
, 
æags
, 0666)) < 0)

658 ià((
fi
 = 
	`fdİ’
(
fd
, 
mode
)) == 0)

660 
	`şo£
(
fd
);

663  
fi
;

665 
	}
}

669 
	$£cİ’
(
Çme
, 
æags
, 
mode
)

670 *
Çme
;

671 
æags
;

672 
mode
;

674 
fd
;

675 #iâdeà
USE_SETEUID


676 
q
;

677 
¡©
 
¡b
;

680 
	`debug3
("£cİ’(%s, 0x%x, 0%03o)\n", 
Çme
, 
æags
, 
mode
);

681 #ifdeà
USE_SETEUID


682 
	`x£‹uid
(
»®_uid
);

683 
	`x£‹gid
(
»®_gid
);

684 
fd
 = 
	`İ’
(
Çme
, 
æags
, 
mode
);

685 
	`x£‹uid
(
eff_uid
);

686 
	`x£‹gid
(
eff_gid
);

687  
fd
;

689 ià(
eff_uid
 =ğ
»®_uid
)

690  
	`İ’
(
Çme
, 
æags
, 
mode
);

692 ià((
æags
 & 
O_TRUNC
è|| ((æag & 
O_CREAT
è&& 
	`acûss
(
Çme
, 
F_OK
)))

694 ià(
	`U£rCÚ‹xt
() > 0)

696 ià((
fd
 = 
	`İ’
(
Çme
, 
æags
, 
mode
)) >= 0)

698 
	`şo£
(
fd
);

699 
	`U£rR‘uº
(0);

701 ià(
”ºo
 == 0)

702 
”ºo
 = 
EACCES
;

703 
	`U£rR‘uº
(
”ºo
);

705 ià((
q
 = 
	`U£rStus
()))

707 ià(
q
 > 0)

708 
”ºo
 = 
q
;

712 ià(
	`acûss
(
Çme
, 
F_OK
))

714 ià((
fd
 = 
	`İ’
(
Çme
, 
æags
 & ~(
O_TRUNC
 | 
O_CREAT
), 0)) < 0)

716 
	`debug
("open successful\n");

717 ià(
	`f¡©
(
fd
, &
¡b
))

719 
	`şo£
(
fd
);

722 
	`debug
("fstat successful\n");

723 ià(
¡b
.
¡_uid
 !ğ
»®_uid
)

725 
æags
 & (
O_RDONLY
 | 
O_WRONLY
 | 
O_RDWR
))

727 
O_RDONLY
:

728 
q
 = 0004;

730 
O_WRONLY
:

731 
q
 = 0002;

734 
q
 = 0006;

737 ià((
¡b
.
¡_mode
 & 
q
) != q)

739 
	`debug1
("£cİ’:…”missiÚ d’›d (%03o)\n", 
¡b
.
¡_mode
 & 07777);

740 
	`şo£
(
fd
);

741 
”ºo
 = 
EACCES
;

745 
	`debug1
("£cİ’ ok -„‘uºšg %d\n", 
fd
);

746  
fd
;

748 
	}
}

752 
	$´še
(
p
, 
cmd
)

753 
wš
 *
p
;

754 *
cmd
;

756 
pi
[2];

757 ià(
	`pe
(
pi
))

759 
	`WMsg
(
p
, 
”ºo
, "printing…ipe");

762 
	`fÜk
())

765 
	`WMsg
(
p
, 
”ºo
, "printing fork");

768 
di¥Ïy
 = 
p
->
w_pdi¥Ïy
;

769 
di¥Ïys
 = 0;

770 #ifdeà
DEBUG


771 ià(
då
 && då !ğ
¡d”r
)

772 
	`fşo£
(
då
);

774 
	`şo£
(0);

775 
	`dup
(
pi
[0]);

776 
	`şo£®lfes
(0);

777 ià(
	`£tgid
(
»®_gid
è|| 
	`£tuid
(
»®_uid
))

778 
	`Pªic
(
”ºo
, "printpipe setuid");

779 #ifdeà
SIGPIPE


780 
	`sigÇl
(
SIGPIPE
, 
SIG_DFL
);

782 
	`exeş
("/bš/sh", "sh", "-c", 
cmd
, 0);

783 
	`Pªic
(
”ºo
, "/bin/sh");

787 
	`şo£
(
pi
[0]);

788  
pi
[1];

789 
	}
}

792 
	$»adpe
(
cmdv
)

793 **
cmdv
;

795 
pi
[2];

797 ià(
	`pe
(
pi
))

799 
	`Msg
(
”ºo
, "pipe");

802 
	`fÜk
())

805 
	`Msg
(
”ºo
, "fork");

808 
di¥Ïys
 = 0;

809 #ifdeà
DEBUG


810 ià(
då
 && då !ğ
¡d”r
)

811 
	`fşo£
(
då
);

813 
	`şo£
(1);

814 ià(
	`dup
(
pi
[1]) != 1)

816 
	`şo£
(
pi
[1]);

817 
	`Pªic
(0, "dup");

819 
	`şo£®lfes
(1);

820 ià(
	`£tgid
(
»®_gid
è|| 
	`£tuid
(
»®_uid
))

822 
	`şo£
(1);

823 
	`Pªic
(
”ºo
, "setuid/setgid");

825 #ifdeà
SIGPIPE


826 
	`sigÇl
(
SIGPIPE
, 
SIG_DFL
);

828 
	`execvp
(*
cmdv
, cmdv);

829 
	`şo£
(1);

830 
	`Pªic
(
”ºo
, *
cmdv
);

834 
	`şo£
(
pi
[1]);

835  
pi
[0];

836 
	}
}

	@help.c

24 
	~<sys/ty³s.h
>

26 
	~"cÚfig.h
"

28 
	~"sü“n.h
"

29 
	~"ex‹º.h
"

31 
	gv”siÚ
[40];

33 
Ïy”
 *
æay”
;

34 
di¥Ïy
 *di¥Ïy, *
di¥Ïys
;

35 
wš
 *
wšdows
;

36 *
nßrgs
[];

37 
mch¬
 
mch¬_bÏnk
, 
mch¬_so
;

38 *
bÏnk
;

39 
wš
 *
wb
[];

41 
PadSŒ
 
__P
((*, , , ));

43 *
wli¡¡r
;

44 *
wli¡t™
;

47 
	$ex™_w™h_u§ge
(
myÇme
, 
mes§ge
, 
¬g
)

48 *
myÇme
, *
mes§ge
, *
¬g
;

50 
	`´štf
("U£: % [-İts] [cmd [¬gs]]\n", 
myÇme
);

51 
	`´štf
(" or: % -¸[ho¡.‰y]\n\nO±iÚs:\n", 
myÇme
);

52 
	`´štf
("-a Force‡ll capabilities intoƒach window'sermcap.\n");

53 
	`´štf
("-A -[r|R] Adapt‡ll windowsohe‚ew display width & height.\n");

54 
	`´štf
("-c file Read configuration file instead of '.screenrc'.\n");

55 #ifdeà
REMOTE_DETACH


56 
	`´štf
("-d (-r) Detachheƒlsewhere„unning screen (and„eattach here).\n");

57 
	`´štf
("-dmS‚ame Start‡s daemon: Screen session in detached mode.\n");

58 
	`´štf
("-D (-r) Detach‡nd†ogout„emote (and„eattach here).\n");

59 
	`´štf
("-D -RR Do whatever is‚eededo get‡ screen session.\n");

61 
	`´štf
("-e xy Change command characters.\n");

62 
	`´štf
("-f Flow control on, -fn = off, -fa =‡uto.\n");

63 
	`´štf
("-h†ines Sethe size ofhe scrollback history buffer.\n");

64 
	`´štf
("-i Interrupt output sooner when flow control is on.\n");

65 #ià
	`defšed
(
LOGOUTOK
è&& defšed(
UTMPOK
)

66 
	`´štf
("-È Logš modÚ (upd©%s), -Ê = off.\n", 
UTMPFILE
);

68 
	`´štf
("-list or -ls. Do‚othing, just†ist our SockDir.\n");

69 
	`´štf
("-L Turn on output†ogging.\n");

70 
	`´štf
("-m ignore $STY variable, do create‡‚ew screen session.\n");

71 
	`´štf
("-O Choose optimal output„atherhanƒxact vt100ƒmulation.\n");

72 
	`´štf
("-p window Preselecthe‚amed window if itƒxists.\n");

73 
	`´štf
("-q Quiet startup. Exits with‚on-zero„eturn code if unsuccessful.\n");

74 
	`´štf
("-r Reattacho‡ detached screen…rocess.\n");

75 
	`´štf
("-R Reattach if…ossible, otherwise start‡‚ew session.\n");

76 
	`´štf
("-s shell Shelloƒxecute„atherhan $SHELL.\n");

77 
	`´štf
("-S sockname Namehis session <pid>.sockname instead of <pid>.<tty>.<host>.\n");

78 
	`´štf
("-title Setitle. (window's‚ame).\n");

79 
	`´štf
("-Term Useerm‡s $TERM for windows,„atherhan \"screen\".\n");

80 #ifdeà
UTF8


81 
	`´štf
("-U Tell screeno use UTF-8ƒncoding.\n");

83 
	`´štf
("-v Pršˆ\"Sü“Àv”siÚ %s\".\n", 
v”siÚ
);

84 
	`´štf
("-wipe Do‚othing, just clean up SockDir.\n");

85 #ifdeà
MULTI


86 
	`´štf
("-x Attacho‡‚ot detached screen. (Multi display mode).\n");

88 
	`´štf
("-X Execute <cmd>‡s‡ screen command inhe specified session.\n");

89 ià(
mes§ge
 && *message)

91 
	`´štf
("\nError: ");

92 
	`´štf
(
mes§ge
, 
¬g
);

93 
	`´štf
("\n");

95 
	`ex™
(1);

96 
	}
}

102 
comm
 
comms
[];

103 
aùiÚ
 
kb
[];

105 
H–pProûss
 
__P
((**, *));

106 
H–pAbÜt
 
__P
(());

107 
H–pRedi¥ÏyLše
 
__P
((, , , ));

108 
add_key_to_buf
 
__P
((*, ));

109 
AddAùiÚ
 
__P
((
aùiÚ
 *, , ));

110 
h–µage
 
__P
(());

112 
	sh–pd©a


114 *
	mşass
;

115 
aùiÚ
 *
	mkbp
;

116 
	mmaxrow
, 
	mgrow
, 
	mnumcŞs
, 
	mnumrows
, 
	mnum_Çmes
;

117 
	mnumsk
, 
	mnum·ges
;

118 
	mcommªd_£¬ch
, 
	mcommªd_bšdšgs
;

119 
	m»fgrow
, 
	m»fcommªd_£¬ch
;

120 
	mš‹r
, 
	mmcom
, 
	mmkey
;

121 
	mÇù
[
RC_LAST
 + 1];

124 
	#MAXKLEN
 256

	)

126 
LayFuncs
 
	gH–pLf
 =

128 
H–pProûss
,

129 
H–pAbÜt
,

130 
H–pRedi¥ÏyLše
,

131 
DefCË¬Lše
,

132 
DefRewr™e
,

133 
DefResize
,

134 
DefRe¡Üe


139 
	$di¥Ïy_h–p
(
şass
, 
kbp
)

140 *
şass
;

141 
aùiÚ
 *
kbp
;

143 
i
, 
n
, 
key
, 
mcom
, 
mkey
, 
l
;

144 
h–pd©a
 *helpdata;

145 
u£d
[
RC_LAST
 + 1];

147 ià(
æay”
->
l_height
 < 6)

149 
	`LMsg
(0, "Window heightoo small for help…age");

152 ià(
	`In™Ov”ÏyPage
((*
h–pd©a
), &
H–pLf
, 0))

155 
h–pd©a
 = (h–pd©¨*)
æay”
->
l_d©a
;

156 
h–pd©a
->
şass
 = class;

157 
h–pd©a
->
kbp
 = ktabp;

158 
h–pd©a
->
num_Çmes
 = h–pd©a->
commªd_bšdšgs
 = 0;

159 
h–pd©a
->
commªd_£¬ch
 = 0;

160 
n
 = 0;‚ <ğ
RC_LAST
;‚++)

161 
u£d
[
n
] = 0;

162 
mcom
 = 0;

163 
mkey
 = 0;

164 
key
 = 0; key < 256; key++)

166 
n
 = 
kbp
[
key
].
Ä
;

167 ià(
n
 =ğ
RC_ILLEGAL
)

169 ià(
kbp
[
key
].
¬gs
 =ğ
nßrgs
)

171 
u£d
[
n
] +ğ(
key
 <= ' ' || key == 0x7f) ? 3 :

172 (
key
 > 0x7f) ? 5 : 2;

175 
h–pd©a
->
commªd_bšdšgs
++;

177 
n
 = 
i
 = 0;‚ <ğ
RC_LAST
;‚++)

178 ià(
u£d
[
n
])

180 
l
 = 
	`¡¾’
(
comms
[
n
].
Çme
);

181 ià(
l
 > 
mcom
)

182 
mcom
 = 
l
;

183 ià(
u£d
[
n
] > 
mkey
)

184 
mkey
 = 
u£d
[
n
];

185 
h–pd©a
->
Çù
[
i
++] = 
n
;

187 
	`debug1
("h–p: %d commªd boundØkey w™h‚Ø¬gum’ts\n", 
i
);

188 
	`debug2
("mcom: %d mkey: %d\n", 
mcom
, 
mkey
);

189 
h–pd©a
->
num_Çmes
 = 
i
;

191 ià(
mkey
 > 
MAXKLEN
)

192 
mkey
 = 
MAXKLEN
;

193 
h–pd©a
->
numcŞs
 = 
æay”
->
l_width
 / (
mcom
 + 
mkey
 + 1);

194 ià(
h–pd©a
->
numcŞs
 == 0)

196 
	`H–pAbÜt
();

197 
	`LMsg
(0, "Widthoo small");

200 
h–pd©a
->
š‹r
 = (
æay”
->
l_width
 - (
mcom
 + 
mkey
è* h–pd©a->
numcŞs
) / (helpdata->numcols + 1);

201 ià(
h–pd©a
->
š‹r
 <= 0)

202 
h–pd©a
->
š‹r
 = 1;

203 
	`debug1
("š‹r: %d\n", 
h–pd©a
->
š‹r
);

204 
h–pd©a
->
mcom
 = mcom;

205 
h–pd©a
->
mkey
 = mkey;

206 
h–pd©a
->
numrows
 = (h–pd©a->
num_Çmes
 + h–pd©a->
numcŞs
 - 1) / helpdata->numcols;

207 
	`debug1
("Numrows: %d\n", 
h–pd©a
->
numrows
);

208 
h–pd©a
->
numsk
 = 
æay”
->
l_height
-5 - (2 + h–pd©a->
numrows
);

209 
h–pd©a
->
numsk
 < 0)

210 
h–pd©a
->
numsk
 +ğ
æay”
->
l_height
-5;

211 
h–pd©a
->
numsk
 %ğ
æay”
->
l_height
-5;

212 
	`debug1
("Numsk: %d\n", 
h–pd©a
->
numsk
);

213 ià(
h–pd©a
->
numsk
 > 
æay”
->
l_height
/3 || h–pd©a->numsk > h–pd©a->
commªd_bšdšgs
)

214 
h–pd©a
->
numsk
 = 1;

215 
h–pd©a
->
maxrow
 = 2 + h–pd©a->
numrows
 + h–pd©a->
numsk
 + h–pd©a->
commªd_bšdšgs
;

216 
h–pd©a
->
grow
 = 0;

218 
h–pd©a
->
num·ges
 = (h–pd©a->
maxrow
 + 
æay”
->
l_height
-6) / (flayer->l_height-5);

219 
æay”
->
l_x
 = 0;

220 
æay”
->
l_y
 = fÏy”->
l_height
 - 1;

221 
	`h–µage
();

222 
	}
}

225 
	$H–pProûss
(
µbuf
, 
¶’
)

226 **
µbuf
;

227 *
¶’
;

229 
dÚe
 = 0;

231 !
dÚe
 && *
¶’
 > 0)

233 **
µbuf
)

236 ià(
	`h–µage
() == 0)

241 
dÚe
 = 1;

246 ++*
µbuf
;

247 --*
¶’
;

249 ià(
dÚe
)

250 
	`H–pAbÜt
();

251 
	}
}

254 
	$H–pAbÜt
()

256 
	`LAY_CALL_UP
(
	`LReäeshAÎ
(
æay”
, 0));

257 
	`Ex™Ov”ÏyPage
();

258 
	}
}

262 
	$h–µage
()

264 
h–pd©a
 *helpdata;

265 
cŞ
, 
üow
, 
n
, 
key
, 
x
;

266 
buf
[
MAXKLEN
], 
Esc_buf
[5], 
cbuf
[256];

267 
aùiÚ
 *
kbp
;

269 
h–pd©a
 = (h–pd©¨*)
æay”
->
l_d©a
;

271 
kbp
 = 
h–pd©a
->ktabp;

272 ià(
h–pd©a
->
grow
 >ğh–pd©a->
maxrow
)

274 
h–pd©a
->
»fgrow
 = h–pd©a->
grow
;

275 
h–pd©a
->
»fcommªd_£¬ch
 = h–pd©a->
commªd_£¬ch
;

278 
	`LCË¬AÎ
(
æay”
, 0);

280 
	`¥rštf
(
cbuf
,"Sü“Àkey bšdšgs,…ag%d oà%d.", 
h–pd©a
->
grow
 / (
æay”
->
l_height
-5è+ 1, h–pd©a->
num·ges
);

281 
	`ûÁ”lše
(
cbuf
, 0);

282 
üow
 = 2;

284 *
Esc_buf
 = '\0';

285 *
buf
 = '\0';

287 ià(
æay”
->
l_cvli¡
 && fÏy”->l_cvli¡->
c_di¥Ïy
)

289 
	`add_key_to_buf
(
buf
, 
æay”
->
l_cvli¡
->
c_di¥Ïy
->
d_u£r
->
u_M‘aEsc
);

290 
	`add_key_to_buf
(
Esc_buf
, 
æay”
->
l_cvli¡
->
c_di¥Ïy
->
d_u£r
->
u_Esc
);

294 
	`¡rıy
(
Esc_buf
, "??");

295 
	`¡rıy
(
buf
, "??");

298 ; 
üow
 < 
æay”
->
l_height
 - 3; crow++)

300 ià(
h–pd©a
->
grow
 < 1)

302 ià(
kbp
 =ğ
kb
)

303 
	`¥rštf
(
cbuf
,"Commªd key: %  L™”® %s: %s", 
Esc_buf
, Esc_buf, 
buf
);

305 
	`¥rštf
(
cbuf
,"Commªd cÏss: '%.80s'", 
h–pd©a
->
şass
);

306 
	`ûÁ”lše
(
cbuf
, 
üow
);

307 
h–pd©a
->
grow
++;

309 ià(
h–pd©a
->
grow
 >ğ2 && h–pd©a->grow-2 < h–pd©a->
numrows
)

311 
x
 = 0;

312 
cŞ
 = 0; cŞ < 
h–pd©a
->
numcŞs
 && (
n
 = h–pd©a->
numrows
 * cŞ + (h–pd©a->
grow
-2)è< h–pd©a->
num_Çmes
; col++)

314 
x
 +ğ
h–pd©a
->
š‹r
 - !
cŞ
;

315 
n
 = 
h–pd©a
->
Çù
[n];

316 
buf
[0] = '\0';

317 
key
 = 0; key < 256; key++)

318 ià(
kbp
[
key
].
Ä
 =ğ
n
 && kbp[key].
¬gs
 =ğ
nßrgs
 && 
	`¡¾’
(
buf
) < (buf) - 7)

320 
	`¡rÿt
(
buf
, " ");

321 
	`add_key_to_buf
(
buf
, 
key
);

323 
	`PadSŒ
(
comms
[
n
].
Çme
, 
h–pd©a
->
mcom
, 
x
, 
üow
);

324 
x
 +ğ
h–pd©a
->
mcom
;

325 
	`PadSŒ
(
buf
, 
h–pd©a
->
mkey
, 
x
, 
üow
);

326 
x
 +ğ
h–pd©a
->
mkey
;

328 
h–pd©a
->
grow
++;

330 ià(
h–pd©a
->
grow
-2-h–pd©a->
numrows
 >ğh–pd©a->
numsk


331 && 
h–pd©a
->
grow
-2-h–pd©a->
numrows
-h–pd©a->
numsk
 < h–pd©a->
commªd_bšdšgs
)

333 (
n
 = 
kbp
[
h–pd©a
->
commªd_£¬ch
].
Ä
è=ğ
RC_ILLEGAL


334 || 
kbp
[
h–pd©a
->
commªd_£¬ch
].
¬gs
 =ğ
nßrgs
)

336 ià(++
h–pd©a
->
commªd_£¬ch
 >= 256)

339 
buf
[0] = '\0';

340 
	`add_key_to_buf
(
buf
, 
h–pd©a
->
commªd_£¬ch
);

341 
	`PadSŒ
(
buf
, 4, 0, 
üow
);

342 
	`AddAùiÚ
(&
kbp
[
h–pd©a
->
commªd_£¬ch
++], 4, 
üow
);

343 
h–pd©a
->
grow
++;

346 
h–pd©a
->
grow
++;

348 
	`¥rštf
(
cbuf
,"[Press Space %s Returnoƒnd.]",

349 
h–pd©a
->
grow
 < h–pd©a->
maxrow
 ? "for‚ext…age;" : "or");

350 
	`ûÁ”lše
(
cbuf
, 
æay”
->
l_height
 - 2);

351 
	`LayS‘CursÜ
();

353 
	}
}

356 
	$AddAùiÚ
(
aù
, 
x
, 
y
)

357 
aùiÚ
 *
aù
;

358 
x
, 
y
;

360 
buf
[256];

361 
d–
, 
l
;

362 *
bp
, *
ı
, **
µ
;

363 *
Í
, 
Î
;

364 
ä
;

365 
mch¬
 
mch¬_dŞ
;

367 
mch¬_dŞ
 = 
mch¬_bÏnk
;

368 
mch¬_dŞ
.
image
 = '$';

370 
ä
 = 
æay”
->
l_width
 - 1 - 
x
;

371 ià(
ä
 <= 0)

373 
l
 = 
	`¡¾’
(
comms
[
aù
->
Ä
].
Çme
);

375 ià(
l
 + 1 > 
ä
)

376 
l
 = 
ä
 - 1;

377 
	`PadSŒ
(
comms
[
aù
->
Ä
].
Çme
, 
l
, 
x
, 
y
);

378 
x
 +ğ
l
;

379 
ä
 -ğ
l
 + 1;

380 
	`LPutCh¬
(
æay”
, 
ä
 ? &
mch¬_bÏnk
 : &
mch¬_dŞ
, 
x
++, 
y
);

382 
µ
 = 
aù
->
¬gs
;

383 
Í
 = 
aù
->
¬gl
;

384 
µ
 && (
ı
 = *µè!ğ
NULL
)

386 
d–
 = 0;

387 
bp
 = 
buf
;

388 
Î
 = *
Í
++;

389 ià(!
Î
 || (
	`šdex
(
ı
, ' 'è!ğ
NULL
))

391 ià(
	`šdex
(
ı
, '\''è!ğ
NULL
)

392 *
bp
++ = 
d–
 = '"';

394 *
bp
++ = 
d–
 = '\'';

396 
Î
-- && 
bp
 < 
buf
 + 250)

397 
bp
 +ğ
	`AddXCh¬
(bp, *(*)
ı
++);

398 ià(
d–
)

399 *
bp
++ = 
d–
;

400 *
bp
 = 0;

401 ià((
ä
 -ğ(
bp
 - 
buf
) + 1) < 0)

403 
ä
 +ğ
bp
 - 
buf
;

404 ià(
ä
 > 0)

405 
	`PadSŒ
(
buf
, 
ä
, 
x
, 
y
);

406 ià(
ä
 == 0)

407 
	`LPutCh¬
(
æay”
, &
mch¬_dŞ
, 
x
, 
y
);

410 
	`PadSŒ
(
buf
, 
	`¡¾’
(buf), 
x
, 
y
);

411 
x
 +ğ
	`¡¾’
(
buf
);

412 
µ
++;

413 ià(*
µ
)

414 
	`LPutCh¬
(
æay”
, 
ä
 ? &
mch¬_bÏnk
 : &
mch¬_dŞ
, 
x
++, 
y
);

416 
	}
}

419 
	$add_key_to_buf
(
buf
, 
key
)

420 *
buf
;

421 
key
;

423 
buf
 +ğ
	`¡¾’
(buf);

424 ià(
key
 < 0)

425 
	`¡rıy
(
buf
, "unset");

426 ià(
key
 == ' ')

427 
	`¡rıy
(
buf
, "sp");

429 
buf
[
	`AddXCh¬
(buf, 
key
)] = 0;

430 
	}
}

434 
	$H–pRedi¥ÏyLše
(
y
, 
xs
, 
xe
, 
isbÏnk
)

435 
y
, 
xs
, 
xe
, 
isbÏnk
;

437 ià(
y
 < 0)

439 
h–pd©a
 *helpdata;

441 
h–pd©a
 = (h–pd©¨*)
æay”
->
l_d©a
;

442 
h–pd©a
->
grow
 = h–pd©a->
»fgrow
;

443 
h–pd©a
->
commªd_£¬ch
 = h–pd©a->
»fcommªd_£¬ch
;

444 
	`h–µage
();

447 ià(
y
 !ğ0 && y !ğ
æay”
->
l_height
 - 1)

449 ià(!
isbÏnk
)

450 
	`LCË¬A»a
(
æay”
, 
xs
, 
y
, 
xe
, y, 0, 0);

451 
	}
}

460 
CİyrightProûss
 
__P
((**, *));

461 
CİyrightRedi¥ÏyLše
 
__P
((, , , ));

462 
CİyrightAbÜt
 
__P
(());

463 
cİy·ge
 
__P
(());

465 
	scİyd©a


467 *
	mıs
, *
	m§vedıs
;

468 *
	m»fıs
, *
	m»f§vedıs
;

471 
LayFuncs
 
	gCİyrightLf
 =

473 
CİyrightProûss
,

474 
CİyrightAbÜt
,

475 
CİyrightRedi¥ÏyLše
,

476 
DefCË¬Lše
,

477 
DefRewr™e
,

478 
DefResize
,

479 
DefRe¡Üe


482 cÚ¡ 
	gımsg
[] = "\
\n\
 version %v\n\
\n\
 (c) 1993-2002 Juergen Weigert, Michael Schroeder\n\
 (c) 1987 Oliver Laumann\n\
\n\
…rogram is free software; you can„edistribute it‡nd/or \
 it underheerms ofhe GNU General Public License‡s…ublished \
he Free Software Foundation;ƒither version 2, or (at your option) \
†ater version.\n\
\n\
…rogram is distributed inhe hopehat it will be useful, \
 WITHOUT ANY WARRANTY; withoutƒvenhe implied warranty of \
 or FITNESS FOR A PARTICULAR PURPOSE. Seehe \
 General Public License for more details.\n\
\n\
 should have„eceived‡ copy ofhe GNU General Public License \
 withhis…rogram (seehe file COPYING); if‚ot, writeohe \
 Software Foundation, Inc., \
59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.\n\
\n\
 bugreports, fixes,ƒnhancements,-shirts, money, beer &…izzao \
@uni-erlangen.de\n";

509 
	$CİyrightProûss
(
µbuf
, 
¶’
)

510 **
µbuf
;

511 *
¶’
;

513 
dÚe
 = 0;

514 
cİyd©a
 *copydata;

516 
cİyd©a
 = (cİyd©¨*)
æay”
->
l_d©a
;

517 !
dÚe
 && *
¶’
 > 0)

519 **
µbuf
)

522 ià(*
cİyd©a
->
ıs
)

524 
	`cİy·ge
();

530 
	`CİyrightAbÜt
();

531 
dÚe
 = 1;

536 ++*
µbuf
;

537 --*
¶’
;

539 
	}
}

542 
	$CİyrightAbÜt
()

544 
	`LAY_CALL_UP
(
	`LReäeshAÎ
(
æay”
, 0));

545 
	`Ex™Ov”ÏyPage
();

546 
	}
}

549 
	$di¥Ïy_cİyright
()

551 
cİyd©a
 *copydata;

553 ià(
æay”
->
l_width
 < 10 || fÏy”->
l_height
 < 5)

555 
	`LMsg
(0, "Window sizeoo small for copyright…age");

558 ià(
	`In™Ov”ÏyPage
((*
cİyd©a
), &
CİyrightLf
, 0))

560 
cİyd©a
 = (cİyd©¨*)
æay”
->
l_d©a
;

561 
cİyd©a
->
ıs
 = (*)
ımsg
;

562 
cİyd©a
->
§vedıs
 = 0;

563 
æay”
->
l_x
 = 0;

564 
æay”
->
l_y
 = fÏy”->
l_height
 - 1;

565 
	`cİy·ge
();

566 
	}
}

569 
	$cİy·ge
()

571 *
ıs
;

572 *
ws
;

573 
x
, 
y
, 
l
;

574 
cbuf
[80];

575 
cİyd©a
 *copydata;

577 
	`ASSERT
(
æay”
);

578 
cİyd©a
 = (cİyd©¨*)
æay”
->
l_d©a
;

580 
	`LCË¬AÎ
(
æay”
, 0);

581 
x
 = 
y
 = 0;

582 
ıs
 = 
cİyd©a
->cps;

583 
cİyd©a
->
»fıs
 = 
ıs
;

584 
cİyd©a
->
»f§vedıs
 = cİyd©a->
§vedıs
;

585 *
ıs
 && 
y
 < 
æay”
->
l_height
 - 3)

587 
ws
 = 
ıs
;

588 *
ıs
 == ' ')

589 
ıs
++;

590 ià(
	`¡ºcmp
(
ıs
, "%v", 2) == 0)

592 
cİyd©a
->
§vedıs
 = 
ıs
 + 2;

593 
ıs
 = 
v”siÚ
;

596 *
ıs
 && *cps != ' ' && *cps != '\n')

597 
ıs
++;

598 
l
 = 
ıs
 - 
ws
;

599 
ıs
 = 
ws
;

600 ià(
l
 > 
æay”
->
l_width
 - 1)

601 
l
 = 
æay”
->
l_width
 - 1;

602 ià(
x
 && x + 
l
 >ğ
æay”
->
l_width
 - 2)

604 
x
 = 0;

605 
y
++;

608 ià(
x
)

610 
	`LPutCh¬
(
æay”
, &
mch¬_bÏnk
, 
x
, 
y
);

611 
x
++;

613 ià(
l
)

614 
	`LPutSŒ
(
æay”
, 
ws
, 
l
, &
mch¬_bÏnk
, 
x
, 
y
);

615 
x
 +ğ
l
;

616 
ıs
 +ğ
l
;

617 ià(*
ıs
 =ğ0 && 
cİyd©a
->
§vedıs
)

619 
ıs
 = 
cİyd©a
->
§vedıs
;

620 
cİyd©a
->
§vedıs
 = 0;

622 ià(*
ıs
 == '\n')

624 
x
 = 0;

625 
y
++;

627 ià(*
ıs
 == ' ' || *cps == '\n')

628 
ıs
++;

630 *
ıs
 == '\n')

631 
ıs
++;

632 
	`¥rštf
(
cbuf
,"[Press Space %s Returnoƒnd.]",

633 *
ıs
 ? "for‚ext…age;" : "or");

634 
	`ûÁ”lše
(
cbuf
, 
æay”
->
l_height
 - 2);

635 
cİyd©a
->
ıs
 = cps;

636 
	`LayS‘CursÜ
();

637 
	}
}

640 
	$CİyrightRedi¥ÏyLše
(
y
, 
xs
, 
xe
, 
isbÏnk
)

641 
y
, 
xs
, 
xe
, 
isbÏnk
;

643 
	`ASSERT
(
æay”
);

644 ià(
y
 < 0)

646 
cİyd©a
 *copydata;

648 
cİyd©a
 = (cİyd©¨*)
æay”
->
l_d©a
;

649 
cİyd©a
->
ıs
 = cİyd©a->
»fıs
;

650 
cİyd©a
->
§vedıs
 = cİyd©a->
»f§vedıs
;

651 
	`cİy·ge
();

654 ià(
y
 !ğ0 && y !ğ
æay”
->
l_height
 - 1)

656 ià(
isbÏnk
)

658 
	`LCË¬A»a
(
æay”
, 
xs
, 
y
, 
xe
, y, 0, 0);

659 
	}
}

669 #ifdeà
MULTI


671 
Di¥ÏysProûss
 
__P
((**, *));

672 
Di¥ÏysRedi¥ÏyLše
 
__P
((, , , ));

673 
di¥Ïy¥age
 
__P
(());

675 
	sdi¥Ïysd©a


677 
	mdummy_–em’t_fÜ_sŞ¬is
;

680 
LayFuncs
 
	gDi¥ÏysLf
 =

682 
Di¥ÏysProûss
,

683 
H–pAbÜt
,

684 
Di¥ÏysRedi¥ÏyLše
,

685 
DefCË¬Lše
,

686 
DefRewr™e
,

687 
DefResize
,

688 
DefRe¡Üe


692 
	$Di¥ÏysProûss
(
µbuf
, 
¶’
)

693 **
µbuf
;

694 *
¶’
;

696 
dÚe
 = 0;

698 
	`ASSERT
(
æay”
);

699 !
dÚe
 && *
¶’
 > 0)

701 **
µbuf
)

704 
	`di¥Ïy¥age
();

708 
	`H–pAbÜt
();

709 
dÚe
 = 1;

714 ++*
µbuf
;

715 --*
¶’
;

717 
	}
}

721 
	$di¥Ïy_di¥Ïys
()

723 ià(
æay”
->
l_width
 < 10 || fÏy”->
l_height
 < 5)

725 
	`LMsg
(0, "Window sizeoo small for displays…age");

728 ià(
	`In™Ov”ÏyPage
((
di¥Ïysd©a
), &
Di¥ÏysLf
, 0))

730 
æay”
->
l_x
 = 0;

731 
æay”
->
l_y
 = fÏy”->
l_height
 - 1;

732 
	`di¥Ïy¥age
();

733 
	}
}

757 
	$di¥Ïy¥age
()

759 
y
, 
l
;

760 
tbuf
[80];

761 
di¥Ïy
 *
d
;

762 
wš
 *
w
;

763 *
block¡©es
[5] = {"nb", "NB", "Z<", "Z>", "BL"};

765 
	`LCË¬AÎ
(
æay”
, 0);

767 
	`Ëálše
("term-type size user interface window", 0);

768 
	`Ëálše
("---------- ------- ---------- ----------------- ----------", 1);

769 
y
 = 2;

771 
d
 = 
di¥Ïys
; d; d = d->
d_Ãxt
)

773 
w
 = 
d
->
d_fÜe
;

775 ià(
y
 >ğ
æay”
->
l_height
 - 3)

777 
	`¥rštf
(
tbuf
, "%-10.10s%4dx%-4d%10.10s@%-16.16s%s",

778 
d
->
d_‹rmÇme
, d->
d_width
, d->
d_height
, d->
d_u£r
->
u_Çme
,

779 
d
->
d_u£¹ty
,

780 (
d
->
d_blocked
 || d->
d_nÚblock
 >ğ0è&& d->d_blocked <ğ4 ? 
block¡©es
[d->d_blocked] : " ");

782 ià(
w
)

784 
l
 = 10 - 
	`¡¾’
(
w
->
w_t™Ë
);

785 ià(
l
 < 0)

786 
l
 = 0;

787 
	`¥rštf
(
tbuf
 + 
	`¡¾’
(tbuf), "%3d(%.10s)%*s%c%c%c%c",

788 
w
->
w_numb”
, w->
w_t™Ë
, 
l
, "",

797 #ifdeà
MULTIUSER


798 (
	`AşCheckP”mWš
(
d
->
d_u£r
, 
ACL_READ
, 
w
) ? '-' :

799 ((
w
->
w_wlock
 =ğ
WLOCK_OFF
 || 
d
->
d_u£r
 =ğw->
w_wlocku£r
) ?

801 (
	`AşCheckP”mWš
(
d
->
d_u£r
, 
ACL_READ
, 
w
) ? '-' :

802 ((
w
->
w_wlock
 =ğ
WLOCK_OFF
) ? 'w' :

803 ((
d
->
d_u£r
 =ğ
w
->
w_wlocku£r
) ? 'W' : 'v'))),

804 (
	`AşCheckP”mWš
(
d
->
d_u£r
, 
ACL_READ
, 
w
) ? '-' : 'x')

810 
	`Ëálše
(
tbuf
, 
y
);

811 
y
++;

813 
	`¥rštf
(
tbuf
,"[Press Space %s Returnoƒnd.]",

815 
	`ûÁ”lše
(
tbuf
, 
æay”
->
l_height
 - 2);

816 
	`LayS‘CursÜ
();

817 
	}
}

820 
	$Di¥ÏysRedi¥ÏyLše
(
y
, 
xs
, 
xe
, 
isbÏnk
)

821 
y
, 
xs
, 
xe
, 
isbÏnk
;

823 
	`ASSERT
(
æay”
);

824 ià(
y
 < 0)

826 
	`di¥Ïy¥age
();

829 ià(
y
 !ğ0 && y !ğ
æay”
->
l_height
 - 1)

831 ià(
isbÏnk
)

833 
	`LCË¬A»a
(
æay”
, 
xs
, 
y
, 
xe
, y, 0, 0);

835 
	}
}

846 
	gwli¡d©a
;

848 
WLi¡Proûss
 
__P
((**, *));

849 
WLi¡Redi¥ÏyLše
 
__P
((, , , ));

850 
wli¡·ge
 
__P
(());

851 
WLi¡Lše
 
__P
((, , , ));

852 
WLi¡Lšes
 
__P
((, ));

853 
WLi¡Move
 
__P
((, ));

854 
WLi¡Upd©e
 
__P
((
wš
 *));

855 
WLi¡NÜm®ize
 
__P
(());

856 
WLi¡Resize
 
__P
((, ));

857 
WLi¡Next
 
__P
((
wli¡d©a
 *, , ));

859 
	swli¡d©a
 {

860 
	mpos
;

861 
	mypos
;

862 
	mÅos
;

863 
	mnumwš
;

864 
	mfœ¡
;

865 
	mÏ¡
;

866 
	m¡¬t
;

867 
	mÜd”
;

870 
LayFuncs
 
	gWLi¡Lf
 =

872 
WLi¡Proûss
,

873 
H–pAbÜt
,

874 
WLi¡Redi¥ÏyLše
,

875 
DefCË¬Lše
,

876 
DefRewr™e
,

877 
WLi¡Resize
,

878 
DefRe¡Üe


882 
	$WLi¡Resize
(
wi
, 
he
)

883 
wi
, 
he
;

885 
wli¡d©a
 *wlistdata;

886 ià(
wi
 < 10 || 
he
 < 5)

888 
wli¡d©a
 = (wli¡d©¨*)
æay”
->
l_d©a
;

889 
æay”
->
l_width
 = 
wi
;

890 
æay”
->
l_height
 = 
he
;

891 
wli¡d©a
->
numwš
 = 
he
 - 3;

892 ià(
wli¡d©a
->
ypos
 >ğwli¡d©a->
numwš
)

893 
wli¡d©a
->
ypos
 = wli¡d©a->
numwš
 - 1;

894 
æay”
->
l_y
 = 
he
 - 1;

896 
	}
}

899 
	$WLi¡Proûss
(
µbuf
, 
¶’
)

900 **
µbuf
;

901 *
¶’
;

903 
dÚe
 = 0;

904 
wli¡d©a
 *wlistdata;

905 
di¥Ïy
 *
Şddi¥Ïy
 = display;

906 
h
;

908 
	`ASSERT
(
æay”
);

909 
wli¡d©a
 = (wli¡d©¨*)
æay”
->
l_d©a
;

910 
h
 = 
wli¡d©a
->
numwš
;

911 !
dÚe
 && *
¶’
 > 0)

913 ià(()**
µbuf
 >= '0' && ()**ppbuf <= '9')

915 
n
 = ()**
µbuf
 - '0';

916 
d
 = 0;

917 ià(
n
 < 
MAXWIN
 && 
wb
[n])

919 
i
;

920 
d
 = -
wli¡d©a
->
Åos
, 
i
 = 
	`WLi¡Next
(wli¡d©a, -1, 0); i !ğ
n
; i = WListNext(wlistdata, i, 1), d++)

923 ià(
d
)

924 
	`WLi¡Move
(
d
, -1);

926 ()**
µbuf
)

931 
	`WLi¡Move
(-1, -1);

936 
	`WLi¡Move
(1, -1);

939 
	`WLi¡Move
(-(
h
 / 2), 
wli¡d©a
->
ypos
);

942 
	`WLi¡Move
(
h
 / 2, 
wli¡d©a
->
ypos
);

946 
	`WLi¡Move
(-
h
, -1);

950 
	`WLi¡Move
(
h
, -1);

953 
	`WLi¡Move
(-
wli¡d©a
->
pos
, -1);

956 
	`WLi¡Move
(
MAXWIN
, -1);

961 
dÚe
 = 1;

962 
h
 = 
wli¡d©a
->
pos
;

963 ià(!
di¥Ïy
 || !
wb
[
h
] || wb[h] =ğ
D_fÜe
 || (
æay”
->
l_cvli¡
 && fÏy”->l_cvli¡->
c_Êext
))

964 
	`H–pAbÜt
();

965 #ifdeà
MULTIUSER


966 ià(
	`AşCheckP”mWš
(
D_u£r
, 
ACL_READ
, 
wb
[
h
]))

967 
	`H–pAbÜt
();

970 
	`Ex™Ov”ÏyPage
();

972 
di¥Ïy
 = 
Şddi¥Ïy
;

973 
	`Sw™chWšdow
(
h
);

977 
h
 = 
wli¡d©a
->
¡¬t
;

978 
	`H–pAbÜt
();

979 
di¥Ïy
 = 
Şddi¥Ïy
;

980 ià(
h
 >ğ0 && 
wb
[h])

981 
	`Sw™chWšdow
(
h
);

982 ià(
h
 == -2)

984 
wš
 *
p
 = 
	`FšdNiûWšdow
(
di¥Ïy
 ? 
D_Ùh”
 : (win *)0, 0);

985 ià(
p
)

986 
	`Sw™chWšdow
(
p
->
w_numb”
);

988 
dÚe
 = 1;

993 ++*
µbuf
;

994 --*
¶’
;

996 
	}
}

999 
	$WLi¡Lše
(
y
, 
i
, 
pos
, 
isbÏnk
)

1000 
y
, 
i
;

1001 
pos
;

1002 
isbÏnk
;

1004 *
¡r
;

1005 
n
;

1007 
di¥Ïy
 = 0;

1008 
¡r
 = 
	`MakeWšMsgEv
(
wli¡¡r
, 
wb
[
i
], '%', 
æay”
->
l_width
, (
ev’t
 *)0, 0);

1009 
n
 = 
	`¡¾’
(
¡r
);

1010 ià(
i
 !ğ
pos
 && 
isbÏnk
)

1011 
n
 && 
¡r
[n - 1] == ' ')

1012 
n
--;

1013 
	`LPutWšMsg
(
æay”
, 
¡r
, (
i
 =ğ
pos
 || !
isbÏnk
è? fÏy”->
l_width
 : 
n
, i =ğpo ? &
mch¬_so
 : &
mch¬_bÏnk
, 0, 
y
 + 2);

1015 
	`LPutSŒ
(
æay”
, 
¡r
, 
n
, 
i
 =ğ
pos
 ? &
mch¬_so
 : &
mch¬_bÏnk
, 0, 
y
 + 2);

1016 ià(
i
 =ğ
pos
 || !
isbÏnk
)

1017 
n
 < 
æay”
->
l_width
)

1018 
	`LPutCh¬
(
æay”
, 
i
 =ğ
pos
 ? &
mch¬_so
 : &
mch¬_bÏnk
, 
n
++, 
y
 + 2);

1021 
	}
}

1024 
	$WLi¡Next
(
wli¡d©a
, 
Şd
, 
d–
)

1025 
wli¡d©a
 *wlistdata;

1026 
Şd
, 
d–
;

1028 
i
, 
j
;

1030 ià(
Şd
 =ğ
MAXWIN
)

1031  
MAXWIN
;

1032 ià(
wli¡d©a
->
Üd”
 =ğ
WLIST_NUM
)

1034 ià(
Şd
 == -1)

1036 
Şd
 = 0; old < 
MAXWIN
; old++)

1037 ià(
wb
[
Şd
])

1039 ià(
Şd
 =ğ
MAXWIN
)

1040  
Şd
;

1042 ià(!
wb
[
Şd
])

1043  
MAXWIN
;

1044 
i
 = 
Şd
;

1045 
d–
 > 0 && 
i
 < 
MAXWIN
 - 1)

1046 ià(
wb
[++
i
])

1048 
Şd
 = 
i
;

1049 
d–
--;

1051 
d–
 < 0 && 
i
 > 0)

1052 ià(
wb
[--
i
])

1054 
Şd
 = 
i
;

1055 
d–
++;

1060 ià(
Şd
 == -1)

1061 
Şd
 = 
wšdows
->
w_numb”
;

1062 ià(!
wb
[
Şd
])

1063  
MAXWIN
;

1064 ; 
d–
 > 0; delta--)

1065 ià(
wb
[
Şd
]->
w_Ãxt
)

1066 
Şd
 = 
wb
[Şd]->
w_Ãxt
->
w_numb”
;

1067 ià(
d–
 < 0)

1069 
j
 = 
i
 = 
wšdows
->
w_numb”
; j !ğ
Şd
; )

1071 ià(
d–
++ >ğ0 && 
wb
[
i
]->
w_Ãxt
)

1072 
i
 = 
wb
[i]->
w_Ãxt
->
w_numb”
;

1073 ià(
wb
[
j
]->
w_Ãxt
)

1074 
j
 = 
wb
[j]->
w_Ãxt
->
w_numb”
;

1076 
Şd
 = 
i
;

1079  
Şd
;

1080 
	}
}

1083 
	$WLi¡Lšes
(
up
, 
Şdpos
)

1084 
up
, 
Şdpos
;

1086 
wli¡d©a
 *wlistdata;

1087 
ypos
, 
pos
;

1088 
y
, 
i
, 
Şdi
;

1090 
wli¡d©a
 = (wli¡d©¨*)
æay”
->
l_d©a
;

1091 
ypos
 = 
wli¡d©a
->ypos;

1092 
pos
 = 
wli¡d©a
->pos;

1094 
i
 = 
	`WLi¡Next
(
wli¡d©a
, 
pos
, -
ypos
);

1095 
y
 = 0; y < 
wli¡d©a
->
numwš
; y++)

1097 ià(
i
 =ğ
MAXWIN
 || !
wb
[i])

1099 ià(
y
 == 0)

1100 
wli¡d©a
->
fœ¡
 = 
i
;

1101 
wli¡d©a
->
Ï¡
 = 
i
;

1102 ià(((
i
 =ğ
Şdpos
 || i =ğ
pos
è&&…o !ğŞdposè|| (
up
 > 0 && 
y
 >ğ
wli¡d©a
->
numwš
 - up) || (up < 0 && y < -up))

1103 
	`WLi¡Lše
(
y
, 
i
, 
pos
, i !ğ
Şdpos
);

1104 ià(
i
 =ğ
pos
)

1105 
wli¡d©a
->
ypos
 = 
y
;

1106 
Şdi
 = 
i
;

1107 
i
 = 
	`WLi¡Next
(
wli¡d©a
, i, 1);

1108 ià(
i
 =ğ
MAXWIN
 || i =ğ
Şdi
)

1111 
	}
}

1114 
	$WLi¡NÜm®ize
()

1116 
wli¡d©a
 *wlistdata;

1117 
i
, 
Şdi
, 
n
;

1118 
ypos
, 
pos
;

1120 
wli¡d©a
 = (wli¡d©¨*)
æay”
->
l_d©a
;

1121 
ypos
 = 
wli¡d©a
->ypos;

1122 
pos
 = 
wli¡d©a
->pos;

1123 ià(
ypos
 < 0)

1124 
ypos
 = 0;

1125 ià(
ypos
 >ğ
wli¡d©a
->
numwš
)

1126 
ypos
 = 
wli¡d©a
->
numwš
 - 1;

1127 
n
 = 0, 
Şdi
 = 
MAXWIN
, 
i
 = 
pos
; i !ğMAXWIN && i !ğŞd˜&&‚ < 
wli¡d©a
->
numwš
; old˜ği, i = 
	`WLi¡Next
(wlistdata, i, 1))

1128 
n
++;

1129 ià(
ypos
 < 
wli¡d©a
->
numwš
 - 
n
)

1130 
ypos
 = 
wli¡d©a
->
numwš
 - 
n
;

1131 
n
 = 0, 
Şdi
 = 
MAXWIN
, 
i
 = 
	`WLi¡Next
(
wli¡d©a
, -1, 0); i !ğMAXWIN && i !ğŞd˜&& i !ğ
pos
; oldi = i, i = WListNext(wlistdata, i, 1))

1132 
n
++;

1133 ià(
ypos
 > 
n
)

1134 
ypos
 = 
n
;

1135 
wli¡d©a
->
ypos
 = ypos;

1136 
wli¡d©a
->
Åos
 = 
n
;

1137  
ypos
;

1138 
	}
}

1141 
	$WLi¡Move
(
num
, 
ypos
)

1142 
num
;

1143 
ypos
;

1145 
wli¡d©a
 *wlistdata;

1146 
Şdpos
, 
Şdypos
, 
ŞdÅos
;

1147 
pos
, 
up
;

1149 
wli¡d©a
 = (wli¡d©¨*)
æay”
->
l_d©a
;

1150 
Şdpos
 = 
wli¡d©a
->
pos
;

1151 
Şdypos
 = 
wli¡d©a
->
ypos
;

1152 
ŞdÅos
 = 
wli¡d©a
->
Åos
;

1153 
wli¡d©a
->
ypos
 = ypo =ğ-1 ? 
Şdypos
 + 
num
 : ypos;

1154 
pos
 = 
	`WLi¡Next
(
wli¡d©a
, 
Şdpos
, 
num
);

1155 
wli¡d©a
->
pos
 =…os;

1156 
ypos
 = 
	`WLi¡NÜm®ize
();

1157 
up
 = 
wli¡d©a
->
Åos
 - 
ypos
 - (
ŞdÅos
 - 
Şdypos
);

1158 ià(
up
)

1160 
	`LSüŞlV
(
æay”
, 
up
, 2, 2 + 
wli¡d©a
->
numwš
 - 1, 0);

1161 
	`WLi¡Lšes
(
up
, 
Şdpos
);

1162 
	`LayS‘CursÜ
();

1165 ià(
pos
 =ğ
Şdpos
)

1167 
	`WLi¡Lše
(
Şdypos
, 
Şdpos
, 
pos
, 0);

1168 
	`WLi¡Lše
(
ypos
, 
pos
,…os, 1);

1169 
	`LayS‘CursÜ
();

1170 
	}
}

1173 
	$WLi¡Redi¥ÏyLše
(
y
, 
xs
, 
xe
, 
isbÏnk
)

1174 
y
, 
xs
, 
xe
, 
isbÏnk
;

1176 
	`ASSERT
(
æay”
);

1177 ià(
y
 < 0)

1179 
	`wli¡·ge
();

1182 ià(
y
 !ğ0 && y !ğ
æay”
->
l_height
 - 1)

1184 ià(!
isbÏnk
)

1185 
	`LCË¬A»a
(
æay”
, 
xs
, 
y
, 
xe
, y, 0, 0);

1186 
	}
}

1189 
	$di¥Ïy_wli¡
(
ÚbÏnk
, 
Üd”
)

1190 
ÚbÏnk
;

1191 
Üd”
;

1193 
wš
 *
p
;

1194 
wli¡d©a
 *wlistdata;

1196 ià(
æay”
->
l_width
 < 10 || fÏy”->
l_height
 < 5)

1198 
	`LMsg
(0, "Window sizeoo small for window†ist…age");

1201 ià(
ÚbÏnk
)

1203 
	`debug3
("æay” %x %d %x\n", 
æay”
, fÏy”->
l_width
, fÏy”->
l_height
);

1204 ià(!
di¥Ïy
)

1206 
	`LMsg
(0, "windowlist -b: display„equired");

1209 
p
 = 
D_fÜe
;

1210 
	`S‘FÜeWšdow
((
wš
 *)0);

1211 
	`Aùiv©e
(0);

1212 ià(
æay”
->
l_width
 < 10 || fÏy”->
l_height
 < 5)

1214 
	`LMsg
(0, "Window sizeoo small for window†ist…age");

1217 
	`debug3
("æay” %x %d %x\n", 
æay”
, fÏy”->
l_width
, fÏy”->
l_height
);

1220 
p
 = 
	`Lay”2Wšdow
(
æay”
);

1221 ià(
	`In™Ov”ÏyPage
((*
wli¡d©a
), &
WLi¡Lf
, 0))

1223 
wli¡d©a
 = (wli¡d©¨*)
æay”
->
l_d©a
;

1224 
æay”
->
l_x
 = 0;

1225 
æay”
->
l_y
 = fÏy”->
l_height
 - 1;

1226 
wli¡d©a
->
¡¬t
 = 
ÚbÏnk
 && 
p
 ?…->
w_numb”
 : -1;

1227 
wli¡d©a
->
Üd”
 = order;

1228 
wli¡d©a
->
pos
 = 
p
 ?…->
w_numb”
 : 
	`WLi¡Next
(wlistdata, -1, 0);

1229 
wli¡d©a
->
ypos
 = wli¡d©a->
Åos
 = 0;

1230 
wli¡d©a
->
numwš
ğ
æay”
->
l_height
 - 3;

1231 
	`wli¡·ge
();

1232 
	}
}

1235 
	$wli¡·ge
()

1237 
wli¡d©a
 *wlistdata;

1238 *
¡r
;

1239 
pos
;

1241 
wli¡d©a
 = (wli¡d©¨*)
æay”
->
l_d©a
;

1243 
	`LCË¬AÎ
(
æay”
, 0);

1244 ià(
wli¡d©a
->
¡¬t
 >ğ0 && 
wb
[wlistdata->start] == 0)

1245 
wli¡d©a
->
¡¬t
 = -2;

1247 
pos
 = 
wli¡d©a
->pos;

1248 ià(
wb
[
pos
] == 0)

1250 ià(
wli¡d©a
->
Üd”
 =ğ
WLIST_MRU
)

1251 
pos
 = 
	`WLi¡Next
(
wli¡d©a
, -1, wli¡d©a->
Åos
);

1255 ++
pos
 < 
MAXWIN
)

1256 ià(
wb
[
pos
])

1258 ià(
pos
 =ğ
MAXWIN
)

1259 --
pos
 > 0)

1260 ià(
wb
[
pos
])

1264 
wli¡d©a
->
pos
 =…os;

1266 
di¥Ïy
 = 0;

1267 
¡r
 = 
	`MakeWšMsgEv
(
wli¡t™
, (
wš
 *)0, '%', 
æay”
->
l_width
, (
ev’t
 *)0, 0);

1268 
	`LPutWšMsg
(
æay”
, 
¡r
, 
	`¡¾’
(¡r), &
mch¬_bÏnk
, 0, 0);

1269 
	`WLi¡NÜm®ize
();

1270 
	`WLi¡Lšes
(
wli¡d©a
->
numwš
, -1);

1271 
	`LayS‘CursÜ
();

1272 
	}
}

1275 
	$WLi¡Upd©e
(
p
)

1276 
wš
 *
p
;

1278 
wli¡d©a
 *wlistdata;

1279 
i
, 
n
, 
y
;

1281 ià(
p
 == 0)

1283 
	`wli¡·ge
();

1286 
wli¡d©a
 = (wli¡d©¨*)
æay”
->
l_d©a
;

1287 
n
 = 
p
->
w_numb”
;

1288 ià(
wli¡d©a
->
Üd”
 =ğ
WLIST_NUM
 && (
n
 < wli¡d©a->
fœ¡
 ||‚ > wli¡d©a->
Ï¡
))

1290 
i
 = 
wli¡d©a
->
fœ¡
;

1291 
y
 = 0; y < 
wli¡d©a
->
numwš
; y++)

1293 ià(
i
 =ğ
n
)

1295 
i
 = 
	`WLi¡Next
(
wli¡d©a
, i, 1);

1297 ià(
y
 =ğ
wli¡d©a
->
numwš
)

1299 
	`WLi¡Lše
(
y
, 
i
, 
wli¡d©a
->
pos
, 0);

1300 
	`LayS‘CursÜ
();

1301 
	}
}

1304 
	$WLi¡Upd©ecv
(
cv
, 
p
)

1305 
ÿnvas
 *
cv
;

1306 
wš
 *
p
;

1308 ià(
cv
->
c_Ïy”
->
l_Ïyâ
 !ğ&
WLi¡Lf
)

1310 
	`CV_CALL
(
cv
, 
	`WLi¡Upd©e
(
p
));

1311 
	}
}

1314 
	$WLi¡LškChªged
()

1316 
di¥Ïy
 *
Şddi¥Ïy
 = display;

1317 
ÿnvas
 *
cv
;

1318 
wli¡d©a
 *wlistdata;

1320 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

1321 
cv
 = 
D_cvli¡
; cv; cv = cv->
c_Ãxt
)

1323 ià(
cv
->
c_Ïy”
->
l_Ïyâ
 !ğ&
WLi¡Lf
)

1325 
wli¡d©a
 = (wli¡d©¨*)
cv
->
c_Ïy”
->
l_d©a
;

1326 ià(
wli¡d©a
->
Üd”
 !ğ
WLIST_MRU
)

1328 
	`CV_CALL
(
cv
, 
	`WLi¡Upd©e
(0));

1330 
di¥Ïy
 = 
Şddi¥Ïy
;

1331 
	}
}

1334 
	$InWLi¡
()

1336 ià(
æay”
 && fÏy”->
l_Ïyâ
 =ğ&
WLi¡Lf
)

1339 
	}
}

1349 #ifdeà
MAPKEYS


1351 
‹rm
erm[];

1352 
km­_ext
 *
km­_exts
;

1353 
km­_exŠ
;

1354 
aùiÚ
 
dmb
[];

1355 
aùiÚ
 
mmb
[];

1358 
BšdkeyProûss
 
__P
((**, *));

1359 
BšdkeyAbÜt
 
__P
(());

1360 
BšdkeyRedi¥ÏyLše
 
__P
((, , , ));

1361 
bšdkey·ge
 
__P
(());

1363 
	sbšdkeyd©a


1365 *
	mt™Ë
;

1366 
aùiÚ
 *
	mb
;

1367 
	mpos
;

1368 
	mÏ¡
;

1369 
	m·ge
;

1370 
	m·ges
;

1373 
LayFuncs
 
	gBšdkeyLf
 =

1375 
BšdkeyProûss
,

1376 
BšdkeyAbÜt
,

1377 
BšdkeyRedi¥ÏyLše
,

1378 
DefCË¬Lše
,

1379 
DefRewr™e
,

1380 
DefResize
,

1381 
DefRe¡Üe


1386 
	$di¥Ïy_bšdkey
(
t™Ë
, 
b
)

1387 *
t™Ë
;

1388 
aùiÚ
 *
b
;

1390 
bšdkeyd©a
 *bindkeydata;

1391 
i
, 
n
;

1393 ià(
æay”
->
l_height
 < 6)

1395 
	`LMsg
(0, "Window heightoo small for bindkey…age");

1398 ià(
	`In™Ov”ÏyPage
((*
bšdkeyd©a
), &
BšdkeyLf
, 0))

1401 
bšdkeyd©a
 = (bšdkeyd©¨*)
æay”
->
l_d©a
;

1402 
bšdkeyd©a
->
t™Ë
 =itle;

1403 
bšdkeyd©a
->
b
 =ab;

1405 
n
 = 0;

1406 
i
 = 0; i < 
KMAP_KEYS
+
KMAP_AKEYS
+
km­_exŠ
; i++)

1408 ià(
b
[
i
].
Ä
 !ğ
RC_ILLEGAL
)

1409 
n
++;

1411 
bšdkeyd©a
->
pos
 = 0;

1412 
bšdkeyd©a
->
·ge
 = 1;

1413 
bšdkeyd©a
->
·ges
 = (
n
 + 
æay”
->
l_height
 - 6) / (flayer->l_height - 5);

1414 ià(
bšdkeyd©a
->
·ges
 == 0)

1415 
bšdkeyd©a
->
·ges
 = 1;

1416 
æay”
->
l_x
 = 0;

1417 
æay”
->
l_y
 = fÏy”->
l_height
 - 1;

1418 
	`bšdkey·ge
();

1419 
	}
}

1422 
	$BšdkeyAbÜt
()

1424 
	`LAY_CALL_UP
(
	`LReäeshAÎ
(
æay”
, 0));

1425 
	`Ex™Ov”ÏyPage
();

1426 
	}
}

1429 
	$bšdkey·ge
()

1431 
bšdkeyd©a
 *bindkeydata;

1432 
km­_ext
 *
kme
;

1433 
tbuf
[256];

1434 
d–
, 
i
, 
y
, 
¦
;

1435 
aùiÚ
 *
aù
;

1436 *
xch
, *
s
, *
p
;

1438 
bšdkeyd©a
 = (bšdkeyd©¨*)
æay”
->
l_d©a
;

1440 
	`LCË¬AÎ
(
æay”
, 0);

1442 
	`¥rštf
(
tbuf
, "% key bšdšgs,…ag%d oà%d.", 
bšdkeyd©a
->
t™Ë
, bšdkeyd©a->
·ge
, bšdkeyd©a->
·ges
);

1443 
	`ûÁ”lše
(
tbuf
, 0);

1444 
y
 = 2;

1445 
i
 = 
bšdkeyd©a
->
pos
; i < 
KMAP_KEYS
+
KMAP_AKEYS
+
km­_exŠ
 && 
y
 < 
æay”
->
l_height
 - 3; i++)

1447 
p
 = 
tbuf
;

1448 
xch
 = " ";

1449 ià(
i
 < 
KMAP_KEYS
)

1451 
aù
 = &
bšdkeyd©a
->
b
[
i
];

1452 ià(
aù
->
Ä
 =ğ
RC_ILLEGAL
)

1454 
d–
 = *
p
++ = ':';

1455 
s
 = 
‹rm
[
i
 + 
T_CAPS
].
túame
;

1456 
¦
 = 
s
 ? 
	`¡¾’
(s) : 0;

1458 ià(
i
 < 
KMAP_KEYS
+
KMAP_AKEYS
)

1460 
aù
 = &
bšdkeyd©a
->
b
[
i
];

1461 ià(
aù
->
Ä
 =ğ
RC_ILLEGAL
)

1463 
d–
 = *
p
++ = ':';

1464 
s
 = 
‹rm
[
i
 + (
T_CAPS
 - 
T_OCAPS
 + 
T_CURSOR
)].
túame
;

1465 
¦
 = 
s
 ? 
	`¡¾’
(s) : 0;

1466 
xch
 = "[A]";

1470 
kme
 = 
km­_exts
 + (
i
 - (
KMAP_KEYS
+
KMAP_AKEYS
));

1471 
d–
 = 0;

1472 
s
 = 
kme
->
¡r
;

1473 
¦
 = 
kme
->
æ
 & ~
KMAP_NOTIMEOUT
;

1474 ià((
kme
->
æ
 & 
KMAP_NOTIMEOUT
) != 0)

1475 
xch
 = "[T]";

1476 
aù
 = 
bšdkeyd©a
->
b
 =ğ
dmb
 ? &
kme
->
dm
 : bšdkeyd©a->b =ğ
mmb
 ? &kme->
mm
 : &kme->
um
;

1477 ià(
aù
->
Ä
 =ğ
RC_ILLEGAL
)

1480 
¦
-- > 0)

1481 
p
 +ğ
	`AddXCh¬
Õ, *(*)
s
++);

1482 ià(
d–
)

1483 *
p
++ = 
d–
;

1484 *
p
++ = ' ';

1485 
p
 < 
tbuf
 + 15)

1486 *
p
++ = ' ';

1487 
	`¥rštf
(
p
, "% -> ", 
xch
);

1488 
p
 += 7;

1489 ià(
p
 - 
tbuf
 > 
æay”
->
l_width
 - 1)

1491 
tbuf
[
æay”
->
l_width
 - 2] = '$';

1492 
tbuf
[
æay”
->
l_width
 - 1] = 0;

1494 
	`PadSŒ
(
tbuf
, 
	`¡¾’
Ñbuf), 0, 
y
);

1495 
	`AddAùiÚ
(
aù
, 
	`¡¾’
(
tbuf
), 
y
);

1496 
y
++;

1498 
y
++;

1499 
bšdkeyd©a
->
Ï¡
 = 
i
;

1500 
	`¥rštf
(
tbuf
,"[P»s S·û % R‘uºØ’d.]", 
bšdkeyd©a
->
·ge
 < bšdkeyd©a->
·ges
 ? "for‚ext…age;" : "or");

1501 
	`ûÁ”lše
(
tbuf
, 
æay”
->
l_height
 - 2);

1502 
	`LayS‘CursÜ
();

1503 
	}
}

1506 
	$BšdkeyProûss
(
µbuf
, 
¶’
)

1507 **
µbuf
;

1508 *
¶’
;

1510 
dÚe
 = 0;

1511 
bšdkeyd©a
 *bindkeydata;

1513 
bšdkeyd©a
 = (bšdkeyd©¨*)
æay”
->
l_d©a
;

1514 !
dÚe
 && *
¶’
 > 0)

1516 **
µbuf
)

1519 ià(
bšdkeyd©a
->
·ge
 < bšdkeyd©a->
·ges
)

1521 
bšdkeyd©a
->
pos
 = bšdkeyd©a->
Ï¡
;

1522 
bšdkeyd©a
->
·ge
++;

1523 
	`bšdkey·ge
();

1529 
dÚe
 = 1;

1534 ++*
µbuf
;

1535 --*
¶’
;

1537 ià(
dÚe
)

1538 
	`BšdkeyAbÜt
();

1539 
	}
}

1542 
	$BšdkeyRedi¥ÏyLše
(
y
, 
xs
, 
xe
, 
isbÏnk
)

1543 
y
, 
xs
, 
xe
, 
isbÏnk
;

1545 ià(
y
 < 0)

1547 
	`bšdkey·ge
();

1550 ià(
y
 !ğ0 && y !ğ
æay”
->
l_height
 - 1)

1552 ià(!
isbÏnk
)

1553 
	`LCË¬A»a
(
æay”
, 
xs
, 
y
, 
xe
, y, 0, 0);

1554 
	}
}

1565 #ifdeà
ZMODEM


1567 
ZmodemRedi¥ÏyLše
 
__P
((, , , ));

1568 
ZmodemResize
 
__P
((, ));

1570 
LayFuncs
 
	gZmodemLf
 =

1572 
DefProûss
,

1574 
ZmodemRedi¥ÏyLše
,

1575 
DefCË¬Lše
,

1576 
DefRewr™e
,

1577 
ZmodemResize
,

1578 
DefRe¡Üe


1583 
	$ZmodemResize
(
wi
, 
he
)

1584 
wi
, 
he
;

1586 
æay”
->
l_width
 = 
wi
;

1587 
æay”
->
l_height
 = 
he
;

1588 
æay”
->
l_x
 = fÏy”->
l_width
 > 32 ? 32 : 0;

1590 
	}
}

1593 
	$ZmodemRedi¥ÏyLše
(
y
, 
xs
, 
xe
, 
isbÏnk
)

1594 
y
, 
xs
, 
xe
, 
isbÏnk
;

1596 
	`DefRedi¥ÏyLše
(
y
, 
xs
, 
xe
, 
isbÏnk
);

1597 ià(
y
 =ğ0 && 
xs
 == 0)

1598 
	`LPutSŒ
(
æay”
, "Zmodem‡ùivÚ‡nÙh” di¥Ïy", fÏy”->
l_width
 > 32 ? 32 : fÏy”->l_width, &
mch¬_bÏnk
, 0, 0);

1599 
	}
}

1602 
	$ZmodemPage
()

1604 ià(
	`In™Ov”ÏyPage
(1, &
ZmodemLf
, 1))

1606 
	`LReäeshAÎ
(
æay”
, 0);

1607 
æay”
->
l_x
 = fÏy”->
l_width
 > 32 ? 32 : 0;

1608 
æay”
->
l_y
 = 0;

1609 
	}
}

1616 
	$PadSŒ
(
¡r
, 
n
, 
x
, 
y
)

1617 *
¡r
;

1618 
n
, 
x
, 
y
;

1620 
l
;

1622 
l
 = 
	`¡¾’
(
¡r
);

1623 ià(
l
 > 
n
)

1624 
l
 = 
n
;

1625 
	`LPutSŒ
(
æay”
, 
¡r
, 
l
, &
mch¬_bÏnk
, 
x
, 
y
);

1626 ià(
l
 < 
n
)

1627 
	`LPutSŒ
(
æay”
, (*)
bÏnk
, 
n
 - 
l
, &
mch¬_bÏnk
, 
x
 +†, 
y
);

1628 
	}
}

	@image.h

26 #undeà
IFFONT


27 #undeà
IFCOLOR


29 #ifdeà
FONT


30 
	#IFFONT
(
x
è
	)
x

32 
	#IFFONT
(
x
)

	)

35 #ifdeà
COLOR


36 
	#IFCOLOR
(
x
è
	)
x

38 
	#IFCOLOR
(
x
)

	)

41 #ià
defšed
(
COLOR
è&& defšed(
COLORS16
è&& defšed(
COLORS256
)

42 
	#IFCOLORX
(
x
è
	)
x

44 
	#IFCOLORX
(
x
)

	)

47 #ifdeà
DW_CHARS


48 
	#IFDWCHAR
(
x
è
	)
x

50 
	#IFDWCHAR
(
x
)

	)

53 
	smch¬
 {

54 
	mimage
;

55 
	m©Œ
;

56 
IFFONT
Ğ
fÚt
; )

57 
IFCOLOR
Ğ
cŞÜ
; )

58 
IFCOLORX
(
cŞÜx
; )

59 
IFDWCHAR
(
mbcs
; )

62 
	smlše
 {

63 *
	mimage
;

64 *
	m©Œ
;

65 
IFFONT
Ğ*
fÚt
; )

66 
IFCOLOR
Ğ*
cŞÜ
; )

67 
IFCOLORX
(*
cŞÜx
; )

72 
	#§ve_mlše
(
ml
, 
n
) do { \

73 
	`bcİy
((*)(
ml
)->
image
, (*)
mlše_Şd
.image, (
n
)); \

74 
	`bcİy
((*)(
ml
)->
©Œ
, (*)
mlše_Şd
.©Œ, (
n
)); \

75 
	`IFFONT
Ğ
	`bcİy
((*)(
ml
)->
fÚt
, (*)
mlše_Şd
.fÚt, (
n
)); ) \

76 
	`IFCOLOR
Ğ
	`bcİy
((*)(
ml
)->
cŞÜ
, (*)
mlše_Şd
.cŞÜ, (
n
)); ) \

77 
	`IFCOLORX
(
	`bcİy
((*)(
ml
)->
cŞÜx
, (*)
mlše_Şd
.cŞÜx, (
n
)); ) \

78 } 0)

	)

80 
	#bcİy_mlše
(
ml
, 
xf
, 
xt
, 
n
) do { \

81 
	`bcİy
((*)(
ml
)->
image
 + (
xf
), (*)(ml)->imag+ (
xt
), (
n
)); \

82 
	`bcİy
((*)(
ml
)->
©Œ
 + (
xf
), (*)(ml)->©Œ + (
xt
), (
n
)); \

83 
	`IFFONT
Ğ
	`bcİy
((*)(
ml
)->
fÚt
 + (
xf
), (*)(ml)->fÚˆ+ (
xt
), (
n
)); ) \

84 
	`IFCOLOR
Ğ
	`bcİy
((*)(
ml
)->
cŞÜ
 + (
xf
), (*)(ml)->cŞÜ + (
xt
), (
n
)); ) \

85 
	`IFCOLORX
(
	`bcİy
((*)(
ml
)->
cŞÜx
 + (
xf
), (*)(ml)->cŞÜx + (
xt
), (
n
));) \

86 } 0)

	)

88 
	#ş—r_mlše
(
ml
, 
x
, 
n
) do { \

89 
	`bş—r
((*)(
ml
)->
image
 + (
x
), (
n
)); \

90 ià((
ml
)->
©Œ
 !ğ
nuÎ
è
	`bz”o
((*)(ml)->©Œ + (
x
), (
n
)); \

91 
	`IFFONT
Ğià((
ml
)->
fÚt
 !ğ
nuÎ
è
	`bz”o
((*)(ml)->fÚˆ+ (
x
), (
n
)); ) \

92 
	`IFCOLOR
Ğià((
ml
)->
cŞÜ
!ğ
nuÎ
è
	`bz”o
((*)(ml)->cŞÜ + (
x
), (
n
)); ) \

93 
	`IFCOLORX
(ià((
ml
)->
cŞÜx
!ğ
nuÎ
è
	`bz”o
((*)(ml)->cŞÜx + (
x
), (
n
)); ) \

94 } 0)

	)

96 
	#cmp_mlše
(
ml1
, 
ml2
, 
x
) ( \

97 (
ml1
)->
image
[
x
] =ğ(
ml2
)->image[x] \

98 && (
ml1
)->
©Œ
[
x
] =ğ(
ml2
)->attr[x] \

99 
	`IFFONT
Ğ&& (
ml1
)->
fÚt
[
x
] =ğ(
ml2
)->font[x] ) \

100 
	`IFCOLOR
Ğ&& (
ml1
)->
cŞÜ
[
x
] =ğ(
ml2
)->color[x] ) \

101 
	`IFCOLORX
(&& (
ml1
)->
cŞÜx
[
x
] =ğ(
ml2
)->colorx[x] ) \

102 )

	)

104 
	#cmp_mch¬
(
mc1
, 
mc2
) ( \

105 (
mc1
)->
image
 =ğ(
mc2
)->image \

106 && (
mc1
)->
©Œ
 =ğ(
mc2
)->attr \

107 
	`IFFONT
Ğ&& (
mc1
)->
fÚt
 =ğ(
mc2
)->font ) \

108 
	`IFCOLOR
Ğ&& (
mc1
)->
cŞÜ
 =ğ(
mc2
)->color ) \

109 
	`IFCOLORX
(&& (
mc1
)->
cŞÜx
 =ğ(
mc2
)->colorx ) \

110 )

	)

112 
	#cmp_mch¬_mlše
(
mc
, 
ml
, 
x
) ( \

113 (
mc
)->
image
 =ğ(
ml
)->image[
x
] \

114 && (
mc
)->
©Œ
 =ğ(
ml
)->©Œ[
x
] \

115 
	`IFFONT
Ğ&& (
mc
)->
fÚt
 =ğ(
ml
)->fÚt[
x
] ) \

116 
	`IFCOLOR
Ğ&& (
mc
)->
cŞÜ
 =ğ(
ml
)->cŞÜ[
x
] ) \

117 
	`IFCOLORX
(&& (
mc
)->
cŞÜx
 =ğ(
ml
)->cŞÜx[
x
] ) \

118 )

	)

120 
	#cİy_mch¬2mlše
(
mc
, 
ml
, 
x
) do { \

121 (
ml
)->
image
[
x
] = (
mc
)->image; \

122 (
ml
)->
©Œ
[
x
] = (
mc
)->attr; \

123 
	`IFFONT
Ğ(
ml
)->
fÚt
[
x
] = (
mc
)->font; ) \

124 
	`IFCOLOR
Ğ(
ml
)->
cŞÜ
[
x
] = (
mc
)->color; ) \

125 
	`IFCOLORX
((
ml
)->
cŞÜx
[
x
] = (
mc
)->colorx; ) \

126 } 0)

	)

128 
	#cİy_mlše2mch¬
(
mc
, 
ml
, 
x
) do { \

129 (
mc
)->
image
 = (
ml
)->image[
x
]; \

130 (
mc
)->
©Œ
 = (
ml
)->©Œ[
x
]; \

131 
	`IFFONT
Ğ(
mc
)->
fÚt
 = (
ml
)->fÚt[
x
]; ) \

132 
	`IFCOLOR
Ğ(
mc
)->
cŞÜ
 = (
ml
)->cŞÜ[
x
]; ) \

133 
	`IFCOLORX
((
mc
)->
cŞÜx
 = (
ml
)->cŞÜx[
x
]; ) \

134 
	`IFDWCHAR
((
mc
)->
mbcs
 = 0; ) \

135 } 0)

	)

137 #ifdeà
COLOR


138 #ifdeà
COLORS16


139 #ifdeà
COLORS256


140 
	#»nd_g‘bg
(
mc
è(((mc)->
cŞÜ
 & 0xf0è>> 4 | ((mc)->
©Œ
 & 
A_BBG
 ? 0x100 : 0è| ((mc)->
cŞÜx
 & 0xf0))

	)

141 
	#»nd_£tbg
(
mc
, 
c
è((mc)->
cŞÜ
 = ((mc)->cŞÜ & 0x0fè| (ø<< 4 & 0xf0), (mc)->
cŞÜx
 = ((mc)->cŞÜx & 0x0fè| (ø& 0xf0), (mc)->
©Œ
 = ((mc)->©Œ | 
A_BBG
è^ (ø& 0x100 ? 0 : A_BBG))

	)

142 
	#»nd_g‘fg
(
mc
è(((mc)->
cŞÜ
 & 0x0fè| ((mc)->
©Œ
 & 
A_BFG
 ? 0x100 : 0è| (((mc)->
cŞÜx
 & 0x0fè<< 4))

	)

143 
	#»nd_£tfg
(
mc
, 
c
è((mc)->
cŞÜ
 = ((mc)->cŞÜ & 0xf0è| (ø& 0x0f), (mc)->
cŞÜx
 = ((mc)->cŞÜx & 0xf0è| ((ø& 0xf0è>> 4), (mc)->
©Œ
 = ((mc)->©Œ | 
A_BFG
è^ (ø& 0x100 ? 0 : A_BFG))

	)

144 
	#»nd_£tdeçuÉ
(
mc
è((mc)->
cŞÜ
 = (mc)->
cŞÜx
 = 0, (mc)->
©Œ
 &ğ~(
A_BBG
|
A_BFG
))

	)

146 
	#»nd_g‘bg
(
mc
è(((mc)->
cŞÜ
 & 0xf0è>> 4 | ((mc)->
©Œ
 & 
A_BBG
 ? 0x100 : 0))

	)

147 
	#»nd_£tbg
(
mc
, 
c
è((mc)->
cŞÜ
 = ((mc)->cŞÜ & 0x0fè| (ø<< 4 & 0xf0), (mc)->
©Œ
 = ((mc)->©Œ | 
A_BBG
è^ (ø& 0x100 ? 0 : A_BBG))

	)

148 
	#»nd_g‘fg
(
mc
è(((mc)->
cŞÜ
 & 0x0fè| ((mc)->
©Œ
 & 
A_BFG
 ? 0x100 : 0))

	)

149 
	#»nd_£tfg
(
mc
, 
c
è((mc)->
cŞÜ
 = ((mc)->cŞÜ & 0xf0è| (ø& 0x0f), (mc)->
©Œ
 = ((mc)->©Œ | 
A_BFG
è^ (ø& 0x100 ? 0 : A_BFG))

	)

150 
	#»nd_£tdeçuÉ
(
mc
è((mc)->
cŞÜ
 = 0, (mc)->
©Œ
 &ğ~(
A_BBG
|
A_BFG
))

	)

152 
	#cŞi2e
(
c
è((((cè& 0x1f8è=ğ0x108 ? (cè^ 0x108 : (ø& 0xff)è^ 9)

	)

153 
	#cŞe2i
(
c
è((cè>ğ8 && (cè< 16 ? (cè^ 0x109 : (cè^ 9)

	)

155 
	#»nd_g‘bg
(
mc
è(((mc)->
cŞÜ
 & 0xf0è>> 4)

	)

156 
	#»nd_£tbg
(
mc
, 
c
è((mc)->
cŞÜ
 = ((mc)->cŞÜ & 0x0fè| (ø<< 4 & 0xf0))

	)

157 
	#»nd_g‘fg
(
mc
è((mc)->
cŞÜ
 & 0x0f)

	)

158 
	#»nd_£tfg
(
mc
, 
c
è((mc)->
cŞÜ
 = ((mc)->cŞÜ & 0xf0è| (ø& 0x0f))

	)

159 
	#»nd_£tdeçuÉ
(
mc
è((mc)->
cŞÜ
 = 0)

	)

160 
	#cŞi2e
(
c
è((cè^ 9)

	)

161 
	#cŞe2i
(
c
è((cè^ 9)

	)

	@input.c

24 
	~<sys/ty³s.h
>

25 
	~"cÚfig.h
"

26 
	~"sü“n.h
"

27 
	~"ex‹º.h
"

29 
	#INPUTLINE
 (
æay”
->
l_height
 - 1)

	)

31 
IÅProûss
 
__P
((**, *));

32 
IÅAbÜt
 
__P
(());

33 
IÅRedi¥ÏyLše
 
__P
((, , , ));

35 
Ïy”
 *
æay”
;

36 
di¥Ïy
 *display;

37 
mch¬
 
mch¬_bÏnk
, 
mch¬_so
;

39 
	sš¶še


41 
	mbuf
[101];

42 
	mËn
;

43 
	mpos
;

46 
š¶še
 
	gšphi¡
;

49 
	sšpd©a


51 
š¶še
 
	mšp
;

52 
	mšpmaxËn
;

53 *
	mšp¡ršg
;

54 
	mšp¡ršgËn
;

55 
	mšpmode
;

56 (*
	mšpfšfunc
è
__P
((*
buf
, 
Ën
, *
´iv
));

57 *
	m´iv
;

60 
LayFuncs
 
	gIÅLf
 =

62 
IÅProûss
,

63 
IÅAbÜt
,

64 
IÅRedi¥ÏyLše
,

65 
DefCË¬Lše
,

66 
DefRewr™e
,

67 
DefResize
,

68 
DefRe¡Üe


77 
	$šp_£rom±
(
p
, 
s
)

78 *
p
, *
s
;

80 
špd©a
 *inpdata;

82 
špd©a
 = (špd©¨*)
æay”
->
l_d©a
;

83 ià(
p
)

85 
špd©a
->
šp¡ršgËn
 = 
	`¡¾’
(
p
);

86 
špd©a
->
šp¡ršg
 = 
p
;

88 ià(
s
)

90 ià(
s
 !ğ
špd©a
->
šp
.
buf
)

91 
	`¡ºıy
(
špd©a
->
šp
.
buf
, 
s
, (inpdata->inp.buf) - 1);

92 
špd©a
->
šp
.
buf
[(inpdata->inp.buf) - 1] = 0;

93 
špd©a
->
šp
.
pos
 = iÅd©a->šp.
Ën
 = 
	`¡¾’
(špd©a->šp.
buf
);

95 
	`IÅRedi¥ÏyLše
(
INPUTLINE
, 0, 
æay”
->
l_width
 - 1, 0);

96 
	}
}

109 
	$IÅut
(
i¡r
, 
Ën
, 
mode
, 
fšfunc
, 
d©a
)

110 *
i¡r
;

111 
Ën
;

112 
mode
;

113 (*
fšfunc
è
	`__P
((*
buf
, 
Ën
, *
d©a
));

114 *
d©a
;

116 
maxËn
;

117 
špd©a
 *inpdata;

119 ià(
Ën
 > 100)

120 
Ën
 = 100;

121 ià(!(
mode
 & 
INP_NOECHO
))

123 
maxËn
 = 
æay”
->
l_width
 - 1 - 
	`¡¾’
(
i¡r
);

124 ià(
Ën
 > 
maxËn
)

125 
Ën
 = 
maxËn
;

127 ià(
Ën
 < 0)

129 
	`LMsg
(0, "Width %d ch¬ toØsm®l", -
Ën
);

132 ià(
	`In™Ov”ÏyPage
((*
špd©a
), &
IÅLf
, 1))

134 
špd©a
 = (špd©¨*)
æay”
->
l_d©a
;

135 
špd©a
->
špmaxËn
 = 
Ën
;

136 
špd©a
->
špfšfunc
 = 
fšfunc
;

137 
špd©a
->
šp
.
pos
 = iÅd©a->šp.
Ën
 = 0;

138 
špd©a
->
špmode
 = 
mode
;

139 
špd©a
->
´iv
 = 
d©a
;

140 
	`šp_£rom±
(
i¡r
, (*)
NULL
);

141 
æay”
->
l_x
 = 
špd©a
->
šp¡ršgËn
;

142 
æay”
->
l_y
 = 
INPUTLINE
;

143 
	}
}

146 
	$IÅProûss
(
µbuf
, 
¶’
)

147 **
µbuf
;

148 *
¶’
;

150 
Ën
, 
x
;

151 *
pbuf
;

152 
ch
;

153 
špd©a
 *inpdata;

154 
di¥Ïy
 *
špdi¥Ïy
;

156 
špd©a
 = (špd©¨*)
æay”
->
l_d©a
;

157 
špdi¥Ïy
 = 
di¥Ïy
;

159 
	`LGÙoPos
(
æay”
, 
špd©a
->
šp¡ršgËn
 + (špd©a->
špmode
 & 
INP_NOECHO
 ? 0 : iÅd©a->
šp
.
pos
), 
INPUTLINE
);

160 ià(
µbuf
 == 0)

162 
	`IÅAbÜt
();

165 
x
 = 
špd©a
->
šp¡ršgËn
 + iÅd©a->
šp
.
pos
;

166 
Ën
 = *
¶’
;

167 
pbuf
 = *
µbuf
;

168 
Ën
)

170 *
p
 = 
špd©a
->
šp
.
buf
 + iÅd©a->šp.
pos
;

172 
ch
 = *
pbuf
++;

173 
Ën
--;

174 ià(
špd©a
->
špmode
 & 
INP_EVERY
)

176 
špd©a
->
šp
.
buf
[špd©a->šp.
Ën
] = 
ch
;

177 
špd©a
->
šp
.
buf
[špd©a->šp.
Ën
 + 1] = 
ch
;

178 
di¥Ïy
 = 
špdi¥Ïy
;

179 (*
špd©a
->
špfšfunc
)(špd©a->
šp
.
buf
, iÅd©a->šp.
Ën
, iÅd©a->
´iv
);

180 
ch
 = 
špd©a
->
šp
.
buf
[špd©a->šp.
Ën
];

182 ià(
špd©a
->
špmode
 & 
INP_RAW
)

184 
di¥Ïy
 = 
špdi¥Ïy
;

185 (*
špd©a
->
špfšfunc
)(&
ch
, 1, iÅd©a->
´iv
);

186 ià(
ch
)

189 ià((()
ch
 & 0177è>ğ' ' && ch !ğ0177 && 
špd©a
->
šp
.
Ën
 < iÅd©a->
špmaxËn
)

191 ià(
špd©a
->
šp
.
Ën
 > iÅd©a->šp.
pos
)

192 
	`bcİy
(
p
,…+1, 
špd©a
->
šp
.
Ën
 - iÅd©a->šp.
pos
);

193 
špd©a
->
šp
.
buf
[špd©a->šp.
pos
++] = 
ch
;

194 
špd©a
->
šp
.
Ën
++;

196 ià(!(
špd©a
->
špmode
 & 
INP_NOECHO
))

198 
mch¬
 
mc
;

199 
mc
 = 
mch¬_so
;

200 
mc
.
image
 = *
p
++;

201 
	`LPutCh¬
(
æay”
, &
mc
, 
x
, 
INPUTLINE
);

202 
x
++;

203 ià(
p
 < 
špd©a
->
šp
.
buf
+špd©a->šp.
Ën
)

205 
p
 < 
špd©a
->
šp
.
buf
+špd©a->šp.
Ën
)

207 
mc
.
image
 = *
p
++;

208 
	`LPutCh¬
(
æay”
, &
mc
, 
x
++, 
INPUTLINE
);

210 
x
 = 
špd©a
->
šp¡ršgËn
 + iÅd©a->
šp
.
pos
;

211 
	`LGÙoPos
(
æay”
, 
x
, 
INPUTLINE
);

215 ià((
ch
 =ğ'\b' || ch =ğ0177è&& 
špd©a
->
šp
.
pos
 > 0)

217 ià(
špd©a
->
šp
.
Ën
 > iÅd©a->šp.
pos
)

218 
	`bcİy
(
p
,…-1, 
špd©a
->
šp
.
Ën
 - iÅd©a->šp.
pos
);

219 
špd©a
->
šp
.
Ën
--;

220 
špd©a
->
šp
.
pos
--;

221 
p
--;

223 ià(!(
špd©a
->
špmode
 & 
INP_NOECHO
))

225 
mch¬
 
mc
;

226 
mc
 = 
mch¬_so
;

227 
x
--;

228 
p
 < 
špd©a
->
šp
.
buf
+špd©a->šp.
Ën
)

230 
mc
.
image
 = *
p
++;

231 
	`LPutCh¬
(
æay”
, &
mc
, 
x
++, 
INPUTLINE
);

233 
	`LPutCh¬
(
æay”
, &
mch¬_bÏnk
, 
x
, 
INPUTLINE
);

234 
x
 = 
špd©a
->
šp¡ršgËn
 + iÅd©a->
šp
.
pos
;

235 
	`LGÙoPos
(
æay”
, 
x
, 
INPUTLINE
);

238 ià(
ch
 == '\025')

240 
x
 = 
špd©a
->
šp¡ršgËn
;

241 ià(
špd©a
->
šp
.
Ën
 && !(špd©a->
špmode
 & 
INP_NOECHO
))

243 
	`LCË¬A»a
(
æay”
, 
x
, 
INPUTLINE
, x + 
špd©a
->
šp
.
Ën
 - 1, INPUTLINE, 0, 0);

244 
	`LGÙoPos
(
æay”
, 
x
, 
INPUTLINE
);

246 
špd©a
->
šp
.
Ën
 = iÅd©a->šp.
pos
 = 0;

248 ià(
ch
 == '\013')

250 
x
 = 
špd©a
->
šp¡ršgËn
 + iÅd©a->
šp
.
pos
;

251 ià(
špd©a
->
šp
.
Ën
 > iÅd©a->šp.
pos
 && !(špd©a->
špmode
 & 
INP_NOECHO
))

253 
	`LCË¬A»a
(
æay”
, 
x
, 
INPUTLINE
, x + 
špd©a
->
šp
.
Ën
 - iÅd©a->šp.
pos
 - 1, INPUTLINE, 0, 0);

254 
	`LGÙoPos
(
æay”
, 
x
, 
INPUTLINE
);

256 
špd©a
->
šp
.
Ën
 = iÅd©a->šp.
pos
;

258 ià(
ch
 == '\001' || ()ch == 0201)

260 
	`LGÙoPos
(
æay”
, 
x
 -ğ
špd©a
->
šp
.
pos
, 
INPUTLINE
);

261 
špd©a
->
šp
.
pos
 = 0;

263 ià((
ch
 =ğ'\002' || ()ch =ğ0202è&& 
špd©a
->
šp
.
pos
 > 0)

265 
	`LGÙoPos
(
æay”
, --
x
, 
INPUTLINE
);

266 
špd©a
->
šp
.
pos
--;

268 ià(
ch
 == '\005' || ()ch == 0205)

270 
	`LGÙoPos
(
æay”
, 
x
 +ğ
špd©a
->
šp
.
Ën
 - iÅd©a->šp.
pos
, 
INPUTLINE
);

271 
špd©a
->
šp
.
pos
 = iÅd©a->šp.
Ën
;

273 ià((
ch
 =ğ'\006' || ()ch =ğ0206è&& 
špd©a
->
šp
.
pos
 < iÅd©a->šp.
Ën
)

275 
	`LGÙoPos
(
æay”
, ++
x
, 
INPUTLINE
);

276 
špd©a
->
šp
.
pos
++;

278 ià(
ch
 == '\020' || ()ch == 0220)

280 
mch¬
 
mc
;

281 
mc
 = 
mch¬_so
;

282 ià(
špd©a
->
šp
.
Ën
 && !(špd©a->
špmode
 & 
INP_NOECHO
))

283 
	`LCË¬A»a
(
æay”
, 
špd©a
->
šp¡ršgËn
, 
INPUTLINE
, iÅd©a->šp¡ršgËÀ+ iÅd©a->
šp
.
Ën
 - 1, INPUTLINE, 0, 0);

285 
špd©a
->
šp
 = 
šphi¡
;

286 ià(
špd©a
->
šp
.
Ën
 > iÅd©a->
špmaxËn
)

287 
špd©a
->
šp
.
Ën
 = iÅd©a->
špmaxËn
;

288 ià(
špd©a
->
šp
.
pos
 > iÅd©a->šp.
Ën
)

289 
špd©a
->
šp
.
pos
 = iÅd©a->šp.
Ën
;

291 
x
 = 
špd©a
->
šp¡ršgËn
;

292 
p
 = 
špd©a
->
šp
.
buf
;

294 ià(!(
špd©a
->
špmode
 & 
INP_NOECHO
))

296 
p
 < 
špd©a
->
šp
.
buf
+špd©a->šp.
Ën
)

298 
mc
.
image
 = *
p
++;

299 
	`LPutCh¬
(
æay”
, &
mc
, 
x
++, 
INPUTLINE
);

302 
x
 = 
špd©a
->
šp¡ršgËn
 + iÅd©a->
šp
.
pos
;

303 
	`LGÙoPos
(
æay”
, 
x
, 
INPUTLINE
);

306 ià(
ch
 == '\004' || ch == '\003' || ch == '\007' || ch == '\033' ||

307 
ch
 == '\000' || ch == '\n' || ch == '\r')

309 ià(
ch
 != '\004' && ch != '\n' && ch != '\r')

310 
špd©a
->
šp
.
Ën
 = 0;

311 
špd©a
->
šp
.
buf
[špd©a->šp.
Ën
] = 0;

313 ià(
špd©a
->
šp
.
Ën
 && iÅd©a->
špmode
 == 0)

314 
šphi¡
 = 
špd©a
->
šp
;

316 
æay”
->
l_d©a
 = 0;

317 
	`IÅAbÜt
();

318 *
µbuf
 = 
pbuf
;

319 *
¶’
 = 
Ën
;

320 
di¥Ïy
 = 
špdi¥Ïy
;

321 ià((
špd©a
->
špmode
 & 
INP_RAW
) == 0)

322 (*
špd©a
->
špfšfunc
)(špd©a->
šp
.
buf
, iÅd©a->šp.
Ën
, iÅd©a->
´iv
);

324 (*
špd©a
->
špfšfunc
)(
pbuf
 - 1, 0, iÅd©a->
´iv
);

325 
	`ä“
((*)
špd©a
);

329 ià(!(
špd©a
->
špmode
 & 
INP_RAW
))

331 
æay”
->
l_x
 = 
špd©a
->
šp¡ršgËn
 + (špd©a->
špmode
 & 
INP_NOECHO
 ? 0 : iÅd©a->
šp
.
pos
);

332 
æay”
->
l_y
 = 
INPUTLINE
;

334 *
µbuf
 = 
pbuf
;

335 *
¶’
 = 
Ën
;

336 
	}
}

339 
	$IÅAbÜt
()

341 
	`LAY_CALL_UP
(
	`LayRedi¥ÏyLše
(
INPUTLINE
, 0, 
æay”
->
l_width
 - 1, 0));

342 
	`Ex™Ov”ÏyPage
();

343 
	}
}

346 
	$IÅRedi¥ÏyLše
(
y
, 
xs
, 
xe
, 
isbÏnk
)

347 
y
, 
xs
, 
xe
, 
isbÏnk
;

349 
q
, 
r
, 
s
, 
l
, 
v
;

350 
špd©a
 *inpdata;

352 
špd©a
 = (špd©¨*)
æay”
->
l_d©a
;

353 ià(
y
 !ğ
INPUTLINE
)

355 
	`LAY_CALL_UP
(
	`LayRedi¥ÏyLše
(
y
, 
xs
, 
xe
, 
isbÏnk
));

358 
špd©a
->
šp
.
buf
[špd©a->šp.
Ën
] = 0;

359 
q
 = 
xs
;

360 
v
 = 
xe
 - 
xs
 + 1;

361 
s
 = 0;

362 
r
 = 
špd©a
->
šp¡ršgËn
;

363 ià(
v
 > 0 && 
q
 < 
r
)

365 
l
 = 
v
;

366 ià(
l
 > 
r
 - 
q
)

367 
l
 = 
r
 - 
q
;

368 
	`LPutSŒ
(
æay”
, 
špd©a
->
šp¡ršg
 + 
q
 - 
s
, 
l
, &
mch¬_so
, q, 
y
);

369 
q
 +ğ
l
;

370 
v
 -ğ
l
;

372 
s
 = 
r
;

373 
r
 +ğ
špd©a
->
šp
.
Ën
;

374 ià(!(
špd©a
->
špmode
 & 
INP_NOECHO
è&& 
v
 > 0 && 
q
 < 
r
)

376 
l
 = 
v
;

377 ià(
l
 > 
r
 - 
q
)

378 
l
 = 
r
 - 
q
;

379 
	`LPutSŒ
(
æay”
, 
špd©a
->
šp
.
buf
 + 
q
 - 
s
, 
l
, &
mch¬_so
, q, 
y
);

380 
q
 +ğ
l
;

381 
v
 -ğ
l
;

383 
s
 = 
r
;

384 
r
 = 
æay”
->
l_width
;

385 ià(!
isbÏnk
 && 
v
 > 0 && 
q
 < 
r
)

387 
l
 = 
v
;

388 ià(
l
 > 
r
 - 
q
)

389 
l
 = 
r
 - 
q
;

390 
	`LCË¬A»a
(
æay”
, 
q
, 
y
, q + 
l
 - 1, y, 0, 0);

391 
q
 +ğ
l
;

393 
	}
}

396 
	$InIÅut
()

398 ià(
æay”
 && fÏy”->
l_Ïyâ
 =ğ&
IÅLf
)

401 
	}
}

	@layer.c

24 
	~<sys/ty³s.h
>

26 
	~"cÚfig.h
"

27 
	~"sü“n.h
"

28 
	~"m¬k.h
"

29 
	~"ex‹º.h
"

30 
	~"b¿Ë.h
"

32 
di¥Ïy
 *di¥Ïy, *
di¥Ïys
;

34 
mlše
 
mlše_bÏnk
, 
mlše_nuÎ
;

35 
mch¬
 
mch¬_bÏnk
, 
mch¬_nuÎ
;

37 
Ïy”
 *
æay”
;

38 
LayFuncs
 
WšLf
;

39 
LayFuncs
 
BÏnkLf
;

42 
mlše
 *
mloff
 
__P
((mline *, ));

53 
mlše
 *

54 
	$mloff
(
ml
, 
off
)

55 
mlše
 *
ml
;

56 
off
;

58 
mlše
 
mml
;

60 ià(
ml
 == 0)

62 
mml
.
image
 = 
ml
->imag+ 
off
;

63 
mml
.
©Œ
 = 
ml
->©Œ + 
off
;

64 #ifdeà
FONT


65 
mml
.
fÚt
 = 
ml
->fÚˆ+ 
off
;

67 #ifdeà
COLOR


68 
mml
.
cŞÜ
 = 
ml
->cŞÜ + 
off
;

69 #ifdeà
COLORS256


70 
mml
.
cŞÜx
 = 
ml
->cŞÜx + 
off
;

73  &
mml
;

74 
	}
}

76 #ifdeà
UTF8


77 
	#RECODE_MCHAR
(
mc
è((
l
->
l_’codšg
 =ğ
UTF8
è!ğ(
D_’codšg
 =ğUTF8è? 
	`»code_mch¬
(mc,†->l_’codšg, D_’codšgè: (mc))

	)

78 
	#RECODE_MLINE
(
ml
è((
l
->
l_’codšg
 =ğ
UTF8
è!ğ(
D_’codšg
 =ğUTF8è? 
	`»code_mlše
(ml,†->
l_width
,†->l_’codšg, D_’codšgè: (ml))

	)

80 
	#RECODE_MCHAR
(
mc
è(mc)

	)

81 
	#RECODE_MLINE
(
ml
è(ml)

	)

86 
	$LGÙoPos
(
l
, 
x
, 
y
)

87 
Ïy”
 *
l
;

88 
x
, 
y
;

90 
ÿnvas
 *
cv
;

91 
v›wpÜt
 *
vp
;

92 
x2
, 
y2
;

94 #ifdeà
HAVE_BRAILLE


95 ià(
bd
.
bd_»äeshšg
)

98 
cv
 = 
l
->
l_cvli¡
; cv; cv = cv->
c_Êext
)

100 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

101 ià(
D_blocked
)

103 ià(
cv
 !ğ
D_fÜecv
)

105 
x2
 = 
x
 + 
cv
->
c_xoff
;

106 
y2
 = 
y
 + 
cv
->
c_yoff
;

107 
	`debug2
("---LGÙoPo %d %d\n", 
x2
, 
y2
);

108 ià(
x2
 < 
cv
->
c_xs
)

109 
x2
 = 
cv
->
c_xs
;

110 ià(
y2
 < 
cv
->
c_ys
)

111 
y2
 = 
cv
->
c_ys
;

112 ià(
x2
 > 
cv
->
c_xe
)

113 
x2
 = 
cv
->
c_xe
;

114 ià(
y2
 > 
cv
->
c_ye
)

115 
y2
 = 
cv
->
c_ye
;

116 
vp
 = 
cv
->
c_v¶i¡
; vp; v°ğvp->
v_Ãxt
)

118 ià(
x2
 < 
vp
->
v_xs
 || x2 > vp->
v_xe
)

120 ià(
y2
 < 
vp
->
v_ys
 || y2 > vp->
v_ye
)

122 
	`GÙoPos
(
x2
, 
y2
);

126 
	}
}

129 
	$LSüŞlH
(
l
, 
n
, 
y
, 
xs
, 
xe
, 
bû
, 
Ş
)

130 
Ïy”
 *
l
;

131 
n
, 
y
, 
xs
, 
xe
;

132 
bû
;

133 
mlše
 *
Ş
;

135 
ÿnvas
 *
cv
;

136 
v›wpÜt
 *
vp
;

137 
y2
, 
xs2
, 
xe2
;

139 ià(
n
 == 0)

141 
cv
 = 
l
->
l_cvli¡
; cv; cv = cv->
c_Êext
)

142 
vp
 = 
cv
->
c_v¶i¡
; vp; v°ğvp->
v_Ãxt
)

144 
y2
 = 
y
 + 
vp
->
v_yoff
;

145 ià(
y2
 < 
vp
->
v_ys
 || y2 > vp->
v_ye
)

147 
xs2
 = 
xs
 + 
vp
->
v_xoff
;

148 
xe2
 = 
xe
 + 
vp
->
v_xoff
;

149 ià(
xs2
 < 
vp
->
v_xs
)

150 
xs2
 = 
vp
->
v_xs
;

151 ià(
xe2
 > 
vp
->
v_xe
)

152 
xe2
 = 
vp
->
v_xe
;

153 ià(
xs2
 > 
xe2
)

155 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

156 ià(
D_blocked
)

158 
	`SüŞlH
(
y2
, 
xs2
, 
xe2
, 
n
, 
bû
, 
Ş
 ? 
	`mloff
(Ş, -
vp
->
v_xoff
) : 0);

159 ià(
xe2
 - 
xs2
 =ğ
xe
 - 
xs
)

161 ià(
n
 > 0)

163 
xs2
 = 
xe2
 + 1 - 
n
;

164 
xe2
 = 
xe
 + 
vp
->
v_xoff
 - 
n
;

168 
xe2
 = 
xs2
 - 1 - 
n
;

169 
xs2
 = 
xs
 + 
vp
->
v_xoff
 - 
n
;

171 ià(
xs2
 < 
vp
->
v_xs
)

172 
xs2
 = 
vp
->
v_xs
;

173 ià(
xe2
 > 
vp
->
v_xe
)

174 
xe2
 = 
vp
->
v_xe
;

175 ià(
xs2
 <ğ
xe2
)

176 
	`ReäeshA»a
(
xs2
, 
y2
, 
xe2
, y2, 1);

178 
	}
}

181 
	$LSüŞlV
(
l
, 
n
, 
ys
, 
ye
, 
bû
)

182 
Ïy”
 *
l
;

183 
n
;

184 
ys
, 
ye
;

185 
bû
;

187 
ÿnvas
 *
cv
;

188 
v›wpÜt
 *
vp
;

189 
ys2
, 
ye2
, 
xs2
, 
xe2
;

190 ià(
n
 == 0)

192 
cv
 = 
l
->
l_cvli¡
; cv; cv = cv->
c_Êext
)

193 
vp
 = 
cv
->
c_v¶i¡
; vp; v°ğvp->
v_Ãxt
)

195 
xs2
 = 
vp
->
v_xoff
;

196 
xe2
 = 
l
->
l_width
 - 1 + 
vp
->
v_xoff
;

197 
ys2
 = 
ys
 + 
vp
->
v_yoff
;

198 
ye2
 = 
ye
 + 
vp
->
v_yoff
;

199 ià(
xs2
 < 
vp
->
v_xs
)

200 
xs2
 = 
vp
->
v_xs
;

201 ià(
xe2
 > 
vp
->
v_xe
)

202 
xe2
 = 
vp
->
v_xe
;

203 ià(
ys2
 < 
vp
->
v_ys
)

204 
ys2
 = 
vp
->
v_ys
;

205 ià(
ye2
 > 
vp
->
v_ye
)

206 
ye2
 = 
vp
->
v_ye
;

207 ià(
ys2
 > 
ye2
 || 
xs2
 > 
xe2
)

209 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

210 ià(
D_blocked
)

213 
	`SüŞlV
(
xs2
, 
ys2
, 
xe2
, 
ye2
, 
n
, 
bû
);

215 
	`SüŞlV
(
vp
->
v_xs
, 
ys2
, vp->
v_xe
, 
ye2
, 
n
, 
bû
);

217 
	`debug2
("LSüŞlV: %d %d", 
ys
, 
ye
);

218 
	`debug2
(" -> %d %d\n", 
ys2
, 
ye2
);

219 ià(
ye2
 - 
ys2
 =ğ
ye
 - 
ys
)

221 ià(
n
 > 0)

223 
ys2
 = 
ye2
 + 1 - 
n
;

224 
ye2
 = 
ye
 + 
vp
->
v_yoff
 - 
n
;

228 
ye2
 = 
ys2
 - 1 - 
n
;

229 
ys2
 = 
ys
 + 
vp
->
v_yoff
 - 
n
;

231 
	`debug2
("LSüŞlV: - %d %d\n", 
ys2
, 
ye2
);

232 ià(
ys2
 < 
vp
->
v_ys
)

233 
ys2
 = 
vp
->
v_ys
;

234 ià(
ye2
 > 
vp
->
v_ye
)

235 
ye2
 = 
vp
->
v_ye
;

236 
	`debug2
("LSüŞlV: - %d %d\n", 
ys2
, 
ye2
);

237 ià(
ys2
 <ğ
ye2
)

238 
	`ReäeshA»a
(
xs2
, 
ys2
, 
xe2
, 
ye2
, 1);

240 
	}
}

243 
	$LInsCh¬
(
l
, 
c
, 
x
, 
y
, 
Ş
)

244 
Ïy”
 *
l
;

245 
mch¬
 *
c
;

246 
x
, 
y
;

247 
mlše
 *
Ş
;

249 
ÿnvas
 *
cv
;

250 
v›wpÜt
 *
vp
;

251 
xs2
, 
xe2
, 
y2
, 
f
;

252 
mch¬
 *
c2
, 
cc
;

253 
mlše
 *
rŞ
;

255 
cv
 = 
l
->
l_cvli¡
; cv; cv = cv->
c_Êext
)

256 
vp
 = 
cv
->
c_v¶i¡
; vp; v°ğvp->
v_Ãxt
)

258 
y2
 = 
y
 + 
vp
->
v_yoff
;

259 ià(
y2
 < 
vp
->
v_ys
 || y2 > vp->
v_ye
)

261 
xs2
 = 
x
 + 
vp
->
v_xoff
;

262 
xe2
 = 
l
->
l_width
 - 1 + 
vp
->
v_xoff
;

263 
c2
 = 
c
;

264 
f
 = 0;

265 ià(
xs2
 < 
vp
->
v_xs
)

267 
xs2
 = 
vp
->
v_xs
;

268 
c2
 = &
mch¬_bÏnk
;

269 ià(
Ş
)

271 
i
;

272 
i
 = 
xs2
 - 
vp
->
v_xoff
 - 1;

273 ià(
i
 >ğ0 && i < 
l
->
l_width
)

275 
	`cİy_mlše2mch¬
(&
cc
, 
Ş
, 
i
);

276 
c2
 = &
cc
;

280 
f
 = 1;

282 ià(
xe2
 > 
vp
->
v_xe
)

283 
xe2
 = 
vp
->
v_xe
;

284 ià(
xs2
 > 
xe2
)

286 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

287 ià(
D_blocked
)

289 
rŞ
 = 
	`RECODE_MLINE
(
Ş
);

290 
	`InsCh¬
(
	`RECODE_MCHAR
(
c2
), 
xs2
, 
xe2
, 
y2
, 
	`mloff
(
rŞ
, -
vp
->
v_xoff
));

291 ià(
f
)

292 
	`ReäeshA»a
(
xs2
, 
y2
, xs2, y2, 1);

294 
	}
}

297 
	$LPutCh¬
(
l
, 
c
, 
x
, 
y
)

298 
Ïy”
 *
l
;

299 
mch¬
 *
c
;

300 
x
, 
y
;

302 
ÿnvas
 *
cv
;

303 
v›wpÜt
 *
vp
;

304 
x2
, 
y2
;

305 #ifdeà
HAVE_BRAILLE


306 ià(
bd
.
bd_»äeshšg
)

308 
	`BPutCh¬
(
l
, 
c
, 
x
, 
y
);

312 
cv
 = 
l
->
l_cvli¡
; cv; cv = cv->
c_Êext
)

314 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

315 ià(
D_blocked
)

317 
vp
 = 
cv
->
c_v¶i¡
; vp; v°ğvp->
v_Ãxt
)

319 
y2
 = 
y
 + 
vp
->
v_yoff
;

320 ià(
y2
 < 
vp
->
v_ys
 || y2 > vp->
v_ye
)

322 
x2
 = 
x
 + 
vp
->
v_xoff
;

323 ià(
x2
 < 
vp
->
v_xs
 || x2 > vp->
v_xe
)

325 
	`PutCh¬
(
	`RECODE_MCHAR
(
c
), 
x2
, 
y2
);

329 
	}
}

332 
	$LPutSŒ
(
l
, 
s
, 
n
, 
r
, 
x
, 
y
)

333 
Ïy”
 *
l
;

334 *
s
;

335 
n
;

336 
mch¬
 *
r
;

337 
x
, 
y
;

339 
ÿnvas
 *
cv
;

340 
v›wpÜt
 *
vp
;

341 *
s2
;

342 
xs2
, 
xe2
, 
y2
;

344 ià(
x
 + 
n
 > 
l
->
l_width
)

345 
n
 = 
l
->
l_width
 - 
x
;

346 #ifdeà
HAVE_BRAILLE


347 ià(
bd
.
bd_»äeshšg
)

349 
	`BPutSŒ
(
l
, 
s
, 
n
, 
r
, 
x
, 
y
);

353 
cv
 = 
l
->
l_cvli¡
; cv; cv = cv->
c_Êext
)

354 
vp
 = 
cv
->
c_v¶i¡
; vp; v°ğvp->
v_Ãxt
)

356 
y2
 = 
y
 + 
vp
->
v_yoff
;

357 ià(
y2
 < 
vp
->
v_ys
 || y2 > vp->
v_ye
)

359 
xs2
 = 
x
 + 
vp
->
v_xoff
;

360 
xe2
 = 
xs2
 + 
n
 - 1;

361 ià(
xs2
 < 
vp
->
v_xs
)

362 
xs2
 = 
vp
->
v_xs
;

363 ià(
xe2
 > 
vp
->
v_xe
)

364 
xe2
 = 
vp
->
v_xe
;

365 ià(
xs2
 > 
xe2
)

367 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

368 ià(
D_blocked
)

370 
	`GÙoPos
(
xs2
, 
y2
);

371 
	`S‘R’d™iÚ
(
r
);

372 
s2
 = 
s
 + 
xs2
 - 
x
 - 
vp
->
v_xoff
;

373 #ifdeà
UTF8


374 ià(
D_’codšg
 =ğ
UTF8
 && 
l
->
l_’codšg
 !ğUTF8 && (
r
->
fÚt
 ||†->l_encoding))

376 
mch¬
 
mc
;

377 
mc
 = *
r
;

378 
xs2
 <ğ
xe2
)

380 
mc
.
image
 = *
s2
++;

381 
	`PutCh¬
(
	`RECODE_MCHAR
(&
mc
), 
xs2
++, 
y2
);

386 
xs2
++ <ğ
xe2
)

387 
	`PUTCHARLP
(*
s2
++);

389 
	}
}

392 
	$LPutWšMsg
(
l
, 
s
, 
n
, 
r
, 
x
, 
y
)

393 
Ïy”
 *
l
;

394 *
s
;

395 
n
;

396 
mch¬
 *
r
;

397 
x
, 
y
;

399 
ÿnvas
 *
cv
;

400 
v›wpÜt
 *
vp
;

401 *
s2
;

402 
xs2
, 
xe2
, 
y2
, 
Ën
, 
Ën2
;

403 
mch¬
 
Ü
;

405 ià(
x
 + 
n
 > 
l
->
l_width
)

406 
n
 = 
l
->
l_width
 - 
x
;

407 #ifdeà
HAVE_BRAILLE


408 ià(
bd
.
bd_»äeshšg
)

410 
	`BPutSŒ
(
l
, 
s
, 
n
, 
r
, 
x
, 
y
);

414 
Ën
 = 
	`¡¾’
(
s
);

415 ià(
Ën
 > 
n
)

416 
Ën
 = 
n
;

417 
cv
 = 
l
->
l_cvli¡
; cv; cv = cv->
c_Êext
)

418 
vp
 = 
cv
->
c_v¶i¡
; vp; v°ğvp->
v_Ãxt
)

420 
y2
 = 
y
 + 
vp
->
v_yoff
;

421 ià(
y2
 < 
vp
->
v_ys
 || y2 > vp->
v_ye
)

423 
xs2
 = 
x
 + 
vp
->
v_xoff
;

424 
xe2
 = 
xs2
 + 
n
 - 1;

425 ià(
xs2
 < 
vp
->
v_xs
)

426 
xs2
 = 
vp
->
v_xs
;

427 ià(
xe2
 > 
vp
->
v_xe
)

428 
xe2
 = 
vp
->
v_xe
;

429 ià(
xs2
 > 
xe2
)

431 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

432 ià(
D_blocked
)

434 
	`GÙoPos
(
xs2
, 
y2
);

435 
	`S‘R’d™iÚ
(
r
);

436 
Ën2
 = 
xe2
 - (
x
 + 
vp
->
v_xoff
) + 1;

437 ià(
Ën2
 > 
Ën
)

438 
Ën2
 = 
Ën
;

439 ià(!
	`PutWšMsg
(
s
, 
xs2
 - 
x
 - 
vp
->
v_xoff
, 
Ën2
))

441 
s2
 = 
s
 + 
xs2
 - 
x
 - 
vp
->
v_xoff
;

442 
Ën2
-- > 0)

444 
	`PUTCHARLP
(*
s2
++);

445 
xs2
++;

449 
xs2
 = 
x
 + 
vp
->
v_xoff
 + 
Ën2
;

450 ià(
xs2
 < 
vp
->
v_xs
)

451 
xs2
 = 
vp
->
v_xs
;

452 
Ü
 = 
D_»nd
;

453 
	`GÙoPos
(
xs2
, 
y2
);

454 
	`S‘R’d™iÚ
(&
Ü
);

455 
xs2
++ <ğ
xe2
)

456 
	`PUTCHARLP
(' ');

458 
	}
}

461 
	$LCË¬Lše
(
l
, 
y
, 
xs
, 
xe
, 
bû
, 
Ş
)

462 
Ïy”
 *
l
;

463 
xs
, 
xe
, 
bû
;

464 
mlše
 *
Ş
;

466 
ÿnvas
 *
cv
;

467 
v›wpÜt
 *
vp
;

468 
y2
, 
xs2
, 
xe2
;

471 ià(
xs
 >ğ
l
->
l_width
)

472 
xs
 = 
l
->
l_width
 - 1;

473 ià(
xe
 >ğ
l
->
l_width
)

474 
xe
 = 
l
->
l_width
 - 1;

475 
cv
 = 
l
->
l_cvli¡
; cv; cv = cv->
c_Êext
)

476 
vp
 = 
cv
->
c_v¶i¡
; vp; v°ğvp->
v_Ãxt
)

478 
xs2
 = 
xs
 + 
vp
->
v_xoff
;

479 
xe2
 = 
xe
 + 
vp
->
v_xoff
;

480 
y2
 = 
y
 + 
vp
->
v_yoff
;

481 ià(
y2
 < 
vp
->
v_ys
 || y2 > vp->
v_ye
)

483 ià(
xs2
 < 
vp
->
v_xs
)

484 
xs2
 = 
vp
->
v_xs
;

485 ià(
xe2
 > 
vp
->
v_xe
)

486 
xe2
 = 
vp
->
v_xe
;

487 ià(
xs2
 > 
xe2
)

489 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

490 ià(
D_blocked
)

492 
	`CË¬Lše
(
Ş
 ? 
	`mloff
(
	`RECODE_MLINE
(Ş), -
vp
->
v_xoff
è: (
mlše
 *)0, 
y2
, 
xs2
, 
xe2
, 
bû
);

494 
	}
}

497 
	$LCË¬A»a
(
l
, 
xs
, 
ys
, 
xe
, 
ye
, 
bû
, 
u£lf
)

498 
Ïy”
 *
l
;

499 
xs
, 
ys
, 
xe
, 
ye
;

500 
bû
;

501 
u£lf
;

503 
ÿnvas
 *
cv
;

504 
v›wpÜt
 *
vp
;

505 
xs2
, 
ys2
, 
xe2
, 
ye2
;

506 #ifdeà
HAVE_BRAILLE


507 ià(
bd
.
bd_»äeshšg
)

511 ià(
xs
 >ğ
l
->
l_width
)

512 
xs
 = 
l
->
l_width
 - 1;

513 ià(
xe
 >ğ
l
->
l_width
)

514 
xe
 = 
l
->
l_width
 - 1;

515 
cv
 = 
l
->
l_cvli¡
; cv; cv = cv->
c_Êext
)

517 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

518 ià(
D_blocked
)

520 
vp
 = 
cv
->
c_v¶i¡
; vp; v°ğvp->
v_Ãxt
)

522 
xs2
 = 
xs
 + 
vp
->
v_xoff
;

523 
xe2
 = 
xe
 + 
vp
->
v_xoff
;

524 
ys2
 = 
ys
 + 
vp
->
v_yoff
;

525 
ye2
 = 
ye
 + 
vp
->
v_yoff
;

526 ià(
xs2
 < 
vp
->
v_xs
)

527 
xs2
 = 
vp
->
v_xs
;

528 ià(
xe2
 > 
vp
->
v_xe
)

529 
xe2
 = 
vp
->
v_xe
;

530 ià(
xs2
 > 
vp
->
v_xe
)

531 
ys2
++;

532 ià(
xe2
 < 
vp
->
v_xs
)

533 
ye2
--;

534 ià(
ys2
 < 
vp
->
v_ys
)

535 
ys2
 = 
vp
->
v_ys
;

536 ià(
ye2
 > 
vp
->
v_ye
)

537 
ye2
 = 
vp
->
v_ye
;

538 ià(
ys2
 > 
ye2
)

541 
xcs
 = 
vp
->
v_xoff
;

542 
xû
 = 
l
->
l_width
 - 1 + 
vp
->
v_xoff
;

543 ià(
xcs
 < 
vp
->
v_xs
)

544 
xcs
 = 
vp
->
v_xs
;

545 ià(
xû
 > 
vp
->
v_xe
)

546 
xû
 = 
vp
->
v_xe
;

547 ià(
xcs
 > 
xû
)

549 ià(
ys2
 !ğ
ys
 + 
vp
->
v_yoff
)

550 
xs2
 = 
xcs
;

551 ià(
ye2
 !ğ
ye
 + 
vp
->
v_yoff
)

552 
xe2
 = 
xû
;

553 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

554 
	`CË¬A»a
(
xs2
, 
ys2
, 
xcs
, 
xû
, 
xe2
, 
ye2
, 
bû
, 
u£lf
);

556 ià(
xs
 =ğ0 || 
ys2
 !ğ
ys
 + 
vp
->
v_yoff
)

557 
xs2
 = 
vp
->
v_xs
;

558 ià(
xe
 =ğ
l
->
l_width
 - 1 || 
ye2
 !ğ
ye
 + 
vp
->
v_yoff
)

559 
xe2
 = 
vp
->
v_xe
;

560 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

561 
	`CË¬A»a
(
xs2
, 
ys2
, 
vp
->
v_xs
, vp->
v_xe
, 
xe2
, 
ye2
, 
bû
, 
u£lf
);

565 
	}
}

568 
	$LCDi¥ÏyLše
(
l
, 
ml
, 
y
, 
xs
, 
xe
, 
isbÏnk
)

569 
Ïy”
 *
l
;

570 
mlše
 *
ml
;

571 
y
, 
xs
, 
xe
;

572 
isbÏnk
;

574 
ÿnvas
 *
cv
;

575 
v›wpÜt
 *
vp
;

576 
xs2
, 
xe2
, 
y2
;

577 #ifdeà
HAVE_BRAILLE


578 ià(
bd
.
bd_»äeshšg
)

580 
	`BCDi¥ÏyLše
(
l
, 
ml
, 
y
, 
xs
, 
xe
, 
isbÏnk
);

584 
cv
 = 
l
->
l_cvli¡
; cv; cv = cv->
c_Êext
)

586 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

587 ià(
D_blocked
)

589 
vp
 = 
cv
->
c_v¶i¡
; vp; v°ğvp->
v_Ãxt
)

591 
xs2
 = 
xs
 + 
vp
->
v_xoff
;

592 
xe2
 = 
xe
 + 
vp
->
v_xoff
;

593 
y2
 = 
y
 + 
vp
->
v_yoff
;

594 ià(
y2
 < 
vp
->
v_ys
 || y2 > vp->
v_ye
)

596 ià(
xs2
 < 
vp
->
v_xs
)

597 
xs2
 = 
vp
->
v_xs
;

598 ià(
xe2
 > 
vp
->
v_xe
)

599 
xe2
 = 
vp
->
v_xe
;

600 ià(
xs2
 > 
xe2
)

602 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

603 
	`debug3
("LCDi¥ÏyLše: Di¥ÏyLš%d, %d-%d", 
y2
, 
xs2
, 
xe2
);

604 
	`debug1
(" mlofàğ%d\n", -
vp
->
v_xoff
);

605 
	`Di¥ÏyLše
(
isbÏnk
 ? &
mlše_bÏnk
 : &
mlše_nuÎ
, 
	`mloff
(
	`RECODE_MLINE
(
ml
), -
vp
->
v_xoff
), 
y2
, 
xs2
, 
xe2
);

608 
	}
}

611 
	$LCDi¥ÏyLšeW¿p
(
l
, 
ml
, 
y
, 
äom
, 
to
, 
isbÏnk
)

612 
Ïy”
 *
l
;

613 
mlše
 *
ml
;

614 
y
, 
äom
, 
to
;

615 
isbÏnk
;

617 
mch¬
 
nc
;

618 
	`cİy_mlše2mch¬
(&
nc
, 
ml
, 0);

619 #ifdeà
DW_CHARS


620 ià(
	`dw_Ëá
(
ml
, 0, 
l
->
l_’codšg
))

622 
nc
.
mbcs
 = 
ml
->
image
[1];

623 
äom
++;

626 
	`LW¿pCh¬
(
l
, &
nc
, 
y
 - 1, -1, -1, 0);

627 
äom
++;

628 ià(
äom
 <ğ
to
)

629 
	`LCDi¥ÏyLše
(
l
, 
ml
, 
y
, 
äom
, 
to
, 
isbÏnk
);

630 
	}
}

633 
	$LS‘R’d™iÚ
(
l
, 
r
)

634 
Ïy”
 *
l
;

635 
mch¬
 *
r
;

637 
ÿnvas
 *
cv
;

639 
cv
 = 
l
->
l_cvli¡
; cv; cv = cv->
c_Êext
)

641 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

642 ià(
D_blocked
)

644 
	`S‘R’d™iÚ
(
r
);

646 
	}
}

649 
	$LW¿pCh¬
(
l
, 
c
, 
y
, 
tİ
, 
bÙ
, 
šs
)

650 
Ïy”
 *
l
;

651 
mch¬
 *
c
;

652 
y
, 
tİ
, 
bÙ
;

653 
šs
;

655 
ÿnvas
 *
cv
, *
cvli¡
, *
cvÊext
;

656 
v›wpÜt
 *
vp
, *
evp
, **
vµ
;

657 
yy
, 
y2
, 
yy2
, 
tİ2
, 
bÙ2
;

658 
bû
;

660 #ifdeà
COLOR


661 
bû
 = 
	`»nd_g‘bg
(
c
);

663 
bû
 = 0;

665 ià(
y
 !ğ
bÙ
)

670 
yy
 = 
y
 =ğ
l
->
l_height
 - 1 ? y : y + 1;

672 
cv
 = 
l
->
l_cvli¡
; cv; cv = cv->
c_Êext
)

674 
y2
 = 0;

675 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

676 ià(
D_blocked
)

679 
vp
 = 
cv
->
c_v¶i¡
; vp; v°ğvp->
v_Ãxt
)

681 
y2
 = 
y
 + 
vp
->
v_yoff
;

682 
yy2
 = 
yy
 + 
vp
->
v_yoff
;

683 ià(
yy2
 >ğ
vp
->
v_ys
 && yy2 <ğvp->
v_ye
 && vp->
v_xoff
 >ğvp->
v_xs
 && vp->v_xofà<ğvp->
v_xe
)

686 ià(
vp
 == 0)

689 
evp
 = 
cv
->
c_v¶i¡
;ƒvp;ƒv°ğevp->
v_Ãxt
)

690 ià(
y2
 >ğ
evp
->
v_ys
 && y2 <ğevp->
v_ye
 &&ƒvp->
v_xoff
 + 
l
->
l_width
 - 1 >ğevp->
v_xs
 &&ƒvp->v_xofà+†->l_width - 1 <ğevp->
v_xe
)

692 ià(
evp
 =ğ0 || (
šs
 && 
vp
->
v_xoff
 + 
l
->
l_width
 - 1 > vp->
v_ye
))

695 
	`debug
("LWrap: can't wrap!\n");

696 
cvli¡
 = 
l
->
l_cvli¡
;

697 
cvÊext
 = 
cv
->
c_Êext
;

698 
l
->
l_cvli¡
 = 
cv
;

699 
cv
->
c_Êext
 = 0;

700 ià(
šs
)

701 
	`LInsCh¬
(
l
, 
c
, 0, 
yy
, 0);

703 
	`LPutCh¬
(
l
, 
c
, 0, 
yy
);

704 
l
->
l_cvli¡
 = 
cvli¡
;

705 
cv
->
c_Êext
 = 
cvÊext
;

709 
	`W¿pCh¬
(
	`RECODE_MCHAR
(
c
), 
vp
->
v_xoff
 + 
l
->
l_width
, 
y2
, vp->v_xoff, -1, vp->v_xofà+†->l_width - 1, -1, 
šs
);

717 
cv
 = 
l
->
l_cvli¡
; cv; cv = cv->
c_Êext
)

719 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

720 ià(
D_blocked
)

723 
vµ
 = &
cv
->
c_v¶i¡
; (
vp
 = *vµ); vµ = &vp->
v_Ãxt
)

725 
yy2
 = 
bÙ
 + 
vp
->
v_yoff
;

726 ià(
yy2
 >ğ
vp
->
v_ys
 && yy2 <ğvp->
v_ye
 && vp->
v_xoff
 >ğvp->
v_xs
 && vp->v_xofà+ 
l
->
l_width
 - 1 <ğvp->
v_xe
)

730 ià(
vp
)

734 *
vµ
 = 
vp
->
v_Ãxt
;

736 ià(
cv
->
c_v¶i¡
)

739 
cvli¡
 = 
l
->
l_cvli¡
;

740 
cvÊext
 = 
cv
->
c_Êext
;

741 
l
->
l_cvli¡
 = 
cv
;

742 
cv
->
c_Êext
 = 0;

743 
	`LSüŞlV
(
l
, 1, 
tİ
, 
bÙ
, 
bû
);

744 ià(!
vp
)

746 ià(
šs
)

747 
	`LInsCh¬
(
l
, 
c
, 0, 
bÙ
, 0);

749 
	`LPutCh¬
(
l
, 
c
, 0, 
bÙ
);

751 
l
->
l_cvli¡
 = 
cvli¡
;

752 
cv
->
c_Êext
 = 
cvÊext
;

754 ià(
vp
)

757 *
vµ
 = 
vp
;

758 
tİ2
 = 
tİ
 + 
vp
->
v_yoff
;

759 
bÙ2
 = 
bÙ
 + 
vp
->
v_yoff
;

760 ià(
tİ2
 < 
vp
->
v_ys
)

761 
tİ2
 = 
vp
->
v_ys
;

762 
	`W¿pCh¬
(
	`RECODE_MCHAR
(
c
), 
vp
->
v_xoff
 + 
l
->
l_width
, 
bÙ2
, vp->v_xoff, 
tİ2
, vp->v_xofà+†->l_width - 1, bÙ2, 
šs
);

766 
	}
}

770 
	$LCursÜVisib™y
(
l
, 
vis
)

771 
Ïy”
 *
l
;

772 
vis
;

774 
ÿnvas
 *
cv
;

775 
cv
 = 
l
->
l_cvli¡
; cv; cv = cv->
c_Êext
)

777 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

778 ià(
D_blocked
)

780 ià(
cv
 !ğ
D_fÜecv
)

782 
	`CursÜVisib™y
(
vis
);

784 
	}
}

787 
	$LS‘Flow
(
l
, 
æow
)

788 
Ïy”
 *
l
;

789 
æow
;

791 
ÿnvas
 *
cv
;

792 
cv
 = 
l
->
l_cvli¡
; cv; cv = cv->
c_Êext
)

794 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

795 ià(
cv
 !ğ
D_fÜecv
)

797 
	`S‘Flow
(
æow
);

799 
	}
}

802 
	$LKey·dMode
(
l
, 
Ú
)

803 
Ïy”
 *
l
;

804 
Ú
;

806 
ÿnvas
 *
cv
;

807 
cv
 = 
l
->
l_cvli¡
; cv; cv = cv->
c_Êext
)

809 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

810 ià(
D_blocked
)

812 ià(
cv
 !ğ
D_fÜecv
)

814 
	`Key·dMode
(
Ú
);

816 
	}
}

819 
	$LCursÜkeysMode
(
l
, 
Ú
)

820 
Ïy”
 *
l
;

821 
Ú
;

823 
ÿnvas
 *
cv
;

824 
cv
 = 
l
->
l_cvli¡
; cv; cv = cv->
c_Êext
)

826 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

827 ià(
D_blocked
)

829 ià(
cv
 !ğ
D_fÜecv
)

831 
	`CursÜkeysMode
(
Ú
);

833 
	}
}

836 
	$LMou£Mode
(
l
, 
Ú
)

837 
Ïy”
 *
l
;

838 
Ú
;

840 
ÿnvas
 *
cv
;

841 
cv
 = 
l
->
l_cvli¡
; cv; cv = cv->
c_Êext
)

843 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

844 ià(
D_blocked
)

846 ià(
cv
 !ğ
D_fÜecv
)

848 
	`Mou£Mode
(
Ú
);

850 
	}
}

856 
	$LCË¬AÎ
(
l
, 
u£lf
)

857 
Ïy”
 *
l
;

858 
u£lf
;

860 
	`LCË¬A»a
(
l
, 0, 0,†->
l_width
 - 1,†->
l_height
 - 1, 0, 
u£lf
);

861 
	}
}

864 
	$LReäeshAÎ
(
l
, 
isbÏnk
)

865 
Ïy”
 *
l
;

866 
isbÏnk
;

868 
Ïy”
 *
Şdæay”
;

869 
y
;

871 
	`debug1
("LReäeshAÎ isbÏnk=%d\n", 
isbÏnk
);

872 
Şdæay”
 = 
æay”
;

873 
æay”
 = 
l
;

874 ià(!
isbÏnk
)

875 
	`LCË¬A»a
(
l
, 0, 0,†->
l_width
 - 1,†->
l_height
 - 1, 0, 0);

877 
	`LayRedi¥ÏyLše
(-1, -1, -1, 1);

878 
y
 = 0; y < 
l
->
l_height
; y++)

879 
	`LayRedi¥ÏyLše
(
y
, 0, 
l
->
l_width
 - 1, 1);

880 
æay”
 = 
Şdæay”
;

881 
	}
}

885 
	$KlLay”Chaš
(
Ïy
)

886 
Ïy”
 *
Ïy
;

888 
ÿnvas
 *
cv
, *
ncv
;

889 
Ïy”
 *
l
, *
Şdæay”
;

891 
Şdæay”
 = 
æay”
;

892 
	`debug1
("KlLay”Chaš %#x\n", 
Ïy
);

893 
l
 = 
Ïy
;†;† =†->
l_Ãxt
)

895 ià(
l
->
l_Ïyâ
 =ğ&
WšLf
 ||†->l_Ïyâ =ğ&
BÏnkLf
)

897 
	`debug1
("- klšg %#x\n", 
l
);

898 ià(
Şdæay”
 =ğ
l
)

899 
Şdæay”
 = 0;

900 
cv
 = 
l
->
l_cvli¡
; cv; cv = 
ncv
)

902 
ncv
 = 
cv
->
c_Êext
;

903 
cv
->
c_Ïy”
 = 0;

904 
cv
->
c_Êext
 = 0;

907 
æay”
 = 
Ïy
;

908 
æay”
 !ğ
l
)

909 
	`Ex™Ov”ÏyPage
();

910 
æay”
 = 
Şdæay”
;

911 
	}
}

922 
	$In™Ov”ÏyPage
(
d©asize
, 
lf
, 
block
)

923 
d©asize
;

924 
LayFuncs
 *
lf
;

925 
block
;

927 *
d©a
;

928 
Ïy”
 *
ÃwÏy
;

929 
ÿnvas
 *
cv
, *
cvp
, **
cvµ
;

930 
wš
 *
p
;

932 
	`ASSERT
(
æay”
);

934 
cv
 = 0;

935 ià(
di¥Ïy
 && 
D_fÜecv
->
c_Ïy”
 =ğ
æay”
)

936 
cv
 = 
D_fÜecv
;

938 ià((
ÃwÏy
 = (
Ïy”
 *)
	`ÿÎoc
(1, (layer))) == 0)

940 
	`Msg
(0, "No memory for†ayer struct");

943 
	`debug2
("EÁ”šg‚ew†ay” oÀtİ oà%#x: %#x\n", ()
æay”
, 
ÃwÏy
);

944 
d©a
 = 0;

945 ià(
d©asize
)

947 ià((
d©a
 = 
	`m®loc
(
d©asize
)) == 0)

949 
	`ä“
((*)
ÃwÏy
);

950 
	`Msg
(0, "No memory for†ayer data");

953 
	`bz”o
(
d©a
, 
d©asize
);

956 
p
 = 
	`Lay”2Wšdow
(
æay”
);

958 ià(
p
 && (p->
w_§v–ay”
 =ğ
æay”
 || (
block
 && fÏy”->
l_Ãxt
 == 0)))

960 ià(
p
->
w_§v–ay”
 &&…->w_§v–ay” !ğ
æay”
 &&…->w_§v–ay”->
l_cvli¡
 == 0)

961 
	`KlLay”Chaš
(
p
->
w_§v–ay”
);

962 
p
->
w_§v–ay”
 = 
ÃwÏy
;

965 ià(
cv
 && 
æay”
->
l_Ãxt
 =ğ0 && !
block
)

967 
di¥Ïy
 *
Şddi¥Ïy
 = display;

968 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

969 
	`RemoveStus
();

970 
di¥Ïy
 = 
Şddi¥Ïy
;

973 
cvµ
 = &
æay”
->
l_cvli¡
; (
cvp
 = *cvµ); cvµ = &cvp->
c_Êext
)

974 ià(
cvp
 =ğ
cv
)

976 
	`ASSERT
(
cvp
);

977 *
cvµ
 = 
cv
->
c_Êext
;

978 
ÃwÏy
->
l_cvli¡
 = 
cv
;

979 
cv
->
c_Êext
 = 0;

980 
cv
->
c_Ïy”
 = 
ÃwÏy
;

984 
	`LAY_DISPLAYS
(
æay”
, 
	`RemoveStus
());

985 ià(
block
)

986 
	`debug
("layer is blocking\n");

987 ià(
block
 && 
æay”
->
l_Ïyâ
 =ğ&
WšLf
)

989 
	`debug
("...and is first, so window gets blocked\n");

990 
	`ASSERT
(
p
->
w_blocked
 == 0);

991 
p
->
w_blocked
++;

992 
ÃwÏy
->
l_blockšg
 = 1;

995 
ÃwÏy
->
l_cvli¡
 = 
æay”
->l_cvlist;

996 
cvp
 = 
ÃwÏy
->
l_cvli¡
; cvp; cv°ğcvp->
c_Êext
)

997 
cvp
->
c_Ïy”
 = 
ÃwÏy
;

998 
æay”
->
l_cvli¡
 = 0;

1000 
ÃwÏy
->
l_width
 = 
æay”
->l_width;

1001 
ÃwÏy
->
l_height
 = 
æay”
->l_height;

1002 
ÃwÏy
->
l_’codšg
 = 0;

1003 
ÃwÏy
->
l_Ïyâ
 = 
lf
;

1004 
ÃwÏy
->
l_d©a
 = 
d©a
;

1005 
ÃwÏy
->
l_Ãxt
 = 
æay”
;

1006 
ÃwÏy
->
l_bÙtom
 = 
æay”
->l_bottom;

1007 
æay”
 = 
ÃwÏy
;

1008 
	`LayRe¡Üe
();

1010 
	}
}

1013 
	$Ex™Ov”ÏyPage
()

1015 
Ïy”
 *
ŞdÏy
;

1016 
wš
 *
p
;

1017 
dÜedi¥Ïy
 = 0;

1018 
ÿnvas
 *
cv
, *
ocv
;

1020 
	`ASSERT
(
æay”
);

1021 
	`debug1
("Ex™šg†ay” %#x\n", ()
æay”
);

1022 
ŞdÏy
 = 
æay”
;

1023 ià(
ŞdÏy
->
l_d©a
)

1024 
	`ä“
(
ŞdÏy
->
l_d©a
);

1026 
p
 = 
	`Lay”2Wšdow
(
æay”
);

1028 
æay”
 = 
ŞdÏy
->
l_Ãxt
;

1029 ià(
æay”
->
l_Ïyâ
 =ğ&
WšLf
)

1031 ià(
ŞdÏy
->
l_blockšg
)

1033 
	`ASSERT
(
p
->
w_blocked
 > 0);

1034 
p
->
w_blocked
--;

1035 
	`debug1
("Ïy” wa blockšg, -> w_blocked‚ow %d\n", 
p
->
w_blocked
);

1038 ià(
p
->
w_blocked
 &&…->
w_§v–ay”
 &&…->w_§v–ay” !ğ
æay”
 && 
ŞdÏy
->
l_cvli¡
)

1040 
	`debug
("warpingoop of blocking chain!\n");

1042 
æay”
 = 
p
->
w_§v–ay”
;

1043 
dÜedi¥Ïy
 = 1;

1046 ià(
p
 &&…->
w_§v–ay”
 =ğ
ŞdÏy
)

1047 
p
->
w_§v–ay”
 = 
æay”
;

1048 #ifdeà
COPY_PASTE


1049 ià(
p
 && 
ŞdÏy
 =ğp->
w_·¡”
.
·_·¡–ay”
)

1050 
p
->
w_·¡”
.
·_·¡–ay”
 = 0;

1054 
ocv
 = 0, 
cv
 = 
ŞdÏy
->
l_cvli¡
; cv; cv = cv->
c_Êext
)

1056 
cv
->
c_Ïy”
 = 
æay”
;

1057 
ocv
 = 
cv
;

1059 ià(
ocv
)

1061 
cv
 = 
æay”
->
l_cvli¡
;

1062 
ocv
->
c_Êext
 = 0;

1063 
æay”
->
l_cvli¡
 = 
ŞdÏy
->l_cvlist;

1065 ià(
dÜedi¥Ïy
)

1066 
	`LReäeshAÎ
(
æay”
, 0);

1067 
ocv
->
c_Êext
 = 
cv
;

1069 
ŞdÏy
->
l_cvli¡
 = 0;

1070 
	`ä“
((*)
ŞdÏy
);

1071 
	`LayRe¡Üe
();

1072 
	`LayS‘CursÜ
();

1073 
	}
}

1077 #ià
defšed
(
USEVARARGS
è&& defšed(
__STDC__
)

1078 
	$LMsg
(
”r
, *
fmt
, 
VA_DOTS
)

1080 
	$LMsg
(
”r
, 
fmt
, 
VA_DOTS
)

1081 
”r
;

1082 *
fmt
;

1083 
VA_DECL


1086 
	`VA_LIST
(
­
)

1087 
buf
[
MAXPATHLEN
*2];

1088 *
p
 = 
buf
;

1089 
ÿnvas
 *
cv
;

1091 
	`VA_START
(
­
, 
fmt
);

1092 
fmt
 = 
	`DoNLS
(fmt);

1093 ()
	`v¢´štf
(
p
, (
buf
è- 100, 
fmt
, 
	`VA_ARGS
(
­
));

1094 
	`VA_END
(
­
);

1095 ià(
”r
)

1097 
p
 +ğ
	`¡¾’
(p);

1098 *
p
++ = ':';

1099 *
p
++ = ' ';

1100 
	`¡ºıy
(
p
, 
	`¡»¼Ü
(
”r
), 
buf
 + (buf) -… - 1);

1101 
buf
[(buf) - 1] = 0;

1103 
	`debug2
("LMsg('%s'è(%#x);\n", 
buf
, ()
æay”
);

1104 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

1106 
cv
 = 
D_cvli¡
; cv; cv = cv->
c_Ãxt
)

1107 ià(
cv
->
c_Ïy”
 =ğ
æay”
)

1109 ià(
cv
 == 0)

1111 
	`MakeStus
(
buf
);

1113 
	}
}

	@layer.h

30 
	gmch¬
;

32 
	sLayFuncs


34 (*
	mlf_LayProûss
è
__P
((**, *));

35 (*
	mlf_LayAbÜt
è
__P
(());

36 (*
	mlf_LayRedi¥ÏyLše
è
__P
((, , , ));

37 (*
	mlf_LayCË¬Lše
è
__P
((, , , ));

38 (*
	mlf_LayRewr™e
è
__P
((, , , 
mch¬
 *, ));

39 (*
	mlf_LayResize
è
__P
((, ));

40 (*
	mlf_LayRe¡Üe
è
__P
(());

43 
	sÏy”


45 
ÿnvas
 *
	ml_cvli¡
;

46 
	ml_width
;

47 
	ml_height
;

48 
	ml_x
;

49 
	ml_y
;

50 
	ml_’codšg
;

51 
LayFuncs
 *
	ml_Ïyâ
;

52 *
	ml_d©a
;

54 
Ïy”
 *
	ml_Ãxt
;

55 
Ïy”
 *
	ml_bÙtom
;

56 
	ml_blockšg
;

59 
	#LayProûss
 (*
æay”
->
l_Ïyâ
->
lf_LayProûss
)

	)

60 
	#LayAbÜt
 (*
æay”
->
l_Ïyâ
->
lf_LayAbÜt
)

	)

61 
	#LayRedi¥ÏyLše
 (*
æay”
->
l_Ïyâ
->
lf_LayRedi¥ÏyLše
)

	)

62 
	#LayCË¬Lše
 (*
æay”
->
l_Ïyâ
->
lf_LayCË¬Lše
)

	)

63 
	#LayRewr™e
 (*
æay”
->
l_Ïyâ
->
lf_LayRewr™e
)

	)

64 
	#LayResize
 (*
æay”
->
l_Ïyâ
->
lf_LayResize
)

	)

65 
	#LayRe¡Üe
 (*
æay”
->
l_Ïyâ
->
lf_LayRe¡Üe
)

	)

67 
	#LayS‘CursÜ
(è
	`LGÙoPos
(
æay”
, fÏy”->
l_x
, fÏy”->
l_y
)

	)

68 
	#LayCªResize
(
l
èÖ->
l_Ïyâ
->
LayResize
 !ğ
DefResize
)

	)

72 
	#LAY_CALL_UP
(
â
) do \

74 
Ïy”
 *
ŞdÏy
 = 
æay”
; \

75 
ÿnvas
 *
Şdcvli¡
, *
cv
; \

76 
	`debug
("LayCallUp\n"); \

77 
æay”
 = fÏy”->
l_Ãxt
; \

78 
Şdcvli¡
 = 
æay”
->
l_cvli¡
; \

79 
	`debug1
("Şdcvli¡: %x\n", 
Şdcvli¡
); \

80 
æay”
->
l_cvli¡
 = 
ŞdÏy
->l_cvlist; \

81 
cv
 = 
æay”
->
l_cvli¡
; cv; cv = cv->
c_Êext
) \

82 
cv
->
c_Ïy”
 = 
æay”
; \

83 
â
; \

84 
æay”
 = 
ŞdÏy
; \

85 
cv
 = 
æay”
->
l_cvli¡
; cv; cv = cv->
c_Êext
) \

86 
cv
->
c_Ïy”
 = 
æay”
; \

87 
æay”
->
l_Ãxt
->
l_cvli¡
 = 
Şdcvli¡
; \

88 } 0)

	)

90 
	#LAY_DISPLAYS
(
l
, 
â
) do \

92 
di¥Ïy
 *
Şddi¥Ïy
 = display; \

93 
ÿnvas
 *
cv
; \

94 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
) \

96 
cv
 = 
D_cvli¡
; cv; cv = cv->
c_Ãxt
) \

97 ià(
cv
->
c_Ïy”
 =ğ
l
) \

99 ià(
cv
 == 0) \

101 
â
; \

103 
di¥Ïy
 = 
Şddi¥Ïy
; \

104 } 0)

	)

	@loadav.c

24 
	~<sys/ty³s.h
>

25 
	~<fú.h
>

26 #ifdeà
uÉrix


27 
	~<sys/fixpošt.h
>

31 #ifdeà
NeXT


32 
	~<sys/v”siÚ.h
>

33 #ià
KERNEL_MAJOR_VERSION
 > 2

34 
	~<mach/mach.h
>

36 
	~<mach.h
>

40 
	~"cÚfig.h
"

41 
	~"sü“n.h
"

43 
	~"ex‹º.h
"

45 #ifdeà
LOADAV


47 
G‘Lßdav
 
__P
(());

49 
LOADAV_TYPE
 
	glßdav
[
LOADAV_NUM
];

50 
	glßdok
;

56 #ià
defšed
(
lšux
è&& !defšed(
LOADAV_DONE
)

57 
	#LOADAV_DONE


	)

63 
	$In™Lßdav
()

65 
lßdok
 = 1;

66 
	}
}

69 
	$G‘Lßdav
()

71 
FILE
 *
å
;

72 
buf
[128], *
s
;

73 
i
;

74 
d
, 
e
;

76 ià((
å
 = 
	`£cfİ’
("/´oc/lßdavg", "r")è=ğ
NULL
)

78 *
buf
 = 0;

79 
	`fg‘s
(
buf
, (buf), 
å
);

80 
	`fşo£
(
å
);

84 
s
 = 
buf
;

85 
i
 = 0; i < (
LOADAV_NUM
 > 3 ? 3 : LOADAV_NUM); i++)

87 
d
 = 
e
 = 0;

88 *
s
 == ' ')

89 
s
++;

90 ià(*
s
 == 0)

94 ià(*
s
 == '.')

95 
e
 = 1;

96 ià(*
s
 >= '0' && *s <= '9')

98 
d
 = d * 10 + (*
s
 - '0');

99 ià(
e
)

100 
e
 *= 10;

104 
s
++;

106 
lßdav
[
i
] = 
e
 ? 
d
 /ƒ : d;

108  
i
;

109 
	}
}

114 #ià
defšed
(
LOADAV_GETLOADAVG
è&& !defšed(
LOADAV_DONE
)

115 
	#LOADAV_DONE


	)

117 
	$In™Lßdav
()

119 
lßdok
 = 1;

120 
	}
}

123 
	$G‘Lßdav
()

125  
	`g‘lßdavg
(
lßdav
, 
LOADAV_NUM
);

126 
	}
}

131 #ià
defšed
(
­Şlo
è&& !defšed(
LOADAV_DONE
)

132 
	#LOADAV_DONE


	)

134 
	$In™Lßdav
()

136 
lßdok
 = 1;

137 
	}
}

140 
	$G‘Lßdav
()

142 
	`´oc1_$g‘_lßdav
(
lßdav
);

143  
LOADAV_NUM
;

144 
	}
}

149 #ià
defšed
(
NeXT
è&& !defšed(
LOADAV_DONE
)

150 
	#LOADAV_DONE


	)

152 
´oûssÜ_£t_t
 
	gdeçuÉ_£t
;

155 
	$In™Lßdav
()

157 
k”n_»tuº_t
 
”rÜ
;

159 
”rÜ
 = 
	`´oûssÜ_£t_deçuÉ
(
	`ho¡_£lf
(), &
deçuÉ_£t
);

160 ià(
”rÜ
 !ğ
KERN_SUCCESS
)

161 
	`mach_”rÜ
("E¼Ü c®lšg…roûssÜ_£t_deçuÉ", 
”rÜ
);

163 
lßdok
 = 1;

164 
	}
}

167 
	$G‘Lßdav
()

169 
šfo_couÁ
;

170 
´oûssÜ_£t_basic_šfo
 
šfo
;

171 
ho¡_t
 
ho¡
;

173 
šfo_couÁ
 = 
PROCESSOR_SET_BASIC_INFO_COUNT
;

174 ià(
	`´oûssÜ_£t_šfo
(
deçuÉ_£t
, 
PROCESSOR_SET_BASIC_INFO
, &
ho¡
, (
´oûssÜ_£t_šfo_t
)&
šfo
, &
šfo_couÁ
è!ğ
KERN_SUCCESS
)

176 
lßdav
[0] = ()
šfo
.
lßd_av”age
 / 
LOAD_SCALE
;

178 
	}
}

183 #ià
defšed
(
sun
è&& defšed(
SVR4
è&& !defšed(
LOADAV_DONE
)

184 
	#LOADAV_DONE


	)

186 
	~<k¡©.h
>

188 
k¡©_ùl_t
 *
	gkc
;

191 
	$In™Lßdav
()

193 
lßdok
 = (
kc
 = 
	`k¡©_İ’
()) != 0;

194 
	}
}

197 
	$G‘Lßdav
()

199 
k¡©_t
 *
ks
;

200 
k¡©_Çmed_t
 *
avgs
[3];

201 
i
;

203 
	`k¡©_chaš_upd©e
(
kc
);

204 ià((
ks
 = 
	`k¡©_lookup
(
kc
, "unix", -1, "sy¡em_misc")è=ğ0 || 
	`k¡©_»ad
(kc, ks, (*)0) == -1)

205  (
lßdok
 = 0);

206 
avgs
[0] = 
	`k¡©_d©a_lookup
(
ks
, "avenrun_1min");

207 
avgs
[1] = 
	`k¡©_d©a_lookup
(
ks
, "avenrun_5min");

208 
avgs
[2] = 
	`k¡©_d©a_lookup
(
ks
, "avenrun_15min");

209 
i
 = 0; i < 3; i++)

211 ià(
avgs
[
i
] =ğ0 ||‡vgs[i]->
d©a_ty³
 !ğ
KSTAT_DATA_ULONG
)

212  (
lßdok
 = 0);

213 
lßdav
[
i
] = 
avgs
[i]->
v®ue
.
ul
;

216 
	}
}

222 #ià
defšed
(
__osf__
è&& defšed(
__®pha
è&& !defšed(
LOADAV_DONE
)

223 
	#LOADAV_DONE


	)

225 
	g¹’Œy
; 
	gmbuf
;

226 
	~<sys/bË.h
>

229 
	$In™Lßdav
()

231 
lßdok
 = 1;

232 
	}
}

235 
	$G‘Lßdav
()

237 
tbl_lßdavg
 
tbl
;

238 
i
;

240 ià(
	`bË
(
TBL_LOADAVG
, 0, &
tbl
, 1, (
tbl_lßdavg
)) != 1)

243 ià(
tbl
.
_lsÿË
)

246 
i
 = 0; i < 
LOADAV_NUM
; i++)

247 
lßdav
[
i
] = (è
tbl
.
_av’run
.
l
[i] /bl.
_lsÿË
;

252 
i
 = 0; i < 
LOADAV_NUM
; i++)

253 
lßdav
[
i
] = 
tbl
.
_av’run
.
d
[i];

255  
LOADAV_NUM
;

256 
	}
}

261 #ià!
defšed
(
LOADAV_DONE
)

268 #ifdeà
NLIST_STRUCT


269 
	~<Æi¡.h
>

271 
	~<a.out.h
>

273 #iâdeà
NLIST_DECLARED


274 
Æi¡
 
__P
((*, nlist *));

277 #ifdeà
LOADAV_USE_NLIST64


278 
	#Æi¡
 
Æi¡64


	)

281 
Æi¡
 
	gÆ
[2];

282 
	gkmemf
;

284 #ifdeà
_IBMR2


285 
	#Æi¡
(
u
,
l
è
	`kÆi¡
Ö,1,(*l))

	)

289 
	$In™Lßdav
()

291 
	`debug
("Init Kmem...\n");

292 ià((
kmemf
 = 
	`İ’
("/dev/kmem", 
O_RDONLY
)) == -1)

294 #ià!
	`defšed
(
_AUX_SOURCE
è&& !defšed(
AUX
)

295 #ifdeà
NLIST_NAME_UNION


296 
Æ
[0].
n_un
.
n_Çme
 = 
LOADAV_AVENRUN
;

298 
Æ
[0].
n_Çme
 = 
LOADAV_AVENRUN
;

301 
	`¡ºıy
(
Æ
[0].
n_Çme
, 
LOADAV_AVENRUN
, (nl[0].n_name));

303 
	`debug2
("S—rchšg iÀ% fÜ %s\n", 
LOADAV_UNIX
, 
Æ
[0].
n_Çme
);

304 
	`Æi¡
(
LOADAV_UNIX
, 
Æ
);

305 ià(
Æ
[0].
n_v®ue
 == 0)

307 
	`şo£
(
kmemf
);

311 #ifdeà
sgi


312 
Æ
[0].
n_v®ue
 &= ()-1 >> 1;

315 
	`debug1
("Av’runSym found (0x%lx)!!\n", 
Æ
[0].
n_v®ue
);

316 
lßdok
 = 1;

317 
	}
}

320 
	$G‘Lßdav
()

322 ià(
	`l£ek
(
kmemf
, (
off_t
è
Æ
[0].
n_v®ue
, 0) == (off_t)-1)

324 ià(
	`»ad
(
kmemf
, (*è
lßdav
, (loadav)) != (loadav))

326  
LOADAV_NUM
;

327 
	}
}

332 #iâdeà
FIX_TO_DBL


333 
	#FIX_TO_DBL
(
l
è(()Öè/ 
LOADAV_SCALE
)

	)

337 
	$AddLßdav
(
p
)

338 *
p
;

340 
i
, 
j
;

341 ià(
lßdok
 == 0)

343 
j
 = 
	`G‘Lßdav
();

344 
i
 = 0; i < 
j
; i++)

346 
	`¥rštf
(
p
, " %2.2f" + !
i
, 
	`FIX_TO_DBL
(
lßdav
[i]));

347 
p
 +ğ
	`¡¾’
(p);

349 
	}
}

	@logfile.c

24 
	~<sys/ty³s.h
>

25 
	~<sys/¡©.h
>

26 
	~<fú.h
>

29 
	~"cÚfig.h
"

30 
	~"sü“n.h
"

31 
	~"ex‹º.h
"

32 
	~"logfe.h
"

34 
chªged_logfe
 
__P
((
logfe
 *));

35 
logfe
 *
lookup_logfe
 
__P
((*));

36 
¡Ş’_logfe
 
__P
((
logfe
 *));

38 
logfe
 *
	glogroÙ
 = 
NULL
;

41 
	$chªged_logfe
(
l
)

42 
logfe
 *
l
;

44 
¡©
 
o
, *
s
 = 
l
->
¡
;

46 ià(
	`f¡©
(
	`f’o
(
l
->
å
), &
o
) < 0)

48 ià(
o
.
¡_size
 > 
s
->st_size)

50 
s
->
¡_size
 = 
o
.st_size;

51 
s
->
¡_mtime
 = 
o
.st_mtime;

53 
	}
}

64 
	$lf_move_fd
(
fd
, 
Ãed_fd
)

65 
Ãed_fd
, 
fd
;

67 
r
 = -1;

69 ià(
fd
 =ğ
Ãed_fd
)

70  
fd
;

71 ià(
fd
 >=0 && fd < 
Ãed_fd
)

72 
r
 = 
	`lf_move_fd
(
	`dup
(
fd
), 
Ãed_fd
);

73 
	`şo£
(
fd
);

74  
r
;

75 
	}
}

78 
	$logfe_»İ’
(
Çme
, 
wªtfd
, 
l
)

79 *
Çme
;

80 
wªtfd
;

81 
logfe
 *
l
;

83 
gÙ_fd
;

85 
	`şo£
(
wªtfd
);

86 ià(((
gÙ_fd
 = 
	`İ’
(
Çme
, 
O_WRONLY
 | 
O_CREAT
 | 
O_APPEND
, 0666)) < 0) ||

87 
	`lf_move_fd
(
gÙ_fd
, 
wªtfd
) < 0)

89 
	`logfşo£
(
l
);

90 
	`debug1
("logfe_»İ’: faed fÜ %s\n", 
Çme
);

93 
	`chªged_logfe
(
l
);

94 
	`debug2
("logfe_»İ’: %d = %s\n", 
wªtfd
, 
Çme
);

96 
	}
}

98 (* 
	glf_»İ’_â
)(èğ
logfe_»İ’
;

113 
	$log»İ’_»gi¡”
(
â
)

114 (*
â
è
	`__P
((*, , 
logfe
 *));

116 
lf_»İ’_â
 = 
â
 ? fÀ: 
logfe_»İ’
;

117 
	}
}

126 
	$¡Ş’_logfe
(
l
)

127 
logfe
 *
l
;

129 
¡©
 
o
, *
s
 = 
l
->
¡
;

131 
o
 = *
s
;

132 ià(
	`f¡©
(
	`f’o
(
l
->
å
), 
s
) < 0)

133 
s
->
¡_šo
 = s->
¡_dev
 = 0;

134 
	`ASSERT
(
s
 =ğ
l
->
¡
);

135 ià(!
o
.
¡_dev
 && !o.
¡_šo
)

138 ià((!
s
->
¡_dev
 && !s->
¡_šo
) ||

139 !
s
->
¡_Æšk
 ||

140 (
s
->
¡_size
 < 
o
.st_size) ||

141 (
s
->
¡_mtime
 !ğ
o
.st_mtime) ||

142 ((
s
->
¡_ùime
 !ğ
o
.st_ctime) &&

143 !(
s
->
¡_mtime
 =ğs->
¡_ùime
 &&

144 
o
.
¡_ùime
 < 
s
->st_ctime)))

146 
	`debug1
("¡Ş’_logfe: % ¡Ş’!\n", 
l
->
Çme
);

147 
	`debug3
("st_dev %d, st_ino %d, st_nlink %d\n",

148 ()
s
->
¡_dev
, ()s->
¡_šo
, ()s->
¡_Æšk
);

149 
	`debug2
("s->¡_siz%d, o.¡_siz%d\n", ()
s
->
¡_size
, ()
o
.st_size);

150 
	`debug2
("s->st_mtime %d, o.st_mtime %d\n",

151 ()
s
->
¡_mtime
, ()
o
.st_mtime);

152 
	`debug2
("s->st_ctime %d, o.st_ctime %d\n",

153 ()
s
->
¡_ùime
, ()
o
.st_ctime);

157 
	`debug1
("¡Ş’_logfe: % o.k.\n", 
l
->
Çme
);

159 
	}
}

161 
logfe
 *

162 
	$lookup_logfe
(
Çme
)

163 *
Çme
;

165 
logfe
 *
l
;

167 
l
 = 
logroÙ
;†;† =†->
Ãxt
)

168 ià(!
	`¡rcmp
(
Çme
, 
l
->name))

169  
l
;

170  
NULL
;

171 
	}
}

173 
logfe
 *

174 
	$logfİ’
(
Çme
, 
å
)

175 *
Çme
;

176 
FILE
 *
å
;

178 
logfe
 *
l
;

180 ià(!
å
)

182 ià(!(
l
 = 
	`lookup_logfe
(
Çme
)))

183  
NULL
;

184 
l
->
İ’couÁ
++;

185  
l
;

188 ià(!(
l
 = (
logfe
 *)
	`m®loc
((logfile))))

189  
NULL
;

190 ià(!(
l
->
¡
 = (
¡©
 *)
	`m®loc
((stat))))

192 
	`ä“
((*)
l
);

193  
NULL
;

196 ià(!(
l
->
Çme
 = 
	`SaveSŒ
(name)))

198 
	`ä“
((*)
l
->
¡
);

199 
	`ä“
((*)
l
);

200  
NULL
;

202 
l
->
å
 = fp;

203 
l
->
İ’couÁ
 = 1;

204 
l
->
wr™ecouÁ
 = 0;

205 
l
->
æushcouÁ
 = 0;

206 
	`chªged_logfe
(
l
);

208 
l
->
Ãxt
 = 
logroÙ
;

209 
logroÙ
 = 
l
;

210  
l
;

211 
	}
}

214 
	$i¦ogfe
(
Çme
)

215 *
Çme
;

217 ià(!
Çme
)

218  
logroÙ
 ? 1 : 0;

219  
	`lookup_logfe
(
Çme
) ? 1 : 0;

220 
	}
}

223 
	$logfşo£
(
l
)

224 
logfe
 *
l
;

226 
logfe
 **
Í
;

228 
Í
 = &
logroÙ
; *Í;†°ğ&(*Í)->
Ãxt
)

229 ià(*
Í
 =ğ
l
)

232 ià(!*
Í
)

235 ià((--
l
->
İ’couÁ
) > 0)

237 ià(
l
->
İ’couÁ
 < 0)

238 
	`abÜt
();

240 *
Í
 = 
l
->
Ãxt
;

241 
	`fşo£
(
l
->
å
);

242 
	`ä“
(
l
->
Çme
);

243 
	`ä“
((*)
l
);

245 
	}
}

253 
	$logfwr™e
(
l
, 
buf
, 
n
)

254 
logfe
 *
l
;

255 *
buf
;

256 
n
;

258 
r
;

260 ià(
	`¡Ş’_logfe
(
l
è&& 
	`lf_»İ’_â
Ö->
Çme
, 
	`f’o
Ö->
å
),†))

262 
r
 = 
	`fwr™e
(
buf
, 
n
, 1, 
l
->
å
);

263 
l
->
wr™ecouÁ
 +ğl->
æushcouÁ
 + 1;

264 
l
->
æushcouÁ
 = 0;

265 
	`chªged_logfe
(
l
);

266  
r
;

267 
	}
}

270 
	$logfæush
(
l
)

271 
logfe
 *
l
;

273 
r
 = 0;

275 ià(!
l
)

276 
l
 = 
logroÙ
;†;† =†->
Ãxt
)

278 ià(
	`¡Ş’_logfe
(
l
è&& 
	`lf_»İ’_â
Ö->
Çme
, 
	`f’o
Ö->
å
),†))

280 
r
 |ğ
	`fæush
(
l
->
å
);

281 
l
->
æushcouÁ
++;

282 
	`chªged_logfe
(
l
);

286 ià(
	`¡Ş’_logfe
(
l
è&& 
	`lf_»İ’_â
Ö->
Çme
, 
	`f’o
Ö->
å
),†))

288 
r
 = 
	`fæush
(
l
->
å
);

289 
l
->
æushcouÁ
++;

290 
	`chªged_logfe
(
l
);

292  
r
;

293 
	}
}

	@logfile.h

25 
	slogfe


27 
logfe
 *
	mÃxt
;

28 
FILE
 *
	må
;

29 *
	mÇme
;

30 
	mİ’couÁ
;

31 
	mwr™ecouÁ
;

32 
	mæushcouÁ
;

33 
¡©
 *
	m¡
;

42 
logfe
 *
logfİ’
 
__P
((*
Çme
, 
FILE
 *
å
));

49 
i¦ogfe
 
__P
((*
Çme
));

54 
logfşo£
 
__P
((
logfe
 *));

55 
logfwr™e
 
__P
((
logfe
 *, *, ));

62 
logfæush
 
__P
((
logfe
 *
içny
));

72 
log»İ’_»gi¡”
 
__P
(((*
â
è
	`__P
((*, , 
logfe
 *)) ));

82 
lf_move_fd
 
	`__P
((
fd
, 
wªtfd
));

	@mark.c

24 
	~<sys/ty³s.h
>

26 
	~"cÚfig.h
"

27 
	~"sü“n.h
"

28 
	~"m¬k.h
"

29 
	~"ex‹º.h
"

31 #ifdeà
COPY_PASTE


42 
is_Ë‰”
 
__P
(());

43 
ÃxtwÜd
 
__P
((*, *, , ));

44 
lše¡¬t
 
__P
(());

45 
lš“nd
 
__P
(());

46 
»m
 
__P
((, , , , , *, ));

47 
eq
 
__P
((, ));

48 
M¬kSüŞlDownDi¥Ïy
 
__P
(());

49 
M¬kSüŞlUpDi¥Ïy
 
__P
(());

51 
M¬kProûss
 
__P
((**, *));

52 
M¬kAbÜt
 
__P
(());

53 
M¬kRedi¥ÏyLše
 
__P
((, , , ));

54 
M¬kRewr™e
 
__P
((, , , 
mch¬
 *, ));

56 
Ïy”
 *
æay”
;

57 
di¥Ïy
 *di¥Ïy, *
di¥Ïys
;

58 
wš
 *
fÜe
;

59 
mlše
 
mlše_bÏnk
, 
mlše_nuÎ
;

60 
mch¬
 
mch¬_so
;

62 #ifdeà
FONT


63 
	g·¡efÚt
 = 1;

66 
LayFuncs
 
	gM¬kLf
 =

68 
M¬kProûss
,

69 
M¬kAbÜt
,

70 
M¬kRedi¥ÏyLše
,

71 
DefCË¬Lše
,

72 
M¬kRewr™e
,

73 
DefResize
,

74 
DefRe¡Üe


77 
	gjoš_w™h_ü
 = 0;

78 
	gcom·ùhi¡
 = 0;

80 
	gm¬k_key_b
[256];

82 
m¬kd©a
 *
	gm¬kd©a
;

90 
	$is_Ë‰”
(
c
)

91 
c
;

93 ià((
c
 >= 'a' && c <= 'z') ||

94 (
c
 >= 'A' && c <= 'Z') ||

95 (
c
 >= '0' && c <= '9') ||

96 
c
 == '_' || c == '.' ||

97 
c
 == '@' || c == ':' ||

98 
c
 == '%' || c == '!' ||

99 
c
 == '-' || c == '+')

102 ià(
c
 != ' ')

105 
	}
}

108 
	$lše¡¬t
(
y
)

109 
y
;

111 
x
;

112 *
i
;

114 
x
 = 
m¬kd©a
->
Ëá_m¬
, 
i
 = 
	`WIN
(
y
)->
image
 + x; x < 
fÜe
->
w_width
 - 1; x++)

115 ià(*
i
++ != ' ')

117 ià(
x
 =ğ
fÜe
->
w_width
 - 1)

118 
x
 = 
m¬kd©a
->
Ëá_m¬
;

119  
x
;

120 
	}
}

123 
	$lš“nd
(
y
)

124 
y
;

126 
x
;

127 *
i
;

129 
x
 = 
m¬kd©a
->
right_m¬
, 
i
 = 
	`WIN
(
y
)->
image
 + x; x >= 0; x--)

130 ià(*
i
-- != ' ')

132 ià(
x
 < 0)

133 
x
 = 
m¬kd©a
->
Ëá_m¬
;

134  
x
;

135 
	}
}

147 
	#NW_BACK
 (1<<0)

	)

148 
	#NW_ENDOFWORD
 (1<<1)

	)

149 
	#NW_MUSTMOVE
 (1<<2)

	)

150 
	#NW_BIG
 (1<<3)

	)

153 
	$ÃxtwÜd
(
xp
, 
yp
, 
æags
, 
num
)

154 *
xp
, *
yp
, 
æags
, 
num
;

156 
xx
 = 
fÜe
->
w_width
, 
yy
 = fÜe->
w_hi¡height
 + fÜe->
w_height
;

157 
sx
, 
oq
, 
q
, 
x
, 
y
;

158 
mlše
 *
ml
;

160 
x
 = *
xp
;

161 
y
 = *
yp
;

162 
sx
 = (
æags
 & 
NW_BACK
) ? -1 : 1;

163 ià((
æags
 & 
NW_ENDOFWORD
è&& (æag & 
NW_MUSTMOVE
))

164 
x
 +ğ
sx
;

165 
ml
 = 
	`WIN
(
y
);

166 
oq
 = -1; ; 
x
 +ğ
sx
, oq = 
q
)

168 ià(
x
 >ğ
xx
 || x < 0)

169 
q
 = 0;

170 ià(
æags
 & 
NW_BIG
)

171 
q
 = 
ml
->
image
[
x
] == ' ';

173 
q
 = 
	`is_Ë‰”
(
ml
->
image
[
x
]);

174 ià(
oq
 >ğ0 && oq !ğ
q
)

176 ià(
oq
 =ğ0 || !(
æags
 & 
NW_ENDOFWORD
))

177 *
xp
 = 
x
;

179 *
xp
 = 
x
-
sx
;

180 *
yp
 = 
y
;

181 ià((!(
æags
 & 
NW_ENDOFWORD
è&& 
q
) ||

182 ((
æags
 & 
NW_ENDOFWORD
è&& 
oq
))

184 ià(--
num
 <= 0)

188 ià(
x
 =ğ
xx
)

190 
x
 = -1;

191 ià(++
y
 >ğ
yy
)

193 
ml
 = 
	`WIN
(
y
);

195 ià(
x
 < 0)

197 
x
 = 
xx
;

198 ià(--
y
 < 0)

200 
ml
 = 
	`WIN
(
y
);

203 
	}
}

215 
	$»m
(
x1
, 
y1
, 
x2
, 
y2
, 
»di¥Ïy
, 
±
, 
y’d
)

216 
x1
, 
y1
, 
x2
, 
y2
, 
»di¥Ïy
, 
y’d
;

217 *
±
;

219 
i
, 
j
, 
äom
, 
to
, 
ry
, 
c
;

220 
l
 = 0;

221 *
im
;

222 
mlše
 *
ml
;

223 #ifdeà
FONT


224 
cf
, 
fÚt
;

225 *
fo
;

228 
m¬kd©a
->
£cÚd
 = 0;

229 ià(
y2
 < 
y1
 || ((y2 =ğy1è&& (
x2
 < 
x1
)))

231 
i
 = 
y2
;

232 
y2
 = 
y1
;

233 
y1
 = 
i
;

234 
i
 = 
x2
;

235 
x2
 = 
x1
;

236 
x1
 = 
i
;

238 
ry
 = 
y1
 - 
m¬kd©a
->
hi¡_off£t
;

240 
i
 = 
y1
;

241 ià(
»di¥Ïy
 !ğ2 && 
±
 =ğ0 && 
ry
 <0)

243 
i
 -ğ
ry
;

244 
ry
 = 0;

246 ; 
i
 <ğ
y2
; i++, 
ry
++)

248 ià(
»di¥Ïy
 !ğ2 && 
±
 =ğ0 && 
ry
 > 
y’d
)

250 
ml
 = 
	`WIN
(
i
);

251 
äom
 = (
i
 =ğ
y1
è? 
x1
 : 0;

252 ià(
äom
 < 
m¬kd©a
->
Ëá_m¬
)

253 
äom
 = 
m¬kd©a
->
Ëá_m¬
;

254 
to
 = 
fÜe
->
w_width
, 
im
 = 
ml
->
image
 +o;o >= 0;o--)

255 ià(*
im
-- != ' ')

257 ià(
i
 =ğ
y2
 && 
x2
 < 
to
)

258 
to
 = 
x2
;

259 ià(
to
 > 
m¬kd©a
->
right_m¬
)

260 
to
 = 
m¬kd©a
->
right_m¬
;

261 ià(
»di¥Ïy
 =ğ1 && 
äom
 <ğ
to
 && 
ry
 >=0 &&„y <ğ
y’d
)

262 
	`M¬kRedi¥ÏyLše
(
ry
, 
äom
, 
to
, 0);

263 ià(
»di¥Ïy
 !ğ2 && 
±
 == 0)

265 
j
 = 
äom
;

266 #ifdeà
DW_CHARS


267 ià(
	`dw_right
(
ml
, 
j
, 
fÜe
->
w_’codšg
))

268 
j
--;

270 
im
 = 
ml
->
image
 + 
j
;

271 #ifdeà
FONT


272 
fo
 = 
ml
->
fÚt
 + 
j
;

273 
fÚt
 = 
ASCII
;

275 ; 
j
 <ğ
to
; j++)

277 
c
 = ()*
im
++;

278 #ifdeà
FONT


279 
cf
 = ()*
fo
++;

280 #ifdeà
UTF8


281 ià(
fÜe
->
w_’codšg
 =ğ
UTF8
)

283 
c
 |ğ
cf
 << 8;

284 ià(
c
 =ğ
UCS_HIDDEN
)

286 
c
 = 
	`ToUtf8_comb
(
±
, c);

287 
l
 +ğ
c
;

288 ià(
±
)

289 
±
 +ğ
c
;

293 #ifdeà
DW_CHARS


294 ià(
	`is_dw_fÚt
(
cf
))

296 
c
 = c << 8 | ()*
im
++;

297 
fo
++;

298 
j
++;

301 ià(
·¡efÚt
)

303 
c
 = 
	`EncodeCh¬
(
±
, c | 
cf
 << 16, 
fÜe
->
w_’codšg
, &
fÚt
);

304 
l
 +ğ
c
;

305 ià(
±
)

306 
±
 +ğ
c
;

310 ià(
±
)

311 *
±
++ = 
c
;

312 
l
++;

314 #ifdeà
FONT


315 ià(
·¡efÚt
 && 
fÚt
 !ğ
ASCII
)

317 ià(
±
)

319 
	`¡rıy
(
±
, "\033(B");

320 
±
 += 3;

322 
l
 += 3;

325 ià(
i
 !ğ
y2
 && (
to
 !ğ
fÜe
->
w_width
 - 1 || 
ml
->
image
[to + 1] == ' '))

330 
m¬kd©a
->
nÚl
)

333 ià(
±
)

334 *
±
++ = '\r';

335 
l
++;

336 ià(
još_w™h_ü
)

338 ià(
±
)

339 *
±
++ = '\n';

340 
l
++;

346 ià(
±
)

347 *
±
++ = ' ';

348 
l
++;

351 ià(
±
)

352 *
±
++ = ',';

353 
l
++;

358  
l
;

359 
	}
}

366 
	$eq
(
a
, 
b
)

367 
a
, 
b
;

369 ià(
a
 =ğ
b
)

371 ià(
a
 =ğ0 || 
b
 == 0)

373 ià(
a
 <ğ'9' &&‡ >ğ'0' && 
b
 <= '9' && b >= '0')

376 
	}
}

382 
	$G‘Hi¡Üy
()

384 
i
 = 0, 
q
 = 0, 
xx
, 
yy
, 
x
, 
y
;

385 *
lš•
;

386 
mlše
 *
ml
;

388 
	`ASSERT
(
di¥Ïy
 && 
fÜe
);

389 
x
 = 
fÜe
->
w_x
;

390 ià(
x
 >ğ
fÜe
->
w_width
)

391 
x
 = 
fÜe
->
w_width
 - 1;

392 
y
 = 
fÜe
->
w_y
 + fÜe->
w_hi¡height
;

393 
	`debug2
("cursÜ i © x=%d, y=%d\n", 
x
, 
y
);

394 
ml
 = 
	`WIN
(
y
);

395 
xx
 = 
x
 - 1, 
lš•
 = 
ml
->
image
 + xx; xx >= 0; xx--)

396 ià((
q
 = *
lš•
--) != ' ' )

398 
	`debug3
("%ø© (%d,%d)\n", 
q
, 
xx
, 
y
);

399 
yy
 = 
y
 - 1; yy >= 0; yy--)

401 
ml
 = 
	`WIN
(
yy
);

402 
lš•
 = 
ml
->
image
;

403 ià(
xx
 < 0 || 
	`eq
(
lš•
[xx], 
q
))

405 
i
 = 
fÜe
->
w_width
 - 1, 
lš•
 +ği; i >ğ
x
; i--)

406 ià(*
lš•
-- != ' ')

408 ià(
i
 >ğ
x
)

412 ià(
yy
 < 0)

414 ià(
D_u£r
->
u_¶İ
.
buf
)

415 
	`U£rF»eCİyBufãr
(
D_u£r
);

416 ià((
D_u£r
->
u_¶İ
.
buf
 = (*)
	`m®loc
((è(
i
 - 
x
 + 2))è=ğ
NULL
)

418 
	`LMsg
(0, "Notƒnough memory... Sorry.");

421 
	`bcİy
((*)
lš•
 - 
i
 + 
x
 + 1, 
D_u£r
->
u_¶İ
.
buf
, i - x + 1);

422 
D_u£r
->
u_¶İ
.
Ën
 = 
i
 - 
x
 + 1;

423 #ifdeà
ENCODINGS


424 
D_u£r
->
u_¶İ
.
’c
 = 
fÜe
->
w_’codšg
;

427 
	}
}

433 
	$M¬kRoutše
()

435 
x
, 
y
;

437 
	`ASSERT
(
fÜe
 && 
di¥Ïy
 && 
D_u£r
);

439 
	`debug2
("MarkRoutine called: fore‚r %d, display %s\n",

440 
fÜe
->
w_numb”
, 
D_u£¹ty
);

442 ià(
	`In™Ov”ÏyPage
((*
m¬kd©a
), &
M¬kLf
, 1))

444 
æay”
->
l_’codšg
 = 
fÜe
->
w_’codšg
;

445 
m¬kd©a
 = (m¬kd©¨*)
æay”
->
l_d©a
;

446 
m¬kd©a
->
md_u£r
 = 
D_u£r
;

447 
m¬kd©a
->
md_wšdow
 = 
fÜe
;

448 
m¬kd©a
->
£cÚd
 = 0;

449 
m¬kd©a
->
»p_út
 = 0;

450 
m¬kd©a
->
­³nd_mode
 = 0;

451 
m¬kd©a
->
wr™e_bufãr
 = 0;

452 
m¬kd©a
->
nÚl
 = 0;

453 
m¬kd©a
->
Ëá_m¬
 = 0;

454 
m¬kd©a
->
right_m¬
 = 
fÜe
->
w_width
 - 1;

455 
m¬kd©a
->
hi¡_off£t
 = 
fÜe
->
w_hi¡height
;

456 
x
 = 
fÜe
->
w_x
;

457 
y
 = 
	`D2W
(
fÜe
->
w_y
);

458 ià(
x
 >ğ
fÜe
->
w_width
)

459 
x
 = 
fÜe
->
w_width
 - 1;

461 
	`LGÙoPos
(
æay”
, 
x
, 
	`W2D
(
y
));

462 
	`LMsg
(0, "Copy mode - Column %d Line %d(+%d) (%d,%d)",

463 
x
 + 1, 
	`W2D
(
y
 + 1), 
fÜe
->
w_hi¡height
, fÜe->
w_width
, fÜe->
w_height
);

464 
m¬kd©a
->
cx
 = m¬kd©a->
x1
 = 
x
;

465 
m¬kd©a
->
cy
 = m¬kd©a->
y1
 = 
y
;

466 
æay”
->
l_x
 = 
x
;

467 
æay”
->
l_y
 = 
	`W2D
(
y
);

468 
	}
}

471 
	$M¬kProûss
(
šbuå
,
šËÅ
)

472 **
šbuå
;

473 *
šËÅ
;

475 *
šbuf
, *
±
;

476 
šËn
;

477 
cx
, 
cy
, 
x2
, 
y2
, 
j
, 
y’d
;

478 
ÃwcİyËn
 = 0, 
od
;

479 
š_m¬k
;

480 
»p_út
;

481 
aşu£r
 *
md_u£r
;

487 
m¬kd©a
 = (m¬kd©¨*)
æay”
->
l_d©a
;

488 
fÜe
 = 
m¬kd©a
->
md_wšdow
;

489 
md_u£r
 = 
m¬kd©a
->md_user;

490 ià(
šbuå
 == 0)

492 
	`M¬kAbÜt
();

496 
	`LGÙoPos
(
æay”
, 
m¬kd©a
->
cx
, 
	`W2D
(m¬kd©a->
cy
));

497 
šbuf
ğ*
šbuå
;

498 
šËn
ğ*
šËÅ
;

499 
±
 = 
šbuf
;

500 
š_m¬k
 = 1;

501 
š_m¬k
 && (
šËn
 ))

513 
od
 = 
m¬k_key_b
[()()*
±
++];

514 
šËn
--;

516 
»p_út
 = 
m¬kd©a
->rep_cnt;

517 ià(
od
 >= '0' && od <= '9')

519 ià(
»p_út
 < 1001 && (
od
 != '0' ||„ep_cnt != 0))

521 
m¬kd©a
->
»p_út
 = 10 *„•_úˆ+ 
od
 - '0';

535 
cx
 = 
m¬kd©a
->cx;

536 
cy
 = 
m¬kd©a
->cy;

537 
od
)

541 ià(!
m¬kd©a
->
£cÚd
)

543 
m¬kd©a
->
cx
 = m¬kd©a->
x1
;

544 
m¬kd©a
->
cy
 = m¬kd©a->
y1
;

545 
m¬kd©a
->
x1
 = 
cx
;

546 
m¬kd©a
->
y1
 = 
cy
;

547 
	`»vto
(
m¬kd©a
->
cx
, m¬kd©a->
cy
);

550 
	`Redi¥Ïy
(0);

551 
	`LGÙoPos
(
æay”
, 
cx
, 
	`W2D
(
cy
));

556 ià(
»p_út
 == 0)

557 
»p_út
 = 1;

558 
	`»vto
(
cx
 - 
»p_út
, 
cy
);

563 ià(
»p_út
 == 0)

564 
»p_út
 = 1;

565 
	`»vto
(
cx
, 
cy
 + 
»p_út
);

568 ià(
»p_út
 == 0)

569 
»p_út
 = 1;

570 
j
 = 
cy
 + 
»p_út
;

571 ià(
j
 > 
fÜe
->
w_hi¡height
 + fÜe->
w_height
 - 1)

572 
j
 = 
fÜe
->
w_hi¡height
 + fÜe->
w_height
 - 1;

573 
	`»vto
(
	`lše¡¬t
(
j
), j);

576 ià(
»p_út
 == 0)

577 
»p_út
 = 1;

578 
cy
 -ğ
»p_út
;

579 ià(
cy
 < 0)

580 
cy
 = 0;

581 
	`»vto
(
	`lše¡¬t
(
cy
), cy);

584 
	`»vto
(
	`lše¡¬t
(
cy
), cy);

587 
	`»vto
(
m¬kd©a
->
Ëá_m¬
, 
cy
 + 1);

592 ià(
»p_út
 == 0)

593 
»p_út
 = 1;

594 
	`»vto
(
cx
, 
cy
 - 
»p_út
);

598 ià(
»p_út
 == 0)

599 
»p_út
 = 1;

600 
	`»vto
(
cx
 + 
»p_út
, 
cy
);

604 
	`»vto
(
m¬kd©a
->
Ëá_m¬
, 
cy
);

607 ià(
»p_út
 == 0)

608 
»p_út
 = (
fÜe
->
w_height
 + 1) >> 1;

609 
	`»vto_lše
(
cx
, 
cy
 + 
»p_út
, 
	`W2D
(cy));

612 
	`»vto
(
	`lš“nd
(
cy
), cy);

615 
	`IS—rch
(-1);

616 
š_m¬k
 = 0;

619 
	`IS—rch
(1);

620 
š_m¬k
 = 0;

623 ià(
»p_út
 == 0)

624 
»p_út
 = (
fÜe
->
w_height
 + 1) >> 1;

625 
	`»vto_lše
(
cx
, 
cy
 - 
»p_út
, 
	`W2D
(cy));

628 ià(
m¬kd©a
->
Ëá_m¬
 =ğ0 && m¬kd©a->
right_m¬
 =ğ
fÜe
->
w_width
 - 1)

629 
	`LMsg
(0, "CŞumÀ%d Lš%d(+%d)", 
cx
+1, 
	`W2D
(
cy
)+1,

630 
m¬kd©a
->
hi¡_off£t
);

632 
	`LMsg
(0, "CŞumÀ%d(%d..%dèLš%d(+%d)", 
cx
+1,

633 
m¬kd©a
->
Ëá_m¬
+1, m¬kd©a->
right_m¬
+1, 
	`W2D
(
cy
)+1, m¬kd©a->
hi¡_off£t
);

636 ià(
»p_út
 == 0)

637 
»p_út
 = 1;

638 
»p_út
 *ğ
fÜe
->
w_height
;

639 
	`»vto
(
cx
, 
cy
 - 
»p_út
);

642 ià(
»p_út
 == 0)

643 
»p_út
 = 1;

644 
»p_út
 *ğ
fÜe
->
w_height
;

645 
	`»vto
(
cx
, 
cy
 + 
»p_út
);

648 ià(
»p_út
 == 0)

649 
»p_út
 = 1;

650 
»p_út
 = 
	`M¬kSüŞlUpDi¥Ïy
(rep_cnt);

651 ià(
cy
 < 
	`D2W
(0))

652 
	`»vto
(
cx
, 
	`D2W
(0));

654 
	`LGÙoPos
(
æay”
, 
cx
, 
	`W2D
(
cy
));

657 ià(
»p_út
 == 0)

658 
»p_út
 = 1;

659 
»p_út
 = 
	`M¬kSüŞlDownDi¥Ïy
(rep_cnt);

660 ià(
cy
 > 
	`D2W
(
fÜe
->
w_height
-1))

661 
	`»vto
(
cx
, 
	`D2W
(
fÜe
->
w_height
-1));

663 
	`LGÙoPos
(
æay”
, 
cx
, 
	`W2D
(
cy
));

669 
»p_út
--;

671 ià(
»p_út
 < 0)

672 
»p_út
 = 0;

673 ià(
»p_út
 > 100)

674 
»p_út
 = 100;

675 
	`»vto_lše
(
m¬kd©a
->
Ëá_m¬
, (
»p_út
 * (
fÜe
->
w_hi¡height
 + fÜe->
w_height
)) / 100, (fore->w_height - 1) / 2);

679 
»p_út
 = 1;

684 ià(
»p_út
 == 0)

685 
»p_út
 = 
fÜe
->
w_hi¡height
 + fÜe->
w_height
;

686 
	`»vto_lše
(
m¬kd©a
->
Ëá_m¬
, --
»p_út
, (
fÜe
->
w_height
 - 1) / 2);

689 
	`»vto
(
m¬kd©a
->
Ëá_m¬
, 
	`D2W
(0));

692 
	`»vto
(
m¬kd©a
->
Ëá_m¬
, 
	`D2W
((
fÜe
->
w_height
 - 1) / 2));

695 
	`»vto
(
m¬kd©a
->
Ëá_m¬
, 
	`D2W
(
fÜe
->
w_height
 - 1));

698 
	`»vto
(--
»p_út
, 
cy
);

701 ià(
»p_út
 == 0)

702 
»p_út
 = 1;

703 
	`ÃxtwÜd
(&
cx
, &
cy
, 
NW_MUSTMOVE
, 
»p_út
);

704 
	`»vto
(
cx
, 
cy
);

708 ià(
»p_út
 == 0)

709 
»p_út
 = 1;

710 
	`ÃxtwÜd
(&
cx
, &
cy
, 
NW_ENDOFWORD
|
NW_MUSTMOVE
 | (
od
 =ğ'E' ? 
NW_BIG
 : 0), 
»p_út
);

711 
	`»vto
(
cx
, 
cy
);

715 ià(
»p_út
 == 0)

716 
»p_út
 = 1;

717 
	`ÃxtwÜd
(&
cx
, &
cy
, 
NW_BACK
|
NW_ENDOFWORD
|
NW_MUSTMOVE
 | (
od
 =ğ'B' ? 
NW_BIG
 : 0), 
»p_út
);

718 
	`»vto
(
cx
, 
cy
);

721 
m¬kd©a
->
­³nd_mode
 = 1 - markdata->append_mode;

722 
	`debug1
("­³nd mod%d--\n", 
m¬kd©a
->
­³nd_mode
);

723 
	`LMsg
(0, (
m¬kd©a
->
­³nd_mode
) ? ":set‡ppend" : ":set‚oappend");

728 ià(
m¬kd©a
->
Ëá_m¬
 == 8)

729 
»p_út
 = 1;

731 
»p_út
 = 9;

736 ià(
m¬kd©a
->
£cÚd
)

738 
	`»m
(
m¬kd©a
->
x1
, m¬kd©a->
y1
, 
cx
, 
cy
, 1, (*)0, 
fÜe
->
w_height
-1);

739 
m¬kd©a
->
£cÚd
 = 1;

741 
»p_út
--;

742 ià(
»p_út
 < 0)

743 
»p_út
 = 
cx
;

744 ià(
od
 != 'C')

746 
m¬kd©a
->
Ëá_m¬
 = 
»p_út
;

747 ià(
m¬kd©a
->
Ëá_m¬
 > m¬kd©a->
right_m¬
)

748 
m¬kd©a
->
Ëá_m¬
 = m¬kd©a->
right_m¬
;

752 
m¬kd©a
->
right_m¬
 = 
»p_út
;

753 ià(
m¬kd©a
->
Ëá_m¬
 > m¬kd©a->
right_m¬
)

754 
m¬kd©a
->
right_m¬
 = m¬kd©a->
Ëá_m¬
;

756 ià(
m¬kd©a
->
£cÚd
)

758 
m¬kd©a
->
cx
 = m¬kd©a->
x1
; m¬kd©a->
cy
 = m¬kd©a->
y1
;

759 
	`»vto
(
cx
, 
cy
);

761 ià(
od
 == 'v' || od == 'V')

762 
	`LMsg
(0, (
m¬kd©a
->
Ëá_m¬
 != 8) ? ":set‚onu" : ":set‚u");

766 
m¬kd©a
->
nÚl
 = (markdata->nonl + 1) % 4;

767 
m¬kd©a
->
nÚl
)

770 ià(
još_w™h_ü
)

771 
	`LMsg
(0, "Multiple†ines (CR/LF)");

773 
	`LMsg
(0, "Multiple†ines (LF)");

776 
	`LMsg
(0, "Lines joined");

779 
	`LMsg
(0, "Lines joined with blanks");

782 
	`LMsg
(0, "Lines joined with comma");

787 
	`S—rch
(1);

788 
š_m¬k
 = 0;

791 
	`S—rch
(-1);

792 
š_m¬k
 = 0;

795 
	`S—rch
(0);

799 ià(
m¬kd©a
->
£cÚd
 == 0)

801 
	`»vto
(
	`lše¡¬t
(
cy
), cy);

802 
m¬kd©a
->
£cÚd
++;

803 
cx
 = 
m¬kd©a
->
x1
 = markdata->cx;

804 
cy
 = 
m¬kd©a
->
y1
 = markdata->cy;

806 ià(--
»p_út
 > 0)

807 
	`»vto
(
cx
, 
cy
 + 
»p_út
);

808 
	`»vto
(
	`lš“nd
(
m¬kd©a
->
cy
), markdata->cy);

809 ià(
od
 == 'y')

813 ià(
od
 == 'W')

815 ià(
»p_út
 == 0)

816 
»p_út
 = 1;

817 ià(!
m¬kd©a
->
£cÚd
)

819 
	`ÃxtwÜd
(&
cx
, &
cy
, 
NW_BACK
|
NW_ENDOFWORD
, 1);

820 
	`»vto
(
cx
, 
cy
);

821 
m¬kd©a
->
£cÚd
++;

822 
cx
 = 
m¬kd©a
->
x1
 = markdata->cx;

823 
cy
 = 
m¬kd©a
->
y1
 = markdata->cy;

825 
	`ÃxtwÜd
(&
cx
, &
cy
, 
NW_ENDOFWORD
, 
»p_út
);

826 
	`»vto
(
cx
, 
cy
);

828 
cx
 = 
m¬kd©a
->cx;

829 
cy
 = 
m¬kd©a
->cy;

832 ià(
od
 == 'A')

833 
m¬kd©a
->
­³nd_mode
 = 1;

836 ià(
od
 == '>')

837 
m¬kd©a
->
wr™e_bufãr
 = 1;

841 ià(!
m¬kd©a
->
£cÚd
)

843 
m¬kd©a
->
£cÚd
++;

844 
m¬kd©a
->
x1
 = 
cx
;

845 
m¬kd©a
->
y1
 = 
cy
;

846 
	`»vto
(
cx
, 
cy
);

847 
	`LMsg
(0, "Fœ¡ m¬k s‘ - CŞumÀ%d Lš%d", 
cx
+1, 
	`W2D
(
cy
)+1);

852 
­³nd_mode
 = 
m¬kd©a
->append_mode;

853 
wr™e_bufãr
 = 
m¬kd©a
->write_buffer;

855 
x2
 = 
cx
;

856 
y2
 = 
cy
;

857 
ÃwcİyËn
 = 
	`»m
(
m¬kd©a
->
x1
, m¬kd©a->
y1
, 
x2
, 
y2
, 2, (*)0, 0);

858 ià(
md_u£r
->
u_¶İ
.
buf
 && !
­³nd_mode
)

859 
	`U£rF»eCİyBufãr
(
md_u£r
);

860 
y’d
 = 
fÜe
->
w_height
 - 1;

861 ià(
fÜe
->
w_hi¡height
 - 
m¬kd©a
->
hi¡_off£t
 < fÜe->
w_height
)

863 
m¬kd©a
->
£cÚd
 = 0;

864 
y’d
 -ğ
	`M¬kSüŞlUpDi¥Ïy
(
fÜe
->
w_hi¡height
 - 
m¬kd©a
->
hi¡_off£t
);

866 ià(
ÃwcİyËn
 > 0)

869 ià(
md_u£r
->
u_¶İ
.
buf
)

870 
md_u£r
->
u_¶İ
.
buf
 = 
	`»®loc
(md_user->u_plop.buf,

871 (è(
md_u£r
->
u_¶İ
.
Ën
 + 
ÃwcİyËn
 + 3));

874 
md_u£r
->
u_¶İ
.
Ën
 = 0;

875 
md_u£r
->
u_¶İ
.
buf
 = 
	`m®loc
((è(
ÃwcİyËn
 + 3));

877 ià(!
md_u£r
->
u_¶İ
.
buf
)

879 
	`M¬kAbÜt
();

880 
š_m¬k
 = 0;

881 
	`LMsg
(0, "Notƒnough memory... Sorry.");

882 
md_u£r
->
u_¶İ
.
Ën
 = 0;

883 
md_u£r
->
u_¶İ
.
buf
 = 0;

886 ià(
­³nd_mode
)

888 
m¬kd©a
->
nÚl
)

894 ià(
još_w™h_ü
)

896 
md_u£r
->
u_¶İ
.
buf
[md_u£r->u_¶İ.
Ën
] = '\r';

897 
md_u£r
->
u_¶İ
.
Ën
++;

899 
md_u£r
->
u_¶İ
.
buf
[md_u£r->u_¶İ.
Ën
] = '\n';

900 
md_u£r
->
u_¶İ
.
Ën
++;

905 
md_u£r
->
u_¶İ
.
buf
[md_u£r->u_¶İ.
Ën
] = ' ';

906 
md_u£r
->
u_¶İ
.
Ën
++;

909 
md_u£r
->
u_¶İ
.
buf
[md_u£r->u_¶İ.
Ën
] = ',';

910 
md_u£r
->
u_¶İ
.
Ën
++;

914 
md_u£r
->
u_¶İ
.
Ën
 +ğ
	`»m
(
m¬kd©a
->
x1
, m¬kd©a->
y1
, 
x2
, 
y2
,

915 
m¬kd©a
->
hi¡_off£t
 =ğ
fÜe
->
w_hi¡height
,

916 
md_u£r
->
u_¶İ
.
buf
 + md_u£r->u_¶İ.
Ën
, 
y’d
);

917 #ifdeà
ENCODINGS


918 
md_u£r
->
u_¶İ
.
’c
 = 
fÜe
->
w_’codšg
;

921 ià(
m¬kd©a
->
hi¡_off£t
 !ğ
fÜe
->
w_hi¡height
)

923 
	`LAY_CALL_UP
(
	`LReäeshAÎ
(
æay”
, 0));

925 
	`Ex™Ov”ÏyPage
();

926 ià(
­³nd_mode
)

927 
	`LMsg
(0, "Appended %d characterso buffer",

928 
ÃwcİyËn
);

930 
	`LMsg
(0, "Cİ›d %d ch¬aù” štØbufãr", 
md_u£r
->
u_¶İ
.
Ën
);

931 ià(
wr™e_bufãr
)

932 
	`Wr™eFe
(
md_u£r
, (*)0, 
DUMP_EXCHANGE
);

933 
š_m¬k
 = 0;

937 
	`M¬kAbÜt
();

938 
	`LMsg
(0, "Copy mode‡borted");

939 
š_m¬k
 = 0;

942 ià(
š_m¬k
)

943 
m¬kd©a
->
»p_út
 = 0;

945 ià(
š_m¬k
)

947 
æay”
->
l_x
 = 
m¬kd©a
->
cx
;

948 
æay”
->
l_y
 = 
	`W2D
(
m¬kd©a
->
cy
);

950 *
šbuå
 = 
±
;

951 *
šËÅ
 = 
šËn
;

952 
	}
}

954 
	$»vto
(
tx
, 
ty
)

955 
tx
, 
ty
;

957 
	`»vto_lše
(
tx
, 
ty
, -1);

958 
	}
}

961 
	$»vto_lše
(
tx
, 
ty
, 
lše
)

962 
tx
, 
ty
, 
lše
;

964 
fx
, 
fy
;

965 
x
, 
y
, 
t
, 
»v¡
, 
»v’
, 
qq
, 
ff
, 
‰
, 
¡
, 
’
, 
û
 = 0;

966 
y¡¬t
 = 0, 
y’d
 = 
fÜe
->
w_height
-1;

967 
i
, 
ry
;

968 *
wi
;

969 
mlše
 *
ml
;

970 
mch¬
 
mc
;

972 ià(
tx
 < 0)

973 
tx
 = 0;

974 ià(
tx
 > 
fÜe
->
w_width
 - 1)

975 
tx
 = 
fÜe
->
w_width
 -1;

976 ià(
ty
 < 0)

977 
ty
 = 0;

978 ià(
ty
 > 
fÜe
->
w_hi¡height
 + fÜe->
w_height
 - 1)

979 
ty
 = 
fÜe
->
w_hi¡height
 + fÜe->
w_height
 - 1;

981 
fx
 = 
m¬kd©a
->
cx
; 
fy
 = m¬kd©a->
cy
;

983 #ifdeà
DW_CHARS


985 
ml
 = 
	`WIN
(
ty
);

986 ià(
ty
 =ğ
fy
 && 
fx
 + 1 =ğ
tx
 && 
	`dw_right
(
ml
,x, 
fÜe
->
w_’codšg
è&&x < 
D_width
 - 1)

987 
tx
++;

988 ià(
ty
 =ğ
fy
 && 
fx
 - 1 =ğ
tx
 && 
	`dw_right
(
ml
, fx, 
fÜe
->
w_’codšg
) &&x)

989 
tx
--;

992 
m¬kd©a
->
cx
 = 
tx
; m¬kd©a->
cy
 = 
ty
;

998 
i
 = 0;

999 ià(
lše
 >ğ0 &&†š< 
fÜe
->
w_height
)

1000 
i
 = 
	`W2D
(
ty
è- 
lše
;

1001 ià(
ty
 < 
m¬kd©a
->
hi¡_off£t
)

1002 
i
 = 
ty
 - 
m¬kd©a
->
hi¡_off£t
;

1003 ià(
ty
 > 
m¬kd©a
->
hi¡_off£t
 + (
fÜe
->
w_height
 - 1))

1004 
i
 = 
ty
 - 
m¬kd©a
->
hi¡_off£t
 - (
fÜe
->
w_height
 - 1);

1005 ià(
i
 > 0)

1006 
y’d
 -ğ
	`M¬kSüŞlUpDi¥Ïy
(
i
);

1007 ià(
i
 < 0)

1008 
y¡¬t
 +ğ
	`M¬kSüŞlDownDi¥Ïy
(-
i
);

1010 ià(
m¬kd©a
->
£cÚd
 == 0)

1012 
	`LGÙoPos
(
æay”
, 
tx
, 
	`W2D
(
ty
));

1016 
qq
 = 
m¬kd©a
->
x1
 + m¬kd©a->
y1
 * 
fÜe
->
w_width
;

1017 
ff
 = 
fx
 + 
fy
 * 
fÜe
->
w_width
;

1018 
‰
 = 
tx
 + 
ty
 * 
fÜe
->
w_width
;

1020 ià(
ff
 > 
‰
)

1022 
¡
 = 
‰
; 
’
 = 
ff
;

1023 
x
 = 
tx
; 
y
 = 
ty
;

1027 
¡
 = 
ff
; 
’
 = 
‰
;

1028 
x
 = 
fx
; 
y
 = 
fy
;

1030 ià(
¡
 > 
qq
)

1032 
¡
++;

1033 
x
++;

1035 ià(
’
 < 
qq
)

1036 
’
--;

1037 ià(
‰
 > 
qq
)

1039 
»v¡
 = 
qq
; 
»v’
 = 
‰
;

1043 
»v¡
 = 
‰
; 
»v’
 = 
qq
;

1045 
ry
 = 
y
 - 
m¬kd©a
->
hi¡_off£t
;

1046 ià(
ry
 < 
y¡¬t
)

1048 
y
 +ğ(
y¡¬t
 - 
ry
);

1049 
x
 = 0;

1050 
¡
 = 
y
 * 
fÜe
->
w_width
;

1051 
ry
 = 
y¡¬t
;

1053 
ml
 = 
	`WIN
(
y
);

1054 
t
 = 
¡
; <ğ
’
;++, 
x
++)

1056 ià(
x
 >ğ
fÜe
->
w_width
)

1058 
x
 = 0;

1059 
y
++, 
ry
++;

1060 
ml
 = 
	`WIN
(
y
);

1062 ià(
ry
 > 
y’d
)

1064 ià(
t
 =ğ
¡
 || 
x
 == 0)

1066 
wi
 = 
ml
->
image
 + 
fÜe
->
w_width
;

1067 
û
 = 
fÜe
->
w_width
; c>ğ0; ce--, 
wi
--)

1068 ià(*
wi
 != ' ')

1071 ià(
x
 <ğ
û
 && x >ğ
m¬kd©a
->
Ëá_m¬
 && x <ğm¬kd©a->
right_m¬
)

1073 #ifdeà
DW_CHARS


1074 ià(
	`dw_right
(
ml
, 
x
, 
fÜe
->
w_’codšg
))

1076 ià(
t
 =ğ
»v¡
)

1077 
»v¡
--;

1078 
t
--;

1079 
x
--;

1082 ià(
t
 >ğ
»v¡
 && <ğ
»v’
)

1084 
mc
 = 
mch¬_so
;

1085 #ifdeà
FONT


1086 ià(
·¡efÚt
)

1087 
mc
.
fÚt
 = 
ml
->fÚt[
x
];

1089 
mc
.
image
 = 
ml
->image[
x
];

1092 
	`cİy_mlše2mch¬
(&
mc
, 
ml
, 
x
);

1093 #ifdeà
DW_CHARS


1094 ià(
	`dw_Ëá
(
ml
, 
x
, 
fÜe
->
w_’codšg
))

1096 
mc
.
mbcs
 = 
ml
->
image
[
x
 + 1];

1097 
	`LPutCh¬
(
æay”
, &
mc
, 
x
, 
	`W2D
(
y
));

1098 
t
++;

1101 
	`LPutCh¬
(
æay”
, &
mc
, 
x
, 
	`W2D
(
y
));

1102 #ifdeà
DW_CHARS


1103 ià(
	`dw_Ëá
(
ml
, 
x
, 
fÜe
->
w_’codšg
))

1104 
x
++;

1108 
	`LGÙoPos
(
æay”
, 
tx
, 
	`W2D
(
ty
));

1109 
	}
}

1112 
	$M¬kAbÜt
()

1114 
y’d
, 
»di¥
;

1116 
	`debug
("MarkAbort\n");

1117 
m¬kd©a
 = (m¬kd©¨*)
æay”
->
l_d©a
;

1118 
fÜe
 = 
m¬kd©a
->
md_wšdow
;

1119 
y’d
 = 
fÜe
->
w_height
 - 1;

1120 
»di¥
 = 
m¬kd©a
->
£cÚd
;

1121 ià(
fÜe
->
w_hi¡height
 - 
m¬kd©a
->
hi¡_off£t
 < fÜe->
w_height
)

1123 
m¬kd©a
->
£cÚd
 = 0;

1124 
y’d
 -ğ
	`M¬kSüŞlUpDi¥Ïy
(
fÜe
->
w_hi¡height
 - 
m¬kd©a
->
hi¡_off£t
);

1126 ià(
m¬kd©a
->
hi¡_off£t
 !ğ
fÜe
->
w_hi¡height
)

1128 
	`LAY_CALL_UP
(
	`LReäeshAÎ
(
æay”
, 0));

1132 
	`»m
(
m¬kd©a
->
x1
, m¬kd©a->
y1
, m¬kd©a->
cx
, m¬kd©a->
cy
, 
»di¥
, (*)0, 
y’d
);

1134 
	`Ex™Ov”ÏyPage
();

1135 
	}
}

1139 
	$M¬kRedi¥ÏyLše
(
y
, 
xs
, 
xe
, 
isbÏnk
)

1140 
y
;

1141 
xs
, 
xe
;

1142 
isbÏnk
;

1144 
wy
, 
x
, 
i
, 
rm
;

1145 
¡a
, 
¡o
, 
ı
;

1146 *
wi
;

1147 
mlše
 *
ml
;

1148 
mch¬
 
mch¬_m¬ked
;

1150 ià(
y
 < 0)

1153 
m¬kd©a
 = (m¬kd©¨*)
æay”
->
l_d©a
;

1154 
fÜe
 = 
m¬kd©a
->
md_wšdow
;

1156 
mch¬_m¬ked
 = 
mch¬_so
;

1158 
wy
 = 
	`D2W
(
y
);

1159 
ml
 = 
	`WIN
(
wy
);

1161 ià(
m¬kd©a
->
£cÚd
 == 0)

1163 ià(
	`dw_right
(
ml
, 
xs
, 
fÜe
->
w_’codšg
) && xs > 0)

1164 
xs
--;

1165 ià(
	`dw_Ëá
(
ml
, 
xe
, 
fÜe
->
w_’codšg
è&& x< fÜe->
w_width
 - 1)

1166 
xe
++;

1167 ià(
xs
 =ğ0 && 
y
 > 0 && 
wy
 > 0 && 
	`WIN
(wy - 1)->
image
[
æay”
->
l_width
] == 0)

1168 
	`LCDi¥ÏyLšeW¿p
(
æay”
, 
ml
, 
y
, 
xs
, 
xe
, 
isbÏnk
);

1170 
	`LCDi¥ÏyLše
(
æay”
, 
ml
, 
y
, 
xs
, 
xe
, 
isbÏnk
);

1174 
¡a
 = 
m¬kd©a
->
y1
 * 
fÜe
->
w_width
 + m¬kd©a->
x1
;

1175 
¡o
 = 
m¬kd©a
->
cy
 * 
fÜe
->
w_width
 + m¬kd©a->
cx
;

1176 ià(
¡a
 > 
¡o
)

1178 
i
=
¡a
; s=
¡o
; sto=i;

1180 
ı
 = 
wy
 * 
fÜe
->
w_width
 + 
xs
;

1182 
rm
 = 
m¬kd©a
->
right_m¬
;

1183 
x
 = 
fÜe
->
w_width
, 
wi
 = 
ml
->
image
 + fore->w_width; x >= 0; x--, wi--)

1184 ià(*
wi
 != ' ')

1186 ià(
x
 < 
rm
)

1187 
rm
 = 
x
;

1189 
x
 = 
xs
; x <ğ
xe
; x++, 
ı
++)

1190 ià(
ı
 >ğ
¡a
 && 
x
 >ğ
m¬kd©a
->
Ëá_m¬
)

1192 #ifdeà
DW_CHARS


1193 ià(
	`dw_right
(
ml
, 
x
, 
fÜe
->
w_’codšg
))

1194 
x
--;

1196 ià(
x
 > 
xs
)

1197 
	`LCDi¥ÏyLše
(
æay”
, 
ml
, 
y
, 
xs
, 
x
 - 1, 
isbÏnk
);

1198 ; 
x
 <ğ
xe
; x++, 
ı
++)

1200 ià(
ı
 > 
¡o
 || 
x
 > 
rm
)

1202 #ifdeà
FONT


1203 ià(
·¡efÚt
)

1204 
mch¬_m¬ked
.
fÚt
 = 
ml
->fÚt[
x
];

1206 
mch¬_m¬ked
.
image
 = 
ml
->image[
x
];

1207 #ifdeà
DW_CHARS


1208 
mch¬_m¬ked
.
mbcs
 = 0;

1209 ià(
	`dw_Ëá
(
ml
, 
x
, 
fÜe
->
w_’codšg
))

1211 
mch¬_m¬ked
.
mbcs
 = 
ml
->
image
[
x
 + 1];

1212 
ı
++;

1215 
	`LPutCh¬
(
æay”
, &
mch¬_m¬ked
, 
x
, 
y
);

1216 #ifdeà
DW_CHARS


1217 ià(
	`dw_Ëá
(
ml
, 
x
, 
fÜe
->
w_’codšg
))

1218 
x
++;

1221 ià(
x
 <ğ
xe
)

1222 
	`LCDi¥ÏyLše
(
æay”
, 
ml
, 
y
, 
x
, 
xe
, 
isbÏnk
);

1223 
	}
}

1230 
	$M¬kRewr™e
(
ry
, 
xs
, 
xe
, 
»nd
, 
do™
)

1231 
ry
, 
xs
, 
xe
, 
do™
;

1232 
mch¬
 *
»nd
;

1234 
dx
, 
x
, 
y
, 
¡
, 
’
, 
t
, 
rm
;

1235 *
i
;

1236 
mlše
 *
ml
;

1237 
mch¬
 
mch¬_m¬ked
;

1239 
mch¬_m¬ked
 = 
mch¬_so
;

1241 
	`debug3
("M¬kRewr™%d, %d-%d\n", 
ry
, 
xs
, 
xe
);

1242 
m¬kd©a
 = (m¬kd©¨*)
æay”
->
l_d©a
;

1243 
fÜe
 = 
m¬kd©a
->
md_wšdow
;

1244 
y
 = 
	`D2W
(
ry
);

1245 
ml
 = 
	`WIN
(
y
);

1246 #ifdeà
UTF8


1247 ià(
fÜe
->
w_’codšg
 && fÜe->w_’codšg !ğ
UTF8
 && 
D_’codšg
 =ğUTF8 && 
	`CÚšsS³cŸlDeffÚt
(
ml
, 
xs
, 
xe
, fore->w_encoding))

1248  
EXPENSIVE
;

1250 
dx
 = 
xe
 - 
xs
 + 1;

1251 ià(
do™
)

1253 
i
 = 
ml
->
image
 + 
xs
;

1254 
dx
--)

1255 
	`PUTCHAR
(*
i
++);

1259 ià(
m¬kd©a
->
£cÚd
 == 0)

1260 
¡
 = 
’
 = -1;

1263 
¡
 = 
m¬kd©a
->
y1
 * 
fÜe
->
w_width
 + m¬kd©a->
x1
;

1264 
’
 = 
m¬kd©a
->
cy
 * 
fÜe
->
w_width
 + m¬kd©a->
cx
;

1265 ià(
¡
 > 
’
)

1267 
t
 = 
¡
; sˆğ
’
;ƒn =;

1270 
t
 = 
y
 * 
fÜe
->
w_width
 + 
xs
;

1271 
rm
 = 
fÜe
->
w_width
, 
i
 = 
ml
->
image
 + fore->w_width;„m >= 0;„m--)

1272 ià(*
i
-- != ' ')

1274 ià(
rm
 > 
m¬kd©a
->
right_m¬
)

1275 
rm
 = 
m¬kd©a
->
right_m¬
;

1276 
x
 = 
xs
;

1277 
dx
--)

1279 ià(
t
 >ğ
¡
 && <ğ
’
 && 
x
 >ğ
m¬kd©a
->
Ëá_m¬
 && x <ğ
rm
)

1281 #ifdeà
FONT


1282 ià(
·¡efÚt
)

1283 
mch¬_m¬ked
.
fÚt
 = 
ml
->fÚt[
x
];

1285 
»nd
->
image
 = 
mch¬_m¬ked
.image;

1286 ià(!
	`cmp_mch¬
(
»nd
, &
mch¬_m¬ked
))

1287  
EXPENSIVE
;

1291 
»nd
->
image
 = 
ml
->image[
x
];

1292 ià(!
	`cmp_mch¬_mlše
(
»nd
, 
ml
, 
x
))

1293  
EXPENSIVE
;

1295 
x
++;

1297  
xe
 - 
xs
 + 1;

1298 
	}
}

1304 
	$M¬kSüŞlUpDi¥Ïy
(
n
)

1305 
n
;

1307 
i
;

1309 
	`debug1
("M¬kSüŞlUpDi¥Ïy(%d)\n", 
n
);

1310 ià(
n
 <= 0)

1312 ià(
n
 > 
fÜe
->
w_hi¡height
 - 
m¬kd©a
->
hi¡_off£t
)

1313 
n
 = 
fÜe
->
w_hi¡height
 - 
m¬kd©a
->
hi¡_off£t
;

1314 
m¬kd©a
->
hi¡_off£t
 +ğ
n
;

1315 
i
 = (
n
 < 
æay”
->
l_height
) ?‚ : (flayer->l_height);

1316 
	`LSüŞlV
(
æay”
, 
i
, 0, fÏy”->
l_height
 - 1, 0);

1317 
i
-- > 0)

1318 
	`M¬kRedi¥ÏyLše
(
æay”
->
l_height
 - 
i
 - 1, 0, fÏy”->
l_width
 - 1, 1);

1319  
n
;

1320 
	}
}

1323 
	$M¬kSüŞlDownDi¥Ïy
(
n
)

1324 
n
;

1326 
i
;

1328 
	`debug1
("M¬kSüŞlDownDi¥Ïy(%d)\n", 
n
);

1329 ià(
n
 <= 0)

1331 ià(
n
 > 
m¬kd©a
->
hi¡_off£t
)

1332 
n
 = 
m¬kd©a
->
hi¡_off£t
;

1333 
m¬kd©a
->
hi¡_off£t
 -ğ
n
;

1334 
i
 = (
n
 < 
æay”
->
l_height
) ?‚ : (flayer->l_height);

1335 
	`LSüŞlV
(
æay”
, -
i
, 0, 
fÜe
->
w_height
 - 1, 0);

1336 
i
-- > 0)

1337 
	`M¬kRedi¥ÏyLše
(
i
, 0, 
æay”
->
l_width
 - 1, 1);

1338  
n
;

1339 
	}
}

1342 
	$InM¬k
()

1344 ià(
æay”
 && fÏy”->
l_Ïyâ
 =ğ&
M¬kLf
)

1347 
	}
}

1350 
	$MakePa¡”
(
·
, 
buf
, 
Ën
, 
bufiscİy
)

1351 
·¡”
 *
·
;

1352 *
buf
;

1353 
Ën
;

1354 
bufiscİy
;

1356 
	`F»ePa¡”
(
·
);

1357 
·
->
·_·¡•Œ
 = 
buf
;

1358 
·
->
·_·¡–’
 = 
Ën
;

1359 ià(
bufiscİy
)

1360 
·
->
·_·¡ebuf
 = 
buf
;

1361 
·
->
·_·¡–ay”
 = 
æay”
;

1362 
	`DoProûss
(
	`Lay”2Wšdow
(
æay”
), &
·
->
·_·¡•Œ
, &·->
·_·¡–’
,…a);

1363 
	}
}

1366 
	$F»ePa¡”
(
·
)

1367 
·¡”
 *
·
;

1369 ià(
·
->
·_·¡ebuf
)

1370 
	`ä“
(
·
->
·_·¡ebuf
);

1371 
·
->
·_·¡ebuf
 = 0;

1372 
·
->
·_·¡•Œ
 = 0;

1373 
·
->
·_·¡–’
 = 0;

1374 
·
->
·_·¡–ay”
 = 0;

1375 
	`evdeq
(&
·
->
·_¦owev
);

1376 
	}
}

	@mark.h

25 
	sm¬kd©a


27 
wš
 *
	mmd_wšdow
;

28 
aşu£r
 *
	mmd_u£r
;

29 
	mcx
, 
	mcy
;

30 
	mx1
, 
	my1
;

31 
	m£cÚd
;

32 
	mËá_m¬
, 
	mright_m¬
, 
	mnÚl
;

33 
	m»p_út
;

34 
	m­³nd_mode
;

35 
	mwr™e_bufãr
;

36 
	mhi¡_off£t
;

37 
	mis¡r
[100];

38 
	mis¡¾
;

39 
	misi¡r
[200];

40 
	misi¡¾
;

41 
	misdœ
;

42 
	mis¡¬os
;

43 
	mis¡¬tdœ
;

47 
	#W2D
(
y
è((yè- 
m¬kd©a
->
hi¡_off£t
)

	)

48 
	#D2W
(
y
è((yè+ 
m¬kd©a
->
hi¡_off£t
)

	)

	@misc.c

24 
	~<sys/ty³s.h
>

25 
	~<sys/¡©.h
>

26 
	~<sigÇl.h
>

28 
	~"cÚfig.h
"

29 
	~"sü“n.h
"

30 
	~"ex‹º.h
"

32 #ifdeà
SVR4


33 
	~<sys/»sourû.h
>

36 
Ïy”
 *
æay”
;

38 
eff_uid
, 
»®_uid
;

39 
eff_gid
, 
»®_gid
;

40 
mlše
 
mlše_Şd
;

41 
mch¬
 
mch¬_bÏnk
;

42 *
nuÎ
, *
bÏnk
;

44 #ifdeà
HAVE_FDWALK


45 
şo£_func
 
__P
((*, ));

49 
	$SaveSŒ
(
¡r
)

50 cÚ¡ *
¡r
;

52 *
ı
;

54 ià((
ı
 = 
	`m®loc
(
	`¡¾’
(
¡r
è+ 1)è=ğ
NULL
)

55 
	`Pªic
(0, 
¡ºomem
);

57 
	`¡rıy
(
ı
, 
¡r
);

58  
ı
;

59 
	}
}

62 
	$SaveSŒn
(
¡r
, 
n
)

63 cÚ¡ *
¡r
;

64 
n
;

66 *
ı
;

68 ià((
ı
 = 
	`m®loc
(
n
 + 1)è=ğ
NULL
)

69 
	`Pªic
(0, 
¡ºomem
);

72 
	`bcİy
((*)
¡r
, 
ı
, 
n
);

73 
ı
[
n
] = 0;

75  
ı
;

76 
	}
}

80 
	$InSŒ
(
¡r
, 
·t
)

81 *
¡r
;

82 cÚ¡ *
·t
;

84 
Å©
 = 
	`¡¾’
(
·t
);

85 ;*
¡r
; str++)

86 ià(!
	`¡ºcmp
(
¡r
, 
·t
, 
Å©
))

87  
¡r
;

89 
	}
}

91 #iâdeà
HAVE_STRERROR


93 
	$¡»¼Ü
(
”r
)

94 
”r
;

96 
sys_Ã¼
;

97 *
sys_”¾i¡
[];

99 
”
[20];

100 ià(
”r
 > 0 &&ƒ¼ < 
sys_Ã¼
)

101  
sys_”¾i¡
[
”r
];

102 
	`¥rštf
(
”
, "E¼Ü %d", 
”r
);

103  
”
;

104 
	}
}

108 
	$ûÁ”lše
(
¡r
, 
y
)

109 *
¡r
;

110 
y
;

112 
l
, 
n
;

114 
	`ASSERT
(
æay”
);

115 
n
 = 
	`¡¾’
(
¡r
);

116 ià(
n
 > 
æay”
->
l_width
 - 1)

117 
n
 = 
æay”
->
l_width
 - 1;

118 
l
 = (
æay”
->
l_width
 - 1 - 
n
) / 2;

119 
	`LPutSŒ
(
æay”
, 
¡r
, 
n
, &
mch¬_bÏnk
, 
l
, 
y
);

120 
	}
}

123 
	$Ëálše
(
¡r
, 
y
)

124 *
¡r
;

125 
y
;

127 
l
, 
n
;

128 
mch¬
 
mch¬_dŞ
;

130 
mch¬_dŞ
 = 
mch¬_bÏnk
;

131 
mch¬_dŞ
.
image
 = '$';

133 
	`ASSERT
(
æay”
);

134 
l
 = 
n
 = 
	`¡¾’
(
¡r
);

135 ià(
n
 > 
æay”
->
l_width
 - 1)

136 
n
 = 
æay”
->
l_width
 - 1;

137 
	`LPutSŒ
(
æay”
, 
¡r
, 
n
, &
mch¬_bÏnk
, 0, 
y
);

138 ià(
n
 !ğ
l
)

139 
	`LPutCh¬
(
æay”
, &
mch¬_dŞ
, 
n
, 
y
);

140 
	}
}

144 
	$F’ame
(
s
)

145 *
s
;

147 *
p
 = 
s
;

149 ià(
p
)

150 *
p
)

151 ià(*
p
++ == '/')

152 
s
 = 
p
;

153  
s
;

154 
	}
}

157 
	$¡rdev
(
Çm
)

158 *
Çm
;

160 #ifdeà
­Şlo


161 *
p
;

163 ià(
Çm
 =ğ
NULL
)

164  
NULL
;

165 #ifdeà
SVR4


167 ià(!
	`¡ºcmp
(
Çm
, "/dev/pts", 8) &&‚am[8] >= '0' &&‚am[8] <= '9')

169 
b
[13];

170 
	`¥rštf
(
b
, "±s/%d", 
	`©oi
(
Çm
 + 8));

171  
b
;

174 ià(
p
 = 
	`¡r¡r
(
Çm
,"/dev/"))

175  
p
 + 5;

177 ià(
Çm
 =ğ
NULL
)

178  
NULL
;

179 ià(
	`¡ºcmp
(
Çm
, "/dev/", 5) == 0)

180  
Çm
 + 5;

182  
Çm
;

183 
	}
}

190 #ifdeà
POSIX


191 
sig»t_t
 (*
	$xsigÇl
(
sig
, 
func
))

192 #iâdeà
__APPLE__


193 
	$__P
(
SIGPROTOARG
)

197 
sig
;

198 
	$sig»t_t
 (*
func
è
	`__P
(
SIGPROTOARG
);

200 
sigaùiÚ
 
o§
, 
§
;

201 
§
.
§_hªdËr
 = 
func
;

202 ()
	`sigem±y£t
(&
§
.
§_mask
);

203 #ifdeà
SA_RESTART


204 
§
.
§_æags
 = (
sig
 =ğ
SIGCHLD
 ? 
SA_RESTART
 : 0);

206 
§
.
§_æags
 = 0;

208 ià(
	`sigaùiÚ
(
sig
, &
§
, &
o§
))

209  (
	`sig»t_t
 (*)
	`__P
(
SIGPROTOARG
))-1;

210  
o§
.
§_hªdËr
;

211 
	}
}

214 #ifdeà
hpux


219 (*
	$xsigÇl
(
sig
, 
func
)è
	$__P
(
SIGPROTOARG
)

220 
sig
;

221 (*
func
è
	`__P
(
SIGPROTOARG
);

223 
sigvec
 
osv
, 
sv
;

225 
sv
.
sv_hªdËr
 = 
func
;

226 
sv
.
sv_mask
 = 
	`sigmask
(
sig
);

227 
sv
.
sv_æags
 = 
SV_BSDSIG
;

228 ià(
	`sigveùÜ
(
sig
, &
sv
, &
osv
) < 0)

229  ((*)
	`__P
(
SIGPROTOARG
))(
BADSIG
);

230  
osv
.
sv_hªdËr
;

231 
	}
}

240 #ifdeà
HAVE_SETEUID


243 
	$x£‹uid
(
euid
)

244 
euid
;

246 ià(
	`£‹uid
(
euid
) == 0)

248 
	`£‹uid
(0);

249 ià(
	`£‹uid
(
euid
))

250 
	`Pªic
(
”ºo
, "seteuid");

251 
	}
}

254 
	$x£‹gid
(
egid
)

255 
egid
;

257 ià(
	`£‹gid
(
egid
))

258 
	`Pªic
(
”ºo
, "setegid");

259 
	}
}

262 #ifdeà
HAVE_SETREUID


265 
	$x£‹uid
(
euid
)

266 
euid
;

268 
Ûuid
;

270 
Ûuid
 = 
	`g‘euid
();

271 ià(
Ûuid
 =ğ
euid
)

273 ià(()
	`g‘uid
(è!ğ
euid
)

274 
Ûuid
 = 
	`g‘uid
();

275 ià(
	`£Œeuid
(
Ûuid
, 
euid
))

276 
	`Pªic
(
”ºo
, "setreuid");

277 
	}
}

280 
	$x£‹gid
(
egid
)

281 
egid
;

283 
Ûgid
;

285 
Ûgid
 = 
	`g‘egid
();

286 ià(
Ûgid
 =ğ
egid
)

288 ià(()
	`g‘gid
(è!ğ
egid
)

289 
Ûgid
 = 
	`g‘gid
();

290 ià(
	`£Œegid
(
Ûgid
, 
egid
))

291 
	`Pªic
(
”ºo
, "setregid");

292 
	}
}

299 #ifdeà
NEED_OWN_BCOPY


301 
	$xbcİy
(
s1
, 
s2
, 
Ën
)

302 *
s1
, *
s2
;

303 
Ën
;

305 ià(
s1
 < 
s2
 && s2 < s1 + 
Ën
)

307 
s1
 +ğ
Ën
;

308 
s2
 +ğ
Ën
;

309 
Ën
-- > 0)

310 *--
s2
 = *--
s1
;

313 
Ën
-- > 0)

314 *
s2
++ = *
s1
++;

315 
	}
}

319 
	$bş—r
(
p
, 
n
)

320 *
p
;

321 
n
;

323 
	`bcİy
((*)
bÏnk
, 
p
, 
n
);

324 
	}
}

328 
	$Kl
(
pid
, 
sig
)

329 
pid
, 
sig
;

331 ià(
pid
 < 2)

333 (è
	`kl
(
pid
, 
sig
);

334 
	}
}

336 #ifdeà
HAVE_FDWALK


343 
	$şo£_func
(
cb_d©a
, 
fd
)

344 *
cb_d©a
;

345 
fd
;

347 
exû±
 = *(*)
cb_d©a
;

348 ià(
fd
 > 2 && fd !ğ
exû±
)

349 ()
	`şo£
(
fd
);

351 
	}
}

354 
	$şo£®lfes
(
exû±
)

355 
exû±
;

357 ()
	`fdw®k
(
şo£_func
, &
exû±
);

358 
	}
}

363 
	$şo£®lfes
(
exû±
)

364 
exû±
;

366 
f
;

367 #ifdeà
SVR4


368 
¾im™
 
¾
;

370 ià((
	`g‘¾im™
(
RLIMIT_NOFILE
, &
¾
è=ğ0è&&„l.
¾im_max
 !ğ
RLIM_INFINITY
)

371 
f
 = 
¾
.
¾im_max
;

374 #ià
	`defšed
(
SYSV
è&& defšed(
NOFILE
è&& !defšed(
ISC
)

375 
f
 = 
NOFILE
;

377 
f
 = 
	`g‘dbËsize
();

379 --
f
 > 2)

380 ià(
f
 !ğ
exû±
)

381 
	`şo£
(
f
);

382 
	}
}

391 #iâdeà
USE_SETEUID


392 
	gU£rPID
;

393 
	$sig»t_t
 (*
U£rsigşd
)
	`__P
(
SIGPROTOARG
);

395 
U£rSTAT
;

398 
	$U£rCÚ‹xt
()

400 #iâdeà
USE_SETEUID


401 ià(
eff_uid
 =ğ
»®_uid
 && 
eff_gid
 =ğ
»®_gid
)

403 
U£rsigşd
 = 
	`sigÇl
(
SIGCHLD
, 
SIG_DFL
);

404 
	`debug
("UserContext: forking.\n");

405 
U£rPID
 = 
	`fÜk
())

408 
	`Msg
(
”ºo
, "fork");

411 
	`sigÇl
(
SIGHUP
, 
SIG_DFL
);

412 
	`sigÇl
(
SIGINT
, 
SIG_IGN
);

413 
	`sigÇl
(
SIGQUIT
, 
SIG_DFL
);

414 
	`sigÇl
(
SIGTERM
, 
SIG_DFL
);

415 #ifdeà
BSDJOBS


416 
	`sigÇl
(
SIGTTIN
, 
SIG_DFL
);

417 
	`sigÇl
(
SIGTTOU
, 
SIG_DFL
);

419 
	`£tuid
(
»®_uid
);

420 
	`£tgid
(
»®_gid
);

426 
	`x£‹uid
(
»®_uid
);

427 
	`x£‹gid
(
»®_gid
);

430 
	}
}

433 
	$U£rR‘uº
(
v®
)

434 
v®
;

436 #iâdeà
USE_SETEUID


437 ià(
eff_uid
 =ğ
»®_uid
 && 
eff_gid
 =ğ
»®_gid
)

438 
U£rSTAT
 = 
v®
;

440 
	`_ex™
(
v®
);

442 
	`x£‹uid
(
eff_uid
);

443 
	`x£‹gid
(
eff_gid
);

444 
U£rSTAT
 = 
v®
;

446 
	}
}

449 
	$U£rStus
()

451 #iâdeà
USE_SETEUID


452 
i
;

453 #ifdeà
BSDWAIT


454 
wa™
 
w¡©
;

456 
w¡©
;

459 ià(
eff_uid
 =ğ
»®_uid
 && 
eff_gid
 =ğ
»®_gid
)

460  
U£rSTAT
;

461 ià(
U£rPID
 < 0)

463 (
”ºo
 = 0, 
i
 = 
	`wa™
(&
w¡©
)è!ğ
U£rPID
)

464 ià(
i
 < 0 && 
”ºo
 !ğ
EINTR
)

466 (è
	`sigÇl
(
SIGCHLD
, 
U£rsigşd
);

467 ià(
i
 == -1)

469  
	`WEXITSTATUS
(
w¡©
);

471  
U£rSTAT
;

473 
	}
}

475 #iâdeà
HAVE_RENAME


477 
	$»Çme
 (
Şd
, 
Ãw
)

478 *
Şd
;

479 *
Ãw
;

481 ià(
	`lšk
(
Şd
, 
Ãw
) < 0)

483  
	`uÆšk
(
Şd
);

484 
	}
}

489 
	$AddXCh¬
(
buf
, 
ch
)

490 *
buf
;

491 
ch
;

493 *
p
 = 
buf
;

495 ià(
ch
 < ' ' || ch == 0x7f)

497 *
p
++ = '^';

498 *
p
++ = 
ch
 ^ 0x40;

500 ià(
ch
 >= 0x80)

502 *
p
++ = '\\';

503 *
p
++ = (
ch
 >> 6 & 7) + '0';

504 *
p
++ = (
ch
 >> 3 & 7) + '0';

505 *
p
++ = (
ch
 >> 0 & 7) + '0';

508 *
p
++ = 
ch
;

509  
p
 - 
buf
;

510 
	}
}

513 
	$AddXCh¬s
(
buf
, 
Ën
, 
¡r
)

514 *
buf
, *
¡r
;

515 
Ën
;

517 *
p
;

519 ià(
¡r
 == 0)

521 *
buf
 = 0;

524 
Ën
 -= 4;

525 
p
 = 
buf
;… < buà+ 
Ën
 && *
¡r
; str++)

527 ià(*
¡r
 == ' ')

528 *
p
++ = *
¡r
;

530 
p
 +ğ
	`AddXCh¬
Õ, *
¡r
);

532 *
p
 = 0;

533  
p
 - 
buf
;

534 
	}
}

537 #ifdeà
DEBUG


539 
	$İ’debug
(
Ãw
, 
shout
)

540 
Ãw
, 
shout
;

542 
buf
[256];

544 #ifdeà
_MODE_T


545 
mode_t
 
oumask
 = 
	`umask
(0);

547 
oumask
 = 
	`umask
(0);

550 
	`ASSERT
(!
då
);

552 (è
	`mkdœ
(
DEBUGDIR
, 0777);

553 
	`¥rštf
(
buf
, 
shout
 ? "%s/SCREEN.%d" : "%s/sü“n.%d", 
DEBUGDIR
, 
	`g‘pid
());

554 ià(!(
då
 = 
	`fİ’
(
buf
, 
Ãw
 ? "w" : "a")))

555 
då
 = 
¡d”r
;

557 ()
	`chmod
(
buf
, 0666);

559 ()
	`umask
(
oumask
);

560 
	`debug
("opendebug: done.\n");

561 
	}
}

565 
	$¦“p1000
(
m£c
)

566 
m£c
;

569 
timev®
 
t
;

571 
t
.
tv_£c
 = (è(
m£c
 / 1000);

572 
t
.
tv_u£c
 = (è((
m£c
 % 1000) * 1000);

573 
	`£Ëù
(0, (
fd_£t
 *)0, (fd_£ˆ*)0, (fd_£ˆ*)0, &
t
);

574 
	}
}

582 
	$x£‹nv
(
v¬
, 
v®ue
)

583 *
v¬
;

584 *
v®ue
;

586 #iâdeà
USESETENV


587 *
buf
;

588 
l
;

590 ià((
buf
 = (*)
	`m®loc
((
l
 = 
	`¡¾’
(
v¬
)) +

591 
	`¡¾’
(
v®ue
è+ 2)è=ğ
NULL
)

593 
	`Msg
(0, 
¡ºomem
);

596 
	`¡rıy
(
buf
, 
v¬
);

597 
buf
[
l
] = '=';

598 
	`¡rıy
(
buf
 + 
l
 + 1, 
v®ue
);

599 
	`pu‹nv
(
buf
);

600 #ifdeà
NEEDPUTENV


605 
	`ä“
(
buf
);

616 #ià
	`defšed
(
lšux
è|| defšed(
__cÚvex__
è|| (
BSD
 >= 199103)

617 
	`£‹nv
(
v¬
, 
v®ue
, 1);

619 
	`£‹nv
(
v¬
, 
v®ue
);

622 
	}
}

624 #ifdeà
TERMINFO


630 
	$_d–ay
(
d–ay
, 
outc
)

631 
d–ay
;

632 (*
outc
è
	`__P
(());

634 
·d
;

635 
o¥“d
;

636 
o¥2·d
[] = {

640 ià(
o¥“d
 <ğ0 || o¥“d >ğ()((
o¥2·d
)/(*osp2pad)))

642 
·d
 =
o¥2·d
[
o¥“d
];

643 
d–ay
 = (d–ay + 
·d
 / 2) /…ad;

644 
d–ay
-- > 0)

645 (*
outc
)(0);

647 
	}
}

649 #ifdeà
lšux


657 (*
§ve_outc
è
	`__P
(());

659 #undeà
uts


662 
	$xuts
(
¡r
, 
affút
, 
outc
)

663 *
¡r
;

664 
affút
;

665 (*
outc
è
	`__P
(());

667 
uts
 
	`__P
((const *, , (*)()));

668 
§ve_outc
 = 
outc
;

669 
	`uts
(
¡r
, 
affút
, 
outc
);

670 
	}
}

673 
	$_nc_timed_wa™
(
mode
, 
ms
, 
p
)

674 
mode
, 
ms
, *
p
;

676 
	`_d–ay
(
ms
 * 10, 
§ve_outc
);

678 
	}
}

686 #iâdeà
USEVARARGS


688 
	#xva_¬g
(
s
, 
t
, 
Š
è(*Ñ *)( +ğ
	`x¢off
Ñn, 0, 0), s - x¢offÑn, 0, 0)))

	)

689 
	#xva_li¡
 *

	)

692 
	$x¢off
(
a
, 
b
, 
c
)

693 
a
;

694 *
b
;

695 
c
;

697  
a
 ? (*)&
c
 - (*)&
b
 : (*)&b - (*)&a;

698 
	}
}

701 
	$x¢´štf
(
s
, 
n
, 
fmt
, 
p1
, 
p2
, 
p3
, 
p4
, 
p5
, 
p6
)

702 *
s
;

703 
n
;

704 *
fmt
;

705 
p1
, 
p2
, 
p3
, 
p4
, 
p5
, 
p6
;

707 
xv¢´štf
 
	`__P
((*, , *, 
xva_li¡
));

708  
	`xv¢´štf
(
s
, 
n
, 
fmt
, (*)&fmˆ+ 
	`x¢off
(1, 0, 0));

709 
	}
}

713 
	#xva_¬g
(
s
, 
t
, 
Š
è
	`va_¬g
(s,)

	)

714 
	#xva_li¡
 
va_li¡


	)

719 #ià!
defšed
(
USEVARARGS
è|| !defšed(
HAVE_VSNPRINTF
)

722 
	$xv¢´štf
(
s
, 
n
, 
fmt
, 
¡ack
)

723 *
s
;

724 
n
;

725 *
fmt
;

726 
xva_li¡
 
¡ack
;

728 *
f
, *
sf
 = 0;

729 
i
, 
Ú
, 
¬gl
 = 0;

730 
myf
[10], 
buf
[20];

731 *
¬g
, *
myå
;

733 
Ú
 = 
n
;

734 
f
 = 
fmt
;

735 
¬g
 = 0;

736 
¬g
 || (
sf
 = 
	`šdex
(
f
, '%')è|| (sàğà+ 
	`¡¾’
(f)))

738 ià(
¬g
 == 0)

740 
¬g
 = 
f
;

741 
¬gl
 = 
sf
 - 
f
;

743 ià(
¬gl
)

745 
i
 = 
¬gl
 > 
n
 - 1 ?‚ - 1 :‡rgl;

746 
	`¡ºıy
(
s
, 
¬g
, 
i
);

747 
s
 +ğ
i
;

748 
n
 -ğ
i
;

749 ià(
i
 < 
¬gl
)

751 *
s
 = 0;

752  
Ú
;

755 
¬g
 = 0;

756 ià(
sf
 == 0)

758 
f
 = 
sf
;

759 
sf
 = 0;

760 ià(!*
f
)

762 
myå
 = 
myf
;

763 *
myå
++ = *
f
++;

764 ((*
f
 >ğ'0' && *à<='9'è|| *à=ğ'#'è&& 
myå
 - 
myf
 < 8)

765 *
myå
++ = *
f
++;

766 *
myå
++ = *
f
;

767 *
myå
 = 0;

768 ià(!*
f
++)

770 
f
[-1])

773 
¬g
 = "%";

779 
i
 = 
	`xva_¬g
(
¡ack
, , 0);

780 
	`¥rštf
(
buf
, 
myf
, 
i
);

781 
¬g
 = 
buf
;

784 
¬g
 = 
	`xva_¬g
(
¡ack
, *, 1);

785 ià(
¬g
 == 0)

786 
¬g
 = "NULL";

789 
¬g
 = "";

792 
¬gl
 = 
	`¡¾’
(
¬g
);

794 *
s
 = 0;

795  
Ú
 - 
n
;

796 
	}
}

	@nethack.c

24 
	~"cÚfig.h
"

25 
	~"sü“n.h
"

27 #ifdeà
NETHACK


28 
Ãthackæag
;

31 
	sÆ¡¿ns
 {

32 *
	mäom
;

33 *
	mto
;

36 #ifdeà
NETHACK


37 
Æ¡¿ns
 
	gÃthackŒªs
[] = {

119 
	$DoNLS
(
äom
)

120 *
äom
;

122 #ifdeà
NETHACK


123 
Æ¡¿ns
 *
t
;

125 ià(
Ãthackæag
)

127 
t
 = 
ÃthackŒªs
;->
äom
;++)

128 ià(
	`¡rcmp
(
äom
, 
t
->from) == 0)

129  
t
->
to
;

132  
äom
;

133 
	}
}

	@os.h

25 
	~<¡dio.h
>

26 
	~<”ºo.h
>

28 
	~<sys/·¿m.h
>

31 #ià
defšed
(
__hpux
è&& !defšed(
hpux
)

32 
	#hpux


	)

35 #ià
defšed
(
__bsdi__
è|| defšed(
__386BSD__
è|| defšed(
_CX_UX
è|| defšed(
hpux
è|| defšed(
_IBMR2
è|| defšed(
lšux
)

36 
	~<sigÇl.h
>

39 #ifdeà
ISC


40 #ifdeà
ENAMETOOLONG


41 #undeà
ENAMETOOLONG


43 #ifdeà
ENOTEMPTY


44 #undeà
ENOTEMPTY


46 
	~<sys/bsdty³s.h
>

47 
	~<Ãt/”ºo.h
>

50 #ifdeà
sun


51 
	#g‘pg½
 
__g‘pg½


	)

52 
	#ex™
 
__ex™


	)

54 #ifdeà
POSIX


55 
	~<uni¡d.h
>

56 #ià
defšed
(
__STDC__
)

57 
	~<¡dlib.h
>

60 #ifdeà
sun


61 #undeà
g‘pg½


62 #undeà
ex™


65 #iâdeà
lšux


66 
”ºo
;

68 #iâdeà
HAVE_STRERROR


70 #undeà
¡»¼Ü


73 #ià!
defšed
(
SYSV
è&& !defšed(
lšux
)

74 #ifdeà
NEWSOS


75 
	#¡¾’
 
___¡¾’___


	)

76 
	~<¡ršgs.h
>

77 #undeà
¡¾’


79 
	~<¡ršgs.h
>

82 #ià
defšed
(
SVR4
è|| defšed(
NEWSOS
)

83 
	#¡¾’
 
___¡¾’___


	)

84 
	~<¡ršg.h
>

85 #undeà
¡¾’


86 #ià!
defšed
(
NEWSOS
è&& !defšed(
__hpux
)

87 
size_t
 
¡¾’
(const *);

90 
	~<¡ršg.h
>

94 #ifdeà
USEVARARGS


95 #ià
defšed
(
__STDC__
)

96 
	~<¡d¬g.h
>

97 
	#VA_LIST
(
v¬
è
va_li¡
 v¬;

	)

98 
	#VA_DOTS
 ...

	)

99 
	#VA_DECL


	)

100 
	#VA_START
(
­
, 
fmt
è
	`va_¡¬t
×p, fmt)

	)

101 
	#VA_ARGS
(
­
è
	)
­

102 
	#VA_END
(
­
è
	`va_’d
×p)

	)

104 
	~<v¬¬gs.h
>

105 
	#VA_LIST
(
v¬
è
va_li¡
 v¬;

	)

106 
	#VA_DOTS
 
va_®i¡


	)

107 
	#VA_DECL
 
va_dş


	)

108 
	#VA_START
(
­
, 
fmt
è
	`va_¡¬t
×p)

	)

109 
	#VA_ARGS
(
­
è
	)
­

110 
	#VA_END
(
­
è
	`va_’d
×p)

	)

113 
	#VA_LIST
(
v¬
)

	)

114 
	#VA_DOTS
 
p1
, 
p2
, 
p3
, 
p4
, 
p5
, 
p6


	)

115 
	#VA_DECL
 
VA_DOTS
;

	)

116 
	#VA_START
(
­
, 
fmt
)

	)

117 
	#VA_ARGS
(
­
è
VA_DOTS


	)

118 
	#VA_END
(
­
)

	)

119 #undeà
v¢´štf


120 
	#v¢´štf
 
x¢´štf


	)

123 #ià!
defšed
(
sun
è&& !defšed(
B43
è&& !defšed(
ISC
è&& !defšed(
pyr
è&& !defšed(
_CX_UX
)

124 
	~<time.h
>

126 
	~<sys/time.h
>

128 #ifdeà
M_UNIX


129 
	~<sys/¡»am.h
>

130 
	~<sys/±em.h
>

131 
	#árunÿ‹
(
fd
, 
s
è
	`chsize
(fd, s)

	)

134 #ifdeà
SYSV


135 
	#šdex
 
¡rchr


	)

136 
	#ršdex
 
¡¼chr


	)

137 
	#bz”o
(
poi
,
Ën
è
	`mem£t
Õoi,0,Ën)

	)

138 
	#bcmp
 
memcmp


	)

139 
	#kÍg
(
pg½
,
sig
è
	`kl
Ğ-Õg½), sig)

	)

142 #iâdeà
HAVE_GETCWD


143 
	#g‘cwd
(
b
,
l
è
	`g‘wd
(b)

	)

146 #iâdeà
USEBCOPY


147 #ifdeà
USEMEMMOVE


148 
	#bcİy
(
s
,
d
,
Ën
è
	`memmove
(d,s,Ën)

	)

150 #ifdeà
USEMEMCPY


151 
	#bcİy
(
s
,
d
,
Ën
è
	`memıy
(d,s,Ën)

	)

153 
	#NEED_OWN_BCOPY


	)

154 
	#bcİy
 
xbcİy


	)

159 #ifdeà
hpux


160 
	#£Œeuid
(
ruid
, 
euid
è
	`£Œesuid
Ôuid,ƒuid, -1)

	)

161 
	#£Œegid
(
rgid
, 
egid
è
	`£Œesgid
Ôgid,ƒgid, -1)

	)

164 #ià
defšed
(
HAVE_SETEUID
è|| defšed(
HAVE_SETREUID
)

165 
	#USE_SETEUID


	)

168 #ià!
defšed
(
HAVE__EXIT
è&& !defšed(
_ex™
)

169 
	#_ex™
(
x
è
	`ex™
(x)

	)

172 #iâdeà
HAVE_UTIMES


173 
	#utimes
 
utime


	)

175 #iâdeà
HAVE_VSNPRINTF


176 
	#v¢´štf
 
xv¢´štf


	)

179 #ifdeà
BUILTIN_TELNET


180 
	~<Ãtš‘/š.h
>

181 
	~<¬·/š‘.h
>

184 #ià
defšed
(
USE_LOCALE
è&& (!defšed(
HAVE_SETLOCALE
è|| !defšed(
HAVE_STRFTIME
))

185 #undeà
USE_LOCALE


192 #ifdeà
POSIX


193 
	~<‹rmios.h
>

194 #ifdeà
hpux


195 
	~<bsd‰y.h
>

197 #ifdeà
NCCS


198 
	#MAXCC
 
NCCS


	)

200 
	#MAXCC
 256

	)

203 #ifdeà
TERMIO


204 
	~<‹rmio.h
>

205 #ifdeà
NCC


206 
	#MAXCC
 
NCC


	)

208 
	#MAXCC
 256

	)

210 #ifdeà
CYTERMIO


211 
	~<cy‹rmio.h
>

214 
	~<sg‰y.h
>

218 #iâdeà
VDISABLE


219 #ifdeà
_POSIX_VDISABLE


220 
	#VDISABLE
 
_POSIX_VDISABLE


	)

222 
	#VDISABLE
 0377

	)

238 #ià
defšed
(
sgi
è|| defšed(
DGUX
è|| defšed(
_IBMR2
)

239 #undeà
TIOCPKT


243 #ià
defšed
(
lšux
è&& defšed(
TERMINFO
)

244 
	#uts
 
xuts


	)

248 #ifdeà
__osf__


249 #undeà
HAVE_SVR4_PTYS


256 #ifdeà
GETUTENT


257 *
	t¦Ù_t
;

259 
	t¦Ù_t
;

262 #ià
defšed
(
UTMPOK
è|| defšed(
BUGGYGETLOGIN
)

263 #ià
defšed
(
SVR4
è&& !defšed(
DGUX
è&& !defšed(
__hpux
è&& !defšed(
lšux
)

264 
	~<utmpx.h
>

265 
	#UTMPFILE
 
UTMPX_FILE


	)

266 
	#utmp
 
utmpx


	)

267 
	#g‘u‹Á
 
g‘utx’t


	)

268 
	#g‘utid
 
g‘utxid


	)

269 
	#g‘uše
 
g‘utxlše


	)

270 
	#putuše
 
pututxlše


	)

271 
	#£tu‹Á
 
£tutx’t


	)

272 
	#’du‹Á
 
’dutx’t


	)

273 
	#ut_time
 
ut_xtime


	)

275 
	~<utmp.h
>

277 #ifdeà
­Şlo


284 
	#UTNOKEEP


	)

287 #iâdeà
UTMPFILE


288 #ifdeà
UTMP_FILE


289 
	#UTMPFILE
 
UTMP_FILE


	)

291 #ifdeà
_PATH_UTMP


292 
	#UTMPFILE
 
_PATH_UTMP


	)

294 
	#UTMPFILE
 "/‘c/utmp"

	)

301 #ià!
defšed
(
UTMPOK
è&& defšed(
USRLIMIT
)

302 #undeà
USRLIMIT


305 #ifdeà
LOGOUTOK


306 #iâdeà
LOGINDEFAULT


307 
	#LOGINDEFAULT
 0

	)

310 #ifdeà
LOGINDEFAULT


311 #undeà
LOGINDEFAULT


313 
	#LOGINDEFAULT
 1

	)

321 #iâdeà
F_OK


322 
	#F_OK
 0

	)

324 #iâdeà
X_OK


325 
	#X_OK
 1

	)

327 #iâdeà
W_OK


328 
	#W_OK
 2

	)

330 #iâdeà
R_OK


331 
	#R_OK
 4

	)

334 #iâdeà
S_IFIFO


335 
	#S_IFIFO
 0010000

	)

337 #iâdeà
S_IREAD


338 
	#S_IREAD
 0000400

	)

340 #iâdeà
S_IWRITE


341 
	#S_IWRITE
 0000200

	)

343 #iâdeà
S_IEXEC


344 
	#S_IEXEC
 0000100

	)

347 #ià
defšed
(
S_IFIFO
è&& defšed(
S_IFMT
è&& !defšed(
S_ISFIFO
)

348 
	#S_ISFIFO
(
mode
è(((modeè& 
S_IFMT
è=ğ
S_IFIFO
)

	)

350 #ià
defšed
(
S_IFSOCK
è&& defšed(
S_IFMT
è&& !defšed(
S_ISSOCK
)

351 
	#S_ISSOCK
(
mode
è(((modeè& 
S_IFMT
è=ğ
S_IFSOCK
)

	)

353 #ià
defšed
(
S_IFCHR
è&& defšed(
S_IFMT
è&& !defšed(
S_ISCHR
)

354 
	#S_ISCHR
(
mode
è(((modeè& 
S_IFMT
è=ğ
S_IFCHR
)

	)

356 #ià
defšed
(
S_IFDIR
è&& defšed(
S_IFMT
è&& !defšed(
S_ISDIR
)

357 
	#S_ISDIR
(
mode
è(((modeè& 
S_IFMT
è=ğ
S_IFDIR
)

	)

359 #ià
defšed
(
S_IFLNK
è&& defšed(
S_IFMT
è&& !defšed(
S_ISLNK
)

360 
	#S_ISLNK
(
mode
è(((modeè& 
S_IFMT
è=ğ
S_IFLNK
)

	)

374 #ià
defšed
(
sun
è&& !defšed(
SVR4
)

375 #undeà
O_NONBLOCK


378 #ià!
defšed
(
O_NONBLOCK
è&& defšed(
O_NDELAY
)

379 
	#O_NONBLOCK
 
O_NDELAY


	)

382 #ià!
defšed
(
FNBLOCK
è&& defšed(
FNONBLOCK
)

383 
	#FNBLOCK
 
FNONBLOCK


	)

385 #ià!
defšed
(
FNBLOCK
è&& defšed(
FNDELAY
)

386 
	#FNBLOCK
 
FNDELAY


	)

388 #ià!
defšed
(
FNBLOCK
è&& defšed(
O_NONBLOCK
)

389 
	#FNBLOCK
 
O_NONBLOCK


	)

392 #iâdeà
POSIX


393 #undeà
mkfifo


394 
	#mkfifo
(
n
,
m
è
	`mknod
Ò,
S_IFIFO
|(m),0)

	)

397 #ià!
defšed
(
HAVE_LSTAT
è&& !defšed(
l¡©
)

398 
	#l¡©
 
¡©


	)

405 #ifdeà
SIGVOID


406 
	#SIGRETURN


	)

407 
	#sig»t_t
 

	)

409 
	#SIGRETURN
  0;

	)

410 
	#sig»t_t
 

	)

414 #ià
defšed
(
SVR4
è|| (defšed(
SYSV
è&& defšed(
ISC
)è|| defšed(
_AIX
è|| defšed(
lšux
è|| defšed(
uÉrix
è|| defšed(
__386BSD__
è|| defšed(
__bsdi__
è|| defšed(
POSIX
è|| defšed(
NeXT
)

415 
	#SIGHASARG


	)

418 #ifdeà
SIGHASARG


419 
	#SIGPROTOARG
 ()

	)

420 
	#SIGDEFARG
 (
sigsig
èsigsig;

	)

421 
	#SIGARG
 0

	)

423 
	#SIGPROTOARG
 ()

	)

424 
	#SIGDEFARG
 ()

	)

425 
	#SIGARG


	)

428 #iâdeà
SIGCHLD


429 
	#SIGCHLD
 
SIGCLD


	)

432 #ià
defšed
(
POSIX
è|| defšed(
hpux
)

433 
	#sigÇl
 
xsigÇl


	)

435 #ifdeà
USESIGSET


436 
	#sigÇl
 
sig£t


	)

441 #iâdeà
NSIG


442 
	#NSIG
 32

	)

450 #ià(!
defšed
(
sysV68
è&& !defšed(
M_XENIX
)è|| defšed(
NeXT
è|| defšed(
M_UNIX
)

451 
	~<sys/wa™.h
>

454 #iâdeà
WTERMSIG


455 #iâdeà
BSDWAIT


456 
	#WTERMSIG
(
¡©us
è(¡©u & 0177)

	)

458 
	#WTERMSIG
(
¡©us
è¡©us.
w_T
.
w_T”msig


	)

462 #iâdeà
WSTOPSIG


463 #iâdeà
BSDWAIT


464 
	#WSTOPSIG
(
¡©us
è((¡©u >> 8è& 0377)

	)

466 
	#WSTOPSIG
(
¡©us
è¡©us.
w_S
.
w_Stİsig


	)

471 #ià
defšed
(
WCOREDUMP
è&& !defšed(
WIFCORESIG
)

472 
	#WIFCORESIG
(
¡©us
è
	`WCOREDUMP
(¡©us)

	)

475 #iâdeà
WIFCORESIG


476 #iâdeà
BSDWAIT


477 
	#WIFCORESIG
(
¡©us
è(¡©u & 0200)

	)

479 
	#WIFCORESIG
(
¡©us
è¡©us.
w_T
.
w_CÜedump


	)

483 #iâdeà
WEXITSTATUS


484 #iâdeà
BSDWAIT


485 
	#WEXITSTATUS
(
¡©us
è((¡©u >> 8è& 0377)

	)

487 
	#WEXITSTATUS
(
¡©us
è¡©us.
w_T
.
w_R‘code


	)

496 #ià
defšed
(
M_XENIX
è|| defšed(
M_UNIX
è|| defšed(
_SEQUENT_
)

497 
	~<sys/£Ëù.h
>

504 #iâdeà
FD_SET


505 #iâdeà
SUNOS3


506 
	sfd_£t
 { 
	mfds_b™s
[1]; } 
	tfd_£t
;

508 
	#FD_ZERO
(
fd
è((fd)->
fds_b™s
[0] = 0)

	)

509 
	#FD_SET
(
b
, 
fd
è((fd)->
fds_b™s
[0] |ğ1 << (b))

	)

510 
	#FD_ISSET
(
b
, 
fd
è((fd)->
fds_b™s
[0] & 1 << (b))

	)

511 
	#FD_SETSIZE
 32

	)

519 #iâdeà
TERMCAP_BUFSIZE


520 
	#TERMCAP_BUFSIZE
 2048

	)

523 #iâdeà
MAXPATHLEN


524 
	#MAXPATHLEN
 1024

	)

532 
	#IOSIZE
 4096

	)

	@patchlevel.h

527 
	#ORIGIN
 "FAU"

	)

528 
	#REV
 4

	)

529 
	#VERS
 0

	)

530 
	#PATCHLEVEL
 3

	)

531 
	#DATE
 "23-Où-06"

	)

532 
	#STATE
 ""

	)

	@process.c

24 
	~<sys/ty³s.h
>

25 
	~<sys/¡©.h
>

26 
	~<sigÇl.h
>

27 
	~<fú.h
>

28 #ià!
defšed
(
sun
è&& !defšed(
B43
è&& !defšed(
ISC
è&& !defšed(
pyr
è&& !defšed(
_CX_UX
)

29 
	~<time.h
>

31 
	~<sys/time.h
>

32 #iâdeà
sun


33 
	~<sys/ioùl.h
>

37 
	~"cÚfig.h
"

40 #ifdeà
SVR4


41 
	~<sys/¡rİts.h
>

44 
	~"sü“n.h
"

45 
	~"ex‹º.h
"

46 
	~"logfe.h
"

48 
comm
 
comms
[];

49 *
rc_Çme
;

50 *
RcFeName
, *
home
;

51 *
B–lSŒšg
, *
Aùiv™ySŒšg
, *
Sh–lProg
, *
Sh–lArgs
[];

52 *
h¡©us¡ršg
, *
ÿ±iÚ¡ršg
, *
time¡ršg
;

53 *
wli¡¡r
, *
wli¡t™
;

54 
ÿ±iÚ®ways
;

55 *
h¬dcİydœ
, *
sü“Æogfe
, *
logt¡amp_¡ršg
;

56 
log_æush
, 
logt¡amp_Ú
, 
logt¡amp_aá”
;

57 *
Visu®B–lSŒšg
;

58 
VB–lWa™
, 
MsgWa™
, 
MsgMšWa™
, 
S’ûWa™
;

59 
SockP©h
[], *
SockName
;

60 
TtyMode
, 
auto_d‘ach
, 
u£_®tsü“n
;

61 
iæag
, 
maxwš
;

62 
u£_h¬d¡©us
, 
visu®_b–l
;

63 #ifdeà
COLOR


64 
©Œ2cŞÜ
[][4];

65 
Ç‰r2cŞÜ
;

67 
h¬d¡©u£mu
;

68 *
´štcmd
;

69 
deçuÉ_¡¬tup
;

70 
defobuæim™
;

71 
deâÚblock
;

72 
Zomb›Key_de¡roy
;

73 
Zomb›Key_»su¼eù
;

74 #ifdeà
AUTO_NUKE


75 
deçutÚuke
;

77 
£·¿‹_sids
;

78 
NewWšdow
 
nwš_deçuÉ
, 
nwš_undef
;

79 #ifdeà
COPY_PASTE


80 
još_w™h_ü
;

81 
com·ùhi¡
;

82 
£¬ch_ic
;

83 #ifdeà
FONT


84 
·¡efÚt
;

86 
m¬k_key_b
[];

87 *
BufãrFe
;

89 #ifdeà
POW_DETACH


90 *
BufãrFe
, *
PowD‘achSŒšg
;

92 #ifdeà
MULTIUSER


93 
aşu£r
 *
EfãùiveAşU£r
;

95 
‹rm
erm[];

96 #ifdeà
MAPKEYS


97 *
km­def
[];

98 *
km­adef
[];

99 *
km­mdef
[];

101 
mch¬
 
mch¬_so
, 
mch¬_nuÎ
;

102 
V”bo£C»©e
;

103 #ifdeà
UTF8


104 *
sü“Ãncodšgs
;

107 
CheckArgNum
 
__P
((, **));

108 
CË¬AùiÚ
 
__P
((
aùiÚ
 *));

109 
SaveAùiÚ
 
__P
((
aùiÚ
 *, , **, *));

110 
NextWšdow
 
__P
(());

111 
P»viousWšdow
 
__P
(());

112 
MÜeWšdows
 
__P
(());

113 
LogToggË
 
__P
(());

114 
ShowInfo
 
__P
(());

115 
ShowDInfo
 
__P
(());

116 
wš
 *
WšdowByName
 
__P
((*));

117 
WšdowByNumb”
 
__P
((*));

118 
P¬£OnOff
 
__P
((
aùiÚ
 *, *));

119 
P¬£WšNum
 
__P
((
aùiÚ
 *, *));

120 
P¬£Ba£
 
__P
((
aùiÚ
 *, *, *, , *));

121 
P¬£Num1000
 
__P
((
aùiÚ
 *, *));

122 **
SaveArgs
 
__P
((**));

123 
IsNum
 
__P
((*, ));

124 
CŞÚfš
 
__P
((*, , *));

125 
IÅutS–eù
 
__P
(());

126 
IÅutS‘’v
 
__P
((*));

127 
IÅutAKA
 
__P
(());

128 #ifdeà
MULTIUSER


129 
IÅutSu
 
__P
((
wš
 *, 
aşu£r
 **, *));

130 
su_fš
 
__P
((*, , *));

132 
AKAfš
 
__P
((*, , *));

133 #ifdeà
COPY_PASTE


134 
cİy_»g_â
 
__P
((*, , *));

135 
šs_»g_â
 
__P
((*, , *));

137 
´oûss_â
 
__P
((*, , *));

138 #ifdeà
PASSWORD


139 
·ss1
 
__P
((*, , *));

140 
·ss2
 
__P
((*, , *));

142 #ifdeà
POW_DETACH


143 
pow_d‘ach_â
 
__P
((*, , *));

145 
dig¿ph_â
 
__P
((*, , *));

146 
cÚfœm_â
 
__P
((*, , *));

147 
IsOnDi¥Ïy
 
__P
((
wš
 *));

148 
ResizeRegiÚs
 
__P
((*));

149 
ResizeFš
 
__P
((*, , *));

150 
aùiÚ
 *
FšdKb
 
__P
((*, ));

153 
Ïy”
 *
æay”
;

154 
di¥Ïy
 *di¥Ïy, *
di¥Ïys
;

155 
wš
 *
fÜe
, *
cÚsŞe_wšdow
, *
wšdows
;

156 
aşu£r
 *
u£rs
;

158 
sü“Á”m
[], 
Ho¡Name
[], 
v”siÚ
[];

159 
NewWšdow
 
nwš_undef
, 
nwš_deçuÉ
;

160 
LayFuncs
 
WšLf
;

162 
Z0width
, 
Z1width
;

163 
»®_uid
, 
»®_gid
;

165 #ifdeà
NETHACK


166 
Ãthackæag
;

170 
wš
 *
	gwb
[
MAXWIN
];

172 #ifdeà
MULTIUSER


173 *
muÉi
;

174 
maxu£rcouÁ
;

176 
	gNuÎSŒ
[] = "";

178 
¶İ
 
	g¶İ_b
[
MAX_PLOP_DEFS
];

180 #iâdeà
PTYMODE


181 
	#PTYMODE
 0622

	)

184 
	gTtyMode
 = 
PTYMODE
;

185 
	gh¬dcİy_­³nd
 = 0;

186 
	g®l_nÜeäesh
 = 0;

187 #ifdeà
ZMODEM


188 
	gzmodem_mode
 = 0;

189 *
	gzmodem_£ndcmd
;

190 *
	gzmodem_»cvcmd
;

191 *
	gzmodes
[4] = {"off", "auto", "catch", "pass"};

194 
	gidËtimo
;

195 
aùiÚ
 
	gidËaùiÚ
;

196 #ifdeà
BLANKER_PRG


197 **
	gbÏnk”´g
;

200 
aùiÚ
 
	gkb
[256];

201 
	skşass
 {

202 
kşass
 *
	mÃxt
;

203 *
	mÇme
;

204 
aùiÚ
 
	mkb
[256];

206 
kşass
 *
	gkşas£s
;

208 #ifdeà
MAPKEYS


209 
aùiÚ
 
	gumb
[
KMAP_KEYS
+
KMAP_AKEYS
];

210 
aùiÚ
 
	gdmb
[
KMAP_KEYS
+
KMAP_AKEYS
];

211 
aùiÚ
 
	gmmb
[
KMAP_KEYS
+
KMAP_AKEYS
];

212 
km­_ext
 *
	gkm­_exts
;

213 
	gkm­_exŠ
;

214 
	gm­timeout
 = 300;

219 cÚ¡ 
	gdig¿phs
[][3] = {

394 *
	gnßrgs
[1];

397 
	$In™Keyb
()

399 
i
;

400 #ifdeà
MAPKEYS


401 *
¬g¬r
[2];

404 
i
 = 0; i < (
kb
)/(*ktab); i++)

406 
kb
[
i
].
Ä
 = 
RC_ILLEGAL
;

407 
kb
[
i
].
¬gs
 = 
nßrgs
;

408 
kb
[
i
].
¬gl
 = 0;

410 #ifdeà
MAPKEYS


411 
i
 = 0; i < 
KMAP_KEYS
+
KMAP_AKEYS
; i++)

413 
umb
[
i
].
Ä
 = 
RC_ILLEGAL
;

414 
umb
[
i
].
¬gs
 = 
nßrgs
;

415 
umb
[
i
].
¬gl
 = 0;

416 
dmb
[
i
].
Ä
 = 
RC_ILLEGAL
;

417 
dmb
[
i
].
¬gs
 = 
nßrgs
;

418 
dmb
[
i
].
¬gl
 = 0;

419 
mmb
[
i
].
Ä
 = 
RC_ILLEGAL
;

420 
mmb
[
i
].
¬gs
 = 
nßrgs
;

421 
mmb
[
i
].
¬gl
 = 0;

423 
¬g¬r
[1] = 0;

424 
i
 = 0; i < 
NKMAPDEF
; i++)

426 ià(
i
 + 
KMAPDEFSTART
 < 
T_CAPS
)

428 ià(
i
 + 
KMAPDEFSTART
 >ğ
T_CAPS
 + 
KMAP_KEYS
)

430 ià(
km­def
[
i
] == 0)

432 
¬g¬r
[0] = 
km­def
[
i
];

433 
	`SaveAùiÚ
(
dmb
 + 
i
 + (
KMAPDEFSTART
 - 
T_CAPS
), 
RC_STUFF
, 
¬g¬r
, 0);

435 
i
 = 0; i < 
NKMAPADEF
; i++)

437 ià(
i
 + 
KMAPADEFSTART
 < 
T_CURSOR
)

439 ià(
i
 + 
KMAPADEFSTART
 >ğ
T_CURSOR
 + 
KMAP_AKEYS
)

441 ià(
km­adef
[
i
] == 0)

443 
¬g¬r
[0] = 
km­adef
[
i
];

444 
	`SaveAùiÚ
(
dmb
 + 
i
 + (
KMAPADEFSTART
 - 
T_CURSOR
 + 
KMAP_KEYS
), 
RC_STUFF
, 
¬g¬r
, 0);

446 
i
 = 0; i < 
NKMAPMDEF
; i++)

448 ià(
i
 + 
KMAPMDEFSTART
 < 
T_CAPS
)

450 ià(
i
 + 
KMAPMDEFSTART
 >ğ
T_CAPS
 + 
KMAP_KEYS
)

452 ià(
km­mdef
[
i
] == 0)

454 
¬g¬r
[0] = 
km­mdef
[
i
];

455 
¬g¬r
[1] = 0;

456 
	`SaveAùiÚ
(
mmb
 + 
i
 + (
KMAPMDEFSTART
 - 
T_CAPS
), 
RC_STUFF
, 
¬g¬r
, 0);

460 
kb
['h'].
Ä
 = 
RC_HARDCOPY
;

461 #ifdeà
BSDJOBS


462 
kb
['z'].
Ä
 = kb[
	`CŒl
('z')].Ä = 
RC_SUSPEND
;

464 
kb
['c'].
Ä
 = kb[
	`CŒl
('c')].Ä = 
RC_SCREEN
;

465 
kb
[' '].
Ä
 = kb[
	`CŒl
(' ')].nr =

466 
kb
['n'].
Ä
 = kb[
	`CŒl
('n')].Ä = 
RC_NEXT
;

467 
kb
['N'].
Ä
 = 
RC_NUMBER
;

468 
kb
[
	`CŒl
('h')].
Ä
 = kb[0177].Ä = kb['p'].Ä = kb[CŒl('p')].Ä = 
RC_PREV
;

469 
kb
['k'].
Ä
 = kb[
	`CŒl
('k')].Ä = 
RC_KILL
;

470 
kb
['l'].
Ä
 = kb[
	`CŒl
('l')].Ä = 
RC_REDISPLAY
;

471 
kb
['w'].
Ä
 = kb[
	`CŒl
('w')].Ä = 
RC_WINDOWS
;

472 
kb
['v'].
Ä
 = 
RC_VERSION
;

473 
kb
[
	`CŒl
('v')].
Ä
 = 
RC_DIGRAPH
;

474 
kb
['q'].
Ä
 = kb[
	`CŒl
('q')].Ä = 
RC_XON
;

475 
kb
['s'].
Ä
 = kb[
	`CŒl
('s')].Ä = 
RC_XOFF
;

476 
kb
['t'].
Ä
 = kb[
	`CŒl
('t')].Ä = 
RC_TIME
;

477 
kb
['i'].
Ä
 = kb[
	`CŒl
('i')].Ä = 
RC_INFO
;

478 
kb
['m'].
Ä
 = kb[
	`CŒl
('m')].Ä = 
RC_LASTMSG
;

479 
kb
['A'].
Ä
 = 
RC_TITLE
;

480 #ià
	`defšed
(
UTMPOK
è&& defšed(
LOGOUTOK
)

481 
kb
['L'].
Ä
 = 
RC_LOGIN
;

483 
kb
[','].
Ä
 = 
RC_LICENSE
;

484 
kb
['W'].
Ä
 = 
RC_WIDTH
;

485 
kb
['.'].
Ä
 = 
RC_DUMPTERMCAP
;

486 
kb
[
	`CŒl
('\\')].
Ä
 = 
RC_QUIT
;

487 #ifdeà
DETACH


488 
kb
['d'].
Ä
 = kb[
	`CŒl
('d')].Ä = 
RC_DETACH
;

489 #ifdeà
POW_DETACH


490 
kb
['D'].
Ä
 = 
RC_POW_DETACH
;

493 
kb
['r'].
Ä
 = kb[
	`CŒl
('r')].Ä = 
RC_WRAP
;

494 
kb
['f'].
Ä
 = kb[
	`CŒl
('f')].Ä = 
RC_FLOW
;

495 
kb
['C'].
Ä
 = 
RC_CLEAR
;

496 
kb
['Z'].
Ä
 = 
RC_RESET
;

497 
kb
['H'].
Ä
 = 
RC_LOG
;

498 
kb
['M'].
Ä
 = 
RC_MONITOR
;

499 
kb
['?'].
Ä
 = 
RC_HELP
;

500 #ifdeà
MULTI


501 
kb
['*'].
Ä
 = 
RC_DISPLAYS
;

504 *
¬gs
[2];

505 
¬gs
[0] = "-";

506 
¬gs
[1] = 
NULL
;

507 
	`SaveAùiÚ
(
kb
 + '-', 
RC_SELECT
, 
¬gs
, 0);

509 
i
 = 0; i < ((
MAXWIN
 < 10) ? MAXWIN : 10); i++)

511 *
¬gs
[2], 
¬g1
[10];

512 
¬gs
[0] = 
¬g1
;

513 
¬gs
[1] = 0;

514 
	`¥rštf
(
¬g1
, "%d", 
i
);

515 
	`SaveAùiÚ
(
kb
 + '0' + 
i
, 
RC_SELECT
, 
¬gs
, 0);

517 
kb
['\''].
Ä
 = 
RC_SELECT
;

519 *
¬gs
[2];

520 
¬gs
[0] = "-b";

521 
¬gs
[1] = 0;

522 
	`SaveAùiÚ
(
kb
 + '"', 
RC_WINDOWLIST
, 
¬gs
, 0);

524 
kb
[
	`CŒl
('G')].
Ä
 = 
RC_VBELL
;

525 
kb
[':'].
Ä
 = 
RC_COLON
;

526 #ifdeà
COPY_PASTE


527 
kb
['['].
Ä
 = kb[
	`CŒl
('[')].Ä = 
RC_COPY
;

529 *
¬gs
[2];

530 
¬gs
[0] = ".";

531 
¬gs
[1] = 0;

532 
	`SaveAùiÚ
(
kb
 + ']', 
RC_PASTE
, 
¬gs
, 0);

533 
	`SaveAùiÚ
(
kb
 + 
	`CŒl
(']'), 
RC_PASTE
, 
¬gs
, 0);

535 
kb
['{'].
Ä
 = 
RC_HISTORY
;

536 
kb
['}'].
Ä
 = 
RC_HISTORY
;

537 
kb
['>'].
Ä
 = 
RC_WRITEBUF
;

538 
kb
['<'].
Ä
 = 
RC_READBUF
;

539 
kb
['='].
Ä
 = 
RC_REMOVEBUF
;

541 #ifdeà
POW_DETACH


542 
kb
['D'].
Ä
 = 
RC_POW_DETACH
;

544 #ifdeà
LOCK


545 
kb
['x'].
Ä
 = kb[
	`CŒl
('x')].Ä = 
RC_LOCKSCREEN
;

547 
kb
['b'].
Ä
 = kb[
	`CŒl
('b')].Ä = 
RC_BREAK
;

548 
kb
['B'].
Ä
 = 
RC_POW_BREAK
;

549 
kb
['_'].
Ä
 = 
RC_SILENCE
;

550 
kb
['S'].
Ä
 = 
RC_SPLIT
;

551 
kb
['Q'].
Ä
 = 
RC_ONLY
;

552 
kb
['X'].
Ä
 = 
RC_REMOVE
;

553 
kb
['F'].
Ä
 = 
RC_FIT
;

554 
kb
['\t'].
Ä
 = 
RC_FOCUS
;

556 ià(
DeçuÉEsc
 >= 0)

558 
	`CË¬AùiÚ
(&
kb
[
DeçuÉEsc
]);

559 
kb
[
DeçuÉEsc
].
Ä
 = 
RC_OTHER
;

561 ià(
DeçuÉM‘aEsc
 >= 0)

563 
	`CË¬AùiÚ
(&
kb
[
DeçuÉM‘aEsc
]);

564 
kb
[
DeçuÉM‘aEsc
].
Ä
 = 
RC_META
;

567 
idËaùiÚ
.
Ä
 = 
RC_BLANKER
;

568 
idËaùiÚ
.
¬gs
 = 
nßrgs
;

569 
idËaùiÚ
.
¬gl
 = 0;

570 
	}
}

572 
aùiÚ
 *

573 
	$FšdKb
(
şass
, 
ü—‹
)

574 *
şass
;

575 
ü—‹
;

577 
kşass
 *
kp
, **
kµ
;

578 
i
;

580 ià(
şass
 == 0)

581  
kb
;

582 
kµ
 = &
kşas£s
; (
kp
 = *kµè!ğ0; kµ = &kp->
Ãxt
)

583 ià(!
	`¡rcmp
(
kp
->
Çme
, 
şass
))

585 ià(
kp
 == 0)

587 ià(!
ü—‹
)

589 ià(
	`¡¾’
(
şass
) > 80)

591 
	`Msg
(0, "Command class‚ameoo†ong.");

594 
kp
 = 
	`m®loc
((*kp));

595 ià(
kp
 == 0)

597 
	`Msg
(0, 
¡ºomem
);

600 
kp
->
Çme
 = 
	`SaveSŒ
(
şass
);

601 
i
 = 0; i < ()((
kp
->
kb
)/(*kp->ktab)); i++)

603 
kp
->
kb
[
i
].
Ä
 = 
RC_ILLEGAL
;

604 
kp
->
kb
[
i
].
¬gs
 = 
nßrgs
;

606 
kp
->
Ãxt
 = 0;

607 *
kµ
 = 
kp
;

609  
kp
->
kb
;

610 
	}
}

613 
	$CË¬AùiÚ
(
aù
)

614 
aùiÚ
 *
aù
;

616 **
p
;

618 ià(
aù
->
Ä
 =ğ
RC_ILLEGAL
)

620 
aù
->
Ä
 = 
RC_ILLEGAL
;

621 ià(
aù
->
¬gs
 =ğ
nßrgs
)

623 
p
 = 
aù
->
¬gs
; *p;…++)

624 
	`ä“
(*
p
);

625 
	`ä“
((*)
aù
->
¬gs
);

626 
aù
->
¬gs
 = 
nßrgs
;

627 
aù
->
¬gl
 = 0;

628 
	}
}

635 #ifdeà
MAPKEYS


643 
	$ProûssIÅut
(
ibuf
, 
’
)

644 *
ibuf
;

645 
’
;

647 
ch
, 
¦’
;

648 *
s
, *
q
;

649 
i
, 
l
;

650 *
p
;

652 
	`debug1
("ProûssIÅut: %d by‹s\n", 
’
);

653 ià(
di¥Ïy
 =ğ0 || 
’
 == 0)

655 ià(
D_£ql
)

656 
	`evdeq
(&
D_m­ev
);

657 
¦’
 = 
’
;

658 
s
 = (*)
ibuf
;

659 
’
-- > 0)

661 
ch
 = *
s
++;

662 ià(
D_dÚtm­
 || !
D_n£qs
)

664 
D_dÚtm­
 = 0;

669 
	`debug3
("cm°%ø%c[%d]\n", 
ch
, *
D_£qp
, D_£q°- 
D_km­s
);

670 ià(*
D_£qp
 !ğ
ch
)

672 
l
 = 
D_£qp
[D_£qp[-
D_£ql
-1] + 1];

673 ià(
l
)

675 
D_£qp
 +ğ
l
 * 2 + 4;

676 
	`debug1
("mis %d\n", 
D_£qp
 - 
D_km­s
);

679 
	`debug
("complete miss\n");

680 
D_m­deçuÉ
 = 0;

681 
l
 = 
D_£ql
;

682 
p
 = (*)
D_£qp
 - 
l
;

683 
D_£ql
 = 0;

684 
D_£qp
 = 
D_km­s
 + 3;

685 ià(
l
 == 0)

687 ià((
q
 = 
D_£qh
) != 0)

689 
D_£qh
 = 0;

690 
i
 = 
q
[0] << 8 | q[1];

691 
i
 &ğ~
KMAP_NOTIMEOUT
;

692 
	`debug1
("M­pšg fÜm” h™ #%d - ", 
i
);

693 
	`debug2
("%d(%sè- ", 
q
[2], q + 3);

694 ià(
	`StuffKey
(
i
))

695 
	`ProûssIÅut2
((*)
q
 + 3, q[2]);

696 ià(
di¥Ïy
 == 0)

698 
l
 -ğ
q
[2];

699 
p
 +ğ
q
[2];

702 
D_dÚtm­
 = 1;

703 
	`debug1
("æush old %d\n", 
l
);

704 
	`ProûssIÅut
(
p
, 
l
);

705 ià(
di¥Ïy
 == 0)

707 
	`evdeq
(&
D_m­ev
);

710 ià(
D_£ql
++ == 0)

713 
¦’
 -ğ
’
 + 1;

714 
	`debug1
("fšish old %d\n", 
¦’
);

715 ià(
¦’
)

716 
	`ProûssIÅut2
(
ibuf
, 
¦’
);

717 ià(
di¥Ïy
 == 0)

719 
D_£qh
 = 0;

721 
ibuf
 = (*)
s
;

722 
¦’
 = 
’
;

723 
D_£qp
++;

724 
l
 = 
D_£ql
;

725 
	`debug2
("Ëngth‡m %d, wªˆ%d\n", 
l
, 
D_£qp
[-l - 1]);

726 ià(
l
 =ğ
D_£qp
[-l - 1])

728 ià(
D_£qp
[
l
] !=†)

730 
q
 = 
D_£qp
 + 1 + 
l
;

731 ià(
D_km­s
 + 
D_n£qs
 > 
q
 && q[2] > 
l
 && !
	`bcmp
(
D_£qp
 -†, q + 3,†))

733 
	`debug1
("havªÙh” m­pšg (%s), d–ayƒxecutiÚ\n", 
q
 + 3);

734 
D_£qh
 = 
D_£qp
 - 3 - 
l
;

735 
D_£qp
 = 
q
 + 3 + 
l
;

739 
i
 = 
D_£qp
[-
l
 - 3] << 8 | D_seqp[-l - 2];

740 
i
 &ğ~
KMAP_NOTIMEOUT
;

741 
	`debug1
("M­pšg #%d - ", 
i
);

742 
p
 = (*)
D_£qp
 - 
l
;

743 
	`debug2
("%d(%sè- ", 
l
, 
p
);

744 
D_£ql
 = 0;

745 
D_£qp
 = 
D_km­s
 + 3;

746 
D_£qh
 = 0;

747 ià(
	`StuffKey
(
i
))

748 
	`ProûssIÅut2
(
p
, 
l
);

749 ià(
di¥Ïy
 == 0)

755 ià(
D_£ql
)

757 
	`debug
("am in sequence -> check forimeout\n");

758 
l
 = 
D_£ql
;

759 
s
 = 
D_£qp
; ; s +ğ
i
 * 2 + 4)

761 ià(
s
[-
l
-3] & 
KMAP_NOTIMEOUT
 >> 8)

763 ià((
i
 = 
s
[s[-
l
-1] + 1]) == 0)

765 
	`S‘Timeout
(&
D_m­ev
, 
m­timeout
);

766 
	`ev’q
(&
D_m­ev
);

771 
	`ProûssIÅut2
(
ibuf
, 
¦’
);

772 
	}
}

775 
	#ProûssIÅut2
 
ProûssIÅut


	)

784 
	$ProûssIÅut2
(
ibuf
, 
’
)

785 *
ibuf
;

786 
’
;

788 *
s
;

789 
ch
, 
¦’
;

790 
aùiÚ
 *
kbp
;

792 
	`debug1
("ProûssIÅut2: %d by‹s\n", 
’
);

793 
’
 && 
di¥Ïy
)

795 
	`debug1
(" - iËÀnow %d by‹s\n", 
’
);

796 
æay”
 = 
D_fÜecv
->
c_Ïy”
;

797 
fÜe
 = 
D_fÜe
;

798 
¦’
 = 
’
;

799 
s
 = 
ibuf
;

800 ià(!
D_ESC£’
)

802 
’
 > 0)

804 ià(()*
s
++ =ğ
D_u£r
->
u_Esc
)

806 
’
--;

808 
¦’
 -ğ
’
;

809 ià(
¦’
)

810 
	`DoProûss
(
fÜe
, &
ibuf
, &
¦’
, 0);

811 ià(--
’
 == 0)

812 
D_ESC£’
 = 
kb
;

814 ià(
’
 <= 0)

816 
kbp
 = 
D_ESC£’
 ? D_ESC£’ : 
kb
;

817 
D_ESC£’
 = 0;

818 
ch
 = ()*
s
;

826 ià(
ch
 =ğ
D_u£r
->
u_Esc
)

827 
ch
 = 
DeçuÉEsc
;

828 ià(
ch
 =ğ
D_u£r
->
u_M‘aEsc
)

829 
ch
 = 
DeçuÉM‘aEsc
;

831 ià(
ch
 >= 0)

832 
	`DoAùiÚ
(&
kbp
[
ch
], ch);

833 
ibuf
 = (*)(
s
 + 1);

834 
’
--;

836 
	}
}

839 
	$DoProûss
(
p
, 
buå
, 
ËÅ
, 
·
)

840 
wš
 *
p
;

841 **
buå
;

842 *
ËÅ
;

843 
·¡”
 *
·
;

845 
ŞdËn
;

846 
di¥Ïy
 *
d
 = display;

848 #ifdeà
COPY_PASTE


850 ià(
·
 && *
ËÅ
 > 1 && 
p
 &&…->
w_¦ow·¡e
)

853 
	`S‘Timeout
(&
p
->
w_·¡”
.
·_¦owev
,…->
w_¦ow·¡e
);

854 
	`ev’q
(&
p
->
w_·¡”
.
·_¦owev
);

858 
æay”
 && *
ËÅ
)

860 #ifdeà
COPY_PASTE


861 ià(!
·
 && 
p
 &&…->
w_·¡”
.
·_·¡–’
 && 
æay”
 =ğp->w_·¡”.
·_·¡–ay”
)

863 
	`debug
("layer is busy - beep!\n");

864 
	`WB–l
(
p
, 
visu®_b–l
);

865 *
buå
 +ğ*
ËÅ
;

866 *
ËÅ
 = 0;

867 
di¥Ïy
 = 
d
;

871 
ŞdËn
 = *
ËÅ
;

872 
	`LayProûss
(
buå
, 
ËÅ
);

873 #ifdeà
COPY_PASTE


874 ià(
·
 && !·->
·_·¡–ay”
)

877 ià(*
ËÅ
 =ğ
ŞdËn
)

879 ià(
·
)

881 
di¥Ïy
 = 
d
;

885 
	`debug
("layer is full - beep!\n");

886 
	`WB–l
(
p
, 
visu®_b–l
);

890 *
buå
 +ğ*
ËÅ
;

891 *
ËÅ
 = 0;

892 
di¥Ïy
 = 
d
;

893 #ifdeà
COPY_PASTE


894 ià(
·
 &&…a->
·_·¡–’
 == 0)

895 
	`F»ePa¡”
(
·
);

897 
	}
}

900 
	$FšdCommÄ
(
¡r
)

901 *
¡r
;

903 
x
, 
m
, 
l
 = 0, 
r
 = 
RC_LAST
;

904 
l
 <ğ
r
)

906 
m
 = (
l
 + 
r
) / 2;

907 
x
 = 
	`¡rcmp
(
¡r
, 
comms
[
m
].
Çme
);

908 ià(
x
 > 0)

909 
l
 = 
m
 + 1;

910 ià(
x
 < 0)

911 
r
 = 
m
 - 1;

913  
m
;

915  
RC_ILLEGAL
;

916 
	}
}

919 
	$CheckArgNum
(
Ä
, 
¬gs
)

920 
Ä
;

921 **
¬gs
;

923 
i
, 
n
;

924 *
¬gss
[] = {"no", "one", "two", "three", "four", "OOPS"};

925 *
ÜfÜm©
[] =

933 
n
 = 
comms
[
Ä
].
æags
 & 
ARGS_MASK
;

934 
i
 = 0; 
¬gs
[i]; i++)

936 ià(
comms
[
Ä
].
æags
 & 
ARGS_ORMORE
)

938 ià(
i
 < 
n
)

940 
	`Msg
(0, "%s: %s:‡t†east %s‡rgument%s„equired",

941 
rc_Çme
, 
comms
[
Ä
].
Çme
, 
¬gss
[
n
],‚ != 1 ? "s" : "");

945 ià((
comms
[
Ä
].
æags
 & 
ARGS_PLUS1
) &&

946 (
comms
[
Ä
].
æags
 & 
ARGS_PLUS2
) &&

947 (
comms
[
Ä
].
æags
 & 
ARGS_PLUS3
))

949 ià(
i
 !ğ
n
 && i !=‚ + 1 && i !=‚ + 2 && i !=‚ + 3)

951 
	`Msg
(0, 
ÜfÜm©
[3], 
rc_Çme
, 
comms
[
Ä
].
Çme
, 
¬gss
[
n
],

952 
¬gss
[
n
 + 1],‡rgss[n + 2],‡rgss[n + 3], "");

956 ià((
comms
[
Ä
].
æags
 & 
ARGS_PLUS1
) &&

957 (
comms
[
Ä
].
æags
 & 
ARGS_PLUS2
))

959 ià(
i
 !ğ
n
 && i !=‚ + 1 && i !=‚ + 2)

961 
	`Msg
(0, 
ÜfÜm©
[2], 
rc_Çme
, 
comms
[
Ä
].
Çme
, 
¬gss
[
n
],

962 
¬gss
[
n
 + 1],‡rgss[n + 2], "");

966 ià((
comms
[
Ä
].
æags
 & 
ARGS_PLUS1
) &&

967 (
comms
[
Ä
].
æags
 & 
ARGS_PLUS3
))

969 ià(
i
 !ğ
n
 && i !=‚ + 1 && i !=‚ + 3)

971 
	`Msg
(0, 
ÜfÜm©
[2], 
rc_Çme
, 
comms
[
Ä
].
Çme
, 
¬gss
[
n
],

972 
¬gss
[
n
 + 1],‡rgss[n + 3], "");

976 ià((
comms
[
Ä
].
æags
 & 
ARGS_PLUS2
) &&

977 (
comms
[
Ä
].
æags
 & 
ARGS_PLUS3
))

979 ià(
i
 !ğ
n
 && i !=‚ + 2 && i !=‚ + 3)

981 
	`Msg
(0, 
ÜfÜm©
[2], 
rc_Çme
, 
comms
[
Ä
].
Çme
, 
¬gss
[
n
],

982 
¬gss
[
n
 + 2],‡rgss[n + 3], "");

986 ià(
comms
[
Ä
].
æags
 & 
ARGS_PLUS1
)

988 ià(
i
 !ğ
n
 && i !=‚ + 1)

990 
	`Msg
(0, 
ÜfÜm©
[1], 
rc_Çme
, 
comms
[
Ä
].
Çme
, 
¬gss
[
n
],

991 
¬gss
[
n
 + 1],‚ != 0 ? "s" : "");

995 ià(
comms
[
Ä
].
æags
 & 
ARGS_PLUS2
)

997 ià(
i
 !ğ
n
 && i !=‚ + 2)

999 
	`Msg
(0, 
ÜfÜm©
[1], 
rc_Çme
, 
comms
[
Ä
].
Çme
, 
¬gss
[
n
],

1000 
¬gss
[
n
 + 2], "s");

1004 ià(
comms
[
Ä
].
æags
 & 
ARGS_PLUS3
)

1006 ià(
i
 !ğ
n
 && i !=‚ + 3)

1008 
	`Msg
(0, 
ÜfÜm©
[1], 
rc_Çme
, 
comms
[
Ä
].
Çme
, 
¬gss
[
n
],

1009 
¬gss
[
n
 + 3], "");

1013 ià(
i
 !ğ
n
)

1015 
	`Msg
(0, 
ÜfÜm©
[0], 
rc_Çme
, 
comms
[
Ä
].
Çme
, 
¬gss
[
n
],‚ != 1 ? "s" : "");

1018  
i
;

1019 
	}
}

1023 
	$DoAùiÚ
(
aù
, 
key
)

1024 
aùiÚ
 *
aù
;

1025 
key
;

1027 
Ä
 = 
aù
->nr;

1028 **
¬gs
 = 
aù
->args;

1029 *
¬gl
 = 
aù
->argl;

1030 
wš
 *
p
;

1031 
¬gc
, 
i
, 
n
, 
msgok
;

1032 *
s
;

1033 
ch
;

1034 
di¥Ïy
 *
odi¥Ïy
 = display;

1035 
aşu£r
 *
u£r
;

1037 
u£r
 = 
di¥Ïy
 ? 
D_u£r
 : 
u£rs
;

1038 ià(
Ä
 =ğ
RC_ILLEGAL
)

1040 
	`debug1
("key '%c': NØaùiÚ\n", 
key
);

1043 
n
 = 
comms
[
Ä
].
æags
;

1044 ià((
n
 & 
NEED_DISPLAY
è&& 
di¥Ïy
 == 0)

1046 
	`Msg
(0, "%s: %s: di¥Ïy„equœed", 
rc_Çme
, 
comms
[
Ä
].
Çme
);

1049 ià((
n
 & 
NEED_FORE
è&& 
fÜe
 == 0)

1051 
	`Msg
(0, "%s: %s: wšdow„equœed", 
rc_Çme
, 
comms
[
Ä
].
Çme
);

1054 ià((
n
 & 
NEED_LAYER
è&& 
æay”
 == 0)

1056 
	`Msg
(0, "%s: %s: di¥Ïy o¸wšdow„equœed", 
rc_Çme
, 
comms
[
Ä
].
Çme
);

1059 ià((
¬gc
 = 
	`CheckArgNum
(
Ä
, 
¬gs
)) < 0)

1061 #ifdeà
MULTIUSER


1062 ià(
di¥Ïy
)

1064 ià(
	`AşCheckP”mCmd
(
D_u£r
, 
ACL_EXEC
, &
comms
[
Ä
]))

1066 
	`Msg
(0, "%s: %s:…ermission denied (user %s)",

1067 
rc_Çme
, 
comms
[
Ä
].
Çme
, (
EfãùiveAşU£r
 ? EfãùiveAşU£¸: 
D_u£r
)->
u_Çme
);

1073 
msgok
 = 
di¥Ïy
 && !*
rc_Çme
;

1074 
Ä
)

1076 
RC_SELECT
:

1077 ià(!*
¬gs
)

1078 
	`IÅutS–eù
();

1079 ià(
¬gs
[0][0] == '-' && !args[0][1])

1081 
	`S‘FÜeWšdow
((
wš
 *)0);

1082 
	`Aùiv©e
(0);

1084 ià(
¬gs
[0][0] == '.' && !args[0][1])

1086 ià(!
fÜe
)

1087 
	`Msg
(0, "select .‚eeds‡ window");

1090 
	`S‘FÜeWšdow
(
fÜe
);

1091 
	`Aùiv©e
(0);

1094 ià(
	`P¬£WšNum
(
aù
, &
n
) == 0)

1095 
	`Sw™chWšdow
(
n
);

1097 #ifdeà
AUTO_NUKE


1098 
RC_DEFAUTONUKE
:

1099 ià(
	`P¬£OnOff
(
aù
, &
deçutÚuke
è=ğ0 && 
msgok
)

1100 
	`Msg
(0, "DeçuÉ‡utÚuktuºed %s", 
deçutÚuke
 ? "on" : "off");

1101 ià(
di¥Ïy
 && *
rc_Çme
)

1102 
D_auto_nuke
 = 
deçutÚuke
;

1104 
RC_AUTONUKE
:

1105 ià(
	`P¬£OnOff
(
aù
, &
D_auto_nuke
è=ğ0 && 
msgok
)

1106 
	`Msg
(0, "AutÚuktuºed %s", 
D_auto_nuke
 ? "on" : "off");

1109 
RC_DEFOBUFLIMIT
:

1110 ià(
	`P¬£Num
(
aù
, &
defobuæim™
è=ğ0 && 
msgok
)

1111 
	`Msg
(0, "DeçuÉ†im™ s‘Ø%d", 
defobuæim™
);

1112 ià(
di¥Ïy
 && *
rc_Çme
)

1114 
D_obufmax
 = 
defobuæim™
;

1115 
D_obuæ’max
 = 
D_obuæ’
 - 
D_obufmax
;

1118 
RC_OBUFLIMIT
:

1119 ià(*
¬gs
 == 0)

1120 
	`Msg
(0, "Lim™ i %d, cu¼’ˆbufã¸sizi %d", 
D_obufmax
, 
D_obuæ’
);

1121 ià(
	`P¬£Num
(
aù
, &
D_obufmax
è=ğ0 && 
msgok
)

1122 
	`Msg
(0, "Lim™ s‘Ø%d", 
D_obufmax
);

1123 
D_obuæ’max
 = 
D_obuæ’
 - 
D_obufmax
;

1125 
RC_DUMPTERMCAP
:

1126 
	`Wr™eFe
(
u£r
, (*)0, 
DUMP_TERMCAP
);

1128 
RC_HARDCOPY
:

1130 
mode
 = 
DUMP_HARDCOPY
;

1132 ià(
¬gc
 > 1 && !
	`¡rcmp
(*
¬gs
, "-h"))

1134 
mode
 = 
DUMP_SCROLLBACK
;

1135 
¬gs
++;

1136 
¬gc
--;

1138 ià(*
¬gs
 &&‡rgs[1])

1140 
	`Msg
(0, "%s: h¬dcİy:oØmªy‡rgum’ts", 
rc_Çme
);

1143 ià(
fÜe
 =ğ0 && *
¬gs
 == 0)

1144 
	`Msg
(0, "%s: h¬dcİy: wšdow„equœed", 
rc_Çme
);

1146 
	`Wr™eFe
(
u£r
, *
¬gs
, 
mode
);

1149 
RC_DEFLOG
:

1150 ()
	`P¬£OnOff
(
aù
, &
nwš_deçuÉ
.
Læag
);

1152 
RC_LOG
:

1153 
n
 = 
fÜe
->
w_log
 ? 1 : 0;

1154 
	`P¬£Sw™ch
(
aù
, &
n
);

1155 
	`LogToggË
(
n
);

1157 #ifdeà
BSDJOBS


1158 
RC_SUSPEND
:

1159 
	`D‘ach
(
D_STOP
);

1162 
RC_NEXT
:

1163 ià(
	`MÜeWšdows
())

1164 
	`Sw™chWšdow
(
	`NextWšdow
());

1166 
RC_PREV
:

1167 ià(
	`MÜeWšdows
())

1168 
	`Sw™chWšdow
(
	`P»viousWšdow
());

1170 
RC_KILL
:

1172 *
Çme
;

1174 ià(
key
 >= 0)

1176 #ifdeà
PSEUDOS


1177 
	`IÅut
(
fÜe
->
w_pwš
 ? "R—Îy kÈthi f‹¸[y/n]" : "R—Îy kÈthi wšdow [y/n]", 1, 
INP_RAW
, 
cÚfœm_â
, (*)
RC_KILL
);

1179 
	`IÅut
("R—Îy kÈthi wšdow [y/n]", 1, 
INP_RAW
, 
cÚfœm_â
, (*)
RC_KILL
);

1183 
n
 = 
fÜe
->
w_numb”
;

1184 #ifdeà
PSEUDOS


1185 ià(
fÜe
->
w_pwš
)

1187 
	`F»eP£udowš
(
fÜe
);

1188 
	`Msg
(0, "Filter„emoved.");

1192 
Çme
 = 
	`SaveSŒ
(
fÜe
->
w_t™Ë
);

1193 
	`KlWšdow
(
fÜe
);

1194 
	`Msg
(0, "Wšdow %d (%sèkËd.", 
n
, 
Çme
);

1195 ià(
Çme
)

1196 
	`ä“
(
Çme
);

1199 
RC_QUIT
:

1200 ià(
key
 >= 0)

1202 
	`IÅut
("R—Îy qu™‡nd kÈ®Èyou¸wšdow [y/n]", 1, 
INP_RAW
, 
cÚfœm_â
, (*)
RC_QUIT
);

1205 
	`Fš™
(0);

1207 #ifdeà
DETACH


1208 
RC_DETACH
:

1209 ià(*
¬gs
 && !
	`¡rcmp
(*args, "-h"))

1210 
	`Hªgup
();

1212 
	`D‘ach
(
D_DETACH
);

1214 #ifdeà
POW_DETACH


1215 
RC_POW_DETACH
:

1216 ià(
key
 >= 0)

1218 
buf
[2];

1220 
buf
[0] = 
key
;

1221 
	`IÅut
(
buf
, 1, 
INP_RAW
, 
pow_d‘ach_â
, 
NULL
);

1224 
	`D‘ach
(
D_POWER
);

1228 
RC_DEBUG
:

1229 #ifdeà
DEBUG


1230 ià(!*
¬gs
)

1232 ià(
då
)

1233 
	`Msg
(0, "debuggšg infØi wr™‹ÀtØ%s/", 
DEBUGDIR
);

1235 
	`Msg
(0, "debugging is currently off. Use 'debug on'oƒnable.");

1238 ià(
då
)

1240 
	`debug
("debug: closing debug file.\n");

1241 
	`fæush
(
då
);

1242 
	`fşo£
(
då
);

1243 
då
 = 
NULL
;

1245 ià(
	`¡rcmp
("off", *
¬gs
))

1246 
	`İ’debug
(0, 1);

1247 #ifdeà
SIG_NODEBUG


1248 ià(
di¥Ïy
)

1249 
	`kl
(
D_u£½id
, 
SIG_NODEBUG
);

1252 ià(*
¬gs
 =ğ0 || 
	`¡rcmp
("off", *args))

1253 
	`Msg
(0, "Sorry, screen was compiled without -DDEBUG option.");

1256 #ifdeà
ZMODEM


1257 
RC_ZMODEM
:

1258 ià(*
¬gs
 && !
	`¡rcmp
(*args, "sendcmd"))

1260 ià(
¬gs
[1])

1262 
	`ä“
(
zmodem_£ndcmd
);

1263 
zmodem_£ndcmd
 = 
	`SaveSŒ
(
¬gs
[1]);

1265 ià(
msgok
)

1266 
	`Msg
(0, "zmodem s’dcmd: %s", 
zmodem_£ndcmd
);

1269 ià(*
¬gs
 && !
	`¡rcmp
(*args, "recvcmd"))

1271 ià(
¬gs
[1])

1273 
	`ä“
(
zmodem_»cvcmd
);

1274 
zmodem_»cvcmd
 = 
	`SaveSŒ
(
¬gs
[1]);

1276 ià(
msgok
)

1277 
	`Msg
(0, "zmodem„ecvcmd: %s", 
zmodem_»cvcmd
);

1280 ià(*
¬gs
)

1282 
i
 = 0; i < 4; i++)

1283 ià(!
	`¡rcmp
(
zmodes
[
i
], *
¬gs
))

1285 ià(
i
 =ğ4 && !
	`¡rcmp
(*
¬gs
, "on"))

1286 
i
 = 1;

1287 ià(
i
 == 4)

1289 
	`Msg
(0, "usage: zmodem off|auto|catch|pass");

1292 
zmodem_mode
 = 
i
;

1294 ià(
msgok
)

1295 
	`Msg
(0, "zmodem modi %s", 
zmodes
[
zmodem_mode
]);

1298 
RC_ZOMBIE
:

1300 ià(!(
s
 = *
¬gs
))

1302 
Zomb›Key_de¡roy
 = 0;

1305 ià(*
¬gl
 == 0 || *argl > 2)

1307 
	`Msg
(0, "%s:zomb›: oÃ o¸twØch¬aù” ex³ùed.", 
rc_Çme
);

1310 
Zomb›Key_de¡roy
 = 
¬gs
[0][0];

1311 
Zomb›Key_»su¼eù
 = *
¬gl
 =ğ2 ? 
¬gs
[0][1] : 0;

1314 
RC_WALL
:

1315 #ifdeà
MULTIUSER


1316 
s
 = 
D_u£r
->
u_Çme
;

1318 
s
 = 
D_u£¹ty
;

1321 
di¥Ïy
 *
Şddi¥Ïy
 = display;

1322 
di¥Ïy
 = 0;

1323 
	`Msg
(0, "%s: %s", 
s
, *
¬gs
);

1324 
di¥Ïy
 = 
Şddi¥Ïy
;

1327 
RC_AT
:

1329 #ifdeà
MULTIUSER


1330 
s
 = 
	`SaveSŒ
(
D_u£r
->
u_Çme
);

1332 
EfãùiveAşU£r
 = 
D_u£r
;

1334 
s
 = 
	`SaveSŒ
(
D_u£¹ty
);

1336 
n
 = 
	`¡¾’
(
¬gs
[0]);

1337 ià(
n
)‚--;

1343 
¬gs
[0][
n
])

1347 
di¥Ïy
 *
nd
;

1348 
aşu£r
 *
u
;

1350 ià(!
n
)

1351 
u
 = 
D_u£r
;

1353 
u
 = 
u£rs
; u; u = u->
u_Ãxt
)

1355 
	`debug3
("¡ºcmp('%s', '%s', %d)\n", *
¬gs
, 
u
->
u_Çme
, 
n
);

1356 ià(!
	`¡ºcmp
(*
¬gs
, 
u
->
u_Çme
, 
n
))

1359 
	`debug1
("©‡Î di¥Ïy oàu£¸%s\n", 
u
->
u_Çme
);

1360 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = 
nd
)

1362 
nd
 = 
di¥Ïy
->
d_Ãxt
;

1363 ià(
D_fÜecv
 == 0)

1365 
æay”
 = 
D_fÜecv
->
c_Ïy”
;

1366 
fÜe
 = 
D_fÜe
;

1367 ià(
D_u£r
 !ğ
u
)

1369 
	`debug1
("AT di¥Ïy %s\n", 
D_u£¹ty
);

1370 
	`DoCommªd
(
¬gs
 + 1, 
¬gl
 + 1);

1371 ià(
di¥Ïy
)

1372 
	`Msg
(0, "command from %s: %s %s",

1373 
s
, 
¬gs
[1],‡rgs[2] ?‡rgs[2] : "");

1374 
di¥Ïy
 = 
NULL
;

1375 
æay”
 = 0;

1376 
fÜe
 = 
NULL
;

1382 
di¥Ïy
 *
nd
;

1384 
	`debug1
("© di¥Ïy m©chšg '%s'\n", 
¬gs
[0]);

1385 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = 
nd
)

1387 
nd
 = 
di¥Ïy
->
d_Ãxt
;

1388 ià(
D_fÜecv
 == 0)

1390 
fÜe
 = 
D_fÜe
;

1391 
æay”
 = 
D_fÜecv
->
c_Ïy”
;

1392 ià(
	`¡ºcmp
(
¬gs
[0], 
D_u£¹ty
, 
n
) &&

1393 (
	`¡ºcmp
("/dev/", 
D_u£¹ty
, 5) ||

1394 
	`¡ºcmp
(
¬gs
[0], 
D_u£¹ty
 + 5, 
n
)) &&

1395 (
	`¡ºcmp
("/dev/‰y", 
D_u£¹ty
, 8) ||

1396 
	`¡ºcmp
(
¬gs
[0], 
D_u£¹ty
 + 8, 
n
)))

1398 
	`debug1
("AT di¥Ïy %s\n", 
D_u£¹ty
);

1399 
	`DoCommªd
(
¬gs
 + 1, 
¬gl
 + 1);

1400 ià(
di¥Ïy
)

1401 
	`Msg
(0, "command from %s: %s %s",

1402 
s
, 
¬gs
[1],‡rgs[2] ?‡rgs[2] : "");

1403 
di¥Ïy
 = 
NULL
;

1404 
fÜe
 = 
NULL
;

1405 
æay”
 = 0;

1410 
n
--;

1414 
wš
 *
nw
;

1415 
ch
;

1417 
n
++;

1418 
ch
 = 
¬gs
[0][
n
];

1419 
¬gs
[0][
n
] = '\0';

1420 ià(!*
¬gs
[0] || (
i
 = 
	`WšdowByNumb”
(args[0])) < 0)

1422 
¬gs
[0][
n
] = 
ch
;

1424 
fÜe
 = 
wšdows
; fÜe; fÜğ
nw
)

1426 
nw
 = 
fÜe
->
w_Ãxt
;

1427 ià(
	`¡ºcmp
(
¬gs
[0], 
fÜe
->
w_t™Ë
, 
n
))

1429 
	`debug2
("AT wšdow %d(%s)\n", 
fÜe
->
w_numb”
, fÜe->
w_t™Ë
);

1437 
i
 = 0;

1439 ià(
fÜe
->
w_Ïy”
.
l_cvli¡
)

1440 
di¥Ïy
 = 
fÜe
->
w_Ïy”
.
l_cvli¡
->
c_di¥Ïy
;

1441 
æay”
 = 
fÜe
->
w_§v–ay”
 ? fÜe->w_§v–ay” : &fÜe->
w_Ïy”
;

1442 
	`DoCommªd
(
¬gs
 + 1, 
¬gl
 + 1);

1443 ià(
fÜe
 && fÜe->
w_Ïy”
.
l_cvli¡
)

1445 
di¥Ïy
 = 
fÜe
->
w_Ïy”
.
l_cvli¡
->
c_di¥Ïy
;

1446 
	`Msg
(0, "command from %s: %s %s",

1447 
s
, 
¬gs
[1],‡rgs[2] ?‡rgs[2] : "");

1450 
di¥Ïy
 = 
NULL
;

1451 
fÜe
 = 
NULL
;

1452 ià(
i
 < 0)

1453 
	`Msg
(0, "%s:‡ˆ'%s':‚Øsuch wšdow.\n", 
rc_Çme
, 
¬gs
[0]);

1456 ià(
i
 < 
MAXWIN
 && (
fÜe
 = 
wb
[i]))

1458 
¬gs
[0][
n
] = 
ch
;

1459 
	`debug2
("AT wšdow %d (%s)\n", 
fÜe
->
w_numb”
, fÜe->
w_t™Ë
);

1460 ià(
fÜe
->
w_Ïy”
.
l_cvli¡
)

1461 
di¥Ïy
 = 
fÜe
->
w_Ïy”
.
l_cvli¡
->
c_di¥Ïy
;

1462 
æay”
 = 
fÜe
->
w_§v–ay”
 ? fÜe->w_§v–ay” : &fÜe->
w_Ïy”
;

1463 
	`DoCommªd
(
¬gs
 + 1, 
¬gl
 + 1);

1464 ià(
fÜe
 && fÜe->
w_Ïy”
.
l_cvli¡
)

1466 
di¥Ïy
 = 
fÜe
->
w_Ïy”
.
l_cvli¡
->
c_di¥Ïy
;

1467 
	`Msg
(0, "command from %s: %s %s",

1468 
s
, 
¬gs
[1],‡rgs[2] ?‡rgs[2] : "");

1470 
di¥Ïy
 = 
NULL
;

1471 
fÜe
 = 
NULL
;

1474 
	`Msg
(0, "%s:‡ˆ[id’tif›r][%%|*|#] commªd [¬gs]", 
rc_Çme
);

1478 
	`ä“
(
s
);

1479 #ifdeà
MULTIUSER


1480 
EfãùiveAşU£r
 = 
NULL
;

1484 #ifdeà
COPY_PASTE


1485 
RC_READREG
:

1486 #ifdeà
ENCODINGS


1487 
i
 = 
fÜe
 ? fÜe->
w_’codšg
 : 
di¥Ïy
 ? di¥Ïy->
d_’codšg
 : 0;

1488 ià(
¬gs
[0] &&‡rgs[1] && !
	`¡rcmp
(args[0], "-e"))

1490 
i
 = 
	`FšdEncodšg
(
¬gs
[1]);

1491 ià(
i
 == -1)

1493 
	`Msg
(0, "%s:„—d»g: unknowÀ’codšg", 
rc_Çme
);

1496 
¬gs
 += 2;

1505 ià((
s
 = *
¬gs
è=ğ
NULL
)

1507 
	`IÅut
("CİyØ»gi¡”:", 1, 
INP_RAW
, 
cİy_»g_â
, 
NULL
);

1510 ià(*
¬gl
 != 1)

1512 
	`Msg
(0, "%s: cİy»g: ch¬aù”, ^x, o¸(où®è\\032ƒx³ùed.", 
rc_Çme
);

1515 
ch
 = 
¬gs
[0][0];

1519 ià(
¬gs
[1])

1521 ià(
¬gs
[2])

1523 
	`Msg
(0, "%s:„—d»g:oØmªy‡rgum’ts", 
rc_Çme
);

1526 ià((
s
 = 
	`R—dFe
(
¬gs
[1], &
n
)))

1528 
¶İ
 *
µ
 = 
¶İ_b
 + ()()
ch
;

1530 ià(
µ
->
buf
)

1531 
	`ä“
(
µ
->
buf
);

1532 
µ
->
buf
 = 
s
;

1533 
µ
->
Ën
 = 
n
;

1534 #ifdeà
ENCODINGS


1535 
µ
->
’c
 = 
i
;

1545 
	`cİy_»g_â
(&
ch
, 0, 
NULL
);

1548 
RC_REGISTER
:

1549 #ifdeà
ENCODINGS


1550 
i
 = 
fÜe
 ? fÜe->
w_’codšg
 : 
di¥Ïy
 ? di¥Ïy->
d_’codšg
 : 0;

1551 ià(
¬gs
[0] &&‡rgs[1] && !
	`¡rcmp
(args[0], "-e"))

1553 
i
 = 
	`FšdEncodšg
(
¬gs
[1]);

1554 ià(
i
 == -1)

1556 
	`Msg
(0, "%s:„egi¡”: unknowÀ’codšg", 
rc_Çme
);

1559 
¬gs
 += 2;

1560 
¬gc
 -= 2;

1563 ià(
¬gc
 != 2)

1565 
	`Msg
(0, "%s:„egi¡”: iÎeg®‚umb” oà¬gum’ts.", 
rc_Çme
);

1568 ià(*
¬gl
 != 1)

1570 
	`Msg
(0, "%s:„egi¡”: ch¬aù”, ^x, o¸(où®è\\032ƒx³ùed.", 
rc_Çme
);

1573 
ch
 = 
¬gs
[0][0];

1574 #ifdeà
COPY_PASTE


1575 ià(
ch
 == '.')

1577 ià(
u£r
->
u_¶İ
.
buf
 !ğ
NULL
)

1578 
	`U£rF»eCİyBufãr
(
u£r
);

1579 ià(
¬gs
[1] &&‡rgs[1][0])

1581 
u£r
->
u_¶İ
.
buf
 = 
	`SaveSŒn
(
¬gs
[1], 
¬gl
[1]);

1582 
u£r
->
u_¶İ
.
Ën
 = 
¬gl
[1];

1583 #ifdeà
ENCODINGS


1584 
u£r
->
u_¶İ
.
’c
 = 
i
;

1591 
¶İ
 *
¶p
 = 
¶İ_b
 + ()()
ch
;

1593 ià(
¶p
->
buf
)

1594 
	`ä“
(
¶p
->
buf
);

1595 
¶p
->
buf
 = 
	`SaveSŒn
(
¬gs
[1], 
¬gl
[1]);

1596 
¶p
->
Ën
 = 
¬gl
[1];

1597 #ifdeà
ENCODINGS


1598 
¶p
->
’c
 = 
i
;

1602 
RC_PROCESS
:

1603 ià((
s
 = *
¬gs
è=ğ
NULL
)

1605 
	`IÅut
("Proûs »gi¡”:", 1, 
INP_RAW
, 
´oûss_â
, 
NULL
);

1608 ià(*
¬gl
 != 1)

1610 
	`Msg
(0, "%s:…roûss: ch¬aù”, ^x, o¸(où®è\\032ƒx³ùed.", 
rc_Çme
);

1613 
ch
 = 
¬gs
[0][0];

1614 
	`´oûss_â
(&
ch
, 0, 
NULL
);

1616 
RC_STUFF
:

1617 
s
 = *
¬gs
;

1618 
n
 = *
¬gl
;

1619 ià(
¬gs
[1])

1621 ià(
	`¡rcmp
(
s
, "-k"))

1623 
	`Msg
(0, "%s: stuff: inv®id o±iÚ %s", 
rc_Çme
, 
s
);

1626 
s
 = 
¬gs
[1];

1627 
i
 = 
T_CAPS
; i < 
T_OCAPS
; i++)

1628 ià(
	`¡rcmp
(
‹rm
[
i
].
túame
, 
s
) == 0)

1630 ià(
i
 =ğ
T_OCAPS
)

1632 
	`Msg
(0, "%s: stuff: unknowÀkey '%s'", 
rc_Çme
, 
s
);

1635 #ifdeà
MAPKEYS


1636 ià(
	`StuffKey
(
i
 - 
T_CAPS
) == 0)

1639 
s
 = 
di¥Ïy
 ? 
D_tcs
[
i
].
¡r
 : 0;

1640 ià(
s
 == 0)

1642 
n
 = 
	`¡¾’
(
s
);

1644 
n
)

1645 
	`LayProûss
(&
s
, &
n
);

1647 
RC_REDISPLAY
:

1648 
	`Aùiv©e
(-1);

1650 
RC_WINDOWS
:

1651 
	`ShowWšdows
(-1);

1653 
RC_VERSION
:

1654 
	`Msg
(0, "sü“À%s", 
v”siÚ
);

1656 
RC_TIME
:

1657 ià(*
¬gs
)

1659 
time¡ršg
 = 
	`SaveSŒ
(*
¬gs
);

1662 
	`Msg
(0, "%s", 
	`MakeWšMsg
(
time¡ršg
, 
fÜe
, '%'));

1664 
RC_INFO
:

1665 
	`ShowInfo
();

1667 
RC_DINFO
:

1668 
	`ShowDInfo
();

1670 
RC_COMMAND
:

1672 
aùiÚ
 *
kbp
 = 
kb
;

1673 ià(
¬gc
 =ğ2 && !
	`¡rcmp
(*
¬gs
, "-c"))

1675 ià((
kbp
 = 
	`FšdKb
(
¬gs
[1], 0)) == 0)

1677 
	`Msg
(0, "UnknowÀcommªd cÏs '%s'", 
¬gs
[1]);

1681 ià(
D_ESC£’
 !ğ
kb
 || 
kbp
 != ktab)

1683 
D_ESC£’
 = 
kbp
;

1686 
D_ESC£’
 = 0;

1689 
RC_OTHER
:

1690 ià(
	`MÜeWšdows
())

1691 
	`Sw™chWšdow
(
di¥Ïy
 && 
D_Ùh”
 ? D_Ùh”->
w_numb”
 : 
	`NextWšdow
());

1693 
RC_META
:

1694 ià(
u£r
->
u_Esc
 == -1)

1696 
ch
 = 
u£r
->
u_Esc
;

1697 
s
 = &
ch
;

1698 
n
 = 1;

1699 
	`LayProûss
(&
s
, &
n
);

1701 
RC_XON
:

1702 
ch
 = 
	`CŒl
('q');

1703 
s
 = &
ch
;

1704 
n
 = 1;

1705 
	`LayProûss
(&
s
, &
n
);

1707 
RC_XOFF
:

1708 
ch
 = 
	`CŒl
('s');

1709 
s
 = &
ch
;

1710 
n
 = 1;

1711 
	`LayProûss
(&
s
, &
n
);

1713 
RC_DEFBREAKTYPE
:

1714 
RC_BREAKTYPE
:

1716 *
ty³s
[] = { "TIOCSBRK", "TCSBRK", "tc£ndb»ak", 
NULL
 };

1717 
b»akty³
;

1719 ià(*
¬gs
)

1721 ià(
	`P¬£Num
(
aù
, &
n
))

1722 
n
 = 0;‚ < ()((
ty³s
)/(*types));‚++)

1724 
i
 = 0; i < 4; i++)

1726 
ch
 = 
¬gs
[0][
i
];

1727 ià(
ch
 >= 'a' && ch <= 'z')

1728 
ch
 -= 'a' - 'A';

1729 ià(
ch
 !ğ
ty³s
[
n
][
i
] && (ch + ('a' - 'A')) !=ypes[n][i])

1732 ià(
i
 == 4)

1735 ià(
n
 < 0 ||‚ >ğ()((
ty³s
)/(*types)))

1736 
	`Msg
(0, "% šv®id, cho£ oÃ oà%s, % Ü %s", *
¬gs
, 
ty³s
[0],ypes[1],ypes[2]);

1739 
b»akty³
 = 
n
;

1740 
	`Msg
(0, "b»akty³ s‘Ø(%dè%s", 
n
, 
ty³s
[n]);

1744 
	`Msg
(0, "b»akty³ i (%dè%s", 
b»akty³
, 
ty³s
[breaktype]);

1747 
RC_POW_BREAK
:

1748 
RC_BREAK
:

1749 
n
 = 0;

1750 ià(*
¬gs
 && 
	`P¬£Num
(
aù
, &
n
))

1752 
	`S’dB»ak
(
fÜe
, 
n
, 
Ä
 =ğ
RC_POW_BREAK
);

1754 #ifdeà
LOCK


1755 
RC_LOCKSCREEN
:

1756 
	`D‘ach
(
D_LOCK
);

1759 
RC_WIDTH
:

1760 
RC_HEIGHT
:

1762 
w
, 
h
;

1763 
wh©
 = 0;

1765 
i
 = 1;

1766 ià(*
¬gs
 && !
	`¡rcmp
(*args, "-w"))

1767 
wh©
 = 1;

1768 ià(*
¬gs
 && !
	`¡rcmp
(*args, "-d"))

1769 
wh©
 = 2;

1770 ià(
wh©
)

1771 
¬gs
++;

1772 ià(
wh©
 =ğ0 && 
æay”
 && !
di¥Ïy
)

1773 
wh©
 = 1;

1774 ià(
wh©
 == 1)

1776 ià(!
æay”
)

1778 
	`Msg
(0, "%s: %s: wšdow„equœed", 
rc_Çme
, 
comms
[
Ä
].
Çme
);

1781 
w
 = 
æay”
->
l_width
;

1782 
h
 = 
æay”
->
l_height
;

1786 ià(!
di¥Ïy
)

1788 
	`Msg
(0, "%s: %s: di¥Ïy„equœed", 
rc_Çme
, 
comms
[
Ä
].
Çme
);

1791 
w
 = 
D_width
;

1792 
h
 = 
D_height
;

1794 ià(*
¬gs
 &&‡rgs[0][0] == '-')

1796 
	`Msg
(0, "%s: %s: unknowÀİtiÚ %s", 
rc_Çme
, 
comms
[
Ä
].
Çme
, *
¬gs
);

1799 ià(
Ä
 =ğ
RC_HEIGHT
)

1801 ià(!*
¬gs
)

1803 
	#H0height
 42

	)

1804 
	#H1height
 24

	)

1805 ià(
h
 =ğ
H0height
)

1806 
h
 = 
H1height
;

1807 ià(
h
 =ğ
H1height
)

1808 
h
 = 
H0height
;

1809 ià(
h
 > (
H0height
 + 
H1height
) / 2)

1810 
h
 = 
H0height
;

1812 
h
 = 
H1height
;

1816 
h
 = 
	`©oi
(*
¬gs
);

1817 ià(
¬gs
[1])

1818 
w
 = 
	`©oi
(
¬gs
[1]);

1823 ià(!*
¬gs
)

1825 ià(
w
 =ğ
Z0width
)

1826 
w
 = 
Z1width
;

1827 ià(
w
 =ğ
Z1width
)

1828 
w
 = 
Z0width
;

1829 ià(
w
 > (
Z0width
 + 
Z1width
) / 2)

1830 
w
 = 
Z0width
;

1832 
w
 = 
Z1width
;

1836 
w
 = 
	`©oi
(*
¬gs
);

1837 ià(
¬gs
[1])

1838 
h
 = 
	`©oi
(
¬gs
[1]);

1841 ià(*
¬gs
 &&‡rgs[1] &&‡rgs[2])

1843 
	`Msg
(0, "%s: %s:oØmªy‡rgum’ts", 
rc_Çme
, 
comms
[
Ä
].
Çme
);

1846 ià(
w
 <= 0)

1848 
	`Msg
(0, "Illegal width");

1851 ià(
h
 <= 0)

1853 
	`Msg
(0, "Illegal height");

1856 ià(
wh©
 == 1)

1858 ià(
æay”
->
l_width
 =ğ
w
 && fÏy”->
l_height
 =ğ
h
)

1860 
	`ResizeLay”
(
æay”
, 
w
, 
h
, (
di¥Ïy
 *)0);

1863 ià(
D_width
 =ğ
w
 && 
D_height
 =ğ
h
)

1865 ià(
wh©
 == 2)

1867 
	`ChªgeSü“nSize
(
w
, 
h
, 1);

1871 ià(
	`ResizeDi¥Ïy
(
w
, 
h
) == 0)

1873 
	`Aùiv©e
(
D_fÜe
 ? D_fÜe->
w_nÜeäesh
 : 0);

1875 
	`ResizeLay”
(
D_fÜecv
->
c_Ïy”
, D_fÜecv->
c_xe
 - D_fÜecv->
c_xs
 + 1, D_fÜecv->
c_ye
 - D_fÜecv->
c_ys
 + 1, 0);

1878 ià(
h
 =ğ
D_height
)

1879 
	`Msg
(0, "You¸‹rmÿ°dÛ nÙ s³cify howØchªgth‹rmš®' widthØ%d.", 
w
);

1880 ià(
w
 =ğ
D_width
)

1881 
	`Msg
(0, "You¸‹rmÿ°dÛ nÙ s³cify howØchªgth‹rmš®' heighˆtØ%d.", 
h
);

1883 
	`Msg
(0, "You¸‹rmÿ°dÛ nÙ s³cify howØchªgth‹rmš®' »sŞutiÚØ%dx%d.", 
w
, 
h
);

1887 
RC_TITLE
:

1888 ià(*
¬gs
 == 0)

1889 
	`IÅutAKA
();

1891 
	`ChªgeAKA
(
fÜe
, *
¬gs
, 
	`¡¾’
(*args));

1893 
RC_COLON
:

1894 
	`IÅut
(":", 100, 
INP_COOKED
, 
CŞÚfš
, 
NULL
);

1895 ià(*
¬gs
 && **args)

1897 
s
 = *
¬gs
;

1898 
n
 = 
	`¡¾’
(
s
);

1899 
	`LayProûss
(&
s
, &
n
);

1902 
RC_LASTMSG
:

1903 ià(
D_¡©us_Ï¡msg
)

1904 
	`Msg
(0, "%s", 
D_¡©us_Ï¡msg
);

1906 
RC_SCREEN
:

1907 
	`DoSü“n
("key", 
¬gs
);

1909 
RC_WRAP
:

1910 ià(
	`P¬£Sw™ch
(
aù
, &
fÜe
->
w_w¿p
è=ğ0 && 
msgok
)

1911 
	`Msg
(0, "%cw¿p", 
fÜe
->
w_w¿p
 ? '+' : '-');

1913 
RC_FLOW
:

1914 ià(*
¬gs
)

1916 ià(
¬gs
[0][0] == 'a')

1918 
fÜe
->
w_æow
 = (fÜe->w_æow & 
FLOW_AUTO
è? 
FLOW_AUTOFLAG
 |FLOW_AUTO|
FLOW_NOW
 : FLOW_AUTOFLAG;

1922 ià(
	`P¬£OnOff
(
aù
, &
n
))

1924 
fÜe
->
w_æow
 = (fÜe->w_æow & 
FLOW_AUTO
è| 
n
;

1929 ià(
fÜe
->
w_æow
 & 
FLOW_AUTOFLAG
)

1930 
fÜe
->
w_æow
 = (fÜe->w_æow & 
FLOW_AUTO
è| 
FLOW_NOW
;

1931 ià(
fÜe
->
w_æow
 & 
FLOW_NOW
)

1932 
fÜe
->
w_æow
 &ğ~
FLOW_NOW
;

1934 
fÜe
->
w_æow
 = fÜe->w_æow ? 
FLOW_AUTOFLAG
|
FLOW_AUTO
|
FLOW_NOW
 : FLOW_AUTOFLAG;

1936 
	`S‘Flow
(
fÜe
->
w_æow
 & 
FLOW_NOW
);

1937 ià(
msgok
)

1938 
	`Msg
(0, "%cæow%s", (
fÜe
->
w_æow
 & 
FLOW_NOW
) ? '+' : '-',

1939 (
fÜe
->
w_æow
 & 
FLOW_AUTOFLAG
) ? "(auto)" : "");

1941 #ifdeà
MULTIUSER


1942 
RC_DEFWRITELOCK
:

1943 ià(
¬gs
[0][0] == 'a')

1944 
nwš_deçuÉ
.
wlock
 = 
WLOCK_AUTO
;

1947 ià(
	`P¬£OnOff
(
aù
, &
n
))

1949 
nwš_deçuÉ
.
wlock
 = 
n
 ? 
WLOCK_ON
 : 
WLOCK_OFF
;

1952 
RC_WRITELOCK
:

1953 ià(*
¬gs
)

1955 ià(
¬gs
[0][0] == 'a')

1957 
fÜe
->
w_wlock
 = 
WLOCK_AUTO
;

1961 ià(
	`P¬£OnOff
(
aù
, &
n
))

1963 
fÜe
->
w_wlock
 = 
n
 ? 
WLOCK_ON
 : 
WLOCK_OFF
;

1969 ià(!
	`AşCheckP”mWš
(
D_u£r
, 
ACL_WRITE
, 
fÜe
))

1970 
fÜe
->
w_wlocku£r
 = 
D_u£r
;

1972 
	`Msg
(0, "wr™–ock %s", (
fÜe
->
w_wlock
 =ğ
WLOCK_AUTO
) ? "auto" :

1973 ((
fÜe
->
w_wlock
 =ğ
WLOCK_OFF
) ? "off" : "on"));

1976 
RC_CLEAR
:

1977 
	`Re£tAnsiS‹
(
fÜe
);

1978 
	`Wr™eSŒšg
(
fÜe
, "\033[H\033[J", 6);

1980 
RC_RESET
:

1981 
	`Re£tAnsiS‹
(
fÜe
);

1982 #ifdeà
ZMODEM


1983 ià(
fÜe
->
w_zdi¥Ïy
)

1984 
	`zmodem_abÜt
(
fÜe
, fÜe->
w_zdi¥Ïy
);

1986 
	`Wr™eSŒšg
(
fÜe
, "\033c", 2);

1988 
RC_MONITOR
:

1989 
n
 = 
fÜe
->
w_mÚ™Ü
 !ğ
MON_OFF
;

1990 ià(
	`P¬£Sw™ch
(
aù
, &
n
))

1992 ià(
n
)

1994 #ifdeà
MULTIUSER


1995 ià(
di¥Ïy
)

1996 
	`ACLBYTE
(
fÜe
->
w_mÚ_nÙify
, 
D_u£r
->
u_id
è|ğ
	`ACLBIT
(D_user->u_id);

1998 
i
 = 0; i < 
maxu£rcouÁ
; i++)

1999 
	`ACLBYTE
(
fÜe
->
w_mÚ_nÙify
, 
i
è|ğ
	`ACLBIT
(i);

2001 ià(
fÜe
->
w_mÚ™Ü
 =ğ
MON_OFF
)

2002 
fÜe
->
w_mÚ™Ü
 = 
MON_ON
;

2003 
	`Msg
(0, "Wšdow %d (%sèi now bešg mÚ™Üed fÜ‡Î‡ùiv™y.", 
fÜe
->
w_numb”
, fÜe->
w_t™Ë
);

2007 #ifdeà
MULTIUSER


2008 ià(
di¥Ïy
)

2009 
	`ACLBYTE
(
fÜe
->
w_mÚ_nÙify
, 
D_u£r
->
u_id
)

2010 &ğ~
	`ACLBIT
(
D_u£r
->
u_id
);

2012 
i
 = 0; i < 
maxu£rcouÁ
; i++)

2013 
	`ACLBYTE
(
fÜe
->
w_mÚ_nÙify
, 
i
è&ğ~
	`ACLBIT
(i);

2014 
i
 = 
maxu£rcouÁ
 - 1; i >= 0; i--)

2015 ià(
	`ACLBYTE
(
fÜe
->
w_mÚ_nÙify
, 
i
))

2017 ià(
i
 < 0)

2019 
fÜe
->
w_mÚ™Ü
 = 
MON_OFF
;

2020 
	`Msg
(0, "Wšdow %d (%sèi nØlÚg” bešg mÚ™Üed fÜ‡ùiv™y.", 
fÜe
->
w_numb”
, fÜe->
w_t™Ë
);

2023 #ifdeà
MULTI


2024 
RC_DISPLAYS
:

2025 
	`di¥Ïy_di¥Ïys
();

2028 
RC_WINDOWLIST
:

2029 ià(!*
¬gs
)

2030 
	`di¥Ïy_wli¡
(0, 
WLIST_NUM
);

2031 ià(!
	`¡rcmp
(*
¬gs
, "-m") && !args[1])

2032 
	`di¥Ïy_wli¡
(0, 
WLIST_MRU
);

2033 ià(!
	`¡rcmp
(*
¬gs
, "-b") && !args[1])

2034 
	`di¥Ïy_wli¡
(1, 
WLIST_NUM
);

2035 ià(!
	`¡rcmp
(*
¬gs
, "-b") && !strcmp(args[1], "-m") && !args[2])

2036 
	`di¥Ïy_wli¡
(1, 
WLIST_MRU
);

2037 ià(!
	`¡rcmp
(*
¬gs
, "-m") && !strcmp(args[1], "-b") && !args[2])

2038 
	`di¥Ïy_wli¡
(1, 
WLIST_MRU
);

2039 ià(!
	`¡rcmp
(*
¬gs
, "string"))

2041 ià(
¬gs
[1])

2043 ià(
wli¡¡r
)

2044 
	`ä“
(
wli¡¡r
);

2045 
wli¡¡r
 = 
	`SaveSŒ
(
¬gs
[1]);

2047 ià(
msgok
)

2048 
	`Msg
(0, "wšdowli¡ sŒšg i '%s'", 
wli¡¡r
);

2050 ià(!
	`¡rcmp
(*
¬gs
, "title"))

2052 ià(
¬gs
[1])

2054 ià(
wli¡t™
)

2055 
	`ä“
(
wli¡t™
);

2056 
wli¡t™
 = 
	`SaveSŒ
(
¬gs
[1]);

2058 ià(
msgok
)

2059 
	`Msg
(0, "wšdowli¡™Ë i '%s'", 
wli¡t™
);

2062 
	`Msg
(0, "usage: windowlist [-b] [string [string] |itle [title]]");

2064 
RC_HELP
:

2065 ià(
¬gc
 =ğ2 && !
	`¡rcmp
(*
¬gs
, "-c"))

2067 
aùiÚ
 *
kbp
;

2068 ià((
kbp
 = 
	`FšdKb
(
¬gs
[1], 0)) == 0)

2070 
	`Msg
(0, "UnknowÀcommªd cÏs '%s'", 
¬gs
[1]);

2073 
	`di¥Ïy_h–p
(
¬gs
[1], 
kbp
);

2076 
	`di¥Ïy_h–p
((*)0, 
kb
);

2078 
RC_LICENSE
:

2079 
	`di¥Ïy_cİyright
();

2081 #ifdeà
COPY_PASTE


2082 
RC_COPY
:

2083 ià(
æay”
->
l_Ïyâ
 !ğ&
WšLf
)

2085 
	`Msg
(0, "Must be on‡ window†ayer");

2088 
	`M¬kRoutše
();

2090 
RC_HISTORY
:

2092 *
·¡—rgs
[] = {".", 0};

2093 
·¡—rgl
[] = {1};

2095 ià(
æay”
->
l_Ïyâ
 !ğ&
WšLf
)

2097 
	`Msg
(0, "Must be on‡ window†ayer");

2100 ià(
	`G‘Hi¡Üy
() == 0)

2102 ià(
u£r
->
u_¶İ
.
buf
 =ğ
NULL
)

2104 
¬gs
 = 
·¡—rgs
;

2105 
¬gl
 = 
·¡—rgl
;

2108 
RC_PASTE
:

2110 *
ss
, *
dbuf
, 
dch
;

2111 
l
 = 0;

2112 #ifdeà
ENCODINGS


2113 
’c
 = -1;

2119 ià((
s
 = *
¬gs
è=ğ
NULL
)

2121 
	`IÅut
("Pa¡äom„egi¡”:", 1, 
INP_RAW
, 
šs_»g_â
, 
NULL
);

2124 ià(
¬gs
[1] =ğ0 && !
fÜe
)

2130 ià(
¬gs
[1] && 
¬gl
[1] != 1)

2132 
	`Msg
(0, "%s:…aste destination: character, ^x, or (octal) \\032ƒxpected.",

2133 
rc_Çme
);

2136 #ifdeà
ENCODINGS


2137 ià(
fÜe
)

2138 
’c
 = 
fÜe
->
w_’codšg
;

2144 
ss
 = 
s
 = *
¬gs
; (
ch
 = *ss); ss++)

2146 ià(
ch
 == '.')

2148 #ifdeà
ENCODINGS


2149 ià(
’c
 == -1)

2150 
’c
 = 
u£r
->
u_¶İ
.enc;

2151 ià(
’c
 !ğ
u£r
->
u_¶İ
.enc)

2152 
l
 +ğ
	`RecodeBuf
((*)
u£r
->
u_¶İ
.
buf
, u£r->u_¶İ.
Ën
, u£r->u_¶İ.
’c
,ƒnc, (*)0);

2155 
l
 +ğ
u£r
->
u_¶İ
.
Ën
;

2159 #ifdeà
ENCODINGS


2160 ià(
’c
 == -1)

2161 
’c
 = 
¶İ_b
[()()
ch
].enc;

2162 ià(
’c
 !ğ
¶İ_b
[()()
ch
].enc)

2163 
l
 +ğ
	`RecodeBuf
((*)
¶İ_b
[()()
ch
].
buf
,…lİ_b[()()ch].
Ën
,…lİ_b[()()ch].
’c
,ƒnc, (*)0);

2166 
l
 +ğ
¶İ_b
[()()
ch
].
Ën
;

2169 ià(
l
 == 0)

2171 
	`Msg
(0, "empty buffer");

2179 ià(
s
[1] =ğ0 && 
¬gs
[1] == 0)

2180 #ifdeà
ENCODINGS


2181 ià(
’c
 =ğ(*
s
 =ğ'.' ? 
u£r
->
u_¶İ
.’ø: 
¶İ_b
[()()*s].enc))

2184 
	`MakePa¡”
(&
fÜe
->
w_·¡”
, *
s
 =ğ'.' ? 
u£r
->
u_¶İ
.
buf
 : 
¶İ_b
[()()*s].buf, 
l
, 0);

2190 ià((
dbuf
 = (*)
	`m®loc
(
l
)) == 0)

2192 
	`Msg
(0, 
¡ºomem
);

2195 
l
 = 0;

2200 
ss
 = 
s
; (
ch
 = *ss); ss++)

2202 
¶İ
 *
µ
 = (
ch
 =ğ'.' ? &
u£r
->
u_¶İ
 : &
¶İ_b
[()()ch]);

2203 #ifdeà
ENCODINGS


2204 ià(
µ
->
’c
 !=ƒnc)

2206 
l
 +ğ
	`RecodeBuf
((*)
µ
->
buf
,…p->
Ën
,…p->
’c
,ƒnc, (*)
dbuf
 +†);

2210 
	`bcİy
(
µ
->
buf
, 
dbuf
 + 
l
,…p->
Ën
);

2211 
l
 +ğ
µ
->
Ën
;

2216 ià(
¬gs
[1] == 0)

2218 
	`MakePa¡”
(&
fÜe
->
w_·¡”
, 
dbuf
, 
l
, 1);

2226 
dch
 = 
¬gs
[1][0];

2227 ià(
dch
 == '.')

2229 ià(
u£r
->
u_¶İ
.
buf
 !ğ
NULL
)

2230 
	`U£rF»eCİyBufãr
(
u£r
);

2231 
u£r
->
u_¶İ
.
buf
 = 
dbuf
;

2232 
u£r
->
u_¶İ
.
Ën
 = 
l
;

2233 #ifdeà
ENCODINGS


2234 
u£r
->
u_¶İ
.
’c
 =ƒnc;

2239 
¶İ
 *
µ
 = 
¶İ_b
 + ()()
dch
;

2240 ià(
µ
->
buf
)

2241 
	`ä“
(
µ
->
buf
);

2242 
µ
->
buf
 = 
dbuf
;

2243 
µ
->
Ën
 = 
l
;

2244 #ifdeà
ENCODINGS


2245 
µ
->
’c
 =ƒnc;

2251 
RC_WRITEBUF
:

2252 ià(!
u£r
->
u_¶İ
.
buf
)

2254 
	`Msg
(0, "empty buffer");

2257 #ifdeà
ENCODINGS


2259 
¶İ
 
Şd¶İ
;

2261 
Şd¶İ
 = 
u£r
->
u_¶İ
;

2262 ià(
¬gs
[0] &&‡rgs[1] && !
	`¡rcmp
(args[0], "-e"))

2264 
’c
, 
l
;

2265 *
Ãwbuf
;

2267 
’c
 = 
	`FšdEncodšg
(
¬gs
[1]);

2268 ià(
’c
 == -1)

2270 
	`Msg
(0, "%s: wr™ebuf: unknowÀ’codšg", 
rc_Çme
);

2273 ià(
’c
 !ğ
Şd¶İ
.enc)

2275 
l
 = 
	`RecodeBuf
((*)
Şd¶İ
.
buf
, old¶İ.
Ën
, old¶İ.
’c
,ƒnc, (*)0);

2276 
Ãwbuf
 = 
	`m®loc
(
l
 + 1);

2277 ià(!
Ãwbuf
)

2279 
	`Msg
(0, 
¡ºomem
);

2282 
u£r
->
u_¶İ
.
Ën
 = 
	`RecodeBuf
((*)
Şd¶İ
.
buf
, old¶İ.Ën, old¶İ.
’c
,ƒnc, (*)
Ãwbuf
);

2283 
u£r
->
u_¶İ
.
buf
 = 
Ãwbuf
;

2284 
u£r
->
u_¶İ
.
’c
 =ƒnc;

2286 
¬gs
 += 2;

2289 ià(
¬gs
[0] &&‡rgs[1])

2290 
	`Msg
(0, "%s: wr™ebuf:oØmªy‡rgum’ts", 
rc_Çme
);

2292 
	`Wr™eFe
(
u£r
, 
¬gs
[0], 
DUMP_EXCHANGE
);

2293 #ifdeà
ENCODINGS


2294 ià(
u£r
->
u_¶İ
.
buf
 !ğ
Şd¶İ
.buf)

2295 
	`ä“
(
u£r
->
u_¶İ
.
buf
);

2296 
u£r
->
u_¶İ
 = 
Şd¶İ
;

2300 
RC_READBUF
:

2301 #ifdeà
ENCODINGS


2302 
i
 = 
fÜe
 ? fÜe->
w_’codšg
 : 
di¥Ïy
 ? di¥Ïy->
d_’codšg
 : 0;

2303 ià(
¬gs
[0] &&‡rgs[1] && !
	`¡rcmp
(args[0], "-e"))

2305 
i
 = 
	`FšdEncodšg
(
¬gs
[1]);

2306 ià(
i
 == -1)

2308 
	`Msg
(0, "%s:„—dbuf: unknowÀ’codšg", 
rc_Çme
);

2311 
¬gs
 += 2;

2314 ià(
¬gs
[0] &&‡rgs[1])

2316 
	`Msg
(0, "%s:„—dbuf:oØmªy‡rgum’ts", 
rc_Çme
);

2319 ià((
s
 = 
	`R—dFe
(
¬gs
[0] ?‡rgs[0] : 
BufãrFe
, &
n
)))

2321 ià(
u£r
->
u_¶İ
.
buf
)

2322 
	`U£rF»eCİyBufãr
(
u£r
);

2323 
u£r
->
u_¶İ
.
Ën
 = 
n
;

2324 
u£r
->
u_¶İ
.
buf
 = 
s
;

2325 #ifdeà
ENCODINGS


2326 
u£r
->
u_¶İ
.
’c
 = 
i
;

2330 
RC_REMOVEBUF
:

2331 
	`KlBufãrs
();

2333 
RC_IGNORECASE
:

2334 ()
	`P¬£Sw™ch
(
aù
, &
£¬ch_ic
);

2335 ià(
msgok
)

2336 
	`Msg
(0, "WÈ%signÜÿ£ iÀ£¬ches", 
£¬ch_ic
 ? "" : "not ");

2339 
RC_ESCAPE
:

2340 ià(*
¬gl
 == 0)

2341 
	`S‘Esÿ³
(
u£r
, -1, -1);

2342 ià(*
¬gl
 == 2)

2343 
	`S‘Esÿ³
(
u£r
, ()()
¬gs
[0][0], ()()args[0][1]);

2346 
	`Msg
(0, "%s:wØch¬aù” »quœed‡á”ƒsÿ³.", 
rc_Çme
);

2352 ià(
di¥Ïy
 && 
u£r
 !ğ
u£rs
)

2355 
RC_DEFESCAPE
:

2356 ià(*
¬gl
 == 0)

2357 
	`S‘Esÿ³
(
NULL
, -1, -1);

2358 ià(*
¬gl
 == 2)

2359 
	`S‘Esÿ³
(
NULL
, ()()
¬gs
[0][0], ()()args[0][1]);

2362 
	`Msg
(0, "%s:wØch¬aù” »quœed‡á” deãsÿ³.", 
rc_Çme
);

2365 #ifdeà
MAPKEYS


2366 
	`CheckEsÿ³
();

2369 
RC_CHDIR
:

2370 
s
 = *
¬gs
 ? *¬g : 
home
;

2371 ià(
	`chdœ
(
s
) == -1)

2372 
	`Msg
(
”ºo
, "%s", 
s
);

2374 
RC_SHELL
:

2375 
RC_DEFSHELL
:

2376 ià(
	`P¬£SaveSŒ
(
aù
, &
Sh–lProg
) == 0)

2377 
Sh–lArgs
[0] = 
Sh–lProg
;

2379 
RC_HARDCOPYDIR
:

2380 ià(*
¬gs
)

2381 ()
	`P¬£SaveSŒ
(
aù
, &
h¬dcİydœ
);

2382 ià(
msgok
)

2383 
	`Msg
(0, "h¬dcİydœ i %s\n", 
h¬dcİydœ
 && *hardcopydir ? hardcopydir : "<cwd>");

2385 
RC_LOGFILE
:

2386 ià(*
¬gs
)

2388 ià(
¬gs
[1] && !(
	`¡rcmp
(*args, "flush")))

2390 
log_æush
 = 
	`©oi
(
¬gs
[1]);

2391 ià(
msgok
)

2392 
	`Msg
(0, "log flushimeouˆ£ˆtØ%ds\n", 
log_æush
);

2395 ià(
	`P¬£SaveSŒ
(
aù
, &
sü“Æogfe
è|| !
msgok
)

2398 
	`Msg
(0, "logfi '%s'", 
sü“Æogfe
);

2400 
RC_LOGTSTAMP
:

2401 ià(!*
¬gs
 || !
	`¡rcmp
(*args, "on") || !strcmp(*args, "off"))

2403 ià(
	`P¬£Sw™ch
(
aù
, &
logt¡amp_Ú
è=ğ0 && 
msgok
)

2404 
	`Msg
(0, "time¡amp tuºed %s", 
logt¡amp_Ú
 ? "on" : "off");

2406 ià(!
	`¡rcmp
(*
¬gs
, "string"))

2408 ià(
¬gs
[1])

2410 ià(
logt¡amp_¡ršg
)

2411 
	`ä“
(
logt¡amp_¡ršg
);

2412 
logt¡amp_¡ršg
 = 
	`SaveSŒ
(
¬gs
[1]);

2414 ià(
msgok
)

2415 
	`Msg
(0, "logftime¡am°i '%s'", 
logt¡amp_¡ršg
);

2417 ià(!
	`¡rcmp
(*
¬gs
, "after"))

2419 ià(
¬gs
[1])

2421 
logt¡amp_aá”
 = 
	`©oi
(
¬gs
[1]);

2422 ià(!
msgok
)

2425 
	`Msg
(0, "time¡am°´š‹d‡á” %ds\n", 
logt¡amp_aá”
);

2428 
	`Msg
(0, "usage:†ogtstamp [after [n]|string [str]|on|off]");

2430 
RC_SHELLTITLE
:

2431 ()
	`P¬£SaveSŒ
(
aù
, &
nwš_deçuÉ
.
aka
);

2433 
RC_TERMCAP
:

2434 
RC_TERMCAPINFO
:

2435 
RC_TERMINFO
:

2436 ià(!
rc_Çme
 || !*rc_name)

2437 
	`Msg
(0, "Sorry,oo†ate‚ow. Placehat in your .screenrc file.");

2439 
RC_SLEEP
:

2441 
RC_TERM
:

2442 
s
 = 
NULL
;

2443 ià(
	`P¬£SaveSŒ
(
aù
, &
s
))

2445 ià(
	`¡¾’
(
s
) >= 20)

2447 
	`Msg
(0, "%s:”m:‡rgum’ˆtoØlÚg ( < 20)", 
rc_Çme
);

2448 
	`ä“
(
s
);

2451 
	`¡rıy
(
sü“Á”m
, 
s
);

2452 
	`ä“
(
s
);

2453 
	`debug1
("sü“Á”m s‘Ø%s\n", 
sü“Á”m
);

2454 
	`MakeT”mÿp
((
di¥Ïy
 == 0));

2455 
	`debug
("newermcap made\n");

2457 
RC_ECHO
:

2458 ià(!
msgok
 && (!
rc_Çme
 || 
	`¡rcmp
(rc_name, "-X")))

2464 ià(
¬gc
 > 1 && !
	`¡rcmp
(*
¬gs
, "-n"))

2466 
¬gs
++;

2467 
¬gc
--;

2469 
s
 = *
¬gs
;

2470 ià(
¬gc
 > 1 && !
	`¡rcmp
(*
¬gs
, "-p"))

2472 
¬gs
++;

2473 
¬gc
--;

2474 
s
 = *
¬gs
;

2475 ià(
s
)

2476 
s
 = 
	`MakeWšMsg
(s, 
fÜe
, '%');

2478 ià(
s
)

2479 
	`Msg
(0, "%s", 
s
);

2481 
	`Msg
(0, "%s: 'echØ[-n] [-p] \"¡ršg\"'ƒx³ùed.", 
rc_Çme
);

2483 
RC_BELL
:

2484 
RC_BELL_MSG
:

2485 ià(*
¬gs
 == 0)

2487 
buf
[256];

2488 
	`AddXCh¬s
(
buf
, (buf), 
B–lSŒšg
);

2489 
	`Msg
(0, "b–l_msg i '%s'", 
buf
);

2492 ()
	`P¬£SaveSŒ
(
aù
, &
B–lSŒšg
);

2494 #ifdeà
COPY_PASTE


2495 
RC_BUFFERFILE
:

2496 ià(*
¬gs
 == 0)

2497 
BufãrFe
 = 
	`SaveSŒ
(
DEFAULT_BUFFERFILE
);

2498 ià(
	`P¬£SaveSŒ
(
aù
, &
BufãrFe
))

2500 ià(
msgok
)

2501 
	`Msg
(0, "Bufãrfi now '%s'", 
BufãrFe
);

2504 
RC_ACTIVITY
:

2505 ()
	`P¬£SaveSŒ
(
aù
, &
Aùiv™ySŒšg
);

2507 #ià
	`defšed
(
DETACH
è&& defšed(
POW_DETACH
)

2508 
RC_POW_DETACH_MSG
:

2509 ià(*
¬gs
 == 0)

2511 
buf
[256];

2512 
	`AddXCh¬s
(
buf
, (buf), 
PowD‘achSŒšg
);

2513 
	`Msg
(0, "pow_d‘ach_msg i '%s'", 
buf
);

2516 ()
	`P¬£SaveSŒ
(
aù
, &
PowD‘achSŒšg
);

2519 #ià
	`defšed
(
UTMPOK
è&& defšed(
LOGOUTOK
)

2520 
RC_LOGIN
:

2521 
n
 = 
fÜe
->
w_¦Ù
 !ğ(
¦Ù_t
)-1;

2522 ià(*
¬gs
 && !
	`¡rcmp
(*args, "always"))

2524 
fÜe
->
w_læag
 = 3;

2525 ià(!
di¥Ïys
 && 
n
)

2526 
	`SlÙToggË
(
n
);

2529 ià(*
¬gs
 && !
	`¡rcmp
(*args, "attached"))

2531 
fÜe
->
w_læag
 = 1;

2532 ià(!
di¥Ïys
 && 
n
)

2533 
	`SlÙToggË
(0);

2536 ià(
	`P¬£Sw™ch
(
aù
, &
n
) == 0)

2537 
	`SlÙToggË
(
n
);

2539 
RC_DEFLOGIN
:

2540 ià(!
	`¡rcmp
(*
¬gs
, "always"))

2541 
nwš_deçuÉ
.
læag
 |= 2;

2542 ià(!
	`¡rcmp
(*
¬gs
, "attached"))

2543 
nwš_deçuÉ
.
læag
 &= ~2;

2545 ()
	`P¬£OnOff
(
aù
, &
nwš_deçuÉ
.
læag
);

2548 
RC_DEFFLOW
:

2549 ià(
¬gs
[0] &&‡rgs[1] &&‡rgs[1][0] == 'i')

2551 
iæag
 = 1;

2552 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

2554 ià(!
D_æow
)

2556 #ià
	`defšed
(
TERMIO
è|| defšed(
POSIX
)

2557 
D_NewMode
.
tio
.
c_cc
[
VINTR
] = 
D_OldMode
.tio.c_cc[VINTR];

2558 
D_NewMode
.
tio
.
c_læag
 |ğ
ISIG
;

2560 
D_NewMode
.
m_tch¬s
.
t_šŒc
 = 
D_OldMode
.m_tchars.t_intrc;

2562 
	`S‘TTY
(
D_u£rfd
, &
D_NewMode
);

2565 ià(
¬gs
[0] &&‡rgs[0][0] == 'a')

2566 
nwš_deçuÉ
.
æowæag
 = 
FLOW_AUTOFLAG
;

2568 ()
	`P¬£OnOff
(
aù
, &
nwš_deçuÉ
.
æowæag
);

2570 
RC_DEFWRAP
:

2571 ()
	`P¬£OnOff
(
aù
, &
nwš_deçuÉ
.
w¿p
);

2573 
RC_DEFC1
:

2574 ()
	`P¬£OnOff
(
aù
, &
nwš_deçuÉ
.
c1
);

2576 #ifdeà
COLOR


2577 
RC_DEFBCE
:

2578 ()
	`P¬£OnOff
(
aù
, &
nwš_deçuÉ
.
bû
);

2581 
RC_DEFGR
:

2582 ()
	`P¬£OnOff
(
aù
, &
nwš_deçuÉ
.
gr
);

2584 
RC_DEFMONITOR
:

2585 ià(
	`P¬£OnOff
(
aù
, &
n
) == 0)

2586 
nwš_deçuÉ
.
mÚ™Ü
 = (
n
 =ğ0è? 
MON_OFF
 : 
MON_ON
;

2588 
RC_DEFSILENCE
:

2589 ià(
	`P¬£OnOff
(
aù
, &
n
) == 0)

2590 
nwš_deçuÉ
.
s’û
 = (
n
 =ğ0è? 
SILENCE_OFF
 : 
SILENCE_ON
;

2592 
RC_VERBOSE
:

2593 ià(!*
¬gs
)

2594 
	`Msg
(0, "W%sƒcho command when creating windows.",

2595 
V”bo£C»©e
 ? "ill" : "on't");

2596 ià(
	`P¬£OnOff
(
aù
, &
n
) == 0)

2597 
V”bo£C»©e
 = 
n
;

2599 
RC_HARDSTATUS
:

2600 ià(
di¥Ïy
)

2602 
	`Msg
(0, "%s", "");

2603 
	`RemoveStus
();

2605 ià(
¬gs
[0] && 
	`¡rcmp
(args[0], "on") && strcmp(args[0], "off"))

2607 
di¥Ïy
 *
Şddi¥Ïy
 = display;

2608 
Şd_u£
, 
Ãw_u£
 = -1;

2610 
s
 = 
¬gs
[0];

2611 ià(!
	`¡ºcmp
(
s
, "always", 6))

2612 
s
 += 6;

2613 ià(!
	`¡rcmp
(
s
, "lastline"))

2614 
Ãw_u£
 = 
HSTATUS_LASTLINE
;

2615 ià(!
	`¡rcmp
(
s
, "ignore"))

2616 
Ãw_u£
 = 
HSTATUS_IGNORE
;

2617 ià(!
	`¡rcmp
(
s
, "message"))

2618 
Ãw_u£
 = 
HSTATUS_MESSAGE
;

2619 ià(!
	`¡rcmp
(
¬gs
[0], "string"))

2621 ià(!
¬gs
[1])

2623 
buf
[256];

2624 
	`AddXCh¬s
(
buf
, (buf), 
h¡©us¡ršg
);

2625 
	`Msg
(0, "h¬d¡©u ¡ršg i '%s'", 
buf
);

2631 
	`Msg
(0, "%s: u§ge: h¬d¡©u [®ways]Ï¡lše|ignÜe|mes§ge|¡ršg [¡ršg]", 
rc_Çme
);

2634 ià(
Ãw_u£
 != -1)

2636 
h¬d¡©u£mu
 = 
Ãw_u£
 | (
s
 =ğ
¬gs
[0] ? 0 : 
HSTATUS_ALWAYS
);

2637 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

2639 
	`RemoveStus
();

2640 
Ãw_u£
 = 
h¬d¡©u£mu
 & ~
HSTATUS_ALWAYS
;

2641 ià(
D_HS
 && 
s
 =ğ
¬gs
[0])

2642 
Ãw_u£
 = 
HSTATUS_HS
;

2643 
	`ShowHStus
((*)0);

2644 
Şd_u£
 = 
D_has_h¡©us
;

2645 
D_has_h¡©us
 = 
Ãw_u£
;

2646 ià((
Ãw_u£
 =ğ
HSTATUS_LASTLINE
 && 
Şd_u£
 != HSTATUS_LASTLINE) || (new_use != HSTATUS_LASTLINE && old_use == HSTATUS_LASTLINE))

2647 
	`ChªgeSü“nSize
(
D_width
, 
D_height
, 1);

2648 
	`ReäeshHStus
();

2651 ià(
¬gs
[1])

2653 ià(
h¡©us¡ršg
)

2654 
	`ä“
(
h¡©us¡ršg
);

2655 
h¡©us¡ršg
 = 
	`SaveSŒ
(
¬gs
[1]);

2656 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

2657 
	`ReäeshHStus
();

2659 
di¥Ïy
 = 
Şddi¥Ïy
;

2662 ()
	`P¬£Sw™ch
(
aù
, &
u£_h¬d¡©us
);

2663 ià(
msgok
)

2664 
	`Msg
(0, "mes§ge di¥Ïyed oÀ%s", 
u£_h¬d¡©us
 ? "hardstatus†ine" : "window");

2666 
RC_CAPTION
:

2667 ià(
	`¡rcmp
(
¬gs
[0], "always") == 0 || strcmp(args[0], "splitonly") == 0)

2669 
di¥Ïy
 *
Şddi¥Ïy
 = display;

2671 
ÿ±iÚ®ways
 = 
¬gs
[0][0] == 'a';

2672 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

2673 
	`ChªgeSü“nSize
(
D_width
, 
D_height
, 1);

2674 
di¥Ïy
 = 
Şddi¥Ïy
;

2676 ià(
	`¡rcmp
(
¬gs
[0], "string") == 0)

2678 ià(!
¬gs
[1])

2680 
buf
[256];

2681 
	`AddXCh¬s
(
buf
, (buf), 
ÿ±iÚ¡ršg
);

2682 
	`Msg
(0, "ÿ±iÚ sŒšg i '%s'", 
buf
);

2688 
	`Msg
(0, "%s: u§ge: c­tiÚ‡lways|¥l™Úly|¡ršg <¡ršg>", 
rc_Çme
);

2691 ià(!
¬gs
[1])

2693 ià(
ÿ±iÚ¡ršg
)

2694 
	`ä“
(
ÿ±iÚ¡ršg
);

2695 
ÿ±iÚ¡ršg
 = 
	`SaveSŒ
(
¬gs
[1]);

2696 
	`Redi¥ÏyDi¥Ïys
(0);

2698 
RC_CONSOLE
:

2699 
n
 = (
cÚsŞe_wšdow
 != 0);

2700 ià(
	`P¬£Sw™ch
(
aù
, &
n
))

2702 ià(
	`TtyG¿bCÚsŞe
(
fÜe
->
w_±yfd
, 
n
, 
rc_Çme
))

2704 ià(
n
 == 0)

2705 
	`Msg
(0, "%s:„–—sšg cÚsŞ%s", 
rc_Çme
, 
Ho¡Name
);

2706 ià(
cÚsŞe_wšdow
)

2707 
	`Msg
(0, "%s: s‹®šg cÚsŞ% äom wšdow %d (%s)", 
rc_Çme
,

2708 
Ho¡Name
, 
cÚsŞe_wšdow
->
w_numb”
, cÚsŞe_wšdow->
w_t™Ë
);

2710 
	`Msg
(0, "%s: g¿bbšg cÚsŞ%s", 
rc_Çme
, 
Ho¡Name
);

2711 
cÚsŞe_wšdow
 = 
n
 ? 
fÜe
 : 0;

2713 
RC_ALLPARTIAL
:

2714 ià(
	`P¬£OnOff
(
aù
, &
®l_nÜeäesh
))

2716 ià(!
®l_nÜeäesh
 && 
fÜe
)

2717 
	`Aùiv©e
(-1);

2718 ià(
msgok
)

2719 
	`Msg
(0, 
®l_nÜeäesh
 ? "No„efresh on window change!\n" :

2722 
RC_PARTIAL
:

2723 ()
	`P¬£Sw™ch
(
aù
, &
n
);

2724 
fÜe
->
w_nÜeäesh
 = 
n
;

2726 
RC_VBELL
:

2727 ià(
	`P¬£Sw™ch
(
aù
, &
visu®_b–l
è|| !
msgok
)

2729 ià(
visu®_b–l
 == 0)

2730 
	`Msg
(0, "switchedo‡udible bell.");

2732 
	`Msg
(0, "switchedo visual bell.");

2734 
RC_VBELLWAIT
:

2735 ià(
	`P¬£Num1000
(
aù
, &
VB–lWa™
è=ğ0 && 
msgok
)

2736 
	`Msg
(0, "vb–lwa™ s‘Ø%.10g secÚds", 
VB–lWa™
/1000.);

2738 
RC_MSGWAIT
:

2739 ià(
	`P¬£Num1000
(
aù
, &
MsgWa™
è=ğ0 && 
msgok
)

2740 
	`Msg
(0, "msgwa™ s‘Ø%.10g secÚds", 
MsgWa™
/1000.);

2742 
RC_MSGMINWAIT
:

2743 ià(
	`P¬£Num1000
(
aù
, &
MsgMšWa™
è=ğ0 && 
msgok
)

2744 
	`Msg
(0, "msgmšwa™ s‘Ø%.10g secÚds", 
MsgMšWa™
/1000.);

2746 
RC_SILENCEWAIT
:

2747 ià(
	`P¬£Num
(
aù
, &
S’ûWa™
))

2749 ià(
S’ûWa™
 < 1)

2750 
S’ûWa™
 = 1;

2751 
p
 = 
wšdows
;…;… =…->
w_Ãxt
)

2752 
p
->
w_s’ûwa™
 = 
S’ûWa™
;

2753 ià(
msgok
)

2754 
	`Msg
(0, "s’ûwa™ s‘Ø%d secÚds", 
S’ûWa™
);

2756 
RC_NUMBER
:

2757 ià(*
¬gs
 == 0)

2758 
	`Msg
(0, "Thi i wšdow %d (%s).\n", 
fÜe
->
w_numb”
, fÜe->
w_t™Ë
);

2761 
Şd
 = 
fÜe
->
w_numb”
;

2763 ià(
	`P¬£Num
(
aù
, &
n
è||‚ >ğ
maxwš
)

2765 
p
 = 
wb
[
n
];

2766 
wb
[
n
] = 
fÜe
;

2767 
fÜe
->
w_numb”
 = 
n
;

2768 
wb
[
Şd
] = 
p
;

2769 ià(
p
)

2770 
p
->
w_numb”
 = 
Şd
;

2771 #ifdeà
MULTIUSER


2773 
	`AşWšSw­
(
Şd
, 
n
);

2775 #ifdeà
UTMPOK


2777 ià((
fÜe
->
w_¦Ù
 !ğ(
¦Ù_t
) -1) && (fore->w_slot != (slot_t) 0))

2779 
	`RemoveUtmp
(
fÜe
);

2780 
	`S‘Utmp
(
fÜe
);

2782 ià(
p
 && (p->
w_¦Ù
 !ğ(
¦Ù_t
) -1) && (p->w_slot != (slot_t) 0))

2785 
di¥Ïy
 = 
fÜe
->
w_Ïy”
.
l_cvli¡
 ? fÜe->w_Ïy”.l_cvli¡->
c_di¥Ïy
 : 0;

2786 
	`RemoveUtmp
(
p
);

2787 
	`S‘Utmp
(
p
);

2791 
	`WšdowChªged
(
fÜe
, 'n');

2792 
	`WšdowChªged
((
wš
 *)0, 'w');

2793 
	`WšdowChªged
((
wš
 *)0, 'W');

2794 
	`WšdowChªged
((
wš
 *)0, 0);

2797 
RC_SILENCE
:

2798 
n
 = 
fÜe
->
w_s’û
 != 0;

2799 
i
 = 
fÜe
->
w_s’ûwa™
;

2800 ià(
¬gs
[0] && (args[0][0] == '-' || (args[0][0] >= '0' &&‡rgs[0][0] <= '9')))

2802 ià(
	`P¬£Num
(
aù
, &
i
))

2804 
n
 = 
i
 > 0;

2806 ià(
	`P¬£Sw™ch
(
aù
, &
n
))

2808 ià(
n
)

2810 #ifdeà
MULTIUSER


2811 ià(
di¥Ïy
)

2812 
	`ACLBYTE
(
fÜe
->
w_lio_nÙify
, 
D_u£r
->
u_id
è|ğ
	`ACLBIT
(D_user->u_id);

2814 
n
 = 0;‚ < 
maxu£rcouÁ
;‚++)

2815 
	`ACLBYTE
(
fÜe
->
w_lio_nÙify
, 
n
è|ğ
	`ACLBIT
(n);

2817 
fÜe
->
w_s’ûwa™
 = 
i
;

2818 
fÜe
->
w_s’û
 = 
SILENCE_ON
;

2819 
	`S‘Timeout
(&
fÜe
->
w_s’ûev
, fÜe->
w_s’ûwa™
 * 1000);

2820 
	`ev’q
(&
fÜe
->
w_s’ûev
);

2822 ià(!
msgok
)

2824 
	`Msg
(0, "Thwšdow i now bešg mÚ™Üed fÜ %d sec. s’û.", 
fÜe
->
w_s’ûwa™
);

2828 #ifdeà
MULTIUSER


2829 ià(
di¥Ïy
)

2830 
	`ACLBYTE
(
fÜe
->
w_lio_nÙify
, 
D_u£r
->
u_id
)

2831 &ğ~
	`ACLBIT
(
D_u£r
->
u_id
);

2833 
n
 = 0;‚ < 
maxu£rcouÁ
;‚++)

2834 
	`ACLBYTE
(
fÜe
->
w_lio_nÙify
, 
n
è&ğ~
	`ACLBIT
(n);

2835 
i
 = 
maxu£rcouÁ
 - 1; i >= 0; i--)

2836 ià(
	`ACLBYTE
(
fÜe
->
w_lio_nÙify
, 
i
))

2838 ià(
i
 < 0)

2841 
fÜe
->
w_s’û
 = 
SILENCE_OFF
;

2842 
	`evdeq
(&
fÜe
->
w_s’ûev
);

2844 ià(!
msgok
)

2846 
	`Msg
(0, "The window is‚o†onger being monitored for silence.");

2849 #ifdeà
COPY_PASTE


2850 
RC_DEFSCROLLBACK
:

2851 ()
	`P¬£Num
(
aù
, &
nwš_deçuÉ
.
hi¡height
);

2853 
RC_SCROLLBACK
:

2854 ()
	`P¬£Num
(
aù
, &
n
);

2855 
	`ChªgeWšdowSize
(
fÜe
, fÜe->
w_width
, fÜe->
w_height
, 
n
);

2856 ià(
msgok
)

2857 
	`Msg
(0, "süŞlback s‘Ø%d", 
fÜe
->
w_hi¡height
);

2860 
RC_SESSIONNAME
:

2861 ià(*
¬gs
 == 0)

2862 
	`Msg
(0, "Thi £ssiÚ i Çmed '%s'\n", 
SockName
);

2865 
buf
[
MAXPATHLEN
];

2867 
s
 = 0;

2868 ià(
	`P¬£SaveSŒ
(
aù
, &
s
))

2870 ià(!*
s
 || 
	`¡¾’
(sè+ (
SockName
 - 
SockP©h
è> 
MAXPATHLEN
 - 13 || 
	`šdex
(s, '/'))

2872 
	`Msg
(0, "%s: bad sessiÚ‚am'%s'\n", 
rc_Çme
, 
s
);

2873 
	`ä“
(
s
);

2876 
	`¡ºıy
(
buf
, 
SockP©h
, 
SockName
 - SockPath);

2877 
	`¥rštf
(
buf
 + (
SockName
 - 
SockP©h
), "%d.%s", ()
	`g‘pid
(), 
s
);

2878 
	`ä“
(
s
);

2879 ià((
	`acûss
(
buf
, 
F_OK
è=ğ0è|| (
”ºo
 !ğ
ENOENT
))

2881 
	`Msg
(0, "%s: iÇµrİrŸ‹…©h: '%s'.", 
rc_Çme
, 
buf
);

2884 ià(
	`»Çme
(
SockP©h
, 
buf
))

2886 
	`Msg
(
”ºo
, "%s: faedØ»Çme(%s, %s)", 
rc_Çme
, 
SockP©h
, 
buf
);

2889 
	`debug2
("»Çme(%s, %sèdÚe\n", 
SockP©h
, 
buf
);

2890 
	`¡rıy
(
SockP©h
, 
buf
);

2891 
	`MakeNewEnv
();

2894 
RC_SETENV
:

2895 ià(!
¬gs
[0] || !args[1])

2897 
	`debug1
("RC_SETENV‡rgum’t missšg: %s\n", 
¬gs
[0] ?‡rgs[0] : "");

2898 
	`IÅutS‘’v
(
¬gs
[0]);

2902 
	`x£‹nv
(
¬gs
[0],‡rgs[1]);

2903 
	`MakeNewEnv
();

2906 
RC_UNSETENV
:

2907 
	`un£‹nv
(*
¬gs
);

2908 
	`MakeNewEnv
();

2910 #ifdeà
COPY_PASTE


2911 
RC_DEFSLOWPASTE
:

2912 ()
	`P¬£Num
(
aù
, &
nwš_deçuÉ
.
¦ow
);

2914 
RC_SLOWPASTE
:

2915 ià(*
¬gs
 == 0)

2916 
	`Msg
(0, 
fÜe
->
w_¦ow·¡e
 ?

2919 
fÜe
->
w_numb”
, fÜe->
w_¦ow·¡e
);

2920 ià(
	`P¬£Num
(
aù
, &
fÜe
->
w_¦ow·¡e
è=ğ0 && 
msgok
)

2921 
	`Msg
(0, 
fÜe
->
w_¦ow·¡e
 ?

2924 
fÜe
->
w_numb”
, fÜe->
w_¦ow·¡e
);

2926 
RC_MARKKEYS
:

2927 ià(
	`CompeKeys
(*
¬gs
, *
¬gl
, 
m¬k_key_b
))

2929 
	`Msg
(0, "%s: m¬kkeys: syÁaxƒ¼Ü.", 
rc_Çme
);

2932 
	`debug1
("m¬kkey %s\n", *
¬gs
);

2934 #ifdeà
FONT


2935 
RC_PASTEFONT
:

2936 ià(
	`P¬£Sw™ch
(
aù
, &
·¡efÚt
è=ğ0 && 
msgok
)

2937 
	`Msg
(0, "WÈ%¥a¡fÚˆ£‰šgs", 
·¡efÚt
 ? "" : "not ");

2940 
RC_CRLF
:

2941 ()
	`P¬£Sw™ch
(
aù
, &
još_w™h_ü
);

2943 
RC_COMPACTHIST
:

2944 ià(
	`P¬£Sw™ch
(
aù
, &
com·ùhi¡
è=ğ0 && 
msgok
)

2945 
	`Msg
(0, "%scom·ùšg hi¡Üy†šes", 
com·ùhi¡
 ? "" : "not ");

2948 #ifdeà
NETHACK


2949 
RC_NETHACK
:

2950 ()
	`P¬£OnOff
(
aù
, &
Ãthackæag
);

2953 
RC_HARDCOPY_APPEND
:

2954 ()
	`P¬£OnOff
(
aù
, &
h¬dcİy_­³nd
);

2956 
RC_VBELL_MSG
:

2957 ià(*
¬gs
 == 0)

2959 
buf
[256];

2960 
	`AddXCh¬s
(
buf
, (buf), 
Visu®B–lSŒšg
);

2961 
	`Msg
(0, "vb–l_msg i '%s'", 
buf
);

2964 ()
	`P¬£SaveSŒ
(
aù
, &
Visu®B–lSŒšg
);

2965 
	`debug1
("‚ew vb–l¡¸'%s'\n", 
Visu®B–lSŒšg
);

2967 
RC_DEFMODE
:

2968 ià(
	`P¬£Ba£
(
aù
, *
¬gs
, &
n
, 8, "octal"))

2970 ià(
n
 < 0 ||‚ > 0777)

2972 
	`Msg
(0, "%s: mode: Inv®idty mod%o", 
rc_Çme
, 
n
);

2975 
TtyMode
 = 
n
;

2976 ià(
msgok
)

2977 
	`Msg
(0, "Ttymod£ˆtØ%03o", 
TtyMode
);

2979 
RC_AUTODETACH
:

2980 ()
	`P¬£OnOff
(
aù
, &
auto_d‘ach
);

2982 
RC_STARTUP_MESSAGE
:

2983 ()
	`P¬£OnOff
(
aù
, &
deçuÉ_¡¬tup
);

2985 #ifdeà
PASSWORD


2986 
RC_PASSWORD
:

2987 ià(*
¬gs
)

2989 
n
 = (*
u£r
->
u_·sswÜd
) ? 1 : 0;

2990 ià(
u£r
->
u_·sswÜd
 !ğ
NuÎSŒ
è
	`ä“
((*)user->u_password);

2991 
u£r
->
u_·sswÜd
 = 
	`SaveSŒ
(*
¬gs
);

2992 ià(!
	`¡rcmp
(
u£r
->
u_·sswÜd
, "none"))

2994 ià(
n
)

2995 
	`Msg
(0, "Password checking disabled");

2996 
	`ä“
(
u£r
->
u_·sswÜd
);

2997 
u£r
->
u_·sswÜd
 = 
NuÎSŒ
;

3002 ià(!
fÜe
)

3004 
	`Msg
(0, "%s:…asswÜd: wšdow„equœed", 
rc_Çme
);

3007 
	`IÅut
("New sü“À·sswÜd:", 100, 
INP_NOECHO
, 
·ss1
, 
di¥Ïy
 ? (*)
D_u£r
 : (*)
u£rs
);

3011 
RC_BIND
:

3013 
aùiÚ
 *
kbp
 = 
kb
;

3015 ià(
¬gc
 > 2 && !
	`¡rcmp
(*
¬gs
, "-c"))

3017 
kbp
 = 
	`FšdKb
(
¬gs
[1], 1);

3018 ià(
kbp
 == 0)

3020 
¬gs
 += 2;

3021 
¬gl
 += 2;

3023 ià(*
¬gl
 != 1)

3025 
	`Msg
(0, "%s: bšd: ch¬aù”, ^x, o¸(où®è\\032ƒx³ùed.", 
rc_Çme
);

3028 
n
 = ()
¬gs
[0][0];

3029 ià(
¬gs
[1])

3031 ià((
i
 = 
	`FšdCommÄ
(
¬gs
[1])è=ğ
RC_ILLEGAL
)

3033 
	`Msg
(0, "%s: bšd: unknowÀcommªd '%s'", 
rc_Çme
, 
¬gs
[1]);

3036 ià(
	`CheckArgNum
(
i
, 
¬gs
 + 2) < 0)

3038 
	`CË¬AùiÚ
(&
kbp
[
n
]);

3039 
	`SaveAùiÚ
(
kbp
 + 
n
, 
i
, 
¬gs
 + 2, 
¬gl
 + 2);

3042 
	`CË¬AùiÚ
(&
kbp
[
n
]);

3045 #ifdeà
MAPKEYS


3046 
RC_BINDKEY
:

3048 
aùiÚ
 *
Ãwaù
;

3049 
ÃwÄ
, 
æ
 = 0, 
kf
 = 0, 
af
 = 0, 
df
 = 0, 
mf
 = 0;

3050 
di¥Ïy
 *
odi¥
 = display;

3051 
u£d
 = 0;

3052 
km­_ext
 *
kme
;

3054 ; *
¬gs
 && **¬g =ğ'-';‡rgs++, 
¬gl
++)

3056 ià(
	`¡rcmp
(*
¬gs
, "-t") == 0)

3057 
æ
 = 
KMAP_NOTIMEOUT
;

3058 ià(
	`¡rcmp
(*
¬gs
, "-k") == 0)

3059 
kf
 = 1;

3060 ià(
	`¡rcmp
(*
¬gs
, "-a") == 0)

3061 
af
 = 1;

3062 ià(
	`¡rcmp
(*
¬gs
, "-d") == 0)

3063 
df
 = 1;

3064 ià(
	`¡rcmp
(*
¬gs
, "-m") == 0)

3065 
mf
 = 1;

3066 ià(
	`¡rcmp
(*
¬gs
, "--") == 0)

3068 
¬gs
++;

3069 
¬gl
++;

3074 
	`Msg
(0, "%s: bšdkey: inv®id o±iÚ %s", 
rc_Çme
, *
¬gs
);

3078 ià(
df
 && 
mf
)

3080 
	`Msg
(0, "%s: bšdkey: -d dÛ nÙ wÜk w™h -m", 
rc_Çme
);

3083 ià(*
¬gs
 == 0)

3085 ià(
mf
)

3086 
	`di¥Ïy_bšdkey
("Ed™ mode", 
mmb
);

3087 ià(
df
)

3088 
	`di¥Ïy_bšdkey
("DeçuÉ", 
dmb
);

3090 
	`di¥Ïy_bšdkey
("U£r", 
umb
);

3093 ià(
kf
 == 0)

3095 ià(
af
)

3097 
	`Msg
(0, "%s: bšdkey: -¨Úly wÜk w™h -k", 
rc_Çme
);

3100 ià(*
¬gl
 == 0)

3102 
	`Msg
(0, "%s: bšdkey:ƒm±y sŒšg make nØ£n£", 
rc_Çme
);

3105 
i
 = 0, 
kme
 = 
km­_exts
; i < 
km­_exŠ
; i++, kme++)

3106 ià(
kme
->
¡r
 == 0)

3108 ià(
¬gs
[1])

3112 ià(*
¬gl
 =ğ(
kme
->
æ
 & ~
KMAP_NOTIMEOUT
è&& 
	`bcmp
(kme->
¡r
, *
¬gs
, *argl) == 0)

3114 ià(
i
 =ğ
km­_exŠ
)

3116 ià(!
¬gs
[1])

3118 
	`Msg
(0, "%s: bšdkey: keybšdšg‚Ù found", 
rc_Çme
);

3121 
km­_exŠ
 += 8;

3122 
km­_exts
 = (
km­_ext
 *)
	`x»®loc
((*)km­_exts, 
km­_exŠ
 * (*kmap_exts));

3123 
kme
 = 
km­_exts
 + 
i
;

3124 
	`bz”o
((*)
kme
, 8 * (*
km­_exts
));

3125 ; 
i
 < 
km­_exŠ
; i++, 
kme
++)

3127 
kme
->
¡r
 = 0;

3128 
kme
->
dm
.
Ä
 = kme->
mm
.Ä = kme->
um
.Ä = 
RC_ILLEGAL
;

3129 
kme
->
dm
.
¬gs
 = kme->
mm
.¬g ğkme->
um
.¬g ğ
nßrgs
;

3131 
i
 -= 8;

3132 
kme
 -= 8;

3134 ià(
df
 =ğ0 && 
kme
->
dm
.
Ä
 !ğ
RC_ILLEGAL
)

3135 
u£d
 = 1;

3136 ià(
mf
 =ğ0 && 
kme
->
mm
.
Ä
 !ğ
RC_ILLEGAL
)

3137 
u£d
 = 1;

3138 ià((
df
 || 
mf
è&& 
kme
->
um
.
Ä
 !ğ
RC_ILLEGAL
)

3139 
u£d
 = 1;

3140 
i
 +ğ
KMAP_KEYS
 + 
KMAP_AKEYS
;

3141 
Ãwaù
 = 
df
 ? &
kme
->
dm
 : 
mf
 ? &kme->
mm
 : &kme->
um
;

3145 
i
 = 
T_CAPS
; i < 
T_OCAPS
; i++)

3146 ià(
	`¡rcmp
(
‹rm
[
i
].
túame
, *
¬gs
) == 0)

3148 ià(
i
 =ğ
T_OCAPS
)

3150 
	`Msg
(0, "%s: bšdkey: unknowÀkey '%s'", 
rc_Çme
, *
¬gs
);

3153 ià(
af
 && 
i
 >ğ
T_CURSOR
 && i < 
T_OCAPS
)

3154 
i
 -ğ
T_CURSOR
 - 
KMAP_KEYS
;

3156 
i
 -ğ
T_CAPS
;

3157 
Ãwaù
 = 
df
 ? &
dmb
[
i
] : 
mf
 ? &
mmb
[i] : &
umb
[i];

3159 ià(
¬gs
[1])

3161 ià((
ÃwÄ
 = 
	`FšdCommÄ
(
¬gs
[1])è=ğ
RC_ILLEGAL
)

3163 
	`Msg
(0, "%s: bšdkey: unknowÀcommªd '%s'", 
rc_Çme
, 
¬gs
[1]);

3166 ià(
	`CheckArgNum
(
ÃwÄ
, 
¬gs
 + 2) < 0)

3168 
	`CË¬AùiÚ
(
Ãwaù
);

3169 
	`SaveAùiÚ
(
Ãwaù
, 
ÃwÄ
, 
¬gs
 + 2, 
¬gl
 + 2);

3170 ià(
kf
 =ğ0 && 
¬gs
[1])

3172 ià(
kme
->
¡r
)

3173 
	`ä“
(
kme
->
¡r
);

3174 
kme
->
¡r
 = 
	`SaveSŒn
(*
¬gs
, *
¬gl
);

3175 
kme
->
æ
 = fÈ| *
¬gl
;

3179 
	`CË¬AùiÚ
(
Ãwaù
);

3180 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

3181 
	`»m­
(
i
, 
¬gs
[1] ? 1 : 0);

3182 ià(
kf
 =ğ0 && !
¬gs
[1])

3184 ià(!
u£d
 && 
kme
->
¡r
)

3186 
	`ä“
(
kme
->
¡r
);

3187 
kme
->
¡r
 = 0;

3188 
kme
->
æ
 = 0;

3191 
di¥Ïy
 = 
odi¥
;

3194 
RC_MAPTIMEOUT
:

3195 ià(*
¬gs
)

3197 ià(
	`P¬£Num
(
aù
, &
n
))

3199 ià(
n
 < 0)

3201 
	`Msg
(0, "%s: m­timeout: iÎeg®im%d", 
rc_Çme
, 
n
);

3204 
m­timeout
 = 
n
;

3206 ià(*
¬gs
 =ğ0 || 
msgok
)

3207 
	`Msg
(0, "m­timeouˆi %dms", 
m­timeout
);

3209 
RC_MAPNOTNEXT
:

3210 
D_dÚtm­
 = 1;

3212 
RC_MAPDEFAULT
:

3213 
D_m­deçuÉ
 = 1;

3216 #ifdeà
MULTIUSER


3217 
RC_ACLCHG
:

3218 
RC_ACLADD
:

3219 
RC_ADDACL
:

3220 
RC_CHACL
:

3221 
	`U£rsAş
(
NULL
, 
¬gc
, 
¬gs
);

3223 
RC_ACLDEL
:

3224 ià(
	`U£rD–
(
¬gs
[0], 
NULL
))

3226 ià(
msgok
)

3227 
	`Msg
(0, "% »moved from‡ş d©aba£", 
¬gs
[0]);

3229 
RC_ACLGRP
:

3235 ià(
¬gs
[1])

3237 ià(
	`¡rcmp
(
¬gs
[1], "none"))

3239 ià(
	`AşLškU£r
(
¬gs
[0],‡rgs[1]))

3241 ià(
msgok
)

3242 
	`Msg
(0, "U£¸% jošed‡ş-grou°%s", 
¬gs
[0],‡rgs[1]);

3246 
aşu£r
 *
u
;

3247 
aşu£rgroup
 *
g
;

3249 ià(!(
u
 = *
	`FšdU£rPŒ
(
¬gs
[0])))

3251 (
g
 = 
u
->
u_group
))

3253 
u
->
u_group
 = 
g
->
Ãxt
;

3254 
	`ä“
((*)
g
);

3260 
buf
[256], *
p
 = buf;

3261 
ngroups
 = 0;

3262 
aşu£r
 *
u
;

3263 
aşu£rgroup
 *
g
;

3265 ià(!(
u
 = *
	`FšdU£rPŒ
(
¬gs
[0])))

3267 ià(
msgok
)

3268 
	`Msg
(0, "U£¸% dÛ nÙƒxi¡.", 
¬gs
[0]);

3271 
g
 = 
u
->
u_group
;

3272 
g
)

3274 
ngroups
++;

3275 
	`¥rštf
(
p
, "% ", 
g
->
u
->
u_Çme
);

3276 
p
 +ğ
	`¡¾’
(p);

3277 ià(
p
 > 
buf
+200)

3279 
g
 = g->
Ãxt
;

3281 ià(
ngroups
)

3282 *(--
p
) = '\0';

3283 
	`Msg
(0, "%s' group%s: %s.", 
¬gs
[0], (
ngroups
 == 1) ? "" : "s",

3284 (
ngroups
 =ğ0è? "nÚe" : 
buf
);

3287 
RC_ACLUMASK
:

3288 
RC_UMASK
:

3289 (
s
 = *
¬gs
++))

3291 *
”r
 = 0;

3293 ià(
	`AşUmask
(
di¥Ïy
 ? 
D_u£r
 : 
u£rs
, 
s
, &
”r
))

3294 
	`Msg
(0, "umask: %s\n", 
”r
);

3297 
RC_MULTIUSER
:

3298 ià(
	`P¬£OnOff
(
aù
, &
n
))

3300 
muÉi
 = 
n
 ? "" : 0;

3301 
	`chsock
();

3302 ià(
msgok
)

3303 
	`Msg
(0, "MuÉiu£¸mod%s", 
muÉi
 ? "enabled" : "disabled");

3306 #ifdeà
PSEUDOS


3307 
RC_EXEC
:

3308 
	`wšexec
(
¬gs
);

3311 #ifdeà
MULTI


3312 
RC_NONBLOCK
:

3313 
i
 = 
D_nÚblock
 >= 0;

3314 ià(*
¬gs
 && ((args[0][0] >= '0' &&‡rgs[0][0] <= '9') ||‡rgs[0][0] == '.'))

3316 ià(
	`P¬£Num1000
(
aù
, &
i
))

3319 ià(!
	`P¬£Sw™ch
(
aù
, &
i
))

3320 
i
 = i == 0 ? -1 : 1000;

3323 ià(
msgok
 && 
i
 == -1)

3324 
	`Msg
(0, "display seto blocking mode");

3325 ià(
msgok
 && 
i
 == 0)

3326 
	`Msg
(0, "display seto‚onblocking mode,‚oimeout");

3327 ià(
msgok
)

3328 
	`Msg
(0, "di¥Ïy s‘ØnÚblockšg mode, %.10g timeout", 
i
/1000.);

3329 
D_nÚblock
 = 
i
;

3330 ià(
D_nÚblock
 <= 0)

3331 
	`evdeq
(&
D_blockedev
);

3333 
RC_DEFNONBLOCK
:

3334 ià(*
¬gs
 && ((args[0][0] >= '0' &&‡rgs[0][0] <= '9') ||‡rgs[0][0] == '.'))

3336 ià(
	`P¬£Num1000
(
aù
, &
deâÚblock
))

3339 ià(!
	`P¬£OnOff
(
aù
, &
deâÚblock
))

3340 
deâÚblock
 = defnonblock == 0 ? -1 : 1000;

3343 ià(
di¥Ïy
 && *
rc_Çme
)

3345 
D_nÚblock
 = 
deâÚblock
;

3346 ià(
D_nÚblock
 <= 0)

3347 
	`evdeq
(&
D_blockedev
);

3351 
RC_GR
:

3352 #ifdeà
ENCODINGS


3353 ià(
fÜe
->
w_gr
 == 2)

3354 
fÜe
->
w_gr
 = 0;

3356 ià(
	`P¬£Sw™ch
(
aù
, &
fÜe
->
w_gr
è=ğ0 && 
msgok
)

3357 
	`Msg
(0, "WÈ%su£ GR", 
fÜe
->
w_gr
 ? "" : "not ");

3358 #ifdeà
ENCODINGS


3359 ià(
fÜe
->
w_gr
 =ğ0 && fÜe->
w_FÚtE
)

3360 
fÜe
->
w_gr
 = 2;

3363 
RC_C1
:

3364 ià(
	`P¬£Sw™ch
(
aù
, &
fÜe
->
w_c1
è=ğ0 && 
msgok
)

3365 
	`Msg
(0, "WÈ%su£ C1", 
fÜe
->
w_c1
 ? "" : "not ");

3367 #ifdeà
COLOR


3368 
RC_BCE
:

3369 ià(
	`P¬£Sw™ch
(
aù
, &
fÜe
->
w_bû
è=ğ0 && 
msgok
)

3370 
	`Msg
(0, "WÈ%£¿£ w™h background cŞÜ", 
fÜe
->
w_bû
 ? "" : "not ");

3373 #ifdeà
ENCODINGS


3374 
RC_KANJI
:

3375 
RC_ENCODING
:

3376 #ifdeà
UTF8


3377 ià(*
¬gs
 && !
	`¡rcmp
(args[0], "-d"))

3379 ià(!
¬gs
[1])

3380 
	`Msg
(0, "’codšg dœeùÜy i %s", 
sü“Ãncodšgs
 ? screenencodings : "<unset>");

3383 
	`ä“
(
sü“Ãncodšgs
);

3384 
sü“Ãncodšgs
 = 
	`SaveSŒ
(
¬gs
[1]);

3388 ià(*
¬gs
 && !
	`¡rcmp
(args[0], "-l"))

3390 ià(!
¬gs
[1])

3391 
	`Msg
(0, "encoding: -l:‡rgument„equired");

3392 ià(
	`LßdFÚtT¿n¦©iÚ
(-1, 
¬gs
[1]))

3393 
	`Msg
(0, "encoding: could‚ot†oad utf8ƒncoding file");

3394 ià(
msgok
)

3395 
	`Msg
(0, "encoding: utf8ƒncoding file†oaded");

3399 ià(*
¬gs
 && (!
	`¡rcmp
(args[0], "-l") || !strcmp(args[0], "-d")))

3401 ià(
msgok
)

3402 
	`Msg
(0, "encoding: screen is‚ot compiled for UTF-8.");

3406 
i
 = 0; i < 2; i++)

3408 ià(
¬gs
[
i
] == 0)

3410 ià(!
	`¡rcmp
(
¬gs
[
i
], "."))

3412 
n
 = 
	`FšdEncodšg
(
¬gs
[
i
]);

3413 ià(
n
 == -1)

3415 
	`Msg
(0, "’codšg: unknowÀ’codšg '%s'", 
¬gs
[
i
]);

3418 ià(
i
 =ğ0 && 
fÜe
)

3420 
	`WšSw™chEncodšg
(
fÜe
, 
n
);

3421 
	`Re£tCh¬£ts
(
fÜe
);

3423 ià(
i
 && 
di¥Ïy
)

3424 
D_’codšg
 = 
n
;

3427 
RC_DEFKANJI
:

3428 
RC_DEFENCODING
:

3429 
n
 = 
	`FšdEncodšg
(*
¬gs
);

3430 ià(
n
 == -1)

3432 
	`Msg
(0, "deãncodšg: unknowÀ’codšg '%s'", *
¬gs
);

3435 
nwš_deçuÉ
.
’codšg
 = 
n
;

3439 #ifdeà
UTF8


3440 
RC_DEFUTF8
:

3441 
n
 = 
nwš_deçuÉ
.
’codšg
 =ğ
UTF8
;

3442 ià(
	`P¬£Sw™ch
(
aù
, &
n
) == 0)

3444 
nwš_deçuÉ
.
’codšg
 = 
n
 ? 
UTF8
 : 0;

3445 ià(
msgok
)

3446 
	`Msg
(0, "WÈ%su£ UTF-8ƒncodšg fÜ‚ew wšdows", 
n
 ? "" : "not ");

3449 
RC_UTF8
:

3450 
i
 = 0; i < 2; i++)

3452 ià(
i
 && 
¬gs
[i] == 0)

3454 ià(
¬gs
[
i
] == 0)

3455 
n
 = 
fÜe
->
w_’codšg
 !ğ
UTF8
;

3456 ià(
	`¡rcmp
(
¬gs
[
i
], "off") == 0)

3457 
n
 = 0;

3458 ià(
	`¡rcmp
(
¬gs
[
i
], "on") == 0)

3459 
n
 = 1;

3462 
	`Msg
(0, "utf8: iÎeg®‡rgum’ˆ(%s)", 
¬gs
[
i
]);

3465 ià(
i
 == 0)

3467 
	`WšSw™chEncodšg
(
fÜe
, 
n
 ? 
UTF8
 : 0);

3468 ià(
msgok
)

3469 
	`Msg
(0, "WÈ%su£ UTF-8ƒncodšg", 
n
 ? "" : "not ");

3471 ià(
di¥Ïy
)

3472 
D_’codšg
 = 
n
 ? 
UTF8
 : 0;

3473 ià(
¬gs
[
i
] == 0)

3479 
RC_PRINTCMD
:

3480 ià(*
¬gs
)

3482 ià(
´štcmd
)

3483 
	`ä“
(
´štcmd
);

3484 
´štcmd
 = 0;

3485 ià(**
¬gs
)

3486 
´štcmd
 = 
	`SaveSŒ
(*
¬gs
);

3488 ià(*
¬gs
 =ğ0 || 
msgok
)

3490 ià(
´štcmd
)

3491 
	`Msg
(0, "usšg '%s'‡ ´šˆcommªd", 
´štcmd
);

3493 
	`Msg
(0, "usingermcapƒntries for…rinting");

3498 
RC_DIGRAPH
:

3499 
	`IÅut
("EÁ” dig¿ph: ", 10, 
INP_EVERY
, 
dig¿ph_â
, 
NULL
);

3500 ià(*
¬gs
 && **args)

3502 
s
 = *
¬gs
;

3503 
n
 = 
	`¡¾’
(
s
);

3504 
	`LayProûss
(&
s
, &
n
);

3508 
RC_DEFHSTATUS
:

3509 ià(*
¬gs
 == 0)

3511 
buf
[256];

3512 *
buf
 = 0;

3513 ià(
nwš_deçuÉ
.
h¡©us
)

3514 
	`AddXCh¬s
(
buf
, (buf), 
nwš_deçuÉ
.
h¡©us
);

3515 
	`Msg
(0, "deçuÉ h¡©u i '%s'", 
buf
);

3518 ()
	`P¬£SaveSŒ
(
aù
, &
nwš_deçuÉ
.
h¡©us
);

3519 ià(*
nwš_deçuÉ
.
h¡©us
 == 0)

3521 
	`ä“
(
nwš_deçuÉ
.
h¡©us
);

3522 
nwš_deçuÉ
.
h¡©us
 = 0;

3525 
RC_HSTATUS
:

3526 ()
	`P¬£SaveSŒ
(
aù
, &
fÜe
->
w_h¡©us
);

3527 ià(*
fÜe
->
w_h¡©us
 == 0)

3529 
	`ä“
(
fÜe
->
w_h¡©us
);

3530 
fÜe
->
w_h¡©us
 = 0;

3532 
	`WšdowChªged
(
fÜe
, 'h');

3535 #ifdeà
FONT


3536 
RC_DEFCHARSET
:

3537 
RC_CHARSET
:

3538 ià(*
¬gs
 == 0)

3540 
buf
[256];

3541 *
buf
 = 0;

3542 ià(
nwš_deçuÉ
.
ch¬£t
)

3543 
	`AddXCh¬s
(
buf
, (buf), 
nwš_deçuÉ
.
ch¬£t
);

3544 
	`Msg
(0, "deçuÉ ch¬£ˆi '%s'", 
buf
);

3547 
n
 = 
	`¡¾’
(*
¬gs
);

3548 ià(
n
 == 0 ||‚ > 6)

3550 
	`Msg
(0, "%s: %s: sŒšg ha Ëg® size.", 
rc_Çme
, 
comms
[
Ä
].
Çme
);

3553 ià(
n
 > 4 && (

3554 ((
¬gs
[0][4] < '0' ||‡rgs[0][4] > '3') &&‡rgs[0][4] != '.') ||

3555 ((
¬gs
[0][5] < '0' ||‡rgs[0][5] > '3') &&‡rgs[0][5] &&‡rgs[0][5] != '.')))

3557 
	`Msg
(0, "%s: %s: iÎeg® m­pšg‚umb”.", 
rc_Çme
, 
comms
[
Ä
].
Çme
);

3560 ià(
Ä
 =ğ
RC_CHARSET
)

3562 
	`S‘Ch¬£ts
(
fÜe
, *
¬gs
);

3565 ià(
nwš_deçuÉ
.
ch¬£t
)

3566 
	`ä“
(
nwš_deçuÉ
.
ch¬£t
);

3567 
nwš_deçuÉ
.
ch¬£t
 = 
	`SaveSŒ
(*
¬gs
);

3570 #ifdeà
COLOR


3571 
RC_ATTRCOLOR
:

3572 
s
 = 
¬gs
[0];

3573 ià(*
s
 >= '0' && *s <= '9')

3574 
i
 = *
s
 - '0';

3576 
i
 = 0; i < 8; i++)

3577 ià(*
s
 =ğ"dubrsBiI"[
i
])

3579 
s
++;

3580 
Ä
 = 0;

3581 ià(*
s
 && s[1] && !s[2])

3583 ià(*
s
 == 'd' && s[1] == 'd')

3584 
Ä
 = 3;

3585 ià(*
s
 == '.' && s[1] == 'd')

3586 
Ä
 = 2;

3587 ià(*
s
 == 'd' && s[1] == '.')

3588 
Ä
 = 1;

3589 ià(*
s
 != '.' || s[1] != '.')

3590 
s
--;

3591 
s
 += 2;

3593 ià(*
s
 || 
i
 < 0 || i >= 8)

3595 
	`Msg
(0, "%s:‡‰rcŞÜ: unknowÀ©Œibu‹ '%s'.", 
rc_Çme
, 
¬gs
[0]);

3598 
n
 = 0;

3599 ià(
¬gs
[1])

3600 
n
 = 
	`P¬£A‰rCŞÜ
(
¬gs
[1],‡rgs[2], 1);

3601 ià(
n
 == -1)

3603 
©Œ2cŞÜ
[
i
][
Ä
] = 
n
;

3604 
n
 = 0;

3605 
i
 = 0; i < 8; i++)

3606 ià(
©Œ2cŞÜ
[
i
][0] ||‡ttr2color[i][1] ||‡ttr2color[i][2] ||‡ttr2color[i][3])

3607 
n
 |ğ1 << 
i
;

3608 
Ç‰r2cŞÜ
 = 
n
;

3611 
RC_SORENDITION
:

3612 
i
 = 0;

3613 ià(*
¬gs
)

3615 
i
 = 
	`P¬£A‰rCŞÜ
(*
¬gs
,‡rgs[1], 1);

3616 ià(
i
 == -1)

3618 
	`AµlyA‰rCŞÜ
(
i
, &
mch¬_so
);

3619 
	`debug2
("--> %x %x\n", 
mch¬_so
.
©Œ
, mch¬_so.
cŞÜ
);

3621 ià(
msgok
)

3622 #ifdeà
COLOR


3623 
	`Msg
(0, "Sndouˆ©Œibu‹ 0x%02x cŞÜ 0x%02x", ()
mch¬_so
.
©Œ
, 0x99 ^ ()mch¬_so.
cŞÜ
);

3625 
	`Msg
(0, "Sndouˆ©Œibu‹ 0x%02x ", ()
mch¬_so
.
©Œ
);

3629 
RC_SOURCE
:

3630 
	`do_sourû
(*
¬gs
);

3633 #ifdeà
MULTIUSER


3634 
RC_SU
:

3635 
s
 = 
NULL
;

3636 ià(!*
¬gs
)

3638 
	`Msg
(0, "%s:% sü“Àlogš", 
Ho¡Name
, 
SockP©h
);

3639 
	`IÅutSu
(
D_fÜe
, &
D_u£r
, 
NULL
);

3641 ià(!
¬gs
[1])

3642 
	`IÅutSu
(
D_fÜe
, &
D_u£r
, 
¬gs
[0]);

3643 ià(!
¬gs
[2])

3644 
s
 = 
	`DoSu
(&
D_u£r
, 
¬gs
[0],‡rgs[1], "\377");

3646 
s
 = 
	`DoSu
(&
D_u£r
, 
¬gs
[0],‡rgs[1],‡rgs[2]);

3647 ià(
s
)

3648 
	`Msg
(0, "%s", 
s
);

3651 
RC_SPLIT
:

3652 
	`AddCªvas
();

3653 
	`Aùiv©e
(-1);

3655 
RC_REMOVE
:

3656 
	`RemCªvas
();

3657 
	`Aùiv©e
(-1);

3659 
RC_ONLY
:

3660 
	`OÃCªvas
();

3661 
	`Aùiv©e
(-1);

3663 
RC_FIT
:

3664 
D_fÜecv
->
c_xoff
 = D_fÜecv->
c_xs
;

3665 
D_fÜecv
->
c_yoff
 = D_fÜecv->
c_ys
;

3666 
	`R‘hškV›wpÜtOff£ts
(
D_fÜecv
);

3667 
	`ResizeLay”
(
D_fÜecv
->
c_Ïy”
, D_fÜecv->
c_xe
 - D_fÜecv->
c_xs
 + 1, D_fÜecv->
c_ye
 - D_fÜecv->
c_ys
 + 1, 0);

3668 
æay”
 = 
D_fÜecv
->
c_Ïy”
;

3669 
	`LayS‘CursÜ
();

3671 
RC_FOCUS
:

3672 ià(!*
¬gs
 || !
	`¡rcmp
(*args, "down"))

3673 
D_fÜecv
 = D_fÜecv->
c_Ãxt
 ? D_fÜecv->c_Ãxˆ: 
D_cvli¡
;

3674 ià(!
	`¡rcmp
(*
¬gs
, "up"))

3676 
ÿnvas
 *
cv
;

3677 
cv
 = 
D_cvli¡
; cv->
c_Ãxt
 && cv->c_Ãxˆ!ğ
D_fÜecv
; cv = cv->c_next)

3679 
D_fÜecv
 = 
cv
;

3681 ià(!
	`¡rcmp
(*
¬gs
, "top"))

3682 
D_fÜecv
 = 
D_cvli¡
;

3683 ià(!
	`¡rcmp
(*
¬gs
, "bottom"))

3685 
ÿnvas
 *
cv
;

3686 
cv
 = 
D_cvli¡
; cv->
c_Ãxt
; cv = cv->c_next)

3688 
D_fÜecv
 = 
cv
;

3692 
	`Msg
(0, "%s: u§ge: focu [up|down|tİ|bÙtom]", 
rc_Çme
);

3695 
fÜe
 = 
D_fÜe
 = 
	`Lay”2Wšdow
(
D_fÜecv
->
c_Ïy”
);

3696 
æay”
 = 
D_fÜecv
->
c_Ïy”
;

3697 #ifdeà
RXVT_OSC


3698 ià(
D_x‹rmosc
[2] || D_xtermosc[3])

3700 
	`Aùiv©e
(-1);

3704 
	`ReäeshHStus
();

3705 #ifdeà
RXVT_OSC


3706 
	`ReäeshX‹rmOSC
();

3708 
æay”
 = 
D_fÜecv
->
c_Ïy”
;

3709 
	`CV_CALL
(
D_fÜecv
, 
	`LayRe¡Üe
();
	`LayS‘CursÜ
());

3710 
	`WšdowChªged
(0, 'F');

3712 
RC_RESIZE
:

3713 ià(*
¬gs
)

3714 
	`ResizeRegiÚs
(*
¬gs
);

3716 
	`IÅut
("»siz#†šes: ", 20, 
INP_COOKED
, 
ResizeFš
, (*)0);

3718 
RC_SETSID
:

3719 ()
	`P¬£Sw™ch
(
aù
, &
£·¿‹_sids
);

3721 
RC_EVAL
:

3722 ; *
¬gs
;‡rgs++)

3724 *
ss
 = 
	`SaveSŒ
(*
¬gs
);

3725 ià(*
ss
)

3726 
	`CŞÚfš
(
ss
, 
	`¡¾’
(ss), (*)0);

3727 
	`ä“
(
ss
);

3730 
RC_ALTSCREEN
:

3731 ()
	`P¬£Sw™ch
(
aù
, &
u£_®tsü“n
);

3732 ià(
msgok
)

3733 
	`Msg
(0, "WÈ%sdØ®‹º©sü“Àsw™chšg", 
u£_®tsü“n
 ? "" : "not ");

3735 
RC_MAXWIN
:

3736 ià(
	`P¬£Num
(
aù
, &
n
))

3738 ià(
n
 < 1)

3739 
	`Msg
(0, "illegal maxwin‚umber specified");

3740 ià(
n
 > 
maxwš
)

3741 
	`Msg
(0, "may only decrease maxwin‚umber");

3743 
maxwš
 = 
n
;

3745 
RC_BACKTICK
:

3746 ià(
	`P¬£Ba£
(
aù
, *
¬gs
, &
n
, 10, "decimal"))

3748 ià(!
¬gs
[1])

3749 
	`£tbacktick
(
n
, 0, 0, (**)0);

3752 
liã¥ª
, 
tick
;

3753 ià(
¬gc
 < 4)

3755 
	`Msg
(0, "%s: u§ge: backtick‚um [liã¥ªick cmd‡rgs...]", 
rc_Çme
);

3758 ià(
	`P¬£Ba£
(
aù
, 
¬gs
[1], &
liã¥ª
, 10, "decimal"))

3760 ià(
	`P¬£Ba£
(
aù
, 
¬gs
[2], &
tick
, 10, "decimal"))

3762 
	`£tbacktick
(
n
, 
liã¥ª
, 
tick
, 
	`SaveArgs
(
¬gs
 + 3));

3764 
	`WšdowChªged
(0, '`');

3766 
RC_BLANKER
:

3767 #ifdeà
BLANKER_PRG


3768 ià(
bÏnk”´g
)

3770 
	`RunBÏnk”
(
bÏnk”´g
);

3774 
	`CË¬AÎ
();

3775 
	`CursÜVisib™y
(-1);

3776 
D_blocked
 = 4;

3778 #ifdeà
BLANKER_PRG


3779 
RC_BLANKERPRG
:

3780 ià(
bÏnk”´g
)

3782 **
µ
;

3783 
µ
 = 
bÏnk”´g
; *pp;…p++)

3784 
	`ä“
(*
µ
);

3785 
	`ä“
(
bÏnk”´g
);

3786 
bÏnk”´g
 = 0;

3788 ià(
¬gs
[0][0])

3789 
bÏnk”´g
 = 
	`SaveArgs
(
¬gs
);

3792 
RC_IDLE
:

3793 ià(*
¬gs
)

3795 
di¥Ïy
 *
Şddi¥Ïy
 = display;

3796 ià(!
	`¡rcmp
(*
¬gs
, "off"))

3797 
idËtimo
 = 0;

3798 ià(
¬gs
[0][0])

3799 
idËtimo
 = 
	`©oi
(*
¬gs
) * 1000;

3800 ià(
¬gc
 > 1)

3802 ià((
i
 = 
	`FšdCommÄ
(
¬gs
[1])è=ğ
RC_ILLEGAL
)

3804 
	`Msg
(0, "%s: idË: unknowÀcommªd '%s'", 
rc_Çme
, 
¬gs
[1]);

3807 ià(
	`CheckArgNum
(
i
, 
¬gs
 + 2) < 0)

3809 
	`CË¬AùiÚ
(&
idËaùiÚ
);

3810 
	`SaveAùiÚ
(&
idËaùiÚ
, 
i
, 
¬gs
 + 2, 
¬gl
 + 2);

3812 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

3813 
	`Re£tIdË
();

3814 
di¥Ïy
 = 
Şddi¥Ïy
;

3816 ià(
msgok
)

3818 ià(
idËtimo
)

3819 
	`Msg
(0, "idËimeouˆ%ds, %s", 
idËtimo
 / 1000, 
comms
[
idËaùiÚ
.
Ä
].
Çme
);

3821 
	`Msg
(0, "idle off");

3825 #ifdeà
HAVE_BRAILLE


3827 
	`DoB¿ËAùiÚ
(
aù
, 
key
 =ğ-2 ? 0 : 
msgok
);

3831 ià(
di¥Ïy
 !ğ
odi¥Ïy
)

3833 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

3834 ià(
di¥Ïy
 =ğ
odi¥Ïy
)

3837 
	}
}

3840 
	$DoCommªd
(
¬gv
, 
¬gl
)

3841 **
¬gv
;

3842 *
¬gl
;

3844 
aùiÚ
 
aù
;

3846 ià((
aù
.
Ä
 = 
	`FšdCommÄ
(*
¬gv
)è=ğ
RC_ILLEGAL
)

3848 
	`Msg
(0, "%s: unknowÀcommªd '%s'", 
rc_Çme
, *
¬gv
);

3851 
aù
.
¬gs
 = 
¬gv
 + 1;

3852 
aù
.
¬gl
 =‡rgl + 1;

3853 
	`DoAùiÚ
(&
aù
, -1);

3854 
	}
}

3857 
	$SaveAùiÚ
(
aù
, 
Ä
, 
¬gs
, 
¬gl
)

3858 
aùiÚ
 *
aù
;

3859 
Ä
;

3860 **
¬gs
;

3861 *
¬gl
;

3863 
¬gc
 = 0;

3864 **
µ
;

3865 *
Í
;

3867 ià(
¬gs
)

3868 
¬gs
[
¬gc
])

3869 
¬gc
++;

3870 ià(
¬gc
 == 0)

3872 
aù
->
Ä
 =‚r;

3873 
aù
->
¬gs
 = 
nßrgs
;

3874 
aù
->
¬gl
 = 0;

3877 ià((
µ
 = (**)
	`m®loc
(()(
¬gc
 + 1) * (**))) == 0)

3878 
	`Pªic
(0, 
¡ºomem
);

3879 ià((
Í
 = (*)
	`m®loc
(()(
¬gc
) * (*))) == 0)

3880 
	`Pªic
(0, 
¡ºomem
);

3881 
aù
->
Ä
 =‚r;

3882 
aù
->
¬gs
 = 
µ
;

3883 
aù
->
¬gl
 = 
Í
;

3884 
¬gc
--)

3886 *
Í
 = 
¬gl
 ? *¬gl++ : ()
	`¡¾’
(*
¬gs
);

3887 *
µ
++ = 
	`SaveSŒn
(*
¬gs
++, *
Í
++);

3889 *
µ
 = 0;

3890 
	}
}

3893 
	$SaveArgs
(
¬gs
)

3894 **
¬gs
;

3896 **
­
, **
µ
;

3897 
¬gc
 = 0;

3899 
¬gs
[
¬gc
])

3900 
¬gc
++;

3901 ià((
µ
 = 
­
 = (**)
	`m®loc
(()(
¬gc
 + 1) * (**))) == 0)

3902 
	`Pªic
(0, 
¡ºomem
);

3903 
¬gc
--)

3904 *
µ
++ = 
	`SaveSŒ
(*
¬gs
++);

3905 *
µ
 = 0;

3906  
­
;

3907 
	}
}

3920 
	$P¬£
(
buf
, 
buæ
, 
¬gs
, 
¬gl
)

3921 *
buf
, **
¬gs
;

3922 
buæ
, *
¬gl
;

3924 *
p
 = 
buf
, **
­
 = 
¬gs
, *
µ
;

3925 
d–im
, 
¬gc
;

3926 *
Í
 = 
¬gl
;

3928 
	`debug2
("P¬£ %d %s\n", 
buæ
, 
buf
);

3929 
¬gc
 = 0;

3930 
µ
 = 
buf
;

3931 
d–im
 = 0;

3934 *
p
 && (*p == ' ' || *p == '\t'))

3935 ++
p
;

3936 #ifdeà
PSEUDOS


3937 ià(
¬gc
 =ğ0 && *
p
 == '!')

3939 *
­
++ = "exec";

3940 *
Í
++ = 4;

3941 
p
++;

3942 
¬gc
++;

3946 ià(*
p
 == '\0' || *p == '#' || *p == '\n')

3948 *
p
 = '\0';

3949 
d–im
 = 0; d–im < 
¬gc
; delim++)

3950 
	`debug1
("-- %s\n", 
¬gs
[
d–im
]);

3951 
¬gs
[
¬gc
] = 0;

3952  
¬gc
;

3954 ià(++
¬gc
 >ğ
MAXARGS
)

3956 
	`Msg
(0, "%s:oØmªyok’s.", 
rc_Çme
);

3959 *
­
++ = 
µ
;

3961 
	`debug1
("-‚ew‡rg %s\n", 
p
);

3962 *
p
)

3964 ià(*
p
 =ğ
d–im
)

3965 
d–im
 = 0;

3966 ià(
d–im
 !ğ'\'' && *
p
 == '\\' && (p[1] == '\'' ||…[1] == '"' ||…[1] == '\\' ||…[1] == '$' ||…[1] == '#' ||…[1] == '^' || (p[1] >= '0' &&…[1] <= '7')))

3968 
p
++;

3969 ià(*
p
 >= '0' && *p <= '7')

3971 *
µ
 = *
p
 - '0';

3972 ià(
p
[1] >= '0' &&…[1] <= '7')

3974 
p
++;

3975 *
µ
 = (*µ << 3è| (*
p
 - '0');

3976 ià(
p
[1] >= '0' &&…[1] <= '7')

3978 
p
++;

3979 *
µ
 = (*µ << 3è| (*
p
 - '0');

3982 
µ
++;

3985 *
µ
++ = *
p
;

3987 ià(
d–im
 !ğ'\'' && *
p
 == '$' && (p[1] == '{' ||…[1] == ':' || (p[1] >= 'a' &&…[1] <= 'z') || (p[1] >= 'A' &&…[1] <= 'Z') || (p[1] >= '0' &&…[1] <= '9') ||…[1] == '_'))

3990 *
ps
, *
³
, 
İ
, *
v
, 
xbuf
[11];

3991 
vl
;

3993 
ps
 = ++
p
;

3994 
	`debug1
("- v¬ %s\n", 
ps
);

3995 
p
++;

3996 *
p
)

3998 ià(*
ps
 =ğ'{' && *
p
 == '}')

4000 ià(*
ps
 =ğ':' && *
p
 == ':')

4002 ià(*
ps
 !ğ'{' && *p !ğ':' && (*
p
 < 'a' || *p > 'z') && (*p < 'A' || *p > 'Z') && (*p < '0' || *p > '9') && *p != '_')

4004 
p
++;

4006 
³
 = 
p
;

4007 ià(*
ps
 == '{' || *ps == ':')

4009 ià(!*
p
)

4011 
	`Msg
(0, "%s: bad v¬ŸbË‚ame.", 
rc_Çme
);

4014 
p
++;

4016 
İ
 = *
³
;

4017 *
³
 = 0;

4018 
	`debug1
("- v¬ i '%s'\n", 
ps
);

4019 ià(*
ps
 == ':')

4020 
v
 = 
	`g‘‹rmÿp¡ršg
(
ps
 + 1);

4023 ià(*
ps
 == '{')

4024 
ps
++;

4025 
v
 = 
xbuf
;

4026 ià(!
	`¡rcmp
(
ps
, "TERM"))

4027 
v
 = 
di¥Ïy
 ? 
D_‹rmÇme
 : "unknown";

4028 ià(!
	`¡rcmp
(
ps
, "COLUMNS"))

4029 
	`¥rštf
(
xbuf
, "%d", 
di¥Ïy
 ? 
D_width
 : -1);

4030 ià(!
	`¡rcmp
(
ps
, "LINES"))

4031 
	`¥rštf
(
xbuf
, "%d", 
di¥Ïy
 ? 
D_height
 : -1);

4033 
v
 = 
	`g‘’v
(
ps
);

4035 *
³
 = 
İ
;

4036 
vl
 = 
v
 ? 
	`¡¾’
(v) : 0;

4037 ià(
vl
)

4039 
	`debug1
("- sub i '%s'\n", 
v
);

4040 ià(
p
 - 
µ
 < 
vl
)

4042 
right
 = 
buf
 + 
buæ
 - (
p
 + 
	`¡¾’
(p) + 1);

4043 ià(
right
 > 0)

4045 
	`bcİy
(
p
,… + 
right
, 
	`¡¾’
(p) + 1);

4046 
p
 +ğ
right
;

4049 ià(
p
 - 
µ
 < 
vl
)

4051 
	`Msg
(0, "%s:‚Ø¥aû†eá fÜ v¬ŸbËƒx·nsiÚ.", 
rc_Çme
);

4054 
	`bcİy
(
v
, 
µ
, 
vl
);

4055 
µ
 +ğ
vl
;

4059 ià(
d–im
 !ğ'\'' && *
p
 == '^' &&…[1])

4061 
p
++;

4062 *
µ
++ = *
p
 == '?' ? '\177' : *p & 0x1f;

4064 ià(
d–im
 =ğ0 && (*
p
 == '\'' || *p == '"'))

4065 
d–im
 = *
p
;

4066 ià(
d–im
 =ğ0 && (*
p
 == ' ' || *p == '\t' || *p == '\n'))

4069 *
µ
++ = *
p
;

4070 
p
++;

4072 ià(
d–im
)

4074 
	`Msg
(0, "%s: Missšg %øquÙe.", 
rc_Çme
, 
d–im
);

4077 ià(*
p
)

4078 
p
++;

4079 *
µ
 = 0;

4080 
	`debug2
("-‡rg dÚe, '%s'„e¡ %s\n", 
­
[-1], 
p
);

4081 *
Í
++ = 
µ
 - 
­
[-1];

4082 
µ
++;

4084 
	}
}

4087 
	$S‘Esÿ³
(
u
, 
e
, 
me
)

4088 
aşu£r
 *
u
;

4089 
e
, 
me
;

4091 ià(
u
)

4093 
u
->
u_Esc
 = 
e
;

4094 
u
->
u_M‘aEsc
 = 
me
;

4098 ià(
u£rs
)

4100 ià(
DeçuÉEsc
 >= 0)

4101 
	`CË¬AùiÚ
(&
kb
[
DeçuÉEsc
]);

4102 ià(
DeçuÉM‘aEsc
 >= 0)

4103 
	`CË¬AùiÚ
(&
kb
[
DeçuÉM‘aEsc
]);

4105 
DeçuÉEsc
 = 
e
;

4106 
DeçuÉM‘aEsc
 = 
me
;

4107 ià(
u£rs
)

4109 ià(
DeçuÉEsc
 >= 0)

4111 
	`CË¬AùiÚ
(&
kb
[
DeçuÉEsc
]);

4112 
kb
[
DeçuÉEsc
].
Ä
 = 
RC_OTHER
;

4114 ià(
DeçuÉM‘aEsc
 >= 0)

4116 
	`CË¬AùiÚ
(&
kb
[
DeçuÉM‘aEsc
]);

4117 
kb
[
DeçuÉM‘aEsc
].
Ä
 = 
RC_META
;

4121 
	}
}

4124 
	$P¬£Sw™ch
(
aù
, 
v¬
)

4125 
aùiÚ
 *
aù
;

4126 *
v¬
;

4128 ià(*
aù
->
¬gs
 == 0)

4130 *
v¬
 ^= 1;

4133  
	`P¬£OnOff
(
aù
, 
v¬
);

4134 
	}
}

4137 
	$P¬£OnOff
(
aù
, 
v¬
)

4138 
aùiÚ
 *
aù
;

4139 *
v¬
;

4141 
num
 = -1;

4142 **
¬gs
 = 
aù
->args;

4144 ià(
¬gs
[1] == 0)

4146 ià(
	`¡rcmp
(
¬gs
[0], "on") == 0)

4147 
num
 = 1;

4148 ià(
	`¡rcmp
(
¬gs
[0], "off") == 0)

4149 
num
 = 0;

4151 ià(
num
 < 0)

4153 
	`Msg
(0, "%s: %s: inv®id‡rgum’t. Giv'Ú' o¸'off'", 
rc_Çme
, 
comms
[
aù
->
Ä
].
Çme
);

4156 *
v¬
 = 
num
;

4158 
	}
}

4161 
	$P¬£SaveSŒ
(
aù
, 
v¬
)

4162 
aùiÚ
 *
aù
;

4163 **
v¬
;

4165 **
¬gs
 = 
aù
->args;

4166 ià(*
¬gs
 == 0 ||‡rgs[1])

4168 
	`Msg
(0, "%s: %s: oÃ‡rgum’ˆ»quœed.", 
rc_Çme
, 
comms
[
aù
->
Ä
].
Çme
);

4171 ià(*
v¬
)

4172 
	`ä“
(*
v¬
);

4173 *
v¬
 = 
	`SaveSŒ
(*
¬gs
);

4175 
	}
}

4178 
	$P¬£Num
(
aù
, 
v¬
)

4179 
aùiÚ
 *
aù
;

4180 *
v¬
;

4182 
i
;

4183 *
p
, **
¬gs
 = 
aù
->args;

4185 
p
 = *
¬gs
;

4186 ià(
p
 =ğ0 || *°=ğ0 || 
¬gs
[1])

4188 
	`Msg
(0, "%s: %s: invalid‡rgument. Give one‡rgument.",

4189 
rc_Çme
, 
comms
[
aù
->
Ä
].
Çme
);

4192 
i
 = 0;

4193 *
p
)

4195 ià(*
p
 >= '0' && *p <= '9')

4196 
i
 = 10 * i + (*
p
 - '0');

4199 
	`Msg
(0, "%s: %s: invalid‡rgument. Give‚umeric‡rgument.",

4200 
rc_Çme
, 
comms
[
aù
->
Ä
].
Çme
);

4203 
p
++;

4205 
	`debug1
("P¬£Num gÙ %d\n", 
i
);

4206 *
v¬
 = 
i
;

4208 
	}
}

4211 
	$P¬£Num1000
(
aù
, 
v¬
)

4212 
aùiÚ
 *
aù
;

4213 *
v¬
;

4215 
i
;

4216 *
p
, **
¬gs
 = 
aù
->args;

4217 
dig
 = 0;

4219 
p
 = *
¬gs
;

4220 ià(
p
 =ğ0 || *°=ğ0 || 
¬gs
[1])

4222 
	`Msg
(0, "%s: %s: invalid‡rgument. Give one‡rgument.",

4223 
rc_Çme
, 
comms
[
aù
->
Ä
].
Çme
);

4226 
i
 = 0;

4227 *
p
)

4229 ià(*
p
 >= '0' && *p <= '9')

4231 ià(
dig
 < 4)

4232 
i
 = 10 * i + (*
p
 - '0');

4233 ià(
dig
 =ğ4 && *
p
 >= '5')

4234 
i
++;

4235 ià(
dig
)

4236 
dig
++;

4238 ià(*
p
 =ğ'.' && !
dig
)

4239 
dig
++;

4242 
	`Msg
(0, "%s: %s: invalid‡rgument. Give floating…oint‡rgument.",

4243 
rc_Çme
, 
comms
[
aù
->
Ä
].
Çme
);

4246 
p
++;

4248 ià(
dig
 == 0)

4249 
i
 *= 1000;

4251 
dig
++ < 4)

4252 
i
 *= 10;

4253 ià(
i
 < 0)

4254 
i
 = ()(()~0 >> 1);

4255 
	`debug1
("P¬£Num1000 gÙ %d\n", 
i
);

4256 *
v¬
 = 
i
;

4258 
	}
}

4260 
wš
 *

4261 
	$WšdowByName
(
s
)

4262 *
s
;

4264 
wš
 *
p
;

4266 
p
 = 
wšdows
;…;… =…->
w_Ãxt
)

4267 ià(!
	`¡rcmp
(
p
->
w_t™Ë
, 
s
))

4268  
p
;

4269 
p
 = 
wšdows
;…;… =…->
w_Ãxt
)

4270 ià(!
	`¡ºcmp
(
p
->
w_t™Ë
, 
s
, 
	`¡¾’
(s)))

4271  
p
;

4273 
	}
}

4276 
	$WšdowByNumb”
(
¡r
)

4277 *
¡r
;

4279 
i
;

4280 *
s
;

4282 
i
 = 0, 
s
 = 
¡r
; *s; s++)

4284 ià(*
s
 < '0' || *s > '9')

4286 
i
 = i * 10 + (*
s
 - '0');

4288  *
s
 ? -1 : 
i
;

4289 
	}
}

4297 
	$WšdowByNoN
(
¡r
)

4298 *
¡r
;

4300 
i
;

4301 
wš
 *
p
;

4303 ià((
i
 = 
	`WšdowByNumb”
(
¡r
)è< 0 || i >ğ
MAXWIN
)

4305 ià((
p
 = 
	`WšdowByName
(
¡r
)))

4306  
p
->
w_numb”
;

4309  
i
;

4310 
	}
}

4313 
	$P¬£WšNum
(
aù
, 
v¬
)

4314 
aùiÚ
 *
aù
;

4315 *
v¬
;

4317 **
¬gs
 = 
aù
->args;

4318 
i
 = 0;

4320 ià(*
¬gs
 == 0 ||‡rgs[1])

4322 
	`Msg
(0, "%s: %s: oÃ‡rgum’ˆ»quœed.", 
rc_Çme
, 
comms
[
aù
->
Ä
].
Çme
);

4326 
i
 = 
	`WšdowByNoN
(*
¬gs
);

4327 ià(
i
 < 0)

4329 
	`Msg
(0, "%s: %s: invalid‡rgument. Give window‚umber or‚ame.",

4330 
rc_Çme
, 
comms
[
aù
->
Ä
].
Çme
);

4333 
	`debug1
("P¬£WšNum gÙ %d\n", 
i
);

4334 *
v¬
 = 
i
;

4336 
	}
}

4339 
	$P¬£Ba£
(
aù
, 
p
, 
v¬
, 
ba£
, 
bÇme
)

4340 
aùiÚ
 *
aù
;

4341 *
p
;

4342 *
v¬
;

4343 
ba£
;

4344 *
bÇme
;

4346 
i
 = 0;

4347 
c
;

4349 ià(*
p
 == 0)

4351 
	`Msg
(0, "%s: %s:ƒm±y‡rgum’t.", 
rc_Çme
, 
comms
[
aù
->
Ä
].
Çme
);

4354 (
c
 = *
p
++))

4356 ià(
c
 >= 'a' && c <= 'z')

4357 
c
 -= 'a' - 'A';

4358 ià(
c
 >= 'A' && c <= 'Z')

4359 
c
 -= 'A' - ('0' + 10);

4360 
c
 -= '0';

4361 ià(
c
 < 0 || c >ğ
ba£
)

4363 
	`Msg
(0, "%s: %s:‡rgum’ˆi nÙ %s.", 
rc_Çme
, 
comms
[
aù
->
Ä
].
Çme
, 
bÇme
);

4366 
i
 = 
ba£
 * i + 
c
;

4368 
	`debug1
("P¬£Ba£ gÙ %d\n", 
i
);

4369 *
v¬
 = 
i
;

4371 
	}
}

4374 
	$IsNum
(
s
, 
ba£
)

4375 *
s
;

4376 
ba£
;

4378 
ba£
 +ğ'0'; *
s
; ++s)

4379 ià(*
s
 < '0' || * > 
ba£
)

4382 
	}
}

4385 
	$IsNumCŞÚ
(
s
, 
ba£
, 
p
, 
psize
)

4386 
ba£
, 
psize
;

4387 *
s
, *
p
;

4389 *
q
;

4390 ià((
q
 = 
	`ršdex
(
s
, ':')) != 0)

4392 
	`¡ºıy
(
p
, 
q
 + 1, 
psize
 - 1);

4393 
p
[
psize
 - 1] = '\0';

4394 *
q
 = '\0';

4397 *
p
 = '\0';

4398  
	`IsNum
(
s
, 
ba£
);

4399 
	}
}

4402 
	$Sw™chWšdow
(
n
)

4403 
n
;

4405 
wš
 *
p
;

4407 
	`debug1
("Sw™chWšdow %d\n", 
n
);

4408 ià(
n
 < 0 ||‚ >ğ
MAXWIN
)

4410 
	`ShowWšdows
(-1);

4413 ià((
p
 = 
wb
[
n
]) == 0)

4415 
	`ShowWšdows
(
n
);

4418 ià(
di¥Ïy
 == 0)

4420 
fÜe
 = 
p
;

4423 ià(
p
 =ğ
D_fÜe
)

4425 
	`Msg
(0, "Thi IS wšdow %d (%s).", 
n
, 
p
->
w_t™Ë
);

4428 #ifdeà
MULTIUSER


4429 ià(
	`AşCheckP”mWš
(
D_u£r
, 
ACL_READ
, 
p
))

4431 
	`Msg
(0, "Acûs tØwšdow %d d’›d.", 
p
->
w_numb”
);

4435 
	`S‘FÜeWšdow
(
p
);

4436 
	`Aùiv©e
(
fÜe
->
w_nÜeäesh
);

4437 
	}
}

4441 
	$S‘CªvasWšdow
(
cv
, 
wi
)

4442 
ÿnvas
 *
cv
;

4443 
wš
 *
wi
;

4445 
wš
 *
p
 = 0, **
µ
;

4446 
Ïy”
 *
l
;

4447 
ÿnvas
 *
cvp
, **
cvµ
;

4449 
l
 = 
cv
->
c_Ïy”
;

4450 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

4452 ià(
l
)

4455 
cvµ
 = &
l
->
l_cvli¡
; (
cvp
 = *cvµ); cvµ = &cvp->
c_Êext
)

4456 ià(
cvp
 =ğ
cv
)

4458 
	`ASSERT
(
cvp
);

4459 *
cvµ
 = 
cvp
->
c_Êext
;

4461 
p
 = 
	`Lay”2Wšdow
(
l
);

4462 
l
 = 
cv
->
c_Ïy”
;

4463 
cv
->
c_Ïy”
 = 0;

4465 ià(
p
 && 
cv
 =ğ
D_fÜecv
)

4467 #ifdeà
MULTIUSER


4468 
	`R–—£AutoWr™–ock
(
di¥Ïy
, 
p
);

4470 ià(
p
->
w_s’û
)

4472 
	`S‘Timeout
(&
p
->
w_s’ûev
,…->
w_s’ûwa™
 * 1000);

4473 
	`ev’q
(&
p
->
w_s’ûev
);

4475 
D_Ùh”
 = 
fÜe
;

4476 
D_fÜe
 = 0;

4478 ià(
l
->
l_cvli¡
 =ğ0 && (
p
 =ğ0 ||† !ğp->
w_§v–ay”
))

4479 
	`KlLay”Chaš
(
l
);

4483 ià(
wi
)

4485 
l
 = &
wi
->
w_Ïy”
;

4486 ià(
wi
->
w_§v–ay”
 && (wi->
w_blocked
 || wi->w_§v–ay”->
l_cvli¡
 == 0))

4487 
l
 = 
wi
->
w_§v–ay”
;

4490 
l
 = &
cv
->
c_bÏnk
;

4493 
cv
->
c_Êext
 = 
l
->
l_cvli¡
;

4494 
l
->
l_cvli¡
 = 
cv
;

4495 
cv
->
c_Ïy”
 = 
l
;

4496 
cv
->
c_xoff
 = cv->
c_xs
;

4497 
cv
->
c_yoff
 = cv->
c_ys
;

4498 
	`R‘hškV›wpÜtOff£ts
(
cv
);

4500 ià(
æay”
 == 0)

4501 
æay”
 = 
l
;

4503 ià(
wi
 && 
D_Ùh”
 == wi)

4504 
D_Ùh”
 = 
wi
->
w_Ãxt
;

4505 ià(
cv
 =ğ
D_fÜecv
)

4507 
D_fÜe
 = 
wi
;

4508 
fÜe
 = 
D_fÜe
;

4509 ià(
wi
)

4511 #ifdeà
MULTIUSER


4512 
	`ObšAutoWr™–ock
(
di¥Ïy
, 
wi
);

4517 ià(
wšdows
 !ğ
wi
)

4519 
µ
 = &
wšdows
; (
p
 = *µ);…°ğ&p->
w_Ãxt
)

4520 ià(
p
 =ğ
wi
)

4522 
	`ASSERT
(
p
);

4523 *
µ
 = 
p
->
w_Ãxt
;

4524 
p
->
w_Ãxt
 = 
wšdows
;

4525 
wšdows
 = 
p
;

4526 
	`WLi¡LškChªged
();

4530 
	}
}

4538 
	$S‘FÜeWšdow
(
wi
)

4539 
wš
 *
wi
;

4541 
wš
 *
p
;

4542 ià(
di¥Ïy
 == 0)

4544 
fÜe
 = 
wi
;

4547 
p
 = 
	`Lay”2Wšdow
(
D_fÜecv
->
c_Ïy”
);

4548 
	`S‘CªvasWšdow
(
D_fÜecv
, 
wi
);

4549 ià(
p
)

4550 
	`WšdowChªged
(
p
, 'u');

4551 ià(
wi
)

4552 
	`WšdowChªged
(
wi
, 'u');

4553 
æay”
 = 
D_fÜecv
->
c_Ïy”
;

4555 
	}
}

4565 
	$Aùiv©e
(
nÜeäesh
)

4566 
nÜeäesh
;

4568 
	`debug1
("Aùiv©e(%d)\n", 
nÜeäesh
);

4569 ià(
di¥Ïy
 == 0)

4571 ià(
D_¡©us
)

4573 
	`Msg
(0, "%s", "");

4574 
	`RemoveStus
();

4577 ià(
	`MayResizeLay”
(
D_fÜecv
->
c_Ïy”
))

4578 
	`ResizeLay”
(
D_fÜecv
->
c_Ïy”
, D_fÜecv->
c_xe
 - D_fÜecv->
c_xs
 + 1, D_fÜecv->
c_ye
 - D_fÜecv->
c_ys
 + 1, 
di¥Ïy
);

4580 
fÜe
 = 
D_fÜe
;

4581 ià(
fÜe
)

4584 ià(
fÜe
->
w_mÚ™Ü
 !ğ
MON_OFF
)

4585 
fÜe
->
w_mÚ™Ü
 = 
MON_ON
;

4586 
fÜe
->
w_b–l
 = 
BELL_ON
;

4587 
	`WšdowChªged
(
fÜe
, 'f');

4590 ià(
	`ResizeDi¥Ïy
(
fÜe
->
w_width
, fÜe->
w_height
))

4592 
	`debug2
("CªnÙ„esizäom (%d,%d)", 
D_width
, 
D_height
);

4593 
	`debug2
("Ø(%d,%dè->„esizwšdow\n", 
fÜe
->
w_width
, fÜe->
w_height
);

4594 
	`DoResize
(
D_width
, 
D_height
);

4598 
	`Redi¥Ïy
(
nÜeäesh
 + 
®l_nÜeäesh
);

4599 
	}
}

4603 
	$NextWšdow
()

4605 
wš
 **
µ
;

4606 
n
 = 
fÜe
 ? fÜe->
w_numb”
 : -1;

4608 
µ
 = 
wb
 + 
n
 + 1;…p != wtab +‚;…p++)

4610 ià(
µ
 =ğ
wb
 + 
MAXWIN
)

4611 
µ
 = 
wb
;

4612 ià(*
µ
)

4615  
µ
 - 
wb
;

4616 
	}
}

4619 
	$P»viousWšdow
()

4621 
wš
 **
µ
;

4622 
n
 = 
fÜe
 ? fÜe->
w_numb”
 : 
MAXWIN
 - 1;

4624 
µ
 = 
wb
 + 
n
 - 1;…p != wtab +‚;…p--)

4626 ià(
µ
 < 
wb
)

4627 
µ
 = 
wb
 + 
MAXWIN
 - 1;

4628 ià(*
µ
)

4631  
µ
 - 
wb
;

4632 
	}
}

4635 
	$MÜeWšdows
()

4637 *
m
 = "No other window.";

4638 ià(
wšdows
 && (
fÜe
 =ğ0 || wšdows->
w_Ãxt
))

4640 ià(
fÜe
 == 0)

4642 
	`Msg
(0, "No window‡vailable");

4645 
	`Msg
(0, 
m
, 
fÜe
->
w_numb”
);

4647 
	}
}

4650 
	$KlWšdow
(
wi
)

4651 
wš
 *
wi
;

4653 
wš
 **
µ
, *
p
;

4654 
ÿnvas
 *
cv
;

4655 
gÙÚe
;

4660 
µ
 = &
wšdows
; (
p
 = *µ);…°ğ&p->
w_Ãxt
)

4661 ià(
p
 =ğ
wi
)

4663 
	`ASSERT
(
p
);

4664 *
µ
 = 
p
->
w_Ãxt
;

4665 
wi
->
w_šËn
 = 0;

4666 
wb
[
wi
->
w_numb”
] = 0;

4668 ià(
wšdows
 == 0)

4670 
	`F»eWšdow
(
wi
);

4671 
	`Fš™
(0);

4677 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

4679 
gÙÚe
 = 0;

4680 
cv
 = 
D_cvli¡
; cv; cv = cv->
c_Ãxt
)

4682 ià(
	`Lay”2Wšdow
(
cv
->
c_Ïy”
è!ğ
wi
)

4685 
	`S‘CªvasWšdow
(
cv
, 
	`FšdNiûWšdow
(
D_Ùh”
, 0));

4686 
gÙÚe
 = 1;

4688 ià(
gÙÚe
)

4690 #ifdeà
ZMODEM


4691 ià(
wi
->
w_zdi¥Ïy
 =ğ
di¥Ïy
)

4693 
D_blocked
 = 0;

4694 
D_»adev
.
cÚdpos
 = D_»adev.
cÚdÃg
 = 0;

4697 
	`Aùiv©e
(-1);

4700 
	`F»eWšdow
(
wi
);

4701 
	`WšdowChªged
((
wš
 *)0, 'w');

4702 
	`WšdowChªged
((
wš
 *)0, 'W');

4703 
	`WšdowChªged
((
wš
 *)0, 0);

4704 
	}
}

4707 
	$LogToggË
(
Ú
)

4708 
Ú
;

4710 
buf
[1024];

4712 ià((
fÜe
->
w_log
 !ğ0è=ğ
Ú
)

4714 ià(
di¥Ïy
 && !*
rc_Çme
)

4715 
	`Msg
(0, "You‡» % loggšg.", 
Ú
 ? "already" : "not");

4718 ià(
fÜe
->
w_log
 != 0)

4720 
	`Msg
(0, "Logf\"%s\" clo£d.", 
fÜe
->
w_log
->
Çme
);

4721 
	`logfşo£
(
fÜe
->
w_log
);

4722 
fÜe
->
w_log
 = 0;

4723 
	`WšdowChªged
(
fÜe
, 'f');

4726 ià(
	`DoS¹Log
(
fÜe
, 
buf
, (buf)))

4728 
	`Msg
(
”ºo
, "E¼Ü o³nšg†ogf\"%s\"", 
buf
);

4731 ià(
	`á–l
(
fÜe
->
w_log
->
å
) == 0)

4732 
	`Msg
(0, "C»©šg†ogf\"%s\".", 
fÜe
->
w_log
->
Çme
);

4734 
	`Msg
(0, "Aµ’dšgØlogf\"%s\".", 
fÜe
->
w_log
->
Çme
);

4735 
	`WšdowChªged
(
fÜe
, 'f');

4736 
	}
}

4739 
	$AddWšdows
(
buf
, 
Ën
, 
æags
, 
wh”e
)

4740 *
buf
;

4741 
Ën
;

4742 
æags
;

4743 
wh”e
;

4745 *
s
, *
ss
;

4746 
wš
 **
µ
, *
p
;

4747 *
cmd
;

4748 
l
;

4750 
s
 = 
ss
 = 
buf
;

4751 
µ
 = ((
æags
 & 4è&& 
wh”e
 >ğ0è? 
wb
 + wh”+ 1: wb;…°< wb + 
MAXWIN
;…p++)

4753 ià(
µ
 - 
wb
 =ğ
wh”e
 && 
ss
 =ğ
buf
)

4754 
ss
 = 
s
;

4755 ià((
p
 = *
µ
) == 0)

4757 ià((
æags
 & 1è&& 
di¥Ïy
 && 
p
 =ğ
D_fÜe
)

4760 
cmd
 = 
p
->
w_t™Ë
;

4761 
l
 = 
	`¡¾’
(
cmd
);

4762 ià(
l
 > 20)

4763 
l
 = 20;

4764 ià(
s
 - 
buf
 + 
l
 > 
Ën
 - 24)

4766 ià(
s
 > 
buf
 || (
æags
 & 4))

4768 *
s
++ = ' ';

4769 *
s
++ = ' ';

4771 
	`¥rštf
(
s
, "%d", 
p
->
w_numb”
);

4772 ià(
p
->
w_numb”
 =ğ
wh”e
)

4773 
ss
 = 
s
;

4774 
s
 +ğ
	`¡¾’
(s);

4775 ià(
di¥Ïy
 && 
p
 =ğ
D_fÜe
)

4776 *
s
++ = '*';

4777 ià(!(
æags
 & 2))

4779 ià(
di¥Ïy
 && 
p
 =ğ
D_Ùh”
)

4780 *
s
++ = '-';

4781 
s
 = 
	`AddWšdowFÏgs
(s, 
Ën
, 
p
);

4783 *
s
++ = ' ';

4784 
	`¡ºıy
(
s
, 
cmd
, 
l
);

4785 
s
 +ğ
l
;

4787 *
s
 = 0;

4788  
ss
;

4789 
	}
}

4792 
	$AddWšdowFÏgs
(
buf
, 
Ën
, 
p
)

4793 *
buf
;

4794 
Ën
;

4795 
wš
 *
p
;

4797 *
s
 = 
buf
;

4798 ià(
p
 =ğ0 || 
Ën
 < 12)

4800 *
s
 = 0;

4801  
s
;

4804 ià(
di¥Ïy
 && 
p
 =ğ
D_fÜe
)

4805 *
s
++ = '*';

4806 ià(
di¥Ïy
 && 
p
 =ğ
D_Ùh”
)

4807 *
s
++ = '-';

4809 ià(
p
->
w_Ïy”
.
l_cvli¡
 &&…->w_Ïy”.l_cvli¡->
c_Êext
)

4810 *
s
++ = '&';

4811 ià(
p
->
w_mÚ™Ü
 =ğ
MON_DONE
)

4812 *
s
++ = '@';

4813 ià(
p
->
w_b–l
 =ğ
BELL_DONE
)

4814 *
s
++ = '!';

4815 #ifdeà
UTMPOK


4816 ià(
p
->
w_¦Ù
 !ğ(
¦Ù_t
) 0 &&…->w_slot != (slot_t) -1)

4817 *
s
++ = '$';

4819 ià(
p
->
w_log
 != 0)

4821 
	`¡rıy
(
s
, "(L)");

4822 
s
 += 3;

4824 ià(
p
->
w_±yfd
 < 0)

4825 *
s
++ = 'Z';

4826 *
s
 = 0;

4827  
s
;

4828 
	}
}

4831 
	$AddOth”U£rs
(
buf
, 
Ën
, 
p
)

4832 *
buf
;

4833 
Ën
;

4834 
wš
 *
p
;

4836 
di¥Ïy
 *
d
, *
Şddi¥Ïy
 = display;

4837 
ÿnvas
 *
cv
;

4838 *
s
;

4839 
l
;

4841 
s
 = 
buf
;

4842 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

4844 ià(
D_u£r
 =ğ
Şddi¥Ïy
->
d_u£r
)

4846 
cv
 = 
D_cvli¡
; cv; cv = cv->
c_Ãxt
)

4847 ià(
	`Lay”2Wšdow
(
cv
->
c_Ïy”
è=ğ
p
)

4849 ià(!
cv
)

4851 
d
 = 
di¥Ïys
; d && d !ğ
di¥Ïy
; d = d->
d_Ãxt
)

4852 ià(
D_u£r
 =ğ
d
->
d_u£r
)

4854 ià(
d
 && d !ğ
di¥Ïy
)

4856 ià(
Ën
 > 1 && 
s
 !ğ
buf
)

4858 *
s
++ = ',';

4859 
Ën
--;

4861 
l
 = 
	`¡¾’
(
D_u£r
->
u_Çme
);

4862 ià(
l
 + 1 > 
Ën
)

4864 
	`¡rıy
(
s
, 
D_u£r
->
u_Çme
);

4865 
s
 +ğ
l
;

4866 
Ën
 -ğ
l
;

4868 *
s
 = 0;

4869 
di¥Ïy
 = 
Şddi¥Ïy
;

4870  
s
;

4871 
	}
}

4874 
	$ShowWšdows
(
wh”e
)

4875 
wh”e
;

4877 
buf
[1024];

4878 *
s
, *
ss
;

4880 ià(!
di¥Ïy
)

4882 ià(
wh”e
 =ğ-1 && 
D_fÜe
)

4883 
wh”e
 = 
D_fÜe
->
w_numb”
;

4884 
ss
 = 
	`AddWšdows
(
buf
, (buf), 0, 
wh”e
);

4885 
s
 = 
buf
 + 
	`¡¾’
(buf);

4886 ià(
ss
 - 
buf
 > 
D_width
 / 2)

4888 
ss
 -ğ
D_width
 / 2;

4889 ià(
s
 - 
ss
 < 
D_width
)

4891 
ss
 = 
s
 - 
D_width
;

4892 ià(
ss
 < 
buf
)

4893 
ss
 = 
buf
;

4897 
ss
 = 
buf
;

4898 
	`Msg
(0, "%s", 
ss
);

4899 
	}
}

4902 
	$ShowInfo
()

4904 
buf
[512], *
p
;

4905 
wš
 *
wp
 = 
fÜe
;

4906 
i
;

4908 ià(
wp
 == 0)

4910 
	`Msg
(0, "(%d,%d)/(%d,%dènØwšdow", 
D_x
 + 1, 
D_y
 + 1, 
D_width
, 
D_height
);

4913 
p
 = 
buf
;

4914 ià(
buf
 < (
p
 +ğ
	`G‘AnsiStus
(
wp
,…)))

4915 *
p
++ = ' ';

4916 
	`¥rštf
(
p
, "(%d,%d)/(%d,%d)",

4917 
wp
->
w_x
 + 1, wp->
w_y
 + 1, wp->
w_width
, wp->
w_height
);

4918 #ifdeà
COPY_PASTE


4919 
	`¥rštf
(
p
 +ğ
	`¡¾’
Õ), "+%d", 
wp
->
w_hi¡height
);

4921 
	`¥rštf
(
p
 +ğ
	`¡¾’
(p), " %c%sflow",

4922 (
wp
->
w_æow
 & 
FLOW_NOW
) ? '+' : '-',

4923 (
wp
->
w_æow
 & 
FLOW_AUTOFLAG
) ? "" :

4924 ((
wp
->
w_æow
 & 
FLOW_AUTO
) ? "(+)" : "(-)"));

4925 ià(!
wp
->
w_w¿p
è
	`¥rštf
(
p
 +ğ
	`¡¾’
(p), " -wrap");

4926 ià(
wp
->
w_š£¹
è
	`¥rštf
(
p
 +ğ
	`¡¾’
(p), " ins");

4927 ià(
wp
->
w_Üigš
è
	`¥rštf
(
p
 +ğ
	`¡¾’
(p), " org");

4928 ià(
wp
->
w_key·d
è
	`¥rštf
(
p
 +ğ
	`¡¾’
(p), "‡pp");

4929 ià(
wp
->
w_log
è
	`¥rštf
(
p
 +ğ
	`¡¾’
(p), "†og");

4930 ià(
wp
->
w_mÚ™Ü
 !ğ
MON_OFF
è
	`¥rštf
(
p
 +ğ
	`¡¾’
(p), " mon");

4931 ià(
wp
->
w_mou£
è
	`¥rštf
(
p
 +ğ
	`¡¾’
(p), " mouse");

4932 #ifdeà
COLOR


4933 ià(
wp
->
w_bû
è
	`¥rštf
(
p
 +ğ
	`¡¾’
(p), " bce");

4935 ià(!
wp
->
w_c1
è
	`¥rštf
(
p
 +ğ
	`¡¾’
(p), " -c1");

4936 ià(
wp
->
w_nÜeäesh
è
	`¥rštf
(
p
 +ğ
	`¡¾’
(p), "‚ored");

4938 
p
 +ğ
	`¡¾’
(p);

4939 #ifdeà
FONT


4940 #ifdeà
ENCODINGS


4941 ià(
wp
->
w_’codšg
 && (
di¥Ïy
 =ğ0 || 
D_’codšg
 !ğwp->w_’codšg || 
	`EncodšgDefFÚt
(wp->w_encoding) <= 0))

4943 *
p
++ = ' ';

4944 
	`¡rıy
(
p
, 
	`EncodšgName
(
wp
->
w_’codšg
));

4945 
p
 +ğ
	`¡¾’
(p);

4947 #ifdeà
UTF8


4948 ià(
wp
->
w_’codšg
 !ğ
UTF8
)

4951 ià(
D_CC0
 || (
D_CS0
 && *D_CS0))

4953 ià(
wp
->
w_gr
 == 2)

4955 
	`¥rštf
(
p
, " G%c", 
wp
->
w_Ch¬£t
 + '0');

4956 ià(
wp
->
w_FÚtE
 >= ' ')

4957 
p
[3] = 
wp
->
w_FÚtE
;

4960 
p
[3] = '^';

4961 
p
[4] = 
wp
->
w_FÚtE
 ^ 0x40;

4962 
p
++;

4964 
p
[4] = '[';

4965 
p
++;

4967 ià(
wp
->
w_gr
)

4968 
	`¥rštf
(
p
++, " G%c%c[", 
wp
->
w_Ch¬£t
 + '0', wp->
w_Ch¬£tR
 + '0');

4970 
	`¥rštf
(
p
, " G%c[", 
wp
->
w_Ch¬£t
 + '0');

4971 
p
 += 4;

4972 
i
 = 0; i < 4; i++)

4974 ià(
wp
->
w_ch¬£ts
[
i
] =ğ
ASCII
)

4975 *
p
++ = 'B';

4976 ià(
wp
->
w_ch¬£ts
[
i
] >= ' ')

4977 *
p
++ = 
wp
->
w_ch¬£ts
[
i
];

4980 *
p
++ = '^';

4981 *
p
++ = 
wp
->
w_ch¬£ts
[
i
] ^ 0x40;

4984 *
p
++ = ']';

4985 *
p
 = 0;

4989 ià(
wp
->
w_ty³
 =ğ
W_TYPE_PLAIN
)

4992 *
p
++ = ' ';

4993 
	`TtyG‘ModemStus
(
wp
->
w_±yfd
, 
p
);

4995 #ifdeà
BUILTIN_TELNET


4996 ià(
wp
->
w_ty³
 =ğ
W_TYPE_TELNET
)

4998 *
p
++ = ' ';

4999 
	`T–Stus
(
wp
, 
p
, (
buf
) - 1 - (p - buf));

5002 
	`Msg
(0, "% %d(%s)", 
buf
, 
wp
->
w_numb”
, wp->
w_t™Ë
);

5003 
	}
}

5006 
	$ShowDInfo
()

5008 
buf
[512], *
p
;

5009 ià(
di¥Ïy
 == 0)

5011 
p
 = 
buf
;

5012 
	`¥rštf
(
p
, "(%d,%d)", 
D_width
, 
D_height
),

5013 
p
 +ğ
	`¡¾’
(p);

5014 #ifdeà
ENCODINGS


5015 ià(
D_’codšg
)

5017 *
p
++ = ' ';

5018 
	`¡rıy
(
p
, 
	`EncodšgName
(
D_’codšg
));

5019 
p
 +ğ
	`¡¾’
(p);

5022 ià(
D_CXT
)

5024 
	`¡rıy
(
p
, " xterm");

5025 
p
 +ğ
	`¡¾’
(p);

5027 #ifdeà
COLOR


5028 ià(
D_hascŞÜ
)

5030 
	`¡rıy
(
p
, " color");

5031 
p
 +ğ
	`¡¾’
(p);

5034 #ifdeà
FONT


5035 ià(
D_CG0
)

5037 
	`¡rıy
(
p
, " iso2022");

5038 
p
 +ğ
	`¡¾’
(p);

5040 ià(
D_CS0
 && *D_CS0)

5042 
	`¡rıy
(
p
, "‡ltchar");

5043 
p
 +ğ
	`¡¾’
(p);

5046 
	`Msg
(0, "%s", 
buf
);

5047 
	}
}

5050 
	$AKAfš
(
buf
, 
Ën
, 
d©a
)

5051 *
buf
;

5052 
Ën
;

5053 *
d©a
;

5055 
	`ASSERT
(
di¥Ïy
);

5056 ià(
Ën
 && 
fÜe
)

5057 
	`ChªgeAKA
(
fÜe
, 
buf
, 
	`¡¾’
(buf));

5058 
	}
}

5061 
	$IÅutAKA
()

5063 *
s
, *
ss
;

5064 
n
;

5065 
	`IÅut
("S‘ wšdow' t™Ëo: ", (
fÜe
->
w_akabuf
è- 1, 
INP_COOKED
, 
AKAfš
, 
NULL
);

5066 
s
 = 
fÜe
->
w_t™Ë
;

5067 ià(!
s
)

5069 ; *
s
; s++)

5071 ià((*(*)
s
 & 0x7f) < 0x20 || *s == 0x7f)

5073 
ss
 = 
s
;

5074 
n
 = 1;

5075 
	`LayProûss
(&
ss
, &
n
);

5077 
	}
}

5080 
	$CŞÚfš
(
buf
, 
Ën
, 
d©a
)

5081 *
buf
;

5082 
Ën
;

5083 *
d©a
;

5085 
mbuf
[256];

5086 ià(
Ën
)

5088 
Ën
 = 
	`¡¾’
(
buf
) + 1;

5089 ià(
Ën
 > ()(
mbuf
))

5090 
	`RcLše
(
buf
, 
Ën
);

5093 
	`bcİy
(
buf
, 
mbuf
, 
Ën
);

5094 
	`RcLše
(
mbuf
,  mbuf);

5097 
	}
}

5100 
	$S–eùFš
(
buf
, 
Ën
, 
d©a
)

5101 *
buf
;

5102 
Ën
;

5103 *
d©a
;

5105 
n
;

5107 ià(!
Ën
 || !
di¥Ïy
)

5109 ià(
Ën
 =ğ1 && *
buf
 == '-')

5111 
	`S‘FÜeWšdow
((
wš
 *)0);

5112 
	`Aùiv©e
(0);

5115 ià((
n
 = 
	`WšdowByNoN
(
buf
)) < 0)

5117 
	`Sw™chWšdow
(
n
);

5118 
	}
}

5121 
	$IÅutS–eù
()

5123 
	`IÅut
("Sw™chØwšdow: ", 20, 
INP_COOKED
, 
S–eùFš
, 
NULL
);

5124 
	}
}

5126 
	g£‹nv_v¬
[31];

5130 
	$S‘’vFš1
(
buf
, 
Ën
, 
d©a
)

5131 *
buf
;

5132 
Ën
;

5133 *
d©a
;

5135 ià(!
Ën
 || !
di¥Ïy
)

5137 
	`IÅutS‘’v
(
buf
);

5138 
	}
}

5141 
	$S‘’vFš2
(
buf
, 
Ën
, 
d©a
)

5142 *
buf
;

5143 
Ën
;

5144 *
d©a
;

5146 ià(!
Ën
 || !
di¥Ïy
)

5148 
	`debug2
("S‘’vFš2: s‘’v '%s' '%s'\n", 
£‹nv_v¬
, 
buf
);

5149 
	`x£‹nv
(
£‹nv_v¬
, 
buf
);

5150 
	`MakeNewEnv
();

5151 
	}
}

5154 
	$IÅutS‘’v
(
¬g
)

5155 *
¬g
;

5157 
£‹nv_buf
[50 + (
£‹nv_v¬
)];

5159 ià(
¬g
)

5161 
	`¡ºıy
(
£‹nv_v¬
, 
¬g
, (setenv_var) - 1);

5162 
	`¥rštf
(
£‹nv_buf
, "EÁ” v®ufÜ %s: ", 
£‹nv_v¬
);

5163 
	`IÅut
(
£‹nv_buf
, 30, 
INP_COOKED
, 
S‘’vFš2
, 
NULL
);

5166 
	`IÅut
("S‘’v: EÁ” v¬ŸbË‚ame: ", 30, 
INP_COOKED
, 
S‘’vFš1
, 
NULL
);

5167 
	}
}

5177 
	$DoSü“n
(
â
, 
av
)

5178 *
â
, **
av
;

5180 
NewWšdow
 
nwš
;

5181 
num
;

5182 
buf
[20];

5184 
nwš
 = 
nwš_undef
;

5185 
av
 && *av &&‡v[0][0] == '-')

5187 ià(
av
[0][1] == '-')

5189 
av
++;

5192 
av
[0][1])

5195 
av
[0][2])

5199 
nwš
.
æowæag
 = 
FLOW_NOW
 * 0;

5204 
nwš
.
æowæag
 = 
FLOW_NOW
 * 1;

5207 
nwš
.
æowæag
 = 
FLOW_AUTOFLAG
;

5214 ià(
av
[0][2])

5215 
nwš
.
aka
 = &
av
[0][2];

5216 ià(*++
av
)

5217 
nwš
.
aka
 = *
av
;

5219 --
av
;

5222 ià(
av
[0][2])

5223 
nwš
.
‹rm
 = &
av
[0][2];

5224 ià(*++
av
)

5225 
nwš
.
‹rm
 = *
av
;

5227 --
av
;

5230 ià(
av
[0][2])

5231 
nwš
.
hi¡height
 = 
	`©oi
(
av
[0] + 2);

5232 ià(*++
av
)

5233 
nwš
.
hi¡height
 = 
	`©oi
(*
av
);

5235 --
av
;

5237 #ifdeà
LOGOUTOK


5239 
av
[0][2])

5243 
nwš
.
læag
 = 0;

5248 
nwš
.
læag
 = 1;

5251 
nwš
.
læag
 = 3;

5259 
nwš
.
aæag
 = 1;

5262 
nwš
.
mÚ™Ü
 = 
MON_ON
;

5265 
nwš
.
Læag
 = 1;

5268 
	`Msg
(0, "%s: sü“n: inv®id o±iÚ -%c.", 
â
, 
av
[0][1]);

5271 ++
av
;

5273 
num
 = 0;

5274 ià(
av
 && *av && 
	`IsNumCŞÚ
(*av, 10, 
buf
, (buf)))

5276 ià(*
buf
 != '\0')

5277 
nwš
.
aka
 = 
buf
;

5278 
num
 = 
	`©oi
(*
av
);

5279 ià(
num
 < 0 ||‚um > 
MAXWIN
 - 1)

5281 
	`Msg
(0, "%s: iÎeg® sü“Ànumb” %d.", 
â
, 
num
);

5282 
num
 = 0;

5284 
nwš
.
S¹At
 = 
num
;

5285 ++
av
;

5287 ià(
av
 && *av)

5289 
nwš
.
¬gs
 = 
av
;

5290 ià(!
nwš
.
aka
)

5291 
nwš
.
aka
 = 
	`F’ame
(*
av
);

5293 
	`MakeWšdow
(&
nwš
);

5294 
	}
}

5296 #ifdeà
COPY_PASTE


5307 
	$CompeKeys
(
s
, 
¦
, 
¬¿y
)

5308 *
s
;

5309 
¦
;

5310 *
¬¿y
;

5312 
i
;

5313 
key
, 
v®ue
;

5315 ià(
¦
 == 0)

5317 
i
 = 0; i < 256; i++)

5318 
¬¿y
[
i
] = i;

5321 
	`debug1
("CompeKeys: '%s'\n", 
s
);

5322 
¦
)

5324 
key
 = *(*)
s
++;

5325 ià(*
s
 !ğ'=' || 
¦
 < 3)

5327 
¦
--;

5330 
s
++;

5331 
¦
 -= 2;

5332 
v®ue
 = *(*)
s
++;

5333 
¬¿y
[
v®ue
] = 
key
;

5335 *
s
 =ğ'=' && 
¦
 >= 2);

5336 ià(
¦
 == 0)

5338 ià(*
s
++ != ':')

5340 
¦
--;

5343 
	}
}

5350 #ià
defšed
(
DETACH
è&& defšed(
POW_DETACH
)

5352 
	$pow_d‘ach_â
(
buf
, 
Ën
, 
d©a
)

5353 *
buf
;

5354 
Ën
;

5355 *
d©a
;

5357 
	`debug
("pow_detach_fn called\n");

5358 ià(
Ën
)

5360 *
buf
 = 0;

5363 ià(
kb
[()()*
buf
].
Ä
 !ğ
RC_POW_DETACH
)

5365 ià(
di¥Ïy
)

5366 
	`wr™e
(
D_u£rfd
, "\007", 1);

5367 
	`Msg
(0, "Detach‡borted.");

5370 
	`D‘ach
(
D_POWER
);

5371 
	}
}

5374 #ifdeà
COPY_PASTE


5376 
	$cİy_»g_â
(
buf
, 
Ën
, 
d©a
)

5377 *
buf
;

5378 
Ën
;

5379 *
d©a
;

5381 
¶İ
 *
µ
 = 
¶İ_b
 + ()()*
buf
;

5383 ià(
Ën
)

5385 *
buf
 = 0;

5388 ià(
µ
->
buf
)

5389 
	`ä“
(
µ
->
buf
);

5390 
µ
->
buf
 = 0;

5391 
µ
->
Ën
 = 0;

5392 ià(
D_u£r
->
u_¶İ
.
Ën
)

5394 ià((
µ
->
buf
 = (*)
	`m®loc
(
D_u£r
->
u_¶İ
.
Ën
)è=ğ
NULL
)

5396 
	`Msg
(0, 
¡ºomem
);

5399 
	`bcİy
(
D_u£r
->
u_¶İ
.
buf
, 
µ
->buf, D_u£r->u_¶İ.
Ën
);

5401 
µ
->
Ën
 = 
D_u£r
->
u_¶İ
.len;

5402 #ifdeà
ENCODINGS


5403 
µ
->
’c
 = 
D_u£r
->
u_¶İ
.enc;

5405 
	`Msg
(0, "Cİ›d %d ch¬aù” štØ»gi¡” %c", 
D_u£r
->
u_¶İ
.
Ën
, *
buf
);

5406 
	}
}

5409 
	$šs_»g_â
(
buf
, 
Ën
, 
d©a
)

5410 *
buf
;

5411 
Ën
;

5412 *
d©a
;

5414 
¶İ
 *
µ
 = 
¶İ_b
 + ()()*
buf
;

5417 ià(!
fÜe
)

5419 ià(*
buf
 == '.')

5420 
	`Msg
(0, "ins_reg_fn: Warning:…asting„eal„egister '.'!");

5421 ià(
Ën
)

5423 *
buf
 = 0;

5426 ià(
µ
->
buf
)

5428 
	`MakePa¡”
(&
fÜe
->
w_·¡”
, 
µ
->
buf
,…p->
Ën
, 0);

5431 
	`Msg
(0, "Empty„egister.");

5432 
	}
}

5436 
	$´oûss_â
(
buf
, 
Ën
, 
d©a
)

5437 *
buf
;

5438 
Ën
;

5439 *
d©a
;

5441 
¶İ
 *
µ
 = 
¶İ_b
 + ()()*
buf
;

5443 ià(
Ën
)

5445 *
buf
 = 0;

5448 ià(
µ
->
buf
)

5450 
	`ProûssIÅut
(
µ
->
buf
,…p->
Ën
);

5453 
	`Msg
(0, "Empty„egister.");

5454 
	}
}

5457 
	$cÚfœm_â
(
buf
, 
Ën
, 
d©a
)

5458 *
buf
;

5459 
Ën
;

5460 *
d©a
;

5462 
aùiÚ
 
aù
;

5464 ià(
Ën
 || (*
buf
 != 'y' && *buf != 'Y'))

5466 *
buf
 = 0;

5469 
aù
.
Ä
 = ()
d©a
;

5470 
aù
.
¬gs
 = 
nßrgs
;

5471 
aù
.
¬gl
 = 0;

5472 
	`DoAùiÚ
(&
aù
, -1);

5473 
	}
}

5475 #ifdeà
MULTIUSER


5476 
	sšputsu


5478 
aşu£r
 **
	mup
;

5479 
	mÇme
[24];

5480 
	mpw1
[130];

5481 
	mpw2
[130];

5485 
	$su_fš
(
buf
, 
Ën
, 
d©a
)

5486 *
buf
;

5487 
Ën
;

5488 *
d©a
;

5490 
šputsu
 *
i
 = (šputsu *)
d©a
;

5491 *
p
;

5492 
l
;

5494 ià(!*
i
->
Çme
)

5495 { 
p
 = 
i
->
Çme
; 
l
 = (i->name) - 1; }

5496 ià(!*
i
->
pw1
)

5497 { 
	`¡rıy
(
p
 = 
i
->
pw1
, "\377"); 
l
 = (i->pw1) - 1; }

5499 { 
	`¡rıy
(
p
 = 
i
->
pw2
, "\377"); 
l
 = (i->pw2) - 1; }

5500 ià(
buf
 && 
Ën
)

5501 
	`¡ºıy
(
p
, 
buf
, 1 + (
l
 < 
Ën
) ?† :†en);

5502 ià(!*
i
->
Çme
)

5503 
	`IÅut
("Sü“ÀU£r: ", (
i
->
Çme
è- 1, 
INP_COOKED
, 
su_fš
, (*)i);

5504 ià(!*
i
->
pw1
)

5505 
	`IÅut
("U£r' UNIX PasswÜd: ", (
i
->
pw1
)-1, 
INP_COOKED
|
INP_NOECHO
, 
su_fš
, (*)i);

5506 ià(!*
i
->
pw2
)

5507 
	`IÅut
("U£r' Sü“ÀPasswÜd: ", (
i
->
pw2
)-1, 
INP_COOKED
|
INP_NOECHO
, 
su_fš
, (*)i);

5510 ià((
p
 = 
	`DoSu
(
i
->
up
, i->
Çme
, i->
pw2
, i->
pw1
)))

5511 
	`Msg
(0, "%s", 
p
);

5512 
	`ä“
((*)
i
);

5514 
	}
}

5517 
	$IÅutSu
(
w
, 
up
, 
Çme
)

5518 
wš
 *
w
;

5519 
aşu£r
 **
up
;

5520 *
Çme
;

5522 
šputsu
 *
i
;

5524 ià(!(
i
 = (
šputsu
 *)
	`ÿÎoc
(1, (inputsu))))

5527 
i
->
up
 = up;

5528 ià(
Çme
 && *name)

5529 
	`su_fš
(
Çme
, ()
	`¡¾’
Òame), (*)
i
);

5531 
	`su_fš
((*)0, 0, (*)
i
);

5533 
	}
}

5536 #ifdeà
PASSWORD


5539 
	$·ss1
(
buf
, 
Ën
, 
d©a
)

5540 *
buf
;

5541 
Ën
;

5542 *
d©a
;

5544 
aşu£r
 *
u
 = (aşu£¸*)
d©a
;

5546 ià(!*
buf
)

5548 
	`ASSERT
(
u
);

5549 ià(
u
->
u_·sswÜd
 !ğ
NuÎSŒ
)

5550 
	`ä“
((*)
u
->
u_·sswÜd
);

5551 
u
->
u_·sswÜd
 = 
	`SaveSŒ
(
buf
);

5552 
	`bz”o
(
buf
, 
	`¡¾’
(buf));

5553 
	`IÅut
("R‘y³‚ew…asswÜd:", 100, 
INP_NOECHO
, 
·ss2
, 
d©a
);

5554 
	}
}

5557 
	$·ss2
(
buf
, 
Ën
, 
d©a
)

5558 *
buf
;

5559 
Ën
;

5560 *
d©a
;

5562 
¡
;

5563 
§É
[3];

5564 
aşu£r
 *
u
 = (aşu£¸*)
d©a
;

5566 
	`ASSERT
(
u
);

5567 ià(!
buf
 || 
	`¡rcmp
(
u
->
u_·sswÜd
, buf))

5569 
	`Msg
(0, "[ Passwords don't match - checkingurned off ]");

5570 ià(
u
->
u_·sswÜd
 !ğ
NuÎSŒ
)

5572 
	`bz”o
(
u
->
u_·sswÜd
, 
	`¡¾’
(u->u_password));

5573 
	`ä“
((*)
u
->
u_·sswÜd
);

5575 
u
->
u_·sswÜd
 = 
NuÎSŒ
;

5577 ià(
u
->
u_·sswÜd
[0] == '\0')

5579 
	`Msg
(0, "[ No…assword -‚o secure ]");

5580 ià(
buf
)

5581 
	`bz”o
(
buf
, 
	`¡¾’
(buf));

5584 ià(
u
->
u_·sswÜd
 !ğ
NuÎSŒ
)

5586 
¡
 = 0; st < 2; st++)

5587 
§É
[
¡
] = 'A' + ()((
	`time
(0) >> 6 * st) % 26);

5588 
§É
[2] = 0;

5589 
buf
 = 
	`üy±
(
u
->
u_·sswÜd
, 
§É
);

5590 
	`bz”o
(
u
->
u_·sswÜd
, 
	`¡¾’
(u->u_password));

5591 
	`ä“
((*)
u
->
u_·sswÜd
);

5592 
u
->
u_·sswÜd
 = 
	`SaveSŒ
(
buf
);

5593 
	`bz”o
(
buf
, 
	`¡¾’
(buf));

5594 #ifdeà
COPY_PASTE


5595 ià(
u
->
u_¶İ
.
buf
)

5596 
	`U£rF»eCİyBufãr
(
u
);

5597 
u
->
u_¶İ
.
Ën
 = 
	`¡¾’
(u->
u_·sswÜd
);

5598 #ifdeà
ENCODINGS


5599 
u
->
u_¶İ
.
’c
 = 0;

5601 ià(!(
u
->
u_¶İ
.
buf
 = 
	`SaveSŒ
(u->
u_·sswÜd
)))

5603 
	`Msg
(0, 
¡ºomem
);

5604 
D_u£r
->
u_¶İ
.
Ën
 = 0;

5607 
	`Msg
(0, "[ Password moved into copybuffer ]");

5609 
	`Msg
(0, "[ Cry±ed…asswÜd i \"%s\" ]", 
u
->
u_·sswÜd
);

5612 
	}
}

5616 
	$dig¿ph_â
(
buf
, 
Ën
, 
d©a
)

5617 *
buf
;

5618 
Ën
;

5619 *
d©a
;

5621 
ch
, 
i
, 
x
;

5623 
ch
 = 
buf
[
Ën
];

5624 ià(
ch
)

5626 ià(
ch
 < ' ' || ch == '\177')

5628 ià(
Ën
 >ğ1 && ((*
buf
 == 'U' && buf[1] == '+') || (*buf == '0' && (buf[1] == 'x' || buf[1] == 'X'))))

5630 ià(
Ën
 == 1)

5632 ià((
ch
 < '0' || ch > '9') && (ch < 'a' || ch > 'f') && (ch < 'A' || ch > 'F'))

5634 
buf
[
Ën
] = '\034';

5637 ià(
Ën
 =ğ(*
buf
 == 'U' ? 5 : 3))

5638 
buf
[
Ën
] = '\n';

5641 ià(
Ën
 && *
buf
 == '0')

5643 ià(
ch
 < '0' || ch > '7')

5645 
buf
[
Ën
] = '\034';

5648 ià(
Ën
 == 3)

5649 
buf
[
Ën
] = '\n';

5652 ià(
Ën
 == 1)

5653 
buf
[
Ën
] = '\n';

5656 
buf
[
Ën
] = buf[len + 1];

5657 
Ën
++;

5658 ià(
Ën
 < 2)

5660 ià(
Ën
 >ğ1 && ((*
buf
 == 'U' && buf[1] == '+') || (*buf == '0' && (buf[1] == 'x' || buf[1] == 'X'))))

5662 
x
 = 0;

5663 
i
 = 2; i < 
Ën
; i++)

5665 ià(
buf
[
i
] >= '0' && buf[i] <= '9')

5666 
x
 = x * 16 | (
buf
[
i
] - '0');

5667 ià(
buf
[
i
] >= 'a' && buf[i] <= 'f')

5668 
x
 = x * 16 | (
buf
[
i
] - ('a' - 10));

5669 ià(
buf
[
i
] >= 'A' && buf[i] <= 'F')

5670 
x
 = x * 16 | (
buf
[
i
] - ('A' - 10));

5675 ià(
buf
[0] == '0')

5677 
x
 = 0;

5678 
i
 = 1; i < 
Ën
; i++)

5680 ià(
buf
[
i
] < '0' || buf[i] > '7')

5682 
x
 = x * 8 | (
buf
[
i
] - '0');

5687 
i
 = 0; i < ()((
dig¿phs
)/(*digraphs)); i++)

5688 ià((
dig¿phs
[
i
][0] =ğ()
buf
[0] && digraphs[i][1] == ()buf[1]) ||

5689 (
dig¿phs
[
i
][0] =ğ()
buf
[1] && digraphs[i][1] == ()buf[0]))

5691 ià(
i
 =ğ()((
dig¿phs
)/(*digraphs)))

5693 
	`Msg
(0, "Unknown digraph");

5696 
x
 = 
dig¿phs
[
i
][2];

5698 
i
 = 1;

5699 *
buf
 = 
x
;

5700 #ifdeà
UTF8


5701 ià(
æay”
->
l_’codšg
 =ğ
UTF8
)

5702 
i
 = 
	`ToUtf8
(
buf
, 
x
);

5704 
i
)

5705 
	`LayProûss
(&
buf
, &
i
);

5706 
	}
}

5708 #ifdeà
MAPKEYS


5710 
	$StuffKey
(
i
)

5711 
i
;

5713 
aùiÚ
 *
aù
;

5715 
	`debug1
("StuffKey #%d", 
i
);

5716 #ifdeà
DEBUG


5717 ià(
i
 < 
KMAP_KEYS
)

5718 
	`debug1
(" - %s", 
‹rm
[
i
 + 
T_CAPS
].
túame
);

5720 ià(
i
 >ğ
T_CURSOR
 - 
T_CAPS
 && i < 
T_KEYPAD
 - T_CAPS && 
D_cursÜkeys
)

5721 
i
 +ğ
T_OCAPS
 - 
T_CURSOR
;

5722 ià(
i
 >ğ
T_KEYPAD
 - 
T_CAPS
 && i < 
T_OCAPS
 - T_CAPS && 
D_key·d
)

5723 
i
 +ğ
T_OCAPS
 - 
T_CURSOR
;

5724 
	`debug1
(" -‡ùiÚ %d\n", 
i
);

5725 
æay”
 = 
D_fÜecv
->
c_Ïy”
;

5726 
fÜe
 = 
D_fÜe
;

5727 
aù
 = 0;

5728 #ifdeà
COPY_PASTE


5729 ià(
	`InM¬k
(è|| 
	`InIÅut
(è|| 
	`InWLi¡
())

5730 
aù
 = 
i
 < 
KMAP_KEYS
+
KMAP_AKEYS
 ? &
mmb
[i] : &
km­_exts
[˜- (KMAP_KEYS+KMAP_AKEYS)].
mm
;

5732 ià((!
aù
 ||‡ù->
Ä
 =ğ
RC_ILLEGAL
è&& !
D_m­deçuÉ
)

5733 
aù
 = 
i
 < 
KMAP_KEYS
+
KMAP_AKEYS
 ? &
umb
[i] : &
km­_exts
[˜- (KMAP_KEYS+KMAP_AKEYS)].
um
;

5734 
D_m­deçuÉ
 = 0;

5735 ià(!
aù
 ||‡ù->
Ä
 =ğ
RC_ILLEGAL
)

5736 
aù
 = 
i
 < 
KMAP_KEYS
+
KMAP_AKEYS
 ? &
dmb
[i] : &
km­_exts
[˜- (KMAP_KEYS+KMAP_AKEYS)].
dm
;

5737 ià(
aù
 =ğ0 ||‡ù->
Ä
 =ğ
RC_ILLEGAL
)

5739 
	`DoAùiÚ
(
aù
, 0);

5741 
	}
}

5746 
	$IsOnDi¥Ïy
(
wi
)

5747 
wš
 *
wi
;

5749 
ÿnvas
 *
cv
;

5750 
	`ASSERT
(
di¥Ïy
);

5751 
cv
 = 
D_cvli¡
; cv; cv = cv->
c_Ãxt
)

5752 ià(
	`Lay”2Wšdow
(
cv
->
c_Ïy”
è=ğ
wi
)

5755 
	}
}

5757 
wš
 *

5758 
	$FšdNiûWšdow
(
wi
, 
´e£l
)

5759 
wš
 *
wi
;

5760 *
´e£l
;

5762 
i
;

5764 
	`debug2
("FšdNiûWšdow %d %s\n", 
wi
 ? wi->
w_numb”
 : -1 , 
´e£l
 ?…resel : "NULL");

5765 ià(
´e£l
)

5767 
i
 = 
	`WšdowByNoN
(
´e£l
);

5768 ià(
i
 >= 0)

5769 
wi
 = 
wb
[
i
];

5771 ià(!
di¥Ïy
)

5772  
wi
;

5773 #ifdeà
MULTIUSER


5774 ià(
wi
 && 
	`AşCheckP”mWš
(
D_u£r
, 
ACL_READ
, wi))

5775 
wi
 = 0;

5777 ià(!
wi
 || (
	`IsOnDi¥Ïy
(wiè&& !
´e£l
))

5780 
wi
 = 0;

5781 #ifdeà
MULTIUSER


5782 
wi
 = 
wšdows
; wi; w˜ğwi->
w_Ãxt
)

5783 ià(!
wi
->
w_Ïy”
.
l_cvli¡
 && !
	`AşCheckP”mWš
(
D_u£r
, 
ACL_WRITE
, wi))

5785 ià(!
wi
)

5786 
wi
 = 
wšdows
; wi; w˜ğwi->
w_Ãxt
)

5787 ià(
wi
->
w_Ïy”
.
l_cvli¡
 && !
	`IsOnDi¥Ïy
(wiè&& !
	`AşCheckP”mWš
(
D_u£r
, 
ACL_WRITE
, wi))

5789 ià(!
wi
)

5790 
wi
 = 
wšdows
; wi; w˜ğwi->
w_Ãxt
)

5791 ià(!
wi
->
w_Ïy”
.
l_cvli¡
 && !
	`AşCheckP”mWš
(
D_u£r
, 
ACL_READ
, wi))

5793 ià(!
wi
)

5794 
wi
 = 
wšdows
; wi; w˜ğwi->
w_Ãxt
)

5795 ià(
wi
->
w_Ïy”
.
l_cvli¡
 && !
	`IsOnDi¥Ïy
(wiè&& !
	`AşCheckP”mWš
(
D_u£r
, 
ACL_READ
, wi))

5798 ià(!
wi
)

5799 
wi
 = 
wšdows
; wi; w˜ğwi->
w_Ãxt
)

5800 ià(!
wi
->
w_Ïy”
.
l_cvli¡
)

5802 ià(!
wi
)

5803 
wi
 = 
wšdows
; wi; w˜ğwi->
w_Ãxt
)

5804 ià(
wi
->
w_Ïy”
.
l_cvli¡
 && !
	`IsOnDi¥Ïy
(wi))

5807 #ifdeà
MULTIUSER


5808 ià(
wi
 && 
	`AşCheckP”mWš
(
D_u£r
, 
ACL_READ
, wi))

5809 
wi
 = 0;

5811  
wi
;

5812 
	}
}

5817 
comm
 **
	gcommb
;

5818 
	gncommb
;

5821 
	$AddComms
(
cos
, 
hªd
)

5822 
comm
 *
cos
;

5823 (*
hªd
è
	`__P
((
comm
 *, **, ));

5825 
n
, 
i
, 
j
, 
r
;

5826 
n
 = 0; 
cos
[n].
Çme
;‚++)

5828 ià(
n
 == 0)

5830 ià(
commb
)

5831 
commb
 = (
commt
 *)
	`»®loc
(commb, (*commbè* (
ncommb
 + 
n
));

5833 
commb
 = (
commt
 *)
	`m®loc
((*commbè* (
ncommb
 + 
n
));

5834 ià(!
commb
)

5835 
	`Pªic
(0, 
¡ºomem
);

5836 
i
 = 0; i < 
n
; i++)

5838 
j
 = 0; j < 
ncommb
; j++)

5840 
r
 = 
	`¡rcmp
(
cos
[
i
].
Çme
, 
commb
[
j
]->name);

5841 ià(
r
 == 0)

5842 
	`Pªic
(0, "Du¶iÿ‹ commªd: %s\n", 
cos
[
i
].
Çme
);

5843 ià(
r
 < 0)

5846 
r
 = 
ncommb
;„ > 
j
;„--)

5847 
commb
[
r
] = commtab[r - 1];

5848 
commb
[
j
] = 
cos
 + 
i
;

5849 
cos
[
i
].
hªdËr
 = 
hªd
;

5850 
	`bz”o
(
cos
[
i
].
u£rb™s
, (cos[i].userbits));

5851 
ncommb
++;

5853 
	}
}

5855 
comm
 *

5856 
	$FšdComm
(
¡r
)

5857 *
¡r
;

5859 
x
, 
m
, 
l
 = 0, 
r
 = 
ncommb
 - 1;

5860 
l
 <ğ
r
)

5862 
m
 = (
l
 + 
r
) / 2;

5863 
x
 = 
	`¡rcmp
(
¡r
, 
commb
[
m
]->
Çme
);

5864 ià(
x
 > 0)

5865 
l
 = 
m
 + 1;

5866 ià(
x
 < 0)

5867 
r
 = 
m
 - 1;

5869  
commb
[
m
];

5872 
	}
}

5877 
	$ResizeRegiÚs
(
¬g
)

5878 *
¬g
;

5880 
ÿnvas
 *
cv
;

5881 
Äeg
, 
dsize
, 
diff
, 
siz
;

5883 
	`ASSERT
(
di¥Ïy
);

5884 
Äeg
 = 0, 
cv
 = 
D_cvli¡
; cv; cv = cv->
c_Ãxt
)

5885 
Äeg
++;

5886 ià(
Äeg
 < 2)

5888 
	`Msg
(0, "resize:‚eed morehan one„egion");

5891 
dsize
 = 
D_height
 - (
D_has_h¡©us
 =ğ
HSTATUS_LASTLINE
);

5892 ià(*
¬g
 == '=')

5895 
h
 = 
dsize
;

5896 
hh
, 
i
 = 0;

5897 
cv
 = 
D_cvli¡
; cv; cv = cv->
c_Ãxt
)

5899 
hh
 = 
h
 / 
Äeg
-- - 1;

5900 
cv
->
c_ys
 = 
i
;

5901 
cv
->
c_ye
 = 
i
 + 
hh
 - 1;

5902 
cv
->
c_yoff
 = 
i
;

5903 
i
 +ğ
hh
 + 1;

5904 
h
 -ğ
hh
 + 1;

5906 
	`R‘hškDi¥ÏyV›wpÜts
();

5907 
	`ResizeLay”sToCªva£s
();

5910 
siz
 = 
D_fÜecv
->
c_ye
 - D_fÜecv->
c_ys
 + 1;

5911 ià(*
¬g
 == '+')

5912 
diff
 = 
	`©oi
(
¬g
 + 1);

5913 ià(*
¬g
 == '-')

5914 
diff
 = -
	`©oi
(
¬g
 + 1);

5915 ià(!
	`¡rcmp
(
¬g
, "min"))

5916 
diff
 = 1 - 
siz
;

5917 ià(!
	`¡rcmp
(
¬g
, "max"))

5918 
diff
 = 
dsize
 - (
Äeg
 - 1è* 2 - 1 - 
siz
;

5920 
diff
 = 
	`©oi
(
¬g
è- 
siz
;

5921 ià(
diff
 == 0)

5923 ià(
siz
 + 
diff
 < 1)

5924 
diff
 = 1 - 
siz
;

5925 ià(
siz
 + 
diff
 > 
dsize
 - (
Äeg
 - 1) * 2 - 1)

5926 
diff
 = 
dsize
 - (
Äeg
 - 1è* 2 - 1 - 
siz
;

5927 ià(
diff
 =ğ0 || 
siz
 + diff < 1)

5930 ià(
diff
 < 0)

5932 ià(
D_fÜecv
->
c_Ãxt
)

5934 
D_fÜecv
->
c_ye
 +ğ
diff
;

5935 
D_fÜecv
->
c_Ãxt
->
c_ys
 +ğ
diff
;

5936 
D_fÜecv
->
c_Ãxt
->
c_yoff
 +ğ
diff
;

5940 
cv
 = 
D_cvli¡
; cv; cv = cv->
c_Ãxt
)

5941 ià(
cv
->
c_Ãxt
 =ğ
D_fÜecv
)

5943 
	`ASSERT
(
cv
);

5944 
cv
->
c_ye
 -ğ
diff
;

5945 
D_fÜecv
->
c_ys
 -ğ
diff
;

5946 
D_fÜecv
->
c_yoff
 -ğ
diff
;

5951 
s
, 
i
 = 0, 
found
 = 0, 
di
 = 
diff
, 
d2
;

5952 
s
 = 
dsize
 - (
Äeg
 - 1è* 2 - 1 - 
siz
;

5953 
cv
 = 
D_cvli¡
; cv; 
i
 = cv->
c_ye
 + 2, cv = cv->
c_Ãxt
)

5955 ià(
cv
 =ğ
D_fÜecv
)

5957 
cv
->
c_ye
 = 
i
 + (cv->c_y- cv->
c_ys
è+ 
diff
;

5958 
cv
->
c_yoff
 -ğcv->
c_ys
 - 
i
;

5959 
cv
->
c_ys
 = 
i
;

5960 
found
 = 1;

5963 
s
 -ğ
cv
->
c_ye
 - cv->
c_ys
;

5964 ià(!
found
)

5966 ià(
s
 >ğ
di
)

5968 
d2
 = 
di
 - 
s
;

5971 
d2
 = 
di
 > 
cv
->
c_ye
 - cv->
c_ys
 ? cv->c_ye - cv->c_ys : di;

5972 
di
 -ğ
d2
;

5973 
cv
->
c_ye
 = 
i
 + (cv->c_y- cv->
c_ys
è- 
d2
;

5974 
cv
->
c_yoff
 -ğcv->
c_ys
 - 
i
;

5975 
cv
->
c_ys
 = 
i
;

5978 
	`R‘hškDi¥ÏyV›wpÜts
();

5979 
	`ResizeLay”sToCªva£s
();

5980 
	}
}

5983 
	$ResizeFš
(
buf
, 
Ën
, 
d©a
)

5984 *
buf
;

5985 
Ën
;

5986 *
d©a
;

5988 
	`ResizeRegiÚs
(
buf
);

5989 
	}
}

5991 #ifdeà
RXVT_OSC


5993 
	$ReäeshX‹rmOSC
()

5995 
i
;

5996 
wš
 *
p
;

5998 
p
 = 
	`Lay”2Wšdow
(
D_fÜecv
->
c_Ïy”
);

5999 
i
 = 3; i >=0; i--)

6000 
	`S‘X‹rmOSC
(
i
, 
p
 ?…->
w_x‹rmosc
[i] : 0);

6001 
	}
}

6005 
	$P¬£A‰rCŞÜ
(
s1
, 
s2
, 
msgok
)

6006 *
s1
, *
s2
;

6007 
msgok
;

6009 
i
, 
n
;

6010 *
s
, *
ss
;

6011 
r
 = 0;

6013 
s
 = 
s1
;

6014 *
s
 == ' ')

6015 
s
++;

6016 
ss
 = 
s
;

6017 *
ss
 && *ss != ' ')

6018 
ss
++;

6019 *
ss
 == ' ')

6020 
ss
++;

6021 ià(*
s
 && (
s2
 || *
ss
 || !((*s >= 'a' && *s <= 'z') || (*s >= 'A' && *s <= 'Z') || *s == '.')))

6023 
mode
 = 0, 
n
 = 0;

6024 ià(*
s
 == '+')

6026 
mode
 = 1;

6027 
s
++;

6029 ià(*
s
 == '-')

6031 
mode
 = -1;

6032 
s
++;

6034 ià(*
s
 == '!')

6036 
mode
 = 2;

6037 
s
++;

6039 ià(*
s
 == '=')

6040 
s
++;

6041 ià(*
s
 >= '0' && *s <= '9')

6043 
n
 = *
s
++ - '0';

6044 ià(*
s
 >= '0' && *s <= '9')

6045 
n
 =‚ * 16 + (*
s
++ - '0');

6046 ià(*
s
 >= 'a' && *s <= 'f')

6047 
n
 =‚ * 16 + (*
s
++ - ('a' - 10));

6048 ià(*
s
 >= 'A' && *s <= 'F')

6049 
n
 =‚ * 16 + (*
s
++ - ('A' - 10));

6050 ià(*
s
 && *s != ' ')

6052 ià(
msgok
)

6053 
	`Msg
(0, "IÎeg®‡‰ribu‹ hexch¬ '%c'", *
s
);

6059 *
s
 && *s != ' ')

6061 ià(*
s
 == 'd')

6062 
n
 |ğ
A_DI
;

6063 ià(*
s
 == 'u')

6064 
n
 |ğ
A_US
;

6065 ià(*
s
 == 'b')

6066 
n
 |ğ
A_BD
;

6067 ià(*
s
 == 'r')

6068 
n
 |ğ
A_RV
;

6069 ià(*
s
 == 's')

6070 
n
 |ğ
A_SO
;

6071 ià(*
s
 == 'B')

6072 
n
 |ğ
A_BL
;

6075 ià(
msgok
)

6076 
	`Msg
(0, "IÎeg®‡‰ribu‹ s³cif›¸'%c'", *
s
);

6079 
s
++;

6082 ià(*
s
 && *s != ' ')

6084 ià(
msgok
)

6085 
	`Msg
(0, "junk‡á”‡‰ribu‹ desütiÚ: '%c'", *
s
);

6088 ià(
mode
 == -1)

6089 
r
 = 
n
 << 8 |‚;

6090 ià(
mode
 == 1)

6091 
r
 = 
n
 << 8;

6092 ià(
mode
 == 2)

6093 
r
 = 
n
;

6094 ià(
mode
 == 0)

6095 
r
 = 0xfffà^ 
n
;

6097 *
s
 && *s == ' ')

6098 
s
++;

6100 ià(
s2
)

6102 ià(*
s
)

6104 ià(
msgok
)

6105 
	`Msg
(0, "junk‡á” desütiÚ: '%c'", *
s
);

6108 
s
 = 
s2
;

6109 *
s
 && *s == ' ')

6110 
s
++;

6113 #ifdeà
COLOR


6114 ià(*
s
)

6116 
co¡r
[] = "krgybmcw d i.01234567 9 f FKRGYBMCW I ";

6117 
numco
 = 0, 
j
;

6119 
n
 = 0;

6120 ià(*
s
 == '.')

6122 
numco
++;

6123 
n
 = 0x0f;

6124 
s
++;

6126 
j
 = 0; j < 2 && *
s
 && *s != ' '; j++)

6128 
i
 = 0; 
co¡r
[i]; i++)

6129 ià(*
s
 =ğ
co¡r
[
i
])

6131 ià(!
co¡r
[
i
])

6133 ià(
msgok
)

6134 
	`Msg
(0, "Ëg® cŞÜ desütÜ: '%c'", *
s
);

6137 
numco
++;

6138 
n
 =‚ << 4 | (
i
 & 15);

6139 #ifdeà
COLORS16


6140 ià(
i
 >= 48)

6141 
n
 = (n & 0x20ff) | 0x200;

6143 
s
++;

6145 ià((
n
 & 0xf00) == 0xf00)

6146 
n
 ^= 0xf00;

6147 #ifdeà
COLORS16


6148 ià(
n
 & 0x2000)

6149 
n
 ^= 0x2400;

6151 ià(
numco
 == 1)

6152 
n
 |= 0xf0;

6153 ià(
numco
 !ğ2 && 
n
 != 0xff)

6154 
n
 |= 0x100;

6155 ià(*
s
 && *s != ' ')

6157 ià(
msgok
)

6158 
	`Msg
(0, "junk‡á” cŞÜ desütiÚ: '%c'", *
s
);

6161 
n
 ^= 0xff;

6162 
r
 |ğ
n
 << 16;

6166 *
s
 && *s == ' ')

6167 
s
++;

6168 ià(*
s
)

6170 ià(
msgok
)

6171 
	`Msg
(0, "junk‡á” desütiÚ: '%c'", *
s
);

6174 
	`debug1
("P¬£A‰rCŞÜ %06x\n", 
r
);

6175  
r
;

6176 
	}
}

6187 
	$AµlyA‰rCŞÜ
(
i
, 
mc
)

6188 
i
;

6189 
mch¬
 *
mc
;

6191 
	`debug1
("AµlyA‰rCŞÜ %06x\n", 
i
);

6192 
mc
->
©Œ
 |ğ
i
 >> 8 & 255;

6193 
mc
->
©Œ
 ^ğ
i
 & 255;

6194 #ifdeà
COLOR


6195 
i
 = (i >> 16) ^ 0xff;

6196 ià((
i
 & 0x100) != 0)

6198 
i
 &= 0xeff;

6199 ià(
mc
->
©Œ
 & (
A_SO
|
A_RV
))

6200 #ifdeà
COLORS16


6201 
i
 = ((i & 0x0f) << 4) | ((i & 0xf0) >> 4) | ((i & 0x200) << 1) | ((i & 0x400) >> 1);

6203 
i
 = ((i & 0x0f) << 4) | ((i & 0xf0) >> 4);

6206 #ifdeà
COLORS16


6207 ià((
i
 & 0x0f) != 0x0f)

6208 
mc
->
©Œ
 = (mc->©Œ & 0xbfè| ((
i
 >> 3) & 0x40);

6209 ià((
i
 & 0xf0) != 0xf0)

6210 
mc
->
©Œ
 = (mc->©Œ & 0x7fè| ((
i
 >> 3) & 0x80);

6212 
mc
->
cŞÜ
 = 0x99 ^ mc->color;

6213 ià((
i
 & 0x0e) == 0x0e)

6214 
i
 = (˜& 0xf0è| (
mc
->
cŞÜ
 & 0x0f);

6215 ià((
i
 & 0xe0) == 0xe0)

6216 
i
 = (˜& 0x0fè| (
mc
->
cŞÜ
 & 0xf0);

6217 
mc
->
cŞÜ
 = 0x99 ^ 
i
;

6218 
	`debug2
("AµlyA‰rCŞÜ - %02x %02x\n", 
mc
->
©Œ
, 
i
);

6220 
	}
}

	@pty.c

24 
	~<sys/ty³s.h
>

25 
	~<sys/¡©.h
>

26 
	~<fú.h
>

27 
	~<sigÇl.h
>

29 
	~"cÚfig.h
"

30 
	~"sü“n.h
"

32 #iâdeà
sun


33 
	~<sys/ioùl.h
>

37 #ifdeà
HAVE_SVR4_PTYS


38 
	~<sys/¡rİts.h
>

41 #ià
defšed
(
sun
è&& defšed(
LOCKPTY
è&& !defšed(
TIOCEXCL
)

42 
	~<sys/‰Şd.h
>

45 #ifdeà
ISC


46 
	~<sys/‰y.h
>

47 
	~<sys/sioùl.h
>

48 
	~<sys/±y.h
>

51 #ifdeà
sgi


52 
	~<sys/sysmaüos.h
>

55 
	~"ex‹º.h
"

60 #iâdeà
PTYRANGE0


61 
	#PTYRANGE0
 "q´"

	)

63 #iâdeà
PTYRANGE1


64 
	#PTYRANGE1
 "0123456789abcdef"

	)

68 #ifdeà
M_UNIX


69 #undeà
HAVE_SVR4_PTYS


72 
eff_uid
;

75 
	gPtyName
[32], 
	gTtyName
[32];

77 #ià!(
defšed
(
£qu’t
è|| defšed(
_SEQUENT_
è|| defšed(
HAVE_SVR4_PTYS
))

78 #ifdeà
hpux


79 
	gPtyPrÙo
[] = "/dev/ptym/ptyXY";

80 
	gTtyPrÙo
[] = "/dev/pty/ttyXY";

82 #ifdeà
M_UNIX


83 
	gPtyPrÙo
[] = "/dev/ptypXY";

84 
	gTtyPrÙo
[] = "/dev/ttypXY";

86 
	gPtyPrÙo
[] = "/dev/ptyXY";

87 
	gTtyPrÙo
[] = "/dev/ttyXY";

92 
š™ma¡”
 
__P
(());

94 #ià
defšed
(
sun
)

97 
	g±y_´eİ’
 = 1;

99 
	g±y_´eİ’
 = 0;

106 #iâdeà
O_NOCTTY


107 
	#O_NOCTTY
 0

	)

113 
	$š™ma¡”
(
f
)

114 
f
;

116 #ifdeà
POSIX


117 
	`tcæush
(
f
, 
TCIOFLUSH
);

119 #ifdeà
TIOCFLUSH


120 (è
	`ioùl
(
f
, 
TIOCFLUSH
, (*) 0);

123 #ifdeà
LOCKPTY


124 (è
	`ioùl
(
f
, 
TIOCEXCL
, (*) 0);

126 
	}
}

129 
	$In™PTY
(
f
)

130 
f
;

132 ià(
f
 < 0)

134 #ià
	`defšed
(
I_PUSH
è&& defšed(
HAVE_SVR4_PTYS
è&& !defšed(
sgi
è&& !defšed(
lšux
è&& !defšed(
__osf__
è&& !defšed(
M_UNIX
)

135 ià(
	`ioùl
(
f
, 
I_PUSH
, "ptem"))

136 
	`Pªic
(
”ºo
, "InitPTY: cannot I_PUSH…tem");

137 ià(
	`ioùl
(
f
, 
I_PUSH
, "ldterm"))

138 
	`Pªic
(
”ºo
, "InitPTY: cannot I_PUSH†dterm");

139 #ifdeà
sun


140 ià(
	`ioùl
(
f
, 
I_PUSH
, "ttcompat"))

141 
	`Pªic
(
”ºo
, "InitPTY: cannot I_PUSHtcompat");

144 
	}
}

148 #ià
defšed
(
OSX
è&& !defšed(
PTY_DONE
)

149 
	#PTY_DONE


	)

151 
	$O³nPTY
(
‰yn
)

152 **
‰yn
;

154 
f
;

155 ià((
f
 = 
	`İ’_cÚŒŞlšg_±y
(
TtyName
)) < 0)

157 
	`š™ma¡”
(
f
);

158 *
‰yn
 = 
TtyName
;

159  
f
;

160 
	}
}

165 #ià(
defšed
(
£qu’t
è|| defšed(
_SEQUENT_
)è&& !defšed(
PTY_DONE
)

166 
	#PTY_DONE


	)

168 
	$O³nPTY
(
‰yn
)

169 **
‰yn
;

171 *
m
, *
s
;

172 
f
;

174 ià((
f
 = 
	`g‘p£udÙty
(&
s
, &
m
)) < 0)

176 #ifdeà
_SEQUENT_


177 
	`fvhªgup
(
s
);

179 
	`¡ºıy
(
PtyName
, 
m
, (PtyName));

180 
	`¡ºıy
(
TtyName
, 
s
, (TtyName));

181 
	`š™ma¡”
(
f
);

182 *
‰yn
 = 
TtyName
;

183  
f
;

184 
	}
}

189 #ià
defšed
(
__sgi
è&& !defšed(
PTY_DONE
)

190 
	#PTY_DONE


	)

192 
	$O³nPTY
(
‰yn
)

193 **
‰yn
;

195 
f
;

196 *
Çme
, *
	`_g‘±y
();

197 
	`sig»t_t
 (*
sigşd
)
	`__P
(
SIGPROTOARG
);

203 
sigşd
 = 
	`sigÇl
(
SIGCHLD
, 
SIG_DFL
);

204 
Çme
 = 
	`_g‘±y
(&
f
, 
O_RDWR
 | 
O_NONBLOCK
, 0600, 0);

205 
	`sigÇl
(
SIGCHLD
, 
sigşd
);

207 ià(
Çme
 == 0)

209 
	`š™ma¡”
(
f
);

210 *
‰yn
 = 
Çme
;

211  
f
;

212 
	}
}

217 #ià
defšed
(
MIPS
è&& defšed(
HAVE_DEV_PTC
è&& !defšed(
PTY_DONE
)

218 
	#PTY_DONE


	)

220 
	$O³nPTY
(
‰yn
)

221 **
‰yn
;

223 
f
;

224 
¡©
 
buf
;

226 
	`¡rıy
(
PtyName
, "/dev/ptc");

227 ià((
f
 = 
	`İ’
(
PtyName
, 
O_RDWR
 | 
O_NOCTTY
 | 
O_NONBLOCK
)) < 0)

229 ià(
	`f¡©
(
f
, &
buf
) < 0)

231 
	`şo£
(
f
);

234 
	`¥rštf
(
TtyName
, "/dev/‰yq%d", 
	`mšÜ
(
buf
.
¡_rdev
));

235 
	`š™ma¡”
(
f
);

236 *
‰yn
 = 
TtyName
;

237  
f
;

238 
	}
}

243 #ià
defšed
(
HAVE_SVR4_PTYS
è&& !defšed(
PTY_DONE
)

244 
	#PTY_DONE


	)

246 
	$O³nPTY
(
‰yn
)

247 **
‰yn
;

249 
f
;

250 *
m
, *
	`±¢ame
();

251 
uÆock±
 
	`__P
(()), 
g¿Á±
 __P(());

252 #ià
	`defšed
(
HAVE_GETPT
è&& defšed(
lšux
)

253 
g‘±
 
	`__P
(());

255 
	`sig»t_t
 (*
sigşd
)
	`__P
(
SIGPROTOARG
);

257 
	`¡rıy
(
PtyName
, "/dev/ptmx");

258 #ià
	`defšed
(
HAVE_GETPT
è&& defšed(
lšux
)

259 ià((
f
 = 
	`g‘±
()) == -1)

261 ià((
f
 = 
	`İ’
(
PtyName
, 
O_RDWR
 | 
O_NOCTTY
)) == -1)

269 
sigşd
 = 
	`sigÇl
(
SIGCHLD
, 
SIG_DFL
);

270 ià((
m
 = 
	`±¢ame
(
f
)è=ğ
NULL
 || 
	`g¿Á±
(fè|| 
	`uÆock±
(f))

272 
	`sigÇl
(
SIGCHLD
, 
sigşd
);

273 
	`şo£
(
f
);

276 
	`sigÇl
(
SIGCHLD
, 
sigşd
);

277 
	`¡ºıy
(
TtyName
, 
m
, (TtyName));

278 
	`š™ma¡”
(
f
);

279 *
‰yn
 = 
TtyName
;

280  
f
;

281 
	}
}

286 #ià
defšed
(
_AIX
è&& defšed(
HAVE_DEV_PTC
è&& !defšed(
PTY_DONE
)

287 
	#PTY_DONE


	)

290 
	$O³nPTY
(
‰yn
)

291 **
‰yn
;

293 
f
;

296 
	`¡rıy
 (
PtyName
, "/dev/ptc");

297 ià((
f
 = 
	`İ’
 (
PtyName
, 
O_RDWR
 | 
O_NOCTTY
)) < 0)

299 
	`¡ºıy
(
TtyName
, 
	`‰yÇme
(
f
), (TtyName));

300 ià(
eff_uid
 && 
	`acûss
(
TtyName
, 
R_OK
 | 
W_OK
))

302 
	`şo£
(
f
);

305 
	`š™ma¡”
(
f
);

306 #ifdeà
_IBMR2


307 
±y_´eİ’
 = 1;

309 *
‰yn
 = 
TtyName
;

310  
f
;

311 
	}
}

316 #ià
defšed
(
HAVE_OPENPTY
è&& !defšed(
PTY_DONE
)

317 
	#PTY_DONE


	)

319 
	$O³nPTY
(
‰yn
)

320 **
‰yn
;

322 
f
, 
s
;

323 ià(
	`İ’±y
(&
f
, &
s
, 
TtyName
, 
NULL
, NULL) != 0)

325 
	`şo£
(
s
);

326 
	`š™ma¡”
(
f
);

327 
±y_´eİ’
 = 1;

328 *
‰yn
 = 
TtyName
;

329  
f
;

330 
	}
}

335 #iâdeà
PTY_DONE


337 
	$O³nPTY
(
‰yn
)

338 **
‰yn
;

340 *
p
, *
q
, *
l
, *
d
;

341 
f
;

343 
	`debug
("OpenPTY: Using BSD style…tys.\n");

344 
	`¡rıy
(
PtyName
, 
PtyPrÙo
);

345 
	`¡rıy
(
TtyName
, 
TtyPrÙo
);

346 
p
 = 
PtyName
; *p != 'X';…++)

348 
q
 = 
TtyName
; *q != 'X'; q++)

350 
l
 = 
PTYRANGE0
; (*
p
 = *l) != '\0';†++)

352 
d
 = 
PTYRANGE1
; (
p
[1] = *d) != '\0'; d++)

354 
	`debug1
("O³nPTYr› '%s'\n", 
PtyName
);

355 ià((
f
 = 
	`İ’
(
PtyName
, 
O_RDWR
 | 
O_NOCTTY
)) == -1)

357 
q
[0] = *
l
;

358 
q
[1] = *
d
;

359 ià(
eff_uid
 && 
	`acûss
(
TtyName
, 
R_OK
 | 
W_OK
))

361 
	`şo£
(
f
);

364 #ià
	`defšed
(
sun
è&& defšed(
TIOCGPGRP
è&& !defšed(
SUNOS3
)

369 
pg½
;

372 ià(
	`ioùl
(
f
, 
TIOCGPGRP
, (*)&
pg½
è!ğ-1 || 
”ºo
 !ğ
EIO
)

374 
	`şo£
(
f
);

379 
	`š™ma¡”
(
f
);

380 *
‰yn
 = 
TtyName
;

381  
f
;

385 
	}
}

	@putenv.c

58 
	~"cÚfig.h
"

60 #ifdeà
NEEDPUTENV


62 #ià
defšed
(
__STDC__
)

63 
	#__P
(
a
è
	)
a

65 
	#__P
(
a
è()

	)

68 *
m®loc
 
__P
(());

69 *
»®loc
 
__P
((*, ));

70 
ä“
 
__P
((*));

71 
¥rštf
 
__P
((*, *, ...));

73 
	#EXTRASIZE
 5

	)

75 
	g’vsize
 = -1;

76 **
’vœÚ
;

78 
fšd’v
 
__P
((*));

79 
Ãw’v
 
__P
(());

80 
mÜ“nv
 
__P
(());

83 
	$un£‹nv
(
Çme
)

84 *
Çme
;

86 
i
;

88 ià(
’vsize
 < 0)

90 ià(
	`Ãw’v
() < 0)

93 
i
 = 
	`fšd’v
(
Çme
);

94 ià(
i
 < 0)

97 
	`ä“
(
’vœÚ
[
i
]);

98 ià(
’vsize
 > 0)

99 
’vsize
--;

100 ; 
’vœÚ
[
i
]; i++)

101 
’vœÚ
[
i
] =ƒnviron[i+1];

103 
	}
}

106 
	$pu‹nv
(
¡ršg
)

107 *
¡ršg
;

109 
i
;

110 *
p
;

112 ià(
’vsize
 < 0)

114 ià(
	`Ãw’v
() < 0)

118 
i
 = 
	`fšd’v
(
¡ršg
);

120 ià(
i
 < 0)

122 
i
 = 0; 
’vœÚ
[i]; i++);

123 ià(
i
 >ğ(
’vsize
 - 1))

125 ià(
	`mÜ“nv
() < 0)

128 
p
 = 
	`m®loc
(
	`¡¾’
(
¡ršg
) + 1);

129 ià(
p
 == 0)

131 
’vœÚ
[
i
 + 1] = 0;

135 
p
 = 
	`»®loc
(
’vœÚ
[
i
], 
	`¡¾’
(
¡ršg
) + 1);

136 ià(
p
 == 0)

139 
	`¥rštf
(
p
, "%s", 
¡ršg
);

140 
’vœÚ
[
i
] = 
p
;

143 
	}
}

146 
	$fšd’v
(
Çme
)

147 *
Çme
;

149 *
Çmech¬
, *
’vch¬
;

150 
i
, 
found
;

152 
found
 = 0;

153 
i
 = 0; 
’vœÚ
[i] && !
found
; i++)

155 
’vch¬
 = 
’vœÚ
[
i
];

156 
Çmech¬
 = 
Çme
;

157 *
Çmech¬
 && *Çmech¬ !ğ'=' && (*Çmech¬ =ğ*
’vch¬
))

159 
Çmech¬
++;

160 
’vch¬
++;

162 
found
 = ((*
Çmech¬
 =ğ'\0' || *Çmech¬ =ğ'='è&& *
’vch¬
 == '=');

164  
found
 ? 
i
 - 1 : -1;

165 
	}
}

168 
	$Ãw’v
()

170 **
’v
, *
–em
;

171 
i
, 
esize
;

173 
i
 = 0; 
’vœÚ
[i]; i++)

175 
esize
 = 
i
 + 
EXTRASIZE
 + 1;

176 
’v
 = (**)
	`m®loc
(
esize
 *  (
–em
));

177 ià(
’v
 == 0)

180 
i
 = 0; 
’vœÚ
[i]; i++)

182 
–em
 = 
	`m®loc
(
	`¡¾’
(
’vœÚ
[
i
]) + 1);

183 ià(
–em
 == 0)

185 
’v
[
i
] = 
–em
;

186 
	`¡rıy
(
–em
, 
’vœÚ
[
i
]);

189 
’v
[
i
] = 0;

190 
’vœÚ
 = 
’v
;

191 
’vsize
 = 
esize
;

193 
	}
}

196 
	$mÜ“nv
()

198 
esize
;

199 **
’v
;

201 
esize
 = 
’vsize
 + 
EXTRASIZE
;

202 
’v
 = (**)
	`»®loc
((*)
’vœÚ
, 
esize
 *  (*env));

203 ià(
’v
 == 0)

205 
’vœÚ
 = 
’v
;

206 
’vsize
 = 
esize
;

208 
	}
}

	@resize.c

24 
	~<sys/ty³s.h
>

25 
	~<sigÇl.h
>

26 #iâdeà
sun


27 
	~<sys/ioùl.h
>

30 #ifdeà
ISC


31 
	~<sys/‰y.h
>

32 
	~<sys/sioùl.h
>

33 
	~<sys/±y.h
>

36 
	~"cÚfig.h
"

37 
	~"sü“n.h
"

38 
	~"ex‹º.h
"

40 
CheckMaxSize
 
__P
(());

41 
F»eMlše
 
__P
((
mlše
 *));

42 
AÎocMlše
 
__P
((
mlše
 *
ml
, ));

43 
MakeBÏnkLše
 
__P
((*, ));

44 
k¯bÏmm
 
__P
(());

45 
BcİyMlše
 
__P
((
mlše
 *, , mline *, , , ));

46 
Sw­AÉSü“n
 
__P
((
wš
 *));

48 
Ïy”
 *
æay”
;

49 
di¥Ïy
 *di¥Ïy, *
di¥Ïys
;

50 *
bÏnk
, *
nuÎ
;

51 
mlše
 
mlše_bÏnk
, 
mlše_nuÎ
, 
mlše_Şd
;

52 
wš
 *
wšdows
;

53 
Z0width
, 
Z1width
;

54 
ÿ±iÚ®ways
;

56 #ià
defšed
(
TIOCGWINSZ
è|| defšed(
TIOCSWINSZ
)

57 
wšsize
 
	gglwz
;

60 
mlše
 
	gmlše_z”o
 = {

63 #ifdeà
FONT


66 #ifdeà
COLOR


68 #ifdeà
COLORS256


84 
	$CheckSü“nSize
(
chªge_æag
)

85 
chªge_æag
;

87 
wi
, 
he
;

89 ià(
di¥Ïy
 == 0)

91 
	`debug
("CheckScreenSize: No display ->‚o check.\n");

94 #ifdeà
TIOCGWINSZ


95 ià(
	`ioùl
(
D_u£rfd
, 
TIOCGWINSZ
, (*)&
glwz
) != 0)

97 
	`debug2
("CheckSü“nSize: ioùl(%d, TIOCGWINSZè”ºØ%d\n", 
D_u£rfd
, 
”ºo
);

98 
wi
 = 
D_CO
;

99 
he
 = 
D_LI
;

103 
wi
 = 
glwz
.
ws_cŞ
;

104 
he
 = 
glwz
.
ws_row
;

105 ià(
wi
 == 0)

106 
wi
 = 
D_CO
;

107 ià(
he
 == 0)

108 
he
 = 
D_LI
;

111 
wi
 = 
D_CO
;

112 
he
 = 
D_LI
;

115 
	`debug2
("CheckSü“nSize: sü“Ài (%d,%d)\n", 
wi
, 
he
);

118 ià(
chªge_æag
 == 2)

120 
	`debug
("Tryingo‡dapt‡ll windows (-A)\n");

121 
p
 = 
wšdows
;…;… =…->
w_Ãxt
)

122 ià(
p
->
w_di¥Ïy
 =ğ0 ||…->w_di¥Ïy =ğ
di¥Ïy
)

123 
	`ChªgeWšdowSize
(
p
, 
wi
, 
he
,…->
w_hi¡height
);

126 ià(
D_width
 =ğ
wi
 && 
D_height
 =ğ
he
)

128 
	`debug
("CheckScreenSize: No change ->„eturn.\n");

131 #ifdeà
BLANKER_PRG


132 
	`KlBÏnk”
();

134 
	`Re£tIdË
();

135 
	`ChªgeSü“nSize
(
wi
, 
he
, 
chªge_æag
);

138 ià(
chªge_æag
 == 1)

139 
	`Redi¥Ïy
(
D_fÜe
 ? D_fÜe->
w_nÜeäesh
 : 0);

141 
	}
}

144 
	$ChªgeSü“nSize
(
wi
, 
he
, 
chªge_fÜe
)

145 
wi
, 
he
;

146 
chªge_fÜe
;

148 
wš
 *
p
;

149 
ÿnvas
 *
cv
, **
cvµ
;

150 
wwi
;

151 
y
, 
h
, 
hn
;

153 
	`debug2
("ChªgeSü“nSizäom (%d,%dè", 
D_width
, 
D_height
);

154 
	`debug3
("tØ(%d,%dè(chªge_fÜe: %d)\n",
wi
, 
he
, 
chªge_fÜe
);

161 
y
 = 0;

162 
h
 = 
he
;

163 ià(
D_has_h¡©us
 =ğ
HSTATUS_LASTLINE
)

165 ià(
h
 > 1)

166 
h
--;

168 
D_has_h¡©us
 = 0;

170 
cvµ
 = &
D_cvli¡
; (
cv
 = *cvpp); )

172 ià(
h
 < 2 && 
cvµ
 !ğ&
D_cvli¡
)

175 
	`S‘CªvasWšdow
(
cv
, 0);

176 *
cvµ
 = 
cv
->
c_Ãxt
;

177 
	`ä“
(
cv
);

178 ià(
D_fÜecv
 =ğ
cv
)

179 
D_fÜecv
 = 0;

182 
hn
 = (
cv
->
c_ye
 - cv->
c_ys
 + 1è* 
he
 / 
D_height
;

183 ià(
hn
 == 0)

184 
hn
 = 1;

185 ià(
hn
 + 2 >ğ
h
 || 
cv
->
c_Ãxt
 == 0)

186 
hn
 = 
h
 - 1;

187 ià((!
ÿ±iÚ®ways
 && 
cv
 =ğ
D_cvli¡
 && 
h
 - 
hn
 < 2) || hn == 0)

188 
hn
 = 
h
;

189 
	`ASSERT
(
hn
 > 0);

190 
cv
->
c_xs
 = 0;

191 
cv
->
c_xe
 = 
wi
 - 1;

192 
cv
->
c_ys
 = 
y
;

193 
cv
->
c_ye
 = 
y
 + 
hn
 - 1;

195 
cv
->
c_xoff
 = cv->
c_xs
;

196 
cv
->
c_yoff
 = cv->
c_ys
;

198 
y
 +ğ
hn
 + 1;

199 
h
 -ğ
hn
 + 1;

200 
cvµ
 = &
cv
->
c_Ãxt
;

202 
	`R‘hškDi¥ÏyV›wpÜts
();

203 ià(
D_fÜecv
 == 0)

204 
D_fÜecv
 = 
D_cvli¡
;

205 ià(
D_fÜecv
)

206 
D_fÜe
 = 
	`Lay”2Wšdow
(
D_fÜecv
->
c_Ïy”
);

208 
D_width
 = 
wi
;

209 
D_height
 = 
he
;

211 
	`CheckMaxSize
(
wi
);

212 ià(
D_CWS
)

214 
D_defwidth
 = 
D_CO
;

215 
D_defheight
 = 
D_LI
;

219 ià(
D_CZ0
 && (
wi
 =ğ
Z0width
 || w˜=ğ
Z1width
) &&

220 (
D_CO
 =ğ
Z0width
 || D_CO =ğ
Z1width
))

221 
D_defwidth
 = 
D_CO
;

223 
D_defwidth
 = 
wi
;

224 
D_defheight
 = 
he
;

226 
	`debug2
("DeçuÉ size: (%d,%d)\n", 
D_defwidth
, 
D_defheight
);

227 ià(
chªge_fÜe
)

228 
	`ResizeLay”sToCªva£s
();

229 ià(
D_CWS
 =ğ
NULL
 && 
di¥Ïys
->
d_Ãxt
 == 0)

232 
p
 = 
wšdows
;…;… =…->
w_Ãxt
)

234 
	`debug1
("TryšgØchªgwšdow %d.\n", 
p
->
w_numb”
);

235 
wwi
 = 
wi
;

237 ià(
D_CZ0
 && 
p
->
w_width
 !ğ
wi
 && (w˜=ğ
Z0width
 || w˜=ğ
Z1width
))

239 ià(
p
->
w_width
 > (
Z0width
 + 
Z1width
) / 2)

240 
wwi
 = 
Z0width
;

242 
wwi
 = 
Z1width
;

245 ià(
p
->
w_§v–ay”
 &&…->w_§v–ay”->
l_cvli¡
 == 0)

246 
	`ResizeLay”
(
p
->
w_§v–ay”
, 
wwi
, 
he
, 0);

248 
	`ChªgeWšdowSize
(
p
, 
wwi
, 
he
,…->
w_hi¡height
);

252 
	}
}

255 
	$ResizeLay”sToCªva£s
()

257 
ÿnvas
 *
cv
;

258 
Ïy”
 *
l
;

259 
lx
, 
ly
;

261 
	`debug
("ResizeLayersToCanvases\n");

262 
D_k¯bÏmm
 = 0;

263 
cv
 = 
D_cvli¡
; cv; cv = cv->
c_Ãxt
)

265 
l
 = 
cv
->
c_Ïy”
;

266 ià(
l
 == 0)

268 
	`debug
("Doing canvas: ");

269 ià(
l
->
l_width
 =ğ
cv
->
c_xe
 - cv->
c_xs
 + 1 &&

270 
l
->
l_height
 =ğ
cv
->
c_ye
 - cv->
c_ys
 + 1)

272 
	`debug
("already fitting.\n");

275 ià(!
	`MayResizeLay”
(
l
))

277 
	`debug
("may‚ot„esize.\n");

281 
	`debug
("doing„esize.\n");

282 
	`ResizeLay”
(
l
, 
cv
->
c_xe
 - cv->
c_xs
 + 1, cv->
c_ye
 - cv->
c_ys
 + 1, 
di¥Ïy
);

286 
lx
 = 
cv
->
c_Ïy”
->
l_x
;

287 
ly
 = 
cv
->
c_Ïy”
->
l_y
;

288 ià(
ly
 + 
cv
->
c_yoff
 < cv->
c_ys
)

290 
cv
->
c_yoff
 = cv->
c_ys
 - 
ly
;

291 
	`R‘hškV›wpÜtOff£ts
(
cv
);

293 ià(
ly
 + 
cv
->
c_yoff
 > cv->
c_ye
)

295 
cv
->
c_yoff
 = cv->
c_ye
 - 
ly
;

296 
	`R‘hškV›wpÜtOff£ts
(
cv
);

298 ià(
lx
 + 
cv
->
c_xoff
 < cv->
c_xs
)

300 
n
 = 
cv
->
c_xs
 - (
lx
 + cv->
c_xoff
);

301 ià(
n
 < (
cv
->
c_xe
 - cv->
c_xs
 + 1) / 2)

302 
n
 = (
cv
->
c_xe
 - cv->
c_xs
 + 1) / 2;

303 ià(
cv
->
c_xoff
 + 
n
 > cv->
c_xs
)

304 
n
 = 
cv
->
c_xs
 - cv->
c_xoff
;

305 
cv
->
c_xoff
 +ğ
n
;

306 
	`R‘hškV›wpÜtOff£ts
(
cv
);

308 ià(
lx
 + 
cv
->
c_xoff
 > cv->
c_xe
)

310 
n
 = 
lx
 + 
cv
->
c_xoff
 - cv->
c_xe
;

311 ià(
n
 < (
cv
->
c_xe
 - cv->
c_xs
 + 1) / 2)

312 
n
 = (
cv
->
c_xe
 - cv->
c_xs
 + 1) / 2;

313 ià(
cv
->
c_xoff
 - 
n
 + cv->
c_Ïy”
->
l_width
 - 1 < cv->
c_xe
)

314 
n
 = 
cv
->
c_xoff
 + cv->
c_Ïy”
->
l_width
 - 1 - cv->
c_xe
;

315 
cv
->
c_xoff
 -ğ
n
;

316 
	`R‘hškV›wpÜtOff£ts
(
cv
);

319 
	`Redi¥Ïy
(0);

320 ià(
D_k¯bÏmm
)

322 
	`k¯bÏmm
();

323 
D_k¯bÏmm
 = 0;

325 
	}
}

328 
	$MayResizeLay”
(
l
)

329 
Ïy”
 *
l
;

331 
cvs
 = 0;

332 
	`debug
("MayResizeLayer:\n");

333 ; 
l
;† =†->
l_Ãxt
)

335 ià(
l
->
l_cvli¡
)

336 ià(++
cvs
 > 1 || 
l
->
l_cvli¡
->
c_Êext
)

338 
	`debug1
("may‚Ù - cv %d\n", 
cvs
);

342 
	`debug
("may„esize\n");

344 
	}
}

354 
	$k¯bÏmm
()

356 
	`Msg
(0, "Aborted because of window size change.");

357 
	}
}

360 
	$ResizeLay”
(
l
, 
wi
, 
he
, 
nÜefdi¥
)

361 
Ïy”
 *
l
;

362 
wi
, 
he
;

363 
di¥Ïy
 *
nÜefdi¥
;

365 
wš
 *
p
;

366 
ÿnvas
 *
cv
;

367 
Ïy”
 *
Şdæay”
 = 
æay”
;

368 
di¥Ïy
 *
d
, *
Şddi¥Ïy
 = display;

370 ià(
l
->
l_width
 =ğ
wi
 &&†->
l_height
 =ğ
he
)

372 
p
 = 
	`Lay”2Wšdow
(
l
);

374 ià(
Şdæay”
 && (
l
 =ğŞdæay” || 
	`Lay”2Wšdow
(Şdæay”è=ğ
p
))

375 
Şdæay”
->
l_Ãxt
)

376 
Şdæay”
 = oldæay”->
l_Ãxt
;

378 ià(
p
)

380 
d
 = 
di¥Ïys
; d; d = d->
d_Ãxt
)

381 
cv
 = 
d
->
d_cvli¡
; cv; cv = cv->
c_Ãxt
)

383 ià(
p
 =ğ
	`Lay”2Wšdow
(
cv
->
c_Ïy”
))

385 
æay”
 = 
cv
->
c_Ïy”
;

386 ià(
æay”
->
l_Ãxt
)

387 
d
->
d_k¯bÏmm
 = 1;

388 
æay”
->
l_Ãxt
)

389 
	`Ex™Ov”ÏyPage
();

392 
l
 = 
p
->
w_§v–ay”
;

394 
æay”
 = 
l
;

395 ià(
p
 =ğ0 && 
æay”
->
l_Ãxt
 && fÏy”->l_Ãxt->l_Ãxˆ=ğ0 && 
	`LayResize
(
wi
, 
he
) == 0)

397 
æay”
 = fÏy”->
l_Ãxt
;

398 
	`LayResize
(
wi
, 
he
);

399 
æay”
 = 
l
;

403 ià(
æay”
->
l_Ãxt
)

404 
cv
 = 
æay”
->
l_cvli¡
; cv; cv = cv->
c_Êext
)

405 
cv
->
c_di¥Ïy
->
d_k¯bÏmm
 = 1;

406 
æay”
->
l_Ãxt
)

407 
	`Ex™Ov”ÏyPage
();

409 ià(
p
)

410 
æay”
 = &
p
->
w_Ïy”
;

411 
	`LayResize
(
wi
, 
he
);

413 
l
 = 
æay”
;

414 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

416 ià(
di¥Ïy
 =ğ
nÜefdi¥
)

418 
cv
 = 
D_cvli¡
; cv; cv = cv->
c_Ãxt
)

419 ià(
cv
->
c_Ïy”
 =ğ
l
)

421 
	`CV_CALL
(
cv
, 
	`LayRedi¥ÏyLše
(-1, -1, -1, 0));

422 
	`ReäeshA»a
(
cv
->
c_xs
, cv->
c_ys
, cv->
c_xe
, cv->
c_ye
, 0);

424 ià(
D_k¯bÏmm
)

426 
	`k¯bÏmm
();

427 
D_k¯bÏmm
 = 0;

430 
æay”
 = 
Şdæay”
;

431 
di¥Ïy
 = 
Şddi¥Ïy
;

432 
	}
}

436 
	$F»eMlše
(
ml
)

437 
mlše
 *
ml
;

439 ià(
ml
->
image
)

440 
	`ä“
(
ml
->
image
);

441 ià(
ml
->
©Œ
 && ml->©Œ !ğ
nuÎ
)

442 
	`ä“
(
ml
->
©Œ
);

443 #ifdeà
FONT


444 ià(
ml
->
fÚt
 && ml->fÚˆ!ğ
nuÎ
)

445 
	`ä“
(
ml
->
fÚt
);

447 #ifdeà
COLOR


448 ià(
ml
->
cŞÜ
 && ml->cŞÜ !ğ
nuÎ
)

449 
	`ä“
(
ml
->
cŞÜ
);

450 #ifdeà
COLORS256


451 ià(
ml
->
cŞÜx
 && ml->cŞÜx !ğ
nuÎ
)

452 
	`ä“
(
ml
->
cŞÜx
);

455 *
ml
 = 
mlše_z”o
;

456 
	}
}

459 
	$AÎocMlše
(
ml
, 
w
)

460 
mlše
 *
ml
;

461 
w
;

463 
ml
->
image
 = 
	`m®loc
(
w
);

464 
ml
->
©Œ
 = 
nuÎ
;

465 #ifdeà
FONT


466 
ml
->
fÚt
 = 
nuÎ
;

468 #ifdeà
COLOR


469 
ml
->
cŞÜ
 = 
nuÎ
;

470 #ifdeà
COLORS256


471 
ml
->
cŞÜx
 = 
nuÎ
;

474 ià(
ml
->
image
 == 0)

477 
	}
}

481 
	$BcİyMlše
(
mlf
, 
xf
, 
mÉ
, 
xt
, 
l
, 
w
)

482 
mlše
 *
mlf
, *
mÉ
;

483 
xf
, 
xt
, 
l
, 
w
;

485 
r
 = 0;

487 
	`bcİy
((*)
mlf
->
image
 + 
xf
, (*)
mÉ
->imag+ 
xt
, 
l
);

488 ià(
mlf
->
©Œ
 !ğ
nuÎ
 && 
mÉ
->attr ==‚ull)

490 ià((
mÉ
->
©Œ
 = (*)
	`m®loc
(
w
)) == 0)

491 
mÉ
->
©Œ
 = 
nuÎ
, 
r
 = -1;

492 
	`bz”o
((*)
mÉ
->
©Œ
, 
w
);

494 ià(
mÉ
->
©Œ
 !ğ
nuÎ
)

495 
	`bcİy
((*)
mlf
->
©Œ
 + 
xf
, (*)
mÉ
->©Œ + 
xt
, 
l
);

496 #ifdeà
FONT


497 ià(
mlf
->
fÚt
 !ğ
nuÎ
 && 
mÉ
->font ==‚ull)

499 ià((
mÉ
->
fÚt
 = (*)
	`m®loc
(
w
)) == 0)

500 
mÉ
->
fÚt
 = 
nuÎ
, 
r
 = -1;

501 
	`bz”o
((*)
mÉ
->
fÚt
, 
w
);

503 ià(
mÉ
->
fÚt
 !ğ
nuÎ
)

504 
	`bcİy
((*)
mlf
->
fÚt
 + 
xf
, (*)
mÉ
->fÚˆ+ 
xt
, 
l
);

506 #ifdeà
COLOR


507 ià(
mlf
->
cŞÜ
 !ğ
nuÎ
 && 
mÉ
->color ==‚ull)

509 ià((
mÉ
->
cŞÜ
 = (*)
	`m®loc
(
w
)) == 0)

510 
mÉ
->
cŞÜ
 = 
nuÎ
, 
r
 = -1;

511 
	`bz”o
((*)
mÉ
->
cŞÜ
, 
w
);

513 ià(
mÉ
->
cŞÜ
 !ğ
nuÎ
)

514 
	`bcİy
((*)
mlf
->
cŞÜ
 + 
xf
, (*)
mÉ
->cŞÜ + 
xt
, 
l
);

515 #ifdeà
COLORS256


516 ià(
mlf
->
cŞÜx
 !ğ
nuÎ
 && 
mÉ
->colorx ==‚ull)

518 ià((
mÉ
->
cŞÜx
 = (*)
	`m®loc
(
w
)) == 0)

519 
mÉ
->
cŞÜx
 = 
nuÎ
, 
r
 = -1;

520 
	`bz”o
((*)
mÉ
->
cŞÜx
, 
w
);

522 ià(
mÉ
->
cŞÜx
 !ğ
nuÎ
)

523 
	`bcİy
((*)
mlf
->
cŞÜx
 + 
xf
, (*)
mÉ
->cŞÜx + 
xt
, 
l
);

526  
r
;

527 
	}
}

530 
	gmaxwidth
;

533 
	$CheckMaxSize
(
wi
)

534 
wi
;

536 *
ŞdnuÎ
 = 
nuÎ
;

537 
wš
 *
p
;

538 
i
;

539 
mlše
 *
ml
;

541 
wi
 = ((wi + 1) + 255) & ~255;

542 ià(
wi
 <ğ
maxwidth
)

544 
maxwidth
 = 
wi
;

545 
	`debug1
("New maxwidth: %d\n", 
maxwidth
);

546 
bÏnk
 = (*)
	`x»®loc
((*)bÏnk, 
maxwidth
);

547 
nuÎ
 = (*)
	`x»®loc
((*êuÎ, 
maxwidth
);

548 
mlše_Şd
.
image
 = (*)
	`x»®loc
((*)mlše_Şd.image, 
maxwidth
);

549 
mlše_Şd
.
©Œ
 = (*)
	`x»®loc
((*)mlše_Şd.©Œ, 
maxwidth
);

550 #ifdeà
FONT


551 
mlše_Şd
.
fÚt
 = (*)
	`x»®loc
((*)mlše_Şd.fÚt, 
maxwidth
);

553 #ifdeà
COLOR


554 
mlše_Şd
.
cŞÜ
 = (*)
	`x»®loc
((*)mlše_Şd.cŞÜ, 
maxwidth
);

555 #ifdeà
COLORS256


556 
mlše_Şd
.
cŞÜx
 = (*)
	`x»®loc
((*)mlše_Şd.
cŞÜ
, 
maxwidth
);

559 ià(!(
bÏnk
 && 
nuÎ
 && 
mlše_Şd
.
image
 && mlše_Şd.
©Œ
 
	`IFFONT
(&& mlše_Şd.
fÚt
è
	`IFCOLOR
(&& mlše_Şd.
cŞÜ
è
	`IFCOLORX
(&& mlše_Şd.
cŞÜx
)))

560 
	`Pªic
(0, 
¡ºomem
);

562 
	`MakeBÏnkLše
(
bÏnk
, 
maxwidth
);

563 
	`bz”o
((*)
nuÎ
, 
maxwidth
);

565 
mlše_bÏnk
.
image
 = 
bÏnk
;

566 
mlše_bÏnk
.
©Œ
 = 
nuÎ
;

567 
mlše_nuÎ
.
image
 = 
nuÎ
;

568 
mlše_nuÎ
.
©Œ
 = 
nuÎ
;

569 #ifdeà
FONT


570 
mlše_bÏnk
.
fÚt
 = 
nuÎ
;

571 
mlše_nuÎ
.
fÚt
 = 
nuÎ
;

573 #ifdeà
COLOR


574 
mlše_bÏnk
.
cŞÜ
 = 
nuÎ
;

575 
mlše_nuÎ
.
cŞÜ
 = 
nuÎ
;

576 #ifdeà
COLORS256


577 
mlše_bÏnk
.
cŞÜx
 = 
nuÎ
;

578 
mlše_nuÎ
.
cŞÜx
 = 
nuÎ
;

585 
p
 = 
wšdows
;…;… =…->
w_Ãxt
)

587 
ml
 = 
p
->
w_mlšes
;

588 
i
 = 0; i < 
p
->
w_height
; i++, 
ml
++)

590 ià(
ml
->
©Œ
 =ğ
ŞdnuÎ
)

591 
ml
->
©Œ
 = 
nuÎ
;

592 #ifdeà
FONT


593 ià(
ml
->
fÚt
 =ğ
ŞdnuÎ
)

594 
ml
->
fÚt
 = 
nuÎ
;

596 #ifdeà
COLOR


597 ià(
ml
->
cŞÜ
 =ğ
ŞdnuÎ
)

598 
ml
->
cŞÜ
ğ
nuÎ
;

599 #ifdeà
COLORS256


600 ià(
ml
->
cŞÜx
 =ğ
ŞdnuÎ
)

601 
ml
->
cŞÜx
 = 
nuÎ
;

605 #ifdeà
COPY_PASTE


606 
ml
 = 
p
->
w_hlšes
;

607 
i
 = 0; i < 
p
->
w_hi¡height
; i++, 
ml
++)

609 ià(
ml
->
©Œ
 =ğ
ŞdnuÎ
)

610 
ml
->
©Œ
 = 
nuÎ
;

611 #ifdeà
FONT


612 ià(
ml
->
fÚt
 =ğ
ŞdnuÎ
)

613 
ml
->
fÚt
 = 
nuÎ
;

615 #ifdeà
COLOR


616 ià(
ml
->
cŞÜ
 =ğ
ŞdnuÎ
)

617 
ml
->
cŞÜ
ğ
nuÎ
;

618 #ifdeà
COLORS256


619 ià(
ml
->
cŞÜx
 =ğ
ŞdnuÎ
)

620 
ml
->
cŞÜx
 = 
nuÎ
;

626 
	}
}

630 
	$x»®loc
(
mem
, 
Ën
)

631 *
mem
;

632 
Ën
;

634 *
nmem
;

636 ià(
mem
 == 0)

637  
	`m®loc
(
Ën
);

638 ià((
nmem
 = 
	`»®loc
(
mem
, 
Ën
)))

639  
nmem
;

640 
	`ä“
(
mem
);

642 
	}
}

645 
	$MakeBÏnkLše
(
p
, 
n
)

646 *
p
;

647 
n
;

649 
n
--)

650 *
p
++ = ' ';

651 
	}
}

656 #ifdeà
COPY_PASTE


658 
	#OLDWIN
(
y
è((y < 
p
->
w_hi¡height
) \

659 ? &
p
->
w_hlšes
[Õ->
w_hi¡idx
 + 
y
è%…->
w_hi¡height
] \

660 : &
p
->
w_mlšes
[
y
 -…->
w_hi¡height
])

	)

662 
	#NEWWIN
(
y
è((y < 
hi
è? &
nhlšes
[y] : &
nmlšes
[y - hi])

	)

666 
	#OLDWIN
(
y
è(&
p
->
w_mlšes
[y])

	)

667 
	#NEWWIN
(
y
è(&
nmlšes
[y])

	)

673 
	$ChªgeWšdowSize
(
p
, 
wi
, 
he
, 
hi
)

674 
wš
 *
p
;

675 
wi
, 
he
, 
hi
;

677 
mlše
 *
mlf
 = 0, *
mÉ
 = 0, *
ml
, *
nmlšes
, *
nhlšes
;

678 
fy
, 
ty
, 
l
, 
lx
, 
lf
, 
É
, 
yy
, 
Ùy
, 
addÚe
;

679 
ncx
, 
ncy
, 
Çka
, 
t
;

680 
y
, 
shiá
;

682 ià(
wi
 == 0)

683 
he
 = 
hi
 = 0;

685 ià(
p
->
w_width
 =ğ
wi
 &&…->
w_height
 =ğ
he
 &&…->
w_hi¡height
 =ğ
hi
)

687 
	`debug
("ChangeWindowSize: No change.\n");

691 
	`CheckMaxSize
(
wi
);

696 ià(
wi
 && (
p
->
w_width
 !ğw˜||…->
w_height
 !ğ
he
è&&…->
w_Ïy
 !ğ&p->
w_wšÏy
)

698 
	`debug
("ChangeWindowSize: No„esize because of overlay?\n");

703 
	`debug
("ChangeWindowSize");

704 
	`debug3
(" from (%d,%d)+%d", 
p
->
w_width
,…->
w_height
,…->
w_hi¡height
);

705 
	`debug3
("o(%d,%d)+%d\n", 
wi
, 
he
, 
hi
);

707 
fy
 = 
p
->
w_hi¡height
 +…->
w_height
 - 1;

708 
ty
 = 
hi
 + 
he
 - 1;

710 
nmlšes
 = 
nhlšes
 = 0;

711 
ncx
 = 0;

712 
ncy
 = 0;

713 
Çka
 = 0;

715 ià(
wi
)

717 ià(
wi
 !ğ
p
->
w_width
 || 
he
 !ğp->
w_height
)

719 ià((
nmlšes
 = (
mlše
 *)
	`ÿÎoc
(
he
, (mline))) == 0)

721 
	`KlWšdow
(
p
);

722 
	`Msg
(0, 
¡ºomem
);

728 
	`debug1
("imag¡ay th§me: %d†šes\n", 
he
);

729 
nmlšes
 = 
p
->
w_mlšes
;

730 
fy
 -ğ
he
;

731 
ty
 -ğ
he
;

732 
ncx
 = 
p
->
w_x
;

733 
ncy
 = 
p
->
w_y
;

734 
Çka
 = 
p
->
w_autßka
;

737 #ifdeà
COPY_PASTE


738 ià(
hi
)

740 ià((
nhlšes
 = (
mlše
 *)
	`ÿÎoc
(
hi
, (mline))) == 0)

742 
	`Msg
(0, "No memory for history buffer -urned off");

743 
hi
 = 0;

744 
ty
 = 
he
 - 1;

750 
addÚe
 = 0;

751 ià(
p
->
w_width
 &&…->
w_x
 ==…->w_width)

753 
	`debug2
("S³cŸÈaddÚÿ£: %d %d\n", 
p
->
w_x
,…->
w_y
);

754 
addÚe
 = 1;

755 
p
->
w_x
--;

759 ià(
p
->
w_width
 =ğ
wi
)

761 
ncx
 = 
p
->
w_x
 + 
addÚe
;

762 
ncy
 = 
p
->
w_y
 + 
he
 -…->
w_height
;

764 
shiá
 = -
ncy
;

765 
yy
 = 
p
->
w_y
 +…->
w_hi¡height
 - 1; yy >ğ0 && 
ncy
 + 
shiá
 < 
he
; yy--)

767 
ml
 = 
	`OLDWIN
(
yy
);

768 ià(
ml
->
image
[
p
->
w_width
] == ' ')

770 
shiá
++;

772 ià(
shiá
 < 0)

773 
shiá
 = 0;

775 
	`debug1
("»size: cursÜ ouˆoàbounds, shiášg %d\n", 
shiá
);

776 
ncy
 +ğ
shiá
;

777 ià(
p
->
w_autßka
 > 0)

779 
Çka
 = 
p
->
w_autßka
 + 
he
 -…->
w_height
 + 
shiá
;

780 ià(
Çka
 < 1 ||‚ak¨> 
he
)

781 
Çka
 = 0;

783 
shiá
-- > 0)

785 
ml
 = 
	`OLDWIN
(
fy
);

786 
	`F»eMlše
(
ml
);

787 
fy
--;

790 
	`debug2
("fy %dy %d\n", 
fy
, 
ty
);

791 ià(
fy
 >= 0)

792 
mlf
 = 
	`OLDWIN
(
fy
);

793 ià(
ty
 >= 0)

794 
mÉ
 = 
	`NEWWIN
(
ty
);

796 
fy
 >ğ0 && 
ty
 >= 0)

798 ià(
p
->
w_width
 =ğ
wi
)

801 *
mÉ
 = *
mlf
;

802 *
mlf
 = 
mlše_z”o
;

803 ià(--
fy
 >= 0)

804 
mlf
 = 
	`OLDWIN
(
fy
);

805 ià(--
ty
 >= 0)

806 
mÉ
 = 
	`NEWWIN
(
ty
);

811 
l
 = 
p
->
w_width
 - 1;† > 0;†--)

812 ià(
mlf
->
image
[
l
] !ğ' ' || mlf->
©Œ
[l])

814 ià(
fy
 =ğ
p
->
w_y
 +…->
w_hi¡height
 && 
l
 <…->
w_x
)

815 
l
 = 
p
->
w_x
;

816 
l
++;

817 
lf
 = 
l
;

820 
yy
 = 
fy
 - 1; yy >= 0; yy--)

822 
ml
 = 
	`OLDWIN
(
yy
);

823 ià(
ml
->
image
[
p
->
w_width
] == ' ')

825 
l
 +ğ
p
->
w_width
;

829 
É
 = (
l
 - 1è% 
wi
 + 1;

830 
Ùy
 = 
ty
;

831 
l
 > 0 && 
fy
 >ğ0 && 
ty
 >= 0)

833 
lx
 = 
É
 > 
lf
 ?†f :†t;

834 ià(
mÉ
->
image
 == 0)

836 ià(
	`AÎocMlše
(
mÉ
, 
wi
 + 1))

837 
nomem
;

838 
	`MakeBÏnkLše
(
mÉ
->
image
 + 
É
, 
wi
 -†t);

839 
mÉ
->
image
[
wi
] = ((
Ùy
 =ğ
ty
) ? ' ' : 0);

841 ià(
	`BcİyMlše
(
mlf
, 
lf
 - 
lx
, 
mÉ
, 
É
 -†x,†x, 
wi
 + 1))

842 
nomem
;

845 ià(
fy
 =ğ
p
->
w_y
 +…->
w_hi¡height
 && 
lf
 - 
lx
 <ğp->
w_x
 &&†f >…->w_x)

847 
ncx
 = 
p
->
w_x
 + 
É
 - 
lf
 + 
addÚe
;

848 
ncy
 = 
ty
 - 
hi
;

849 
shiá
 = 
wi
 ? -
ncy
 + (
l
 - 
lx
) / wi : 0;

850 ià(
ty
 + 
shiá
 > 
hi
 + 
he
 - 1)

851 
shiá
 = 
hi
 + 
he
 - 1 - 
ty
;

852 ià(
shiá
 > 0)

854 
	`debug3
("»size: cursÜ ouˆoàbounds, shiášg %d [%d/%d]\n", 
shiá
, 
É
 - 
lx
, 
wi
);

855 
y
 = 
hi
 + 
he
 - 1; y >ğ
ty
; y--)

857 
mÉ
 = 
	`NEWWIN
(
y
);

858 
	`F»eMlše
(
mÉ
);

859 ià(
y
 - 
shiá
 < 
ty
)

861 
ml
 = 
	`NEWWIN
(
y
 - 
shiá
);

862 *
mÉ
 = *
ml
;

863 *
ml
 = 
mlše_z”o
;

865 
ncy
 +ğ
shiá
;

866 
ty
 +ğ
shiá
;

867 
mÉ
 = 
	`NEWWIN
(
ty
);

868 ià(
Çka
 > 0)

869 
Çka
 =‚ak¨+ 
shiá
 > 
he
 ? 0 :‚aka + shift;

871 
	`ASSERT
(
ncy
 >= 0);

874 ià(
p
->
w_autßka
 > 0 && 
fy
 =ğp->w_autßk¨- 1 +…->
w_hi¡height
 && 
lf
 - 
lx
 <= 0)

875 
Çka
 = 
ty
 - 
hi
 >= 0 ? 1 +y - hi : 0;

877 
lf
 -ğ
lx
;

878 
É
 -ğ
lx
;

879 
l
 -ğ
lx
;

880 ià(
lf
 == 0)

882 
	`F»eMlše
(
mlf
);

883 
lf
 = 
p
->
w_width
;

884 ià(--
fy
 >= 0)

885 
mlf
 = 
	`OLDWIN
(
fy
);

887 ià(
É
 == 0)

889 
É
 = 
wi
;

890 ià(--
ty
 >= 0)

891 
mÉ
 = 
	`NEWWIN
(
ty
);

894 
	`ASSERT
(
l
 !ğ0 || 
fy
 =ğ
yy
);

896 
fy
 >= 0)

898 
	`F»eMlše
(
mlf
);

899 ià(--
fy
 >= 0)

900 
mlf
 = 
	`OLDWIN
(
fy
);

902 
ty
 >= 0)

904 ià(
	`AÎocMlše
(
mÉ
, 
wi
 + 1))

905 
nomem
;

906 
	`MakeBÏnkLše
(
mÉ
->
image
, 
wi
 + 1);

907 ià(--
ty
 >= 0)

908 
mÉ
 = 
	`NEWWIN
(
ty
);

911 #ifdeà
DEBUG


912 ià(
nmlšes
 !ğ
p
->
w_mlšes
)

913 
fy
 = 0; fy < 
p
->
w_height
 +…->
w_hi¡height
; fy++)

915 
ml
 = 
	`OLDWIN
(
fy
);

916 
	`ASSERT
(
ml
->
image
 == 0);

920 ià(
p
->
w_mlšes
 &&…->w_mlše !ğ
nmlšes
)

921 
	`ä“
((*)
p
->
w_mlšes
);

922 
p
->
w_mlšes
 = 
nmlšes
;

923 #ifdeà
COPY_PASTE


924 ià(
p
->
w_hlšes
 &&…->w_hlše !ğ
nhlšes
)

925 
	`ä“
((*)
p
->
w_hlšes
);

926 
p
->
w_hlšes
 = 
nhlšes
;

928 
nmlšes
 = 
nhlšes
 = 0;

931 ià(
p
->
w_width
 !ğ
wi
)

933 ià(
wi
)

935 
t
 = 
p
->
w_bs
 ?…->
w_width
 : 0;

936 
p
->
w_bs
 = 
	`x»®loc
Õ->w_bs, 
wi
 + 1);

937 ià(
p
->
w_bs
 == 0)

939 
nomem
:

940 ià(
nmlšes
)

942 
ty
 = 
he
 + 
hi
 - 1;y >= 0;y--)

944 
mÉ
 = 
	`NEWWIN
(
ty
);

945 
	`F»eMlše
(
mÉ
);

947 ià(
nmlšes
 && 
p
->
w_mlšes
 !=‚mlines)

948 
	`ä“
((*)
nmlšes
);

949 #ifdeà
COPY_PASTE


950 ià(
nhlšes
 && 
p
->
w_hlšes
 !=‚hlines)

951 
	`ä“
((*)
nhlšes
);

954 
	`KlWšdow
(
p
);

955 
	`Msg
(0, 
¡ºomem
);

958 ; 
t
 < 
wi
;++)

959 
p
->
w_bs
[
t
] = && !(t & 7) ? 1 : 0;

960 
p
->
w_bs
[
wi
] = 0;

964 ià(
p
->
w_bs
)

965 
	`ä“
(
p
->
w_bs
);

966 
p
->
w_bs
 = 0;

971 
p
->
w_Saved_y
 +ğ
ncy
 -…->
w_y
;

973 
p
->
w_x
 = 
ncx
;

974 
p
->
w_y
 = 
ncy
;

975 ià(
p
->
w_autßka
 > 0)

976 
p
->
w_autßka
 = 
Çka
;

979 ià(
p
->
w_x
 > 
wi
)

980 
p
->
w_x
 = 
wi
;

981 ià(
p
->
w_y
 >ğ
he
)

982 
p
->
w_y
 = 
he
 - 1;

983 ià(
p
->
w_Saved_x
 > 
wi
)

984 
p
->
w_Saved_x
 = 
wi
;

985 ià(
p
->
w_Saved_y
 < 0)

986 
p
->
w_Saved_y
 = 0;

987 ià(
p
->
w_Saved_y
 >ğ
he
)

988 
p
->
w_Saved_y
 = 
he
 - 1;

991 
p
->
w_tİ
 = 0;

992 
p
->
w_bÙ
 = 
he
 - 1;

995 #ifdeà
TIOCSWINSZ


996 ià(
wi
 && (
p
->
w_width
 !ğw˜||…->
w_height
 !ğ
he
è&&…->
w_±yfd
 >ğ0 &&…->
w_pid
)

998 
glwz
.
ws_cŞ
 = 
wi
;

999 
glwz
.
ws_row
 = 
he
;

1000 
	`debug
("Setting…ty winsize.\n");

1001 ià(
	`ioùl
(
p
->
w_±yfd
, 
TIOCSWINSZ
, (*)&
glwz
))

1002 
	`debug2
("S‘PtySize:ƒ¼nØ%d (fd:%d)\n", 
”ºo
, 
p
->
w_±yfd
);

1007 
p
->
w_width
 = 
wi
;

1008 
p
->
w_height
 = 
he
;

1009 #ifdeà
COPY_PASTE


1010 
p
->
w_hi¡idx
 = 0;

1011 
p
->
w_hi¡height
 = 
hi
;

1014 #ifdeà
BUILTIN_TELNET


1015 ià(
p
->
w_ty³
 =ğ
W_TYPE_TELNET
)

1016 
	`T–WšdowSize
(
p
);

1019 #ifdeà
DEBUG


1021 
fy
 = 0; fy < 
p
->
w_height
 +…->
w_hi¡height
; fy++)

1023 
ml
 = 
	`OLDWIN
(
fy
);

1024 
	`ASSERT
(
ml
->
image
);

1025 #ifdeà
UTF8


1026 ià(
p
->
w_’codšg
 =ğ
UTF8
)

1028 
l
 = 0;† < 
p
->
w_width
;†++)

1029 
	`ASSERT
(
ml
->
image
[
l
] >ğ' ' || ml->
fÚt
[l]);

1033 
l
 = 0;† < 
p
->
w_width
;†++)

1034 
	`ASSERT
(
ml
->
image
[
l
] >= ' ');

1038 
	}
}

1041 
	$F»eAÉSü“n
(
p
)

1042 
wš
 *
p
;

1044 
i
;

1046 ià(
p
->
w_®t_mlšes
)

1047 
i
 = 0; i < 
p
->
w_®t_height
; i++)

1048 
	`F»eMlše
(
p
->
w_®t_mlšes
 + 
i
);

1049 
p
->
w_®t_mlšes
 = 0;

1050 
p
->
w_®t_width
 = 0;

1051 
p
->
w_®t_height
 = 0;

1052 
p
->
w_®t_x
 = 0;

1053 
p
->
w_®t_y
 = 0;

1054 #ifdeà
COPY_PASTE


1055 ià(
p
->
w_®t_hlšes
)

1056 
i
 = 0; i < 
p
->
w_®t_hi¡height
; i++)

1057 
	`F»eMlše
(
p
->
w_®t_hlšes
 + 
i
);

1058 
p
->
w_®t_hlšes
 = 0;

1059 
p
->
w_®t_hi¡idx
 = 0;

1061 
p
->
w_®t_hi¡height
 = 0;

1062 
	}
}

1065 
	$Sw­AÉSü“n
(
p
)

1066 
wš
 *
p
;

1068 
mlše
 *
ml
;

1069 
t
;

1071 
ml
 = 
p
->
w_®t_mlšes
;…->w_®t_mlše ğp->
w_mlšes
;…->w_mlines = ml;

1072 
t
 = 
p
->
w_®t_width
;…->w_®t_width =…->
w_width
;…->w_width =;

1073 
t
 = 
p
->
w_®t_height
;…->w_®t_heighˆğp->
w_height
;…->w_height =;

1074 
t
 = 
p
->
w_®t_hi¡height
;…->w_®t_hi¡heighˆğp->
w_hi¡height
;…->w_histheight =;

1075 
t
 = 
p
->
w_®t_x
;…->w_®t_x =…->
w_x
;…->w_x =;

1076 
t
 = 
p
->
w_®t_y
;…->w_®t_y =…->
w_y
;…->w_y =;

1077 #ifdeà
COPY_PASTE


1078 
ml
 = 
p
->
w_®t_hlšes
;…->w_®t_hlše ğp->
w_hlšes
;…->w_hlines = ml;

1079 
t
 = 
p
->
w_®t_hi¡idx
;…->w_®t_hi¡idx =…->
w_hi¡idx
;…->w_histidx =;

1081 
	}
}

1084 
	$EÁ”AÉSü“n
(
p
)

1085 
wš
 *
p
;

1087 
ox
 = 
p
->
w_x
, 
oy
 =…->
w_y
;

1088 
	`F»eAÉSü“n
(
p
);

1089 
	`Sw­AÉSü“n
(
p
);

1090 
	`ChªgeWšdowSize
(
p
,…->
w_®t_width
,…->
w_®t_height
,…->
w_®t_hi¡height
);

1091 
p
->
w_x
 = 
ox
;

1092 
p
->
w_y
 = 
oy
;

1093 
	}
}

1096 
	$L—veAÉSü“n
(
p
)

1097 
wš
 *
p
;

1099 ià(!
p
->
w_®t_mlšes
)

1101 
	`Sw­AÉSü“n
(
p
);

1102 
	`ChªgeWšdowSize
(
p
,…->
w_®t_width
,…->
w_®t_height
,…->
w_®t_hi¡height
);

1103 
	`F»eAÉSü“n
(
p
);

1104 
	}
}

	@sched.c

24 
	~<sys/ty³s.h
>

25 #ià!
defšed
(
sun
è&& !defšed(
B43
è&& !defšed(
ISC
è&& !defšed(
pyr
è&& !defšed(
_CX_UX
)

26 
	~<time.h
>

28 
	~<sys/time.h
>

30 
	~"cÚfig.h
"

31 
	~"sü“n.h
"

32 
	~"ex‹º.h
"

34 
ev’t
 *
	gevs
;

35 
ev’t
 *
	g‹vs
;

36 
ev’t
 *
	gÃx‹v
;

37 
	gÿlùimeout
;

39 
ev’t
 *
ÿlùimo
 
__P
(());

40 #ià(
defšed
(
sgi
è&& defšed(
SVR4
)è|| defšed(
__osf__
è|| defšed(
M_UNIX
)

41 
sgihack
 
__P
(());

45 
	$ev’q
(
ev
)

46 
ev’t
 *
ev
;

48 
ev’t
 *
evp
, **
evµ
;

49 
	`debug3
("Newƒv’ˆfd %dy³ %d queued %d\n", 
ev
->
fd
,ƒv->
ty³
,ƒv->
queued
);

50 ià(
ev
->
queued
)

52 
evµ
 = &
evs
;

53 ià(
ev
->
ty³
 =ğ
EV_TIMEOUT
)

55 
ÿlùimeout
 = 1;

56 
evµ
 = &
‹vs
;

58 ; (
evp
 = *
evµ
);ƒvµ = &evp->
Ãxt
)

59 ià(
ev
->
´i
 > 
evp
->pri)

61 
ev
->
Ãxt
 = 
evp
;

62 *
evµ
 = 
ev
;

63 
ev
->
queued
 = 1;

64 
	}
}

67 
	$evdeq
(
ev
)

68 
ev’t
 *
ev
;

70 
ev’t
 *
evp
, **
evµ
;

71 
	`debug3
("Deqƒv’ˆfd %dy³ %d queued %d\n", 
ev
->
fd
,ƒv->
ty³
,ƒv->
queued
);

72 ià(!
ev
->
queued
)

74 
evµ
 = &
evs
;

75 ià(
ev
->
ty³
 =ğ
EV_TIMEOUT
)

77 
ÿlùimeout
 = 1;

78 
evµ
 = &
‹vs
;

80 ; (
evp
 = *
evµ
);ƒvµ = &evp->
Ãxt
)

81 ià(
evp
 =ğ
ev
)

83 
	`ASSERT
(
evp
);

84 *
evµ
 = 
ev
->
Ãxt
;

85 
ev
->
queued
 = 0;

86 ià(
ev
 =ğ
Ãx‹v
)

87 
Ãx‹v
 =‚ex‹v->
Ãxt
;

88 
	}
}

90 
ev’t
 *

91 
	$ÿlùimo
()

93 
ev’t
 *
ev
, *
mš
;

94 
mšs
;

96 ià((
mš
 = 
‹vs
) == 0)

98 
mšs
 = 
mš
->
timeout
.
tv_£c
;

99 
ev
 = 
‹vs
->
Ãxt
;ƒv;ƒv =ƒv->next)

101 
	`ASSERT
(
ev
->
ty³
 =ğ
EV_TIMEOUT
);

102 ià(
mšs
 < 
ev
->
timeout
.
tv_£c
)

104 ià(
mšs
 > 
ev
->
timeout
.
tv_£c
 || 
mš
->timeout.
tv_u£c
 >ƒv->timeout.tv_usec)

106 
mš
 = 
ev
;

107 
mšs
 = 
ev
->
timeout
.
tv_£c
;

110  
mš
;

111 
	}
}

114 
	$sched
()

116 
ev’t
 *
ev
;

117 
fd_£t
 
r
, 
w
, *
£t
;

118 
ev’t
 *
timeou‹v
 = 0;

119 
timev®
 
timeout
;

120 
n£l
;

124 ià(
ÿlùimeout
)

125 
timeou‹v
 = 
	`ÿlùimo
();

126 ià(
timeou‹v
)

128 
	`g‘timeofday
(&
timeout
, 
NULL
);

130 
timeout
.
tv_£c
 = 
timeou‹v
->timeout.tv_sec -imeout.tv_sec;

131 
timeout
.
tv_u£c
 = 
timeou‹v
->timeout.tv_usec -imeout.tv_usec;

132 ià(
timeout
.
tv_u£c
 < 0)

134 
timeout
.
tv_u£c
 += 1000000;

135 
timeout
.
tv_£c
--;

137 ià(
timeout
.
tv_£c
 < 0)

139 
timeout
.
tv_u£c
 = 0;

140 
timeout
.
tv_£c
 = 0;

143 #ifdeà
DEBUG


144 
	`debug
("waiting forƒvents");

145 ià(
timeou‹v
)

146 
	`debug2
("imeouˆ%d sec %d u£cs", 
timeout
.
tv_£c
,imeout.
tv_u£c
);

147 
	`debug
(":\n");

148 
ev
 = 
evs
;ƒv;ƒv =ƒv->
Ãxt
)

149 
	`debug3
(" - fd %dy³ %d…r˜%d\n", 
ev
->
fd
,ƒv->
ty³
,ƒv->
´i
);

150 ià(
‹vs
)

151 
	`debug
("timedƒvents:\n");

152 
ev
 = 
‹vs
;ƒv;ƒv =ƒv->
Ãxt
)

153 
	`debug3
(" -…r˜%d seø%d u£ø%d\n", 
ev
->
´i
,ƒv->
timeout
.
tv_£c
,ƒv->timeout.
tv_u£c
);

156 
	`FD_ZERO
(&
r
);

157 
	`FD_ZERO
(&
w
);

158 
ev
 = 
evs
;ƒv;ƒv =ƒv->
Ãxt
)

160 ià(
ev
->
cÚdpos
 && *ev->cÚdpo <ğÓv->
cÚdÃg
 ? *ev->condneg : 0))

162 
	`debug2
(" - cÚdƒv fd %dy³ %d faed\n", 
ev
->
fd
,ƒv->
ty³
);

165 ià(
ev
->
ty³
 =ğ
EV_READ
)

166 
	`FD_SET
(
ev
->
fd
, &
r
);

167 ià(
ev
->
ty³
 =ğ
EV_WRITE
)

168 
	`FD_SET
(
ev
->
fd
, &
w
);

171 #ifdeà
DEBUG


172 
	`debug
("readfds:");

173 
n£l
 = 0;‚£È< 
FD_SETSIZE
;‚sel++)

174 ià(
	`FD_ISSET
(
n£l
, &
r
))

175 
	`debug1
(" %d", 
n£l
);

176 
	`debug
("\n");

177 
	`debug
("writefds:");

178 
n£l
 = 0;‚£È< 
FD_SETSIZE
;‚sel++)

179 ià(
	`FD_ISSET
(
n£l
, &
w
))

180 
	`debug1
(" %d", 
n£l
);

181 
	`debug
("\n");

184 
n£l
 = 
	`£Ëù
(
FD_SETSIZE
, &
r
, &
w
, (
fd_£t
 *)0, 
timeou‹v
 ? &
timeout
 : (
timev®
 *) 0);

185 ià(
n£l
 < 0)

187 ià(
”ºo
 !ğ
EINTR
)

189 #ià
	`defšed
(
sgi
è&& defšed(
SVR4
)

190 ià(
”ºo
 =ğ
EIO
 && 
	`sgihack
())

193 #ià
	`defšed
(
__osf__
è|| defšed(
M_UNIX
)

196 ià((
”ºo
 =ğ
EIO
 ||ƒ¼nØ=ğ
EBADF
è&& 
	`sgihack
())

199 
	`Pªic
(
”ºo
, "select");

201 
n£l
 = 0;

203 ià(
n£l
 == 0)

205 
	`debug
("TIMEOUT!\n");

206 
	`ASSERT
(
timeou‹v
);

207 
	`evdeq
(
timeou‹v
);

208 
timeou‹v
->
	`hªdËr
Ñimeou‹v,imeou‹v->
d©a
);

210 #ifdeà
SELECT_BROKEN


215 ià(
n£l
)

216 
n£l
 = 2 * 
FD_SETSIZE
;

219 
ev
 = 
evs
;ƒv;ƒv = 
Ãx‹v
)

221 
Ãx‹v
 = 
ev
->
Ãxt
;

222 ià(
ev
->
ty³
 !ğ
EV_ALWAYS
)

224 
£t
 = 
ev
->
ty³
 =ğ
EV_READ
 ? &
r
 : &
w
;

225 ià(
n£l
 =ğ0 || !
	`FD_ISSET
(
ev
->
fd
, 
£t
))

227 
n£l
--;

229 ià(
ev
->
cÚdpos
 && *ev->cÚdpo <ğÓv->
cÚdÃg
 ? *ev->condneg : 0))

231 
	`debug2
(" + h™ƒv fd %dy³ %d!\n", 
ev
->
fd
,ƒv->
ty³
);

232 
ev
->
	`hªdËr
Óv,ƒv->
d©a
);

235 
	}
}

238 
	$S‘Timeout
(
ev
, 
timo
)

239 
ev’t
 *
ev
;

240 
timo
;

242 
	`ASSERT
(
ev
->
ty³
 =ğ
EV_TIMEOUT
);

243 
	`debug2
("ev’ˆ%x‚ewimeouˆ%d ms\n", 
ev
, 
timo
);

244 
	`g‘timeofday
(&
ev
->
timeout
, 
NULL
);

245 
ev
->
timeout
.
tv_£c
 +ğ
timo
 / 1000;

246 
ev
->
timeout
.
tv_u£c
 +ğ(
timo
 % 1000) * 1000;

247 ià(
ev
->
timeout
.
tv_u£c
 > 1000000)

249 
ev
->
timeout
.
tv_u£c
 -= 1000000;

250 
ev
->
timeout
.
tv_£c
++;

252 ià(
ev
->
queued
)

253 
ÿlùimeout
 = 1;

254 
	}
}

257 #ià(
defšed
(
sgi
è&& defšed(
SVR4
)è|| defšed(
__osf__
è|| defšed(
M_UNIX
)

259 
di¥Ïy
 *di¥Ïy, *
di¥Ïys
;

260 
	$sgihack
()

262 
fd_£t
 
r
, 
w
;

263 
timev®
 
tv
;

265 
	`debug
("IRIX5.2 workaround: searching for bad display\n");

266 
di¥Ïy
 = 
di¥Ïys
; display; )

268 
	`FD_ZERO
(&
r
);

269 
	`FD_ZERO
(&
w
);

270 
	`FD_SET
(
D_u£rfd
, &
r
);

271 
	`FD_SET
(
D_u£rfd
, &
w
);

272 
tv
.
tv_£c
 =v.
tv_u£c
 = 0;

273 ià(
	`£Ëù
(
FD_SETSIZE
, &
r
, &
w
, (
fd_£t
 *)0, &
tv
) == -1)

275 ià(
”ºo
 =ğ
EINTR
)

277 
	`Hªgup
();

280 
di¥Ïy
 = di¥Ïy->
d_Ãxt
;

283 
	}
}

	@sched.h

25 
	sev’t


27 
ev’t
 *
	mÃxt
;

28 (*
	mhªdËr
è
__P
((
ev’t
 *, *));

29 *
	md©a
;

30 
	mfd
;

31 
	mty³
;

32 
	m´i
;

33 
timev®
 
	mtimeout
;

34 
	mqueued
;

35 
	maùive
;

36 *
	mcÚdpos
;

37 *
	mcÚdÃg
;

40 
	#EV_TIMEOUT
 0

	)

41 
	#EV_READ
 1

	)

42 
	#EV_WRITE
 2

	)

43 
	#EV_ALWAYS
 3

	)

	@screen.c

33 
	~<sys/ty³s.h
>

34 
	~<ùy³.h
>

36 
	~<fú.h
>

38 #ifdeà
sgi


39 
	~<sys/sysmaüos.h
>

42 
	~<sys/¡©.h
>

43 #iâdeà
sun


44 
	~<sys/ioùl.h
>

47 #iâdeà
SIGINT


48 
	~<sigÇl.h
>

51 
	~"cÚfig.h
"

53 #ifdeà
SVR4


54 
	~<sys/¡rİts.h
>

57 #ià
defšed
(
SYSV
è&& !defšed(
ISC
)

58 
	~<sys/ut¢ame.h
>

61 #ià
defšed
(
£qu’t
è|| defšed(
SVR4
)

62 
	~<sys/»sourû.h
>

65 #ifdeà
ISC


66 
	~<sys/‰y.h
>

67 
	~<sys/sioùl.h
>

68 
	~<sys/±y.h
>

71 #ià(
defšed
(
AUX
è|| defšed(
_AUX_SOURCE
)è&& defšed(
POSIX
)

72 
	~<com·t.h
>

74 #ià
defšed
(
USE_LOCALE
è|| defšed(
ENCODINGS
)

75 
	~<loÿË.h
>

77 #ià
defšed
(
HAVE_NL_LANGINFO
è&& defšed(
ENCODINGS
)

78 
	~<Ïngšfo.h
>

81 
	~"sü“n.h
"

82 #ifdeà
HAVE_BRAILLE


83 
	~"b¿Ë.h
"

86 
	~"·tchËv–.h
"

93 #iâdeà
LOCK


94 #undeà
SHADOWPW


97 
	~<pwd.h
>

98 #ifdeà
SHADOWPW


99 
	~<shadow.h
>

102 
	~"logfe.h
"

104 #ifdeà
DEBUG


105 
FILE
 *
	gdå
;

109 
T”m
[], 
sü“Á”m
[], **
’vœÚ
, 
T”mÿp
[];

110 
	gfÜû_vt
 = 1;

111 
	gVB–lWa™
, 
	gMsgWa™
, 
	gMsgMšWa™
, 
	gS’ûWa™
;

113 
aşu£r
 *
u£rs
;

114 
di¥Ïy
 *
di¥Ïys
, *display;

117 
visu®_b–l
;

118 #ifdeà
COPY_PASTE


119 
m¬k_key_b
[];

121 
v”siÚ
[];

122 
DeçuÉSh–l
[];

123 #ifdeà
ZMODEM


124 *
zmodem_£ndcmd
;

125 *
zmodem_»cvcmd
;

129 *
	gSh–lProg
;

130 *
	gSh–lArgs
[2];

132 
NewWšdow
 
nwš_undef
, 
nwš_deçuÉ
, 
nwš_İtiÚs
;

133 
	gbacktick
;

135 
·sswd
 *
g‘pwbyÇme
 
__P
((*, passwd *));

136 
SigChldHªdËr
 
__P
(());

137 
sig»t_t
 
SigChld
 
__P
(
SIGPROTOARG
);

138 
sig»t_t
 
SigIÁ
 
__P
(
SIGPROTOARG
);

139 
sig»t_t
 
CÜeDump
 
__P
(
SIGPROTOARG
);

140 
sig»t_t
 
Fš™HªdËr
 
__P
(
SIGPROTOARG
);

141 
DoWa™
 
__P
(());

142 
£rv_»ad_â
 
__P
((
ev’t
 *, *));

143 
£rv_£Ëù_â
 
__P
((
ev’t
 *, *));

144 
logæush_â
 
__P
((
ev’t
 *, *));

145 
backtick_f‹r
 
__P
((
backtick
 *));

146 
backtick_â
 
__P
((
ev’t
 *, *));

147 *
runbacktick
 
__P
((
backtick
 *, *, 
time_t
));

148 
IsSymbŞ
 
__P
((*, *));

149 *
P¬£Ch¬
 
__P
((*, *));

150 
P¬£Esÿ³
 
__P
((*));

151 *
·d_ex·nd
 
__P
((*, *, , ));

152 #ifdeà
DEBUG


153 
fds
 
__P
(());

156 
	gnv”siÚ
;

159 
·sswd
 *
	gµp
;

160 *
	g©ch_‰y
;

161 *
	g©ch_‹rm
;

162 *
	gLogšName
;

163 
mode
 
	g©ch_Mode
;

165 
	gSockP©h
[
MAXPATHLEN
 + 2 * 
MAXSTR
];

166 *
	gSockName
;

167 *
	gSockM©ch
 = 
NULL
;

168 
	gS”v”Sock‘
 = -1;

169 
ev’t
 
	g£rv_»ad
;

170 
ev’t
 
	g£rv_£Ëù
;

171 
ev’t
 
	glogæushev
;

173 **
	gNewEnv
 = 
NULL
;

175 *
	gRcFeName
 = 
NULL
;

176 *
	ghome
;

178 *
	gsü“Æogfe
;

179 
	glog_æush
 = 10;

180 
	glogt¡amp_Ú
 = 0;

181 *
	glogt¡amp_¡ršg
;

182 
	glogt¡amp_aá”
 = 120;

183 *
	gh¬dcİydœ
 = 
NULL
;

184 *
	gB–lSŒšg
;

185 *
	gVisu®B–lSŒšg
;

186 *
	gAùiv™ySŒšg
;

187 #ifdeà
COPY_PASTE


188 *
	gBufãrFe
;

190 #ifdeà
POW_DETACH


191 *
	gPowD‘achSŒšg
;

193 *
	gh¡©us¡ršg
;

194 *
	gÿ±iÚ¡ršg
;

195 *
	gtime¡ršg
;

196 *
	gwli¡¡r
;

197 *
	gwli¡t™
;

198 
	gauto_d‘ach
 = 1;

199 
	giæag
, 
	græag
, 
	gdæag
, 
	glsæag
, 
	gqu›tæag
, 
	gweæag
, 
	gxæag
;

200 
	gcmdæag
;

201 
	gad­tæag
;

203 #ifdeà
MULTIUSER


204 *
	gmuÉi
;

205 *
	gmuÉi_home
;

206 
	gmuÉi_uid
;

207 
	gown_uid
;

208 
	gmuÉŸ‰ach
;

209 
	g‰y_mode
;

210 
	g‰y_Şdmode
 = -1;

213 
	gHo¡Name
[
MAXSTR
];

214 
	gMa¡”Pid
;

215 
	g»®_uid
, 
	g»®_gid
, 
	geff_uid
, 
	geff_gid
;

216 
	gdeçuÉ_¡¬tup
;

217 
	gZomb›Key_de¡roy
, 
	gZomb›Key_»su¼eù
;

218 *
	g´e£Ëù
 = 
NULL
;

220 #ifdeà
UTF8


221 *
	gsü“Ãncodšgs
;

224 #ifdeà
NETHACK


225 
	gÃthackæag
 = 0;

227 
	gmaxwš
 = 
MAXWIN
;

230 
Ïy”
 *
	gæay”
;

231 
wš
 *
	gfÜe
;

232 
wš
 *
	gwšdows
;

233 
wš
 *
	gcÚsŞe_wšdow
;

240 
	~"ex‹º.h
"

242 
	g¡ºomem
[] = "Out of memory.";

245 
	gIÁ”ru±PËa£
;

246 
	gGÙSigChld
;

249 
	$lf_£üeİ’
(
Çme
, 
wªtfd
, 
l
)

250 *
Çme
;

251 
wªtfd
;

252 
logfe
 *
l
;

254 
gÙ_fd
;

256 
	`şo£
(
wªtfd
);

257 ià(((
gÙ_fd
 = 
	`£cİ’
(
Çme
, 
O_WRONLY
 | 
O_CREAT
 | 
O_APPEND
, 0666)) < 0) ||

258 
	`lf_move_fd
(
gÙ_fd
, 
wªtfd
) < 0)

260 
	`logfşo£
(
l
);

261 
	`debug1
("lf_£üeİ’: faed fÜ %s\n", 
Çme
);

264 
l
->
¡
->
¡_šo
 =†->¡->
¡_dev
 = 0;

265 
	`debug2
("lf_£üeİ’: %d = %s\n", 
wªtfd
, 
Çme
);

267 
	}
}

274 
·sswd
 *

275 
	$g‘pwbyÇme
(
Çme
, 
µp
)

276 *
Çme
;

277 
·sswd
 *
µp
;

279 
n
;

280 #ifdeà
SHADOWPW


281 
¥wd
 *
sss
 = 
NULL
;

282 *
¥w
 = 
NULL
;

285 ià(!
µp
 && !Õµ = 
	`g‘pwÇm
(
Çme
)))

286  
NULL
;

289 #ifdeà
SHADOWPW


290 
pw_Œy_agaš
:

292 
n
 = 0;

293 ià(
µp
->
pw_·sswd
[0] == '#' &&…pp->pw_passwd[1] == '#' &&

294 
	`¡rcmp
(
µp
->
pw_·sswd
 + 2,…µ->
pw_Çme
) == 0)

295 
n
 = 13;

296 ; 
n
 < 13;‚++)

298 
c
 = 
µp
->
pw_·sswd
[
n
];

299 ià(!(
c
 == '.' || c == '/' || c == '$' ||

300 (
c
 >= '0' && c <= '9') ||

301 (
c
 >= 'a' && c <= 'z') ||

302 (
c
 >= 'A' && c <= 'Z')))

306 #ifdeà
SHADOWPW


308 ià(
n
 < 13 && 
sss
 == 0)

310 
sss
 = 
	`g‘¥Çm
(
µp
->
pw_Çme
);

311 ià(
sss
)

313 ià(
¥w
)

314 
	`ä“
(
¥w
);

315 
µp
->
pw_·sswd
 = 
¥w
 = 
	`SaveSŒ
(
sss
->
¥_pwdp
);

316 
	`’d¥’t
();

317 
pw_Œy_agaš
;

319 
	`’d¥’t
();

322 ià(
n
 < 13)

323 
µp
->
pw_·sswd
 = 0;

324 #ifdeà
lšux


325 ià(
µp
->
pw_·sswd
 && 
	`¡¾’
(ppp->pw_passwd) == 13 + 11)

326 
µp
->
pw_·sswd
[13] = 0;

329  
µp
;

330 
	}
}

334 
	$maš
(
ac
, 
av
)

335 
ac
;

336 **
av
;

338 
n
;

339 *
­
;

340 *
av0
;

341 
sockÇmebuf
[2 * 
MAXSTR
];

342 
mæag
 = 0;

343 *
myÇme
 = (
ac
 =ğ0è? "sü“n" : 
av
[0];

344 *
SockDœ
;

345 
¡©
 
¡
;

346 #ifdeà
_MODE_T


347 
mode_t
 
oumask
;

349 
oumask
;

351 #ià
	`defšed
(
SYSV
è&& !defšed(
ISC
)

352 
ut¢ame
 
ut¢am
;

354 
NewWšdow
 
nwš
;

355 
d‘ached
 = 0;

356 #ifdeà
MULTIUSER


357 *
sockp
;

360 #ià(
	`defšed
(
AUX
è|| defšed(
_AUX_SOURCE
)è&& defšed(
POSIX
)

361 
	`£tcom·t
(
COMPAT_POSIX
|
COMPAT_BSDPROT
);

363 #ià
	`defšed
(
sun
è&& defšed(
SVR4
)

366 
sig£t_t
 
s£t
;

367 
	`sigem±y£t
(&
s£t
);

368 
	`sig´ocmask
(
SIG_SETMASK
, &
s£t
, 0);

376 
	`şo£®lfes
(0);

377 #ifdeà
DEBUG


378 
	`İ’debug
(1, 0);

380 
	`¥rštf
(
v”siÚ
, "%d.%.2d.%.2d% (%sè%s", 
REV
, 
VERS
,

381 
PATCHLEVEL
, 
STATE
, 
ORIGIN
, 
DATE
);

382 
nv”siÚ
 = 
REV
 * 10000 + 
VERS
 * 100 + 
PATCHLEVEL
;

383 
	`debug2
("-- sü“Àdebug s¹ed % (%s)\n", *
av
, 
v”siÚ
);

384 #ifdeà
POSIX


385 
	`debug
("POSIX\n");

387 #ifdeà
TERMIO


388 
	`debug
("TERMIO\n");

390 #ifdeà
SYSV


391 
	`debug
("SYSV\n");

393 #ifdeà
SYSVSIGS


394 
	`debug
("SYSVSIGS\n");

396 #ifdeà
NAMEDPIPE


397 
	`debug
("NAMEDPIPE\n");

399 #ià
	`defšed
(
SIGWINCH
è&& defšed(
TIOCGWINSZ
)

400 
	`debug
("Window size changingƒnabled\n");

402 #ifdeà
HAVE_SETREUID


403 
	`debug
("SETREUID\n");

405 #ifdeà
HAVE_SETEUID


406 
	`debug
("SETEUID\n");

408 #ifdeà
hpux


409 
	`debug
("hpux\n");

411 #ifdeà
USEBCOPY


412 
	`debug
("USEBCOPY\n");

414 #ifdeà
UTMPOK


415 
	`debug
("UTMPOK\n");

417 #ifdeà
LOADAV


418 
	`debug
("LOADAV\n");

420 #ifdeà
NETHACK


421 
	`debug
("NETHACK\n");

423 #ifdeà
TERMINFO


424 
	`debug
("TERMINFO\n");

426 #ifdeà
SHADOWPW


427 
	`debug
("SHADOWPW\n");

429 #ifdeà
NAME_MAX


430 
	`debug1
("NAME_MAX = %d\n", 
NAME_MAX
);

433 
B–lSŒšg
 = 
	`SaveSŒ
("Bell in window %n");

434 
Visu®B–lSŒšg
 = 
	`SaveSŒ
(" Wuff, Wuff!! ");

435 
Aùiv™ySŒšg
 = 
	`SaveSŒ
("Activity in window %n");

436 
sü“Æogfe
 = 
	`SaveSŒ
("screenlog.%n");

437 
logt¡amp_¡ršg
 = 
	`SaveSŒ
("-- %n:%t --ime-stamp -- %M/%d/%y %c:%s --\n");

438 
h¡©us¡ršg
 = 
	`SaveSŒ
("%h");

439 
ÿ±iÚ¡ršg
 = 
	`SaveSŒ
("%3n %t");

440 
time¡ršg
 = 
	`SaveSŒ
("%c:%s %M %d %H%? %l%?");

441 
wli¡t™
 = 
	`SaveSŒ
("Num Name%=Flags");

442 
wli¡¡r
 = 
	`SaveSŒ
("%3n %t%=%f");

443 #ifdeà
COPY_PASTE


444 
BufãrFe
 = 
	`SaveSŒ
(
DEFAULT_BUFFERFILE
);

446 
Sh–lProg
 = 
NULL
;

447 #ifdeà
POW_DETACH


448 
PowD‘achSŒšg
 = 0;

450 
deçuÉ_¡¬tup
 = (
ac
 > 1) ? 0 : 1;

451 
ad­tæag
 = 0;

452 
VB–lWa™
 = 
VBELLWAIT
 * 1000;

453 
MsgWa™
 = 
MSGWAIT
 * 1000;

454 
MsgMšWa™
 = 
MSGMINWAIT
 * 1000;

455 
S’ûWa™
 = 
SILENCEWAIT
;

456 #ifdeà
HAVE_BRAILLE


457 
	`In™B¿Ë
();

459 #ifdeà
ZMODEM


460 
zmodem_£ndcmd
 = 
	`SaveSŒ
("!!! sz -vv -b ");

461 
zmodem_»cvcmd
 = 
	`SaveSŒ
("!!!„z -vv -b -E");

464 #ifdeà
COPY_PASTE


465 
	`CompeKeys
((*)0, 0, 
m¬k_key_b
);

467 #ifdeà
UTF8


468 
	`In™ButšTabs
();

469 
sü“Ãncodšgs
 = 
	`SaveSŒ
(
SCREENENCODINGS
);

471 
nwš
 = 
nwš_undef
;

472 
nwš_İtiÚs
 = 
nwš_undef
;

473 
	`¡rıy
(
sü“Á”m
, "screen");

475 
	`log»İ’_»gi¡”
(
lf_£üeİ’
);

477 
av0
 = *
av
;

479 ià(*
av0
 == '-')

481 
ræag
 = 4;

482 #ifdeà
MULTI


483 
xæag
 = 1;

485 
dæag
 = 1;

487 
Sh–lProg
 = 
	`SaveSŒ
(
DeçuÉSh–l
);

489 
ac
 > 0)

491 
­
 = *++
av
;

492 ià(--
ac
 > 0 && *
­
 == '-')

494 ià(
­
[1] == '-' &&‡p[2] == 0)

496 
av
++;

497 
ac
--;

500 ià(
­
[1] =ğ'-' && !
	`¡rcmp
(ap, "--version"))

501 
	`Pªic
(0, "Sü“Àv”siÚ %s", 
v”siÚ
);

502 ià(
­
[1] =ğ'-' && !
	`¡rcmp
(ap, "--help"))

503 
	`ex™_w™h_u§ge
(
myÇme
, 
NULL
, NULL);

504 
­
 && *ap && *++ap)

506 *
­
)

509 
nwš_İtiÚs
.
aæag
 = 1;

512 
ad­tæag
 = 1;

515 ià(*++
­
)

516 
´e£Ëù
 = 
­
;

519 ià(!--
ac
)

520 
	`ex™_w™h_u§ge
(
myÇme
, "S³cify‡ wšdowØ´e£Ëù w™h -p", 
NULL
);

521 
´e£Ëù
 = *++
av
;

523 
­
 = 
NULL
;

525 #ifdeà
HAVE_BRAILLE


527 
bd
.
bd_¡¬t_b¿Ë
 = 1;

531 ià(*++
­
)

532 
RcFeName
 = 
­
;

535 ià(--
ac
 == 0)

536 
	`ex™_w™h_u§ge
(
myÇme
, "S³cify‡À®‹º©rc-f’amw™h -c", 
NULL
);

537 
RcFeName
 = *++
av
;

539 
­
 = 
NULL
;

542 ià(!*++
­
)

544 ià(--
ac
 == 0)

545 
	`ex™_w™h_u§ge
(
myÇme
, "S³cify commªd ch¬aù” w™h -e", 
NULL
);

546 
­
 = *++
av
;

548 ià(
	`P¬£Esÿ³
(
­
))

549 
	`Pªic
(0, "TwØch¬aù” ¬»quœed w™h -İtiÚ,‚Ù '%s'.", 
­
);

550 
­
 = 
NULL
;

553 
­
++;

554 *
­
++)

558 
nwš_İtiÚs
.
æowæag
 = 
FLOW_NOW
 * 0;

561 
­
--;

565 
nwš_İtiÚs
.
æowæag
 = 
FLOW_NOW
 * 1;

568 
nwš_İtiÚs
.
æowæag
 = 
FLOW_AUTOFLAG
;

571 
	`ex™_w™h_u§ge
(
myÇme
, "UnknowÀæow o±iÚ -%s", --
­
);

575 ià(--
ac
 == 0)

576 
	`ex™_w™h_u§ge
(
myÇme
, 
NULL
, NULL);

577 
nwš_İtiÚs
.
hi¡height
 = 
	`©oi
(*++
av
);

578 ià(
nwš_İtiÚs
.
hi¡height
 < 0)

579 
	`ex™_w™h_u§ge
(
myÇme
, "-h: %s:‚eg©ivsüŞlback size?", *
av
);

582 
iæag
 = 1;

585 ià(--
ac
 == 0)

586 
	`ex™_w™h_u§ge
(
myÇme
, "S³cify‡‚ew wšdow-Çmw™h -t", 
NULL
);

587 
nwš_İtiÚs
.
aka
 = *++
av
;

590 
­
++;

591 *
­
++)

595 
nwš_İtiÚs
.
læag
 = 0;

598 
­
--;

602 
nwš_İtiÚs
.
læag
 = 1;

605 
nwš_İtiÚs
.
læag
 = 3;

609 
lsæag
 = 1;

610 ià(
ac
 > 1 && !
SockM©ch
)

612 
SockM©ch
 = *++
av
;

613 
ac
--;

615 
­
 = 
NULL
;

618 
	`ex™_w™h_u§ge
(
myÇme
, "%s: UnknowÀsubİtiÚØ-l", --
­
);

622 
lsæag
 = 1;

623 
weæag
 = 1;

624 ià(
ac
 > 1 && !
SockM©ch
)

626 
SockM©ch
 = *++
av
;

627 
ac
--;

631 
nwš_İtiÚs
.
Læag
 = 1;

634 
mæag
 = 1;

637 
fÜû_vt
 = 0;

640 ià(--
ac
 == 0)

641 
	`ex™_w™h_u§ge
(
myÇme
, "S³cify”mš®-ty³ w™h -T", 
NULL
);

642 ià(
	`¡¾’
(*++
av
) < 20)

643 
	`¡rıy
(
sü“Á”m
, *
av
);

645 
	`Pªic
(0, "-T:erminal‚ameoo†ong. (max. 20 char)");

646 
nwš_İtiÚs
.
‹rm
 = 
sü“Á”m
;

649 
qu›tæag
 = 1;

653 #ifdeà
MULTI


656 ià(
ac
 > 1 && *
av
[1] !ğ'-' && !
SockM©ch
)

658 
SockM©ch
 = *++
av
;

659 
ac
--;

660 
	`debug2
("ræag=%d, SockM©ch=%s\n", 
dæag
, 
SockM©ch
);

662 #ifdeà
MULTI


663 ià(*
­
 == 'x')

664 
xæag
 = 1;

666 ià(
ræag
)

667 
ræag
 = 2;

668 
ræag
 +ğ(*
­
 == 'R') ? 2 : 1;

670 #ifdeà
REMOTE_DETACH


672 
dæag
 = 1;

675 ià(!
dæag
)

676 
dæag
 = 2;

677 ià(
ac
 == 2)

679 ià(*
av
[1] !ğ'-' && !
SockM©ch
)

681 
SockM©ch
 = *++
av
;

682 
ac
--;

683 
	`debug2
("dæag=%d, SockM©ch=%s\n", 
dæag
, 
SockM©ch
);

689 ià(--
ac
 == 0)

690 
	`ex™_w™h_u§ge
(
myÇme
, "S³cify sh–Èw™h -s", 
NULL
);

691 ià(
Sh–lProg
)

692 
	`ä“
(
Sh–lProg
);

693 
Sh–lProg
 = 
	`SaveSŒ
(*++
av
);

694 
	`debug1
("Sh–lProg: '%s'\n", 
Sh–lProg
);

697 ià(!
SockM©ch
)

699 ià(--
ac
 == 0)

700 
	`ex™_w™h_u§ge
(
myÇme
, "S³cify sessiÚ-Çmw™h -S", 
NULL
);

701 
SockM©ch
 = *++
av
;

703 ià(!*
SockM©ch
)

704 
	`ex™_w™h_u§ge
(
myÇme
, "Em±y sessiÚ-Çme?", 
NULL
);

707 
cmdæag
 = 1;

710 
	`Pªic
(0, "Sü“Àv”siÚ %s", 
v”siÚ
);

712 #ifdeà
UTF8


714 
nwš_İtiÚs
.
’codšg
 =‚wš_İtiÚs.’codšg =ğ-1 ? 
UTF8
 : 0;

718 
	`ex™_w™h_u§ge
(
myÇme
, "UnknowÀİtiÚ %s", --
­
);

726 
»®_uid
 = 
	`g‘uid
();

727 
»®_gid
 = 
	`g‘gid
();

728 
eff_uid
 = 
	`g‘euid
();

729 
eff_gid
 = 
	`g‘egid
();

730 ià(
eff_uid
 !ğ
»®_uid
)

736 #ifdeà
SIGBUS


737 
	`sigÇl
(
SIGBUS
, 
CÜeDump
);

739 
	`sigÇl
(
SIGSEGV
, 
CÜeDump
);

742 #ifdeà
USE_LOCALE


743 
	`£oÿË
(
LC_ALL
, "");

745 #ifdeà
ENCODINGS


746 ià(
nwš_İtiÚs
.
’codšg
 == -1)

749 #ifdeà
HAVE_NL_LANGINFO


750 #iâdeà
USE_LOCALE


751 
	`£oÿË
(
LC_CTYPE
, "");

753 
nwš_İtiÚs
.
’codšg
 = 
	`FšdEncodšg
(
	`Æ_Ïngšfo
(
CODESET
));

754 
	`debug1
("loÿË say ’codšg = %d\n", 
nwš_İtiÚs
.
’codšg
);

756 #ifdeà
UTF8


757 *
s
;

758 ià(((
s
 = 
	`g‘’v
("LC_ALL")) || (s = getenv("LC_CTYPE")) ||

759 (
s
 = 
	`g‘’v
("LANG"))è&& 
	`InSŒ
(s, "UTF-8"))

760 
nwš_İtiÚs
.
’codšg
 = 
UTF8
;

762 
	`debug1
("’vœÚm’ˆ§y ’codšg=%d\n", 
nwš_İtiÚs
.
’codšg
);

766 ià(
SockM©ch
 && 
	`¡¾’
(SockM©chè>ğ
MAXSTR
)

767 
	`Pªic
(0, "Ridiculously†ong socketname -ry‡gain.");

768 ià(
cmdæag
 && !
ræag
 && !
dæag
 && !
xæag
)

769 
xæag
 = 1;

770 ià(!
cmdæag
 && 
dæag
 && 
mæag
 && !(
ræag
 || 
xæag
))

771 
d‘ached
 = 1;

772 
nwš
 = 
nwš_İtiÚs
;

773 #ifdeà
ENCODINGS


774 
nwš
.
’codšg
 = 
nwš_undef
.encoding;

776 ià(
ac
)

777 
nwš
.
¬gs
 = 
av
;

780 #ifdeà
SIGXFSZ


790 
	`sigÇl
(
SIGXFSZ
, 
SIG_IGN
);

793 #ifdeà
SIGPIPE


794 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

797 ià(!
Sh–lProg
)

799 *
sh
;

801 
sh
 = 
	`g‘’v
("SHELL");

802 
Sh–lProg
 = 
	`SaveSŒ
(
sh
 ? sh : 
DeçuÉSh–l
);

804 
Sh–lArgs
[0] = 
Sh–lProg
;

805 
home
 = 
	`g‘’v
("HOME");

807 #ifdeà
NETHACK


808 ià(!(
Ãthackæag
 = (
	`g‘’v
("NETHACKOPTIONS"è!ğ
NULL
)))

810 
Ãthackrc
[
MAXPATHLEN
];

812 ià(
home
 && (
	`¡¾’
(homeè< (
MAXPATHLEN
 - 20)))

814 
	`¥rštf
(
Ãthackrc
,"%s/.Ãthackrc", 
home
);

815 
Ãthackæag
 = !
	`acûss
(
Ãthackrc
, 
F_OK
);

820 #ifdeà
MULTIUSER


821 
own_uid
 = 
muÉi_uid
 = 
»®_uid
;

822 ià(
SockM©ch
 && (
sockp
 = 
	`šdex
(SockMatch, '/')))

824 ià(
eff_uid
)

825 
	`Pªic
(0, "Must„un suid„oot for multiuser support.");

826 *
sockp
 = 0;

827 
muÉi
 = 
SockM©ch
;

828 
SockM©ch
 = 
sockp
 + 1;

829 ià(*
muÉi
)

831 
·sswd
 *
mµp
;

832 ià((
mµp
 = 
	`g‘pwÇm
(
muÉi
)è=ğ(
·sswd
 *)0)

833 
	`Pªic
(0, "CªnÙ id’tify‡ccouÁ '%s'.", 
muÉi
);

834 
muÉi_uid
 = 
mµp
->
pw_uid
;

835 
muÉi_home
 = 
	`SaveSŒ
(
mµp
->
pw_dœ
);

836 ià(
	`¡¾’
(
muÉi_home
è> 
MAXPATHLEN
 - 10)

837 
	`Pªic
(0, "home directory…athoo†ong");

838 #ifdeà
MULTI


840 ià(
ræag
 || 
lsæag
)

841 
xæag
 = 1;

843 
d‘ached
 = 0;

844 
muÉŸ‰ach
 = 1;

847 ià(
SockM©ch
 && *SockMatch == 0)

848 
SockM©ch
 = 0;

851 ià((
LogšName
 = 
	`g‘logš
()) && LoginName[0] != '\0')

853 ià((
µp
 = 
	`g‘pwÇm
(
LogšName
)è!ğ(
·sswd
 *) 0)

854 ià(()
µp
->
pw_uid
 !ğ
»®_uid
)

855 
µp
 = (
·sswd
 *) 0;

857 ià(
µp
 == 0)

859 ià((
µp
 = 
	`g‘pwuid
(
»®_uid
)) == 0)

861 
	`Pªic
(0, "getpwuid() can't identify your‡ccount!");

862 
	`ex™
(1);

864 
LogšName
 = 
µp
->
pw_Çme
;

866 
LogšName
 = 
	`SaveSŒ
(LoginName);

868 
µp
 = 
	`g‘pwbyÇme
(
LogšName
,…pp);

870 #ià!
	`defšed
(
SOCKDIR
è&& defšed(
MULTIUSER
)

871 ià(
muÉi
 && !
muÉŸ‰ach
)

873 ià(
home
 && 
	`¡rcmp
(home, 
µp
->
pw_dœ
))

874 
	`Pªic
(0, "$HOME must match…asswdƒntry for multiuser screens.");

878 ià(
home
 == 0 || *home == '\0')

879 
home
 = 
µp
->
pw_dœ
;

880 ià(
	`¡¾’
(
LogšName
) > 20)

881 
	`Pªic
(0, "LoginNameoo†ong - sorry.");

882 #ifdeà
MULTIUSER


883 ià(
muÉi
 && 
	`¡¾’
(multi) > 20)

884 
	`Pªic
(0, "Screen owner‚ameoo†ong - sorry.");

886 ià(
	`¡¾’
(
home
è> 
MAXPATHLEN
 - 25)

887 
	`Pªic
(0, "$HOMEoo†ong - sorry.");

889 
©ch_‰y
 = "";

890 ià(!
d‘ached
 && !
lsæag
 && !
cmdæag
 && !(
dæag
 && !
mæag
 && !
ræag
 && !
xæag
))

893 ià(!(
©ch_‰y
 = 
	`‰yÇme
(0)))

894 
	`Pªic
(0, "Must be connectedo‡erminal.");

895 ià(
	`¡¾’
(
©ch_‰y
è>ğ
MAXPATHLEN
)

896 
	`Pªic
(0, "TtyNameoo†ong - sorry.");

897 ià(
	`¡©
(
©ch_‰y
, &
¡
))

898 
	`Pªic
(
”ºo
, "CªnÙ‡cûs '%s'", 
©ch_‰y
);

899 #ifdeà
MULTIUSER


900 
‰y_mode
 = ()
¡
.
¡_mode
 & 0777;

902 ià((
n
 = 
	`£cİ’
(
©ch_‰y
, 
O_RDWR
 | 
O_NONBLOCK
, 0)) < 0)

903 
	`Pªic
(0, "CªnÙ o³Àyou¸‹rmš® '%s' -…Ëa£ check.", 
©ch_‰y
);

904 
	`şo£
(
n
);

905 
	`debug1
("©ch_‰y i %s\n", 
©ch_‰y
);

906 ià((
©ch_‹rm
 = 
	`g‘’v
("TERM")) == 0 || *attach_term == 0)

907 
	`Pªic
(0, "Please set‡erminalype.");

908 ià(
	`¡¾’
(
©ch_‹rm
è> (
D_‹rmÇme
) - 1)

909 
	`Pªic
(0, "$TERMoo†ong - sorry.");

910 
	`G‘TTY
(0, &
©ch_Mode
);

911 #ifdeà
DEBUGGGGGGGGGGGGGGG


912 
	`DebugTTY
(&
©ch_Mode
);

916 #ifdeà
_MODE_T


917 
oumask
 = 
	`umask
(0);

919 ià((
oumask
 = ()
	`umask
(0)) == -1)

920 
	`Pªic
(
”ºo
, "Cannot change umasko zero");

922 
SockDœ
 = 
	`g‘’v
("SCREENDIR");

923 ià(
SockDœ
)

925 ià(
	`¡¾’
(
SockDœ
è>ğ
MAXPATHLEN
 - 1)

926 
	`Pªic
(0, "Ridiculously†ong $SCREENDIR -ry‡gain.");

927 #ifdeà
MULTIUSER


928 ià(
muÉi
)

929 
	`Pªic
(0, "No $SCREENDIR with multi screens,…lease.");

932 #ifdeà
MULTIUSER


933 ià(
muÉŸ‰ach
)

935 #iâdeà
SOCKDIR


936 
	`¥rštf
(
SockP©h
, "%s/.sü“n", 
muÉi_home
);

937 
SockDœ
 = 
SockP©h
;

939 
SockDœ
 = 
SOCKDIR
;

940 
	`¥rštf
(
SockP©h
, "%s/S-%s", 
SockDœ
, 
muÉi
);

946 #iâdeà
SOCKDIR


947 ià(
SockDœ
 == 0)

949 
	`¥rštf
(
SockP©h
, "%s/.sü“n", 
home
);

950 
SockDœ
 = 
SockP©h
;

953 ià(
SockDœ
)

955 ià(
	`acûss
(
SockDœ
, 
F_OK
))

957 
	`debug1
("SockDœ '%s' missšg ...\n", 
SockDœ
);

958 ià(
	`U£rCÚ‹xt
() > 0)

960 ià(
	`mkdœ
(
SockDœ
, 0700))

961 
	`U£rR‘uº
(0);

962 
	`U£rR‘uº
(1);

964 ià(
	`U£rStus
() <= 0)

965 
	`Pªic
(0, "CªnÙ makdœeùÜy '%s'.", 
SockDœ
);

967 ià(
SockDœ
 !ğ
SockP©h
)

968 
	`¡rıy
(
SockP©h
, 
SockDœ
);

970 #ifdeà
SOCKDIR


973 
SockDœ
 = 
SOCKDIR
;

974 ià(
	`l¡©
(
SockDœ
, &
¡
))

976 
n
 = (
eff_uid
 =ğ0 && (
»®_uid
 || 
eff_gid
 =ğ
»®_gid
)) ? 0755 :

977 (
eff_gid
 !ğ
»®_gid
) ? 0775 :

978 #ifdeà
S_ISVTX


979 0777|
S_ISVTX
;

983 ià(
	`mkdœ
(
SockDœ
, 
n
) == -1)

984 
	`Pªic
(
”ºo
, "CªnÙ makdœeùÜy '%s'", 
SockDœ
);

988 ià(!
	`S_ISDIR
(
¡
.
¡_mode
))

989 
	`Pªic
(0, "'%s' mu¡ b¨dœeùÜy.", 
SockDœ
);

990 ià(
eff_uid
 =ğ0 && 
»®_uid
 && ()
¡
.
¡_uid
 !=ƒff_uid)

991 
	`Pªic
(0, "DœeùÜy '%s' mu¡ bowÃd by„oÙ.", 
SockDœ
);

992 
n
 = (
eff_uid
 =ğ0 && (
»®_uid
 || (
¡
.
¡_mode
 & 0775) != 0775)) ? 0755 :

993 (
eff_gid
 =ğ()
¡
.
¡_gid
 &&ƒff_gid !ğ
»®_gid
) ? 0775 :

995 ià((()
¡
.
¡_mode
 & 0777è!ğ
n
)

996 
	`Pªic
(0, "DœeùÜy '%s' mu¡ havmod%03o.", 
SockDœ
, 
n
);

998 
	`¥rštf
(
SockP©h
, "%s/S-%s", 
SockDœ
, 
LogšName
);

999 ià(
	`acûss
(
SockP©h
, 
F_OK
))

1001 ià(
	`mkdœ
(
SockP©h
, 0700) == -1)

1002 
	`Pªic
(
”ºo
, "CªnÙ makdœeùÜy '%s'", 
SockP©h
);

1003 (è
	`chown
(
SockP©h
, 
»®_uid
, 
»®_gid
);

1009 ià(
	`¡©
(
SockP©h
, &
¡
) == -1)

1010 
	`Pªic
(
”ºo
, "CªnÙ‡cûs %s", 
SockP©h
);

1012 ià(!
	`S_ISDIR
(
¡
.
¡_mode
))

1013 
	`Pªic
(0, "% i nÙ‡ dœeùÜy.", 
SockP©h
);

1014 #ifdeà
MULTIUSER


1015 ià(
muÉi
)

1017 ià(()
¡
.
¡_uid
 !ğ
muÉi_uid
)

1018 
	`Pªic
(0, "% i nÙhowÃ¸oà%s.", 
muÉi
, 
SockP©h
);

1023 ià(()
¡
.
¡_uid
 !ğ
»®_uid
)

1024 
	`Pªic
(0, "You‡»‚ÙhowÃ¸oà%s.", 
SockP©h
);

1026 ià((
¡
.
¡_mode
 & 0777) != 0700)

1027 
	`Pªic
(0, "DœeùÜy % mu¡ havmod700.", 
SockP©h
);

1028 ià(
SockM©ch
 && 
	`šdex
(SockMatch, '/'))

1029 
	`Pªic
(0, "Bad sessiÚ‚am'%s'", 
SockM©ch
);

1030 
SockName
 = 
SockP©h
 + 
	`¡¾’
(SockPath) + 1;

1031 *
SockName
 = 0;

1032 (è
	`umask
(
oumask
);

1033 
	`debug2
("SockP©h: %  SockM©ch: %s\n", 
SockP©h
, 
SockM©ch
 ? SockMatch : "NULL");

1035 #ià
	`defšed
(
SYSV
è&& !defšed(
ISC
)

1036 ià(
	`uÇme
(&
ut¢am
) == -1)

1037 
	`Pªic
(
”ºo
, "uname");

1038 
	`¡ºıy
(
Ho¡Name
, 
ut¢am
.
nod’ame
, (ut¢am.nod’ameè< 
MAXSTR
 ? (utsnam.nodename) : MAXSTR - 1);

1039 
Ho¡Name
[(
ut¢am
.
nod’ame
è< 
MAXSTR
 ? (utsnam.nodename) : MAXSTR - 1] = '\0';

1041 (è
	`g‘ho¡Çme
(
Ho¡Name
, 
MAXSTR
);

1042 
Ho¡Name
[
MAXSTR
 - 1] = '\0';

1044 ià((
­
 = 
	`šdex
(
Ho¡Name
, '.')è!ğ
NULL
)

1045 *
­
 = '\0';

1047 ià(
lsæag
)

1049 
i
, 
fo
, 
Ùh
;

1051 #ifdeà
MULTIUSER


1052 ià(
muÉi
)

1053 
»®_uid
 = 
muÉi_uid
;

1055 
	`£tgid
(
»®_gid
);

1056 
	`£tuid
(
»®_uid
);

1057 
eff_uid
 = 
»®_uid
;

1058 
eff_gid
 = 
»®_gid
;

1059 
i
 = 
	`FšdSock‘
((*)
NULL
, &
fo
, &
Ùh
, 
SockM©ch
);

1060 ià(
qu›tæag
)

1061 
	`ex™
(8 + (
fo
 ? ((
Ùh
 || 
i
) ? 2 : 1) : 0) + i);

1062 ià(
fo
 == 0)

1063 
	`Pªic
(0, "NØSock‘ found iÀ%s.\n", 
SockP©h
);

1064 
	`Pªic
(0, "%d Sock‘% š %s.\n", 
fo
, fØ> 1 ? "s" : "", 
SockP©h
);

1067 
	`sigÇl
(
SIG_BYE
, 
A‰ach”Fš™
);

1068 ià(
cmdæag
)

1070 *
¡y
 = 0;

1073 ià((
©ch_‰y
 = 
	`‰yÇme
(0)) == 0)

1074 
©ch_‰y
 = "";

1075 ià(
	`¡¾’
(
©ch_‰y
è>ğ
MAXPATHLEN
)

1076 
	`Pªic
(0, "TtyNameoo†ong - sorry.");

1077 ià(!*
av
)

1078 
	`Pªic
(0, "Please specify‡ command.");

1079 
	`£tgid
(
»®_gid
);

1080 
	`£tuid
(
»®_uid
);

1081 
eff_uid
 = 
»®_uid
;

1082 
eff_gid
 = 
»®_gid
;

1083 ià(!
mæag
 && !
SockM©ch
)

1085 
¡y
 = 
	`g‘’v
("STY");

1086 ià(
¡y
 && *sty == 0)

1087 
¡y
 = 0;

1089 
	`S’dCmdMes§ge
(
¡y
, 
SockM©ch
, 
av
);

1090 
	`ex™
(0);

1092 ià(
ræag
 || 
xæag
)

1094 
	`debug
("screen -r: - ishere‡nybody outhere?\n");

1095 ià(
	`A‰ach
(
MSG_ATTACH
))

1097 
	`A‰ach”
();

1100 #ifdeà
MULTIUSER


1101 ià(
muÉŸ‰ach
)

1102 
	`Pªic
(0, "Can't create sessions of other users.");

1104 
	`debug
("screen -r: backend‚ot„esponding -- still crying\n");

1106 ià(
dæag
 && !
mæag
)

1108 (è
	`A‰ach
(
MSG_DETACH
);

1109 
	`Msg
(0, "[% %sd‘ached.]\n", 
SockName
, (
dæag
 > 1 ? "power " : ""));

1110 
	`“x™
(0);

1113 ià(!
SockM©ch
 && !
mæag
)

1115 *
¡y
;

1117 ià((
¡y
 = 
	`g‘’v
("STY")) != 0 && *sty != '\0')

1119 
	`£tgid
(
»®_gid
);

1120 
	`£tuid
(
»®_uid
);

1121 
eff_uid
 = 
»®_uid
;

1122 
eff_gid
 = 
»®_gid
;

1123 
nwš_İtiÚs
.
¬gs
 = 
av
;

1124 
	`S’dC»©eMsg
(
¡y
, &
nwš
);

1125 
	`ex™
(0);

1129 
	`nwš_compo£
(&
nwš_deçuÉ
, &
nwš_İtiÚs
, &nwin_default);

1131 ià(!
d‘ached
 || 
dæag
 != 2)

1132 
Ma¡”Pid
 = 
	`fÜk
();

1134 
Ma¡”Pid
 = 0;

1136 
Ma¡”Pid
)

1139 
	`Pªic
(
”ºo
, "fork");

1144 ià(
d‘ached
)

1145 
	`ex™
(0);

1146 ià(
SockM©ch
)

1147 
	`¥rštf
(
sockÇmebuf
, "%d.%s", 
Ma¡”Pid
, 
SockM©ch
);

1149 
	`¥rštf
(
sockÇmebuf
, "%d.%s.%s", 
Ma¡”Pid
, 
	`¡rdev
(
©ch_‰y
), 
Ho¡Name
);

1150 
­
 = 
sockÇmebuf
; *ap;‡p++)

1151 ià(*
­
 == '/')

1152 *
­
 = '-';

1153 #ifdeà
NAME_MAX


1154 ià(
	`¡¾’
(
sockÇmebuf
è> 
NAME_MAX
)

1155 
sockÇmebuf
[
NAME_MAX
] = 0;

1157 
	`¥rštf
(
SockP©h
 + 
	`¡¾’
(SockP©h), "/%s", 
sockÇmebuf
);

1158 
	`£tgid
(
»®_gid
);

1159 
	`£tuid
(
»®_uid
);

1160 
eff_uid
 = 
»®_uid
;

1161 
eff_gid
 = 
»®_gid
;

1162 
	`A‰ach”
();

1166 ià(
DeçuÉEsc
 == -1)

1167 
DeçuÉEsc
 = 
	`CŒl
('a');

1168 ià(
DeçuÉM‘aEsc
 == -1)

1169 
DeçuÉM‘aEsc
 = 'a';

1171 
­
 = 
av0
 + 
	`¡¾’
(av0) - 1;

1172 
­
 >ğ
av0
)

1174 ià(!
	`¡ºcmp
("sü“n", 
­
, 6))

1176 
	`¡ºıy
(
­
, "SCREEN", 6);

1179 
­
--;

1181 ià(
­
 < 
av0
)

1182 *
av0
 = 'S';

1184 #ifdeà
DEBUG


1186 
buf
[256];

1188 ià(
då
 && då !ğ
¡d”r
)

1189 
	`fşo£
(
då
);

1190 
	`¥rštf
(
buf
, "%s/SCREEN.%d", 
DEBUGDIR
, ()
	`g‘pid
());

1191 ià((
då
 = 
	`fİ’
(
buf
, "w")è=ğ
NULL
)

1192 
då
 = 
¡d”r
;

1194 (è
	`chmod
(
buf
, 0666);

1197 ià(!
d‘ached
)

1200 ià((
n
 = 
	`£cİ’
(
©ch_‰y
, 
O_RDWR
, 0)) < 0)

1201 
	`Pªic
(0, "CªnÙ„eİ’ '%s' -…Ëa£ check.", 
©ch_‰y
);

1204 
n
 = -1;

1205 
	`äeİ’
("/dev/nuÎ", "r", 
¡dš
);

1206 
	`äeİ’
("/dev/nuÎ", "w", 
¡dout
);

1208 #ifdeà
DEBUG


1209 ià(
då
 !ğ
¡d”r
)

1211 
	`äeİ’
("/dev/nuÎ", "w", 
¡d”r
);

1212 
	`debug
("-- screen.back debug started\n");

1219 ià(
	`U£rAdd
(
LogšName
, (*)0, (
aşu£r
 **)0) < 0)

1220 
	`Pªic
(0, "Could‚ot create user info");

1221 ià(!
d‘ached
)

1223 ià(
	`MakeDi¥Ïy
(
LogšName
, 
©ch_‰y
, 
©ch_‹rm
, 
n
, 
	`g‘µid
(), &
©ch_Mode
) == 0)

1224 
	`Pªic
(0, "Could‚ot‡lloc display");

1225 #ifdeà
ENCODINGS


1226 
D_’codšg
 = 
nwš_İtiÚs
.
’codšg
 > 0 ?‚win_options.encoding : 0;

1227 
	`debug1
("D_’codšg = %d\n", 
D_’codšg
);

1231 ià(
SockM©ch
)

1234 
	`¥rštf
(
sockÇmebuf
, "%d.%s", ()
	`g‘pid
(), 
SockM©ch
);

1238 
	`¥rštf
(
sockÇmebuf
, "%d.%s.%s", ()
	`g‘pid
(), 
	`¡rdev
(
©ch_‰y
),

1239 
Ho¡Name
);

1241 
­
 = 
sockÇmebuf
; *ap;‡p++)

1242 ià(*
­
 == '/')

1243 *
­
 = '-';

1244 #ifdeà
NAME_MAX


1245 ià(
	`¡¾’
(
sockÇmebuf
è> 
NAME_MAX
)

1247 
	`debug2
("Sock‘Çm% Œunÿ‹dØ%d ch¬s\n", 
sockÇmebuf
, 
NAME_MAX
);

1248 
sockÇmebuf
[
NAME_MAX
] = 0;

1251 
	`¥rštf
(
SockP©h
 + 
	`¡¾’
(SockP©h), "/%s", 
sockÇmebuf
);

1253 
S”v”Sock‘
 = 
	`MakeS”v”Sock‘
();

1254 
	`In™Keyb
();

1255 #ifdeà
ETCSCREENRC


1256 #ifdeà
ALLOW_SYSSCREENRC


1257 ià((
­
 = 
	`g‘’v
("SYSSCREENRC")))

1258 
	`S¹Rc
(
­
);

1261 
	`S¹Rc
(
ETCSCREENRC
);

1263 
	`S¹Rc
(
RcFeName
);

1264 #ifdeà
UTMPOK


1265 #iâdeà
UTNOKEEP


1266 
	`In™Utmp
();

1269 ià(
di¥Ïy
)

1271 ià(
	`In™T”mÿp
(0, 0))

1273 
	`debug
("Could‚ot initermcap -ƒxiting\n");

1274 
	`fú
(
D_u£rfd
, 
F_SETFL
, 0);

1275 
	`ä“‰y
();

1276 ià(
D_u£½id
)

1277 
	`Kl
(
D_u£½id
, 
SIG_BYE
);

1278 
	`“x™
(1);

1280 
	`MakeDeçuÉCªvas
();

1281 
	`In™T”m
(0);

1282 #ifdeà
UTMPOK


1283 
	`RemoveLogšSlÙ
();

1287 
	`MakeT”mÿp
(1);

1288 #ifdeà
LOADAV


1289 
	`In™Lßdav
();

1291 
	`MakeNewEnv
();

1292 
	`sigÇl
(
SIGHUP
, 
SigHup
);

1293 
	`sigÇl
(
SIGINT
, 
Fš™HªdËr
);

1294 
	`sigÇl
(
SIGQUIT
, 
Fš™HªdËr
);

1295 
	`sigÇl
(
SIGTERM
, 
Fš™HªdËr
);

1296 #ifdeà
BSDJOBS


1297 
	`sigÇl
(
SIGTTIN
, 
SIG_IGN
);

1298 
	`sigÇl
(
SIGTTOU
, 
SIG_IGN
);

1301 ià(
di¥Ïy
)

1303 
	`brk‰y
(
D_u£rfd
);

1304 
	`S‘Mode
(&
D_OldMode
, &
D_NewMode
, 
D_æow
, 
iæag
);

1306 
	`S‘TTY
(
D_u£rfd
, &
D_NewMode
);

1307 ià(
	`fú
(
D_u£rfd
, 
F_SETFL
, 
FNBLOCK
))

1308 
	`Msg
(
”ºo
, "Warning: NBLOCK fcntl failed");

1311 
	`brk‰y
(-1);

1312 
	`sigÇl
(
SIGCHLD
, 
SigChld
);

1313 #ifdeà
ETCSCREENRC


1314 #ifdeà
ALLOW_SYSSCREENRC


1315 ià((
­
 = 
	`g‘’v
("SYSSCREENRC")))

1316 
	`FšishRc
(
­
);

1319 
	`FšishRc
(
ETCSCREENRC
);

1321 
	`FšishRc
(
RcFeName
);

1323 
	`debug2
("UID %d EUID %d\n", ()
	`g‘uid
(), ()
	`g‘euid
());

1324 ià(
wšdows
 =ğ
NULL
)

1326 
	`debug
("We open one default window,‡s screenrc did‚ot specify one.\n");

1327 ià(
	`MakeWšdow
(&
nwš
) == -1)

1329 
	`Msg
(0, "Sorry, could‚ot find‡ PTY.");

1330 
	`¦“p
(5);

1331 
	`Fš™
(0);

1336 #ifdeà
HAVE_BRAILLE


1337 
	`S¹B¿Ë
();

1340 ià(
di¥Ïy
 && 
deçuÉ_¡¬tup
)

1341 
	`di¥Ïy_cİyright
();

1342 
	`sigÇl
(
SIGINT
, 
SigIÁ
);

1343 ià(
ræag
 && (rflag & 1) == 0)

1345 
	`Msg
(0, "New screen...");

1346 
ræag
 = 0;

1349 
£rv_»ad
.
ty³
 = 
EV_READ
;

1350 
£rv_»ad
.
fd
 = 
S”v”Sock‘
;

1351 
£rv_»ad
.
hªdËr
 = 
£rv_»ad_â
;

1352 
	`ev’q
(&
£rv_»ad
);

1354 
£rv_£Ëù
.
´i
 = -10;

1355 
£rv_£Ëù
.
ty³
 = 
EV_ALWAYS
;

1356 
£rv_£Ëù
.
hªdËr
 = 
£rv_£Ëù_â
;

1357 
	`ev’q
(&
£rv_£Ëù
);

1359 
logæushev
.
ty³
 = 
EV_TIMEOUT
;

1360 
logæushev
.
hªdËr
 = 
logæush_â
;

1362 
	`sched
();

1365 
	}
}

1368 
	$WšdowD›d
(
p
)

1369 
wš
 *
p
;

1371 ià(
Zomb›Key_de¡roy
)

1373 
buf
[100], *
s
;

1374 
time_t
 
now
;

1376 (è
	`time
(&
now
);

1377 
s
 = 
	`ùime
(&
now
);

1378 ià(
s
 && *s)

1379 
s
[
	`¡¾’
(s) - 1] = '\0';

1380 
	`debug3
("window %d (%s) going into zombie state fd %d",

1381 
p
->
w_numb”
,…->
w_t™Ë
,…->
w_±yfd
);

1382 #ifdeà
UTMPOK


1383 ià(
p
->
w_¦Ù
 !ğ(
¦Ù_t
)0 &&…->w_slot != (slot_t)-1)

1385 
	`RemoveUtmp
(
p
);

1386 
p
->
w_¦Ù
 = 0;

1389 
	`Clo£Deviû
(
p
);

1391 
p
->
w_pid
 = 0;

1392 
	`Re£tWšdow
(
p
);

1394 
p
->
w_y
 = 
	`MFšdU£dLše
Õ,…->
w_bÙ
, 1);

1395 
	`¥rštf
(
buf
, "\n\r==ğWšdow”mš©ed (%sè===", 
s
 ? s : "?");

1396 
	`Wr™eSŒšg
(
p
, 
buf
, 
	`¡¾’
(buf));

1397 
	`WšdowChªged
(
p
, 'f');

1400 
	`KlWšdow
(
p
);

1401 #ifdeà
UTMPOK


1402 
	`C¬efulUtmp
();

1404 
	}
}

1407 
	$SigChldHªdËr
()

1409 
¡©
 
¡
;

1410 #ifdeà
DEBUG


1411 
	`fds
();

1413 
GÙSigChld
)

1415 
GÙSigChld
 = 0;

1416 
	`DoWa™
();

1417 #ifdeà
SYSVSIGS


1418 
	`sigÇl
(
SIGCHLD
, 
SigChld
);

1421 ià(
	`¡©
(
SockP©h
, &
¡
) == -1)

1423 
	`debug1
("SigChldHªdËr: Yuck! cªnÙ sˆ'%s'\n", 
SockP©h
);

1424 ià(!
	`Recov”Sock‘
())

1426 
	`debug
("SCREEN cannot„ecover from corrupt Socket, bye\n");

1427 
	`Fš™
(1);

1430 
	`debug1
("'%s'„ecÚ¡ruùed\n", 
SockP©h
);

1433 
	`debug2
("SigChldHªdËr: sˆ'%s' o.k. (%03o)\n", 
SockP©h
, ()
¡
.
¡_mode
);

1434 
	}
}

1436 
sig»t_t


1437 
SigChld
 
	gSIGDEFARG


1439 
debug
("SigChld()\n");

1440 
	gGÙSigChld
 = 1;

1441 
	gSIGRETURN
;

1444 
sig»t_t


1445 
SigHup
 
	gSIGDEFARG


1448 (
	gdi¥Ïy
 = 
di¥Ïys
) != 0)

1449 
Hªgup
();

1450 
	gSIGRETURN
;

1458 
sig»t_t


1459 
SigIÁ
 
	gSIGDEFARG


1461 #ià
HAZARDOUS


1462 
	gibuf
;

1464 
debug
("SigInt()\n");

1465 ià(
	gfÜe
 && 
	gdi¥Ïys
)

1467 #ià
defšed
(
TERMIO
è|| defšed(
POSIX
)

1468 
	gibuf
 = 
di¥Ïys
->
d_OldMode
.
tio
.
c_cc
[
VINTR
];

1470 
	gibuf
 = 
di¥Ïys
->
d_OldMode
.
m_tch¬s
.
t_šŒc
;

1472 
	gfÜe
->
	gw_šËn
 = 0;

1473 
wr™e
(
fÜe
->
w_±yfd
, &
ibuf
, 1);

1476 
sigÇl
(
SIGINT
, 
SigIÁ
);

1477 
debug
("SigInt() careful\n");

1478 
	gIÁ”ru±PËa£
 = 1;

1480 
	gSIGRETURN
;

1483 
sig»t_t


1484 
CÜeDump
 
	gSIGDEFARG


1486 
di¥Ïy
 *
	gdi¥
;

1487 
	gbuf
[80];

1489 #ià
defšed
(
SYSVSIGS
è&& defšed(
SIGHASARG
)

1490 
sigÇl
(
sigsig
, 
SIG_IGN
);

1492 
£tgid
(
g‘gid
());

1493 
£tuid
(
g‘uid
());

1494 
uÆšk
("core");

1495 #ifdeà
SIGHASARG


1496 
¥rštf
(
buf
, "\r\n[sü“ÀÿughˆsigÇÈ%d.%s]\r\n", 
sigsig
,

1498 
¥rštf
(
buf
, "\r\n[screen caught‡ fatal signal.%s]\r\n",

1500 #ià
defšed
(
SHADOWPW
è&& !defšed(
DEBUG
è&& !defšed(
DUMPSHADOW
)

1506 
di¥
 = 
di¥Ïys
; di¥; di¥ = di¥->
d_Ãxt
)

1508 
fú
(
di¥
->
d_u£rfd
, 
F_SETFL
, 0);

1509 
S‘TTY
(
di¥
->
d_u£rfd
, &
D_OldMode
);

1510 
wr™e
(
di¥
->
d_u£rfd
, 
buf
, 
¡¾’
(buf));

1511 
Kl
(
di¥
->
d_u£½id
, 
SIG_BYE
);

1513 #ià
defšed
(
SHADOWPW
è&& !defšed(
DEBUG
è&& !defšed(
DUMPSHADOW
)

1514 
Kl
(
g‘pid
(), 
SIGKILL
);

1515 
“x™
(11);

1517 
abÜt
();

1519 
SIGRETURN
;

1523 
	$DoWa™
()

1525 
pid
;

1526 
wš
 *
p
, *
Ãxt
;

1527 #ifdeà
BSDWAIT


1528 
wa™
 
w¡©
;

1530 
w¡©
;

1533 #ifdeà
BSDJOBS


1534 #iâdeà
BSDWAIT


1535 (
pid
 = 
	`wa™pid
(-1, &
w¡©
, 
WNOHANG
 | 
WUNTRACED
)) > 0)

1537 #ifdeà
USE_WAIT2


1543 (
pid
 = 
	`wa™2
(&
w¡©
, 
WNOHANG
 | 
WUNTRACED
 )) > 0)

1545 (
pid
 = 
	`wa™3
(&
w¡©
, 
WNOHANG
 | 
WUNTRACED
, (
ru§ge
 *) 0)) > 0)

1549 (
pid
 = 
	`wa™
(&
w¡©
)) < 0)

1550 ià(
”ºo
 !ğ
EINTR
)

1552 ià(
pid
 > 0)

1555 
p
 = 
wšdows
;…;… = 
Ãxt
)

1557 
Ãxt
 = 
p
->
w_Ãxt
;

1558 ià(
pid
 =ğ
p
->
w_pid
)

1560 #ifdeà
BSDJOBS


1561 ià(
	`WIFSTOPPED
(
w¡©
))

1563 
	`debug3
("Wšdow %d…id %d: WIFSTOPPED (sig %d)\n", 
p
->
w_numb”
,…->
w_pid
, 
	`WSTOPSIG
(
w¡©
));

1564 #ifdeà
SIGTTIN


1565 ià(
	`WSTOPSIG
(
w¡©
è=ğ
SIGTTIN
)

1567 
	`Msg
(0, "Suspended (tty input)");

1571 #ifdeà
SIGTTOU


1572 ià(
	`WSTOPSIG
(
w¡©
è=ğ
SIGTTOU
)

1574 
	`Msg
(0, "Suspended (tty output)");

1579 
	`Msg
(0, "Child has been stopped,„estarting.");

1580 ià(
	`kÍg
(
p
->
w_pid
, 
SIGCONT
))

1581 
	`kl
(
p
->
w_pid
, 
SIGCONT
);

1586 
	`WšdowD›d
(
p
);

1590 #ifdeà
PSEUDOS


1591 ià(
p
->
w_pwš
 && 
pid
 =ğp->w_pwš->
p_pid
)

1593 
	`debug2
("p£udØoàwš N¸%d d›d.…id =ğ%d\n", 
p
->
w_numb”
,…->
w_pwš
->
p_pid
);

1594 
	`F»eP£udowš
(
p
);

1599 ià(
p
 == 0)

1601 
	`debug1
("pid %d‚Ù found - hİth©' ok\n", 
pid
);

1604 
	}
}

1607 
sig»t_t


1608 
Fš™HªdËr
 
SIGDEFARG


1610 #ifdeà
SIGHASARG


1611 
debug1
("Fš™HªdË¸ÿÎed, sig %d.\n", 
sigsig
);

1613 
debug
("FinitHandler called.\n");

1615 
Fš™
(1);

1616 
SIGRETURN
;

1620 
	$Fš™
(
i
)

1621 
i
;

1623 
wš
 *
p
, *
Ãxt
;

1625 
	`sigÇl
(
SIGCHLD
, 
SIG_DFL
);

1626 
	`sigÇl
(
SIGHUP
, 
SIG_IGN
);

1627 
	`debug1
("Fš™(%d);\n", 
i
);

1628 
p
 = 
wšdows
;…;… = 
Ãxt
)

1630 
Ãxt
 = 
p
->
w_Ãxt
;

1631 
	`F»eWšdow
(
p
);

1633 ià(
S”v”Sock‘
 != -1)

1635 
	`debug1
("wuÆšk(%s)\n", 
SockP©h
);

1636 #ifdeà
USE_SETEUID


1637 
	`x£‹uid
(
»®_uid
);

1638 
	`x£‹gid
(
»®_gid
);

1640 (è
	`uÆšk
(
SockP©h
);

1641 #ifdeà
USE_SETEUID


1642 
	`x£‹uid
(
eff_uid
);

1643 
	`x£‹gid
(
eff_gid
);

1646 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

1648 ià(
D_¡©us
)

1649 
	`RemoveStus
();

1650 
	`Fš™T”m
();

1651 #ifdeà
UTMPOK


1652 
	`Re¡ÜeLogšSlÙ
();

1654 
	`AddSŒ
("[screen iserminating]\r\n");

1655 
	`Flush
();

1656 
	`S‘TTY
(
D_u£rfd
, &
D_OldMode
);

1657 
	`fú
(
D_u£rfd
, 
F_SETFL
, 0);

1658 
	`ä“‰y
();

1659 
	`Kl
(
D_u£½id
, 
SIG_BYE
);

1665 
	`ex™
(
i
);

1666 
	}
}

1669 
	$“x™
(
e
)

1670 
e
;

1672 
	`debug
("eexit\n");

1673 ià(
S”v”Sock‘
 != -1)

1675 
	`debug1
("wuÆšk(%s)\n", 
SockP©h
);

1676 
	`£tgid
(
»®_gid
);

1677 
	`£tuid
(
»®_uid
);

1678 (è
	`uÆšk
(
SockP©h
);

1680 
	`ex™
(
e
);

1681 
	}
}

1684 
	$Hªgup
()

1686 ià(
di¥Ïy
 == 0)

1688 
	`debug1
("Hªgu°%x\n", 
di¥Ïy
);

1689 ià(
D_u£rfd
 >= 0)

1691 
	`şo£
(
D_u£rfd
);

1692 
D_u£rfd
 = -1;

1694 ià(
auto_d‘ach
 || 
di¥Ïys
->
d_Ãxt
)

1695 
	`D‘ach
(
D_HANGUP
);

1697 
	`Fš™
(0);

1698 
	}
}

1714 
	$D‘ach
(
mode
)

1715 
mode
;

1717 
sign
 = 0, 
pid
;

1718 
ÿnvas
 *
cv
;

1719 
wš
 *
p
;

1721 ià(
di¥Ïy
 == 0)

1724 
	`sigÇl
(
SIGHUP
, 
SIG_IGN
);

1725 
	`debug1
("D‘ach(%d)\n", 
mode
);

1726 ià(
D_¡©us
)

1727 
	`RemoveStus
();

1728 
	`Fš™T”m
();

1729 ià(!
di¥Ïy
)

1731 
mode
)

1733 
D_HANGUP
:

1734 
sign
 = 
SIG_BYE
;

1736 
D_DETACH
:

1737 
	`AddSŒ
("[detached]\r\n");

1738 
sign
 = 
SIG_BYE
;

1740 #ifdeà
BSDJOBS


1741 
D_STOP
:

1742 
sign
 = 
SIG_STOP
;

1745 #ifdeà
REMOTE_DETACH


1746 
D_REMOTE
:

1747 
	`AddSŒ
("[remote detached]\r\n");

1748 
sign
 = 
SIG_BYE
;

1751 #ifdeà
POW_DETACH


1752 
D_POWER
:

1753 
	`AddSŒ
("[power detached]\r\n");

1754 ià(
PowD‘achSŒšg
)

1756 
	`AddSŒ
(
PowD‘achSŒšg
);

1757 
	`AddSŒ
("\r\n");

1759 
sign
 = 
SIG_POWER_BYE
;

1761 #ifdeà
REMOTE_DETACH


1762 
D_REMOTE_POWER
:

1763 
	`AddSŒ
("[remote…ower detached]\r\n");

1764 ià(
PowD‘achSŒšg
)

1766 
	`AddSŒ
(
PowD‘achSŒšg
);

1767 
	`AddSŒ
("\r\n");

1769 
sign
 = 
SIG_POWER_BYE
;

1773 
D_LOCK
:

1774 
	`CË¬AÎ
();

1775 
sign
 = 
SIG_LOCK
;

1779 #ifdeà
UTMPOK


1780 ià(
di¥Ïys
->
d_Ãxt
 == 0)

1782 
p
 = 
wšdows
;…;… =…->
w_Ãxt
)

1784 ià(
p
->
w_¦Ù
 !ğ(
¦Ù_t
è-1 && !Õ->
w_læag
 & 2))

1786 
	`RemoveUtmp
(
p
);

1791 
p
->
w_¦Ù
 = (
¦Ù_t
) 0;

1795 ià(
mode
 !ğ
D_HANGUP
)

1796 
	`Re¡ÜeLogšSlÙ
();

1798 ià(
di¥Ïys
->
d_Ãxt
 =ğ0 && 
cÚsŞe_wšdow
)

1800 ià(
	`TtyG¿bCÚsŞe
(
cÚsŞe_wšdow
->
w_±yfd
, 0, "detach"))

1802 
	`debug
("could‚ot„elease console - killing window\n");

1803 
	`KlWšdow
(
cÚsŞe_wšdow
);

1804 
di¥Ïy
 = 
di¥Ïys
;

1807 ià(
D_fÜe
)

1809 #ifdeà
MULTIUSER


1810 
	`R–—£AutoWr™–ock
(
di¥Ïy
, 
D_fÜe
);

1812 
D_u£r
->
u_d‘achwš
 = 
D_fÜe
->
w_numb”
;

1813 
D_u£r
->
u_d‘achÙh”wš
 = 
D_Ùh”
 ? D_Ùh”->
w_numb”
 : -1;

1815 
cv
 = 
D_cvli¡
; cv; cv = cv->
c_Ãxt
)

1817 
p
 = 
	`Lay”2Wšdow
(
cv
->
c_Ïy”
);

1818 
	`S‘CªvasWšdow
(
cv
, 0);

1819 ià(
p
)

1820 
	`WšdowChªged
(
p
, 'u');

1823 
pid
 = 
D_u£½id
;

1824 
	`debug2
("di¥Ïy: %#x di¥Ïys: %#x\n", ()
di¥Ïy
, ()
di¥Ïys
);

1825 
	`F»eDi¥Ïy
();

1826 ià(
di¥Ïys
 == 0)

1828 (è
	`chsock
();

1834 
	`Kl
(
pid
, 
sign
);

1835 
	`debug2
("D‘ach: SigÇÈ%dØA‰ach”(%d)!\n", 
sign
, 
pid
);

1836 
	`debug
("Detach„eturns, we‡re successfully detached.\n");

1837 
	`sigÇl
(
SIGHUP
, 
SigHup
);

1838 
	}
}

1841 
	$IsSymbŞ
(
e
, 
s
)

1842 *
e
, *
s
;

1844 
l
;

1846 
l
 = 
	`¡¾’
(
s
);

1847  
	`¡ºcmp
(
e
, 
s
, 
l
) == 0 &&ƒ[l] == '=';

1848 
	}
}

1851 
	$MakeNewEnv
()

1853 **
İ
, **
Å
;

1854 
¡ybuf
[
MAXSTR
];

1856 
İ
 = 
’vœÚ
; *op; ++op)

1858 ià(
NewEnv
)

1859 
	`ä“
((*)
NewEnv
);

1860 
NewEnv
 = 
Å
 = (**è
	`m®loc
((è(
İ
 - 
’vœÚ
 + 7 + 1) * (**));

1861 ià(!
NewEnv
)

1862 
	`Pªic
(0, 
¡ºomem
);

1863 
	`¥rštf
(
¡ybuf
, "STY=%s", 
	`¡¾’
(
SockName
è<ğ
MAXSTR
 - 5 ? SockName : "?");

1864 *
Å
++ = 
¡ybuf
;

1865 *
Å
++ = 
T”m
;

1866 
Å
++;

1867 #ifdeà
TIOCSWINSZ


1868 
Å
 += 2;

1870 
Å
 += 4;

1873 
İ
 = 
’vœÚ
; *op; ++op)

1875 ià(!
	`IsSymbŞ
(*
İ
, "TERM") && !IsSymbol(*op, "TERMCAP")

1876 && !
	`IsSymbŞ
(*
İ
, "STY") && !IsSymbol(*op, "WINDOW")

1877 && !
	`IsSymbŞ
(*
İ
, "SCREENCAP") && !IsSymbol(*op, "SHELL")

1878 && !
	`IsSymbŞ
(*
İ
, "LINES") && !IsSymbol(*op, "COLUMNS")

1880 *
Å
++ = *
İ
;

1882 *
Å
 = 0;

1883 
	}
}

1887 #ià
defšed
(
USEVARARGS
è&& defšed(
__STDC__
)

1888 
	$Msg
(
”r
, *
fmt
, 
VA_DOTS
)

1890 
	$Msg
(
”r
, 
fmt
, 
VA_DOTS
)

1891 
”r
;

1892 *
fmt
;

1893 
VA_DECL


1896 
	`VA_LIST
(
­
)

1897 
buf
[
MAXPATHLEN
*2];

1898 *
p
 = 
buf
;

1900 
	`VA_START
(
­
, 
fmt
);

1901 
fmt
 = 
	`DoNLS
(fmt);

1902 ()
	`v¢´štf
(
p
, (
buf
è- 100, 
fmt
, 
	`VA_ARGS
(
­
));

1903 
	`VA_END
(
­
);

1904 ià(
”r
)

1906 
p
 +ğ
	`¡¾’
(p);

1907 *
p
++ = ':';

1908 *
p
++ = ' ';

1909 
	`¡ºıy
(
p
, 
	`¡»¼Ü
(
”r
), 
buf
 + (buf) -… - 1);

1910 
buf
[(buf) - 1] = 0;

1912 
	`debug2
("Msg('%s'è(%#x);\n", 
buf
, ()
di¥Ïy
);

1914 ià(
di¥Ïy
 && 
di¥Ïys
)

1915 
	`MakeStus
(
buf
);

1916 ià(
di¥Ïys
)

1918 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

1919 
	`MakeStus
(
buf
);

1921 ià(
di¥Ïy
)

1926 *
‰y
 = 
D_u£¹ty
;

1927 
di¥Ïy
 *
Şddi¥Ïy
 = display;

1928 
di¥Ïy
 = 0;

1929 
	`S’dE¼ÜMsg
(
‰y
, 
buf
);

1930 
di¥Ïy
 = 
Şddi¥Ïy
;

1933 
	`´štf
("%s\r\n", 
buf
);

1934 
	}
}

1941 #ià
defšed
(
USEVARARGS
è&& defšed(
__STDC__
)

1942 
	$Pªic
(
”r
, *
fmt
, 
VA_DOTS
)

1944 
	$Pªic
(
”r
, 
fmt
, 
VA_DOTS
)

1945 
”r
;

1946 *
fmt
;

1947 
VA_DECL


1950 
	`VA_LIST
(
­
)

1951 
buf
[
MAXPATHLEN
*2];

1952 *
p
 = 
buf
;

1954 
	`VA_START
(
­
, 
fmt
);

1955 
fmt
 = 
	`DoNLS
(fmt);

1956 ()
	`v¢´štf
(
p
, (
buf
è- 100, 
fmt
, 
	`VA_ARGS
(
­
));

1957 
	`VA_END
(
­
);

1958 ià(
”r
)

1960 
p
 +ğ
	`¡¾’
(p);

1961 *
p
++ = ':';

1962 *
p
++ = ' ';

1963 
	`¡ºıy
(
p
, 
	`¡»¼Ü
(
”r
), 
buf
 + (buf) -… - 1);

1964 
buf
[(buf) - 1] = 0;

1966 
	`debug3
("Pªic('%s'); di¥Ïy=%x di¥Ïys=%x\n", 
buf
, 
di¥Ïy
, 
di¥Ïys
);

1967 ià(
di¥Ïys
 =ğ0 && 
di¥Ïy
 == 0)

1968 
	`´štf
("%s\r\n", 
buf
);

1969 ià(
di¥Ïys
 == 0)

1974 *
‰y
 = 
D_u£¹ty
;

1975 
di¥Ïy
 = 0;

1976 
	`S’dE¼ÜMsg
(
‰y
, 
buf
);

1977 
	`¦“p
(2);

1978 
	`_ex™
(1);

1981 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

1983 ià(
D_¡©us
)

1984 
	`RemoveStus
();

1985 
	`Fš™T”m
();

1986 
	`Flush
();

1987 #ifdeà
UTMPOK


1988 
	`Re¡ÜeLogšSlÙ
();

1990 
	`S‘TTY
(
D_u£rfd
, &
D_OldMode
);

1991 
	`fú
(
D_u£rfd
, 
F_SETFL
, 0);

1992 
	`wr™e
(
D_u£rfd
, 
buf
, 
	`¡¾’
(buf));

1993 
	`wr™e
(
D_u£rfd
, "\n", 1);

1994 
	`ä“‰y
();

1995 ià(
D_u£½id
)

1996 
	`Kl
(
D_u£½id
, 
SIG_BYE
);

1998 #ifdeà
MULTIUSER


1999 ià(
‰y_Şdmode
 >= 0)

2001 #ifdeà
USE_SETEUID


2002 ià(
	`£tuid
(
own_uid
))

2003 
	`x£‹uid
(
own_uid
);

2005 
	`£tuid
(
own_uid
);

2007 
	`debug1
("Pªic: chªgšg back mode äom %s\n", 
©ch_‰y
);

2008 
	`chmod
(
©ch_‰y
, 
‰y_Şdmode
);

2011 
	`“x™
(1);

2012 
	}
}

2023 #iâdeà
USE_LOCALE


2024 cÚ¡ 
days
[] = "SunMonTueWedThuFriSat";

2025 cÚ¡ 
mÚths
[] = "JanFebMarAprMayJunJulAugSepOctNovDec";

2028 
wšmsg_buf
[
MAXSTR
];

2029 
	#MAX_WINMSG_REND
 16

	)

2030 
wšmsg_»nd
[
MAX_WINMSG_REND
];

2031 
wšmsg_»ndpos
[
MAX_WINMSG_REND
];

2032 
wšmsg_num»nd
;

2035 
	$·d_ex·nd
(
buf
, 
p
, 
num·d
, 
·dËn
)

2036 *
buf
;

2037 *
p
;

2038 
num·d
;

2039 
·dËn
;

2041 *
²
, *
²2
;

2042 
i
, 
r
;

2044 
·dËn
 =…adËÀ- (
p
 - 
buf
);

2045 ià(
·dËn
 < 0)

2046 
·dËn
 = 0;

2047 
²2
 = 
²
 = 
p
 + 
·dËn
;

2048 
r
 = 
wšmsg_num»nd
;

2049 
p
 >ğ
buf
)

2051 ià(
r
 && 
p
 - 
buf
 =ğ
wšmsg_»ndpos
[r - 1])

2053 
wšmsg_»ndpos
[--
r
] = 
²
 - 
buf
;

2056 *
²
-- = *
p
;

2057 ià(*
p
-- == 127)

2059 
²
[1] = ' ';

2060 
i
 = 
num·d
 > 0 ? (
·dËn
 +‚umpad - 1) /‚umpad : 0;

2061 
·dËn
 -ğ
i
;

2062 
i
-- > 0)

2063 *
²
-- = ' ';

2064 
num·d
--;

2067  
²2
;

2068 
	}
}

2070 
	sbacktick
 {

2071 
backtick
 *
Ãxt
;

2072 
num
;

2073 
tick
;

2074 
liã¥ª
;

2075 
time_t
 
be¡befÜe
;

2076 
»suÉ
[
MAXSTR
];

2077 **
cmdv
;

2078 
ev’t
 
ev
;

2079 *
buf
;

2080 
bufi
;

2083 
backtick
 *
backticks
;

2086 
	$backtick_f‹r
(
bt
)

2087 
backtick
 *
bt
;

2089 *
p
, *
q
;

2090 
c
;

2092 
p
 = 
q
 = 
bt
->
»suÉ
; (
c
 = ()*p++) != 0;)

2094 ià(
c
 == '\t')

2095 
c
 = ' ';

2096 ià(
c
 >= ' ' || c == '\005')

2097 *
q
++ = 
c
;

2099 *
q
 = 0;

2100 
	}
}

2103 
	$backtick_â
(
ev
, 
d©a
)

2104 
ev’t
 *
ev
;

2105 *
d©a
;

2107 
backtick
 *
bt
;

2108 
i
, 
j
, 
k
, 
l
;

2110 
bt
 = (
backtick
 *)
d©a
;

2111 
	`debug1
("backtick_â fÜ #%d\n", 
bt
->
num
);

2112 
i
 = 
bt
->
bufi
;

2113 
l
 = 
	`»ad
(
ev
->
fd
, 
bt
->
buf
 + 
i
, 
MAXSTR
 - i);

2114 ià(
l
 <= 0)

2116 
	`debug1
("EOF oÀbacktick #%d\n", 
bt
->
num
);

2117 
	`evdeq
(
ev
);

2118 
	`şo£
(
ev
->
fd
);

2119 
ev
->
fd
 = -1;

2122 
	`debug1
("»ad %d by‹s\n", 
l
);

2123 
i
 +ğ
l
;

2124 
j
 = 0; j < 
l
; j++)

2125 ià(
bt
->
buf
[
i
 - 
j
 - 1] == '\n')

2127 ià(
j
 < 
l
)

2129 
k
 = 
i
 - 
j
 - 2; k >= 0; k--)

2130 ià(
bt
->
buf
[
k
] == '\n')

2132 
k
++;

2133 
	`bcİy
(
bt
->
buf
 + 
k
, bt->
»suÉ
, 
i
 - 
j
 - k);

2134 
bt
->
»suÉ
[
i
 - 
j
 - 
k
 - 1] = 0;

2135 
	`backtick_f‹r
(
bt
);

2136 
	`WšdowChªged
(0, '`');

2138 ià(
j
 =ğ
l
 && 
i
 =ğ
MAXSTR
)

2140 
j
 = 
MAXSTR
/2;

2141 
l
 = 
j
 + 1;

2143 ià(
j
 < 
l
)

2145 ià(
j
)

2146 
	`bcİy
(
bt
->
buf
 + 
i
 - 
j
, bt->buf, j);

2147 
i
 = 
j
;

2149 
bt
->
bufi
 = 
i
;

2150 
	}
}

2153 
	$£tbacktick
(
num
, 
liã¥ª
, 
tick
, 
cmdv
)

2154 
num
;

2155 
liã¥ª
;

2156 
tick
;

2157 **
cmdv
;

2159 
backtick
 **
b
, *
bt
;

2160 **
v
;

2162 
	`debug1
("£tbacktick c®Ëd fÜ backtick #%d\n", 
num
);

2163 
b
 = &
backticks
; (
bt
 = *bè!ğ0; b = &bt->
Ãxt
)

2164 ià(
bt
->
num
 ==‚um)

2166 ià(!
bt
 && !
cmdv
)

2168 ià(
bt
)

2170 
v
 = 
bt
->
cmdv
; *v; v++)

2171 
	`ä“
(*
v
);

2172 
	`ä“
(
bt
->
cmdv
);

2173 ià(
bt
->
buf
)

2174 
	`ä“
(
bt
->
buf
);

2175 ià(
bt
->
ev
.
fd
 >= 0)

2176 
	`şo£
(
bt
->
ev
.
fd
);

2177 
	`evdeq
(&
bt
->
ev
);

2179 ià(
bt
 && !
cmdv
)

2181 *
b
 = 
bt
->
Ãxt
;

2182 
	`ä“
(
bt
);

2185 ià(!
bt
)

2187 
bt
 = (
backtick
 *)
	`m®loc
( *bt);

2188 ià(!
bt
)

2190 
	`Msg
(0, 
¡ºomem
);

2193 
	`bz”o
(
bt
, (*bt));

2194 
bt
->
Ãxt
 = 0;

2195 *
b
 = 
bt
;

2197 
bt
->
num
 =‚um;

2198 
bt
->
tick
 =ick;

2199 
bt
->
liã¥ª
 =†ifespan;

2200 
bt
->
be¡befÜe
 = 0;

2201 
bt
->
»suÉ
[0] = 0;

2202 
bt
->
buf
 = 0;

2203 
bt
->
bufi
 = 0;

2204 
bt
->
cmdv
 = cmdv;

2205 
bt
->
ev
.
fd
 = -1;

2206 ià(
bt
->
tick
 =ğ0 && bt->
liã¥ª
 == 0)

2208 
	`debug
("setbacktick: continuous mode\n");

2209 
bt
->
buf
 = (*)
	`m®loc
(
MAXSTR
);

2210 ià(
bt
->
buf
 == 0)

2212 
	`Msg
(0, 
¡ºomem
);

2213 
	`£tbacktick
(
num
, 0, 0, (**)0);

2216 
bt
->
ev
.
ty³
 = 
EV_READ
;

2217 
bt
->
ev
.
fd
 = 
	`»adpe
(bt->
cmdv
);

2218 
bt
->
ev
.
hªdËr
 = 
backtick_â
;

2219 
bt
->
ev
.
d©a
 = (*)bt;

2220 ià(
bt
->
ev
.
fd
 >= 0)

2221 
	`ev’q
(&
bt
->
ev
);

2223 
	}
}

2226 
	$runbacktick
(
bt
, 
tickp
, 
now
)

2227 
backtick
 *
bt
;

2228 *
tickp
;

2229 
time_t
 
now
;

2231 
f
, 
i
, 
l
, 
j
;

2232 
time_t
 
now2
;

2234 
	`debug1
("runbacktick c®Ëd fÜ backtick #%d\n", 
bt
->
num
);

2235 ià(
bt
->
tick
 && (!*
tickp
 || bt->tick < *tickp))

2236 *
tickp
 = 
bt
->
tick
;

2237 ià((
bt
->
liã¥ª
 =ğ0 && bt->
tick
 =ğ0è|| 
now
 < bt->
be¡befÜe
)

2239 
	`debug1
("»tuºšg old„esuÉ (%d)\n", 
bt
->
liã¥ª
);

2240  
bt
->
»suÉ
;

2242 
f
 = 
	`»adpe
(
bt
->
cmdv
);

2243 ià(
f
 == -1)

2244  
bt
->
»suÉ
;

2245 
i
 = 0;

2246 (
l
 = 
	`»ad
(
f
, 
bt
->
»suÉ
 + 
i
, (bt->result) - i)) > 0)

2248 
	`debug1
("runbacktick:„—d %d by‹s\n", 
l
);

2249 
i
 +ğ
l
;

2250 
j
 = 1; j < 
l
; j++)

2251 ià(
bt
->
»suÉ
[
i
 - 
j
 - 1] == '\n')

2253 ià(
j
 =ğ
l
 && 
i
 =ğ(
bt
->
»suÉ
))

2255 
j
 = (
bt
->
»suÉ
) / 2;

2256 
l
 = 
j
 + 1;

2258 ià(
j
 < 
l
)

2260 
	`bcİy
(
bt
->
»suÉ
 + 
i
 - 
j
, bt->result, j);

2261 
i
 = 
j
;

2264 
	`şo£
(
f
);

2265 
bt
->
»suÉ
[(bt->result) - 1] = '\n';

2266 ià(
i
 && 
bt
->
»suÉ
[i - 1] == '\n')

2267 
i
--;

2268 
	`debug1
("runbacktick: fšished, %d by‹s\n", 
i
);

2269 
bt
->
»suÉ
[
i
] = 0;

2270 
	`backtick_f‹r
(
bt
);

2271 ()
	`time
(&
now2
);

2272 
bt
->
be¡befÜe
 = 
now2
 + bt->
liã¥ª
;

2273  
bt
->
»suÉ
;

2274 
	}
}

2277 
	$MakeWšMsgEv
(
¡r
, 
wš
, 
esc
, 
·dËn
, 
ev
, 
»c
)

2278 *
¡r
;

2279 
wš
 *win;

2280 
esc
;

2281 
·dËn
;

2282 
ev’t
 *
ev
;

2283 
»c
;

2285 
tick
;

2286 *
s
 = 
¡r
;

2287 *
p
 = 
wšmsg_buf
;

2288 
ù¾
;

2289 
timev®
 
now
;

2290 
tm
 *tm;

2291 
l
, 
i
, 
r
;

2292 
num
;

2293 
z”oæg
;

2294 
lÚgæg
;

2295 
mšusæg
;

2296 
¶usæg
;

2297 
qmæag
 = 0, 
omæag
 = 0, 
qmnum»nd
 = 0;

2298 *
qmpos
 = 0;

2299 
num·d
 = 0;

2300 
Ï¡·d
 = 0;

2301 
Œunıos
 = -1;

2302 
Œunı”
 = 0;

2303 
ŒunşÚg
 = 0;

2304 
backtick
 *
bt
;

2306 ià(
wšmsg_num»nd
 >= 0)

2307 
wšmsg_num»nd
 = 0;

2309 
wšmsg_num»nd
 = -winmsg_numrend;

2311 
tick
 = 0;

2312 
tm
 = 0;

2313 
ù¾
 = 0;

2314 
	`g‘timeofday
(&
now
, 
NULL
);

2315 ; *
s
 && (
l
 = 
wšmsg_buf
 + 
MAXSTR
 - 1 - 
p
) > 0; s++,…++)

2317 *
p
 = *
s
;

2318 ià(
ù¾
)

2320 
ù¾
 = 0;

2321 ià(*
s
 != '^' && *s >= 64)

2322 *
p
 &= 0x1f;

2325 ià(*
s
 !ğ
esc
)

2327 ià(
esc
 == '%')

2329 *
s
)

2333 *
p
 = 
BELL
;

2337 
ù¾
 = 1;

2338 *
p
-- = '^';

2346 ià(*++
s
 =ğ
esc
)

2348 ià((
¶usæg
 = *
s
 == '+') != 0)

2349 
s
++;

2350 ià((
mšusæg
 = *
s
 == '-') != 0)

2351 
s
++;

2352 ià((
z”oæg
 = *
s
 == '0') != 0)

2353 
s
++;

2354 
num
 = 0;

2355 *
s
 >= '0' && *s <= '9')

2356 
num
 =‚um * 10 + (*
s
++ - '0');

2357 ià((
lÚgæg
 = *
s
 == 'L') != 0)

2358 
s
++;

2359 *
s
)

2362 
p
--;

2363 ià(
qmpos
)

2365 ià((!
qmæag
 && !
omæag
) || omflag == 1)

2367 
p
 = 
qmpos
;

2368 ià(
qmnum»nd
 < 
wšmsg_num»nd
)

2369 
wšmsg_num»nd
 = 
qmnum»nd
;

2371 
qmpos
 = 0;

2374 
qmpos
 = 
p
;

2375 
qmnum»nd
 = 
wšmsg_num»nd
;

2376 
qmæag
 = 
omæag
 = 0;

2379 
p
--;

2380 ià(!
qmpos
)

2382 ià(
qmæag
 && 
omæag
 != 1)

2384 
omæag
 = 1;

2385 
qmpos
 = 
p
;

2386 
qmnum»nd
 = 
wšmsg_num»nd
;

2390 
p
 = 
qmpos
;

2391 ià(
qmnum»nd
 < 
wšmsg_num»nd
)

2392 
wšmsg_num»nd
 = 
qmnum»nd
;

2393 
omæag
 = -1;

2398 ià(
l
 < 4)

2400 ià(
tm
 == 0)

2402 
time_t
 
now£c
 = 
now
.
tv_£c
;

2403 
tm
 = 
	`loÿÉime
(&
now£c
);

2405 
qmæag
 = 1;

2406 ià(!
tick
 ||ick > 3600)

2407 
tick
 = 3600;

2408 *
s
)

2411 
	`¥rštf
(
p
, "%02d", 
tm
->
tm_mday
 % 100);

2414 #ifdeà
USE_LOCALE


2415 
	`¡ráime
(
p
, 
l
, (
lÚgæg
 ? "%A" : "%a"), 
tm
);

2417 
	`¥rštf
(
p
, "%3.3s", 
days
 + 3 * 
tm
->
tm_wday
);

2421 
	`¥rštf
(
p
, "%02d", 
tm
->
tm_mÚ
 + 1);

2424 #ifdeà
USE_LOCALE


2425 
	`¡ráime
(
p
, 
l
, (
lÚgæg
 ? "%B" : "%b"), 
tm
);

2427 
	`¥rštf
(
p
, "%3.3s", 
mÚths
 + 3 * 
tm
->
tm_mÚ
);

2431 
	`¥rštf
(
p
, "%02d", 
tm
->
tm_y—r
 % 100);

2434 
	`¥rštf
(
p
, "%04d", 
tm
->
tm_y—r
 + 1900);

2437 
	`¥rštf
(
p
, 
tm
->
tm_hour
 >= 12 ? "pm" : "am");

2440 
	`¥rštf
(
p
, 
tm
->
tm_hour
 >= 12 ? "PM" : "AM");

2443 
	`¥rštf
(
p
, "%02d", 
tm
->
tm_£c
);

2444 
tick
 = 1;

2447 
	`¥rštf
(
p
, 
z”oæg
 ? "%02d:%02d" : "%2d:%02d", 
tm
->
tm_hour
,m->
tm_mš
);

2448 ià(!
tick
 ||ick > 60)

2449 
tick
 = 60;

2452 
	`¥rštf
(
p
, 
z”oæg
 ? "%02d:%02d" : "%2d:%02d", (
tm
->
tm_hour
 + 11è% 12 + 1,m->
tm_mš
);

2453 ià(!
tick
 ||ick > 60)

2454 
tick
 = 60;

2459 
p
 +ğ
	`¡¾’
(p) - 1;

2462 #ifdeà
LOADAV


2463 *
p
 = 0;

2464 ià(
l
 > 20)

2465 
	`AddLßdav
(
p
);

2466 ià(*
p
)

2468 
qmæag
 = 1;

2469 
p
 +ğ
	`¡¾’
(p) - 1;

2472 *
p
 = '?';

2473 ià(!
tick
 ||ick > 60)

2474 
tick
 = 60;

2476 *
p
 = '?';

2478 
p
 +ğ
	`¡¾’
(p) - 1;

2482 ià(
»c
 >ğ10 || (*
s
 =ğ'h' && (
wš
 =ğ0 || wš->
w_h¡©us
 == 0 || *win->w_hstatus == 0)))

2484 
p
--;

2487 ià(*
s
 == '`')

2489 
bt
 = 
backticks
; bt; bˆğbt->
Ãxt
)

2490 ià(
bt
->
num
 ==‚um)

2492 ià(
bt
 == 0)

2494 
p
--;

2499 
§vebuf
[(
wšmsg_buf
)];

2500 
Şdtick
 = 
tick
;

2501 
Şdnum»nd
 = 
wšmsg_num»nd
;

2503 *
p
 = 0;

2504 
	`¡rıy
(
§vebuf
, 
wšmsg_buf
);

2505 
wšmsg_num»nd
 = -winmsg_numrend;

2506 
	`MakeWšMsgEv
(*
s
 =ğ'h' ? 
wš
->
w_h¡©us
 : 
	`runbacktick
(
bt
, &
Şdtick
, 
now
.
tv_£c
), wš, '\005', 0, (
ev’t
 *)0, 
»c
 + 1);

2507 
	`debug2
("Şdtick=%dick=%d\n", 
Şdtick
, 
tick
);

2508 ià(!
tick
 || 
Şdtick
 <ick)

2509 
tick
 = 
Şdtick
;

2510 ià(()
	`¡¾’
(
wšmsg_buf
è< 
l
)

2511 
	`¡rÿt
(
§vebuf
, 
wšmsg_buf
);

2512 
	`¡rıy
(
wšmsg_buf
, 
§vebuf
);

2513 
Şdnum»nd
 < 
wšmsg_num»nd
)

2514 
wšmsg_»ndpos
[
Şdnum»nd
++] +ğ
p
 - 
wšmsg_buf
;

2515 ià(*
p
)

2516 
qmæag
 = 1;

2517 
p
 +ğ
	`¡¾’
(p) - 1;

2523 
wš
 *
ŞdfÜe
 = 0;

2524 *
ss
;

2526 ià(
di¥Ïy
)

2528 
ŞdfÜe
 = 
D_fÜe
;

2529 
D_fÜe
 = 
wš
;

2531 
ss
 = 
	`AddWšdows
(
p
, 
l
 - 1, (*
s
 =ğ'w' ? 0 : 1è| (
lÚgæg
 ? 0 : 2è| (
¶usæg
 ? 4 : 0), 
wš
 ? wš->
w_numb”
 : -1);

2532 ià(
mšusæg
)

2533 *
ss
 = 0;

2534 ià(
di¥Ïy
)

2535 
D_fÜe
 = 
ŞdfÜe
;

2537 ià(*
p
)

2538 
qmæag
 = 1;

2539 
p
 +ğ
	`¡¾’
(p) - 1;

2542 *
p
 = 0;

2543 ià(
wš
)

2544 
	`AddOth”U£rs
(
p
, 
l
 - 1, 
wš
);

2545 ià(*
p
)

2546 
qmæag
 = 1;

2547 
p
 +ğ
	`¡¾’
(p) - 1;

2550 *
p
 = 0;

2551 ià(
wš
)

2552 
	`AddWšdowFÏgs
(
p
, 
l
 - 1, 
wš
);

2553 ià(*
p
)

2554 
qmæag
 = 1;

2555 
p
 +ğ
	`¡¾’
(p) - 1;

2558 *
p
 = 0;

2559 ià(
wš
 && ()
	`¡¾’
(wš->
w_t™Ë
è< 
l
)

2561 
	`¡rıy
(
p
, 
wš
->
w_t™Ë
);

2562 ià(*
p
)

2563 
qmæag
 = 1;

2565 
p
 +ğ
	`¡¾’
(p) - 1;

2569 
rbuf
[128];

2570 
s
++;

2571 
i
 = 0; i < 127; i++)

2572 ià(
s
[
i
] && s[i] != '}')

2573 
rbuf
[
i
] = 
s
[i];

2576 ià(
s
[
i
] =ğ'}' && 
wšmsg_num»nd
 < 
MAX_WINMSG_REND
)

2578 
r
 = -1;

2579 
rbuf
[
i
] = 0;

2580 
	`debug1
("MakeWšMsg‡‰rcŞÜ %s\n", 
rbuf
);

2581 ià(
i
 !ğ1 || 
rbuf
[0] != '-')

2582 
r
 = 
	`P¬£A‰rCŞÜ
(
rbuf
, (*)0, 0);

2583 ià(
r
 !ğ-1 || (
i
 =ğ1 && 
rbuf
[0] == '-'))

2585 
wšmsg_»nd
[
wšmsg_num»nd
] = 
r
;

2586 
wšmsg_»ndpos
[
wšmsg_num»nd
] = 
p
 - 
wšmsg_buf
;

2587 
wšmsg_num»nd
++;

2590 
s
 +ğ
i
;

2591 
p
--;

2595 *
p
 = 0;

2596 ià(()
	`¡¾’
(
Ho¡Name
è< 
l
)

2598 
	`¡rıy
(
p
, 
Ho¡Name
);

2599 ià(*
p
)

2600 
qmæag
 = 1;

2602 
p
 +ğ
	`¡¾’
(p) - 1;

2605 
p
--;

2607 ià(
di¥Ïy
 && ((
ev
 &&ƒv =ğ&
D_fÜecv
->
c_ÿ±ev
è|| (!ev && 
wš
 && wš =ğ
D_fÜe
)))

2608 
qmæag
 = 1;

2611 
Œunıos
 = 
p
 - 
wšmsg_buf
;

2612 
Œunı”
 = 
num
 > 100 ? 100 :‚um;

2613 
ŒunşÚg
 = 
lÚgæg
;

2614 
p
--;

2618 *
p
 = ' ';

2619 ià(
num
 || 
z”oæg
 || 
¶usæg
 || 
lÚgæg
 || (*
s
 != '='))

2622 ià(
mšusæg
)

2624 
num
 = (
¶usæg
 ? 
Ï¡·d
 : 
·dËn
) -‚um;

2625 ià(!
¶usæg
 && 
·dËn
 == 0)

2626 
num
 = 
p
 - 
wšmsg_buf
;

2627 
¶usæg
 = 0;

2629 ià(!
z”oæg
)

2631 ià(*
s
 !ğ'=' && 
num
 =ğ0 && !
¶usæg
)

2632 
num
 = 100;

2633 ià(
num
 > 100)

2634 
num
 = 100;

2635 ià(
·dËn
 == 0)

2636 
num
 = 
p
 - 
wšmsg_buf
;

2638 
num
 = (
·dËn
 - (
¶usæg
 ? 
Ï¡·d
 : 0)) *‚um / 100;

2640 ià(
num
 < 0)

2641 
num
 = 0;

2642 ià(
¶usæg
)

2643 
num
 +ğ
Ï¡·d
;

2644 ià(
num
 > 
MAXSTR
 - 1)

2645 
num
 = 
MAXSTR
 - 1;

2646 ià(
num·d
)

2647 
p
 = 
	`·d_ex·nd
(
wšmsg_buf
,…, 
num·d
, 
num
);

2648 
num·d
 = 0;

2649 ià(
p
 - 
wšmsg_buf
 > 
num
 && !
lÚgæg
)

2651 
Ëá
, 
Œunc
;

2653 ià(
Œunıos
 == -1)

2655 
Œunıos
 = 
Ï¡·d
;

2656 
Œunı”
 = 0;

2658 
Œunc
 = 
Ï¡·d
 + 
Œunı”
 * (
num
 -†astpad) / 100;

2659 ià(
Œunc
 > 
num
)

2660 
Œunc
 = 
num
;

2661 ià(
Œunc
 < 
Ï¡·d
)

2662 
Œunc
 = 
Ï¡·d
;

2663 
Ëá
 = 
Œunıos
 - 
Œunc
;

2664 ià(
Ëá
 > 
p
 - 
wšmsg_buf
 - 
num
)

2665 
Ëá
 = 
p
 - 
wšmsg_buf
 - 
num
;

2666 
	`debug1
("Ï¡·d = %d, ", 
Ï¡·d
);

2667 
	`debug3
("Œunıo ğ%d,runøğ%d,†eá = %d\n", 
Œunıos
, 
Œunc
, 
Ëá
);

2668 ià(
Ëá
 > 0)

2670 ià(
Ëá
 + 
Ï¡·d
 > 
p
 - 
wšmsg_buf
)

2671 
Ëá
 = 
p
 - 
wšmsg_buf
 - 
Ï¡·d
;

2672 ià(
p
 - 
wšmsg_buf
 - 
Ï¡·d
 - 
Ëá
 > 0)

2673 
	`bcİy
(
wšmsg_buf
 + 
Ï¡·d
 + 
Ëá
, wšmsg_buà+†a¡·d, 
p
 - winmsg_buf -†astpad -†eft);

2674 
p
 -ğ
Ëá
;

2675 
r
 = 
wšmsg_num»nd
;

2676 
r
 && 
wšmsg_»ndpos
[¸- 1] > 
Ï¡·d
)

2678 
r
--;

2679 
wšmsg_»ndpos
[
r
] -ğ
Ëá
;

2680 ià(
wšmsg_»ndpos
[
r
] < 
Ï¡·d
)

2681 
wšmsg_»ndpos
[
r
] = 
Ï¡·d
;

2683 ià(
ŒunşÚg
)

2685 ià(
p
 - 
wšmsg_buf
 > 
Ï¡·d
)

2686 
wšmsg_buf
[
Ï¡·d
] = '.';

2687 ià(
p
 - 
wšmsg_buf
 > 
Ï¡·d
 + 1)

2688 
wšmsg_buf
[
Ï¡·d
 + 1] = '.';

2689 ià(
p
 - 
wšmsg_buf
 > 
Ï¡·d
 + 2)

2690 
wšmsg_buf
[
Ï¡·d
 + 2] = '.';

2693 ià(
p
 - 
wšmsg_buf
 > 
num
)

2695 
p
 = 
wšmsg_buf
 + 
num
;

2696 ià(
ŒunşÚg
)

2698 ià(
num
 - 1 >ğ
Ï¡·d
)

2699 
p
[-1] = '.';

2700 ià(
num
 - 2 >ğ
Ï¡·d
)

2701 
p
[-2] = '.';

2702 ià(
num
 - 3 >ğ
Ï¡·d
)

2703 
p
[-3] = '.';

2705 
r
 = 
wšmsg_num»nd
;

2706 
r
 && 
wšmsg_»ndpos
[¸- 1] > 
num
)

2707 
wšmsg_»ndpos
[--
r
] = 
num
;

2709 
Œunıos
 = -1;

2710 
ŒunşÚg
 = 0;

2711 ià(
Ï¡·d
 > 
p
 - 
wšmsg_buf
)

2712 
Ï¡·d
 = 
p
 - 
wšmsg_buf
;

2713 
	`debug1
("Ï¡·d‚ow %d\n", 
Ï¡·d
);

2715 ià(*
s
 == '=')

2717 
p
 - 
wšmsg_buf
 < 
num
)

2718 *
p
++ = ' ';

2719 
Ï¡·d
 = 
p
 - 
wšmsg_buf
;

2720 
Œunıos
 = -1;

2721 
ŒunşÚg
 = 0;

2722 
	`debug1
("Ï¡·d2‚ow %d\n", 
Ï¡·d
);

2724 
p
--;

2726 ià(
·dËn
)

2728 *
p
 = 127;

2729 
num·d
++;

2733 
s
++;

2736 
s
--;

2737 ià(
l
 > 10 + 
num
)

2739 ià(
num
 == 0)

2740 
num
 = 1;

2741 ià(!
wš
)

2742 
	`¥rštf
(
p
, "%*s", 
num
,‚um > 1 ? "--" : "-");

2744 
	`¥rštf
(
p
, "%*d", 
num
, 
wš
->
w_numb”
);

2745 
qmæag
 = 1;

2746 
p
 +ğ
	`¡¾’
(p) - 1;

2751 ià(
qmpos
 && !
qmæag
)

2752 
p
 = 
qmpos
 + 1;

2753 *
p
 = '\0';

2754 ià(
num·d
)

2756 ià(
·dËn
 > 
MAXSTR
 - 1)

2757 
·dËn
 = 
MAXSTR
 - 1;

2758 
p
 = 
	`·d_ex·nd
(
wšmsg_buf
,…, 
num·d
, 
·dËn
);

2760 ià(
ev
)

2762 
	`evdeq
(
ev
);

2763 
ev
->
timeout
.
tv_£c
 = 0;

2764 
ev
->
timeout
.
tv_u£c
 = 0;

2766 ià(
ev
 && 
tick
)

2768 
now
.
tv_u£c
 = 100000;

2769 ià(
tick
 == 1)

2770 
now
.
tv_£c
++;

2772 
now
.
tv_£c
 +ğ
tick
 - (now.tv_sec %ick);

2773 
ev
->
timeout
 = 
now
;

2774 
	`debug2
("NEWimeouˆ%d %d\n", 
ev
->
timeout
.
tv_£c
, 
tick
);

2776  
wšmsg_buf
;

2777 
	}
}

2780 
	$MakeWšMsg
(
s
, 
wš
, 
esc
)

2781 *
s
;

2782 
wš
 *win;

2783 
esc
;

2785  
	`MakeWšMsgEv
(
s
, 
wš
, 
esc
, 0, (
ev’t
 *)0, 0);

2786 
	}
}

2789 
	$PutWšMsg
(
s
, 
¡¬t
, 
max
)

2790 *
s
;

2791 
¡¬t
, 
max
;

2793 
i
, 
p
, 
l
, 
r
, 
n
;

2794 
mch¬
 
»nd
;

2795 
mch¬
 
»nd¡ack
[
MAX_WINMSG_REND
];

2796 
»nd¡ackn
 = 0;

2798 ià(
s
 !ğ
wšmsg_buf
)

2800 
»nd
 = 
D_»nd
;

2801 
p
 = 0;

2802 
l
 = 
	`¡¾’
(
s
);

2803 
	`debug2
("PutWšMsg % ¡¬ˆ©Œ %x\n", 
s
, 
»nd
.
©Œ
);

2804 
i
 = 0; i < 
wšmsg_num»nd
 && 
max
 > 0; i++)

2806 ià(
p
 > 
wšmsg_»ndpos
[
i
] || wšmsg_»ndpos[i] > 
l
)

2808 ià(
p
 < 
wšmsg_»ndpos
[
i
])

2810 
n
 = 
wšmsg_»ndpos
[
i
] - 
p
;

2811 ià(
n
 > 
max
)

2812 
n
 = 
max
;

2813 
max
 -ğ
n
;

2814 
p
 +ğ
n
;

2815 
n
-- > 0)

2817 ià(
¡¬t
-- > 0)

2818 
s
++;

2820 
	`PUTCHARLP
(*
s
++);

2823 
r
 = 
wšmsg_»nd
[
i
];

2824 ià(
r
 == -1)

2826 ià(
»nd¡ackn
 > 0)

2827 
»nd
 = 
»nd¡ack
[--
»nd¡ackn
];

2831 
»nd¡ack
[
»nd¡ackn
++] = 
»nd
;

2832 
	`AµlyA‰rCŞÜ
(
r
, &
»nd
);

2834 
	`S‘R’d™iÚ
(&
»nd
);

2836 ià(
p
 < 
l
)

2838 
n
 = 
l
 - 
p
;

2839 ià(
n
 > 
max
)

2840 
n
 = 
max
;

2841 
n
-- > 0)

2843 ià(
¡¬t
-- > 0)

2844 
s
++;

2846 
	`PUTCHARLP
(*
s
++);

2850 
	}
}

2853 #ifdeà
DEBUG


2855 
	$fds1
(
i
, 
j
)

2856 
i
, 
j
;

2858 
i
 < 
j
)

2860 
	`debug1
("%d ", 
i
);

2861 
i
++;

2863 ià((
j
 = 
	`İ’
("/dev/null", 0)) >= 0)

2865 
	`fds1
(
i
 + 1, 
j
);

2866 
	`şo£
(
j
);

2870 
	`dup
(++
i
è< 0 && 
”ºo
 !ğ
EBADF
)

2871 
	`debug1
("%d ", 
i
);

2872 
	`debug1
(" [%d]\n", 
i
);

2874 
	}
}

2877 
	$fds
()

2879 
	`debug
("fds: ");

2880 
	`fds1
(-1, -1);

2881 
	}
}

2885 
	$£rv_»ad_â
(
ev
, 
d©a
)

2886 
ev’t
 *
ev
;

2887 *
d©a
;

2889 
	`debug
("Knock - knock!\n");

2890 
	`ReûiveMsg
();

2891 
	}
}

2894 
	$£rv_£Ëù_â
(
ev
, 
d©a
)

2895 
ev’t
 *
ev
;

2896 *
d©a
;

2898 
wš
 *
p
;

2900 
	`debug
("serv_select_fn called\n");

2902 ià(
GÙSigChld
)

2904 
	`SigChldHªdËr
();

2906 ià(
IÁ”ru±PËa£
)

2908 
	`debug
("Backend„eceived interrupt\n");

2911 ià(
fÜe
 && 
di¥Ïys
)

2913 #ià
	`defšed
(
TERMIO
è|| defšed(
POSIX
)

2914 
ibuf
 = 
di¥Ïys
->
d_OldMode
.
tio
.
c_cc
[
VINTR
];

2916 
ibuf
 = 
di¥Ïys
->
d_OldMode
.
m_tch¬s
.
t_šŒc
;

2918 #ifdeà
PSEUDOS


2919 
	`wr™e
(
	`W_UWP
(
fÜe
è? fÜe->
w_pwš
->
p_±yfd
 : fÜe->
w_±yfd
,

2920 &
ibuf
, 1);

2921 
	`debug1
("Back’d wrÙš‹¼u±Ø%d", 
fÜe
->
w_numb”
);

2922 
	`debug1
("%s\n", 
	`W_UWP
(
fÜe
) ? " (pseudowin)" : "");

2924 
	`wr™e
(
fÜe
->
w_±yfd
, &
ibuf
, 1);

2925 
	`debug1
("Back’d wrÙš‹¼u±Ø%d\n", 
fÜe
->
w_numb”
);

2928 
IÁ”ru±PËa£
 = 0;

2931 
p
 = 
wšdows
;…;… =…->
w_Ãxt
)

2933 ià(
p
->
w_b–l
 =ğ
BELL_FOUND
 ||…->w_b–È=ğ
BELL_VISUAL
)

2935 
ÿnvas
 *
cv
;

2936 
visu®
 = 
p
->
w_b–l
 =ğ
BELL_VISUAL
 || 
visu®_b–l
;

2937 
p
->
w_b–l
 = 
BELL_ON
;

2938 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

2940 
cv
 = 
D_cvli¡
; cv; cv = cv->
c_Ãxt
)

2941 ià(
cv
->
c_Ïy”
->
l_bÙtom
 =ğ&
p
->
w_Ïy”
)

2943 ià(
cv
 == 0)

2945 
p
->
w_b–l
 = 
BELL_DONE
;

2946 
	`Msg
(0, "%s", 
	`MakeWšMsg
(
B–lSŒšg
, 
p
, '%'));

2948 ià(
visu®
 && !
D_VB
 && (!
D_¡©us
 || !
D_¡©us_b–l
))

2950 
	`Msg
(0, "%s", 
Visu®B–lSŒšg
);

2951 ià(
D_¡©us
)

2953 
D_¡©us_b–l
 = 1;

2954 
	`debug1
("usšg vb–Ètimeouˆ%d\n", 
VB–lWa™
);

2955 
	`S‘Timeout
(&
D_¡©u£v
, 
VB–lWa™
 );

2960 ià(
p
->
w_mÚ™Ü
 =ğ
MON_FOUND
)

2961 
p
->
w_mÚ™Ü
 = 
MON_DONE
;

2962 
	`WšdowChªged
(
p
, 'f');

2964 ià(
p
->
w_mÚ™Ü
 =ğ
MON_FOUND
)

2966 
ÿnvas
 *
cv
;

2967 
p
->
w_mÚ™Ü
 = 
MON_ON
;

2968 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

2970 
cv
 = 
D_cvli¡
; cv; cv = cv->
c_Ãxt
)

2971 ià(
cv
->
c_Ïy”
->
l_bÙtom
 =ğ&
p
->
w_Ïy”
)

2973 ià(
cv
)

2975 #ifdeà
MULTIUSER


2976 ià(!(
	`ACLBYTE
(
p
->
w_mÚ_nÙify
, 
D_u£r
->
u_id
è& 
	`ACLBIT
(D_user->u_id)))

2979 
	`Msg
(0, "%s", 
	`MakeWšMsg
(
Aùiv™ySŒšg
, 
p
, '%'));

2980 
p
->
w_mÚ™Ü
 = 
MON_DONE
;

2982 
	`WšdowChªged
(
p
, 'f');

2986 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

2988 
ÿnvas
 *
cv
;

2989 ià(
D_¡©us
 =ğ
STATUS_ON_WIN
)

2992 
cv
 = 
D_cvli¡
; cv; cv = cv->
c_Ãxt
)

2994 
lx
, 
ly
;

2997 
lx
 = 
cv
->
c_Ïy”
->
l_x
;

2998 
ly
 = 
cv
->
c_Ïy”
->
l_y
;

2999 ià(
lx
 =ğ
cv
->
c_Ïy”
->
l_width
)

3000 
lx
--;

3001 ià(
ly
 + 
cv
->
c_yoff
 < cv->
c_ys
)

3003 
i
, 
n
 = 
cv
->
c_ys
 - (
ly
 + cv->
c_yoff
);

3004 
cv
->
c_yoff
 = cv->
c_ys
 - 
ly
;

3005 
	`R‘hškV›wpÜtOff£ts
(
cv
);

3006 ià(
n
 > 
cv
->
c_Ïy”
->
l_height
)

3007 
n
 = 
cv
->
c_Ïy”
->
l_height
;

3008 
	`CV_CALL
(
cv
,

3009 
	`LSüŞlV
(
æay”
, -
n
, 0, fÏy”->
l_height
 - 1, 0);

3010 
	`LayRedi¥ÏyLše
(-1, -1, -1, 1);

3011 
i
 = 0; i < 
n
; i++)

3012 
	`LayRedi¥ÏyLše
(
i
, 0, 
æay”
->
l_width
 - 1, 1);

3013 ià(
cv
 =ğcv->
c_di¥Ïy
->
d_fÜecv
)

3014 
	`LayS‘CursÜ
();

3017 ià(
ly
 + 
cv
->
c_yoff
 > cv->
c_ye
)

3019 
i
, 
n
 = 
ly
 + 
cv
->
c_yoff
 - cv->
c_ye
;

3020 
cv
->
c_yoff
 = cv->
c_ye
 - 
ly
;

3021 
	`R‘hškV›wpÜtOff£ts
(
cv
);

3022 ià(
n
 > 
cv
->
c_Ïy”
->
l_height
)

3023 
n
 = 
cv
->
c_Ïy”
->
l_height
;

3024 
	`CV_CALL
(
cv
,

3025 
	`LSüŞlV
(
æay”
, 
n
, 0, 
cv
->
c_Ïy”
->
l_height
 - 1, 0);

3026 
	`LayRedi¥ÏyLše
(-1, -1, -1, 1);

3027 
i
 = 0; i < 
n
; i++)

3028 
	`LayRedi¥ÏyLše
(
i
 + 
æay”
->
l_height
 - 
n
, 0, fÏy”->
l_width
 - 1, 1);

3029 ià(
cv
 =ğcv->
c_di¥Ïy
->
d_fÜecv
)

3030 
	`LayS‘CursÜ
();

3033 ià(
lx
 + 
cv
->
c_xoff
 < cv->
c_xs
)

3035 
i
, 
n
 = 
cv
->
c_xs
 - (
lx
 + cv->
c_xoff
);

3036 ià(
n
 < (
cv
->
c_xe
 - cv->
c_xs
 + 1) / 2)

3037 
n
 = (
cv
->
c_xe
 - cv->
c_xs
 + 1) / 2;

3038 ià(
cv
->
c_xoff
 + 
n
 > cv->
c_xs
)

3039 
n
 = 
cv
->
c_xs
 - cv->
c_xoff
;

3040 
cv
->
c_xoff
 +ğ
n
;

3041 
	`R‘hškV›wpÜtOff£ts
(
cv
);

3042 ià(
n
 > 
cv
->
c_Ïy”
->
l_width
)

3043 
n
 = 
cv
->
c_Ïy”
->
l_width
;

3044 
	`CV_CALL
(
cv
,

3045 
	`LayRedi¥ÏyLše
(-1, -1, -1, 1);

3046 
i
 = 0; i < 
æay”
->
l_height
; i++)

3048 
	`LSüŞlH
(
æay”
, -
n
, 
i
, 0, fÏy”->
l_width
 - 1, 0, 0);

3049 
	`LayRedi¥ÏyLše
(
i
, 0, 
n
 - 1, 1);

3051 ià(
cv
 =ğcv->
c_di¥Ïy
->
d_fÜecv
)

3052 
	`LayS‘CursÜ
();

3055 ià(
lx
 + 
cv
->
c_xoff
 > cv->
c_xe
)

3057 
i
, 
n
 = 
lx
 + 
cv
->
c_xoff
 - cv->
c_xe
;

3058 ià(
n
 < (
cv
->
c_xe
 - cv->
c_xs
 + 1) / 2)

3059 
n
 = (
cv
->
c_xe
 - cv->
c_xs
 + 1) / 2;

3060 ià(
cv
->
c_xoff
 - 
n
 + cv->
c_Ïy”
->
l_width
 - 1 < cv->
c_xe
)

3061 
n
 = 
cv
->
c_xoff
 + cv->
c_Ïy”
->
l_width
 - 1 - cv->
c_xe
;

3062 
cv
->
c_xoff
 -ğ
n
;

3063 
	`R‘hškV›wpÜtOff£ts
(
cv
);

3064 ià(
n
 > 
cv
->
c_Ïy”
->
l_width
)

3065 
n
 = 
cv
->
c_Ïy”
->
l_width
;

3066 
	`CV_CALL
(
cv
,

3067 
	`LayRedi¥ÏyLše
(-1, -1, -1, 1);

3068 
i
 = 0; i < 
æay”
->
l_height
; i++)

3070 
	`LSüŞlH
(
æay”
, 
n
, 
i
, 0, fÏy”->
l_width
 - 1, 0, 0);

3071 
	`LayRedi¥ÏyLše
(
i
, 
æay”
->
l_width
 - 
n
, flayer->l_width - 1, 1);

3073 ià(
cv
 =ğcv->
c_di¥Ïy
->
d_fÜecv
)

3074 
	`LayS‘CursÜ
();

3080 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

3082 ià(
D_¡©us
 =ğ
STATUS_ON_WIN
 || 
D_cvli¡
 =ğ0 || D_cvli¡->
c_Ãxt
 == 0)

3084 
	`debug1
("£rv_£Ëù_â: Re¡ÜÚ cv %#x\n", ()
D_fÜecv
);

3085 
	`CV_CALL
(
D_fÜecv
, 
	`LayRe¡Üe
();
	`LayS‘CursÜ
());

3087 
	}
}

3090 
	$logæush_â
(
ev
, 
d©a
)

3091 
ev’t
 *
ev
;

3092 *
d©a
;

3094 
wš
 *
p
;

3095 *
buf
;

3096 
n
;

3098 ià(!
	`i¦ogfe
(
NULL
))

3100 
	`logfæush
(
NULL
);

3101 
n
 = 
log_æush
 ?†og_æush : (
logt¡amp_aá”
 + 4) / 5;

3102 ià(
n
)

3104 
	`S‘Timeout
(
ev
, 
n
 * 1000);

3105 
	`ev’q
(
ev
);

3107 ià(!
logt¡amp_Ú
)

3110 
p
 = 
wšdows
;…;… =…->
w_Ãxt
)

3112 ià(!
p
->
w_log
)

3114 
p
->
w_logs’û
 +ğ
n
;

3115 ià(
p
->
w_logs’û
 < 
logt¡amp_aá”
)

3117 ià(
p
->
w_logs’û
 - 
n
 >ğ
logt¡amp_aá”
)

3119 
buf
 = 
	`MakeWšMsg
(
logt¡amp_¡ršg
, 
p
, '%');

3120 
	`logfwr™e
(
p
->
w_log
, 
buf
, 
	`¡¾’
(buf));

3122 
	}
}

3132 
	$P¬£Ch¬
(
p
, 
ı
)

3133 *
p
, *
ı
;

3135 ià(*
p
 == 0)

3137 ià(*
p
 == '^' &&…[1])

3139 ià(*++
p
 == '?')

3140 *
ı
 = '\177';

3141 ià(*
p
 >= '@')

3142 *
ı
 = 
	`CŒl
(*
p
);

3145 ++
p
;

3147 ià(*
p
 == '\\' && *++p <= '7' && *p >= '0')

3149 *
ı
 = 0;

3151 *
ı
 = *ı * 8 + *
p
 - '0';

3152 *++
p
 <= '7' && *p >= '0');

3155 *
ı
 = *
p
++;

3156  
p
;

3157 
	}
}

3160 
	$P¬£Esÿ³
(
p
)

3161 *
p
;

3163 
buf
[2];

3165 ià(*
p
 == 0)

3166 
	`S‘Esÿ³
((
aşu£r
 *)0, -1, -1);

3169 ià((
p
 = 
	`P¬£Ch¬
Õ, (*)
buf
)è=ğ
NULL
 ||

3170 (
p
 = 
	`P¬£Ch¬
Õ, (*)
buf
+1)è=ğ
NULL
 || *p)

3172 
	`S‘Esÿ³
((
aşu£r
 *)0, 
buf
[0], buf[1]);

3175 
	}
}

	@screen.h

25 
	~"os.h
"

27 #ià
defšed
(
__STDC__
)

28 #iâdeà
__P


29 
	#__P
(
a
è
	)
a

32 #iâdeà
__P


33 
	#__P
(
a
è()

	)

35 cÚ¡

	)

38 
	~"osdef.h
"

40 
	~"ªsi.h
"

41 
	~"sched.h
"

42 
	~"aşs.h
"

43 
	~"comm.h
"

44 
	~"Ïy”.h
"

45 
	~"‹rm.h
"

48 #ifdeà
DEBUG


49 
	#STATIC


	)

51 
	#STATIC
 

	)

54 #ifdeà
DEBUG


55 
	#DEBUGDIR
 "/tmp/debug"

	)

56 
	#debugf
(
a
èdØ{if(
då
){
årštf
‡;
	`fæush
(då);}} 0)

	)

57 
	#debug
(
x
è
	`debugf
((
då
,x))

	)

58 
	#debug1
(
x
,
a
è
	`debugf
((
då
,x,a))

	)

59 
	#debug2
(
x
,
a
,
b
è
	`debugf
((
då
,x,a,b))

	)

60 
	#debug3
(
x
,
a
,
b
,
c
è
	`debugf
((
då
,x,a,b,c))

	)

61 
FILE
 *
då
;

63 
	#debugf
(
a
èdØ{} 0)

	)

64 
	#debug
(
x
è
	`debugf
(x)

	)

65 
	#debug1
(
x
,
a
è
	`debugf
(x)

	)

66 
	#debug2
(
x
,
a
,
b
è
	`debugf
(x)

	)

67 
	#debug3
(
x
,
a
,
b
,
c
è
	`debugf
(x)

	)

70 #iâdeà
DEBUG


71 
	#NOASSERT


	)

74 #iâdeà
NOASSERT


75 #ià
defšed
(
__STDC__
)

76 
	#ASSERT
(
lousy_ıp
èdØ{ià(!Öousy_ıp)è{ià(!
då
è
	`İ’debug
(0, 1);
	`debug2
("ASSERT("#lousy_ıp"èçed f% lš%d\n", 
__FILE__
, 
__LINE__
);
	`abÜt
();}} 0)

	)

78 
	#ASSERT
(
lousy_ıp
èdØ{ià(!Öousy_ıp)è{ià(!
då
è
	`İ’debug
(0, 1);
	`debug2
("ASSERTÖousy_ıpèçed f% lš%d\n", 
__FILE__
, 
__LINE__
);
	`abÜt
();}} 0)

	)

81 
	#ASSERT
(
lousy_ıp
èdØ{} 0)

	)

85 
	#F»e
(
a
è{ià(×è=ğ0è
	`abÜt
(); 
	`ä“
((*)×)); (a)=0;}

	)

87 
	#CŒl
(
c
è((c)&037)

	)

89 
	#MAXSTR
 256

	)

90 
	#MAXARGS
 64

	)

91 
	#MSGWAIT
 5

	)

92 
	#MSGMINWAIT
 1

	)

93 
	#SILENCEWAIT
 30

	)

99 
	#MAXHISTHEIGHT
 3000

	)

100 
	#DEFAULTHISTHEIGHT
 100

	)

101 #ià
defšed
(
NAME_MAX
) && NAME_MAX < 16

102 
	#DEFAULT_BUFFERFILE
 "/tmp/sü“n-xchg"

	)

104 
	#DEFAULT_BUFFERFILE
 "/tmp/sü“n-exchªge"

	)

108 #ià
defšed
(
hpux
è&& !(defšed(
VSUSP
è&& defšed(
VDSUSP
è&& defšed(
VWERASE
è&& defšed(
VLNEXT
))

109 
	#HPUX_LTCHARS_HACK


	)

112 
	smode


114 #ifdeà
POSIX


115 
‹rmios
 
	mtio
;

116 #ifdeà
HPUX_LTCHARS_HACK


117 
Éch¬s
 
	mm_Éch¬s
;

120 #ifdeà
TERMIO


121 
‹rmio
 
	mtio
;

122 #ifdeà
CYTERMIO


123 
	mm_m­key
;

124 
	mm_m­sü“n
;

125 
	mm_back¥aû
;

128 
sg‰yb
 
	mm_‰yb
;

129 
tch¬s
 
	mm_tch¬s
;

130 
Éch¬s
 
	mm_Éch¬s
;

131 
	mm_ldisc
;

132 
	mm_lmode
;

135 #ià
defšed
(
KANJI
è&& defšed(
TIOCKSET
)

136 
jtch¬s
 
	mm_jtch¬s
;

137 
	mm_knjmode
;

143 
	~"image.h
"

144 
	~"di¥Ïy.h
"

145 
	~"wšdow.h
"

150 
	#D_DETACH
 0

	)

151 
	#D_STOP
 1

	)

152 
	#D_REMOTE
 2

	)

153 
	#D_POWER
 3

	)

154 
	#D_REMOTE_POWER
 4

	)

155 
	#D_LOCK
 5

	)

156 
	#D_HANGUP
 6

	)

161 
	#MSG_CREATE
 0

	)

162 
	#MSG_ERROR
 1

	)

163 
	#MSG_ATTACH
 2

	)

164 
	#MSG_CONT
 3

	)

165 
	#MSG_DETACH
 4

	)

166 
	#MSG_POW_DETACH
 5

	)

167 
	#MSG_WINCH
 6

	)

168 
	#MSG_HANGUP
 7

	)

169 
	#MSG_COMMAND
 8

	)

175 
	#MSG_VERSION
 0

	)

176 
	#MSG_REVISION
 (('m'<<24è| ('s'<<16è| ('g'<<8è| 
MSG_VERSION
)

	)

177 
	smsg


179 
	m´ÙocŞ_»visiÚ
;

180 
	mty³
;

181 
	mm_‰y
[
MAXPATHLEN
];

186 
	mlæag
;

187 
	maæag
;

188 
	mæowæag
;

189 
	mhheight
;

190 
	mÇrgs
;

191 
	mlše
[
MAXPATHLEN
];

192 
	mdœ
[
MAXPATHLEN
];

193 
	msü“Á”m
[20];

195 
	mü—‹
;

198 
	mau£r
[20 + 1];

199 
	m­id
;

200 
	mad­tæag
;

201 
	mlšes
, 
	mcŞumns
;

202 
	m´e£Ëù
[20];

203 
	mesc
;

204 
	mm‘a_esc
;

205 
	m’v‹rm
[20 + 1];

206 
	m’codšg
;

208 
	m©ch
;

211 
	mdu£r
[20 + 1];

212 
	mdpid
;

214 
	md‘ach
;

217 
	mau£r
[20 + 1];

218 
	mÇrgs
;

219 
	mcmd
[
MAXPATHLEN
];

220 
	m­id
;

221 
	m´e£Ëù
[20];

223 
	mcommªd
;

224 
	mmes§ge
[
MAXPATHLEN
 * 2];

225 } 
	mm
;

231 
	#SIG_BYE
 
SIGHUP


	)

232 
	#SIG_POWER_BYE
 
SIGUSR1


	)

233 
	#SIG_LOCK
 
SIGUSR2


	)

234 
	#SIG_STOP
 
SIGTSTP


	)

235 #ifdeà
SIGIO


236 
	#SIG_NODEBUG
 
SIGIO


	)

240 
	#BELL
 (
	`CŒl
('g'))

	)

241 
	#VBELLWAIT
 1

	)

243 
	#BELL_ON
 0

	)

244 
	#BELL_FOUND
 1

	)

245 
	#BELL_DONE
 2

	)

247 
	#BELL_VISUAL
 3

	)

249 
	#MON_OFF
 0

	)

250 
	#MON_ON
 1

	)

251 
	#MON_FOUND
 2

	)

252 
	#MON_DONE
 3

	)

254 
	#DUMP_TERMCAP
 0

	)

255 
	#DUMP_HARDCOPY
 1

	)

256 
	#DUMP_EXCHANGE
 2

	)

257 
	#DUMP_SCROLLBACK
 3

	)

259 
	#SILENCE_OFF
 0

	)

260 
	#SILENCE_ON
 1

	)

262 
¡ºomem
[];

267 
	#INP_COOKED
 0

	)

268 
	#INP_NOECHO
 1

	)

269 
	#INP_RAW
 2

	)

270 
	#INP_EVERY
 4

	)

273 #ifdeà
MULTIUSER


274 
	saş


276 
aş
 *
	mÃxt
;

277 *
	mÇme
;

282 
	#MAX_PLOP_DEFS
 256

	)

284 
	sbaud_v®ues


286 
	midx
;

287 
	mbps
;

288 
	msym
;

294 
	#WLIST_NUM
 0

	)

295 
	#WLIST_MRU
 1

	)

	@search.c

24 
	~<sys/ty³s.h
>

26 
	~"cÚfig.h
"

27 
	~"sü“n.h
"

28 
	~"m¬k.h
"

29 
	~"ex‹º.h
"

31 
	#INPUTLINE
 (
æay”
->
l_height
 - 1)

	)

33 
Ïy”
 *
æay”
;

34 
wš
 *
fÜe
;

36 #ifdeà
COPY_PASTE


38 
	g£¬ch_ic
;

44 
m©chwÜd
 
__P
((*, , , ));

45 
£¬ch’d
 
__P
((*, , *));

46 
back£¬ch’d
 
__P
((*, , *));

49 
	$S—rch
(
dœ
)

50 
dœ
;

52 
m¬kd©a
 *markdata;

53 ià(
dœ
 == 0)

55 
m¬kd©a
 = (m¬kd©¨*)
æay”
->
l_d©a
;

56 ià(
m¬kd©a
->
isdœ
 > 0)

57 
	`£¬ch’d
(0, 0, 
NULL
);

58 ià(
m¬kd©a
->
isdœ
 < 0)

59 
	`back£¬ch’d
(0, 0, 
NULL
);

61 
	`LMsg
(0, "No…revious…attern");

64 
	`IÅut
((
dœ
 > 0 ? "/" : "?"), (
m¬kd©a
->
is¡r
)-1, 
INP_COOKED
,

65 (
dœ
 > 0 ? 
£¬ch’d
 : 
back£¬ch’d
), 
NULL
);

66 
	}
}

69 
	$£¬ch’d
(
buf
, 
Ën
, 
d©a
)

70 *
buf
;

71 
Ën
;

72 *
d©a
;

74 
x
 = 0, 
sx
, 
ex
, 
y
;

75 
m¬kd©a
 *markdata;

76 
wš
 *
p
;

78 
m¬kd©a
 = (m¬kd©¨*)
æay”
->
l_d©a
;

79 
p
 = 
m¬kd©a
->
md_wšdow
;

80 
m¬kd©a
->
isdœ
 = 1;

81 ià(
Ën
)

82 
	`¡rıy
(
m¬kd©a
->
is¡r
, 
buf
);

83 
sx
 = 
m¬kd©a
->
cx
 + 1;

84 
ex
 = 
æay”
->
l_width
 - 1;

85 
y
 = 
m¬kd©a
->
cy
; y < 
p
->
w_hi¡height
 + 
æay”
->
l_height
; y++, 
sx
 = 0)

87 ià((
x
 = 
	`m©chwÜd
(
m¬kd©a
->
is¡r
, 
y
, 
sx
, 
ex
)) >= 0)

90 ià(
y
 >ğ
p
->
w_hi¡height
 + 
æay”
->
l_height
)

92 
	`LGÙoPos
(
æay”
, 
m¬kd©a
->
cx
, 
	`W2D
(m¬kd©a->
cy
));

93 
	`LMsg
(0, "Pattern‚ot found");

96 
	`»vto
(
x
, 
y
);

97 
	}
}

100 
	$back£¬ch’d
(
buf
, 
Ën
, 
d©a
)

101 *
buf
;

102 
Ën
;

103 *
d©a
;

105 
sx
, 
ex
, 
x
 = -1, 
y
;

106 
m¬kd©a
 *markdata;

108 
m¬kd©a
 = (m¬kd©¨*)
æay”
->
l_d©a
;

109 
m¬kd©a
->
isdœ
 = -1;

110 ià(
Ën
)

111 
	`¡rıy
(
m¬kd©a
->
is¡r
, 
buf
);

112 
ex
 = 
m¬kd©a
->
cx
 - 1;

113 
y
 = 
m¬kd©a
->
cy
; y >ğ0; y--, 
ex
 = 
æay”
->
l_width
 - 1)

115 
sx
 = 0;

116 (
sx
 = 
	`m©chwÜd
(
m¬kd©a
->
is¡r
, 
y
, sx, 
ex
)) >= 0)

117 
x
 = 
sx
++;

118 ià(
x
 >= 0)

121 ià(
y
 < 0)

123 
	`LGÙoPos
(
æay”
, 
m¬kd©a
->
cx
, 
	`W2D
(m¬kd©a->
cy
));

124 
	`LMsg
(0, "Pattern‚ot found");

127 
	`»vto
(
x
, 
y
);

128 
	}
}

131 
	$m©chwÜd
(
·‰”n
, 
y
, 
sx
, 
ex
)

132 *
·‰”n
;

133 
y
, 
sx
, 
ex
;

135 *

, *
e
, *
ı
, *
µ
;

136 
mlše
 *
ml
;

139 
fÜe
 = ((
m¬kd©a
 *)
æay”
->
l_d©a
)->
md_wšdow
;

141 
ml
 = 
	`WIN
(
y
);

142 

 = 
ml
->
image
 + 
sx
;

143 
e
 = 
ml
->
image
 + 
æay”
->
l_width
;

144 ;
sx
 <ğ
ex
; sx++)

146 
ı
 = 

++;

147 
µ
 = (*)
·‰”n
;

150 ià(*
ı
 !ğ*
µ
)

151 ià(!
£¬ch_ic
 || ((*
ı
 ^ *
µ
) & 0xdf) || (*cp | 0x20) < 'a' || (*cp | 0x20) > 'z')

153 
ı
++;

154 
µ
++;

155 ià(*
µ
 == 0)

156  
sx
;

157 ià(
ı
 =ğ
e
)

162 
	}
}

169 *
	gi¥rom±s
[] = {

175 
is_»do
 
__P
((
m¬kd©a
 *));

176 
is_´oûss
 
__P
((*, , *));

177 
is_bm
 
__P
((*, , , , ));

181 
	$is_bm
(
¡r
, 
l
, 
p
, 
’d
, 
dœ
)

182 *
¡r
;

183 
l
, 
p
, 
’d
, 
dœ
;

185 
b
[256];

186 
i
, 
q
;

187 *
s
, 
c
;

188 
w
 = 
æay”
->
l_width
;

191 
fÜe
 = ((
m¬kd©a
 *)
æay”
->
l_Ãxt
->
l_d©a
)->
md_wšdow
;

192 
	`debug2
("is_bm: s—rchšg fÜ % ËÀ%d\n", 
¡r
, 
l
);

193 
	`debug3
("¡¬ˆ© %dƒnd %d dœ %d\n", 
p
, 
’d
, 
dœ
);

194 ià(
p
 < 0 ||… + 
l
 > 
’d
)

196 ià(
l
 == 0)

197  
p
;

198 ià(
dœ
 < 0)

199 
¡r
 +ğ
l
 - 1;

200 
i
 = 0; i < 256; i++)

201 
b
[
i
] = 
l
 * 
dœ
;

202 
i
 = 0; i < 
l
 - 1; i++, 
¡r
 +ğ
dœ
)

204 
q
 = *(*)
¡r
;

205 
b
[
q
] = (
l
 - 1 - 
i
è* 
dœ
;

206 ià(
£¬ch_ic
 && (
q
 | 0x20) >= 'a' && ((q | 0x20) <= 'z'))

207 
b
[
q
 ^ 0x20] = (
l
 - 1 - 
i
è* 
dœ
;

209 ià(
dœ
 > 0)

210 
p
 +ğ
l
 - 1;

211 
	`debug1
("fœ¡ ch¬Øm©ch: %c\n", *
¡r
);

212 
p
 >ğ0 &&… < 
’d
)

214 
q
 = 
p
;

215 
s
 = (*)
¡r
;

216 
i
 = 0;;)

218 
c
 = (
	`WIN
(
q
 / 
w
))->
image
[q % w];

219 ià(
i
 == 0)

220 
p
 +ğ
b
[()(è
c
];

221 ià(
c
 !ğ*
s
)

222 ià(!
£¬ch_ic
 || ((
c
 ^ *
s
) & 0xdf) || (c | 0x20) < 'a' || (c | 0x20) > 'z')

224 
q
 -ğ
dœ
;

225 
s
 -ğ
dœ
;

226 ià(++
i
 =ğ
l
)

227  
q
 + (
dœ
 > 0 ? 1 : -
l
);

231 
	}
}

236 
	$is_´oûss
(
p
, 
n
, 
d©a
)

237 *
p
;

238 
n
;

239 *
d©a
;

241 
pos
, 
x
, 
y
, 
dœ
;

242 
m¬kd©a
 *markdata;

244 ià(
n
 == 0)

246 
	`ASSERT
(
p
);

247 
m¬kd©a
 = (m¬kd©¨*)
æay”
->
l_Ãxt
->
l_d©a
;

249 
pos
 = 
m¬kd©a
->
cx
 + m¬kd©a->
cy
 * 
æay”
->
l_width
;

250 
	`LGÙoPos
(
æay”
, 
m¬kd©a
->
cx
, 
	`W2D
(m¬kd©a->
cy
));

252 *
p
)

255 
pos
 = 
m¬kd©a
->
is¡¬os
;

258 *
p
 = 0;

262 
m¬kd©a
->
isi¡¾
 = 1;

266 ià(
m¬kd©a
->
isi¡¾
 == 0)

268 
m¬kd©a
->
isi¡¾
--;

269 
pos
 = 
	`is_»do
(
m¬kd©a
);

270 *
p
 = '\b';

274 ià(
m¬kd©a
->
isi¡¾
 >ğ()(m¬kd©a->
isi¡r
))

276 
dœ
 = (*
p
 == '\023') ? 1 : -1;

277 
pos
 +ğ
dœ
;

278 ià(
m¬kd©a
->
isdœ
 =ğ
dœ
 && m¬kd©a->
isi¡¾
 == 0)

280 
	`¡rıy
(
m¬kd©a
->
isi¡r
, m¬kd©a->
is¡r
);

281 
m¬kd©a
->
isi¡¾
 = m¬kd©a->
is¡¾
 = 
	`¡¾’
(m¬kd©a->
is¡r
);

284 
m¬kd©a
->
isdœ
 = 
dœ
;

285 
m¬kd©a
->
isi¡r
[m¬kd©a->
isi¡¾
++] = *
p
;

288 ià(*
p
 < ' ' || 
m¬kd©a
->
isi¡¾
 >ğ()(m¬kd©a->
isi¡r
)

289 || 
m¬kd©a
->
is¡¾
 >ğ()(m¬kd©a->
is¡r
) - 1)

291 
m¬kd©a
->
is¡r
[m¬kd©a->
is¡¾
++] = *
p
;

292 
m¬kd©a
->
isi¡r
[m¬kd©a->
isi¡¾
++] = *
p
;

293 
m¬kd©a
->
is¡r
[m¬kd©a->
is¡¾
] = 0;

294 
	`debug2
("New ch¬: %ø-†eá %d\n", *
p
, ()(
m¬kd©a
->
isi¡r
è- m¬kd©a->
isi¡¾
);

296 ià(*
p
 && *p != '\b')

297 
pos
 = 
	`is_bm
(
m¬kd©a
->
is¡r
, m¬kd©a->
is¡¾
,…os, 
æay”
->
l_width
 * (m¬kd©a->
md_wšdow
->
w_hi¡height
 + fÏy”->
l_height
), m¬kd©a->
isdœ
);

298 ià(
pos
 >= 0)

300 
x
 = 
pos
 % 
æay”
->
l_width
;

301 
y
 = 
pos
 / 
æay”
->
l_width
;

302 
LAY_CALL_UP


304 
	`LayRedi¥ÏyLše
(
INPUTLINE
, 0, 
æay”
->
l_width
 - 1, 0);

305 
	`»vto
(
x
, 
y
);

306 ià(
	`W2D
(
m¬kd©a
->
cy
è=ğ
INPUTLINE
)

307 
	`»vto_lše
(
m¬kd©a
->
cx
, m¬kd©a->
cy
, 
INPUTLINE
 > 0 ? INPUTLINE - 1 : 1);

310 ià(*
p
)

311 
	`šp_£rom±
(
i¥rom±s
[
m¬kd©a
->
isdœ
 + (
pos
 < 0è+ 1], m¬kd©a->
is¡¾
 ? m¬kd©a->
is¡r
 : "");

312 
æay”
->
l_x
 = 
m¬kd©a
->
cx
;

313 
æay”
->
l_y
 = 
	`W2D
(
m¬kd©a
->
cy
);

314 
	`LGÙoPos
(
æay”
, fÏy”->
l_x
, fÏy”->
l_y
);

315 ià(!*
p
)

318 
æay”
->
l_Ãxt
->
l_x
 = 
m¬kd©a
->
cx
;

319 
æay”
->
l_Ãxt
->
l_y
 = 
	`W2D
(
m¬kd©a
->
cy
);

321 
	}
}

324 
	$is_»do
(
m¬kd©a
)

325 
m¬kd©a
 *markdata;

327 
i
, 
pos
, 
Åos
, 
dœ
;

328 
c
;

330 
Åos
 = 
pos
 = 
m¬kd©a
->
is¡¬os
;

331 
dœ
 = 
m¬kd©a
->
is¡¬tdœ
;

332 
m¬kd©a
->
is¡¾
 = 0;

333 
i
 = 0; i < 
m¬kd©a
->
isi¡¾
; i++)

335 
c
 = 
m¬kd©a
->
isi¡r
[
i
];

336 ià(
c
 == '\022')

337 
pos
 +ğ(
dœ
 = -1);

338 ià(
c
 == '\023')

339 
pos
 +ğ(
dœ
 = 1);

341 
m¬kd©a
->
is¡r
[m¬kd©a->
is¡¾
++] = 
c
;

342 ià(
pos
 >= 0)

344 
Åos
 = 
	`is_bm
(
m¬kd©a
->
is¡r
, m¬kd©a->
is¡¾
, 
pos
, 
æay”
->
l_width
 * (m¬kd©a->
md_wšdow
->
w_hi¡height
 + fÏy”->
l_height
), 
dœ
);

345 ià(
Åos
 >= 0)

346 
pos
 = 
Åos
;

349 
m¬kd©a
->
is¡r
[m¬kd©a->
is¡¾
] = 0;

350 
m¬kd©a
->
isdœ
 = 
dœ
;

351  
Åos
;

352 
	}
}

355 
	$IS—rch
(
dœ
)

356 
dœ
;

358 
m¬kd©a
 *markdata;

360 
m¬kd©a
 = (m¬kd©¨*)
æay”
->
l_d©a
;

361 
m¬kd©a
->
isdœ
 = m¬kd©a->
is¡¬tdœ
 = 
dœ
;

362 
m¬kd©a
->
is¡¬os
 = m¬kd©a->
cx
 + m¬kd©a->
cy
 * 
æay”
->
l_width
;

363 
m¬kd©a
->
isi¡¾
 = m¬kd©a->
is¡¾
 = 0;

364 ià(
	`W2D
(
m¬kd©a
->
cy
è=ğ
INPUTLINE
)

365 
	`»vto_lše
(
m¬kd©a
->
cx
, m¬kd©a->
cy
, 
INPUTLINE
 > 0 ? INPUTLINE - 1 : 1);

366 
	`IÅut
(
i¥rom±s
[
dœ
 + 1], (
m¬kd©a
->
is¡r
è- 1, 
INP_RAW
,

367 
is_´oûss
, 
NULL
);

368 
	`LGÙoPos
(
æay”
, 
m¬kd©a
->
cx
, 
	`W2D
(m¬kd©a->
cy
));

369 
æay”
->
l_x
 = 
m¬kd©a
->
cx
;

370 
æay”
->
l_y
 = 
	`W2D
(
m¬kd©a
->
cy
);

371 
	}
}

	@socket.c

24 
	~"cÚfig.h
"

25 
	~<sys/ty³s.h
>

26 
	~<sys/¡©.h
>

27 
	~<fú.h
>

28 #ià!
defšed
(
NAMEDPIPE
)

29 
	~<sys/sock‘.h
>

30 
	~<sys/un.h
>

33 #iâdeà
SIGINT


34 
	~<sigÇl.h
>

37 
	~"sü“n.h
"

39 #ifdeà
HAVE_DIRENT_H


40 
	~<dœ’t.h
>

42 
	~<sys/dœ.h
>

43 
	#dœ’t
 
dœeù


	)

46 
	~"ex‹º.h
"

48 
CheckPid
 
__P
(());

49 
ExecC»©e
 
__P
((
msg
 *));

50 
DoCommªdMsg
 
__P
((
msg
 *));

51 #ià
defšed
(
_SEQUENT_
è&& !defšed(
NAMEDPIPE
)

52 
	#cÚÃù
 
scÚÃù


	)

53 
scÚÃù
 
__P
((, 
sockaddr
 *, ));

55 
FšishA‰ach
 
__P
((
msg
 *));

56 
AskPasswÜd
 
__P
((
msg
 *));

59 *
RcFeName
, *
exŒa_šÿp
, *
exŒa_outÿp
;

60 
S”v”Sock‘
, 
»®_uid
, 
»®_gid
, 
eff_uid
, 
eff_gid
;

61 
dæag
, 
iæag
, 
ræag
, 
lsæag
, 
qu›tæag
, 
weæag
, 
xæag
;

62 *
©ch_‰y
, *
LogšName
, 
Ho¡Name
[];

63 
di¥Ïy
 *di¥Ïy, *
di¥Ïys
;

64 
wš
 *
fÜe
, *
wb
[], *
cÚsŞe_wšdow
, *
wšdows
;

65 
Ïy”
 *
æay”
;

66 
NewWšdow
 
nwš_undef
;

67 #ifdeà
MULTIUSER


68 *
muÉi
;

71 *
g‘’v
();

73 
SockP©h
[];

74 
ev’t
 
£rv_»ad
;

75 *
rc_Çme
;

76 
comm
 
comms
[];

78 #ifdeà
MULTIUSER


79 
	#SOCKMODE
 (
S_IWRITE
 | 
S_IREAD
 | (
di¥Ïys
 ? 
S_IEXEC
 : 0è| (
muÉi
 ? 1 : 0))

	)

81 
	#SOCKMODE
 (
S_IWRITE
 | 
S_IREAD
 | (
di¥Ïys
 ? 
S_IEXEC
 : 0))

	)

106 
	$FšdSock‘
(
fdp
, 
nfoundp
, 
nÙh”p
, 
m©ch
)

107 *
fdp
;

108 *
nfoundp
, *
nÙh”p
;

109 *
m©ch
;

111 
DIR
 *
dœp
;

112 
dœ’t
 *
dp
;

113 
¡©
 
¡
;

114 
mode
;

115 
sdœËn
;

116 
m©chËn
 = 0;

117 *
Çme
, *
n
;

118 
fœ¡s
 = -1, 
sockfd
;

119 *
fœ¡n
 = 
NULL
;

120 
nfound
 = 0, 
ngood
 = 0, 
nd—d
 = 0, 
nwe
 = 0, 
Åriv
 = 0;

121 
	s£Á


123 
£Á
 *
Ãxt
;

124 
mode
;

125 *
Çme
;

126 } *
¦i¡
, **
¦i¡
, *
£Á
, *
n£Á
;

128 ià(
m©ch
)

130 
m©chËn
 = 
	`¡¾’
(
m©ch
);

131 #ifdeà
NAME_MAX


132 ià(
m©chËn
 > 
NAME_MAX
)

133 
m©chËn
 = 
NAME_MAX
;

142 
sdœËn
 = 
	`¡¾’
(
SockP©h
);

144 #ifdeà
USE_SETEUID


145 
	`x£‹uid
(
»®_uid
);

146 
	`x£‹gid
(
»®_gid
);

149 ià((
dœp
 = 
	`İ’dœ
(
SockP©h
)) == 0)

150 
	`Pªic
(
”ºo
, "CªnÙ o³ndœ %s", 
SockP©h
);

152 
¦i¡
 = 0;

153 
¦i¡
 = &
¦i¡
;

154 (
dp
 = 
	`»addœ
(
dœp
)))

156 
Çme
 = 
dp
->
d_Çme
;

157 
	`debug1
("- %s\n", 
Çme
);

158 ià(*
Çme
 =ğ0 || *Çm=ğ'.' || 
	`¡¾’
Òameè> 2*
MAXSTR
)

160 ià(
m©chËn
)

162 
n
 = 
Çme
;

164 ià((*
m©ch
 <ğ'0' || *m©ch > '9'è&& (*
n
 > '0' && *n <= '9'))

166 *
n
 >= '0' && *n <= '9')

167 
n
++;

168 ià(*
n
 == '.')

169 
n
++;

172 ià(
	`¡ºcmp
(
m©ch
, "‰y", 3è&& sŒncmp(
n
, "tty", 3) == 0)

173 
n
 += 3;

174 ià(
	`¡ºcmp
(
m©ch
, 
n
, 
m©chËn
))

176 
	`debug1
(" -> m©ched %s\n", 
m©ch
);

178 
	`¥rštf
(
SockP©h
 + 
sdœËn
, "/%s", 
Çme
);

180 
	`debug1
("¡© %s\n", 
SockP©h
);

181 
”ºo
 = 0;

182 
	`debug2
("uid = %d, gid = %d\n", 
	`g‘uid
(), 
	`g‘gid
());

183 
	`debug2
("euid = %d,ƒgid = %d\n", 
	`g‘euid
(), 
	`g‘egid
());

184 ià(
	`¡©
(
SockP©h
, &
¡
))

186 
	`debug1
("”ºØğ%d\n", 
”ºo
);

190 #iâdeà
SOCK_NOT_IN_FS


191 #ifdeà
NAMEDPIPE


192 #ifdeà
S_ISFIFO


193 
	`debug
("S_ISFIFO?\n");

194 ià(!
	`S_ISFIFO
(
¡
.
¡_mode
))

198 #ifdeà
S_ISSOCK


199 
	`debug
("S_ISSOCK?\n");

200 ià(!
	`S_ISSOCK
(
¡
.
¡_mode
))

206 
	`debug2
("¡.¡_uid = %d,„—l_uid = %d\n", 
¡
.
¡_uid
, 
»®_uid
);

207 ià(()
¡
.
¡_uid
 !ğ
»®_uid
)

209 
mode
 = ()
¡
.
¡_mode
 & 0777;

210 
	`debug1
(" ha mod0%03o\n", 
mode
);

211 #ifdeà
MULTIUSER


212 ià(
muÉi
 && ((
mode
 & 0677) != 0601))

214 
	`debug
(" is‚ot‡ MULTI-USER session");

215 ià(
	`¡rcmp
(
muÉi
, 
LogšName
))

217 
	`debug
("‡nd we‡re in‡ foreign directory.\n");

218 
mode
 = -4;

222 
	`debug
(", but it is our own session.\n");

226 
	`debug
(" store it.\n");

227 ià((
£Á
 = (£Á *)
	`m®loc
((sent))) == 0)

229 
£Á
->
Ãxt
 = 0;

230 
£Á
->
Çme
 = 
	`SaveSŒ
(name);

231 
£Á
->
mode
 = mode;

232 *
¦i¡
 = 
£Á
;

233 
¦i¡
 = &
£Á
->
Ãxt
;

234 
nfound
++;

235 
sockfd
 = 
	`MakeCl›ÁSock‘
(0);

236 #ifdeà
USE_SETEUID


238 
	`x£‹uid
(
»®_uid
);

239 
	`x£‹gid
(
»®_gid
);

241 ià(
sockfd
 == -1)

243 
	`debug2
(" MakeClientSocket failed, unreachable? %d %d\n",

244 
m©chËn
, 
weæag
);

245 
£Á
->
mode
 = -3;

246 #iâdeà
SOCKDIR_IS_LOCAL_TO_HOST


250 
n
 = 
Çme
 + 
	`¡¾’
(name) - 1;

251 
n
 !ğ
Çme
 && *n != '.')

252 
n
--;

253 ià(
m©chËn
 =ğ0 && !(*
n
 =ğ'.' &&‚[1] && 
	`¡ºcmp
(
Ho¡Name
,‚ + 1, 
	`¡¾’
(n + 1)) == 0))

255 
Åriv
++;

259 
nd—d
++;

260 
£Á
->
mode
 = -1;

261 ià(
weæag
)

263 ià(
	`uÆšk
(
SockP©h
) == 0)

265 
£Á
->
mode
 = -2;

266 
nwe
++;

272 
mode
 &= 0776;

274 
	`debug2
(" cÚÃùšg: mode=%03o,„æag=%d, ", 
mode
, 
ræag
);

275 
	`debug2
("xæag=%d, dæag=%d ?\n", 
xæag
, 
dæag
);

287 ià((
mode
 != 0700 && mode != 0600) ||

288 (
dæag
 && !
ræag
 && !
xæag
 && 
mode
 == 0600) ||

289 (!
dæag
 && 
ræag
 && 
mode
 =ğ0700 && !
xæag
) ||

290 (!
dæag
 && !
ræag
 && !
xæag
))

292 
	`şo£
(
sockfd
);

293 
	`debug
("‚o!\n");

294 
Åriv
++;

297 
ngood
++;

298 ià(
fdp
 && 
fœ¡s
 == -1)

300 
fœ¡s
 = 
sockfd
;

301 
fœ¡n
 = 
£Á
->
Çme
;

302 
	`debug
("aken.\n");

306 
	`debug
(" discarded.\n");

307 
	`şo£
(
sockfd
);

310 ()
	`şo£dœ
(
dœp
);

311 ià(
nfound
 && (
lsæag
 || 
ngood
 !ğ1è&& !
qu›tæag
)

313 
ngood
)

316 
	`Msg
(0, 
nfound
 > 1 ? "There‡re screens on:" : "There is‡ screen on:");

319 
	`Msg
(0, 
nfound
 > 1 ? "There‡re several screens on:" : "There is‡ suitable screen on:");

322 
	`Msg
(0, "There‡re several suitable screens on:");

325 
£Á
 = 
¦i¡
; s’t; s’ˆğ£Á->
Ãxt
)

327 
£Á
->
mode
)

330 
	`´štf
("\t%s\t(A‰ached)\n", 
£Á
->
Çme
);

333 
	`´štf
("\t%s\t(D‘ached)\n", 
£Á
->
Çme
);

335 #ifdeà
MULTIUSER


337 
	`´štf
("\t%s\t(MuÉi,‡‰ached)\n", 
£Á
->
Çme
);

340 
	`´štf
("\t%s\t(MuÉi, d‘ached)\n", 
£Á
->
Çme
);

345 
	`´štf
("\t%s\t(D—d ?%c?)\n", 
£Á
->
Çme
, '?');

348 
	`´štf
("\t%s\t(Removed)\n", 
£Á
->
Çme
);

351 
	`´štf
("\t%s\t(RemÙÜ d—d)\n", 
£Á
->
Çme
);

354 
	`´štf
("\t%s\t(Priv©e)\n", 
£Á
->
Çme
);

359 ià(
nd—d
 && !
qu›tæag
)

361 *
m
 = "Remove dead screens with 'screen -wipe'.";

362 ià(
weæag
)

363 
	`Msg
(0, "%d sock‘% wed out.", 
nwe
,‚wipe > 1 ? "s" : "");

365 
	`Msg
(0, 
m
, 
nd—d
 > 1 ? "s" : "",‚dead > 1 ? "" : "es");

367 ià(
fœ¡s
 != -1)

369 
	`¥rštf
(
SockP©h
 + 
sdœËn
, "/%s", 
fœ¡n
);

370 *
fdp
 = 
fœ¡s
;

373 
SockP©h
[
sdœËn
] = 0;

374 
£Á
 = 
¦i¡
; s’t; s’ˆğ
n£Á
)

376 
n£Á
 = 
£Á
->
Ãxt
;

377 
	`ä“
(
£Á
->
Çme
);

378 
	`ä“
((*)
£Á
);

380 #ifdeà
USE_SETEUID


381 
	`x£‹uid
(
eff_uid
);

382 
	`x£‹gid
(
eff_gid
);

384 ià(
nÙh”p
)

385 *
nÙh”p
 = 
Åriv
;

386 ià(
nfoundp
)

387 *
nfoundp
 = 
nfound
 - 
nwe
;

388  
ngood
;

389 
	}
}

398 #ifdeà
NAMEDPIPE


401 
	$MakeS”v”Sock‘
()

403 
s
;

404 
¡©
 
¡
;

406 #ifdeà
USE_SETEUID


407 
	`x£‹uid
(
»®_uid
);

408 
	`x£‹gid
(
»®_gid
);

410 ià((
s
 = 
	`İ’
(
SockP©h
, 
O_WRONLY
 | 
O_NONBLOCK
)) >= 0)

412 
	`debug
("huii, my fifo‡lreadyƒxists??\n");

413 ià(
qu›tæag
)

415 
	`Kl
(
D_u£½id
, 
SIG_BYE
);

416 
	`“x™
(11);

418 
	`Msg
(0, "Th”i ®»ady‡ sü“ÀruÂšg oÀ%s.", 
	`F’ame
(
SockP©h
));

419 ià(
	`¡©
(
SockP©h
, &
¡
) == -1)

420 
	`Pªic
(
”ºo
, "stat");

421 ià(()
¡
.
¡_uid
 !ğ
»®_uid
)

422 
	`Pªic
(0, "Unfortunatelly you‡re‚ot its owner.");

423 ià((
¡
.
¡_mode
 & 0700) == 0600)

424 
	`Pªic
(0, "To„esume it, use \"screen -r\"");

426 
	`Pªic
(0, "It is‚ot detached.");

429 #ifdeà
USE_SETEUID


430 (è
	`uÆšk
(
SockP©h
);

431 ià(
	`mkfifo
(
SockP©h
, 
SOCKMODE
))

432 
	`Pªic
(0, "mkfifØ% çed", 
SockP©h
);

433 #ifdeà
BROKEN_PIPE


434 ià((
s
 = 
	`İ’
(
SockP©h
, 
O_RDWR
 | 
O_NONBLOCK
, 0)) < 0)

436 ià((
s
 = 
	`İ’
(
SockP©h
, 
O_RDONLY
 | 
O_NONBLOCK
, 0)) < 0)

438 
	`Pªic
(
”ºo
, "İ’ fifØ%s", 
SockP©h
);

439 
	`x£‹uid
(
eff_uid
);

440 
	`x£‹gid
(
eff_gid
);

441  
s
;

443 ià(
	`U£rCÚ‹xt
() > 0)

445 (è
	`uÆšk
(
SockP©h
);

446 
	`U£rR‘uº
(
	`mkfifo
(
SockP©h
, 
SOCKMODE
));

448 ià(
	`U£rStus
())

449 
	`Pªic
(0, "mkfifØ% çed", 
SockP©h
);

450 #ifdeà
BROKEN_PIPE


451 ià((
s
 = 
	`£cİ’
(
SockP©h
, 
O_RDWR
 | 
O_NONBLOCK
, 0)) < 0)

453 ià((
s
 = 
	`£cİ’
(
SockP©h
, 
O_RDONLY
 | 
O_NONBLOCK
, 0)) < 0)

455 
	`Pªic
(
”ºo
, "İ’ fifØ%s", 
SockP©h
);

456  
s
;

458 
	}
}

462 
	$MakeCl›ÁSock‘
(
”r
)

463 
”r
;

465 
s
 = 0;

467 ià((
s
 = 
	`£cİ’
(
SockP©h
, 
O_WRONLY
 | 
O_NONBLOCK
, 0)) >= 0)

469 (è
	`fú
(
s
, 
F_SETFL
, 0);

470  
s
;

472 ià(
”r
)

473 
	`Msg
(
”ºo
, "%s", 
SockP©h
);

474 
	`debug2
("MakeCl›ÁSock‘(èİ’ % çed (%d)\n", 
SockP©h
, 
”ºo
);

476 
	}
}

483 
	$MakeS”v”Sock‘
()

485 
s
;

486 
sockaddr_un
 
a
;

487 
¡©
 
¡
;

489 ià((
s
 = 
	`sock‘
(
AF_UNIX
, 
SOCK_STREAM
, 0)) == -1)

490 
	`Pªic
(
”ºo
, "socket");

491 
a
.
sun_çmy
 = 
AF_UNIX
;

492 
	`¡ºıy
(
a
.
sun_·th
, 
SockP©h
, (a.sun_path));

493 
a
.
sun_·th
[(a.sun_path) - 1] = 0;

494 #ifdeà
USE_SETEUID


495 
	`x£‹uid
(
»®_uid
);

496 
	`x£‹gid
(
»®_gid
);

498 ià(
	`cÚÃù
(
s
, (
sockaddr
 *è&
a
, 
	`¡¾’
(
SockP©h
) + 2) != -1)

500 
	`debug
("oooooh! socket‡lready is‡live!\n");

501 ià(
qu›tæag
)

503 
	`Kl
(
D_u£½id
, 
SIG_BYE
);

508 
	`“x™
(11);

510 
	`Msg
(0, "Th”i ®»ady‡ sü“ÀruÂšg oÀ%s.", 
	`F’ame
(
SockP©h
));

511 ià(
	`¡©
(
SockP©h
, &
¡
) == -1)

512 
	`Pªic
(
”ºo
, "stat");

513 ià(
¡
.
¡_uid
 !ğ
»®_uid
)

514 
	`Pªic
(0, "Unfortunatelly you‡re‚ot its owner.");

515 ià((
¡
.
¡_mode
 & 0700) == 0600)

516 
	`Pªic
(0, "To„esume it, use \"screen -r\"");

518 
	`Pªic
(0, "It is‚ot detached.");

521 #ià
	`defšed
(
m88k
è|| defšed(
sysV68
)

522 
	`şo£
(
s
);

523 ià((
s
 = 
	`sock‘
(
AF_UNIX
, 
SOCK_STREAM
, 0)) == -1)

524 
	`Pªic
(
”ºo
, "reopen socket");

526 (è
	`uÆšk
(
SockP©h
);

527 ià(
	`bšd
(
s
, (
sockaddr
 *è& 
a
, 
	`¡¾’
(
SockP©h
) + 2) == -1)

528 
	`Pªic
(
”ºo
, "bšd (%s)", 
SockP©h
);

529 #ifdeà
SOCK_NOT_IN_FS


531 
f
;

532 ià((
f
 = 
	`£cİ’
(
SockP©h
, 
O_RDWR
 | 
O_CREAT
, 
SOCKMODE
)) < 0)

533 
	`Pªic
(
”ºo
, "shadow socket open");

534 
	`şo£
(
f
);

537 
	`chmod
(
SockP©h
, 
SOCKMODE
);

538 #iâdeà
USE_SETEUID


539 
	`chown
(
SockP©h
, 
»®_uid
, 
»®_gid
);

542 ià(
	`li¡’
(
s
, 5) == -1)

543 
	`Pªic
(
”ºo
, "listen");

544 #ifdeà
F_SETOWN


545 
	`fú
(
s
, 
F_SETOWN
, 
	`g‘pid
());

546 
	`debug1
("S”v”sock‘ owÃd by %d\n", 
	`fú
(
s
, 
F_GETOWN
, 0));

548 #ifdeà
USE_SETEUID


549 
	`x£‹uid
(
eff_uid
);

550 
	`x£‹gid
(
eff_gid
);

552  
s
;

553 
	}
}

556 
	$MakeCl›ÁSock‘
(
”r
)

557 
”r
;

559 
s
;

560 
sockaddr_un
 
a
;

562 ià((
s
 = 
	`sock‘
(
AF_UNIX
, 
SOCK_STREAM
, 0)) == -1)

563 
	`Pªic
(
”ºo
, "socket");

564 
a
.
sun_çmy
 = 
AF_UNIX
;

565 
	`¡ºıy
(
a
.
sun_·th
, 
SockP©h
, (a.sun_path));

566 
a
.
sun_·th
[(a.sun_path) - 1] = 0;

567 #ifdeà
USE_SETEUID


568 
	`x£‹uid
(
»®_uid
);

569 
	`x£‹gid
(
»®_gid
);

571 ià(
	`acûss
(
SockP©h
, 
W_OK
))

573 ià(
”r
)

574 
	`Msg
(
”ºo
, "%s", 
SockP©h
);

575 
	`debug2
("MakeCl›ÁSock‘:‡cûss(%s): %d.\n", 
SockP©h
, 
”ºo
);

576 
	`şo£
(
s
);

580 ià(
	`cÚÃù
(
s
, (
sockaddr
 *è&
a
, 
	`¡¾’
(
SockP©h
) + 2) == -1)

582 ià(
”r
)

583 
	`Msg
(
”ºo
, "%s: cÚÃù", 
SockP©h
);

584 
	`debug
("MakeClientSocket: connect failed.\n");

585 
	`şo£
(
s
);

586 
s
 = -1;

588 #ifdeà
USE_SETEUID


589 
	`x£‹uid
(
eff_uid
);

590 
	`x£‹gid
(
eff_gid
);

592  
s
;

593 
	}
}

604 
	$S’dC»©eMsg
(
¡y
, 
nwš
)

605 *
¡y
;

606 
NewWšdow
 *
nwš
;

608 
s
;

609 
msg
 
m
;

610 *
p
;

611 
Ën
, 
n
;

612 **
av
 = 
nwš
->
¬gs
;

614 #ifdeà
NAME_MAX


615 ià(
	`¡¾’
(
¡y
è> 
NAME_MAX
)

616 
¡y
[
NAME_MAX
] = 0;

618 ià(
	`¡¾’
(
¡y
è> 2 * 
MAXSTR
 - 1)

619 
¡y
[2 * 
MAXSTR
 - 1] = 0;

620 
	`¥rštf
(
SockP©h
 + 
	`¡¾’
(SockP©h), "/%s", 
¡y
);

621 ià((
s
 = 
	`MakeCl›ÁSock‘
(1)) == -1)

622 
	`ex™
(1);

623 
	`debug1
("S’dC»©eMsg(ètØ'%s'\n", 
SockP©h
);

624 
	`bz”o
((*)&
m
, (m));

625 
m
.
ty³
 = 
MSG_CREATE
;

626 
	`¡ºıy
(
m
.
m_‰y
, 
©ch_‰y
, (m.m_tty) - 1);

627 
m
.
m_‰y
[(m.m_tty) - 1] = 0;

628 
p
 = 
m
.m.
ü—‹
.
lše
;

629 
n
 = 0;

630 ià(
nwš
->
¬gs
 !ğ
nwš_undef
.args)

631 
av
 = 
nwš
->
¬gs
; *av && 
n
 < 
MAXARGS
 - 1; ++av, ++n)

633 
Ën
 = 
	`¡¾’
(*
av
) + 1;

634 ià(
p
 + 
Ën
 >ğ
m
.m.
ü—‹
.
lše
 + (m.m.create.line) - 1)

636 
	`¡rıy
(
p
, *
av
);

637 
p
 +ğ
Ën
;

639 ià(
nwš
->
aka
 !ğ
nwš_undef
.ak¨&& 
p
 + 
	`¡¾’
Òwš->akaè+ 1 < 
m
.m.
ü—‹
.
lše
 + (m.m.create.line))

640 
	`¡rıy
(
p
, 
nwš
->
aka
);

642 *
p
 = '\0';

643 
m
.m.
ü—‹
.
Çrgs
 = 
n
;

644 
m
.m.
ü—‹
.
aæag
 = 
nwš
->aflag;

645 
m
.m.
ü—‹
.
æowæag
 = 
nwš
->flowflag;

646 
m
.m.
ü—‹
.
læag
 = 
nwš
->lflag;

647 
m
.m.
ü—‹
.
hheight
 = 
nwš
->
hi¡height
;

648 ià(
	`g‘cwd
(
m
.m.
ü—‹
.
dœ
, (m.m.create.dir)) == 0)

650 
	`Msg
(
”ºo
, "getcwd");

653 ià(
nwš
->
‹rm
 !ğ
nwš_undef
.term)

654 
	`¡ºıy
(
m
.m.
ü—‹
.
sü“Á”m
, 
nwš
->
‹rm
, 19);

655 
m
.m.
ü—‹
.
sü“Á”m
[19] = '\0';

656 
m
.
´ÙocŞ_»visiÚ
 = 
MSG_REVISION
;

657 
	`debug1
("S’dC»©eMsg wr™šg '%s'\n", 
m
.m.
ü—‹
.
lše
);

658 ià(
	`wr™e
(
s
, (*è&
m
,  m) !=  m)

659 
	`Msg
(
”ºo
, "write");

660 
	`şo£
(
s
);

661 
	}
}

664 
	$S’dE¼ÜMsg
(
‰y
, 
buf
)

665 *
‰y
, *
buf
;

667 
s
;

668 
msg
 
m
;

670 
	`¡ºıy
(
m
.m.
mes§ge
, 
buf
, (m.m.message) - 1);

671 
m
.m.
mes§ge
[(m.m.message) - 1] = 0;

672 
s
 = 
	`MakeCl›ÁSock‘
(0);

673 ià(
s
 < 0)

675 
m
.
ty³
 = 
MSG_ERROR
;

676 
	`¡ºıy
(
m
.
m_‰y
, 
‰y
, (m.m_tty) - 1);

677 
m
.
m_‰y
[(m.m_tty) - 1] = 0;

678 
m
.
´ÙocŞ_»visiÚ
 = 
MSG_REVISION
;

679 
	`debug1
("S’dE¼ÜMsg(): wr™šgØ'%s'\n", 
SockP©h
);

680 (è
	`wr™e
(
s
, (*è&
m
,  m);

681 
	`şo£
(
s
);

683 
	}
}

686 
	$ExecC»©e
(
mp
)

687 
msg
 *
mp
;

689 
NewWšdow
 
nwš
;

690 *
¬gs
[
MAXARGS
];

691 
n
;

692 **
µ
 = 
¬gs
, *
p
 = 
mp
->
m
.
ü—‹
.
lše
;

694 
nwš
 = 
nwš_undef
;

695 
n
 = 
mp
->
m
.
ü—‹
.
Çrgs
;

696 ià(
n
 > 
MAXARGS
 - 1)

697 
n
 = 
MAXARGS
 - 1;

699 ià(
n
)

701 
l
, 
num
;

702 
buf
[20];

704 
l
 = 
	`¡¾’
(
p
);

705 ià(
	`IsNumCŞÚ
(
p
, 10, 
buf
, (buf)))

707 ià(*
buf
)

708 
nwš
.
aka
 = 
buf
;

709 
num
 = 
	`©oi
(
p
);

710 ià(
num
 < 0 ||‚um > 
MAXWIN
 - 1)

711 
num
 = 0;

712 
nwš
.
S¹At
 = 
num
;

713 
p
 +ğ
l
 + 1;

714 
n
--;

717 ; 
n
 > 0;‚--)

719 *
µ
++ = 
p
;

720 
p
 +ğ
	`¡¾’
(p) + 1;

722 *
µ
 = 0;

723 ià(*
p
)

724 
nwš
.
aka
 = 
p
;

725 ià(*
¬gs
)

726 
nwš
.
¬gs
 =‡rgs;

727 
nwš
.
aæag
 = 
mp
->
m
.
ü—‹
.aflag;

728 
nwš
.
æowæag
 = 
mp
->
m
.
ü—‹
.flowflag;

729 ià(*
mp
->
m
.
ü—‹
.
dœ
)

730 
nwš
.
dœ
 = 
mp
->
m
.
ü—‹
.dir;

731 
nwš
.
læag
 = 
mp
->
m
.
ü—‹
.lflag;

732 
nwš
.
hi¡height
 = 
mp
->
m
.
ü—‹
.
hheight
;

733 ià(*
mp
->
m
.
ü—‹
.
sü“Á”m
)

734 
nwš
.
‹rm
 = 
mp
->
m
.
ü—‹
.
sü“Á”m
;

735 
	`MakeWšdow
(&
nwš
);

736 
	}
}

739 
	$CheckPid
(
pid
)

740 
pid
;

742 
	`debug1
("Checkšg…id %d\n", 
pid
);

743 ià(
pid
 < 2)

745 ià(
eff_uid
 =ğ
»®_uid
)

746  
	`kl
(
pid
, 0);

747 ià(
	`U£rCÚ‹xt
() > 0)

748 
	`U£rR‘uº
(
	`kl
(
pid
, 0));

749  
	`U£rStus
();

750 
	}
}

752 #ifdeà
hpux


767 
	$‰ycmp
(
s1
, 
s2
)

768 *
s1
, *
s2
;

770 ià(
	`¡¾’
(
s1
) > 5) s1 += strlen(s1) - 5;

771 ià(
	`¡¾’
(
s2
) > 5) s2 += strlen(s2) - 5;

772  
	`¡rcmp
(
s1
, 
s2
);

773 
	}
}

774 
	#TTYCMP
(
a
, 
b
è
	`‰ycmp
×, b)

	)

776 
	#TTYCMP
(
a
, 
b
è
	`¡rcmp
×, b)

	)

780 
	$ReûiveMsg
()

782 
Ëá
, 
Ën
, 
i
;

783 
msg
 
m
;

784 *
p
;

785 
ns
 = 
S”v”Sock‘
;

786 
mode
 
Mode
;

787 
wš
 *
wi
;

788 #ifdeà
REMOTE_DETACH


789 
di¥Ïy
 *
Ãxt
;

791 
di¥Ïy
 *
Şddi¥Ïys
 = 
di¥Ïys
;

793 #ifdeà
NAMEDPIPE


794 
	`debug
("Ha,here was someone knocking on my fifo??\n");

795 ià(
	`fú
(
S”v”Sock‘
, 
F_SETFL
, 0) == -1)

796 
	`Pªic
(
”ºo
, "BLOCK fcntl");

798 
sockaddr_un
 
a
;

800 
Ën
 = (
a
);

801 
	`debug
("Ha,here was someone knocking on my socket??\n");

802 ià((
ns
 = 
	`acû±
Òs, (
sockaddr
 *è&
a
, &
Ën
)) < 0)

804 
	`Msg
(
”ºo
, "accept");

809 
p
 = (*è&
m
;

810 
Ëá
 = (
m
);

811 
Ëá
 > 0)

813 
Ën
 = 
	`»ad
(
ns
, 
p
, 
Ëá
);

814 ià(
Ën
 < 0 && 
”ºo
 =ğ
EINTR
)

816 ià(
Ën
 <= 0)

818 
p
 +ğ
Ën
;

819 
Ëá
 -ğ
Ën
;

822 #ifdeà
NAMEDPIPE


823 #iâdeà
BROKEN_PIPE


825 
	`şo£
(
S”v”Sock‘
);

826 ià((
S”v”Sock‘
 = 
	`£cİ’
(
SockP©h
, 
O_RDONLY
 | 
O_NONBLOCK
, 0)) < 0)

827 
	`Pªic
(
”ºo
, "»İ’ fifØ%s", 
SockP©h
);

828 
	`evdeq
(&
£rv_»ad
);

829 
£rv_»ad
.
fd
 = 
S”v”Sock‘
;

830 
	`ev’q
(&
£rv_»ad
);

833 
	`şo£
(
ns
);

836 ià(
Ën
 < 0)

838 
	`Msg
(
”ºo
, "read");

841 ià(
Ëá
 > 0)

843 ià(
Ëá
 !ğ(
m
))

844 
	`Msg
(0, "Mes§g%d oà%d by‹ toØsm®l", 
Ëá
, ()(
m
));

846 
	`debug
("No data on socket.\n");

849 ià(
m
.
´ÙocŞ_»visiÚ
 !ğ
MSG_REVISION
)

851 
	`Msg
(0, "Inv®id mes§g(magiø0x%08x).", 
m
.
´ÙocŞ_»visiÚ
);

855 
	`debug2
("*** RecMsg:y³ %dty %s\n", 
m
.
ty³
, m.
m_‰y
);

856 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

857 ià(
	`TTYCMP
(
D_u£¹ty
, 
m
.
m_‰y
) == 0)

859 
	`debug2
("di¥Ïy: % di¥Ïy %sfound\n", 
m
.
m_‰y
, 
di¥Ïy
 ? "" : "not ");

860 
wi
 = 0;

861 ià(!
di¥Ïy
)

863 
wi
 = 
wšdows
; wi; w˜ğwi->
w_Ãxt
)

864 ià(!
	`TTYCMP
(
m
.
m_‰y
, 
wi
->
w_‰y
))

867 
di¥Ïy
 = 
wi
->
w_Ïy”
.
l_cvli¡
 ? wi->w_Ïy”.l_cvli¡->
c_di¥Ïy
 : 0;

868 
	`debug2
("buˆwšdow % %sfound.\n", 
m
.
m_‰y
, 
di¥Ïy
 ? "" :

875 ià(
di¥Ïy
 && 
D_¡©us
)

876 
	`RemoveStus
();

878 ià(
di¥Ïy
 && !
D_tcš™ed
 && 
m
.
ty³
 !ğ
MSG_HANGUP
)

881 
m
.
ty³
)

883 
MSG_WINCH
:

884 ià(
di¥Ïy
)

885 
	`CheckSü“nSize
(1);

887 
MSG_CREATE
:

896 ià(
di¥Ïys
)

897 
	`ExecC»©e
(&
m
);

899 
MSG_CONT
:

900 ià(
di¥Ïy
 && 
D_u£½id
 !ğ0 && 
	`kl
(D_userpid, 0) == 0)

902 
	`debug2
("RecMsg:‡pid=%d,wa %d\n", 
m
.m.
©ch
.
­id
, 
di¥Ïy
 ? 
D_u£½id
 : 0);

905 
MSG_ATTACH
:

906 ià(
	`CheckPid
(
m
.m.
©ch
.
­id
))

908 
	`Msg
(0, "A‰ach‡‰em± w™h bad…id(%d)!", 
m
.m.
©ch
.
­id
);

911 ià((
i
 = 
	`£cİ’
(
m
.
m_‰y
, 
O_RDWR
 | 
O_NONBLOCK
, 0)) < 0)

913 
	`Msg
(
”ºo
, "A‰ach: Could‚Ù o³À%s!", 
m
.
m_‰y
);

914 
	`Kl
(
m
.m.
©ch
.
­id
, 
SIG_BYE
);

917 #ifdeà
MULTIUSER


918 
	`Kl
(
m
.m.
©ch
.
­id
, 
SIGCONT
);

921 #ià
	`defšed
(
uÉrix
è|| defšed(
pyr
è|| defšed(
NeXT
)

922 
	`brk‰y
(
i
);

925 ià(
di¥Ïy
 || 
wi
)

927 
	`wr™e
(
i
, "Attaching from inside of screen?\n", 33);

928 
	`şo£
(
i
);

929 
	`Kl
(
m
.m.
©ch
.
­id
, 
SIG_BYE
);

930 
	`Msg
(0, "Attach msg ignored: coming from inside.");

934 #ifdeà
MULTIUSER


935 ià(
	`¡rcmp
(
m
.m.
©ch
.
au£r
, 
LogšName
))

936 ià(*
	`FšdU£rPŒ
(
m
.m.
©ch
.
au£r
) == 0)

938 
	`wr™e
(
i
, "Accesso session denied.\n", 26);

939 
	`şo£
(
i
);

940 
	`Kl
(
m
.m.
©ch
.
­id
, 
SIG_BYE
);

941 
	`Msg
(0, "A‰ach:‡cûs d’›d fÜ u£¸%s.", 
m
.m.
©ch
.
au£r
);

946 
	`debug2
("RecMsg:‡pid %d i o.k.‡nd wju¡ o³Ãd '%s'\n", 
m
.m.
©ch
.
­id
, m.
m_‰y
);

947 #iâdeà
MULTI


948 ià(
di¥Ïys
)

950 
	`wr™e
(
i
, "Screen session in use.\n", 23);

951 
	`şo£
(
i
);

952 
	`Kl
(
m
.m.
©ch
.
­id
, 
SIG_BYE
);

958 
	`G‘TTY
(
i
, &
Mode
);

959 ià(
	`MakeDi¥Ïy
(
m
.m.
©ch
.
au£r
, m.
m_‰y
, m.m.©ch.
’v‹rm
, 
i
, m.m.©ch.
­id
, &
Mode
) == 0)

961 
	`wr™e
(
i
, "Could‚ot make display.\n", 24);

962 
	`şo£
(
i
);

963 
	`Msg
(0, "A‰ach: could‚Ù makdi¥Ïy fÜ u£¸%s", 
m
.m.
©ch
.
au£r
);

964 
	`Kl
(
m
.m.
©ch
.
­id
, 
SIG_BYE
);

967 #ifdeà
ENCODINGS


968 #ifdeà
UTF8


969 
D_’codšg
 = 
m
.m.
©ch
.
’codšg
 =ğ1 ? 
UTF8
 : m.m.attach.encoding ? m.m.attach.encoding - 1 : 0;

971 
D_’codšg
 = 
m
.m.
©ch
.
’codšg
 ? m.m.attach.encoding - 1 : 0;

973 ià(
D_’codšg
 < 0 || !
	`EncodšgName
(D_encoding))

974 
D_’codšg
 = 0;

977 ià(
iæag
 && 
Şddi¥Ïys
)

979 
iæag
 = 0;

980 #ià
	`defšed
(
TERMIO
è|| defšed(
POSIX
)

981 
Şddi¥Ïys
->
d_NewMode
.
tio
.
c_cc
[
VINTR
] = 
VDISABLE
;

982 
Şddi¥Ïys
->
d_NewMode
.
tio
.
c_læag
 &ğ~
ISIG
;

984 
Şddi¥Ïys
->
d_NewMode
.
m_tch¬s
.
t_šŒc
 = -1;

986 
	`S‘TTY
(
Şddi¥Ïys
->
d_u£rfd
, &Şddi¥Ïys->
d_NewMode
);

988 
	`S‘Mode
(&
D_OldMode
, &
D_NewMode
, 
D_æow
, 
iæag
);

989 
	`S‘TTY
(
D_u£rfd
, &
D_NewMode
);

990 ià(
	`fú
(
D_u£rfd
, 
F_SETFL
, 
FNBLOCK
))

991 
	`Msg
(
”ºo
, "Warning: NBLOCK fcntl failed");

993 #ifdeà
PASSWORD


994 ià(
D_u£r
->
u_·sswÜd
 && *D_user->u_password)

995 
	`AskPasswÜd
(&
m
);

998 
	`FšishA‰ach
(&
m
);

1000 
MSG_ERROR
:

1001 
	`Msg
(0, "%s", 
m
.m.
mes§ge
);

1003 
MSG_HANGUP
:

1004 ià(!
wi
)

1005 
	`Hªgup
();

1007 #ifdeà
REMOTE_DETACH


1008 
MSG_DETACH
:

1009 #ifdeà
POW_DETACH


1010 
MSG_POW_DETACH
:

1012 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = 
Ãxt
)

1014 
Ãxt
 = 
di¥Ïy
->
d_Ãxt
;

1015 #ifdeà
POW_DETACH


1016 ià(
m
.
ty³
 =ğ
MSG_POW_DETACH
)

1017 
	`D‘ach
(
D_REMOTE_POWER
);

1020 ià(
m
.
ty³
 =ğ
MSG_DETACH
)

1021 
	`D‘ach
(
D_REMOTE
);

1025 
MSG_COMMAND
:

1026 
	`DoCommªdMsg
(&
m
);

1029 
	`Msg
(0, "Inv®id mes§gÑy³ %d).", 
m
.
ty³
);

1031 
	}
}

1033 #ià
defšed
(
_SEQUENT_
è&& !defšed(
NAMEDPIPE
)

1034 #undeà
cÚÃù


1039 
	$scÚÃù
(
s
, 
§µ
, 
Ën
)

1040 
s
, 
Ën
;

1041 
sockaddr
 *
§µ
;

1043 
sockaddr_un
 *
§p
;

1044 
¡©
 
¡
;

1045 
x
;

1047 
§p
 = (
sockaddr_un
 *)
§µ
;

1048 ià(
	`¡©
(
§p
->
sun_·th
, &
¡
))

1050 
	`chmod
(
§p
->
sun_·th
, 0);

1051 
x
 = 
	`cÚÃù
(
s
, (
sockaddr
 *è
§p
, 
Ën
);

1052 
	`chmod
(
§p
->
sun_·th
, 
¡
.
¡_mode
);

1053  
x
;

1054 
	}
}

1062 
	$chsock
()

1064 
r
, 
euid
 = 
	`g‘euid
();

1065 ià(
euid
 !ğ
»®_uid
)

1067 ià(
	`U£rCÚ‹xt
() <= 0)

1068  
	`U£rStus
();

1070 
r
 = 
	`chmod
(
SockP©h
, 
SOCKMODE
);

1076 ()
	`utimes
(
SockP©h
, 
NULL
);

1078 ià(
euid
 !ğ
»®_uid
)

1079 
	`U£rR‘uº
(
r
);

1080  
r
;

1081 
	}
}

1087 
	$Recov”Sock‘
()

1089 
	`şo£
(
S”v”Sock‘
);

1090 ià(()
	`g‘euid
(è!ğ
»®_uid
)

1092 ià(
	`U£rCÚ‹xt
() > 0)

1093 
	`U£rR‘uº
(
	`uÆšk
(
SockP©h
));

1094 ()
	`U£rStus
();

1097 (è
	`uÆšk
(
SockP©h
);

1099 ià((
S”v”Sock‘
 = 
	`MakeS”v”Sock‘
()) < 0)

1101 
	`evdeq
(&
£rv_»ad
);

1102 
£rv_»ad
.
fd
 = 
S”v”Sock‘
;

1103 
	`ev’q
(&
£rv_»ad
);

1105 
	}
}

1109 
	$FšishA‰ach
(
m
)

1110 
msg
 *
m
;

1112 *
p
;

1113 
pid
;

1114 
noshowwš
;

1115 
wš
 *
wi
;

1117 
	`ASSERT
(
di¥Ïy
);

1118 
pid
 = 
D_u£½id
;

1120 #ià
	`defšed
(
pyr
è|| defšed(
x–os
è|| defšed(
£qu’t
)

1126 
	`debug
("unsetenv(TERMCAP) in case of‡ differenterminal");

1127 
	`un£‹nv
("TERMCAP");

1137 ià(
exŒa_outÿp
)

1138 
	`ä“
(
exŒa_outÿp
);

1139 ià(
exŒa_šÿp
)

1140 
	`ä“
(
exŒa_šÿp
);

1141 
exŒa_šÿp
 = 
exŒa_outÿp
 = 0;

1142 
	`debug2
("Mes§g§y siz(%dx%d)\n", 
m
->m.
©ch
.
cŞumns
, m->m.©ch.
lšes
);

1143 #ifdeà
ETCSCREENRC


1144 #ifdeà
ALLOW_SYSSCREENRC


1145 ià((
p
 = 
	`g‘’v
("SYSSCREENRC")))

1146 
	`S¹Rc
(
p
);

1149 
	`S¹Rc
(
ETCSCREENRC
);

1151 
	`S¹Rc
(
RcFeName
);

1152 ià(
	`In™T”mÿp
(
m
->m.
©ch
.
cŞumns
, m->m.©ch.
lšes
))

1154 
	`F»eDi¥Ïy
();

1155 
	`Kl
(
pid
, 
SIG_BYE
);

1158 
	`MakeDeçuÉCªvas
();

1159 
	`In™T”m
(
m
->m.
©ch
.
ad­tæag
);

1160 ià(
di¥Ïys
->
d_Ãxt
 == 0)

1161 (è
	`chsock
();

1162 
	`sigÇl
(
SIGHUP
, 
SigHup
);

1163 ià(
m
->m.
©ch
.
esc
 !ğ-1 && m->m.©ch.
m‘a_esc
 != -1)

1165 
D_u£r
->
u_Esc
 = 
m
->m.
©ch
.
esc
;

1166 
D_u£r
->
u_M‘aEsc
 = 
m
->m.
©ch
.
m‘a_esc
;

1169 #ifdeà
UTMPOK


1175 
	`RemoveLogšSlÙ
();

1176 ià(
di¥Ïys
->
d_Ãxt
 == 0)

1177 
wi
 = 
wšdows
; wi; w˜ğwi->
w_Ãxt
)

1178 ià(
wi
->
w_±yfd
 >ğ0 && wi->
w_¦Ù
 !ğ(
¦Ù_t
) -1)

1179 
	`S‘Utmp
(
wi
);

1182 
D_fÜe
 = 
NULL
;

1186 
	`debug1
("D_u£r->u_d‘achwš = %d\n", 
D_u£r
->
u_d‘achwš
);

1187 ià(
D_u£r
->
u_d‘achwš
 >= 0)

1188 
fÜe
 = 
wb
[
D_u£r
->
u_d‘achwš
];

1190 
fÜe
 = 0;

1193 ià(
D_u£r
->
u_d‘achÙh”wš
 >= 0)

1194 
D_Ùh”
 = 
wb
[
D_u£r
->
u_d‘achÙh”wš
];

1196 
noshowwš
 = 0;

1197 ià(*
m
->m.
©ch
.
´e£Ëù
)

1199 ià(!
	`¡rcmp
(
m
->m.
©ch
.
´e£Ëù
, "="))

1200 
fÜe
 = 0;

1201 ià(!
	`¡rcmp
(
m
->m.
©ch
.
´e£Ëù
, "-"))

1203 
fÜe
 = 0;

1204 
noshowwš
 = 1;

1207 
fÜe
 = 
	`FšdNiûWšdow
(fÜe, 
m
->m.
©ch
.
´e£Ëù
);

1210 
fÜe
 = 
	`FšdNiûWšdow
(fore, 0);

1211 ià(
fÜe
)

1212 
	`S‘FÜeWšdow
(
fÜe
);

1213 ià(!
noshowwš
)

1215 #ifdeà
MULTIUSER


1216 ià(!
	`AşCheckP”mCmd
(
D_u£r
, 
ACL_EXEC
, &
comms
[
RC_WINDOWLIST
]))

1219 
æay”
 = 
D_fÜecv
->
c_Ïy”
;

1220 
	`di¥Ïy_wli¡
(1, 
WLIST_NUM
);

1221 
noshowwš
 = 1;

1224 
	`Aùiv©e
(0);

1225 
	`Re£tIdË
();

1226 ià(!
D_fÜe
 && !
noshowwš
)

1227 
	`ShowWšdows
(-1);

1228 ià(
di¥Ïys
->
d_Ãxt
 =ğ0 && 
cÚsŞe_wšdow
)

1230 ià(
	`TtyG¿bCÚsŞe
(
cÚsŞe_wšdow
->
w_±yfd
, 1, "reattach") == 0)

1231 
	`Msg
(0, "cÚsŞ% i Ú wšdow %d", 
Ho¡Name
, 
cÚsŞe_wšdow
->
w_numb”
);

1233 
	`debug
("activated...\n");

1235 #ià
	`defšed
(
DEBUG
è&& defšed(
SIG_NODEBUG
)

1236 ià(!
då
)

1238 
	`¦“p
(1);

1239 
	`debug1
("A‰ach” %d mu¡‚Ù debug,‡ whavdebug off.\n", 
pid
);

1240 
	`kl
(
pid
, 
SIG_NODEBUG
);

1243 
	}
}

1246 #ifdeà
PASSWORD


1247 
PasswÜdProûssIÅut
 
__P
((*, ));

1249 
	spwd©a
 {

1250 
	ml
;

1251 
	mbuf
[20 + 1];

1252 
msg
 
	mm
;

1256 
	$AskPasswÜd
(
m
)

1257 
msg
 *
m
;

1259 
pwd©a
 *pwdata;

1260 
	`ASSERT
(
di¥Ïy
);

1261 
pwd©a
 = (pwd©¨*)
	`m®loc
((pwdata));

1262 ià(!
pwd©a
)

1263 
	`Pªic
(0, 
¡ºomem
);

1264 
pwd©a
->
l
 = 0;

1265 
pwd©a
->
m
 = *m;

1266 
D_´oûssšputd©a
 = (*)
pwd©a
;

1267 
D_´oûssšput
 = 
PasswÜdProûssIÅut
;

1268 
	`AddSŒ
("Screen…assword: ");

1269 
	}
}

1272 
	$PasswÜdProûssIÅut
(
ibuf
, 
’
)

1273 *
ibuf
;

1274 
’
;

1276 
pwd©a
 *pwdata;

1277 
c
, 
l
;

1278 *
up
;

1279 
pid
 = 
D_u£½id
;

1281 
pwd©a
 = (pwd©¨*)
D_´oûssšputd©a
;

1282 
l
 = 
pwd©a
->l;

1283 
’
-- > 0)

1285 
c
 = *(*)
ibuf
++;

1286 ià(
c
 == '\r' || c == '\n')

1288 
up
 = 
D_u£r
->
u_·sswÜd
;

1289 
pwd©a
->
buf
[
l
] = 0;

1290 ià(
	`¡ºcmp
(
	`üy±
(
pwd©a
->
buf
, 
up
), up, 
	`¡¾’
(up)))

1293 
	`bz”o
(
pwd©a
->
buf
, (pwdata->buf));

1294 
	`AddSŒ
("\r\nPassword incorrect.\r\n");

1295 
D_´oûssšputd©a
 = 0;

1296 
	`F»eDi¥Ïy
();

1297 
	`Msg
(0, "IÎeg®„—‰ach‡‰em± from”mš® %s.", 
pwd©a
->
m
.
m_‰y
);

1298 
	`ä“
(
pwd©a
);

1299 
	`Kl
(
pid
, 
SIG_BYE
);

1303 
	`bz”o
(
pwd©a
->
buf
, (pwdata->buf));

1304 
	`AddSŒ
("\r\n");

1305 
D_´oûssšputd©a
 = 0;

1306 
D_´oûssšput
 = 
ProûssIÅut
;

1307 
	`FšishA‰ach
(&
pwd©a
->
m
);

1308 
	`ä“
(
pwd©a
);

1311 ià(
c
 =ğ
	`CŒl
('c'))

1313 
	`AddSŒ
("\r\n");

1314 
	`F»eDi¥Ïy
();

1315 
	`Kl
(
pid
, 
SIG_BYE
);

1318 ià(
c
 == '\b' || c == 0177)

1320 ià(
l
 > 0)

1321 
l
--;

1324 ià(
c
 =ğ
	`CŒl
('u'))

1326 
l
 = 0;

1329 ià(
l
 < ()(
pwd©a
->
buf
) - 1)

1330 
pwd©a
->
buf
[
l
++] = 
c
;

1332 
pwd©a
->
l
 =†;

1333 
	}
}

1337 
	$DoCommªdMsg
(
mp
)

1338 
msg
 *
mp
;

1340 *
¬gs
[
MAXARGS
];

1341 
¬gl
[
MAXARGS
];

1342 
n
, *
Í
;

1343 **
µ
 = 
¬gs
, *
p
 = 
mp
->
m
.
commªd
.
cmd
;

1344 
aşu£r
 *
u£r
;

1345 #ifdeà
MULTIUSER


1346 
aşu£r
 *
EfãùiveAşU£r
;

1348 
aşu£r
 *
u£rs
;

1351 
Í
 = 
¬gl
;

1352 
n
 = 
mp
->
m
.
commªd
.
Çrgs
;

1353 ià(
n
 > 
MAXARGS
 - 1)

1354 
n
 = 
MAXARGS
 - 1;

1355 ; 
n
 > 0;‚--)

1357 *
µ
++ = 
p
;

1358 *
Í
 = 
	`¡¾’
(
p
);

1359 
p
 +ğ*
Í
++ + 1;

1361 *
µ
 = 0;

1362 #ifdeà
MULTIUSER


1363 
u£r
 = *
	`FšdU£rPŒ
(
mp
->
m
.
©ch
.
au£r
);

1364 ià(
u£r
 == 0)

1366 
	`Msg
(0, "UnknowÀu£¸% Œ›dØ£nd‡ commªd!", 
mp
->
m
.
©ch
.
au£r
);

1370 
u£r
 = 
u£rs
;

1372 #ifdeà
PASSWORD


1373 ià(
u£r
->
u_·sswÜd
 && *user->u_password)

1375 
	`Msg
(0, "U£¸% ha ¨·sswÜd, cªnÙ u£ -X o±iÚ.", 
mp
->
m
.
©ch
.
au£r
);

1379 ià(!
di¥Ïy
)

1380 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

1381 ià(
D_u£r
 =ğ
u£r
)

1383 
fÜe
 = 
wšdows
; fÜe; fÜğfÜe->
w_Ãxt
)

1384 ià(!
	`TTYCMP
(
mp
->
m_‰y
, 
fÜe
->
w_‰y
))

1386 ià(!
di¥Ïy
)

1387 
di¥Ïy
 = 
fÜe
->
w_Ïy”
.
l_cvli¡
 ? fÜe->w_Ïy”.l_cvli¡->
c_di¥Ïy
 : 0;

1390 ià(!
di¥Ïy
)

1391 
di¥Ïy
 = 
di¥Ïys
;

1392 ià(*
mp
->
m
.
commªd
.
´e£Ëù
)

1394 
i
 = -1;

1395 ià(
	`¡rcmp
(
mp
->
m
.
commªd
.
´e£Ëù
, "-"))

1396 
i
 = 
	`WšdowByNoN
(
mp
->
m
.
commªd
.
´e£Ëù
);

1397 
fÜe
 = 
i
 >ğ0 ? 
wb
[i] : 0;

1399 ià(!
fÜe
)

1401 ià(
di¥Ïy
 && 
D_u£r
 =ğ
u£r
)

1402 
fÜe
 = 
	`Lay”2Wšdow
(
di¥Ïy
->
d_fÜecv
->
c_Ïy”
);

1403 ià(!
fÜe
)

1405 
fÜe
 = 
u£r
->
u_d‘achwš
 >ğ0 ? 
wb
[user->u_detachwin] : 0;

1406 
fÜe
 = 
	`FšdNiûWšdow
(fore, 0);

1409 #ifdeà
MULTIUSER


1410 
EfãùiveAşU£r
 = 
u£r
;

1412 ià(*
¬gs
)

1414 *
Şdrúame
 = 
rc_Çme
;

1415 
rc_Çme
 = "-X";

1416 
	`debug3
("RuÂšg commªd oÀdi¥Ïy %x wšdow %x (%d)\n", 
di¥Ïy
, 
fÜe
, fÜ? fÜe->
w_numb”
 : -1);

1417 
æay”
 = 
fÜe
 ? &fÜe->
w_Ïy”
 : 0;

1418 ià(
fÜe
 && fÜe->
w_§v–ay”
 && (fÜe->
w_blocked
 || fÜe->w_§v–ay”->
l_cvli¡
 == 0))

1419 
æay”
 = 
fÜe
->
w_§v–ay”
;

1420 
	`DoCommªd
(
¬gs
, 
¬gl
);

1421 
rc_Çme
 = 
Şdrúame
;

1423 #ifdeà
MULTIUSER


1424 
EfãùiveAşU£r
 = 0;

1426 
	}
}

	@teln.c

24 
	~<sys/ty³s.h
>

25 
	~<sys/sock‘.h
>

26 
	~<fú.h
>

27 
	~<Ãtdb.h
>

29 
	~"cÚfig.h
"

31 #ifdeà
BUILTIN_TELNET


33 
	~"sü“n.h
"

34 
	~"ex‹º.h
"

36 
wš
 *
fÜe
;

37 
Ïy”
 *
æay”
;

38 
visu®_b–l
;

39 
sü“Á”m
[];

41 
T–R•ly
 
__P
((
wš
 *, *, ));

42 
T–Docmd
 
__P
((
wš
 *, , ));

43 
T–Dosub
 
__P
((
wš
 *));

45 
	#TEL_DEFPORT
 23

	)

46 
	#TEL_CONNECTING
 (-2)

	)

48 
	#TC_IAC
 255

	)

49 
	#TC_DONT
 254

	)

50 
	#TC_DO
 253

	)

51 
	#TC_WONT
 252

	)

52 
	#TC_WILL
 251

	)

53 
	#TC_SB
 250

	)

54 
	#TC_BREAK
 243

	)

55 
	#TC_SE
 240

	)

57 
	#TC_S
 "S b swWdDc"

	)

59 
	#TO_BINARY
 0

	)

60 
	#TO_ECHO
 1

	)

61 
	#TO_SGA
 3

	)

62 
	#TO_TM
 6

	)

63 
	#TO_TTYPE
 24

	)

64 
	#TO_NAWS
 31

	)

65 
	#TO_TSPEED
 32

	)

66 
	#TO_LFLOW
 33

	)

67 
	#TO_XDISPLOC
 35

	)

68 
	#TO_NEWENV
 39

	)

70 
	#TO_S
 "bø wsàxE E"

	)

73 
	gŠ_š™
[] = {

74 
TC_IAC
, 
TC_DO
, 
TO_SGA
,

75 
TC_IAC
, 
TC_WILL
, 
TO_TTYPE
,

76 
TC_IAC
, 
TC_WILL
, 
TO_NAWS
,

77 
TC_IAC
, 
TC_WILL
, 
TO_LFLOW
,

81 
	$‹l_cÚÃv_â
(
ev
, 
d©a
)

82 
ev’t
 *
ev
;

83 *
d©a
;

85 
wš
 *
p
 = (wš *)
d©a
;

86 ià(
	`cÚÃù
(
p
->
w_±yfd
, (
sockaddr
 *)&p->
w_‹l§
, Õ->w_‹l§)è&& 
”ºo
 !ğ
EISCONN
)

88 
buf
[1024];

89 
buf
[0] = ' ';

90 
	`¡ºıy
(
buf
 + 1, 
	`¡»¼Ü
(
”ºo
), (buf) - 2);

91 
buf
[(buf) - 1] = 0;

92 
	`Wr™eSŒšg
(
p
, 
buf
, 
	`¡¾’
(buf));

93 
	`WšdowD›d
(
p
);

96 
	`Wr™eSŒšg
(
p
, "connected.\r\n", 12);

97 
	`evdeq
(&
p
->
w_‹lcÚÃv
);

98 
p
->
w_‹l¡©e
 = 0;

99 
	}
}

102 
	$T–O³n
(
¬gs
)

103 **
¬gs
;

105 
fd
;

106 
Ú
 = 1;

108 ià((
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_STREAM
, 
IPPROTO_TCP
)) == -1)

110 
	`Msg
(
”ºo
, "TelOpen: socket");

113 ià(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_OOBINLINE
, (*)&
Ú
, (on)))

114 
	`Msg
(
”ºo
, "TelOpen: setsockopt SO_OOBINLINE");

115  
fd
;

116 
	}
}

119 
	$T–CÚÃù
(
p
)

120 
wš
 *
p
;

122 
pÜt
 = 
TEL_DEFPORT
;

123 
ho¡’t
 *
hp
;

124 **
¬gs
;

125 
buf
[256];

127 
¬gs
 = 
p
->
w_cmd¬gs
 + 1;

129 ià(!*
¬gs
)

131 
	`Msg
(0, "Usage: screen //telnet host [port]");

134 ià(
¬gs
[1])

135 
pÜt
 = 
	`©oi
(
¬gs
[1]);

136 
p
->
w_‹l§
.
sš_çmy
 = 
AF_INET
;

137 if((
p
->
w_‹l§
.
sš_addr
.
s_addr
 = 
	`š‘_addr
(*
¬gs
)) == -1)

139 ià((
hp
 = 
	`g‘ho¡byÇme
(*
¬gs
)è=ğ
NULL
)

141 
	`Msg
(0, "unknowÀho¡: %s", *
¬gs
);

144 ià(
hp
->
h_Ëngth
 !ğ(
p
->
w_‹l§
.
sš_addr
.
s_addr
è|| hp->
h_add¹y³
 !ğ
AF_INET
)

146 
	`Msg
(0, "Bad‡dd»s ty³ fÜ %s", 
hp
->
h_Çme
);

149 
	`bcİy
((*)
hp
->
h_addr
,(*)&
p
->
w_‹l§
.
sš_addr
.
s_addr
, hp->
h_Ëngth
);

150 
p
->
w_‹l§
.
sš_çmy
 = 
hp
->
h_add¹y³
;

152 
p
->
w_‹l§
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

153 ià(
pÜt
 !ğ
TEL_DEFPORT
)

154 
	`¥rštf
(
buf
, "Tryšg % %d...", 
	`š‘_Áß
(
p
->
w_‹l§
.
sš_addr
), 
pÜt
);

156 
	`¥rštf
(
buf
, "Tryšg %s...", 
	`š‘_Áß
(
p
->
w_‹l§
.
sš_addr
));

157 
	`Wr™eSŒšg
(
p
, 
buf
, 
	`¡¾’
(buf));

158 ià(
	`cÚÃù
(
p
->
w_±yfd
, (
sockaddr
 *)&p->
w_‹l§
, (p->w_telsa)))

160 ià(
”ºo
 =ğ
EINPROGRESS
)

162 
p
->
w_‹l¡©e
 = 
TEL_CONNECTING
;

163 
p
->
w_‹lcÚÃv
.
fd
 =…->
w_±yfd
;

164 
p
->
w_‹lcÚÃv
.
hªdËr
 = 
‹l_cÚÃv_â
;

165 
p
->
w_‹lcÚÃv
.
d©a
 = (*)p;

166 
p
->
w_‹lcÚÃv
.
ty³
 = 
EV_WRITE
;

167 
p
->
w_‹lcÚÃv
.
´i
 = 1;

168 
	`debug
("telnet connect in…rogress...\n");

169 
	`ev’q
(&
p
->
w_‹lcÚÃv
);

173 
	`Msg
(
”ºo
, "TelOpen: connect");

178 
	`Wr™eSŒšg
(
p
, "connected.\r\n", 12);

179 ià(
pÜt
 =ğ
TEL_DEFPORT
)

180 
	`T–R•ly
(
p
, (*)
Š_š™
, (tn_init));

182 
	}
}

185 
	$T–I¦še
(
p
)

186 
wš
 *
p
;

188  !
fÜe
->
w_‹Ìİts
[
TO_SGA
];

189 
	}
}

192 
	$T–ProûssLše
(
buåp
, 
ËÅ
)

193 **
buåp
;

194 *
ËÅ
;

196 
echo
 = !
fÜe
->
w_‹Ìİts
[
TO_ECHO
];

197 
c
;

198 *
tb
;

199 

;

201 *
buf
 = *
buåp
;

202 
l
 = *
ËÅ
;

203 
l
--)

205 
c
 = *(*)
buf
++;

206 ià(
fÜe
->
w_‹lbuæ
 + 2 >ğ
IOSIZE
)

208 
	`WB–l
(
fÜe
, 
visu®_b–l
);

211 ià(
c
 == '\r')

213 ià(
echo
)

214 
	`Wr™eSŒšg
(
fÜe
, "\r\n", 2);

215 
fÜe
->
w_‹lbuf
[fÜe->
w_‹lbuæ
++] = '\r';

216 
fÜe
->
w_‹lbuf
[fÜe->
w_‹lbuæ
++] = '\n';

217 
tb
 = 
fÜe
->
w_‹lbuf
;

218 

 = 
fÜe
->
w_‹lbuæ
;

219 
	`LayProûss
(&
tb
, &

);

220 
fÜe
->
w_‹lbuæ
 = 0;

223 ià(
c
 =ğ'\b' && 
fÜe
->
w_‹lbuæ
 > 0)

225 ià(
echo
)

227 
	`Wr™eSŒšg
(
fÜe
, (*)&
c
, 1);

228 
	`Wr™eSŒšg
(
fÜe
, " ", 1);

229 
	`Wr™eSŒšg
(
fÜe
, (*)&
c
, 1);

231 
fÜe
->
w_‹lbuæ
--;

233 ià((
c
 >= 0x20 && c <= 0x7e) || c >= 0xa0)

235 ià(
echo
)

236 
	`Wr™eSŒšg
(
fÜe
, (*)&
c
, 1);

237 
fÜe
->
w_‹lbuf
[fÜe->
w_‹lbuæ
++] = 
c
;

240 *
ËÅ
 = 0;

241 
	}
}

244 
	$DoT–Ãt
(
buf
, 
ËÅ
, 
f
)

245 *
buf
;

246 *
ËÅ
;

247 
f
;

249 
echo
 = !
fÜe
->
w_‹Ìİts
[
TO_ECHO
];

250 
cmode
 = 
fÜe
->
w_‹Ìİts
[
TO_SGA
];

251 
bš
 = 
fÜe
->
w_‹Ìİts
[
TO_BINARY
];

252 *
p
 = 
buf
, *
sbuf
;

253 
Œunc
 = 0;

254 
c
;

255 
l
 = *
ËÅ
;

257 
sbuf
 = 
p
;

258 
l
-- > 0)

260 
c
 = *(*)
p
++;

261 ià(
c
 =ğ
TC_IAC
 || (ø=ğ'\r' && (
l
 ==0 || *
p
 !ğ'\n'è&& 
cmode
 && !
bš
))

263 ià(
cmode
 && 
echo
)

265 
	`Wr™eSŒšg
(
fÜe
, 
sbuf
, 
p
 - sbuf);

266 
sbuf
 = 
p
;

268 ià(
f
-- <= 0)

270 
Œunc
++;

271 
l
--;

273 ià(
l
 < 0)

275 
p
--;

278 ià(
l
)

279 
	`bcİy
(
p
,… + 1, 
l
);

280 ià(
c
 =ğ
TC_IAC
)

281 *
p
++ = 
c
;

282 ià(
c
 == '\r')

283 *
p
++ = 0;

284 ià(
c
 == '\n')

286 
p
[-1] = '\r';

287 *
p
++ = '\n';

291 *
ËÅ
 = 
p
 - 
buf
;

292  
Œunc
;

293 
	}
}

297 
	$T–In
(
p
, 
buf
, 
Ën
, 
ä“
)

298 
wš
 *
p
;

299 *
buf
;

300 
Ën
;

301 
ä“
;

303 *
½
, *
wp
;

304 
c
;

306 
½
 = 
wp
 = 
buf
;

307 
Ën
-- > 0)

309 
c
 = *(*)
½
++;

311 ià(
p
->
w_‹l¡©e
 >ğ
TC_WILL
 &&…->w_‹l¡©<ğ
TC_DONT
)

313 
	`T–Docmd
(
p
,…->
w_‹l¡©e
, 
c
);

314 
p
->
w_‹l¡©e
 = 0;

317 ià(
p
->
w_‹l¡©e
 =ğ
TC_SB
 ||…->w_‹l¡©=ğ
TC_SE
)

319 ià(
p
->
w_‹l¡©e
 =ğ
TC_SE
 && 
c
 =ğ
TC_IAC
)

320 
p
->
w_‹lsubidx
--;

321 ià(
p
->
w_‹l¡©e
 =ğ
TC_SE
 && 
c
 == TC_SE)

323 
p
->
w_‹lsubidx
--;

324 
	`T–Dosub
(
p
);

325 
p
->
w_‹l¡©e
 = 0;

328 ià(
p
->
w_‹l¡©e
 =ğ
TC_SB
 && 
c
 =ğ
TC_IAC
)

329 
p
->
w_‹l¡©e
 = 
TC_SE
;

331 
p
->
w_‹l¡©e
 = 
TC_SB
;

332 
p
->
w_‹lsubbuf
[p->
w_‹lsubidx
] = 
c
;

333 ià(
p
->
w_‹lsubidx
 < Õ->
w_‹lsubbuf
) - 1)

334 
p
->
w_‹lsubidx
++;

337 ià(
p
->
w_‹l¡©e
 =ğ
TC_IAC
)

339 ià((
c
 >ğ
TC_WILL
 && c <ğ
TC_DONT
è|| c =ğ
TC_SB
)

341 
p
->
w_‹lsubidx
 = 0;

342 
p
->
w_‹l¡©e
 = 
c
;

345 
p
->
w_‹l¡©e
 = 0;

346 ià(
c
 !ğ
TC_IAC
)

349 ià(
c
 =ğ
TC_IAC
)

351 
p
->
w_‹l¡©e
 = 
c
;

354 ià(
p
->
w_‹l¡©e
 == '\r')

356 
p
->
w_‹l¡©e
 = 0;

357 ià(
c
 == 0)

360 ià(
c
 =ğ'\n' && !
p
->
w_‹Ìİts
[
TO_SGA
])

363 ià(
wp
 + 1 =ğ
½
)

365 ià(
ä“
-- > 0)

367 ià(
Ën
)

368 
	`bcİy
(
½
,„°+ 1, 
Ën
);

369 
½
++;

370 *
wp
++ = '\r';

374 *
wp
++ = '\r';

376 ià(
c
 == '\r')

377 
p
->
w_‹l¡©e
 = 
c
;

378 *
wp
++ = 
c
;

380  
wp
 - 
buf
;

381 
	}
}

384 
	$T–R•ly
(
p
, 
¡r
, 
Ën
)

385 
wš
 *
p
;

386 *
¡r
;

387 
Ën
;

389 ià(
Ën
 <= 0)

391 ià(
p
->
w_šËn
 + 
Ën
 > 
IOSIZE
)

393 
	`Msg
(0, "Warning:elnet…rotocol overrun!");

396 
	`bcİy
(
¡r
, 
p
->
w_šbuf
 +…->
w_šËn
, 
Ën
);

397 
p
->
w_šËn
 +ğ
Ën
;

398 
	}
}

401 
	$T–Docmd
(
p
, 
cmd
, 
İt
)

402 
wš
 *
p
;

403 
cmd
, 
İt
;

405 
b
[3];

406 
»¶
 = 0;

408 ià(
cmd
 =ğ
TC_WONT
)

409 
	`debug2
("[WONT %ø%d]\n", 
TO_S
[
İt
], opt);

410 ià(
cmd
 =ğ
TC_WILL
)

411 
	`debug2
("[WILL %ø%d]\n", 
TO_S
[
İt
], opt);

412 ià(
cmd
 =ğ
TC_DONT
)

413 
	`debug2
("[DONT %ø%d]\n", 
TO_S
[
İt
], opt);

414 ià(
cmd
 =ğ
TC_DO
)

415 
	`debug2
("[DO %ø%d]\n", 
TO_S
[
İt
], opt);

417 
cmd
)

419 
TC_WILL
:

420 ià(
p
->
w_‹Ìİts
[
İt
] || o± =ğ
TO_TM
)

422 
»¶
 = 
TC_DONT
;

423 ià(
İt
 =ğ
TO_ECHO
 || o± =ğ
TO_SGA
 || o± =ğ
TO_BINARY
)

425 
p
->
w_‹Ìİts
[
İt
] = 1;

427 
»¶
 = 
TC_DO
;

430 
TC_WONT
:

431 ià(!
p
->
w_‹Ìİts
[
İt
] || o± =ğ
TO_TM
)

433 
»¶
 = 
TC_DONT
;

435 ià(
İt
 =ğ
TO_ECHO
 || o± =ğ
TO_SGA
)

436 
	`£tcÚ
();

438 
p
->
w_‹Ìİts
[
İt
] = 0;

440 
TC_DO
:

441 ià(
p
->
w_‹lmİts
[
İt
])

443 
»¶
 = 
TC_WONT
;

444 ià(
İt
 =ğ
TO_TTYPE
 || o± =ğ
TO_SGA
 || o± =ğ
TO_BINARY
 || o± =ğ
TO_NAWS
 || o± =ğ
TO_TM
 || o± =ğ
TO_LFLOW
)

446 
»¶
 = 
TC_WILL
;

447 
p
->
w_‹lmİts
[
İt
] = 1;

449 
p
->
w_‹lmİts
[
TO_TM
] = 0;

451 
TC_DONT
:

452 ià(!
p
->
w_‹lmİts
[
İt
])

454 
»¶
 = 
TC_WONT
;

455 
p
->
w_‹lmİts
[
İt
] = 0;

458 
b
[0] = 
TC_IAC
;

459 
b
[1] = 
»¶
;

460 
b
[2] = 
İt
;

461 
	`T–R•ly
(
p
, (*)
b
, 3);

462 ià(
cmd
 =ğ
TC_DO
 && 
İt
 =ğ
TO_NAWS
)

463 
	`T–WšdowSize
(
p
);

464 
	}
}

468 
	$T–Dosub
(
p
)

469 
wš
 *
p
;

471 
Œ•l
[20 + 6 + 1];

472 
l
;

474 
p
->
w_‹lsubbuf
[0])

476 
TO_TTYPE
:

477 ià(
p
->
w_‹lsubidx
 !ğ2 ||…->
w_‹lsubbuf
[1] != 1)

479 
l
 = 
	`¡¾’
(
sü“Á”m
);

480 ià(
l
 >= 20)

482 
	`¥rštf
(
Œ•l
, "%c%c%c%c%s%c%c", 
TC_IAC
, 
TC_SB
, 
TO_TTYPE
, 0, 
sü“Á”m
, TC_IAC, 
TC_SE
);

483 
	`T–R•ly
(
p
, 
Œ•l
, 
l
 + 6);

485 
TO_LFLOW
:

486 ià(
p
->
w_‹lsubidx
 != 2)

488 
	`debug1
("[FLOW %d]\r\n", 
p
->
w_‹lsubbuf
[1]);

493 
	}
}

496 
	$T–B»ak
(
p
)

497 
wš
 *
p
;

499 
‹l_b»ak
[] = { 
TC_IAC
, 
TC_BREAK
 };

500 
	`T–R•ly
(
p
, (*)
‹l_b»ak
, 2);

501 
	}
}

504 
	$T–WšdowSize
(
p
)

505 
wš
 *
p
;

507 
s
[20], 
Œ•l
[20], *
t
;

508 
i
;

510 
	`debug2
("T–WšdowSiz%d %d\n", 
p
->
w_width
,…->
w_height
);

511 ià(
p
->
w_width
 =ğ0 ||…->
w_height
 =ğ0 || !p->
w_‹lmİts
[
TO_NAWS
])

513 
	`¥rštf
(
s
, "%c%c%c%c%c%c%c%c%c", 
TC_SB
, TC_SB, 
TO_NAWS
, 
p
->
w_width
 / 256,…->w_width & 255,…->
w_height
 / 256,…->w_heighˆ& 255, 
TC_SE
, TC_SE);

514 
t
 = 
Œ•l
;

515 
i
 = 0; i < 9; i++)

516 ià(()(*
t
++ = 
s
[
i
]è=ğ
TC_IAC
)

517 *
t
++ = 
TC_IAC
;

518 
Œ•l
[0] = 
TC_IAC
;

519 
t
[-2] = 
TC_IAC
;

520 
	`debug
(" - sending");

521 
i
 = 0; 
Œ•l
 + i < 
t
; i++)

522 
	`debug1
(" %02x", ()
Œ•l
[
i
]);

523 
	`debug
("\n");

524 
	`T–R•ly
(
p
, 
Œ•l
, 
t
 -repl);

525 
	}
}

527 
	gtc_s
[] = 
TC_S
;

528 
	gto_s
[] = 
TO_S
;

531 
	$T–Stus
(
p
, 
buf
, 
l
)

532 
wš
 *
p
;

533 *
buf
;

534 
l
;

536 
i
;

538 *
buf
++ = '[';

539 
i
 = 0; 
to_s
[i]; i++)

541 ià(
to_s
[
i
] =ğ' ' || 
p
->
w_‹lmİts
[i] == 0)

543 *
buf
++ = 
to_s
[
i
];

545 *
buf
++ = ':';

546 
i
 = 0; 
to_s
[i]; i++)

548 ià(
to_s
[
i
] =ğ' ' || 
p
->
w_‹Ìİts
[i] == 0)

550 *
buf
++ = 
to_s
[
i
];

552 ià(
p
->
w_‹l¡©e
 =ğ
TEL_CONNECTING
)

553 
buf
[-1] = 'C';

554 ià(
p
->
w_‹l¡©e
 &&…->w_telstate != '\r')

556 *
buf
++ = ':';

557 *
buf
++ = 
tc_s
[
p
->
w_‹l¡©e
 - 
TC_SE
];

559 *
buf
++ = ']';

560 *
buf
 = 0;

562 
	}
}

	@term.c

24 
	~"‹rm.h
"

26 
	#KMAPDEF
(
s
)

	)

27 
	#KMAPADEF
(
s
)

	)

28 
	#KMAPMDEF
(
s
)

	)

30 
‹rm
 
	g‹rm
[
T_N
] =

33 { "li", 
T_NUM
 },

34 { "co", 
T_NUM
 },

37 { "hc", 
T_FLG
 },

38 { "os", 
T_FLG
 },

39 { "ns", 
T_FLG
 },

41 { "cm", 
T_STR
 },

42 { "ho", 
T_STR
 },

43 { "ü", 
T_STR
 },

44 { "up", 
T_STR
 },

45 { "UP", 
T_STR
 },

46 { "do", 
T_STR
 },

47 { "DO", 
T_STR
 },

48 { "bs", 
T_FLG
 },

49 { "bc", 
T_STR
 },

50 { "Ë", 
T_STR
 },

51 { "LE", 
T_STR
 },

52 { "nd", 
T_STR
 },

53 { "RI", 
T_STR
 },

56 { "cs", 
T_STR
 },

57 { "Æ", 
T_STR
 },

58 { "sf", 
T_STR
 },

59 { "¤", 
T_STR
 },

60 { "®", 
T_STR
 },

61 { "AL", 
T_STR
 },

62 { "dl", 
T_STR
 },

63 { "DL", 
T_STR
 },

66 { "š", 
T_FLG
 },

67 { "im", 
T_STR
 },

68 { "ei", 
T_STR
 },

69 { "ic", 
T_STR
 },

70 { "IC", 
T_STR
 },

71 { "dc", 
T_STR
 },

72 { "DC", 
T_STR
 },

75 { "ut", 
T_FLG
 },

76 { "ş", 
T_STR
 },

77 { "cd", 
T_STR
 },

78 { "CD", 
T_STR
 },

79 { "û", 
T_STR
 },

80 { "cb", 
T_STR
 },

83 { "is", 
T_STR
 },

84 { "ti", 
T_STR
 },

85 { "‹", 
T_STR
 },

88 { "bl", 
T_STR
 },

89 { "vb", 
T_STR
 },

92 { "WS", 
T_STR
 },

93 { "Z0", 
T_STR
 },

94 { "Z1", 
T_STR
 },

98 { "mh", 
T_STR
 },

99 { "us", 
T_STR
 },

100 { "md", 
T_STR
 },

101 { "mr", 
T_STR
 },

102 { "so", 
T_STR
 },

103 { "mb", 
T_STR
 },

104 { "ue", 
T_STR
 },

105 { "£", 
T_STR
 },

106 { "me", 
T_STR
 },

107 { "ms", 
T_FLG
 },

108 { "sg", 
T_NUM
 },

109 { "ug", 
T_NUM
 },

110 { "§", 
T_STR
 },

113 { "AF", 
T_STR
 },

114 { "AB", 
T_STR
 },

115 { "Sf", 
T_STR
 },

116 { "Sb", 
T_STR
 },

117 { "İ", 
T_STR
 },

118 { "Co", 
T_NUM
 },

119 { "be", 
T_FLG
 },

120 { "AX", 
T_FLG
 },

121 { "C8", 
T_FLG
 },

124 { "ks", 
T_STR
 },

125 { "ke", 
T_STR
 },

126 { "CS", 
T_STR
 },

127 { "CE", 
T_STR
 },

130 { "po", 
T_STR
 },

131 { "pf", 
T_STR
 },

134 { "hs", 
T_FLG
 },

135 { "ws", 
T_NUM
 },

136 { "ts", 
T_STR
 },

137 { "fs", 
T_STR
 },

138 { "ds", 
T_STR
 },

141 { "vi", 
T_STR
 },

142 { "vs", 
T_STR
 },

143 { "ve", 
T_STR
 },

146 { "am", 
T_FLG
 },

147 { "xv", 
T_FLG
 },

148 { "xn", 
T_FLG
 },

149 { "OP", 
T_FLG
 },

150 { "LP", 
T_FLG
 },

153 { "NF", 
T_FLG
 },

154 { "nx", 
T_FLG
 },

155 { "AN", 
T_FLG
 },

156 { "OL", 
T_NUM
 },

157 { "KJ", 
T_STR
 },

158 { "VR", 
T_STR
 },

159 { "VN", 
T_STR
 },

160 { "TF", 
T_FLG
 },

161 { "XT", 
T_FLG
 },

164 { "G0", 
T_FLG
 },

165 { "S0", 
T_STR
 },

166 { "E0", 
T_STR
 },

167 { "C0", 
T_STR
 },

168 { "as", 
T_STR
 },

169 { "«", 
T_STR
 },

170 { "ac", 
T_STR
 },

171 { "eA", 
T_STR
 },

172 { "XC", 
T_STR
 },

177 { "k0", 
T_STR
 }, 
KMAPDEF
("\033[10~")

178 { "k1", 
T_STR
 }, 
KMAPDEF
("\033OP")

179 { "k2", 
T_STR
 }, 
KMAPDEF
("\033OQ")

180 { "k3", 
T_STR
 }, 
KMAPDEF
("\033OR")

181 { "k4", 
T_STR
 }, 
KMAPDEF
("\033OS")

182 { "k5", 
T_STR
 }, 
KMAPDEF
("\033[15~")

183 { "k6", 
T_STR
 }, 
KMAPDEF
("\033[17~")

184 { "k7", 
T_STR
 }, 
KMAPDEF
("\033[18~")

185 { "k8", 
T_STR
 }, 
KMAPDEF
("\033[19~")

186 { "k9", 
T_STR
 }, 
KMAPDEF
("\033[20~")

187 { "k;", 
T_STR
 }, 
KMAPDEF
("\033[21~")

188 { "F1", 
T_STR
 }, 
KMAPDEF
("\033[23~")

189 { "F2", 
T_STR
 }, 
KMAPDEF
("\033[24~")

191 { "F3", 
T_STR
 },

192 { "F4", 
T_STR
 },

193 { "F5", 
T_STR
 },

194 { "F6", 
T_STR
 },

195 { "F7", 
T_STR
 },

196 { "F8", 
T_STR
 },

197 { "F9", 
T_STR
 },

198 { "FA", 
T_STR
 },

200 { "kb", 
T_STR
 },

201 { "K1", 
T_STR
 },

202 { "K2", 
T_STR
 },

203 { "K3", 
T_STR
 },

204 { "K4", 
T_STR
 },

205 { "K5", 
T_STR
 },

207 { "kA", 
T_STR
 },

208 { "ka", 
T_STR
 },

210 { "kB", 
T_STR
 },

211 { "kC", 
T_STR
 },

212 { "kE", 
T_STR
 },

213 { "kF", 
T_STR
 }, 
KMAPMDEF
("\004")

214 { "kL", 
T_STR
 },

215 { "kM", 
T_STR
 },

216 { "kR", 
T_STR
 }, 
KMAPMDEF
("\025")

217 { "kS", 
T_STR
 },

218 { "kT", 
T_STR
 },

219 { "kt", 
T_STR
 },

220 { "*4", 
T_STR
 },

221 { "*7", 
T_STR
 },

222 { "#2", 
T_STR
 },

223 { "#3", 
T_STR
 },

224 { "#4", 
T_STR
 },

225 { "%c", 
T_STR
 },

226 { "%e", 
T_STR
 },

227 { "%i", 
T_STR
 },

231 { "kh", 
T_STR
 }, 
KMAPDEF
("\033[1~"è
KMAPMDEF
("\201")

232 { "@1", 
T_STR
 },

233 { "kH", 
T_STR
 }, 
KMAPDEF
("\033[4~"è
KMAPMDEF
("\205")

234 { "@7", 
T_STR
 },

235 { "kN", 
T_STR
 }, 
KMAPDEF
("\033[6~"è
KMAPMDEF
("\006")

236 { "kP", 
T_STR
 }, 
KMAPDEF
("\033[5~"è
KMAPMDEF
("\002")

237 { "kI", 
T_STR
 }, 
KMAPDEF
("\033[2~")

239 { "kD", 
T_STR
 }, 
KMAPDEF
("\033[3~")

243 { "ku", 
T_STR
 }, 
KMAPDEF
("\033[A"è
KMAPADEF
("\033OA"è
KMAPMDEF
("\220")

244 { "kd", 
T_STR
 }, 
KMAPDEF
("\033[B"è
KMAPADEF
("\033OB"è
KMAPMDEF
("\216")

245 { "kr", 
T_STR
 }, 
KMAPDEF
("\033[C"è
KMAPADEF
("\033OC"è
KMAPMDEF
("\206")

246 { "kl", 
T_STR
 }, 
KMAPDEF
("\033[D"è
KMAPADEF
("\033OD"è
KMAPMDEF
("\202")

248 { "f0", 
T_STR
 }, 
KMAPDEF
("0"è
KMAPADEF
("\033Op")

249 { "f1", 
T_STR
 }, 
KMAPDEF
("1"è
KMAPADEF
("\033Oq")

250 { "f2", 
T_STR
 }, 
KMAPDEF
("2"è
KMAPADEF
("\033Or")

251 { "f3", 
T_STR
 }, 
KMAPDEF
("3"è
KMAPADEF
("\033Os")

252 { "f4", 
T_STR
 }, 
KMAPDEF
("4"è
KMAPADEF
("\033Ot")

253 { "f5", 
T_STR
 }, 
KMAPDEF
("5"è
KMAPADEF
("\033Ou")

254 { "f6", 
T_STR
 }, 
KMAPDEF
("6"è
KMAPADEF
("\033Ov")

255 { "f7", 
T_STR
 }, 
KMAPDEF
("7"è
KMAPADEF
("\033Ow")

256 { "f8", 
T_STR
 }, 
KMAPDEF
("8"è
KMAPADEF
("\033Ox")

257 { "f9", 
T_STR
 }, 
KMAPDEF
("9"è
KMAPADEF
("\033Oy")

258 { "f+", 
T_STR
 }, 
KMAPDEF
("+"è
KMAPADEF
("\033Ok")

259 { "f-", 
T_STR
 }, 
KMAPDEF
("-"è
KMAPADEF
("\033Om")

260 { "f*", 
T_STR
 }, 
KMAPDEF
("*"è
KMAPADEF
("\033Oj")

261 { "f/", 
T_STR
 }, 
KMAPDEF
("/"è
KMAPADEF
("\033Oo")

262 { "fq", 
T_STR
 }, 
KMAPDEF
("="è
KMAPADEF
("\033OX")

263 { "f.", 
T_STR
 }, 
KMAPDEF
("."è
KMAPADEF
("\033On")

264 { "f,", 
T_STR
 }, 
KMAPDEF
(","è
KMAPADEF
("\033Ol")

265 { "ã", 
T_STR
 }, 
KMAPDEF
("\015"è
KMAPADEF
("\033OM")

268 { "km", 
T_FLG
 },

269 { "ko", 
T_STR
 },

270 { "l0", 
T_STR
 },

271 { "l1", 
T_STR
 },

272 { "l2", 
T_STR
 },

273 { "l3", 
T_STR
 },

274 { "l4", 
T_STR
 },

275 { "l5", 
T_STR
 },

276 { "l6", 
T_STR
 },

277 { "l7", 
T_STR
 },

278 { "l8", 
T_STR
 },

279 { "l9", 
T_STR
 },

280 { "Ï", 
T_STR
 },

	@termcap.c

24 
	~<sys/ty³s.h
>

25 
	~"cÚfig.h
"

26 
	~"sü“n.h
"

27 
	~"ex‹º.h
"

29 #undeà
DEBUGG


31 
di¥Ïy
 *di¥Ïy, *
di¥Ïys
;

32 
»®_uid
, 
»®_gid
, 
eff_uid
, 
eff_gid
;

33 
‹rm
erm[];

34 
NewWšdow
 
nwš_undef
, 
nwš_deçuÉ
, 
nwš_İtiÚs
;

35 
fÜû_vt
;

36 
Z0width
, 
Z1width
;

37 
h¬d¡©u£mu
;

38 #ifdeà
MAPKEYS


39 
aùiÚ
 
umb
[];

40 
aùiÚ
 
mmb
[];

41 
aùiÚ
 
dmb
[];

42 
km­_ext
 *
km­_exts
;

43 
km­_exŠ
;

44 
DeçuÉEsc
;

48 
AddC­
 
__P
((*));

49 
MakeSŒšg
 
__P
((*, *, , *));

50 *
fšdÿp
 
__P
((*, **, ));

51 
cİy¬g
 
__P
((**, *));

52 
e_tg‘’t
 
__P
((*, *));

53 *
e_tg‘¡r
 
__P
((*, **));

54 
e_tg‘æag
 
__P
((*));

55 
e_tg‘num
 
__P
((*));

56 #ifdeà
MAPKEYS


57 
fšd£q_ge
 
__P
((*, , **));

58 
£t£qoff
 
__P
((*, , ));

59 
addm­£q
 
__P
((*, , ));

60 
»mm­£q
 
__P
((*, ));

61 #ifdeà
DEBUGG


62 
dumpm­
 
__P
(());

67 
	gT”mÿp
[
TERMCAP_BUFSIZE
 + 8];

68 
	gT”mÿ¶’
;

69 
	gtcLšeL’
;

70 
	gT”m
[
MAXSTR
+5];

71 
	gsü“Á”m
[20];

73 *
	gexŒa_šÿp
, *
	gexŒa_outÿp
;

75 cÚ¡ 
	gT”mÿpCÚ¡
[] = "\\\n\
\t:DO=\\E[%dB:LE=\\E[%dD:RI=\\E[%dC:UP=\\E[%dA:bs:bt=\\E[Z:\\\n\
\t:cd=\\E[J:ce=\\E[K:cl=\\E[H\\E[J:cm=\\E[%i%d;%dH:ct=\\E[3g:\\\n\
\t:do=^J:nd=\\E[C:pt:rc=\\E8:rs=\\Ec:sc=\\E7:st=\\EH:up=\\EM:\\\n\
\t:le=^H:bl=^G:cr=^M:it#8:ho=\\E[H:nw=\\EE:ta=^I:is=\\E)0:";

82 
	$g‘‹rmÿp¡ršg
(
s
)

83 *
s
;

85 
i
;

87 ià(
di¥Ïy
 =ğ0 || 
s
 == 0)

89 
i
 = 0; i < 
T_N
; i++)

91 ià(
‹rm
[
i
].
ty³
 !ğ
T_STR
)

93 ià(
	`¡rcmp
(
‹rm
[
i
].
túame
, 
s
) == 0)

94  
D_tcs
[
i
].
¡r
;

97 
	}
}

105 
	$In™T”mÿp
(
wi
, 
he
)

106 
wi
;

107 
he
;

109 *
s
;

110 
i
;

111 
tbuf
[
TERMCAP_BUFSIZE
], *

;

112 
t
, 
xue
, 
x£
, 
xme
;

114 
	`ASSERT
(
di¥Ïy
);

115 
	`bz”o
(
tbuf
, (tbuf));

116 
	`debug1
("In™T”mÿp:†ookšg fÜg‘’t('%s')\n", 
D_‹rmÇme
);

117 ià(*
D_‹rmÇme
 =ğ0 || 
	`e_tg‘’t
(
tbuf
, D_termname) != 1)

119 #ifdeà
TERMINFO


120 
	`Msg
(0, "CªnÙ fšd”mšfØ’Œy fÜ '%s'.", 
D_‹rmÇme
);

122 
	`Msg
(0, "CªnÙ fšd”mÿ°’Œy fÜ '%s'.", 
D_‹rmÇme
);

126 
	`debug1
("gÙ it:\n%s\n", 
tbuf
);

127 #ifdeà
DEBUG


128 ià(
exŒa_šÿp
)

129 
	`debug1
("ExŒ¨šÿp: %s\n", 
exŒa_šÿp
);

130 ià(
exŒa_outÿp
)

131 
	`debug1
("ExŒ¨outÿp: %s\n", 
exŒa_outÿp
);

134 ià((
D_‹Áry
 = (*)
	`m®loc
(
TERMCAP_BUFSIZE
 + (
exŒa_šÿp
 ? 
	`¡¾’
(extra_incap) + 1 : 0))) == 0)

136 
	`Msg
(0, 
¡ºomem
);

143 

 = 
D_‹Áry
;

144 
i
 = 0; i < 
T_N
; i++)

146 
‹rm
[
i
].
ty³
)

148 
T_FLG
:

149 
D_tcs
[
i
].
æg
 = 
	`e_tg‘æag
(
‹rm
[i].
túame
);

151 
T_NUM
:

152 
D_tcs
[
i
].
num
 = 
	`e_tg‘num
(
‹rm
[i].
túame
);

154 
T_STR
:

155 
D_tcs
[
i
].
¡r
 = 
	`e_tg‘¡r
(
‹rm
[i].
túame
, &

);

157 ià(
D_tcs
[
i
].
¡r
 && *D_tcs[i].str == 0)

158 
D_tcs
[
i
].
¡r
 = 0;

161 
	`Pªic
(0, "IÎeg®øty³ iÀ’Œy #%d", 
i
);

169 ià(
D_HC
)

171 
	`Msg
(0, "You can't„un screen on‡ hardcopyerminal.");

174 ià(
D_OS
)

176 
	`Msg
(0, "You can't„un screen on‡erminalhat overstrikes.");

179 ià(!
D_CL
)

181 
	`Msg
(0, "Clear screen capability„equired.");

184 ià(!
D_CM
)

186 
	`Msg
(0, "Addressable cursor capability„equired.");

189 ià((
s
 = 
	`g‘’v
("COLUMNS")è&& (
i
 = 
	`©oi
(s)) > 0)

190 
D_CO
 = 
i
;

191 ià((
s
 = 
	`g‘’v
("LINES")è&& (
i
 = 
	`©oi
(s)) > 0)

192 
D_LI
 = 
i
;

193 ià(
wi
)

194 
D_CO
 = 
wi
;

195 ià(
he
)

196 
D_LI
 = 
he
;

197 ià(
D_CO
 <= 0)

198 
D_CO
 = 80;

199 ià(
D_LI
 <= 0)

200 
D_LI
 = 24;

202 ià(
D_CTF
)

206 ià(!
D_CAF
 && 
D_ME
 && (
	`InSŒ
(D_ME, "\033[m") || InStr(D_ME, "\033[0m")))

208 #ifdeà
TERMINFO


209 
D_CAF
 = "\033[3%p1%dm";

210 
D_CAB
 = "\033[4%p1%dm";

212 
D_CAF
 = "\033[3%dm";

213 
D_CAB
 = "\033[4%dm";

216 ià(
D_OP
 && 
	`InSŒ
(D_OP, "\033[39;49m"))

217 
D_CAX
 = 1;

218 ià(
D_OP
 && (
	`InSŒ
(D_OP, "\033[m") || InStr(D_OP, "\033[0m")))

219 
D_OP
 = 0;

221 ià((
D_EA
 && 
	`InSŒ
(D_EA, "\033(B")è|| (
D_AS
 && InStr(D_AS, "\033(0")))

222 
D_CG0
 = 1;

223 ià(
	`InSŒ
(
D_‹rmÇme
, "xterm") || InStr(D_termname, "rxvt"))

224 
D_CXT
 = 1;

226 ià(
D_CXT
)

227 
D_BE
 = 1;

229 ià(
nwš_İtiÚs
.
æowæag
 =ğ
nwš_undef
.flowflag)

230 
nwš_deçuÉ
.
æowæag
 = 
D_CNF
 ? 
FLOW_NOW
 * 0 :

231 
D_NX
 ? 
FLOW_NOW
 * 1 :

232 
FLOW_AUTOFLAG
;

233 
D_CLP
 |ğ(!
D_AM
 || 
D_XV
 || 
D_XN
);

234 ià(!
D_BL
)

235 
D_BL
 = "\007";

236 ià(!
D_BC
)

238 ià(
D_BS
)

239 
D_BC
 = "\b";

241 
D_BC
 = 
D_LE
;

243 ià(!
D_CR
)

244 
D_CR
 = "\r";

245 ià(!
D_NL
)

246 
D_NL
 = "\n";

254 ià(
D_UG
 > 0)

255 
D_US
 = 
D_UE
 = 0;

256 ià(
D_SG
 > 0)

257 
D_SO
 = 
D_SE
 = 0;

261 ià(
D_UG
 > 0 && 
D_SG
 > 0)

262 
D_MH
 = 
D_MD
 = 
D_MR
 = 
D_MB
 = 
D_ME
 = 0;

264 
xue
 = 
ATYP_U
;

265 
x£
 = 
ATYP_S
;

266 
xme
 = 
ATYP_M
;

268 ià(
D_SO
 && 
D_SE
 == 0)

270 
	`Msg
(0, "Warning: 'so' but‚o 'se' capability.");

271 ià(
D_ME
)

272 
x£
 = 
xme
;

274 
D_SO
 = 0;

276 ià(
D_US
 && 
D_UE
 == 0)

278 
	`Msg
(0, "Warning: 'us' but‚o 'ue' capability.");

279 ià(
D_ME
)

280 
xue
 = 
xme
;

282 
D_US
 = 0;

284 ià((
D_MH
 || 
D_MD
 || 
D_MR
 || 
D_MB
è&& 
D_ME
 == 0)

286 
	`Msg
(0, "Warning: 'm?' but‚o 'me' capability.");

287 
D_MH
 = 
D_MD
 = 
D_MR
 = 
D_MB
 = 0;

294 ià(
D_UE
 && 
D_SE
 && 
	`¡rcmp
(D_SE, D_UE) == 0)

295 
x£
 = 
xue
;

296 ià(
D_SE
 && 
D_ME
 && 
	`¡rcmp
(D_ME, D_SE) == 0)

297 
x£
 = 
xme
;

298 ià(
D_UE
 && 
D_ME
 && 
	`¡rcmp
(D_ME, D_UE) == 0)

299 
xue
 = 
xme
;

301 
i
 = 0; i < 
NATTR
; i++)

303 
D_©Œb
[
i
] = 
D_tcs
[
T_ATTR
 + i].
¡r
;

304 
D_©Œtyp
[
i
] = i =ğ
ATTR_SO
 ? 
x£
 : (˜=ğ
ATTR_US
 ? 
xue
 : 
xme
);

308 
s
 = 0;

309 
t
 = 0;

310 
i
 = 0; i < 
NATTR
; i++)

311 ià((
s
 = 
D_©Œb
[
i
]))

313 
t
 = 
D_©Œtyp
[
i
];

316 
i
 = 0; i < 
NATTR
; i++)

318 ià(
D_©Œb
[
i
] == 0)

320 
D_©Œb
[
i
] = 
s
;

321 
D_©Œtyp
[
i
] = 
t
;

325 
s
 = 
D_©Œb
[
i
];

326 
t
 = 
D_©Œtyp
[
i
];

329 ià(
D_CAF
 || 
D_CAB
 || 
D_CSF
 || 
D_CSB
)

330 
D_hascŞÜ
 = 1;

331 ià(
D_UT
)

332 
D_BE
 = 1;

334 ià(!
D_DO
)

335 
D_DO
 = 
D_NL
;

336 ià(!
D_SF
)

337 
D_SF
 = 
D_NL
;

338 ià(
D_IN
)

339 
D_IC
 = 
D_IM
 = 0;

340 ià(
D_EI
 == 0)

341 
D_IM
 = 0;

343 ià(
D_IC
 && 
D_IM
 && 
	`¡rcmp
(D_IC, D_IM) == 0)

344 
D_IC
 = 0;

345 ià(
D_KE
 == 0)

346 
D_KS
 = 0;

347 ià(
D_CVN
 == 0)

348 
D_CVR
 = 0;

349 ià(
D_VE
 == 0)

350 
D_VI
 = 
D_VS
 = 0;

351 ià(
D_CCE
 == 0)

352 
D_CCS
 = 0;

354 #ifdeà
FONT


355 ià(
D_CG0
)

357 ià(
D_CS0
 == 0)

358 #ifdeà
TERMINFO


359 
D_CS0
 = "\033(%p1%c";

361 
D_CS0
 = "\033(%.";

363 ià(
D_CE0
 == 0)

364 
D_CE0
 = "\033(B";

365 
D_AC
 = 0;

366 
D_EA
 = 0;

368 ià(
D_AC
 || (
D_AS
 && 
D_AE
))

370 
D_CS0
 = (
D_AS
 && 
D_AE
) ? D_AS : "";

371 
D_CE0
 = (
D_AS
 && 
D_AE
) ? D_AE : "";

372 
D_CC0
 = 
D_AC
;

376 
D_CS0
 = 
D_CE0
 = "";

377 
D_CC0
 = 0;

378 
D_AC
 = "";

381 
i
 = 0; i < 256; i++)

382 
D_c0_b
[
i
] = i;

383 ià(
D_AC
)

386 
s
 = "l+m+k+j+u+t+v+w+q-x|n+o~s_p\"r#`+a:f'g#~o.v-^+<,>h#I#0#y<z>";

387 
i
 = 
	`¡¾’
(
s
) & ~1; i >= 0; i -= 2)

388 
D_c0_b
[()()
s
[
i
]] = s[i + 1];

390 ià(
D_CC0
)

391 
i
 = 
	`¡¾’
(
D_CC0
) & ~1; i >= 0; i -= 2)

392 
D_c0_b
[()()
D_CC0
[
i
]] = D_CC0[i + 1];

393 
	`debug1
("ISO2022 = %d\n", 
D_CG0
);

395 ià(
D_PF
 == 0)

396 
D_PO
 = 0;

397 
	`debug2
("‹rmš® sizi %d, %d (§y TERMCAP)\n", 
D_CO
, 
D_LI
);

399 #ifdeà
FONT


400 ià(
D_CXC
)

401 ià(
	`C»©eT¿nsTabË
(
D_CXC
))

406 ià(
D_CZ1
 == 0)

407 
D_CZ0
 = 0;

408 
Z0width
 = 132;

409 
Z1width
 = 80;

411 
	`CheckSü“nSize
(0);

413 ià(
D_TS
 =ğ0 || 
D_FS
 =ğ0 || 
D_DS
 == 0)

414 
D_HS
 = 0;

415 ià(
D_HS
)

417 
	`debug
("oy! we have‡ hardware status†ine, saysermcap\n");

418 ià(
D_WS
 < 0)

419 
D_WS
 = 0;

421 
D_has_h¡©us
 = 
h¬d¡©u£mu
 & ~
HSTATUS_ALWAYS
;

422 ià(
D_HS
 && !(
h¬d¡©u£mu
 & 
HSTATUS_ALWAYS
))

423 
D_has_h¡©us
 = 
HSTATUS_HS
;

425 #ifdeà
ENCODINGS


426 ià(
D_CKJ
)

428 
’c
 = 
	`FšdEncodšg
(
D_CKJ
);

429 ià(
’c
 != -1)

430 
D_’codšg
 = 
’c
;

433 ià(!
D_tcs
[
T_NAVIGATE
].
¡r
 && D_tcs[T_NAVIGATE + 1].str)

434 
D_tcs
[
T_NAVIGATE
].
¡r
 = D_tcs[T_NAVIGATE + 1].str;

435 ià(!
D_tcs
[
T_NAVIGATE
 + 2].
¡r
 && D_tcs[T_NAVIGATE + 3].str)

436 
D_tcs
[
T_NAVIGATE
 + 2].
¡r
 = D_tcs[T_NAVIGATE + 3].str;

438 
D_UPco¡
 = 
	`C®cCo¡
(
D_UP
);

439 
D_DOco¡
 = 
	`C®cCo¡
(
D_DO
);

440 
D_NLco¡
 = 
	`C®cCo¡
(
D_NL
);

441 
D_LEco¡
 = 
	`C®cCo¡
(
D_BC
);

442 
D_NDco¡
 = 
	`C®cCo¡
(
D_ND
);

443 
D_CRco¡
 = 
	`C®cCo¡
(
D_CR
);

444 
D_IMco¡
 = 
	`C®cCo¡
(
D_IM
);

445 
D_EIco¡
 = 
	`C®cCo¡
(
D_EI
);

447 #ifdeà
AUTO_NUKE


448 ià(
D_CAN
)

450 
	`debug
("termcap has AN, setting‡utonuke\n");

451 
D_auto_nuke
 = 1;

454 ià(
D_COL
 > 0)

456 
	`debug1
("‹rmÿ°ha OL (%d), s‘tšg†im™\n", 
D_COL
);

457 
D_obufmax
 = 
D_COL
;

458 
D_obuæ’max
 = 
D_obuæ’
 - 
D_obufmax
;

462 ià(
D_tcs
[
T_CAPS
].
¡r
 && D_tcs[T_CAPS + 10].¡¸&& !
	`¡rcmp
(D_tcs[T_CAPS].str, D_tcs[T_CAPS + 10].str))

463 
D_tcs
[
T_CAPS
].
¡r
 = 0;

465 ià(
D_tcs
[
T_NAVIGATE_DELETE
].
¡r
 && !
	`¡rcmp
(D_tcs[T_NAVIGATE_DELETE].str, "\0177"))

466 
D_tcs
[
T_NAVIGATE_DELETE
].
¡r
 = 0;

468 ià(
D_tcs
[
T_CURSOR
 + 3].
¡r
 && !
	`¡rcmp
(D_tcs[T_CURSOR + 3].str, "\008"))

469 
D_tcs
[
T_CURSOR
 + 3].
¡r
 = 0;

471 #ifdeà
MAPKEYS


472 
D_n£qs
 = 0;

473 
i
 = 0; i < 
T_OCAPS
 - 
T_CAPS
; i++)

474 
	`»m­
(
i
, 1);

475 
i
 = 0; i < 
km­_exŠ
; i++)

476 
	`»m­
(
i
 + (
KMAP_KEYS
+
KMAP_AKEYS
), 1);

477 
D_£qp
 = 
D_km­s
 + 3;

478 
D_£ql
 = 0;

479 
D_£qh
 = 0;

482 
D_tcš™ed
 = 1;

483 
	`MakeT”mÿp
(0);

484 #ifdeà
MAPKEYS


485 
	`CheckEsÿ³
();

488 
	}
}

490 #ifdeà
MAPKEYS


493 
	$»m­
(
n
, 
m­
)

494 
n
;

495 
m­
;

497 *
s
 = 0;

498 
æ
 = 0, 
dom­
 = 0;

499 
aùiÚ
 *
a1
, *
a2
, *
b
;

500 
l
 = 0;

501 
km­_ext
 *
kme
 = 0;

503 
a1
 = 0;

504 ià(
n
 >ğ
KMAP_KEYS
+
KMAP_AKEYS
)

506 
kme
 = 
km­_exts
 + (
n
 - (
KMAP_KEYS
+
KMAP_AKEYS
));

507 
s
 = 
kme
->
¡r
;

508 
l
 = 
kme
->
æ
 & ~
KMAP_NOTIMEOUT
;

509 
æ
 = 
kme
->æ & 
KMAP_NOTIMEOUT
;

510 
a1
 = &
kme
->
um
;

512 
b
 = 
umb
;

515 
a2
 = 0;

516 ià(
n
 < 
KMAP_KEYS
+
KMAP_AKEYS
)

518 
a1
 = &
b
[
n
];

519 ià(
n
 >ğ
KMAP_KEYS
)

520 
n
 -ğ
T_OCAPS
-
T_CURSOR
;

521 
s
 = 
D_tcs
[
n
 + 
T_CAPS
].
¡r
;

522 
l
 = 
s
 ? 
	`¡¾’
(s) : 0;

523 ià(
n
 >ğ
T_CURSOR
-
T_CAPS
)

524 
a2
 = &
b
[
n
 + (
T_OCAPS
-
T_CURSOR
)];

526 ià(
s
 =ğ0 || 
l
 == 0)

528 ià(
a1
 &&‡1->
Ä
 =ğ
RC_ILLEGAL
)

529 
a1
 = 0;

530 ià(
a2
 &&‡2->
Ä
 =ğ
RC_ILLEGAL
)

531 
a2
 = 0;

532 ià(
a1
 &&‡1->
Ä
 =ğ
RC_STUFF
 && 
	`¡rcmp
×1->
¬gs
[0], 
s
) == 0)

533 
a1
 = 0;

534 ià(
a2
 &&‡2->
Ä
 =ğ
RC_STUFF
 && 
	`¡rcmp
×2->
¬gs
[0], 
s
) == 0)

535 
a2
 = 0;

536 
dom­
 |ğ(
a1
 || 
a2
);

537 ià(
b
 =ğ
umb
)

539 
b
 = 
dmb
;

540 
a1
 = 
kme
 ? &kme->
dm
 : 0;

542 ià(
b
 =ğ
dmb
)

544 
b
 = 
mmb
;

545 
a1
 = 
kme
 ? &kme->
mm
 : 0;

551 ià(
m­
 =ğ0 && 
dom­
)

553 ià(
m­
 && !
dom­
)

555 
	`debug3
("%sm­pšg % %#x\n", 
m­
? "" :"un",
s
,
n
);

556 ià(
m­
)

557  
	`addm­£q
(
s
, 
l
, 
n
 | 
æ
);

559  
	`»mm­£q
(
s
, 
l
);

560 
	}
}

563 
	$CheckEsÿ³
()

565 
di¥Ïy
 *
odi¥Ïy
;

566 
i
, 
Ä
;

568 ià(
DeçuÉEsc
 >= 0)

571 
odi¥Ïy
 = 
di¥Ïy
;

572 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

574 
i
 = 0; i < 
D_n£qs
; i +ğ
D_km­s
[i + 2] * 2 + 4)

576 
Ä
 = (
D_km­s
[
i
] << 8 | D_km­s[˜+ 1]è& ~
KMAP_NOTIMEOUT
;

577 ià(
Ä
 < 
KMAP_KEYS
+
KMAP_AKEYS
)

579 ià(
umb
[
Ä
].Ä =ğ
RC_COMMAND
)

581 ià(
umb
[
Ä
].Ä =ğ
RC_ILLEGAL
 && 
dmb
[Ä].Ä =ğ
RC_COMMAND
)

586 
km­_ext
 *
kme
 = 
km­_exts
 + 
Ä
 - (
KMAP_KEYS
+
KMAP_AKEYS
);

587 ià(
kme
->
um
.
Ä
 =ğ
RC_COMMAND
)

589 ià(
kme
->
um
.
Ä
 =ğ
RC_ILLEGAL
 && kme->
dm
.Ä =ğ
RC_COMMAND
)

594 ià(
di¥Ïy
 == 0)

596 
di¥Ïy
 = 
odi¥Ïy
;

599 
	`S‘Esÿ³
((
aşu£r
 *)0, 
	`CŒl
('a'), 'a');

600 ià(
odi¥Ïy
->
d_u£r
->
u_Esc
 == -1)

601 
odi¥Ïy
->
d_u£r
->
u_Esc
 = 
DeçuÉEsc
;

602 ià(
odi¥Ïy
->
d_u£r
->
u_M‘aEsc
 == -1)

603 
odi¥Ïy
->
d_u£r
->
u_M‘aEsc
 = 
DeçuÉM‘aEsc
;

604 
di¥Ïy
 = 0;

605 
	`Msg
(0, "Warning:ƒscape char set backo ^A");

606 
di¥Ïy
 = 
odi¥Ïy
;

607 
	}
}

610 
	$fšd£q_ge
(
£q
, 
k
, 
¥
)

611 *
£q
;

612 
k
;

613 **
¥
;

615 *
p
;

616 
j
, 
l
;

618 
p
 = 
D_km­s
;

619 
p
 - 
D_km­s
 < 
D_n£qs
)

621 
l
 = 
p
[2];

622 
p
 += 3;

623 
j
 = 0; ; j++)

625 ià(
j
 =ğ
k
 || j =ğ
l
)

626 
j
 = 
l
 - 
k
;

627 ià(
p
[
j
] !ğ((*)
£q
)[j])

628 
j
 = 
p
[j] - ((*)
£q
)[j];

633 ià(
j
 >= 0)

635 *
¥
 = 
p
 - 3;

636  
j
;

638 
p
 +ğ2 * 
l
 + 1;

640 *
¥
 = 
p
;

642 
	}
}

645 
	$£t£qoff
(
p
, 
i
, 
o
)

646 *
p
;

647 
i
;

648 
o
;

650 *
q
;

651 
l
, 
k
;

653 
k
 = 
p
[2];

654 ià(
o
 < 256)

656 
p
[
k
 + 4 + 
i
] = 
o
;

660 
q
 = 
p
 + 
k
 * 2 + 4; ; q +ğ
l
 * 2 + 4)

662 
l
 = 
q
[2];

663 ià((
q
 + 
l
 * 2 - 
p
) / 2 >= 256)

665 
p
[
k
 + 4 + 
i
] = (
q
 -… - 4) / 2;

669 
	}
}

672 
	$addm­£q
(
£q
, 
k
, 
Ä
)

673 *
£q
;

674 
k
;

675 
Ä
;

677 
i
, 
j
, 
l
, 
mo
, 
m
;

678 *
p
, *
q
;

680 ià(
k
 >= 254)

682 
j
 = 
	`fšd£q_ge
(
£q
, 
k
, &
p
);

683 ià(
j
 == 0)

685 
p
[0] = 
Ä
 >> 8;

686 
p
[1] = 
Ä
;

689 
i
 = 
p
 - 
D_km­s
;

690 ià(
D_n£qs
 + 2 * 
k
 + 4 >ğ
D_a£qs
)

692 
D_km­s
 = (*)
	`x»®loc
((*)D_km­s, 
D_a£qs
 + 256);

693 
D_a£qs
 += 256;

694 
p
 = 
D_km­s
 + 
i
;

696 
D_£qp
 = 
D_km­s
 + 3;

697 
D_£ql
 = 0;

698 
D_£qh
 = 0;

699 
	`evdeq
(&
D_m­ev
);

700 ià(
j
 > 0)

701 
	`bcİy
((*)
p
, (*í + 2 * 
k
 + 4, 
D_n£qs
 - 
i
);

702 
p
[0] = 
Ä
 >> 8;

703 
p
[1] = 
Ä
;

704 
p
[2] = 
k
;

705 
	`bcİy
(
£q
, (*)
p
 + 3, 
k
);

706 
	`bz”o
(
p
 + 
k
 + 3, k + 1);

707 
D_n£qs
 +ğ2 * 
k
 + 4;

708 ià(
j
 > 0)

710 
q
 = 
p
 + 2 * 
k
 + 4;

711 
l
 = 
q
[2];

712 
i
 = 0; i < 
k
; i++)

714 ià(
p
[3 + 
i
] !ğ
q
[3 + i])

716 
p
[
k
 + 4 + 
i
] = k;

719 
	`£t£qoff
(
p
, 
i
, 
q
[
l
 + 4 + i] ? q[È+ 4 + i] + 
k
 + 2: 0);

722 
q
 = 
D_km­s
; q < 
p
; q +ğ2 * 
l
 + 4)

724 
l
 = 
q
[2];

725 
m
 = 
j
 = 0; j < 
l
; j++)

727 
mo
 = 
m
;

728 ià(!
m
 && 
q
[3 + 
j
] !ğ
£q
[j])

729 
m
 = 1;

730 ià(
q
[
l
 + 4 + 
j
] == 0)

732 ià(!
mo
 && 
m
)

733 
	`£t£qoff
(
q
, 
j
, (
p
 - q - 4) / 2);

735 ià(
q
 + q[
l
 + 4 + 
j
] * 2 + 4 > 
p
 || (q + q[È+ 4 + j] * 2 + 4 =ğ°&& !
m
))

736 
	`£t£qoff
(
q
, 
j
, q[
l
 + 4 + j] + 
k
 + 2);

739 #ifdeà
DEBUGG


740 
	`dumpm­
();

743 
	}
}

746 
	$»mm­£q
(
£q
, 
k
)

747 *
£q
;

748 
k
;

750 
j
, 
l
;

751 *
p
, *
q
;

753 ià(
k
 >ğ254 || (
j
 = 
	`fšd£q_ge
(
£q
, k, &
p
)) != 0)

755 
q
 = 
D_km­s
; q < 
p
; q +ğ2 * 
l
 + 4)

757 
l
 = 
q
[2];

758 
j
 = 0; j < 
l
; j++)

760 ià(
q
 + q[
l
 + 4 + 
j
] * 2 + 4 =ğ
p
)

761 
	`£t£qoff
(
q
, 
j
, 
p
[
k
 + 4 + j] ? q[
l
 + 4 + j] +…[k + 4 + j] - k : 0);

762 ià(
q
 + q[
l
 + 4 + 
j
] * 2 + 4 > 
p
)

763 
q
[
l
 + 4 + 
j
] -ğ
k
 + 2;

766 ià(
D_km­s
 + 
D_n£qs
 > 
p
 + 2 * 
k
 + 4)

767 
	`bcİy
((*)
p
 + 2 * 
k
 + 4, (*í, (
D_km­s
 + 
D_n£qs
) - (p + 2 * k + 4));

768 
D_n£qs
 -ğ2 * 
k
 + 4;

769 
D_£qp
 = 
D_km­s
 + 3;

770 
D_£ql
 = 0;

771 
D_£qh
 = 0;

772 
	`evdeq
(&
D_m­ev
);

773 #ifdeà
DEBUGG


774 
	`dumpm­
();

777 
	}
}

779 #ifdeà
DEBUGG


781 
	$dumpm­
()

783 *
p
;

784 
j
, 
n
, 
l
, 
o
, 
oo
;

785 
	`debug
("Mappings:\n");

786 
p
 = 
D_km­s
;

787 ià(!
p
)

789 
p
 < 
D_km­s
 + 
D_n£qs
)

791 
l
 = 
p
[2];

792 
	`debug1
("%d: ", 
p
 - 
D_km­s
 + 3);

793 
j
 = 0; j < 
l
; j++)

795 
o
 = 
oo
 = 
p
[
l
 + 4 + 
j
];

796 ià(
o
)

797 
o
 = 2 * o + 4 + (
p
 + 3 + 
j
 - 
D_km­s
);

798 ià(
p
[
j
 + 3] > ' ' &&…[j + 3] < 0177)

800 
	`debug3
("%c[%d:%d] ", 
p
[
j
 + 3], 
oo
, 
o
);

803 
	`debug3
("\\%03o[%d:%d] ", 
p
[
j
 + 3], 
oo
, 
o
);

805 
n
 = 
p
[0] << 8 |…[1];

806 
	`debug2
(" ==> %d%s\n", 
n
 & ~
KMAP_NOTIMEOUT
, (n & KMAP_NOTIMEOUT) ? " (noimeout)" : "");

807 
p
 +ğ2 * 
l
 + 4;

809 
	}
}

818 
	$AddC­
(
s
)

819 *
s
;

821 
n
;

823 ià(
tcLšeL’
 + (
n
 = 
	`¡¾’
(
s
)è> 55 && 
T”mÿ¶’
 < 
TERMCAP_BUFSIZE
 - 4 - 1)

825 
	`¡rıy
(
T”mÿp
 + 
T”mÿ¶’
, "\\\n\t:");

826 
T”mÿ¶’
 += 4;

827 
tcLšeL’
 = 0;

829 ià(
T”mÿ¶’
 + 
n
 < 
TERMCAP_BUFSIZE
 - 1)

831 
	`¡rıy
(
T”mÿp
 + 
T”mÿ¶’
, 
s
);

832 
T”mÿ¶’
 +ğ
n
;

833 
tcLšeL’
 +ğ
n
;

836 
	`Pªic
(0, "TERMCAP overflow - sorry.");

837 
	}
}

844 
	$MakeT”mÿp
(
aæag
)

845 
aæag
;

847 
buf
[
TERMCAP_BUFSIZE
];

848 *
p
, *
ı
, *
s
, 
ch
, *
Šame
;

849 
i
, 
wi
, 
he
;

851 
found
;

854 ià(
di¥Ïy
)

856 
wi
 = 
D_width
;

857 
he
 = 
D_height
;

858 
Šame
 = 
D_‹rmÇme
;

862 
wi
 = 80;

863 
he
 = 24;

864 
Šame
 = "vt100";

866 
	`debug1
("MakeT”mÿp(%d)\n", 
aæag
);

867 ià((
s
 = 
	`g‘’v
("SCREENCAP")è&& 
	`¡¾’
(sè< 
TERMCAP_BUFSIZE
)

869 
	`¥rštf
(
T”mÿp
, "TERMCAP=%s", 
s
);

870 
	`¡rıy
(
T”m
, "TERM=screen");

871 
	`debug
("getenvSCREENCAP o.k.\n");

872  
T”mÿp
;

874 
T”mÿ¶’
 = 0;

875 
	`debug1
("MakeT”mÿ°sü“Á”m='%s'\n", 
sü“Á”m
);

876 
	`debug1
("MakeT”mÿ°‹rmÇme='%s'\n", 
Šame
);

877 ià(*
sü“Á”m
 =ğ'\0' || 
	`¡¾’
(sü“Á”mè> 
MAXSTR
 - 3)

879 
	`debug
("MakeTermcap sets screenterm=screen\n");

880 
	`¡rıy
(
sü“Á”m
, "screen");

883 
found
 = 1;

887 
	`¡rıy
(
T”m
, "TERM=");

888 
p
 = 
T”m
 + 5;

889 ià(!
aæag
 && 
	`¡¾’
(
sü“Á”m
è+ sŒËn(
Šame
è< 
MAXSTR
-1)

891 
	`¥rštf
(
p
, "%s.%s", 
sü“Á”m
, 
Šame
);

892 ià(
	`e_tg‘’t
(
buf
, 
p
) == 1)

895 #ifdeà
COLOR


896 ià(
nwš_deçuÉ
.
bû
)

898 
	`¥rštf
(
p
, "%s-bû", 
sü“Á”m
);

899 ià(
	`e_tg‘’t
(
buf
, 
p
) == 1)

903 #ifdeà
CHECK_SCREEN_W


904 ià(
wi
 >= 132)

906 
	`¥rštf
(
p
, "%s-w", 
sü“Á”m
);

907 ià(
	`e_tg‘’t
(
buf
, 
p
) == 1)

911 
	`¡rıy
(
p
, 
sü“Á”m
);

912 ià(
	`e_tg‘’t
(
buf
, 
p
) == 1)

914 
	`¡rıy
(
p
, "vt100");

916 
found
 = 0;

922 #iâdeà
TERMINFO


924 ià(
found
)

926 
xbuf
[
TERMCAP_BUFSIZE
], *
xbp
 = xbuf;

927 ià(
	`tg‘¡r
("im", &
xbp
è&&g‘¡r("ic", &xbpè&& 
di¥Ïys
)

929 
	`Msg
(0, "W¬nšg: im‡nd iø£ˆš % ‹rmÿ°’Œy", 
p
);

935 
tcLšeL’
 = 100;

936 ià(
	`¡¾’
(
T”m
è> 
TERMCAP_BUFSIZE
 - 40)

937 
	`¡rıy
(
T”m
, "too_long");

938 
	`¥rštf
(
T”mÿp
, "TERMCAP=SC|%s|VT 100/ANSI X3.64 vœtu®”mš®:", 
T”m
 + 5);

939 
T”mÿ¶’
 = 
	`¡¾’
(
T”mÿp
);

940 
	`debug1
("MakeT”mÿ°decided '%s'\n", 
p
);

941 ià(
exŒa_outÿp
 && *extra_outcap)

943 
ı
 = 
exŒa_outÿp
; (
p
 = 
	`šdex
(cp, ':')); cp =…)

945 
ch
 = *++
p
;

946 *
p
 = '\0';

947 
	`AddC­
(
ı
);

948 *
p
 = 
ch
;

950 
tcLšeL’
 = 100;

952 
	`debug1
("MakeT”mÿ°aá” outÿ°'%s'\n", (*)
T”mÿpCÚ¡
);

953 ià(
T”mÿ¶’
 + 
	`¡¾’
(
T”mÿpCÚ¡
è< 
TERMCAP_BUFSIZE
)

955 
	`¡rıy
(
T”mÿp
 + 
T”mÿ¶’
, (*)
T”mÿpCÚ¡
);

956 
T”mÿ¶’
 +ğ
	`¡¾’
(
T”mÿpCÚ¡
);

958 
	`¥rštf
(
buf
, "li#%d:co#%d:", 
he
, 
wi
);

959 
	`AddC­
(
buf
);

960 
	`AddC­
("am:");

961 ià(
aæag
 || (
fÜû_vt
 && !
D_COP
è|| 
D_CLP
 || !
D_AM
)

963 
	`AddC­
("xn:");

964 
	`AddC­
("xv:");

965 
	`AddC­
("LP:");

967 ià(
aæag
 || (
D_CS
 && 
D_SR
è|| 
D_AL
 || 
D_CAL
)

969 
	`AddC­
("sr=\\EM:");

970 
	`AddC­
("al=\\E[L:");

971 
	`AddC­
("AL=\\E[%dL:");

973 ià(
D_SR
)

974 
	`AddC­
("sr=\\EM:");

975 ià(
aæag
 || 
D_CS
)

976 
	`AddC­
("cs=\\E[%i%d;%dr:");

977 ià(
aæag
 || 
D_CS
 || 
D_DL
 || 
D_CDL
)

979 
	`AddC­
("dl=\\E[M:");

980 
	`AddC­
("DL=\\E[%dM:");

982 ià(
aæag
 || 
D_DC
 || 
D_CDC
)

984 
	`AddC­
("dc=\\E[P:");

985 
	`AddC­
("DC=\\E[%dP:");

987 ià(
aæag
 || 
D_CIC
 || 
D_IC
 || 
D_IM
)

989 
	`AddC­
("im=\\E[4h:");

990 
	`AddC­
("ei=\\E[4l:");

991 
	`AddC­
("mi:");

992 
	`AddC­
("IC=\\E[%d@:");

994 #ifdeà
MAPKEYS


995 
	`AddC­
("ks=\\E[?1h\\E=:");

996 
	`AddC­
("ke=\\E[?1l\\E>:");

998 
	`AddC­
("vi=\\E[?25l:");

999 
	`AddC­
("ve=\\E[34h\\E[?25h:");

1000 
	`AddC­
("vs=\\E[34l:");

1001 
	`AddC­
("ti=\\E[?1049h:");

1002 
	`AddC­
("te=\\E[?1049l:");

1003 ià(
di¥Ïy
)

1005 ià(
D_US
)

1007 
	`AddC­
("us=\\E[4m:");

1008 
	`AddC­
("ue=\\E[24m:");

1010 ià(
D_SO
)

1012 
	`AddC­
("so=\\E[3m:");

1013 
	`AddC­
("se=\\E[23m:");

1015 ià(
D_MB
)

1016 
	`AddC­
("mb=\\E[5m:");

1017 ià(
D_MD
)

1018 
	`AddC­
("md=\\E[1m:");

1019 ià(
D_MH
)

1020 
	`AddC­
("mh=\\E[2m:");

1021 ià(
D_MR
)

1022 
	`AddC­
("mr=\\E[7m:");

1023 ià(
D_MB
 || 
D_MD
 || 
D_MH
 || 
D_MR
)

1024 
	`AddC­
("me=\\E[m:ms:");

1025 ià(
D_hascŞÜ
)

1026 
	`AddC­
("Co#8:pa#64:AF=\\E[3%dm:AB=\\E[4%dm:op=\\E[39;49m:AX:");

1027 ià(
D_VB
)

1028 
	`AddC­
("vb=\\Eg:");

1029 #iâdeà
MAPKEYS


1030 ià(
D_KS
)

1032 
	`AddC­
("ks=\\E=:");

1033 
	`AddC­
("ke=\\E>:");

1035 ià(
D_CCS
)

1037 
	`AddC­
("CS=\\E[?1h:");

1038 
	`AddC­
("CE=\\E[?1l:");

1041 ià(
D_CG0
)

1042 
	`AddC­
("G0:");

1043 ià(
D_CC0
 || (
D_CS0
 && *D_CS0))

1045 
	`AddC­
("as=\\E(0:");

1046 
	`AddC­
("ae=\\E(B:");

1048 
	`AddC­
("ac=\\140\\140aaffggjjkkllmmnnooppqqrrssttuuvvwwxxyyzz{{||}}~~..--++,,hhII00:");

1050 ià(
D_PO
)

1052 
	`AddC­
("po=\\E[5i:");

1053 
	`AddC­
("pf=\\E[4i:");

1055 ià(
D_CZ0
)

1057 
	`AddC­
("Z0=\\E[?3h:");

1058 
	`AddC­
("Z1=\\E[?3l:");

1060 ià(
D_CWS
)

1061 
	`AddC­
("WS=\\E[8;%d;%dt:");

1063 
i
 = 
T_CAPS
; i < 
T_ECAPS
; i++)

1065 #ifdeà
MAPKEYS


1066 
aùiÚ
 *
aù
;

1067 ià(
i
 < 
T_OCAPS
)

1069 ià(
i
 >ğ
T_KEYPAD
)

1071 ià(
i
 >ğ
T_CURSOR
 && i < 
T_OCAPS
)

1073 
aù
 = &
umb
[
i
 - (
T_CURSOR
 - 
T_OCAPS
 + 
T_CAPS
)];

1074 ià(
aù
->
Ä
 =ğ
RC_ILLEGAL
)

1075 
aù
 = &
dmb
[
i
 - (
T_CURSOR
 - 
T_OCAPS
 + 
T_CAPS
)];

1079 
aù
 = &
umb
[
i
 - 
T_CAPS
];

1080 ià(
aù
->
Ä
 =ğ
RC_ILLEGAL
)

1081 
aù
 = &
dmb
[
i
 - 
T_CAPS
];

1083 ià(
aù
->
Ä
 =ğ
RC_ILLEGAL
 && (
i
 =ğ
T_NAVIGATE
 + 1 || i == T_NAVIGATE + 3))

1086 
aù
 = &
umb
[
i
 - 
T_CAPS
 - 1];

1087 ià(
aù
->
Ä
 =ğ
RC_ILLEGAL
)

1088 
aù
 = &
dmb
[
i
 - 
T_CAPS
 - 1];

1090 ià(
aù
->
Ä
 !ğ
RC_ILLEGAL
)

1092 ià(
aù
->
Ä
 =ğ
RC_STUFF
)

1094 
	`MakeSŒšg
(
‹rm
[
i
].
túame
, 
buf
, (buf), 
aù
->
¬gs
[0]);

1095 
	`AddC­
(
buf
);

1101 ià(
di¥Ïy
 == 0)

1103 
‹rm
[
i
].
ty³
)

1105 
T_STR
:

1106 ià(
D_tcs
[
i
].
¡r
 == 0)

1108 
	`MakeSŒšg
(
‹rm
[
i
].
túame
, 
buf
, (buf), 
D_tcs
[i].
¡r
);

1109 
	`AddC­
(
buf
);

1111 
T_FLG
:

1112 ià(
D_tcs
[
i
].
æg
 == 0)

1114 
	`¥rštf
(
buf
, "%s:", 
‹rm
[
i
].
túame
);

1115 
	`AddC­
(
buf
);

1121 
	`debug
("MakeTermcap:ƒnd\n");

1122  
T”mÿp
;

1123 
	}
}

1126 
	$MakeSŒšg
(
ÿp
, 
buf
, 
buæ’
, 
s
)

1127 *
ÿp
, *
buf
;

1128 
buæ’
;

1129 *
s
;

1131 *
p
, *
pmax
;

1132 
c
;

1134 
p
 = 
buf
;

1135 
pmax
 = 
p
 + 
buæ’
 - (3+4+2);

1136 *
p
++ = *
ÿp
++;

1137 *
p
++ = *
ÿp
;

1138 *
p
++ = '=';

1139 (
c
 = *
s
++è&& (
p
 < 
pmax
))

1141 
c
)

1144 *
p
++ = '\\';

1145 *
p
++ = 'E';

1148 
	`¡rıy
(
p
, "\\072");

1149 
p
 += 4;

1153 *
p
++ = '\\';

1154 *
p
++ = 
c
;

1157 ià(
c
 >= 200)

1159 
	`¥rštf
(
p
, "\\%03o", 
c
 & 0377);

1160 
p
 += 4;

1162 ià(
c
 < ' ')

1164 *
p
++ = '^';

1165 *
p
++ = 
c
 + '@';

1168 *
p
++ = 
c
;

1171 *
p
++ = ':';

1172 *
p
 = '\0';

1173 
	}
}

1176 #undeà
QUOTES


1177 
	#QUOTES
(
p
) \

1178 (*
p
 =ğ'\\' && (p[1] =ğ'\\' ||…[1] =ğ',' ||…[1] =ğ'%'))

	)

1180 #ifdeà
FONT


1182 
	$C»©eT¿nsTabË
(
s
)

1183 *
s
;

1185 
curch¬
;

1186 *
‹m¶
, *
¬g
;

1187 
‹m¶Ën
;

1188 
‹m¶nsub
;

1189 *
p
, *
sx
;

1190 **
ùabË
;

1191 
l
, 
c
;

1193 ià((
D_xbË
 = (***)
	`m®loc
(256 * (**))) == 0)

1195 
	`Msg
(0, 
¡ºomem
);

1198 
	`bz”o
((*)
D_xbË
, 256 * (**));

1200 *
s
)

1202 ià(
	`QUOTES
(
s
))

1203 
s
++;

1204 
curch¬
 = ()*
s
++;

1205 ià(
curch¬
 == 'B')

1206 
curch¬
 = 0;

1207 
‹m¶
 = 
s
;

1208 
‹m¶Ën
 = 0;

1209 
‹m¶nsub
 = 0;

1210 ià(
D_xbË
[
curch¬
] == 0)

1212 ià((
D_xbË
[
curch¬
] = (**)
	`m®loc
(257 * (*))) == 0)

1214 
	`Msg
(0, 
¡ºomem
);

1215 
	`F»eT¿nsTabË
();

1218 
	`bz”o
((*)
D_xbË
[
curch¬
], 257 * (*));

1220 
ùabË
 = 
D_xbË
[
curch¬
];

1221 ; *
s
 && *s != ','; s++)

1223 ià(
	`QUOTES
(
s
))

1224 
s
++;

1225 ià(*
s
 == '%')

1227 
‹m¶nsub
++;

1230 
‹m¶Ën
++;

1232 ià(*
s
++ == 0)

1234 *
s
 && *s != ',')

1236 
c
 = ()*
s
++;

1237 ià(
	`QUOTES
((
s
 - 1)))

1238 
c
 = ()*
s
++;

1239 ià(
c
 == '%')

1240 
c
 = 256;

1241 ià(
ùabË
[
c
])

1242 
	`ä“
(
ùabË
[
c
]);

1243 
¬g
 = 
s
;

1244 
l
 = 
	`cİy¬g
(&
s
, (*)0);

1245 ià(
c
 != 256)

1246 
l
 =† * 
‹m¶nsub
 + 
‹m¶Ën
;

1247 ià((
ùabË
[
c
] = (*)
	`m®loc
(
l
 + 1)) == 0)

1249 
	`Msg
(0, 
¡ºomem
);

1250 
	`F»eT¿nsTabË
();

1253 
sx
 = 
ùabË
[
c
];

1254 
p
 = ((
c
 =ğ256è? "%" : 
‹m¶
); *p && *p != ',';…++)

1256 ià(
	`QUOTES
(
p
))

1257 
p
++;

1258 ià(*
p
 == '%')

1260 
s
 = 
¬g
;

1261 
sx
 +ğ
	`cİy¬g
(&
s
, sx);

1264 *
sx
++ = *
p
;

1266 *
sx
 = 0;

1267 
	`ASSERT
(
ùabË
[
c
] + 
l
 * 
‹m¶nsub
 + 
‹m¶Ën
 =ğ
sx
);

1268 
	`debug3
("XC: %ø%c->%s\n", 
curch¬
, 
c
, 
ùabË
[c]);

1270 ià(*
s
 == ',')

1271 
s
++;

1274 
	}
}

1277 
	$F»eT¿nsTabË
()

1279 ***
p
, **
q
;

1280 
i
, 
j
;

1282 ià((
p
 = 
D_xbË
) == 0)

1284 
i
 = 0; i < 256; i++, 
p
++)

1286 ià(*
p
 == 0)

1288 
q
 = *
p
;

1289 
j
 = 0; j < 257; j++, 
q
++)

1290 ià(*
q
)

1291 
	`ä“
(*
q
);

1292 
	`ä“
(*
p
);

1294 
	`ä“
(
D_xbË
);

1295 
	}
}

1299 
	$cİy¬g
(
µ
, 
s
)

1300 **
µ
, *
s
;

1302 
l
;

1303 *
p
;

1305 
l
 = 0, 
p
 = *
µ
; *p && *p != ',';…++)

1307 ià(
	`QUOTES
(
p
))

1308 
p
++;

1309 ià(
s
)

1310 *
s
++ = *
p
;

1311 
l
++;

1313 ià(*
p
 == ',')

1314 
p
++;

1315 *
µ
 = 
p
;

1316  
l
;

1317 
	}
}

1327 
	$e_tg‘’t
(
bp
, 
Çme
)

1328 *
bp
, *
Çme
;

1330 
r
;

1332 #ifdeà
USE_SETEUID


1333 
	`x£‹uid
(
»®_uid
);

1334 
	`x£‹gid
(
»®_gid
);

1336 
r
 = 
	`tg‘’t
(
bp
, 
Çme
);

1337 #ifdeà
USE_SETEUID


1338 
	`x£‹uid
(
eff_uid
);

1339 
	`x£‹gid
(
eff_gid
);

1341  
r
;

1342 
	}
}

1352 
	$fšdÿp
(
ÿp
, 
‹µ
, 
n
)

1353 *
ÿp
;

1354 **
‹µ
;

1355 
n
;

1357 *
‹p
;

1358 
c
, *
p
, *
ı
;

1359 
mode
;

1360 
num
 = 0, 
ÿ¶
;

1362 ià(!
exŒa_šÿp
)

1364 
‹p
 = *
‹µ
;

1365 
ÿ¶
 = 
	`¡¾’
(
ÿp
);

1366 
ı
 = 0;

1367 
mode
 = 0;

1368 
p
 = 
exŒa_šÿp
; *p; )

1370 ià(
	`¡ºcmp
(
p
, 
ÿp
, 
ÿ¶
) == 0)

1372 
p
 +ğ
ÿ¶
;

1373 
c
 = *
p
;

1374 ià(
c
 && c != ':' && c != '@')

1375 
p
++;

1376 ià(
c
 == 0 || c == '@' || c == '=' || c == ':' || c == '#')

1377 
ı
 = 
‹p
;

1379 (
c
 = *
p
))

1381 
p
++;

1382 ià(
mode
 == 0)

1384 ià(
c
 == ':')

1386 ià(
c
 == '^')

1387 
mode
 = 1;

1388 ià(
c
 == '\\')

1389 
mode
 = 2;

1391 ià(
mode
 == 1)

1393 
mode
 = 0;

1394 
c
 = c & 0x1f;

1396 ià(
mode
 == 2)

1398 
mode
 = 0;

1399 
c
)

1411 
mode
 = 3;

1412 
num
 = 0;

1415 
c
 = 27;

1418 
c
 = '\n';

1421 
c
 = '\r';

1424 
c
 = '\t';

1427 
c
 = '\b';

1430 
c
 = '\f';

1434 ià(
mode
 > 2)

1436 
num
 =‚um * 8 + (
c
 - '0');

1437 ià(
mode
++ =ğ5 || (*
p
 < '0' || *p > '9'))

1439 
c
 = 
num
;

1440 
mode
 = 0;

1443 ià(
mode
)

1446 ià(
ı
 && 
n
 != 1)

1448 *
ı
++ = 
c
;

1449 
n
--;

1452 ià(
ı
)

1454 *
ı
++ = 0;

1455 *
‹µ
 = 
ı
;

1456 
	`debug2
("'%s' found iÀexŒa_šÿ°-> %s\n", 
ÿp
, 
‹p
);

1457  
‹p
;

1461 
	}
}

1464 
	$e_tg‘¡r
(
ÿp
, 
‹µ
)

1465 *
ÿp
;

1466 **
‹µ
;

1468 *
‹p
;

1469 ià((
‹p
 = 
	`fšdÿp
(
ÿp
, 
‹µ
, 0)))

1470  (*
‹p
 == '@') ? 0 :ep;

1471  
	`tg‘¡r
(
ÿp
, 
‹µ
);

1472 
	}
}

1475 
	$e_tg‘æag
(
ÿp
)

1476 *
ÿp
;

1478 
buf
[2], *
buå
;

1479 *
‹p
;

1480 
buå
 = 
buf
;

1481 ià((
‹p
 = 
	`fšdÿp
(
ÿp
, &
buå
, 2)))

1482  (*
‹p
 == '@') ? 0 : 1;

1483  
	`tg‘æag
(
ÿp
) > 0;

1484 
	}
}

1487 
	$e_tg‘num
(
ÿp
)

1488 *
ÿp
;

1490 
buf
[20], *
buå
;

1491 *
‹p
, 
c
;

1492 
»s
, 
ba£
 = 10;

1494 
buå
 = 
buf
;

1495 ià((
‹p
 = 
	`fšdÿp
(
ÿp
, &
buå
, 20)))

1497 
c
 = *
‹p
;

1498 ià(
c
 == '@')

1500 ià(
c
 == '0')

1501 
ba£
 = 8;

1502 
»s
 = 0;

1503 (
c
 = *
‹p
++) >= '0' && c <= '9')

1504 
»s
 =„e * 
ba£
 + (
c
 - '0');

1505  
»s
;

1507  
	`tg‘num
(
ÿp
);

1508 
	}
}

	@terminfo/checktc.c

1 
	~<¡dio.h
>

3 *
	gCL
, *
	gCM
, *
	gCS
, *
	gSR
;

4 
	gCO
, 
	gLI
, 
	gAM
, 
	gXN
;

6 *
tg‘¡r
(), *
g‘’v
();

7 
PutSŒ
(), 
CPutSŒ
(), 
CCPutSŒ
(), 
GÙoPos
(), 
RETURN
();

9 
	$maš
()

11 *
‹rm
, *
s
;

12 
tcbuf
[1024];

13 
tc¡r
[1024], *

;

15 ià((
‹rm
 = 
	`g‘’v
("TERM")) == 0)

17 
	`årštf
(
¡d”r
, "No $TERM set\n");

18 
	`ex™
(1);

20 
	`tg‘’t
(
tcbuf
, 
‹rm
))

23 
	`årštf
(
¡d”r
, "Could‚ot openermcap file\n");

24 
	`ex™
(1);

26 
	`årštf
(
¡d”r
, "I dÚ'ˆknow wh©‡ '%s'”mš® is.\n", 
‹rm
);

27 
	`ex™
(1);

29 

 = 
tc¡r
;

30 ià((
CL
 = 
	`tg‘¡r
("ş", &

)) == 0)

32 
	`årštf
(
¡d”r
, "cl capability„equired\n");

33 
	`ex™
(1);

35 ià((
CM
 = 
	`tg‘¡r
("cm", &

)) == 0)

37 
	`årštf
(
¡d”r
, "cm capability„equired\n");

38 
	`ex™
(1);

41 ià((
s
 = 
	`g‘’v
("COLUMNS")))

42 
CO
 = 
	`©oi
(
s
);

43 ià((
s
 = 
	`g‘’v
("LINES")))

44 
LI
 = 
	`©oi
(
s
);

45 ià(
CO
 == 0)

46 
CO
 = 
	`tg‘num
("co");

47 ià(
LI
 == 0)

48 
LI
 = 
	`tg‘num
("li");

49 ià(
CO
 == 0)

50 
CO
 = 80;

51 ià(
LI
 == 0)

52 
LI
 = 24;

53 
	`GÙoPos
(5, 1);

54 
	`´štf
("******* cl capability does‚ot work !!! *******");

55 
	`GÙoPos
(5, 2);

56 
	`PutSŒ
(
CL
);

57 
	`´štf
("******* cl capability does‚ot home cursor *******");

58 
	`GÙoPos
(0, 0);

59 
	`´štf
(" ");

60 
	`GÙoPos
(5, 4);

61 
	`´štf
("******* cm capability does‚ot work !!! *******");

62 
	`GÙoPos
(5, 4);

63 
	`´štf
(" ");

64 
	`GÙoPos
(
CO
/2-12, 
LI
/2);

65 
	`´štf
("Yourerminal size is");

66 
	`GÙoPos
(
CO
/2-3, 
LI
/2+1);

67 
	`´štf
("%dx%d", 
CO
, 
LI
);

68 
	`GÙoPos
(
CO
/2-2, 0);

69 
	`´štf
("top");

70 
	`GÙoPos
(
CO
/2-3, 
LI
-1);

71 
	`´štf
("bottom");

72 
	`GÙoPos
(0, 
LI
/2-2);
	`´štf
("l");

73 
	`GÙoPos
(0, 
LI
/2-1);
	`´štf
("e");

74 
	`GÙoPos
(0, 
LI
/2+0);
	`´štf
("f");

75 
	`GÙoPos
(0, 
LI
/2+1);
	`´štf
("t");

76 
	`GÙoPos
(
CO
-1, 
LI
/2-2);
	`´štf
("r");

77 
	`GÙoPos
(
CO
-1, 
LI
/2-1);
	`´štf
("i");

78 
	`GÙoPos
(
CO
-1, 
LI
/2+0);
	`´štf
("g");

79 
	`GÙoPos
(
CO
-1, 
LI
/2+1);
	`´štf
("h");

80 
	`GÙoPos
(
CO
-1, 
LI
/2+2);
	`´štf
("t");

81 
	`GÙoPos
(
CO
/2-15, 
LI
/2+3);

82 
	`RETURN
();

83 
AM
 = 
	`tg‘æag
("am");

84 
	`´štf
("T”mÿp:”mš® dÛ %§uto-w¿p", 
AM
 ? "" : "not ");

85 
	`GÙoPos
(0, 5);

86 ià(
AM
)

88 
	`´štf
("‡m capability set, buterminal does‚ot wrap");

89 
	`GÙoPos
(
CO
-1, 3);

93 
	`´štf
("‡m capability‚ot set, buterminal does wrap");

94 
	`GÙoPos
(
CO
-1, 4);

96 
	`´štf
(" \n ");

97 
	`GÙoPos
(0, 10);

98 
	`RETURN
();

99 ià(
AM
)

101 
XN
 = 
	`tg‘æag
("xn");

102 
	`´štf
("T”mÿp:”mš® ha %smagiøm¬gšs", 
XN
 ? "" : "no ");

103 
	`GÙoPos
(0, 5);

104 ià((
XN
 = 
	`tg‘æag
("xn")))

106 
	`´štf
(" xn capability set, buterminal has‚o magic-margins");

107 
	`GÙoPos
(
CO
-1, 4);

111 
	`´štf
(" xn capability‚ot set, buterminal has magic-margins");

112 
	`GÙoPos
(
CO
-1, 3);

114 
	`´štf
(" \n");

115 
	`´štf
(" ");

116 
	`GÙoPos
(0, 10);

117 
	`RETURN
();

118 ià(
XN
)

120 
	`GÙoPos
(0, 6);

121 
	`´štf
("†ast col in†ast„ow is‚ot usable");

122 
	`GÙoPos
(
CO
-1, 
LI
-1);

123 
	`´štf
(" ");

124 
	`GÙoPos
(0, 6);

125 
	`´štf
(" ");

126 
	`GÙoPos
(0, 0);

127 
	`´štf
("testing magic margins in†ast„ow");

128 
	`GÙoPos
(0, 10);

129 
	`RETURN
();

132 ià((
CS
 = 
	`tg‘¡r
("cs", &

)))

134 
	`´štf
("Termcap:erminal has scrollregions");

135 
	`GÙoPos
(0, 5);

136 
	`´štf
(" cs capability set, but doesn't work");

137 
	`CCPutSŒ
(
CS
, 4, 5);

138 
	`GÙoPos
(0, 5);

139 
	`´štf
("\n\n");

140 
	`CCPutSŒ
(
CS
, 0, 
LI
-1);

141 
	`GÙoPos
(0, 10);

142 
	`RETURN
();

144 ià((
SR
 = 
	`tg‘¡r
("¤", &

)))

146 
	`GÙoPos
(0, 5);

147 
	`´štf
(" sr capability set, but doesn't work");

148 
	`GÙoPos
(0, 0);

149 
	`PutSŒ
(
SR
);

150 
	`GÙoPos
(0, 6);

151 
	`´štf
(" ");

152 
	`GÙoPos
(0, 0);

153 
	`´štf
("Termcap:erminal can scroll backwards");

154 
	`GÙoPos
(0, 10);

155 
	`RETURN
();

157 
	}
}

160 
	$putcha
(
c
)

161 
c
;

163 
	`putch¬
(
c
);

164 
	}
}

167 
	$PutSŒ
(
s
)

168 *
s
;

170 
	`uts
(
s
, 1, 
putcha
);

171 
	`fæush
(
¡dout
);

172 
	}
}

174 
	$CPutSŒ
(
s
, 
c
)

175 *
s
;

176 
c
;

178 
	`uts
(
	`tgÙo
(
s
, 0, 
c
), 1, 
putcha
);

179 
	`fæush
(
¡dout
);

180 
	}
}

182 
	$CCPutSŒ
(
s
, 
x
, 
y
)

183 *
s
;

184 
x
, 
y
;

186 
	`uts
(
	`tgÙo
(
s
, 
y
, 
x
), 1, 
putcha
);

187 
	`fæush
(
¡dout
);

188 
	}
}

190 
	$GÙoPos
(
x
,
y
)

191 
x
,
y
;

193 
	`uts
(
	`tgÙo
(
CM
, 
x
, 
y
), 1, 
putcha
);

194 
	`fæush
(
¡dout
);

195 
	}
}

198 
	$RETURN
()

200 
	`´štf
("Press <RETURN>o continue");

201 
	`fæush
(
¡dout
);

202 
	`g‘ch¬
() != '\n');

203 
	`PutSŒ
(
CL
);

204 
	}
}

	@terminfo/tetris.c

1 
	gh
[4];
	$t
(){
h
[3]-=h[3]/3000;
	`£t™im”
(0,h,0);
	}

	g}c
,
	gd
,
	gl
,
	gv
[]={()
t
,0,2},
	gw
,
	gs
,
	gI
,
	gK


2 =0,
	gi
=276,
	gj
,
	gk
,
	gq
[276],
	gQ
[276],*
	gn
=
q
,*
	gm
,
	gx
=17,
	gf
[]={7,-13,-12,1,8,-11,-12,-1,9,-1,1,

5 12,17,-13,1,-1,5,-12,12,11,6,-12,12,24};
	$u
(){
i
=11;++i<264;)if((
k
=
q
[i])-
Q
[i]

6 ){
Q
[
i
]=
k
;if(i-++
I
||i%12<1)
	`´štf
("\033[%d;%dH",(I=i)/12,i%12*2+28);printf(

7 "\033[%dm "+(
K
-
k
?0:5),k);K=k;}
Q
[263]=
c
=
	`g‘ch¬
();
	}

	$}G
(
b
){
i
=4;i--;)if(
q
[i?b+

8 
n
[
i
]:
b
]) 0; 1;
	}

	$}g
(
b
){
i
=4;i--;
q
[i?
x
+
n
[i]:x]=b);
	}

	$}maš
(
C
,
V
,
a
)*

9 *
V
,*
a
;{
h
[3]=1000000/(
l
=
C
>1?
	`©oi
(V[1]):2);a=C>2?V[2]:"jkÈpq";
i
;i--)*
n
++=i<

10 25||
i
%12<2?7:0;
	`¤ªd
(
	`g‘pid
());
	`sy¡em
("¡ty cb»ak -echØ¡İ u");
	`sigvec
(14,
v
,

11 0);
	`t
();
	`puts
("\033[H\033[J");
n
=
f
+
	`¿nd
()%7*4;;
	`g
(7),
	`u
(),g(0)){if(
c
<0){if(
	`G
(
x
+

12 12))
x
+=12;{
	`g
(7);++
w
;
j
=0;j<252;j=12*(j/12+1));
q
[++j];)if(j%12==10){

13 ;
j
%12;
q
[j--]=0);
	`u
();;--j;q[j+12]=q[j]);u();}
n
=
f
+
	`¿nd
()%7*4;
	`G
(
x
=17)||(
c


14 =
a
[5]);}}if(
c
==*a)
	`G
(--
x
)||++x;if(c=÷[1])
n
=
f
+4**(
m
ò),G(x)||Ò=m);if(c=÷[2])
G


15 (++
x
)||--x;if(
c
==
a
[3]);
	`G
(x+12);++
w
)x+=12;if(c=÷[4]||c=÷[5]){
s
=
	`sigblock
(

16 8192);
	`´štf
("\033[H\033[J\033[0m%d\n",
w
);if(
c
==
a
[5]);
j
=264;j--;
Q
[j]=

17 0);
	`g‘ch¬
()-
a
[4]);
	`puts
("\033[H\033[J\033[7m");
	`sig£tmask
(
s
);}}
d
=
	`pİ’
(

18 "¡ty -cb»akƒchØ¡İ \023;sÜˆ-mÄ -ØHI - HI;ÿˆHI","w");
	`årštf
(
d
,

19 "%4d from†ev– %1d by %s\n",
w
,
l
,
	`g‘logš
());
	`pşo£
(
d
);
	}
}

	@utmp.c

24 
	~<sys/ty³s.h
>

25 
	~<sys/¡©.h
>

26 
	~<fú.h
>

28 
	~"cÚfig.h
"

29 
	~"sü“n.h
"

30 
	~"ex‹º.h
"

32 #ifdeà
HAVE_UTEMPTER


33 
	~<u‹m±”.h
>

37 
di¥Ïy
 *display;

38 #ifdeà
CAREFULUTMP


39 
wš
 *
wšdows
;

41 
wš
 *
fÜe
;

42 *
LogšName
;

43 
»®_uid
, 
eff_uid
;

55 #ifdeà
UTNOKEEP


56 
	#UT_CLOSE


	)

57 
	#UT_UNSORTED


	)

60 #ifdeà
UT_CLOSE


61 #undeà
UT_CLOSE


62 
	#UT_CLOSE
 
	`’du‹Á
()

	)

64 
	#UT_CLOSE


	)

72 #ià(
defšed
(
sun
è&& defšed(
SVR4
è&& defšed(
GETUTENT
)è|| defšed(
HAVE_UTEMPTER
)

73 
	#UTMP_HELPER


	)

78 #ifdeà
UTMPOK


81 
¦Ù_t
 
TtyNameSlÙ
 
__P
((*));

82 
makeu£r
 
__P
((
utmp
 *, *, *, ));

83 
maked—d
 
__P
((
utmp
 *));

84 
putut¦Ù
 
__P
((
¦Ù_t
, 
utmp
 *, *, 
wš
 *));

85 
utmp
 *
g‘ut¦Ù
 
__P
((
¦Ù_t
));

86 #iâdeà
GETUTENT


87 
utmp
 *
g‘u‹Á
 
__P
(());

88 
’du‹Á
 
__P
(());

89 
š™utmp
 
__P
(());

90 
£tu‹Á
 
__P
(());

92 #ià
defšed
(
lšux
è&& defšed(
GETUTENT
)

93 
utmp
 *
xputuše
 
__P
((utmp *utmp));

94 
	#putuše
 
xputuše


	)

98 
	gutmpok
;

99 
	gUtmpName
[] = 
UTMPFILE
;

100 #iâdeà
UTMP_HELPER


101 
	gutmpfd
 = -1;

105 #ià
defšed
(
GETUTENT
è&& (!defšed(
SVR4
è|| defšed(
__hpux
))

106 #ià
defšed
(
hpux
)

107 
	#putuše
 
_putuše


	)

109 
utmp
 *
g‘uše
(), *
putuše
();

110 #ià
defšed
(
_SEQUENT_
)

111 
utmp
 *
ut_add_u£r
(), *
ut_d–‘e_u£r
();

112 *
ut_fšd_ho¡
();

113 #iâdeà
UTHOST


114 
	#UTHOST


	)

119 #ià!
defšed
(
GETUTENT
è&& !defšed(
UT_UNSORTED
)

120 #ifdeà
GETTTYENT


121 
	~<‰y’t.h
>

123 
	s‰y’t
 { *
	mty_Çme
; };

124 
£‰ty’t
 
__P
(());

125 
‰y’t
 *
g‘‰y’t
 
__P
(());

129 #iâdeà
_SEQUENT_


130 #undeà
D_logšho¡


131 
	#D_logšho¡
 
D_utmp_logš‰y
.
ut_ho¡


	)

133 #iâdeà
UTHOST


134 #undeà
D_logšho¡


135 
	#D_logšho¡
 ((*)0)

	)

153 #iâdeà
UTMPOK


155 
	$SlÙToggË
(
how
)

156 
how
;

158 
	`debug1
("SlÙToggË (!UTMPOKè%d\n", 
how
);

159 #ifdeà
UTMPFILE


160 
	`Msg
(0, "UÇbËØmodify %s.\n", 
UTMPFILE
);

162 
	`Msg
(0, "Unableo modify utmp-database.\n");

164 
	}
}

169 #ifdeà
UTMPOK


172 
	$SlÙToggË
(
how
)

173 
how
;

175 
	`debug1
("SlÙToggË %d\n", 
how
);

176 ià(
fÜe
->
w_ty³
 !ğ
W_TYPE_PTY
)

178 
	`Msg
(0, "Can only work with‚ormal windows.\n");

181 ià(
how
)

183 
	`debug
("ryo†og in\n");

184 ià((
fÜe
->
w_¦Ù
 =ğ(
¦Ù_t
) -1) || (fore->w_slot == (slot_t) 0))

186 #ifdeà
USRLIMIT


187 ià(
	`CouÁU£rs
(è>ğ
USRLIMIT
)

189 
	`Msg
(0, "User†imit„eached.");

193 ià(
	`S‘Utmp
(
fÜe
) == 0)

194 
	`Msg
(0, "This window is‚ow†ogged in.");

196 
	`Msg
(0, "This window should‚ow be†ogged in.");

197 
	`WšdowChªged
(
fÜe
, 'f');

200 
	`Msg
(0, "This window is‡lready†ogged in.");

204 
	`debug
("ryo†og out\n");

205 ià(
fÜe
->
w_¦Ù
 =ğ(
¦Ù_t
) -1)

206 
	`Msg
(0, "This window is‡lready†ogged out\n");

207 ià(
fÜe
->
w_¦Ù
 =ğ(
¦Ù_t
) 0)

209 
	`debug
("What‡„elief! In fact, it was‚ot†ogged in\n");

210 
	`Msg
(0, "This window is‚ot†ogged in.");

211 
fÜe
->
w_¦Ù
 = (
¦Ù_t
) -1;

215 
	`RemoveUtmp
(
fÜe
);

216 ià(
fÜe
->
w_¦Ù
 !ğ(
¦Ù_t
) -1)

217 
	`Msg
(0, "What? Cannot„emove Utmp slot?");

219 
	`Msg
(0, "This window is‚o†onger†ogged in.");

220 #ifdeà
CAREFULUTMP


221 
	`C¬efulUtmp
();

223 
	`WšdowChªged
(
fÜe
, 'f');

226 
	}
}

229 #ifdeà
CAREFULUTMP


235 
	$C¬efulUtmp
()

237 
wš
 *
p
;

239 ià(!
wšdows
)

241 
	`debug
("CarefulUtmp counting slots\n");

242 
p
 = 
wšdows
;…;… =…->
w_Ãxt
)

243 ià(
p
->
w_±yfd
 >ğ0 &&…->
w_¦Ù
 !ğ(
¦Ù_t
)-1)

246 
	`debug
("CarefulUtmp:‚o slots,†og one in‡gain.\n");

247 
p
 = 
wšdows
;…;… =…->
w_Ãxt
)

248 ià(
p
->
w_±yfd
 >= 0)

250 ià(!
p
)

252 
	`S‘Utmp
(
p
);

253 
	`Msg
(0, "Wšdow %d i now†ogged in.\n", 
p
->
w_numb”
);

254 
	}
}

259 
	$In™Utmp
()

261 
	`debug1
("In™Utm°‹¡šg '%s'...\n", 
UtmpName
);

262 #iâdeà
UTMP_HELPER


263 ià((
utmpfd
 = 
	`İ’
(
UtmpName
, 
O_RDWR
)) == -1)

265 ià(
”ºo
 !ğ
EACCES
)

266 
	`Msg
(
”ºo
, 
UtmpName
);

267 
	`debug
("InitUtmp failed.\n");

268 
utmpok
 = 0;

271 #ifdeà
GETUTENT


272 
	`şo£
(
utmpfd
);

273 
utmpfd
 = -1;

276 
utmpok
 = 1;

277 
	}
}

280 #ifdeà
USRLIMIT


282 
	$CouÁU£rs
()

284 
utmp
 *
ut
;

285 
U£rCouÁ
;

287 
	`debug1
("CouÁU£rs(è- utmpok=%d\n", 
utmpok
);

288 ià(!
utmpok
)

290 
U£rCouÁ
 = 0;

291 
	`£tu‹Á
();

292 
ut
 = 
	`g‘u‹Á
())

293 ià(
	`SLOT_USED
(
ut
))

294 
U£rCouÁ
++;

295 
UT_CLOSE
;

296  
U£rCouÁ
;

297 
	}
}

307 
	$RemoveLogšSlÙ
()

309 
utmp
 
u
, *
uu
;

311 
	`ASSERT
(
di¥Ïy
);

312 
	`debug
("RemoveLoginSlot:„emoving your†ogintty\n");

313 
D_logš¦Ù
 = 
	`TtyNameSlÙ
(
D_u£¹ty
);

314 ià(
D_logš¦Ù
 =ğ(
¦Ù_t
)0 || D_loginslot == (slot_t)-1)

316 #ifdeà
UTMP_HELPER


317 ià(
eff_uid
)

319 ià(!
utmpok
)

322 
D_logš¦Ù
 = 0;

323 
	`debug
("RemoveLoginSlot: utmpok == 0\n");

327 #ifdeà
_SEQUENT_


329 *
p
;

330 ià((
p
 = 
	`ut_fšd_ho¡
(
D_logš¦Ù
)) != 0)

331 
	`¡ºıy
(
D_logšho¡
, 
p
, (D_loginhost) - 1);

332 
D_logšho¡
[(D_loginhost) - 1] = 0;

336 ià((
uu
 = 
	`g‘ut¦Ù
(
D_logš¦Ù
)) == 0)

338 
	`debug
("Utmp slot‚ot found ->‚ot„emoved");

339 
D_logš¦Ù
 = 0;

343 
D_utmp_logš‰y
 = *
uu
;

344 
u
 = *
uu
;

345 
	`maked—d
(&
u
);

346 ià(
	`putut¦Ù
(
D_logš¦Ù
, &
u
, (*)0, (
wš
 *)0) == 0)

347 
D_logš¦Ù
 = 0;

349 
UT_CLOSE
;

351 
	`debug1
(" slÙ %d z­³d\n", ()
D_logš¦Ù
);

352 ià(
D_logš¦Ù
 =ğ(
¦Ù_t
)0)

355 
¡©
 
¡b
;

356 *
‰y
;

357 
	`debug
("couln't zap slot -> do mesg‚\n");

358 
D_logš‰ymode
 = 0;

359 ià((
‰y
 = 
	`‰yÇme
(
D_u£rfd
)è&& 
	`¡©
Ñty, &
¡b
è=ğ0 && ()¡b.
¡_uid
 =ğ
»®_uid
 && (()¡b.
¡_mode
 & 0777) != 0666)

361 
D_logš‰ymode
 = ()
¡b
.
¡_mode
 & 0777;

362 
	`chmod
(
D_u£¹ty
, 
¡b
.
¡_mode
 & 0600);

365 
	}
}

371 
	$Re¡ÜeLogšSlÙ
()

373 *
‰y
;

375 
	`debug
("RestoreLoginSlot()\n");

376 
	`ASSERT
(
di¥Ïy
);

377 ià(
utmpok
 && 
D_logš¦Ù
 !ğ(
¦Ù_t
)0 && D_loginslot != (slot_t)-1)

379 
	`debug1
("†oggšg you iÀagaš (¦Ù %#x)\n", ()
D_logš¦Ù
);

380 ià(
	`putut¦Ù
(
D_logš¦Ù
, &
D_utmp_logš‰y
, 
D_logšho¡
, (
wš
 *)0) == 0)

381 
	`Msg
(
”ºo
,"Could‚Ù wr™%s", 
UtmpName
);

383 
UT_CLOSE
;

384 
D_logš¦Ù
 = (
¦Ù_t
)0;

385 ià(
D_logš‰ymode
 && (
‰y
 = 
	`‰yÇme
(
D_u£rfd
)))

386 
	`chmod
(
‰y
, 
D_logš‰ymode
);

387 
	}
}

401 
	$S‘Utmp
(
wi
)

402 
wš
 *
wi
;

404 
¦Ù_t
 
¦Ù
;

405 
utmp
 
u
;

406 
§ved_ut
;

407 #ifdeà
UTHOST


408 *
p
;

409 
ho¡
[(
D_logšho¡
) + 15];

411 *
ho¡
 = 0;

414 
wi
->
w_¦Ù
 = (
¦Ù_t
)0;

415 ià(!
utmpok
 || 
wi
->
w_ty³
 !ğ
W_TYPE_PTY
)

417 ià((
¦Ù
 = 
	`TtyNameSlÙ
(
wi
->
w_‰y
)è=ğ(
¦Ù_t
)0)

419 
	`debug1
("S‘Utm°çed (‰y %s).\n",
wi
->
w_‰y
);

422 
	`debug2
("S‘Utm°%d wÈg‘ slÙ %d...\n", 
wi
->
w_numb”
, ()
¦Ù
);

424 
	`bz”o
((*)&
u
, (u));

425 ià((
§ved_ut
 = 
	`bcmp
((*è&
wi
->
w_§vut
, (*)&
u
, (u))))

427 
	`bcİy
((*)&
wi
->
w_§vut
, (*è&
u
, (u));

429 ià(!
§ved_ut
)

430 
	`makeu£r
(&
u
, 
	`¡rdev
(
wi
->
w_‰y
), 
LogšName
, wi->
w_pid
);

432 #ifdeà
UTHOST


433 
ho¡
[(host) - 15] = '\0';

434 ià(
di¥Ïy
)

436 
	`¡ºıy
(
ho¡
, 
D_logšho¡
, (host) - 15);

437 ià(
D_logš¦Ù
 !ğ(
¦Ù_t
)0 && D_logš¦Ù !ğ(¦Ù_t)-1 && 
ho¡
[0] != '\0')

447 
p
 = 
ho¡
; *p;…++)

448 ià((*
p
 < '0' || *p > '9') && (*p != '.'))

450 ià(*
p
)

452 
p
 = 
ho¡
; *p;…++)

453 ià(*
p
 =ğ'.' || (*°=ğ':' &&… !ğ
ho¡
))

455 *
p
 = '\0';

462 
	`¡ºıy
(
ho¡
 + 1, 
	`¡rdev
(
D_u£¹ty
), (host) - 15 - 1);

463 
ho¡
[0] = ':';

467 
	`¡ºıy
(
ho¡
, "local", (host) - 15);

469 
	`¥rštf
(
ho¡
 + 
	`¡¾’
(ho¡), ":S.%d", 
wi
->
w_numb”
);

470 
	`debug1
("¾ogš ho¡Çme: '%s'\n", 
ho¡
);

472 #ià!
	`defšed
(
_SEQUENT_
è&& !defšed(
£qu’t
)

473 
	`¡ºıy
(
u
.
ut_ho¡
, 
ho¡
, (u.ut_host));

477 ià(
	`putut¦Ù
(
¦Ù
, &
u
, 
ho¡
, 
wi
) == 0)

479 
	`Msg
(
”ºo
,"Could‚Ù wr™%s", 
UtmpName
);

480 
UT_CLOSE
;

483 
	`debug
("SetUtmp successful\n");

484 
wi
->
w_¦Ù
 = 
¦Ù
;

485 
	`bcİy
((*)&
u
, (*)&
wi
->
w_§vut
, (u));

486 
UT_CLOSE
;

488 
	}
}

496 
	$RemoveUtmp
(
wi
)

497 
wš
 *
wi
;

499 
utmp
 
u
, *
uu
;

500 
¦Ù_t
 
¦Ù
;

502 
¦Ù
 = 
wi
->
w_¦Ù
;

503 
	`debug1
("RemoveUtm°¦Ù=%#x\n", 
¦Ù
);

504 ià(!
utmpok
)

506 ià(
¦Ù
 =ğ(
¦Ù_t
)0 || slot == (slot_t)-1)

508 
wi
->
w_¦Ù
 = (
¦Ù_t
)-1;

511 
	`bz”o
((*è&
u
, (u));

512 #ifdeà
sgi


513 
	`bcİy
((*)&
wi
->
w_§vut
, (*)&
u
, (u));

514 
uu
 = &
u
;

516 ià((
uu
 = 
	`g‘ut¦Ù
(
¦Ù
)) == 0)

518 
	`Msg
(0, "Utmp slot‚ot found ->‚ot„emoved");

521 
	`bcİy
((*)
uu
, (*)&
wi
->
w_§vut
, (wi->w_savut));

523 
u
 = *
uu
;

524 
	`maked—d
(&
u
);

525 ià(
	`putut¦Ù
(
¦Ù
, &
u
, (*)0, 
wi
) == 0)

527 
	`Msg
(
”ºo
,"Could‚Ù wr™%s", 
UtmpName
);

528 
UT_CLOSE
;

531 
	`debug
("RemoveUtmp successfull\n");

532 
wi
->
w_¦Ù
 = (
¦Ù_t
)-1;

533 
UT_CLOSE
;

535 
	}
}

544 #ifdeà
GETUTENT


546 
	#SLOT_USED
(
u
è(u->
ut_ty³
 =ğ
USER_PROCESS
)

	)

548 
utmp
 *

549 
	$g‘ut¦Ù
(
¦Ù
)

550 
¦Ù_t
 
¦Ù
;

552 
utmp
 
u
;

553 
	`bz”o
((*)&
u
, (u));

554 
	`¡ºıy
(
u
.
ut_lše
, 
¦Ù
, (u.ut_line));

555 
	`£tu‹Á
();

556  
	`g‘uše
(&
u
);

557 
	}
}

560 
	$putut¦Ù
(
¦Ù
, 
u
, 
ho¡
, 
wi
)

561 
¦Ù_t
 
¦Ù
;

562 
utmp
 *
u
;

563 *
ho¡
;

564 
wš
 *
wi
;

566 #ifdeà
_SEQUENT_


567 ià(
	`SLOT_USED
(
u
è&& 
ho¡
 && *host)

568  
	`ut_add_u£r
(
u
.
ut_Çme
, 
¦Ù
, u.
ut_pid
, 
ho¡
) != 0;

569 ià(!
	`SLOT_USED
(
u
))

570  
	`ut_d–‘e_u£r
(
¦Ù
, 
u
.
ut_pid
, 0, 0) != 0;

572 #ifdeà
HAVE_UTEMPTER


573 ià(
eff_uid
 && 
wi
->
w_±yfd
 != -1)

576 ià(
	`SLOT_USED
(
u
))

577 
	`addToUtmp
(
wi
->
w_‰y
, 
ho¡
, wi->
w_±yfd
);

579 
	`»moveLšeFromUtmp
(
wi
->
w_‰y
, wi->
w_±yfd
);

583 
	`£tu‹Á
();

584  
	`putuše
(
u
) != 0;

585 
	}
}

588 
	$maked—d
(
u
)

589 
utmp
 *
u
;

591 
u
->
ut_ty³
 = 
DEAD_PROCESS
;

592 #ià!
	`defšed
(
lšux
è|| defšed(
EMPTY
)

593 
u
->
ut_ex™
.
e_‹rmš©iÚ
 = 0;

594 
u
->
ut_ex™
.
e_ex™
 = 0;

596 #ià!
	`defšed
(
sun
è|| !defšed(
SVR4
)

597 
u
->
ut_u£r
[0] = 0;

599 
	}
}

602 
	$makeu£r
(
u
, 
lše
, 
u£r
, 
pid
)

603 
utmp
 *
u
;

604 *
lše
, *
u£r
;

605 
pid
;

607 
u
->
ut_ty³
 = 
USER_PROCESS
;

608 
	`¡ºıy
(
u
->
ut_u£r
, 
u£r
, (u->ut_user));

610 #ià
	`defšed
(
sgi
è|| defšed(
lšux
)

611 
	`¡ºıy
(
u
->
ut_id
, 
lše
 + 3, (u->ut_id));

613 #ifdeà
_IBMR2


614 
	`¡ºıy
(
u
->
ut_id
, 
lše
, (u->ut_id));

616 
	`¡ºıy
(
u
->
ut_id
, 
lše
 + 
	`¡¾’
(line) - 2, (u->ut_id));

619 
	`¡ºıy
(
u
->
ut_lše
, 
lše
, (u->ut_line));

620 
u
->
ut_pid
 = 
pid
;

621 ()
	`time
((
time_t
 *)&
u
->
ut_time
);

622 
	}
}

624 
¦Ù_t


625 
	$TtyNameSlÙ
(
Çm
)

626 *
Çm
;

628  
	`¡rdev
(
Çm
);

629 
	}
}

639 
utmp
 
	gu’t
;

641 
	#SLOT_USED
(
u
è(u.
ut_Çme
[0] !ğ0)

	)

644 
	$š™utmp
()

646 ià(
utmpfd
 >= 0)

648  (
utmpfd
 = 
	`İ’
(
UtmpName
, 
O_RDWR
)) >= 0;

649 
	}
}

652 
	$£tu‹Á
()

654 ià(
utmpfd
 >= 0)

655 ()
	`l£ek
(
utmpfd
, (
off_t
)0, 0);

656 
	}
}

659 
	$’du‹Á
()

661 ià(
utmpfd
 >= 0)

662 
	`şo£
(
utmpfd
);

663 
utmpfd
 = -1;

664 
	}
}

666 
utmp
 *

667 
	$g‘u‹Á
()

669 ià(
utmpfd
 < 0 && !
	`š™utmp
())

671 ià(
	`»ad
(
utmpfd
, &
u’t
, (uent)) != (uent))

673  &
u’t
;

674 
	}
}

676 
utmp
 *

677 
	$g‘ut¦Ù
(
¦Ù
)

678 
¦Ù_t
 
¦Ù
;

680 ià(
utmpfd
 < 0 && !
	`š™utmp
())

682 
	`l£ek
(
utmpfd
, (
off_t
)(
¦Ù
 * (
utmp
)), 0);

683 ià(
	`»ad
(
utmpfd
, &
u’t
, (uent)) != (uent))

685  &
u’t
;

686 
	}
}

689 
	$putut¦Ù
(
¦Ù
, 
u
, 
ho¡
, 
wi
)

690 
¦Ù_t
 
¦Ù
;

691 
utmp
 *
u
;

692 *
ho¡
;

693 
wš
 *
wi
;

695 #ifdeà
£qu’t


696 ià(
	`SLOT_USED
(
u
))

697  
	`add_utmp
(
¦Ù
, 
u
) != -1;

699 ià(
utmpfd
 < 0 && !
	`š™utmp
())

701 
	`l£ek
(
utmpfd
, (
off_t
)(
¦Ù
 * (*
u
)), 0);

702 ià(
	`wr™e
(
utmpfd
, 
u
, (*u)) != (*u))

705 
	}
}

709 
	$maked—d
(
u
)

710 
utmp
 *
u
;

712 #ifdeà
UT_UNSORTED


713 
	`bz”o
(
u
->
ut_Çme
, (u->ut_name));

714 #ifdeà
UTHOST


715 
	`bz”o
(
u
->
ut_ho¡
, (u->ut_host));

718 
	`bz”o
((*)
u
, (*u));

720 
	}
}

724 
	$makeu£r
(
u
, 
lše
, 
u£r
, 
pid
)

725 
utmp
 *
u
;

726 *
lše
, *
u£r
;

727 
pid
;

729 
	`¡ºıy
(
u
->
ut_lše
, 
lše
, (u->ut_line));

730 
	`¡ºıy
(
u
->
ut_Çme
, 
u£r
, (u->ut_name));

731 ()
	`time
((
time_t
 *)&
u
->
ut_time
);

732 
	}
}

734 
¦Ù_t


735 
	$TtyNameSlÙ
(
Çm
)

736 *
Çm
;

738 
¦Ù_t
 
¦Ù
;

739 *
lše
;

740 #iâdeà
UT_UNSORTED


741 
‰y’t
 *

;

744 
lše
 = 
	`¡rdev
(
Çm
);

745 #ifdeà
UT_UNSORTED


746 
	`£tu‹Á
();

747 ià(
utmpfd
 < 0)

749 
¦Ù
 = 0; 
	`g‘u‹Á
(); slot++)

750 ià(
	`¡rcmp
(
u’t
.
ut_lše
, 
lše
) == 0)

752 
UT_CLOSE
;

754 
¦Ù
 = 1;

755 
	`£‰ty’t
();

756 (

 = 
	`g‘‰y’t
()è!ğ0 && 
	`¡rcmp
(
lše
,p->
ty_Çme
) != 0)

757 
¦Ù
++;

759  
¦Ù
;

760 
	}
}

771 #ià!
defšed
(
GETTTYENT
è&& !defšed(
GETUTENT
è&& !defšed(
UT_UNSORTED
)

774 *
	g‰
, *
	g‰Ãxt
;

775 
	g‰ys
[] = "/etc/ttys";

778 
	$£‰ty’t
()

780 ià(
‰Ãxt
 == 0)

782 
¡©
 
s
;

783 
f
;

784 *
p
, *
•
;

786 ià((
f
 = 
	`İ’
(
‰ys
, 
O_RDONLY
)è=ğ-1 || 
	`f¡©
(f, &
s
) == -1)

787 
	`Pªic
(
”ºo
, 
‰ys
);

788 ià((
‰
 = 
	`m®loc
((è
s
.
¡_size
 + 1)) == 0)

789 
	`Pªic
(0, 
¡ºomem
);

790 ià(
	`»ad
(
f
, 
‰
, 
s
.
¡_size
) != s.st_size)

791 
	`Pªic
(
”ºo
, 
‰ys
);

792 
	`şo£
(
f
);

793 
p
 = 
‰
, 
•
 =… + 
s
.
¡_size
;… <ƒp;…++)

794 ià(*
p
 == '\n')

795 *
p
 = '\0';

796 *
p
 = '\0';

798 
‰Ãxt
 = 
‰
;

799 
	}
}

801 
‰y’t
 *

802 
	$g‘‰y’t
()

804 
‰y’t
 
t
;

806 ià(*
‰Ãxt
 == '\0')

807  
NULL
;

808 
t
.
ty_Çme
 = 
‰Ãxt
 + 2;

809 
‰Ãxt
 +ğ
	`¡¾’
(ttnext) + 1;

810  &
t
;

811 
	}
}

827 #ià
defšed
(
BUGGYGETLOGIN
è&& defšed(
UTMP_FILE
)

829 
	$g‘logš
()

831 *
‰y
 = 
NULL
;

832 #ifdeà
utmp


833 #undeà
utmp


835 
utmp
 
u
;

836 
»tbuf
[(
u
.
ut_u£r
)+1];

837 
fd
;

839 
fd
 = 0; fd <ğ2 && (
‰y
 = 
	`‰yÇme
(fd)è=ğ
NULL
; fd++)

841 ià((
‰y
 =ğ
NULL
è|| ((
fd
 = 
	`İ’
(
UTMP_FILE
, 
O_RDONLY
)) < 0))

842  
NULL
;

843 
‰y
 = 
	`¡rdev
(tty);

844 
»tbuf
[0] = '\0';

845 
	`»ad
(
fd
, (*)&
u
, (
utmp
)) == (utmp))

847 ià(!
	`¡ºcmp
(
‰y
, 
u
.
ut_lše
, (u.ut_line)))

849 
	`¡ºıy
(
»tbuf
, 
u
.
ut_u£r
, (u.ut_user));

850 
»tbuf
[(
u
.
ut_u£r
)] = '\0';

851 ià(
u
.
ut_ty³
 =ğ
USER_PROCESS
)

855 
	`şo£
(
fd
);

857  *
»tbuf
 ?„‘buà: 
NULL
;

858 
	}
}

861 #ià
defšed
(
lšux
è&& defšed(
GETUTENT
)

862 #undeà
putuše


865 
utmp
 *

866 
	$xputuše
(
u
)

867 
utmp
 *
u
;

869 
utmp
 *
u2
;

870 
	`putuše
(
u
);

871 
	`£tu‹Á
();

872 
u2
 = 
	`g‘uše
(
u
);

873 ià(
u2
 == 0)

874  
u
->
ut_ty³
 =ğ
DEAD_PROCESS
 ? u : 0;

875  
u
->
ut_ty³
 =ğ
u2
->ut_type ? u : 0;

876 
	}
}

	@window.c

24 
	~<sys/ty³s.h
>

25 
	~<sys/¡©.h
>

26 
	~<sigÇl.h
>

27 
	~<fú.h
>

28 #iâdeà
sun


29 
	~<sys/ioùl.h
>

32 
	~"cÚfig.h
"

34 
	~"sü“n.h
"

35 
	~"ex‹º.h
"

36 
	~"logfe.h
"

38 
di¥Ïy
 *
di¥Ïys
, *display;

39 
wš
 *
wšdows
, *
fÜe
, *
wb
[], *
cÚsŞe_wšdow
;

40 *
Sh–lArgs
[];

41 *
Sh–lProg
;

42 
sü“Á”m
[];

43 *
sü“Æogfe
;

44 
Ho¡Name
[];

45 
TtyMode
;

46 
S’ûWa™
;

47 
»®_uid
, 
»®_gid
, 
eff_uid
, 
eff_gid
;

48 
T”mÿp
[];

49 **
NewEnv
;

50 
visu®_b–l
, 
maxwš
;

51 
ev’t
 
logæushev
;

52 
log_æush
, 
logt¡amp_aá”
;

53 
Zomb›Key_de¡roy
, 
Zomb›Key_»su¼eù
;

54 
Ïy”
 *
æay”
;

55 
maxu£rcouÁ
;

56 
±y_´eİ’
;

57 #ifdeà
ZMODEM


58 
zmodem_mode
;

59 
mch¬
 
mch¬_bÏnk
;

60 *
zmodem_£ndcmd
;

61 *
zmodem_»cvcmd
;

64 #ià
defšed
(
TIOCSWINSZ
è|| defšed(
TIOCGWINSZ
)

65 
wšsize
 
glwz
;

68 #ifdeà
O_NOCTTY


69 
£·¿‹_sids
;

72 
WšProûss
 
__P
((**, *));

73 
WšRedi¥ÏyLše
 
__P
((, , , ));

74 
WšCË¬Lše
 
__P
((, , , ));

75 
WšRewr™e
 
__P
((, , , 
mch¬
 *, ));

76 
WšResize
 
__P
((, ));

77 
WšRe¡Üe
 
__P
(());

78 
DoAutŞf
 
__P
((*, *, ));

79 
Zomb›Proûss
 
__P
((**, *));

80 
wš_»adev_â
 
__P
((
ev’t
 *, *));

81 
wš_wr™“v_â
 
__P
((
ev’t
 *, *));

82 
much³ndšg
 
__P
((
wš
 *, 
ev’t
 *));

83 #ifdeà
COPY_PASTE


84 
·¡e_¦owev_â
 
__P
((
ev’t
 *, *));

86 #ifdeà
PSEUDOS


87 
p£u_»adev_â
 
__P
((
ev’t
 *, *));

88 
p£u_wr™“v_â
 
__P
((
ev’t
 *, *));

90 
wš_s’ûev_â
 
__P
((
ev’t
 *, *));

92 
O³nDeviû
 
__P
((**, , *, **));

93 
FÜkWšdow
 
__P
((
wš
 *, **, *));

94 #ifdeà
ZMODEM


95 
zmodem_found
 
__P
((
wš
 *, , *, ));

96 
zmodem_fš
 
__P
((*, , *));

97 
zmodem_·r£
 
__P
((
wš
 *, *, ));

102 
	gV”bo£C»©e
 = 0;

104 
	gDeçuÉSh–l
[] = "/bin/sh";

105 
	gDeçuÉP©h
[] = ":/usr/ucb:/bin:/usr/bin";

108 
NewWšdow
 
	gnwš_undef
 =

133 
NewWšdow
 
	gnwš_deçuÉ
 =

137 
Sh–lArgs
,

139 
sü“Á”m
,

141 1*
FLOW_NOW
,

142 
LOGINDEFAULT
,

143 
DEFAULTHISTHEIGHT
,

144 
MON_OFF
,

145 
WLOCK_OFF
,

158 
NewWšdow
 
	gnwš_İtiÚs
;

160 
	gcÚ¡_IOSIZE
 = 
IOSIZE
;

161 
	gcÚ¡_Úe
 = 1;

164 
	$nwš_compo£
(
def
, 
Ãw
, 
»s
)

165 
NewWšdow
 *
def
, *
Ãw
, *
»s
;

167 
	#COMPOSE
(
x
è
»s
->x = 
Ãw
->x !ğ
nwš_undef
.x ?‚ew->x : 
def
->
	)
x

168 
	`COMPOSE
(
S¹At
);

169 
	`COMPOSE
(
aka
);

170 
	`COMPOSE
(
¬gs
);

171 
	`COMPOSE
(
dœ
);

172 
	`COMPOSE
(
‹rm
);

173 
	`COMPOSE
(
aæag
);

174 
	`COMPOSE
(
æowæag
);

175 
	`COMPOSE
(
læag
);

176 
	`COMPOSE
(
hi¡height
);

177 
	`COMPOSE
(
mÚ™Ü
);

178 
	`COMPOSE
(
wlock
);

179 
	`COMPOSE
(
s’û
);

180 
	`COMPOSE
(
w¿p
);

181 
	`COMPOSE
(
Læag
);

182 
	`COMPOSE
(
¦ow
);

183 
	`COMPOSE
(
gr
);

184 
	`COMPOSE
(
c1
);

185 
	`COMPOSE
(
bû
);

186 
	`COMPOSE
(
’codšg
);

187 
	`COMPOSE
(
h¡©us
);

188 
	`COMPOSE
(
ch¬£t
);

189 #undeà
COMPOSE


190 
	}
}

197 
LayFuncs
 
	gWšLf
 =

199 
WšProûss
,

201 
WšRedi¥ÏyLše
,

202 
WšCË¬Lše
,

203 
WšRewr™e
,

204 
WšResize
,

205 
WšRe¡Üe


209 
	$DoAutŞf
(
buf
, 
ËÅ
, 
ä
)

210 *
buf
;

211 *
ËÅ
;

212 
ä
;

214 *
p
;

215 
Ën
 = *
ËÅ
;

216 
Œunc
 = 0;

218 
p
 = 
buf
; 
Ën
 > 0;…++,†en--)

220 ià(*
p
 != '\r')

222 ià(
ä
-- <= 0)

224 
Œunc
++;

225 
Ën
--;

227 ià(
Ën
 == 0)

229 
	`bcİy
(
p
,… + 1, 
Ën
++);

230 
p
[1] = '\n';

232 *
ËÅ
 = 
p
 - 
buf
;

233  
Œunc
;

234 
	}
}

237 
	$WšProûss
(
buåp
, 
ËÅ
)

238 **
buåp
;

239 *
ËÅ
;

241 
l2
 = 0, 
f
, *
’
, 
l
 = *
ËÅ
, 
Œunc
;

242 *
ibuf
;

244 
	`debug1
("WšProûss: %d by‹s\n", *
ËÅ
);

245 
fÜe
 = (
wš
 *)
æay”
->
l_d©a
;

247 ià(
fÜe
->
w_±yfd
 < 0)

249 
	`Zomb›Proûss
(
buåp
, 
ËÅ
);

252 #ifdeà
MULTIUSER


257 ià(
di¥Ïy
 && 
fÜe
->
w_wlock
 =ğ
WLOCK_AUTO
 &&

258 !
fÜe
->
w_wlocku£r
 && !
	`AşCheckP”mWš
(
D_u£r
, 
ACL_WRITE
, fore))

260 
fÜe
->
w_wlocku£r
 = 
D_u£r
;

261 
	`debug2
("window %d:…ending writelock grabbed by user %s\n",

262 
fÜe
->
w_numb”
, fÜe->
w_wlocku£r
->
u_Çme
);

265 ià(
di¥Ïy
 && ((
fÜe
->
w_wlock
 =ğ
WLOCK_OFF
) ?

266 
	`AşCheckP”mWš
(
D_u£r
, 
ACL_WRITE
, 
fÜe
) :

267 (
D_u£r
 !ğ
fÜe
->
w_wlocku£r
)))

269 
	`debug2
("wšdow %d, u£¸%s: ", 
fÜe
->
w_numb”
, 
D_u£r
->
u_Çme
);

270 
	`debug2
("wr™–ock %d (wlocku£¸%s)\n", 
fÜe
->
w_wlock
,

271 
fÜe
->
w_wlocku£r
 ? fÜe->w_wlocku£r->
u_Çme
 : "NULL");

273 
	`WB–l
(
fÜe
, 
visu®_b–l
);

274 *
buåp
 +ğ*
ËÅ
;

275 *
ËÅ
 = 0;

280 #ifdeà
BUILTIN_TELNET


281 ià(
fÜe
->
w_ty³
 =ğ
W_TYPE_TELNET
 && 
	`T–I¦še
(fÜeè&& *
buåp
 !ğfÜe->
w_‹lbuf
)

283 
	`T–ProûssLše
(
buåp
, 
ËÅ
);

288 #ifdeà
PSEUDOS


289 ià(
	`W_UWP
(
fÜe
))

292 
ibuf
 = 
fÜe
->
w_pwš
->
p_šbuf
; 
’
 = &fÜe->w_pwš->
p_šËn
;

293 
f
 = (
fÜe
->
w_pwš
->
p_šbuf
è- *
’
;

299 
ibuf
 = 
fÜe
->
w_šbuf
; 
’
 = &fÜe->
w_šËn
;

300 
f
 = (
fÜe
->
w_šbuf
è- *
’
;

303 ià(
l
 > 
f
)

304 
l
 = 
f
;

305 #ifdeà
BUILTIN_TELNET


306 
l
 > 0)

308 ià(
l
 > 0)

311 
l2
 = 
l
;

312 
	`bcİy
(*
buåp
, 
ibuf
 + *
’
, 
l2
);

313 ià(
fÜe
->
w_autŞf
 && (
Œunc
 = 
	`DoAutŞf
(
ibuf
 + *
’
, &
l2
, 
f
 -†2)))

314 
l
 -ğ
Œunc
;

315 #ifdeà
BUILTIN_TELNET


316 ià(
fÜe
->
w_ty³
 =ğ
W_TYPE_TELNET
 && (
Œunc
 = 
	`DoT–Ãt
(
ibuf
 + *
’
, &
l2
, 
f
 -†2)))

318 
l
 -ğ
Œunc
;

319 ià(
fÜe
->
w_autŞf
)

323 *
’
 +ğ
l2
;

324 *
buåp
 +ğ
l
;

325 *
ËÅ
 -ğ
l
;

328 
	}
}

331 
	$Zomb›Proûss
(
buåp
, 
ËÅ
)

332 **
buåp
;

333 *
ËÅ
;

335 
l
 = *
ËÅ
;

336 *
buf
 = *
buåp
, 
b1
[10], 
b2
[10];

338 
	`debug1
("Zomb›Proûss: %d by‹s\n", *
ËÅ
);

339 
fÜe
 = (
wš
 *)
æay”
->
l_d©a
;

341 
	`ASSERT
(
fÜe
->
w_±yfd
 < 0);

342 *
buåp
 +ğ*
ËÅ
;

343 *
ËÅ
 = 0;

344 ; 
l
-- > 0; 
buf
++)

346 ià(*(*)
buf
 =ğ
Zomb›Key_de¡roy
)

348 
	`debug1
("Tuºšg und—d: %d\n", 
fÜe
->
w_numb”
);

349 
	`KlWšdow
(
fÜe
);

352 ià(*(*)
buf
 =ğ
Zomb›Key_»su¼eù
)

354 
	`debug1
("Resu¼eùšg Zomb›: %d\n", 
fÜe
->
w_numb”
);

355 
	`Wr™eSŒšg
(
fÜe
, "\r\n", 2);

356 
	`RemakeWšdow
(
fÜe
);

360 
b1
[
	`AddXCh¬
(b1, 
Zomb›Key_de¡roy
)] = '\0';

361 
b2
[
	`AddXCh¬
(b2, 
Zomb›Key_»su¼eù
)] = '\0';

362 
	`Msg
(0, "P»s % tØde¡roy o¸% tØ»su¼eù wšdow", 
b1
, 
b2
);

363 
	}
}

366 
	$WšRedi¥ÏyLše
(
y
, 
äom
, 
to
, 
isbÏnk
)

367 
y
, 
äom
, 
to
, 
isbÏnk
;

369 
	`debug3
("WšRedi¥ÏyLš%d %d %d\n", 
y
, 
äom
, 
to
);

370 ià(
y
 < 0)

372 
fÜe
 = (
wš
 *)
æay”
->
l_d©a
;

373 ià(
äom
 =ğ0 && 
y
 > 0 && 
fÜe
->
w_mlšes
[y - 1].
image
[fÜe->
w_width
] == 0)

374 
	`LCDi¥ÏyLšeW¿p
(&
fÜe
->
w_Ïy”
, &fÜe->
w_mlšes
[
y
], y, 
äom
, 
to
, 
isbÏnk
);

376 
	`LCDi¥ÏyLše
(&
fÜe
->
w_Ïy”
, &fÜe->
w_mlšes
[
y
], y, 
äom
, 
to
, 
isbÏnk
);

377 
	}
}

380 
	$WšRewr™e
(
y
, 
x1
, 
x2
, 
»nd
, 
do™
)

381 
y
, 
x1
, 
x2
, 
do™
;

382 
mch¬
 *
»nd
;

384 
co¡
, 
dx
;

385 *
p
, *
i
;

386 #ifdeà
FONT


387 *
f
;

389 #ifdeà
COLOR


390 *
c
;

391 #ifdeà
COLORS256


392 *
cx
;

396 
	`debug3
("WšRewr™%d, %d-%d\n", 
y
, 
x1
, 
x2
);

397 
fÜe
 = (
wš
 *)
æay”
->
l_d©a
;

398 
dx
 = 
x2
 - 
x1
 + 1;

399 ià(
do™
)

401 
i
 = 
fÜe
->
w_mlšes
[
y
].
image
 + 
x1
;

402 
dx
-- > 0)

403 
	`PUTCHAR
(*
i
++);

406 
p
 = 
fÜe
->
w_mlšes
[
y
].
©Œ
 + 
x1
;

407 #ifdeà
FONT


408 
f
 = 
fÜe
->
w_mlšes
[
y
].
fÚt
 + 
x1
;

409 #ifdeà
DW_CHARS


410 ià(
	`is_dw_fÚt
(
»nd
->
fÚt
))

411  
EXPENSIVE
;

413 #ifdeà
UTF8


414 ià(
fÜe
->
w_’codšg
 && fÜe->w_’codšg !ğ
UTF8
 && 
D_’codšg
 =ğUTF8 && 
	`CÚšsS³cŸlDeffÚt
(fÜe->
w_mlšes
 + 
y
, 
x1
, 
x2
, fore->w_encoding))

415  
EXPENSIVE
;

418 #ifdeà
COLOR


419 
c
 = 
fÜe
->
w_mlšes
[
y
].
cŞÜ
 + 
x1
;

420 #ifdeà
COLORS256


421 
cx
 = 
fÜe
->
w_mlšes
[
y
].
cŞÜx
 + 
x1
;

425 
co¡
 = 
dx
 = 
x2
 - 
x1
 + 1;

426 
dx
-- > 0)

428 ià(*
p
++ !ğ
»nd
->
©Œ
)

429  
EXPENSIVE
;

430 #ifdeà
FONT


431 ià(*
f
++ !ğ
»nd
->
fÚt
)

432  
EXPENSIVE
;

434 #ifdeà
COLOR


435 ià(*
c
++ !ğ
»nd
->
cŞÜ
)

436  
EXPENSIVE
;

437 #ifdeà
COLORS256


438 ià(*
cx
++ !ğ
»nd
->
cŞÜx
)

439  
EXPENSIVE
;

443  
co¡
;

444 
	}
}

447 
	$WšCË¬Lše
(
y
, 
xs
, 
xe
, 
bû
)

448 
y
, 
xs
, 
xe
, 
bû
;

450 
fÜe
 = (
wš
 *)
æay”
->
l_d©a
;

451 
	`debug3
("WšCË¬Lš%d %d-%d\n", 
y
, 
xs
, 
xe
);

452 
	`LCË¬Lše
(
æay”
, 
y
, 
xs
, 
xe
, 
bû
, &
fÜe
->
w_mlšes
[y]);

453 
	}
}

456 
	$WšResize
(
wi
, 
he
)

457 
wi
, 
he
;

459 
fÜe
 = (
wš
 *)
æay”
->
l_d©a
;

460 
	`ChªgeWšdowSize
(
fÜe
, 
wi
, 
he
, fÜe->
w_hi¡height
);

462 
	}
}

465 
	$WšRe¡Üe
()

467 
ÿnvas
 *
cv
;

468 
fÜe
 = (
wš
 *)
æay”
->
l_d©a
;

469 
	`debug1
("WšRe¡Üe: wš %x\n", 
fÜe
);

470 
cv
 = 
æay”
->
l_cvli¡
; cv; cv = cv->
c_Ãxt
)

472 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

473 ià(
cv
 !ğ
D_fÜecv
)

476 
	`Key·dMode
(
fÜe
->
w_key·d
);

477 
	`CursÜkeysMode
(
fÜe
->
w_cursÜkeys
);

478 
	`S‘Flow
(
fÜe
->
w_æow
 & 
FLOW_NOW
);

479 
	`In£¹Mode
(
fÜe
->
w_š£¹
);

480 
	`Rev”£Video
(
fÜe
->
w_»vvid
);

481 
	`CursÜVisib™y
(
fÜe
->
w_curšv
 ? -1 : fÜe->
w_curvvis
);

482 
	`Mou£Mode
(
fÜe
->
w_mou£
);

484 
	}
}

496 
	$DoS¹Log
(
w
, 
buf
, 
bufsize
)

497 
wš
 *
w
;

498 *
buf
;

499 
bufsize
;

501 
n
;

502 ià(!
w
 || !
buf
)

505 
	`¡ºıy
(
buf
, 
	`MakeWšMsg
(
sü“Æogfe
, 
w
, '%'), 
bufsize
 - 1);

506 
buf
[
bufsize
 - 1] = 0;

508 
	`debug2
("DoS¹Log: wš %d, f%s\n", 
w
->
w_numb”
, 
buf
);

510 ià(
w
->
w_log
 !ğ
NULL
)

511 
	`logfşo£
(
w
->
w_log
);

513 ià((
w
->
w_log
 = 
	`logfİ’
(
buf
, 
	`i¦ogfe
(bufè? 
NULL
 : 
	`£cfİ’
(buf, "a"))) == NULL)

515 ià(!
logæushev
.
queued
)

517 
n
 = 
log_æush
 ?†og_æush : (
logt¡amp_aá”
 + 4) / 5;

518 ià(
n
)

520 
	`S‘Timeout
(&
logæushev
, 
n
 * 1000);

521 
	`ev’q
(&
logæushev
);

525 
	}
}

532 
	$MakeWšdow
(
Ãwwš
)

533 
NewWšdow
 *
Ãwwš
;

535 
wš
 **
µ
, *
p
;

536 
n
, 
i
;

537 
f
 = -1;

538 
NewWšdow
 
nwš
;

539 
ty³
, 
¡¬t
;

540 *
TtyName
;

541 #ifdeà
MULTIUSER


542 
aşu£r
 *
u£rs
;

545 
	`debug1
("NewWšdow: S¹Aˆ%d\n", 
Ãwwš
->
S¹At
);

546 
	`debug1
("NewWšdow:‡k¨ %s\n", 
Ãwwš
->
aka
?newwin->aka:"NULL");

547 
	`debug1
("NewWšdow: dœ %s\n", 
Ãwwš
->
dœ
?newwin->dir:"NULL");

548 
	`debug1
("NewWšdow:”m %s\n", 
Ãwwš
->
‹rm
?newwin->term:"NULL");

550 
	`nwš_compo£
(&
nwš_deçuÉ
, 
Ãwwš
, &
nwš
);

551 
	`debug1
("NWš:‡k¨ %s\n", 
nwš
.
aka
 ?‚win.aka : "NULL");

552 
	`debug1
("NWš: wlock %d\n", 
nwš
.
wlock
);

553 
	`debug1
("NWš: Læag %d\n", 
nwš
.
Læag
);

555 
¡¬t
 = 
nwš
.
S¹At
 < 
maxwš
 ?‚win.StartAt : 0;

556 
µ
 = 
wb
 + 
¡¬t
;

560 ià(*
µ
 == 0)

562 ià(++
µ
 =ğ
wb
 + 
maxwš
)

563 
µ
 = 
wb
;

565 
µ
 !ğ
wb
 + 
¡¬t
);

566 ià(*
µ
)

568 
	`Msg
(0, "No more windows.");

572 #ià
	`defšed
(
USRLIMIT
è&& defšed(
UTMPOK
)

576 ià(
nwš
.
læag
 && 
	`CouÁU£rs
(è>ğ
USRLIMIT
)

578 
	`Msg
(0, "User†imit„eached. Window will‚ot be†ogged in.");

579 
nwš
.
læag
 = 0;

582 
n
 = 
µ
 - 
wb
;

583 
	`debug1
("Makewš c»©šg %d\n", 
n
);

585 ià((
f
 = 
	`O³nDeviû
(
nwš
.
¬gs
,‚wš.
læag
, &
ty³
, &
TtyName
)) < 0)

588 ià((
p
 = (
wš
 *)
	`m®loc
((win))) == 0)

590 
	`şo£
(
f
);

591 
	`Msg
(0, 
¡ºomem
);

594 
	`bz”o
((*)
p
, ()(
wš
));

596 #ifdeà
UTMPOK


597 ià(
ty³
 !ğ
W_TYPE_PTY
)

598 
nwš
.
læag
 = 0;

601 
p
->
w_ty³
 = 
ty³
;

604 
i
 = 0; 
nwš
.
¬gs
[i] && i < 
MAXARGS
 - 1; i++)

605 
p
->
w_cmd¬gs
[
i
] = 
	`SaveSŒ
(
nwš
.
¬gs
[i]);

606 
p
->
w_cmd¬gs
[
i
] = 0;

607 ià(
nwš
.
dœ
)

608 
p
->
w_dœ
 = 
	`SaveSŒ
(
nwš
.
dœ
);

609 ià(
nwš
.
‹rm
)

610 
p
->
w_‹rm
 = 
	`SaveSŒ
(
nwš
.
‹rm
);

612 
p
->
w_numb”
 = 
n
;

613 #ifdeà
MULTIUSER


619 ià(
	`NewWšdowAş
(
p
, 
di¥Ïy
 ? 
D_u£r
 : 
u£rs
))

621 
	`ä“
((*)
p
);

622 
	`şo£
(
f
);

623 
	`Msg
(0, 
¡ºomem
);

627 
p
->
w_Ïy”
.
l_Ãxt
 = 0;

628 
p
->
w_Ïy”
.
l_bÙtom
 = &p->w_layer;

629 
p
->
w_Ïy”
.
l_Ïyâ
 = &
WšLf
;

630 
p
->
w_Ïy”
.
l_d©a
 = (*)p;

631 
p
->
w_§v–ay”
 = &p->
w_Ïy”
;

632 
p
->
w_pdi¥Ïy
 = 0;

633 
p
->
w_Ï¡di¥
 = 0;

635 #ifdeà
MULTIUSER


636 ià(
di¥Ïy
 && !
	`AşCheckP”mWš
(
D_u£r
, 
ACL_WRITE
, 
p
))

637 
p
->
w_wlocku£r
 = 
D_u£r
;

638 
p
->
w_wlock
 = 
nwš
.
wlock
;

640 
p
->
w_±yfd
 = 
f
;

641 
p
->
w_aæag
 = 
nwš
.
aæag
;

642 
p
->
w_æow
 = 
nwš
.
æowæag
 | (Òwš.æowæag & 
FLOW_AUTOFLAG
è? (
FLOW_AUTO
|
FLOW_NOW
) : FLOW_AUTO);

643 ià(!
nwš
.
aka
)

644 
nwš
.
aka
 = 
	`F’ame
Òwš.
¬gs
[0]);

645 
	`¡ºıy
(
p
->
w_akabuf
, 
nwš
.
aka
, (p->w_akabuf) - 1);

646 ià((
nwš
.
aka
 = 
	`ršdex
(
p
->
w_akabuf
, '|')è!ğ
NULL
)

648 
p
->
w_autßka
 = 0;

649 *
nwš
.
aka
++ = 0;

650 
p
->
w_t™Ë
 = 
nwš
.
aka
;

651 
p
->
w_akachªge
 = 
nwš
.
aka
 + 
	`¡¾’
(nwin.aka);

654 
p
->
w_t™Ë
 =…->
w_akachªge
 =…->
w_akabuf
;

655 ià(
nwš
.
h¡©us
)

656 
p
->
w_h¡©us
 = 
	`SaveSŒ
(
nwš
.
h¡©us
);

657 
p
->
w_mÚ™Ü
 = 
nwš
.
mÚ™Ü
;

658 #ifdeà
MULTIUSER


659 ià(
p
->
w_mÚ™Ü
 =ğ
MON_ON
)

662 
i
 = 0; i < 
maxu£rcouÁ
; i++)

663 
	`ACLBYTE
(
p
->
w_mÚ_nÙify
, 
i
è|ğ
	`ACLBIT
(i);

669 
p
->
w_s’û
 = 
nwš
.
s’û
;

670 
p
->
w_s’ûwa™
 = 
S’ûWa™
;

671 #ifdeà
MULTIUSER


672 ià(
p
->
w_s’û
 =ğ
SILENCE_ON
)

675 
i
 = 0; i < 
maxu£rcouÁ
; i++)

676 
	`ACLBYTE
(
p
->
w_lio_nÙify
, 
i
è|ğ
	`ACLBIT
(i);

679 #ifdeà
COPY_PASTE


680 
p
->
w_¦ow·¡e
 = 
nwš
.
¦ow
;

682 
nwš
.
hi¡height
 = 0;

685 
p
->
w_nÜeäesh
 = 0;

686 
	`¡ºıy
(
p
->
w_‰y
, 
TtyName
, 
MAXSTR
 - 1);

690 ià(
	`ChªgeWšdowSize
(
p
, 
di¥Ïy
 ? 
D_defwidth
 : 80,

691 
di¥Ïy
 ? 
D_defheight
 : 24,

692 
nwš
.
hi¡height
))

694 
	`F»eWšdow
(
p
);

698 ià(
	`ChªgeWšdowSize
(
p
, 
di¥Ïy
 ? 
D_fÜecv
->
c_xe
 - D_fÜecv->
c_xs
 + 1: 80,

699 
di¥Ïy
 ? 
D_fÜecv
->
c_ye
 - D_fÜecv->
c_ys
 + 1 : 24,

700 
nwš
.
hi¡height
))

702 
	`F»eWšdow
(
p
);

707 
p
->
w_’codšg
 = 
nwš
.
’codšg
;

708 
	`Re£tWšdow
(
p
);

710 #ifdeà
FONT


711 ià(
nwš
.
ch¬£t
)

712 
	`S‘Ch¬£ts
(
p
, 
nwš
.
ch¬£t
);

715 ià(
V”bo£C»©e
)

717 
di¥Ïy
 *
d
 = display;

719 
	`Wr™eSŒšg
(
p
, ":screen (", 9);

720 
	`Wr™eSŒšg
(
p
,…->
w_t™Ë
, 
	`¡¾’
(p->w_title));

721 
	`Wr™eSŒšg
(
p
, "):", 2);

722 
f
 = 0; 
p
->
w_cmd¬gs
[f]; f++)

724 
	`Wr™eSŒšg
(
p
, " ", 1);

725 
	`Wr™eSŒšg
(
p
,…->
w_cmd¬gs
[
f
], 
	`¡¾’
(p->w_cmdargs[f]));

727 
	`Wr™eSŒšg
(
p
, "\r\n", 2);

728 
di¥Ïy
 = 
d
;

731 
p
->
w_pid
 = 0;

732 #ifdeà
PSEUDOS


733 
p
->
w_pwš
 = 0;

736 #ifdeà
BUILTIN_TELNET


737 ià(
ty³
 =ğ
W_TYPE_TELNET
)

739 ià(
	`T–CÚÃù
(
p
))

741 
	`F»eWšdow
(
p
);

747 ià(
ty³
 =ğ
W_TYPE_PTY
)

749 
p
->
w_pid
 = 
	`FÜkWšdow
Õ, 
nwš
.
¬gs
, 
TtyName
);

750 ià(
p
->
w_pid
 < 0)

752 
	`F»eWšdow
(
p
);

760 ià(
di¥Ïy
 && 
D_fÜe
)

761 
D_Ùh”
 = 
D_fÜe
;

762 *
µ
 = 
p
;

763 
p
->
w_Ãxt
 = 
wšdows
;

764 
wšdows
 = 
p
;

765 
p
->
w_læag
 = 
nwš
.
læag
;

766 #ifdeà
UTMPOK


767 
p
->
w_¦Ù
 = (
¦Ù_t
)-1;

768 #ifdeà
LOGOUTOK


769 
	`debug1
("MakeWšdow wÈ%¦og in.\n", 
nwš
.
læag
?"":"not ");

770 ià(
nwš
.
læag
 & 1)

772 
	`debug1
("MakeWindow will†og in, LOGOUTOK undefined in config.h%s.\n",

773 
nwš
.
læag
?"":" (although†flag=0)");

776 
p
->
w_¦Ù
 = (
¦Ù_t
)0;

777 ià(
di¥Ïy
 || (
p
->
w_læag
 & 2))

778 
	`S‘Utmp
(
p
);

780 #ifdeà
CAREFULUTMP


781 
	`C¬efulUtmp
();

785 ià(
nwš
.
Læag
)

787 
buf
[1024];

788 
	`DoS¹Log
(
p
, 
buf
, (buf));

791 
p
->
w_»adev
.
fd
 =…->
w_wr™“v
.fd =…->
w_±yfd
;

792 
p
->
w_»adev
.
ty³
 = 
EV_READ
;

793 
p
->
w_wr™“v
.
ty³
 = 
EV_WRITE
;

794 
p
->
w_»adev
.
d©a
 =…->
w_wr™“v
.data = (*)p;

795 
p
->
w_»adev
.
hªdËr
 = 
wš_»adev_â
;

796 
p
->
w_wr™“v
.
hªdËr
 = 
wš_wr™“v_â
;

797 
p
->
w_wr™“v
.
cÚdpos
 = &p->
w_šËn
;

798 
	`ev’q
(&
p
->
w_»adev
);

799 
	`ev’q
(&
p
->
w_wr™“v
);

800 #ifdeà
COPY_PASTE


801 
p
->
w_·¡”
.
·_¦owev
.
ty³
 = 
EV_TIMEOUT
;

802 
p
->
w_·¡”
.
·_¦owev
.
d©a
 = (*)&p->w_paster;

803 
p
->
w_·¡”
.
·_¦owev
.
hªdËr
 = 
·¡e_¦owev_â
;

805 
p
->
w_s’ûev
.
ty³
 = 
EV_TIMEOUT
;

806 
p
->
w_s’ûev
.
d©a
 = (*)p;

807 
p
->
w_s’ûev
.
hªdËr
 = 
wš_s’ûev_â
;

808 ià(
p
->
w_s’û
 > 0)

810 
	`debug
("New window has silenceƒnabled.\n");

811 
	`S‘Timeout
(&
p
->
w_s’ûev
,…->
w_s’ûwa™
 * 1000);

812 
	`ev’q
(&
p
->
w_s’ûev
);

815 
	`S‘FÜeWšdow
(
p
);

816 
	`Aùiv©e
(
p
->
w_nÜeäesh
);

817 
	`WšdowChªged
((
wš
*)0, 'w');

818 
	`WšdowChªged
((
wš
*)0, 'W');

819 
	`WšdowChªged
((
wš
*)0, 0);

820  
n
;

821 
	}
}

830 
	$RemakeWšdow
(
p
)

831 
wš
 *
p
;

833 *
TtyName
;

834 
læag
, 
f
;

836 
læag
 = 
nwš_deçuÉ
.lflag;

837 ià((
f
 = 
	`O³nDeviû
(
p
->
w_cmd¬gs
, 
læag
, &p->
w_ty³
, &
TtyName
)) < 0)

840 
	`¡ºıy
(
p
->
w_‰y
, *
TtyName
 ? TtyNam:…->
w_t™Ë
, 
MAXSTR
 - 1);

841 
p
->
w_±yfd
 = 
f
;

842 
p
->
w_»adev
.
fd
 = 
f
;

843 
p
->
w_wr™“v
.
fd
 = 
f
;

844 
	`ev’q
(&
p
->
w_»adev
);

845 
	`ev’q
(&
p
->
w_wr™“v
);

847 ià(
V”bo£C»©e
)

849 
di¥Ïy
 *
d
 = display;

851 
	`Wr™eSŒšg
(
p
, ":screen (", 9);

852 
	`Wr™eSŒšg
(
p
,…->
w_t™Ë
, 
	`¡¾’
(p->w_title));

853 
	`Wr™eSŒšg
(
p
, "):", 2);

854 
f
 = 0; 
p
->
w_cmd¬gs
[f]; f++)

856 
	`Wr™eSŒšg
(
p
, " ", 1);

857 
	`Wr™eSŒšg
(
p
,…->
w_cmd¬gs
[
f
], 
	`¡¾’
(p->w_cmdargs[f]));

859 
	`Wr™eSŒšg
(
p
, "\r\n", 2);

860 
di¥Ïy
 = 
d
;

863 
p
->
w_pid
 = 0;

864 #ifdeà
BUILTIN_TELNET


865 ià(
p
->
w_ty³
 =ğ
W_TYPE_TELNET
)

867 ià(
	`T–CÚÃù
(
p
))

872 ià(
p
->
w_ty³
 =ğ
W_TYPE_PTY
)

874 
p
->
w_pid
 = 
	`FÜkWšdow
Õ,…->
w_cmd¬gs
, 
TtyName
);

875 ià(
p
->
w_pid
 < 0)

879 #ifdeà
UTMPOK


880 ià(
p
->
w_¦Ù
 =ğ(
¦Ù_t
)0 && (
di¥Ïy
 || (p->
w_læag
 & 2)))

881 
	`S‘Utmp
(
p
);

882 #ifdeà
CAREFULUTMP


883 
	`C¬efulUtmp
();

886 
	`WšdowChªged
(
p
, 'f');

887  
p
->
w_numb”
;

888 
	}
}

891 
	$Clo£Deviû
(
wp
)

892 
wš
 *
wp
;

894 ià(
wp
->
w_±yfd
 < 0)

896 ià(
wp
->
w_ty³
 =ğ
W_TYPE_PTY
)

899 ()
	`chmod
(
wp
->
w_‰y
, 0666);

900 ()
	`chown
(
wp
->
w_‰y
, 0, 0);

902 
	`şo£
(
wp
->
w_±yfd
);

903 
wp
->
w_±yfd
 = -1;

904 
wp
->
w_‰y
[0] = 0;

905 
	`evdeq
(&
wp
->
w_»adev
);

906 
	`evdeq
(&
wp
->
w_wr™“v
);

907 #ifdeà
BUILTIN_TELNET


908 
	`evdeq
(&
wp
->
w_‹lcÚÃv
);

910 
wp
->
w_»adev
.
fd
 = wp->
w_wr™“v
.fd = -1;

911 
	}
}

914 
	$F»eWšdow
(
wp
)

915 
wš
 *
wp
;

917 
di¥Ïy
 *
d
;

918 
i
;

919 
ÿnvas
 *
cv
, *
ncv
;

920 
Ïy”
 *
l
;

922 
	`debug1
("F»eWšdow %d\n", 
wp
 ? wp->
w_numb”
: -1);

923 #ifdeà
PSEUDOS


924 ià(
wp
->
w_pwš
)

925 
	`F»eP£udowš
(
wp
);

927 #ifdeà
UTMPOK


928 
	`RemoveUtmp
(
wp
);

930 
	`Clo£Deviû
(
wp
);

932 ià(
wp
 =ğ
cÚsŞe_wšdow
)

934 
	`TtyG¿bCÚsŞe
(-1, -1, "free");

935 
cÚsŞe_wšdow
 = 0;

937 ià(
wp
->
w_log
 !ğ
NULL
)

938 
	`logfşo£
(
wp
->
w_log
);

939 
	`ChªgeWšdowSize
(
wp
, 0, 0, 0);

941 ià(
wp
->
w_h¡©us
)

942 
	`ä“
(
wp
->
w_h¡©us
);

943 
i
 = 0; 
wp
->
w_cmd¬gs
[i]; i++)

944 
	`ä“
(
wp
->
w_cmd¬gs
[
i
]);

945 ià(
wp
->
w_dœ
)

946 
	`ä“
(
wp
->
w_dœ
);

947 ià(
wp
->
w_‹rm
)

948 
	`ä“
(
wp
->
w_‹rm
);

949 
d
 = 
di¥Ïys
; d; d = d->
d_Ãxt
)

951 ià(
d
->
d_Ùh”
 =ğ
wp
)

952 
d
->
d_Ùh”
 = d->
d_fÜe
 && d->d_fÜe->
w_Ãxt
 !ğ
wp
 ? d->d_fore->w_next : wp->w_next;

953 ià(
d
->
d_fÜe
 =ğ
wp
)

954 
d
->
d_fÜe
 = 
NULL
;

955 
cv
 = 
d
->
d_cvli¡
; cv; cv = cv->
c_Ãxt
)

957 
l
 = 
cv
->
c_Ïy”
;†;† =†->
l_Ãxt
)

958 ià(
l
->
l_Ïyâ
 =ğ&
WšLf
)

960 ià(!
l
)

962 ià((
wš
 *)
l
->
l_d©a
 !ğ
wp
)

964 ià(
cv
->
c_Ïy”
 =ğ
wp
->
w_§v–ay”
)

965 
wp
->
w_§v–ay”
 = 0;

966 
	`KlLay”Chaš
(
cv
->
c_Ïy”
);

969 ià(
wp
->
w_§v–ay”
)

970 
	`KlLay”Chaš
(
wp
->
w_§v–ay”
);

971 
cv
 = 
wp
->
w_Ïy”
.
l_cvli¡
; cv; cv = 
ncv
)

973 
ncv
 = 
cv
->
c_Êext
;

974 
cv
->
c_Ïy”
 = &cv->
c_bÏnk
;

975 
cv
->
c_bÏnk
.
l_cvli¡
 = cv;

976 
cv
->
c_Êext
 = 0;

977 
cv
->
c_xoff
 = cv->
c_xs
;

978 
cv
->
c_yoff
 = cv->
c_ys
;

979 
	`R‘hškV›wpÜtOff£ts
(
cv
);

981 
wp
->
w_Ïy”
.
l_cvli¡
 = 0;

982 ià(
æay”
 =ğ&
wp
->
w_Ïy”
)

983 
æay”
 = 0;

985 #ifdeà
MULTIUSER


986 
	`F»eWšdowAş
(
wp
);

988 
	`evdeq
(&
wp
->
w_»adev
);

989 
	`evdeq
(&
wp
->
w_wr™“v
);

990 
	`evdeq
(&
wp
->
w_s’ûev
);

991 #ifdeà
COPY_PASTE


992 
	`F»ePa¡”
(&
wp
->
w_·¡”
);

994 
	`ä“
((*)
wp
);

995 
	}
}

998 
	$O³nDeviû
(
¬gs
, 
læag
, 
ty³p
, 
Çm•
)

999 **
¬gs
;

1000 
læag
;

1001 *
ty³p
;

1002 **
Çm•
;

1004 *
¬g
 = 
¬gs
[0];

1005 
¡©
 
¡
;

1006 
f
;

1008 ià(!
¬g
)

1010 #ifdeà
BUILTIN_TELNET


1011 ià(
	`¡rcmp
(
¬g
, "//telnet") == 0)

1013 
f
 = 
	`T–O³n
(
¬gs
 + 1);

1014 
læag
 = 0;

1015 *
ty³p
 = 
W_TYPE_TELNET
;

1016 *
Çm•
 = "telnet";

1020 ià((
	`¡©
(
¬g
, &
¡
)è=ğ0 && 
	`S_ISCHR
(¡.
¡_mode
))

1022 ià(
	`acûss
(
¬g
, 
R_OK
 | 
W_OK
) == -1)

1024 
	`Msg
(
”ºo
, "CªnÙ‡cûs lš'%s' fÜ R/W", 
¬g
);

1027 
	`debug
("OpenDevice: OpenTTY\n");

1028 ià((
f
 = 
	`O³nTTY
(
¬g
, 
¬gs
[1])) < 0)

1030 
læag
 = 0;

1031 *
ty³p
 = 
W_TYPE_PLAIN
;

1032 *
Çm•
 = 
¬g
;

1036 *
ty³p
 = 
W_TYPE_PTY
;

1037 
f
 = 
	`O³nPTY
(
Çm•
);

1038 ià(
f
 == -1)

1040 
	`Msg
(0, "No more PTYs.");

1043 #ifdeà
TIOCPKT


1045 
æag
 = 1;

1046 ià(
	`ioùl
(
f
, 
TIOCPKT
, (*)&
æag
))

1048 
	`Msg
(
”ºo
, "TIOCPKT ioctl");

1049 
	`şo£
(
f
);

1055 
	`debug1
("fú(%d, F_SETFL, FNBLOCK)\n", 
f
);

1056 (è
	`fú
(
f
, 
F_SETFL
, 
FNBLOCK
);

1057 #ifdeà
lšux


1074 ià(*
ty³p
 =ğ
W_TYPE_PTY
 || *ty³°=ğ
W_TYPE_PLAIN
)

1075 
	`tcæush
(
f
, 
TCIOFLUSH
);

1078 ià(*
ty³p
 !ğ
W_TYPE_PTY
)

1079  
f
;

1081 #iâdeà
PTYROFS


1082 #ifdeà
PTYGROUP


1083 ià(
	`chown
(*
Çm•
, 
»®_uid
, 
PTYGROUP
è&& !
eff_uid
)

1085 ià(
	`chown
(*
Çm•
, 
»®_uid
, 
»®_gid
è&& !
eff_uid
)

1088 
	`Msg
(
”ºo
, "chownty");

1089 
	`şo£
(
f
);

1092 #ifdeà
UTMPOK


1093 ià(
	`chmod
(*
Çm•
, 
læag
 ? 
TtyMode
 : (TtyMod& ~022)è&& !
eff_uid
)

1095 ià(
	`chmod
(*
Çm•
, 
TtyMode
è&& !
eff_uid
)

1098 
	`Msg
(
”ºo
, "chmodty");

1099 
	`şo£
(
f
);

1103  
f
;

1104 
	}
}

1114 
	$FÜkWšdow
(
wš
, 
¬gs
, 
‰yn
)

1115 
wš
 *win;

1116 **
¬gs
, *
‰yn
;

1118 
pid
;

1119 
‹buf
[25];

1120 
ebuf
[10];

1121 
sh–lbuf
[7 + 
MAXPATHLEN
];

1122 *
´oc
;

1123 #iâdeà
TIOCSWINSZ


1124 
libuf
[20], 
cobuf
[20];

1126 
Ãwfd
;

1127 
w
 = 
wš
->
w_width
;

1128 
h
 = 
wš
->
w_height
;

1129 #ifdeà
PSEUDOS


1130 
i
, 
·t
, 
wfdu£d
;

1131 
p£udowš
 *
pwš
 = 
wš
->
w_pwš
;

1133 
¦ave
 = -1;

1135 #ifdeà
O_NOCTTY


1136 ià(
±y_´eİ’
)

1138 
	`debug
("pre-opening slave...\n");

1139 ià((
¦ave
 = 
	`İ’
(
‰yn
, 
O_RDWR
|
O_NOCTTY
)) == -1)

1141 
	`Msg
(
”ºo
, "ttyn");

1146 
	`debug
("forking...\n");

1147 
´oc
 = *
¬gs
;

1148 ià(
´oc
 == 0)

1150 
¬gs
 = 
Sh–lArgs
;

1151 
´oc
 = *
¬gs
;

1153 
	`fæush
(
¡dout
);

1154 
	`fæush
(
¡d”r
);

1155 
pid
 = 
	`fÜk
())

1158 
	`Msg
(
”ºo
, "fork");

1161 
	`sigÇl
(
SIGHUP
, 
SIG_DFL
);

1162 
	`sigÇl
(
SIGINT
, 
SIG_DFL
);

1163 
	`sigÇl
(
SIGQUIT
, 
SIG_DFL
);

1164 
	`sigÇl
(
SIGTERM
, 
SIG_DFL
);

1165 #ifdeà
BSDJOBS


1166 
	`sigÇl
(
SIGTTIN
, 
SIG_DFL
);

1167 
	`sigÇl
(
SIGTTOU
, 
SIG_DFL
);

1169 #ifdeà
SIGPIPE


1170 
	`sigÇl
(
SIGPIPE
, 
SIG_DFL
);

1172 #ifdeà
SIGXFSZ


1173 
	`sigÇl
(
SIGXFSZ
, 
SIG_DFL
);

1176 
di¥Ïys
 = 0;

1177 ià(
	`£tgid
(
»®_gid
è|| 
	`£tuid
(
»®_uid
))

1178 
	`Pªic
(
”ºo
, "Setuid/gid");

1179 
eff_uid
 = 
»®_uid
;

1180 
eff_gid
 = 
»®_gid
;

1181 #ifdeà
PSEUDOS


1182 ià(!
pwš
)

1184 ià(
wš
->
w_dœ
 && *wš->w_dœ && 
	`chdœ
(win->w_dir))

1185 
	`Pªic
(
”ºo
, "CªnÙ chdœØ%s", 
wš
->
w_dœ
);

1187 ià(
di¥Ïy
)

1189 
	`brk‰y
(
D_u£rfd
);

1190 
	`ä“‰y
();

1193 
	`brk‰y
(-1);

1194 #ifdeà
DEBUG


1195 ià(
då
 && då !ğ
¡d”r
)

1196 
	`fşo£
(
då
);

1198 ià(
¦ave
 != -1)

1200 
	`şo£
(0);

1201 
	`dup
(
¦ave
);

1202 
	`şo£
(
¦ave
);

1203 
	`şo£®lfes
(
wš
->
w_±yfd
);

1204 
¦ave
 = 
	`dup
(0);

1207 
	`şo£®lfes
(
wš
->
w_±yfd
);

1208 #ifdeà
DEBUG


1209 ià(
då
)

1211 
buf
[256];

1213 
	`¥rštf
(
buf
, "%s/sü“n.chd", 
DEBUGDIR
);

1214 ià((
då
 = 
	`fİ’
(
buf
, "a")) == 0)

1215 
då
 = 
¡d”r
;

1217 (è
	`chmod
(
buf
, 0666);

1219 
	`debug1
("==ğFÜkWšdow:…id %d\n", ()
	`g‘pid
());

1222 
	`şo£
(0);

1223 
	`şo£
(1);

1224 
	`şo£
(2);

1225 
Ãwfd
 = -1;

1229 #ifdeà
PSEUDOS


1230 
·t
 = 
pwš
 ?…wš->
p_fd·t
 :

1231 ((
F_PFRONT
<<(
F_PSHIFT
*2)) | (F_PFRONT<<F_PSHIFT) | F_PFRONT);

1232 
	`debug1
("Usšg wšdow…©‹º 0x%x\n", 
·t
);

1233 
wfdu£d
 = 0;

1234 
i
 = 0; i < 3; i++)

1236 ià(
·t
 & 
F_PFRONT
 << 
F_PSHIFT
 * 
i
)

1238 ià(
Ãwfd
 < 0)

1240 #ifdeà
O_NOCTTY


1241 ià(
£·¿‹_sids
)

1242 
Ãwfd
 = 
	`İ’
(
‰yn
, 
O_RDWR
);

1244 
Ãwfd
 = 
	`İ’
(
‰yn
, 
O_RDWR
|
O_NOCTTY
);

1246 
Ãwfd
 = 
	`İ’
(
‰yn
, 
O_RDWR
);

1248 ià(
Ãwfd
 < 0)

1249 
	`Pªic
(
”ºo
, "CªnÙ o³À%s", 
‰yn
);

1252 
	`dup
(
Ãwfd
);

1256 
	`dup
(
wš
->
w_±yfd
);

1257 
wfdu£d
 = 1;

1260 ià(
wfdu£d
)

1266 
	`debug1
("CË¬šg NBLOCK oÀwšdow-fd(%d)\n", 
wš
->
w_±yfd
);

1267 ià(
	`fú
(
wš
->
w_±yfd
, 
F_SETFL
, 0))

1268 
	`Msg
(
”ºo
, "Warning: clear NBLOCK fcntl failed");

1271 #ifdeà
O_NOCTTY


1272 ià(
£·¿‹_sids
)

1273 
Ãwfd
 = 
	`İ’
(
‰yn
, 
O_RDWR
);

1275 
Ãwfd
 = 
	`İ’
(
‰yn
, 
O_RDWR
|
O_NOCTTY
);

1277 
Ãwfd
 = 
	`İ’
(
‰yn
, 
O_RDWR
);

1279 ià(
Ãwfd
 != 0)

1280 
	`Pªic
(
”ºo
, "CªnÙ o³À%s", 
‰yn
);

1281 
	`dup
(0);

1282 
	`dup
(0);

1284 
	`şo£
(
wš
->
w_±yfd
);

1285 ià(
¦ave
 != -1)

1286 
	`şo£
(
¦ave
);

1287 ià(
Ãwfd
 >= 0)

1289 
mode
 
çkemode
, *
mod•
;

1290 
	`In™PTY
(
Ãwfd
);

1291 ià(
	`fg‰y
(
Ãwfd
))

1292 
	`Msg
(
”ºo
, "fgtty");

1293 ià(
di¥Ïy
)

1295 
	`debug
("ForkWindow: using displayty mode for‚ew child.\n");

1296 
mod•
 = &
D_OldMode
;

1300 
	`debug
("No display - creatingty setting\n");

1301 
mod•
 = &
çkemode
;

1302 
	`In™TTY
(
mod•
, 0);

1303 #ifdeà
DEBUG


1304 
	`DebugTTY
(
mod•
);

1310 #ifdeà
PSEUDOS


1311 ià(
pwš
 && (!(
·t
 & 
F_UWP
è|| (·ˆ& 
F_PBACK
 << 
F_PSHIFT
)))

1313 
	`debug1
("ş—ršgƒchØÚ…£udywš fd (·ˆ%x)\n", 
·t
);

1314 #ià
	`defšed
(
POSIX
è|| defšed(
TERMIO
)

1315 
mod•
->
tio
.
c_læag
 &ğ~
ECHO
;

1316 
mod•
->
tio
.
c_iæag
 &ğ~
ICRNL
;

1318 
mod•
->
m_‰yb
.
sg_æags
 &ğ~
ECHO
;

1322 
	`S‘TTY
(
Ãwfd
, 
mod•
);

1323 #ifdeà
TIOCSWINSZ


1324 
glwz
.
ws_cŞ
 = 
w
;

1325 
glwz
.
ws_row
 = 
h
;

1326 (è
	`ioùl
(
Ãwfd
, 
TIOCSWINSZ
, (*)&
glwz
);

1329 ()
	`fú
(
Ãwfd
, 
F_SETFL
, 0);

1331 #iâdeà
TIOCSWINSZ


1332 
	`¥rštf
(
libuf
, "LINES=%d", 
h
);

1333 
	`¥rštf
(
cobuf
, "COLUMNS=%d", 
w
);

1334 
NewEnv
[5] = 
libuf
;

1335 
NewEnv
[6] = 
cobuf
;

1337 #ifdeà
MAPKEYS


1338 
NewEnv
[2] = 
	`MakeT”mÿp
(
di¥Ïy
 =ğ0 || 
wš
->
w_aæag
);

1340 ià(
wš
->
w_aæag
)

1341 
NewEnv
[2] = 
	`MakeT”mÿp
(1);

1343 
NewEnv
[2] = 
T”mÿp
;

1345 
	`¡rıy
(
sh–lbuf
, "SHELL=");

1346 
	`¡ºıy
(
sh–lbuf
 + 6, 
Sh–lProg
 + (*ShellProg == '-'), (shellbuf) - 7);

1347 
sh–lbuf
[(shellbuf) - 1] = 0;

1348 
NewEnv
[4] = 
sh–lbuf
;

1349 
	`debug1
("FÜkWšdow: NewEnv[4] = '%s'\n", 
sh–lbuf
);

1350 ià(
wš
->
w_‹rm
 && *wš->w_‹rm && 
	`¡rcmp
(
sü“Á”m
, win->w_term) &&

1351 (
	`¡¾’
(
wš
->
w_‹rm
) < 20))

1353 *
s1
, *
s2
, 

;

1355 
	`¥rštf
(
‹buf
, "TERM=%s", 
wš
->
w_‹rm
);

1356 
	`debug2
("Makewšdow %d w™h %s\n", 
wš
->
w_numb”
, 
‹buf
);

1357 

 = 
	`¡¾’
(
wš
->
w_‹rm
);

1358 
NewEnv
[1] = 
‹buf
;

1359 ià((
s1
 = 
	`šdex
(
NewEnv
[2], '|')))

1361 ià((
s2
 = 
	`šdex
(++
s1
, '|')))

1363 ià(
	`¡¾’
(
NewEnv
[2]è- (
s2
 - 
s1
è+ 

 < 1024)

1365 
	`bcİy
(
s2
, 
s1
 + 

, 
	`¡¾’
(s2) + 1);

1366 
	`bcİy
(
wš
->
w_‹rm
, 
s1
, 

);

1371 
	`¥rštf
(
ebuf
, "WINDOW=%d", 
wš
->
w_numb”
);

1372 
NewEnv
[3] = 
ebuf
;

1374 ià(*
´oc
 == '-')

1375 
´oc
++;

1376 ià(!*
´oc
)

1377 
´oc
 = 
DeçuÉSh–l
;

1378 
	`debug1
("ÿÎšgƒxecv³ %s\n", 
´oc
);

1379 
	`execv³
(
´oc
, 
¬gs
, 
NewEnv
);

1380 
	`debug1
("exeø”rÜ: %d\n", 
”ºo
);

1381 
	`Pªic
(
”ºo
, "CªnÙƒxeø'%s'", 
´oc
);

1385 ià(
¦ave
 != -1)

1386 
	`şo£
(
¦ave
);

1387  
pid
;

1388 
	}
}

1391 
	$execv³
(
´og
, 
¬gs
, 
’v
)

1392 *
´og
, **
¬gs
, **
’v
;

1394 *
·th
 = 
NULL
, *
p
;

1395 
buf
[1024];

1396 *
sh¬gs
[
MAXARGS
 + 1];

1397 
i
, 
—cûss
 = 0;

1399 ià(
	`ršdex
(
´og
, '/'))

1400 
·th
 = "";

1401 ià(!
·th
 && !Õ©h = 
	`g‘’v
("PATH")))

1402 
·th
 = 
DeçuÉP©h
;

1405 
p
 = 
buf
; *
·th
 && *path != ':';…ath++)

1406 ià(
p
 - 
buf
 < ()(buf) - 2)

1407 *
p
++ = *
·th
;

1408 ià(
p
 > 
buf
)

1409 *
p
++ = '/';

1410 ià(
p
 - 
buf
 + 
	`¡¾’
(
´og
) >= (buf) - 1)

1412 
	`¡rıy
(
p
, 
´og
);

1413 
	`execve
(
buf
, 
¬gs
, 
’v
);

1414 
”ºo
)

1416 
ENOEXEC
:

1417 
sh¬gs
[0] = 
DeçuÉSh–l
;

1418 
sh¬gs
[1] = 
buf
;

1419 
i
 = 1; (
sh¬gs
[˜+ 1] = 
¬gs
[i]è!ğ
NULL
; ++i)

1421 
	`execve
(
DeçuÉSh–l
, 
sh¬gs
, 
’v
);

1423 
EACCES
:

1424 
—cûss
 = 1;

1426 
ENOMEM
:

1427 
E2BIG
:

1428 
ETXTBSY
:

1431 } *
·th
++);

1432 ià(
—cûss
)

1433 
”ºo
 = 
EACCES
;

1434 
	}
}

1436 #ifdeà
PSEUDOS


1439 
	$wšexec
(
av
)

1440 **
av
;

1442 **
µ
;

1443 *
p
, *
s
, *
t
;

1444 
i
, 
r
 = 0, 
l
 = 0;

1445 
wš
 *
w
;

1446 
di¥Ïy
 *display;

1447 
wš
 *
wšdows
;

1448 
p£udowš
 *
pwš
;

1449 
ty³
;

1451 ià((
w
 = 
di¥Ïy
 ? 
fÜe
 : 
wšdows
è=ğ
NULL
)

1453 ià(!*
av
 || 
w
->
w_pwš
)

1455 
	`Msg
(0, "F‹¸ruÂšg: %s", 
w
->
w_pwš
 ? w->w_pwš->
p_cmd
 : "(none)");

1458 ià(
w
->
w_±yfd
 < 0)

1460 
	`Msg
(0, "You feel dead inside.");

1463 ià(!(
pwš
 = (
p£udowš
 *)
	`m®loc
((pseudowin))))

1465 
	`Msg
(0, 
¡ºomem
);

1468 
	`bz”o
((*)
pwš
, ()(*pwin));

1471 
s
 = *
av
; *s == ' '; s++)

1473 
p
 = 
s
; *p == ':' || *p == '.' || *p == '!';…++)

1475 ià(*
p
 != '|')

1476 *
p
 &&… > 
s
 &&…[-1] == '.')

1477 
p
--;

1478 ià(*
p
 == '|')

1480 
l
 = 
F_UWP
;

1481 
p
++;

1483 ià(*
p
)

1484 
av
[0] = 
p
;

1486 
av
++;

1488 
t
 = 
pwš
->
p_cmd
;

1489 
i
 = 0; i < 3; i++)

1491 *
t
 = (
s
 < 
p
) ? *s++ : '.';

1492 *
t
++)

1496 
l
 |ğ
F_PFRONT
 << (
i
 * 
F_PSHIFT
);

1499 
l
 |ğ
F_PBACK
 << (
i
 * 
F_PSHIFT
);

1502 
l
 |ğ
F_PBOTH
 << (
i
 * 
F_PSHIFT
);

1507 ià(
l
 & 
F_UWP
)

1509 *
t
++ = '|';

1510 ià((
l
 & 
F_PMASK
è=ğ
F_PFRONT
)

1512 *
pwš
->
p_cmd
 = '!';

1513 
l
 ^ğ
F_PFRONT
 | 
F_PBACK
;

1516 ià(!(
l
 & 
F_PBACK
))

1517 
l
 |ğ
F_UWP
;

1518 *
t
++ = ' ';

1519 
pwš
->
p_fd·t
 = 
l
;

1520 
	`debug1
("wšexec: '%#x'\n", 
pwš
->
p_fd·t
);

1522 
l
 = 
MAXSTR
 - 4;

1523 
µ
 = 
av
; *pp;…p++)

1525 
p
 = *
µ
;

1526 *
p
 && 
l
-- > 0)

1527 *
t
++ = *
p
++;

1528 ià(
l
 <= 0)

1530 *
t
++ = ' ';

1532 *--
t
 = '\0';

1533 
	`debug1
("%s\n", 
pwš
->
p_cmd
);

1535 ià((
pwš
->
p_±yfd
 = 
	`O³nDeviû
(
av
, 0, &
ty³
, &
t
)) < 0)

1537 
	`ä“
((*)
pwš
);

1540 
	`¡ºıy
(
pwš
->
p_‰y
, 
t
, 
MAXSTR
 - 1);

1541 
w
->
w_pwš
 = 
pwš
;

1542 ià(
ty³
 !ğ
W_TYPE_PTY
)

1544 
	`F»eP£udowš
(
w
);

1545 
	`Msg
(0, "Cannot only use commands‡s…seudo win.");

1548 ià(!(
pwš
->
p_fd·t
 & 
F_PFRONT
))

1549 
	`evdeq
(&
w
->
w_»adev
);

1550 #ifdeà
TIOCPKT


1552 
æag
 = 0;

1554 ià(
	`ioùl
(
pwš
->
p_±yfd
, 
TIOCPKT
, (*)&
æag
))

1556 
	`Msg
(
”ºo
, "TIOCPKT…win ioctl");

1557 
	`F»eP£udowš
(
w
);

1560 ià(
w
->
w_ty³
 =ğ
W_TYPE_PTY
 && !(
pwš
->
p_fd·t
 & 
F_PFRONT
))

1562 ià(
	`ioùl
(
w
->
w_±yfd
, 
TIOCPKT
, (*)&
æag
))

1564 
	`Msg
(
”ºo
, "TIOCPKT win ioctl");

1565 
	`F»eP£udowš
(
w
);

1572 
pwš
->
p_»adev
.
fd
 =…wš->
p_wr™“v
.fd =…wš->
p_±yfd
;

1573 
pwš
->
p_»adev
.
ty³
 = 
EV_READ
;

1574 
pwš
->
p_wr™“v
.
ty³
 = 
EV_WRITE
;

1575 
pwš
->
p_»adev
.
d©a
 =…wš->
p_wr™“v
.d©¨ğ(*)
w
;

1576 
pwš
->
p_»adev
.
hªdËr
 = 
p£u_»adev_â
;

1577 
pwš
->
p_wr™“v
.
hªdËr
 = 
p£u_wr™“v_â
;

1578 
pwš
->
p_wr™“v
.
cÚdpos
 = &pwš->
p_šËn
;

1579 ià(
pwš
->
p_fd·t
 & (
F_PFRONT
 << 
F_PSHIFT
 * 2 | F_PFRONT << F_PSHIFT))

1580 
	`ev’q
(&
pwš
->
p_»adev
);

1581 
	`ev’q
(&
pwš
->
p_wr™“v
);

1582 
r
 = 
pwš
->
p_pid
 = 
	`FÜkWšdow
(
w
, 
av
, 
t
);

1583 ià(
r
 < 0)

1584 
	`F»eP£udowš
(
w
);

1585  
r
;

1586 
	}
}

1589 
	$F»eP£udowš
(
w
)

1590 
wš
 *
w
;

1592 
p£udowš
 *
pwš
 = 
w
->
w_pwš
;

1594 
	`ASSERT
(
pwš
);

1595 ià(
	`fú
(
w
->
w_±yfd
, 
F_SETFL
, 
FNBLOCK
))

1596 
	`Msg
(
”ºo
, "Warning: FreePseudowin: NBLOCK fcntl failed");

1597 #ifdeà
TIOCPKT


1598 ià(
w
->
w_ty³
 =ğ
W_TYPE_PTY
 && !(
pwš
->
p_fd·t
 & 
F_PFRONT
))

1600 
æag
 = 1;

1601 ià(
	`ioùl
(
w
->
w_±yfd
, 
TIOCPKT
, (*)&
æag
))

1602 
	`Msg
(
”ºo
, "Warning: FreePseudowin: TIOCPKT win ioctl");

1606 ()
	`chmod
(
pwš
->
p_‰y
, 0666);

1607 ()
	`chown
(
pwš
->
p_‰y
, 0, 0);

1608 ià(
pwš
->
p_±yfd
 >= 0)

1609 
	`şo£
(
pwš
->
p_±yfd
);

1610 
	`evdeq
(&
pwš
->
p_»adev
);

1611 
	`evdeq
(&
pwš
->
p_wr™“v
);

1612 ià(
w
->
w_»adev
.
cÚdÃg
 =ğ&
pwš
->
p_šËn
)

1613 
w
->
w_»adev
.
cÚdpos
 = w->w_»adev.
cÚdÃg
 = 0;

1614 
	`ev’q
(&
w
->
w_»adev
);

1615 
	`ä“
((*)
pwš
);

1616 
w
->
w_pwš
 = 
NULL
;

1617 
	}
}

1622 #ifdeà
MULTIUSER


1627 
	$R–—£AutoWr™–ock
(
dis
, 
w
)

1628 
di¥Ïy
 *
dis
;

1629 
wš
 *
w
;

1631 
	`debug2
("ReleaseAutoWritelock: user %s, window %d\n",

1632 
dis
->
d_u£r
->
u_Çme
, 
w
->
w_numb”
);

1635 ià(
w
->
w_wlock
 =ğ
WLOCK_AUTO
 && w->
w_wlocku£r
 =ğ
dis
->
d_u£r
)

1637 
di¥Ïy
 *
d
;

1639 
d
 = 
di¥Ïys
; d; d = d->
d_Ãxt
)

1640 ià(Ğ
d
 !ğ
dis
è&& (d->
d_fÜe
 =ğ
w
è&& (d->
d_u£r
 == dis->d_user))

1642 
	`debug3
("%s %s‡utolock on win %d\n",

1643 
dis
->
d_u£r
->
u_Çme
, 
d
 ? "k“ps" : "»Ëa£s", 
w
->
w_numb”
);

1644 ià(!
d
)

1646 
w
->
w_wlocku£r
 = 
NULL
;

1651 
	}
}

1657 
	$ObšAutoWr™–ock
(
d
, 
w
)

1658 
di¥Ïy
 *
d
;

1659 
wš
 *
w
;

1661 ià((
w
->
w_wlock
 =ğ
WLOCK_AUTO
) &&

1662 !
	`AşCheckP”mWš
(
d
->
d_u£r
, 
ACL_WRITE
, 
w
) &&

1663 !
w
->
w_wlocku£r
)

1665 
	`debug2
("%s obtained‡uto writelock forƒxported window %d\n",

1666 
d
->
d_u£r
->
u_Çme
, 
w
->
w_numb”
);

1667 
w
->
w_wlocku£r
 = 
d
->
d_u£r
;

1671 
	}
}

1679 #ifdeà
COPY_PASTE


1681 
	$·¡e_¦owev_â
(
ev
, 
d©a
)

1682 
ev’t
 *
ev
;

1683 *
d©a
;

1685 
·¡”
 *
·
 = (·¡” *)
d©a
;

1686 
wš
 *
p
;

1688 
l
 = 1;

1689 
æay”
 = 
·
->
·_·¡–ay”
;

1690 ià(!
æay”
)

1691 
·
->
·_·¡–’
 = 0;

1692 ià(!
·
->
·_·¡–’
)

1694 
p
 = 
	`Lay”2Wšdow
(
æay”
);

1695 
	`DoProûss
(
p
, &
·
->
·_·¡•Œ
, &
l
,…a);

1696 
·
->
·_·¡–’
 -ğ1 - 
l
;

1697 ià(
·
->
·_·¡–’
 > 0)

1699 
	`S‘Timeout
(&
·
->
·_¦owev
, 
p
->
w_¦ow·¡e
);

1700 
	`ev’q
(&
·
->
·_¦owev
);

1702 
	}
}

1707 
	$much³ndšg
(
p
, 
ev
)

1708 
wš
 *
p
;

1709 
ev’t
 *
ev
;

1711 
ÿnvas
 *
cv
;

1712 
cv
 = 
p
->
w_Ïy”
.
l_cvli¡
; cv; cv = cv->
c_Êext
)

1714 
di¥Ïy
 = 
cv
->
c_di¥Ïy
;

1715 ià(
D_¡©us
 =ğ
STATUS_ON_WIN
 && !
D_¡©us_b–l
)

1718 
	`debug
("BLOCKING because of status\n");

1719 
ev
->
cÚdpos
 = &
cÚ¡_Úe
;

1720 
ev
->
cÚdÃg
 = &
D_¡©us
;

1723 
	`debug2
("much³ndšg % %d: ", 
D_u£¹ty
, 
D_blocked
);

1724 
	`debug3
("%d %d %d\n", 
D_obuå
 - 
D_obuf
, 
D_obufmax
, 
D_blocked_fuzz
);

1725 ià(
D_blocked
)

1727 ià(
D_obuå
 - 
D_obuf
 > 
D_obufmax
 + 
D_blocked_fuzz
)

1729 ià(
D_nÚblock
 == 0)

1731 
	`debug1
("obuài fuÎ, stİpšg ouuˆtØdi¥Ïy %s\n", 
D_u£¹ty
);

1732 
D_blocked
 = 1;

1735 
	`debug
("BLOCKING because of full obuf\n");

1736 
ev
->
cÚdpos
 = &
D_obufä“
;

1737 
ev
->
cÚdÃg
 = &
D_obuæ’max
;

1738 ià(
D_nÚblock
 > 0 && !
D_blockedev
.
queued
)

1740 
	`debug1
("ü—‹dimeouˆoà%g secs\n", 
D_nÚblock
/1000.);

1741 
	`S‘Timeout
(&
D_blockedev
, 
D_nÚblock
);

1742 
	`ev’q
(&
D_blockedev
);

1748 
	}
}

1751 
	$wš_»adev_â
(
ev
, 
d©a
)

1752 
ev’t
 *
ev
;

1753 *
d©a
;

1755 
wš
 *
p
 = (wš *)
d©a
;

1756 
buf
[
IOSIZE
], *
bp
;

1757 
size
, 
Ën
;

1758 #ifdeà
PSEUDOS


1759 
wtİ
;

1762 
bp
 = 
buf
;

1763 
size
 = 
IOSIZE
;

1765 #ifdeà
PSEUDOS


1766 
wtİ
 = 
p
->
w_pwš
 && 
	`W_WTOP
(p);

1767 ià(
wtİ
)

1769 
	`ASSERT
((
p
->
w_pwš
->
p_šbuf
è=ğ
IOSIZE
);

1770 
size
 = 
IOSIZE
 - 
p
->
w_pwš
->
p_šËn
;

1771 ià(
size
 <= 0)

1773 
ev
->
cÚdpos
 = &
cÚ¡_IOSIZE
;

1774 
ev
->
cÚdÃg
 = &
p
->
w_pwš
->
p_šËn
;

1779 ià(
p
->
w_Ïy”
.
l_cvli¡
 && 
	`much³ndšg
Õ, 
ev
))

1781 #ifdeà
ZMODEM


1782 ià(!
p
->
w_zdi¥Ïy
)

1784 ià(
p
->
w_blocked
)

1786 
ev
->
cÚdpos
 = &
cÚ¡_Úe
;

1787 
ev
->
cÚdÃg
 = &
p
->
w_blocked
;

1790 ià(
ev
->
cÚdpos
)

1791 
ev
->
cÚdpos
 =ƒv->
cÚdÃg
 = 0;

1793 ià((
Ën
 = 
p
->
w_ou’
))

1795 
p
->
w_ou’
 = 0;

1796 
	`Wr™eSŒšg
(
p
,…->
w_outbuf
, 
Ën
);

1800 
	`debug1
("gošgØ»ad from wšdow fd %d\n", 
ev
->
fd
);

1801 ià((
Ën
 = 
	`»ad
(
ev
->
fd
, 
buf
, 
size
)) < 0)

1803 ià(
”ºo
 =ğ
EINTR
 ||ƒ¼nØ=ğ
EAGAIN
)

1805 #ià
	`defšed
(
EWOULDBLOCK
è&& (EWOULDBLOCK !ğ
EAGAIN
)

1806 ià(
”ºo
 =ğ
EWOULDBLOCK
)

1809 
	`debug2
("Wšdow %d:„—dƒ¼Ü (”ºØ%dè- klšg wšdow\n", 
p
->
w_numb”
, 
”ºo
);

1810 
	`WšdowD›d
(
p
);

1813 ià(
Ën
 == 0)

1815 
	`debug1
("Wšdow %d: EOF - klšg wšdow\n", 
p
->
w_numb”
);

1816 
	`WšdowD›d
(
p
);

1819 
	`debug1
(" -> %d by‹s\n", 
Ën
);

1820 #ifdeà
TIOCPKT


1821 ià(
p
->
w_ty³
 =ğ
W_TYPE_PTY
)

1823 ià(
buf
[0])

1825 
	`debug1
("PAKET %x\n", 
buf
[0]);

1826 ià(
buf
[0] & 
TIOCPKT_NOSTOP
)

1827 
	`WNewAutoFlow
(
p
, 0);

1828 ià(
buf
[0] & 
TIOCPKT_DOSTOP
)

1829 
	`WNewAutoFlow
(
p
, 1);

1831 
bp
++;

1832 
Ën
--;

1835 #ifdeà
BUILTIN_TELNET


1836 ià(
p
->
w_ty³
 =ğ
W_TYPE_TELNET
)

1837 
Ën
 = 
	`T–In
(
p
, 
bp
,†’, 
buf
 + (buf) - (bp +†en));

1839 ià(
Ën
 == 0)

1841 #ifdeà
ZMODEM


1842 ià(
zmodem_mode
 && 
	`zmodem_·r£
(
p
, 
bp
, 
Ën
))

1845 #ifdeà
PSEUDOS


1846 ià(
wtİ
)

1848 
	`debug
("sending inputo…win\n");

1849 
	`bcİy
(
bp
, 
p
->
w_pwš
->
p_šbuf
 +…->w_pwš->
p_šËn
, 
Ën
);

1850 
p
->
w_pwš
->
p_šËn
 +ğ
Ën
;

1853 
	`Wr™eSŒšg
(
p
, 
bp
, 
Ën
);

1855 
	}
}

1859 
	$wš_wr™“v_â
(
ev
, 
d©a
)

1860 
ev’t
 *
ev
;

1861 *
d©a
;

1863 
wš
 *
p
 = (wš *)
d©a
;

1864 
Ën
;

1865 ià(
p
->
w_šËn
)

1867 
	`debug2
("wr™šg %d by‹ tØwš %d\n", 
p
->
w_šËn
,…->
w_numb”
);

1868 ià((
Ën
 = 
	`wr™e
(
ev
->
fd
, 
p
->
w_šbuf
,…->
w_šËn
)) <= 0)

1869 
Ën
 = 
p
->
w_šËn
;

1870 ià((
p
->
w_šËn
 -ğ
Ën
))

1871 
	`bcİy
(
p
->
w_šbuf
 + 
Ën
,…->w_šbuf,…->
w_šËn
);

1873 #ifdeà
COPY_PASTE


1874 ià(
p
->
w_·¡”
.
·_·¡–’
 && !p->
w_¦ow·¡e
)

1876 
·¡”
 *
·
 = &
p
->
w_·¡”
;

1877 
æay”
 = 
·
->
·_·¡–ay”
;

1878 ià(
æay”
)

1879 
	`DoProûss
(
p
, &
·
->
·_·¡•Œ
, &·->
·_·¡–’
,…a);

1883 
	}
}

1887 #ifdeà
PSEUDOS


1890 
	$p£u_»adev_â
(
ev
, 
d©a
)

1891 
ev’t
 *
ev
;

1892 *
d©a
;

1894 
wš
 *
p
 = (wš *)
d©a
;

1895 
buf
[
IOSIZE
];

1896 
size
, 
±ow
, 
Ën
;

1898 
size
 = 
IOSIZE
;

1900 
±ow
 = 
	`W_PTOW
(
p
);

1901 ià(
±ow
)

1903 
	`ASSERT
((
p
->
w_šbuf
è=ğ
IOSIZE
);

1904 
size
 = 
IOSIZE
 - 
p
->
w_šËn
;

1905 ià(
size
 <= 0)

1907 
ev
->
cÚdpos
 = &
cÚ¡_IOSIZE
;

1908 
ev
->
cÚdÃg
 = &
p
->
w_šËn
;

1912 ià(
p
->
w_Ïy”
.
l_cvli¡
 && 
	`much³ndšg
Õ, 
ev
))

1914 ià(
p
->
w_blocked
)

1916 
ev
->
cÚdpos
 = &
cÚ¡_Úe
;

1917 
ev
->
cÚdÃg
 = &
p
->
w_blocked
;

1920 ià(
ev
->
cÚdpos
)

1921 
ev
->
cÚdpos
 =ƒv->
cÚdÃg
 = 0;

1923 ià((
Ën
 = 
p
->
w_ou’
))

1925 
p
->
w_ou’
 = 0;

1926 
	`Wr™eSŒšg
(
p
,…->
w_outbuf
, 
Ën
);

1930 ià((
Ën
 = 
	`»ad
(
ev
->
fd
, 
buf
, 
size
)) <= 0)

1932 ià(
”ºo
 =ğ
EINTR
 ||ƒ¼nØ=ğ
EAGAIN
)

1934 #ià
	`defšed
(
EWOULDBLOCK
è&& (EWOULDBLOCK !ğ
EAGAIN
)

1935 ià(
”ºo
 =ğ
EWOULDBLOCK
)

1938 
	`debug2
("Wšdow %d:…£udowš„—dƒ¼Ü (”ºØ%dè--„emovšg…£udowš\n", 
p
->
w_numb”
, 
Ën
 ? 
”ºo
 : 0);

1939 
	`F»eP£udowš
(
p
);

1943 ià(
±ow
)

1945 
	`bcİy
(
buf
, 
p
->
w_šbuf
 +…->
w_šËn
, 
Ën
);

1946 
p
->
w_šËn
 +ğ
Ën
;

1948 
	`Wr™eSŒšg
(
p
, 
buf
, 
Ën
);

1950 
	}
}

1953 
	$p£u_wr™“v_â
(
ev
, 
d©a
)

1954 
ev’t
 *
ev
;

1955 *
d©a
;

1957 
wš
 *
p
 = (wš *)
d©a
;

1958 
p£udowš
 *
pw
 = 
p
->
w_pwš
;

1959 
Ën
;

1961 
	`ASSERT
(
pw
);

1962 ià(
pw
->
p_šËn
 == 0)

1964 ià((
Ën
 = 
	`wr™e
(
ev
->
fd
, 
pw
->
p_šbuf
,…w->
p_šËn
)) <= 0)

1965 
Ën
 = 
pw
->
p_šËn
;

1966 ià((
p
->
w_pwš
->
p_šËn
 -ğ
Ën
))

1967 
	`bcİy
(
p
->
w_pwš
->
p_šbuf
 + 
Ën
,…->w_pwš->p_šbuf,…->w_pwš->
p_šËn
);

1968 
	}
}

1974 
	$wš_s’ûev_â
(
ev
, 
d©a
)

1975 
ev’t
 *
ev
;

1976 *
d©a
;

1978 
wš
 *
p
 = (wš *)
d©a
;

1979 
ÿnvas
 *
cv
;

1980 
	`debug1
("FOUND s’û wš %d\n", 
p
->
w_numb”
);

1981 
di¥Ïy
 = 
di¥Ïys
; di¥Ïy; di¥Ïy = di¥Ïy->
d_Ãxt
)

1983 
cv
 = 
D_cvli¡
; cv; cv = cv->
c_Ãxt
)

1984 ià(
cv
->
c_Ïy”
->
l_bÙtom
 =ğ&
p
->
w_Ïy”
)

1986 ià(
cv
)

1988 #ifdeà
MULTIUSER


1989 ià(!(
	`ACLBYTE
(
p
->
w_lio_nÙify
, 
D_u£r
->
u_id
è& 
	`ACLBIT
(D_user->u_id)))

1992 
	`Msg
(0, "Wšdow %d: s’û fÜ %d secÚds", 
p
->
w_numb”
,…->
w_s’ûwa™
);

1994 
	}
}

1996 #ifdeà
ZMODEM


1999 
	$zmodem_·r£
(
p
, 
bp
, 
Ën
)

2000 
wš
 *
p
;

2001 *
bp
;

2002 
Ën
;

2004 
i
;

2005 *
b2
 = 
bp
;

2006 
i
 = 0; i < 
Ën
; i++, 
b2
++)

2008 ià(
p
->
w_zauto
 == 0)

2010 ; 
i
 < 
Ën
; i++, 
b2
++)

2011 ià(*
b2
 == 030)

2013 ià(
i
 =ğ
Ën
)

2015 ià(
i
 > 1 && 
b2
[-1] == '*' && b2[-2] == '*')

2016 
p
->
w_zauto
 = 3;

2019 ià(
p
->
w_zauto
 > 5 || *
b2
 =ğ"**\030B00"[p->w_zauto] || (p->w_zautØ=ğ5 && *b2 =ğ'1'è|| (p->w_zautØ=ğ5 &&…->
w_zdi¥Ïy
 && *b2 == '8'))

2021 ià(++
p
->
w_zauto
 < 6)

2023 ià(
p
->
w_zauto
 == 6)

2024 
p
->
w_zauto
 = 0;

2025 ià(!
p
->
w_zdi¥Ïy
)

2027 ià(
i
 > 6)

2028 
	`Wr™eSŒšg
(
p
, 
bp
, 
i
 + 1 - 6);

2029 
	`Wr™eSŒšg
(
p
, "\r\n", 2);

2030 
	`zmodem_found
(
p
, *
b2
 =ğ'1', b2 + 1, 
Ën
 - 
i
 - 1);

2033 ià(
p
->
w_zauto
 =ğ7 || *
b2
 == '8')

2035 
£
 = 
p
->
w_zdi¥Ïy
->
d_blocked
 == 2 ? 'O' : '\212';

2036 ; 
i
 < 
Ën
; i++, 
b2
++)

2037 ià(*
b2
 =ğ
£
)

2039 ià(
i
 < 
Ën
)

2041 
	`zmodem_abÜt
(
p
, 0);

2042 
D_blocked
 = 0;

2043 
D_»adev
.
cÚdpos
 = D_»adev.
cÚdÃg
 = 0;

2044 
Ën
-- > 0)

2045 
	`AddCh¬
(*
bp
++);

2046 
	`Flush
();

2047 
	`Aùiv©e
(
D_fÜe
 ? D_fÜe->
w_nÜeäesh
 : 0);

2050 
p
->
w_zauto
 = 6;

2054 
p
->
w_zauto
 = *
b2
 == '*' ? (p->w_zauto == 2 ? 2 : 1) : 0;

2056 ià(
p
->
w_zauto
 =ğ0 && 
bp
[
Ën
 - 1] == '*')

2057 
p
->
w_zauto
 = 
Ën
 > 1 && 
bp
[len - 2] == '*' ? 2 : 1;

2058 ià(
p
->
w_zdi¥Ïy
)

2060 
di¥Ïy
 = 
p
->
w_zdi¥Ïy
;

2061 
Ën
-- > 0)

2062 
	`AddCh¬
(*
bp
++);

2066 
	}
}

2069 
	$zmodem_fš
(
buf
, 
Ën
, 
d©a
)

2070 *
buf
;

2071 
Ën
;

2072 *
d©a
;

2074 *
s
;

2075 
n
;

2077 ià(
Ën
)

2078 
	`RcLše
(
buf
, 
	`¡¾’
(buf) + 1);

2081 
s
 = "\030\030\030\030\030\030\030\030\030\030";

2082 
n
 = 
	`¡¾’
(
s
);

2083 
	`LayProûss
(&
s
, &
n
);

2085 
	}
}

2088 
	$zmodem_found
(
p
, 
£nd
, 
bp
, 
Ën
)

2089 
wš
 *
p
;

2090 
£nd
;

2091 *
bp
;

2092 
Ën
;

2094 *
s
;

2095 
i
, 
n
;

2096 
zmodem_mode
;

2099 
n
 = 0;

2100 
i
 = 0; i < 
Ën
 ; i++)

2101 ià(
bp
[
i
] != 030)

2102 
n
 = 0;

2103 ià(++
n
 > 4)

2105 ià(
zmodem_mode
 =ğ3 || (zmodem_mod=ğ1 && 
p
->
w_ty³
 !ğ
W_TYPE_PLAIN
))

2107 
di¥Ïy
 *
d
, *
Şddi¥Ïy
;

2109 
Şddi¥Ïy
 = 
di¥Ïy
;

2110 
d
 = 
p
->
w_Ï¡di¥
;

2111 ià(!
d
 || d->
d_fÜe
 !ğ
p
)

2112 
d
 = 
di¥Ïys
; d; d = d->
d_Ãxt
)

2113 ià(
d
->
d_fÜe
 =ğ
p
)

2115 ià(!
d
 && 
p
->
w_Ïy”
.
l_cvli¡
)

2116 
d
 = 
p
->
w_Ïy”
.
l_cvli¡
->
c_di¥Ïy
;

2117 ià(!
d
)

2118 
d
 = 
di¥Ïys
;

2119 ià(!
d
)

2121 
di¥Ïy
 = 
d
;

2122 
	`RemoveStus
();

2123 
p
->
w_zdi¥Ïy
 = 
di¥Ïy
;

2124 
D_blocked
 = 2 + 
£nd
;

2125 
æay”
 = &
p
->
w_Ïy”
;

2126 
	`ZmodemPage
();

2127 
di¥Ïy
 = 
d
;

2128 
	`evdeq
(&
D_blockedev
);

2129 
D_»adev
.
cÚdpos
 = &
cÚ¡_IOSIZE
;

2130 
D_»adev
.
cÚdÃg
 = &
p
->
w_šËn
;

2131 
	`CË¬AÎ
();

2132 
	`GÙoPos
(0, 0);

2133 
	`S‘R’d™iÚ
(&
mch¬_bÏnk
);

2134 
	`AddSŒ
("Zmodem‡ctive\r\n\r\n");

2135 
	`AddSŒ
(
£nd
 ? "**\030B01" : "**\030B00");

2136 
Ën
-- > 0)

2137 
	`AddCh¬
(*
bp
++);

2138 
di¥Ïy
 = 
Şddi¥Ïy
;

2141 
æay”
 = &
p
->
w_Ïy”
;

2142 
	`IÅut
(":", 100, 
INP_COOKED
, 
zmodem_fš
, 
NULL
);

2143 
s
 = 
£nd
 ? 
zmodem_£ndcmd
 : 
zmodem_»cvcmd
;

2144 
n
 = 
	`¡¾’
(
s
);

2145 
	`LayProûss
(&
s
, &
n
);

2146 
	}
}

2149 
	$zmodem_abÜt
(
p
, 
d
)

2150 
wš
 *
p
;

2151 
di¥Ïy
 *
d
;

2153 
di¥Ïy
 *
Şddi¥Ïy
 = display;

2154 
Ïy”
 *
Şdæay”
 = 
æay”
;

2155 ià(
p
)

2157 ià(
p
->
w_§v–ay”
 &&…->w_§v–ay”->
l_Ãxt
)

2159 ià(
Şdæay”
 =ğ
p
->
w_§v–ay”
)

2160 
Şdæay”
 = 
æay”
->
l_Ãxt
;

2161 
æay”
 = 
p
->
w_§v–ay”
;

2162 
	`Ex™Ov”ÏyPage
();

2164 
p
->
w_zdi¥Ïy
 = 0;

2165 
p
->
w_zauto
 = 0;

2166 
	`LReäeshAÎ
(&
p
->
w_Ïy”
, 0);

2168 ià(
d
)

2170 
di¥Ïy
 = 
d
;

2171 
D_blocked
 = 0;

2172 
D_»adev
.
cÚdpos
 = D_»adev.
cÚdÃg
 = 0;

2173 
	`Aùiv©e
(
D_fÜe
 ? D_fÜe->
w_nÜeäesh
 : 0);

2175 
di¥Ïy
 = 
Şddi¥Ïy
;

2176 
æay”
 = 
Şdæay”
;

2177 
	}
}

	@window.h

27 
	sNewWšdow


29 
	mS¹At
;

30 *
	maka
;

31 **
	m¬gs
;

32 *
	mdœ
;

33 *
	m‹rm
;

34 
	maæag
;

35 
	mæowæag
;

36 
	mlæag
;

37 
	mhi¡height
;

38 
	mmÚ™Ü
;

39 
	mwlock
;

40 
	ms’û
;

41 
	mw¿p
;

42 
	mLæag
;

43 
	m¦ow
;

44 
	mgr
;

45 
	mc1
;

46 
	mbû
;

47 
	m’codšg
;

48 *
	mh¡©us
;

49 *
	mch¬£t
;

52 #ifdeà
PSEUDOS


54 
	sp£udowš


56 
	mp_fd·t
;

57 
	mp_pid
;

58 
	mp_±yfd
;

59 
ev’t
 
	mp_»adev
;

60 
ev’t
 
	mp_wr™“v
;

61 
	mp_cmd
[
MAXSTR
];

62 
	mp_‰y
[
MAXSTR
];

63 
	mp_šbuf
[
IOSIZE
];

64 
	mp_šËn
;

68 
	#F_PMASK
 0x0003

	)

69 
	#F_PSHIFT
 2

	)

70 
	#F_PFRONT
 0x0001

	)

71 
	#F_PBACK
 0x0002

	)

72 
	#F_PBOTH
 (
F_PFRONT
 | 
F_PBACK
è

	)

74 
	#F_UWP
 0x1000

	)

78 
	#W_WP
(
w
è((w)->
w_pwš
 && ((w)->w_pwš->
p_fd·t
 & 
F_PFRONT
))

	)

82 
	#W_WW
(
w
è(!((w)->
w_pwš
) || \

83 (((
w
)->
w_pwš
->
p_fd·t
 & 
F_PMASK
è=ğ
F_PBACK
) || \

84 ((((
w
)->
w_pwš
->
p_fd·t
 >> 
F_PSHIFT
è& 
F_PMASK
è=ğ
F_PBOTH
) || \

85 ((((
w
)->
w_pwš
->
p_fd·t
 >> (
F_PSHIFT
 * 2)è& 
F_PMASK
è=ğ
F_PBOTH
))

	)

88 
	#W_RP
(
w
è((w)->
w_pwš
 && ((w)->w_pwš->
p_fd·t
 & \

89 ((
F_PFRONT
 << (
F_PSHIFT
 * 2)è| (F_PFRONT << F_PSHIFT)è))

	)

92 
	#W_RW
(
w
è(!((w)->
w_pwš
è|| ((w)->w_pwš->
p_fd·t
 & 
F_PFRONT
))

	)

95 
	#W_UWP
(
w
è((w)->
w_pwš
 && ((w)->w_pwš->
p_fd·t
 & 
F_UWP
))

	)

98 
	#W_PTOW
(
w
) (\

99 ((
w
)->
w_pwš
->
p_fd·t
 & 
F_PMASK
 << 
F_PSHIFT
è=ğ
F_PBOTH
 << F_PSHIFT || \

100 ((
w
)->
w_pwš
->
p_fd·t
 & 
F_PMASK
 << 
F_PSHIFT
 * 2è=ğ
F_PBOTH
 << F_PSHIFT * 2 )

	)

103 
	#W_WTOP
(
w
è(((w)->
w_pwš
->
p_fd·t
 & 
F_PMASK
è=ğ
F_PBOTH
)

	)

108 
	#WLOCK_OFF
 0

	)

109 
	#WLOCK_AUTO
 1

	)

110 
	#WLOCK_ON
 2

	)

113 #ifdeà
COPY_PASTE


114 
	s·¡”


116 *
	m·_·¡ebuf
;

117 *
	m·_·¡•Œ
;

118 
	m·_·¡–’
;

119 
Ïy”
 *
	m·_·¡–ay”
;

120 
ev’t
 
	m·_¦owev
;

123 
	g·¡”
;

126 
	swš


128 
wš
 *
	mw_Ãxt
;

129 
	mw_ty³
;

130 *
	mw_d©a
;

131 
Ïy”
 
	mw_Ïy”
;

132 
Ïy”
 *
	mw_§v–ay”
;

133 
	mw_blocked
;

134 #ifdeà
PSEUDOS


135 
p£udowš
 *
	mw_pwš
;

137 
di¥Ïy
 *
	mw_pdi¥Ïy
;

138 
di¥Ïy
 *
	mw_Ï¡di¥
;

139 
	mw_numb”
;

140 
ev’t
 
	mw_»adev
;

141 
ev’t
 
	mw_wr™“v
;

142 
ev’t
 
	mw_s’ûev
;

143 
	mw_±yfd
;

144 
	mw_šbuf
[
IOSIZE
];

145 
	mw_šËn
;

146 
	mw_outbuf
[
IOSIZE
];

147 
	mw_ou’
;

148 
	mw_aæag
;

149 *
	mw_t™Ë
;

150 *
	mw_akachªge
;

151 
	mw_akabuf
[
MAXSTR
];

152 
	mw_autßka
;

153 
	mw_š‹rmedŸ‹
;

154 
	mw_¬gs
[
MAXARGS
];

155 
	mw_NumArgs
;

157 #ifdeà
MULTIUSER


158 
	mw_wlock
;

159 
aşu£r
 *
	mw_wlocku£r
;

160 
AşB™s
 
	mw_u£rb™s
[
ACL_BITS_PER_WIN
];

161 
AşB™s
 
	mw_lio_nÙify
;

162 
AşB™s
 
	mw_mÚ_nÙify
;

165 
¡©e_t
 
	mw_¡©e
;

166 
¡ršg_t
 
	mw_SŒšgTy³
;

167 
mlše
 *
	mw_mlšes
;

168 
mch¬
 
	mw_»nd
;

169 #ifdeà
FONT


170 
	mw_FÚtL
;

171 
	mw_FÚtR
;

172 #ifdeà
ENCODINGS


173 
	mw_FÚtE
;

175 
	mw_Ch¬£t
;

176 
	mw_Ch¬£tR
;

177 
	mw_ch¬£ts
[4];

179 
	mw_ss
;

180 
	mw_§ved
;

181 
	mw_Saved_x
, 
	mw_Saved_y
;

182 
mch¬
 
	mw_SavedR’d
;

183 #ifdeà
FONT


184 
	mw_SavedCh¬£t
;

185 
	mw_SavedCh¬£tR
;

186 
	mw_SavedCh¬£ts
[4];

188 
	mw_tİ
, 
	mw_bÙ
;

189 
	mw_w¿p
;

190 
	mw_Üigš
;

191 
	mw_š£¹
;

192 
	mw_key·d
;

193 
	mw_cursÜkeys
;

194 
	mw_»vvid
;

195 
	mw_curšv
;

196 
	mw_curvvis
;

197 
	mw_autŞf
;

198 *
	mw_h¡©us
;

199 
	mw_gr
;

200 
	mw_c1
;

201 
	mw_bû
;

203 
	mw_’codšg
;

205 
	mw_decode¡©e
;

206 #ifdeà
DW_CHARS


207 
	mw_mbcs
;

209 
	mw_¡ršg
[
MAXSTR
];

210 *
	mw_¡ršgp
;

211 *
	mw_bs
;

212 
	mw_b–l
;

213 
	mw_æow
;

214 
logfe
 *
	mw_log
;

215 
	mw_logs’û
;

216 
	mw_mÚ™Ü
;

217 
	mw_s’ûwa™
;

218 
	mw_s’û
;

219 
	mw_vbwa™
;

220 
	mw_nÜeäesh
;

221 #ifdeà
RXVT_OSC


222 
	mw_x‹rmosc
[4][
MAXSTR
];

224 
	mw_mou£
;

225 #ifdeà
HAVE_BRAILLE


226 
	mw_bd_x
, 
	mw_bd_y
;

229 #ifdeà
COPY_PASTE


230 
	mw_¦ow·¡e
;

231 
	mw_hi¡height
;

232 
	mw_hi¡idx
;

233 
mlše
 *
	mw_hlšes
;

234 
·¡”
 
	mw_·¡”
;

236 
	mw_hi¡height
;

238 
	mw_pid
;

240 *
	mw_cmd¬gs
[
MAXARGS
];

241 *
	mw_dœ
;

242 *
	mw_‹rm
;

244 
	mw_læag
;

245 
¦Ù_t
 
	mw_¦Ù
;

246 #ià
defšed
 (
UTMPOK
)

247 
utmp
 
	mw_§vut
;

250 
	mw_‰y
[
MAXSTR
];

252 
	mw_zauto
;

253 #ifdeà
ZMODEM


254 
di¥Ïy
 *
	mw_zdi¥Ïy
;

256 #ifdeà
BUILTIN_TELNET


257 
sockaddr_š
 
	mw_‹l§
;

258 
	mw_‹lbuf
[
IOSIZE
];

259 
	mw_‹lbuæ
;

260 
	mw_‹lmİts
[256];

261 
	mw_‹Ìİts
[256];

262 
	mw_‹l¡©e
;

263 
	mw_‹lsubbuf
[128];

264 
	mw_‹lsubidx
;

265 
ev’t
 
	mw_‹lcÚÃv
;

267 
mlše
 *
	mw_®t_mlšes
;

268 
	mw_®t_width
;

269 
	mw_®t_height
;

270 
	mw_®t_hi¡height
;

271 
	mw_®t_x
, 
	mw_®t_y
;

272 #ifdeà
COPY_PASTE


273 
mlše
 *
	mw_®t_hlšes
;

274 
	mw_®t_hi¡idx
;

279 
	#w_’codšg
 
w_Ïy”
.
l_’codšg


	)

280 
	#w_width
 
w_Ïy”
.
l_width


	)

281 
	#w_height
 
w_Ïy”
.
l_height


	)

282 
	#w_x
 
w_Ïy”
.
l_x


	)

283 
	#w_y
 
w_Ïy”
.
l_y


	)

286 
	#W_TYPE_PTY
 0

	)

287 
	#W_TYPE_PLAIN
 1

	)

288 
	#W_TYPE_TELNET
 2

	)

302 
	#FLOW_NOW
 (1<<0)

	)

303 
	#FLOW_AUTO
 (1<<1)

	)

304 
	#FLOW_AUTOFLAG
 (1<<2)

	)

313 
	#WIN
(
y
è((y < 
fÜe
->
w_hi¡height
) ? \

314 &
fÜe
->
w_hlšes
[(fÜe->
w_hi¡idx
 + 
y
è% fÜe->
w_hi¡height
] \

315 : &
fÜe
->
w_mlšes
[
y
 - fÜe->
w_hi¡height
])

	)

317 
	#Lay”2Wšdow
(
l
è((
wš
 *)Ö)->
l_bÙtom
->
l_d©a
)

	)

	@
1
.
0
46
418
acls.c
acls.h
ansi.c
ansi.h
attacher.c
braille.c
braille.h
braille_tsi.c
comm.c
display.c
display.h
encoding.c
extern.h
fileio.c
help.c
image.h
input.c
layer.c
layer.h
loadav.c
logfile.c
logfile.h
mark.c
mark.h
misc.c
nethack.c
os.h
patchlevel.h
process.c
pty.c
putenv.c
resize.c
sched.c
sched.h
screen.c
screen.h
search.c
socket.c
teln.c
term.c
termcap.c
terminfo/checktc.c
terminfo/tetris.c
utmp.c
window.c
window.h
